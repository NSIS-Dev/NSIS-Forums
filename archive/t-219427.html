<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" MSN Messenger and NSIS (Now Playing), media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  MSN Messenger and NSIS (Now Playing) NSIS Discussion" />
	
	<title> MSN Messenger and NSIS (Now Playing) [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  MSN Messenger and NSIS (Now Playing)</div>
<hr />
<div class="pda"><a href="t-219427.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=219427">MSN Messenger and NSIS (Now Playing)</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">saivert</div><div class="date">21st June 2005, 23:01</div></div><div class="posttext">I'm working on a NSIS script that uses the System plug-in in order to set the Now Playing item in MSN Messenger.<br />
<br />
Here is the script, but something is wrong. CAn someone point it out for me?<br />
<br />
<br />
Function Page1Leave<br />
ReadIniStr $R0 &quot;$PLUGINSDIR\msnmsgr-nowplaying.ini&quot; &quot;Settings&quot; &quot;State&quot;<br />
StrCmp $R0 0 next<br />
Abort<br />
<br />
next:<br />
ReadIniStr $R1 &quot;$PLUGINSDIR\msnmsgr-nowplaying.ini&quot; &quot;Field 1&quot; &quot;State&quot;<br />
	<br />
StrCpy $TITLE $R1<br />
StrCpy $ARTIST &quot;Saivert&quot;<br />
StrCpy $ALBUM &quot;The last one&quot;<br />
<br />
StrCpy $R4 'Music\01\0{0} - {1}\0 $ARTIST \0 $TITLE \0 $ALBUM \0WMContentID'<br />
StrLen $R5 $R4<br />
IntOp $R5 $R5 * 2<br />
System::Alloc /NOUNLOAD 256<br />
Pop $R6<br />
System::Call /NOUNLOAD &quot;*$R6(&amp;w128 R4.)&quot;<br />
System::Call /NOUNLOAD &quot;*(i 0x547, i R5, i R1) i .R2&quot;<br />
FindWindow $R3 &quot;MsnMsgrUIManager&quot;<br />
SendMessage $R3 ${WM_COPYDATA} $HWNDPARENT $R2<br />
System::Free /NOUNLOAD $R2<br />
System::Free $R6<br />
<br />
; Write to IO ini file<br />
WriteIniStr &quot;$PLUGINSDIR\msnmsgr-nowplaying.ini&quot; &quot;Field 3&quot; &quot;Text&quot; $R4<br />
SendMessage $HWNDPARENT 0x408 0 0 ; Reload page<br />
Abort<br />
<br />
FunctionEnd<br />
<br />
<br />
The code is a fragment of the entire script. I'm using an InstallOptions page to present a text field where one can enter a title, the ARTIST and ALBUM is variables declared with Var and set to static values using StrCpy. When user clicks the next button, the function above gets called, and it just executes the commands past next label and then keeps the page by using an undocumented message to reload the page. This is so I can write to the IO ini file and have the new data reloaded by InstallOptions.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">saivert</div><div class="date">30th June 2005, 17:56</div></div><div class="posttext">I guess none of you are interested in this. It didn't take long before this post ended up on page three. So here is an update anyway:<br />
<br />
I have rewritten the code to use wsprintfW as in ShaneH's code over at MsnFanatics.com, but it's still not working.<br />
<br />
I saw some VB code there that used a structure to hold the title, artist and album info (pluss WMCOntentID) but later code just uses a string with literal &quot;\0&quot; sequences in it.<br />
<br />
The code so far:<br />
<br />
Function Page1Leave<br />
  ReadIniStr $R0 &quot;$PLUGINSDIR\msnmsgr-nowplaying.ini&quot; &quot;Settings&quot; &quot;State&quot;<br />
  StrCmp $R0 0 next<br />
  StrCmp $R0 5 clear<br />
  <br />
  clear:<br />
    FindWindow $R0 &quot;#32770&quot; &quot;&quot; $HWNDPARENT 0<br />
    GetDlgItem $R0 $R0 1203<br />
    SendMessage $R0 0xC 0 &quot;STR:&quot;<br />
    Abort<br />
  next:<br />
ReadIniStr $R0 &quot;$PLUGINSDIR\msnmsgr-nowplaying.ini&quot; &quot;Field 4&quot; &quot;State&quot;<br />
<br />
System::Alloc 1024<br />
Pop $R1<br />
; Set up string to send the MSN Messenger<br />
; A backslash at the end of line means span next line.<br />
; I needed to do this in order to keep the layout on<br />
; the forum neat.<br />
System::Call 'user32::wsprintfW(i R1, w s, i 1, w &quot;{0} - {1}&quot;, w R0,\<br />
 w &quot;Artist&quot;, w &quot;Album&quot;, w &quot;WMContentID&quot;) i..?c'\<br />
 &quot;\\0Music\\0%d\\0%s\\0%s\\0%s\\0%s\\0%s\\0&quot;<br />
<br />
System::Call &quot;kernel32::lstrlenW(i R1) i.R2&quot;<br />
IntOp $R2 $R2 * 2<br />
<br />
System::Call &quot;*(i 0x547, i R2, i R1) i .R3&quot;<br />
StrCpy $R4 0<br />
nextwnd:<br />
  FindWindow $R5 &quot;MsnMsgrUIManager&quot; &quot;&quot; 0 $R4<br />
  StrCpy $R4 $R5<br />
  SendMessage $R5 ${WM_COPYDATA} $HWNDPARENT $R3 /TIMEOUT=1000<br />
  StrCmp $R5 0 +1 nextwnd<br />
System::Free $R3<br />
<br />
; get the complete string<br />
System::Call &quot;*$R1(&amp;w1024 .R6)&quot;<br />
System::Free $R1<br />
<br />
; Write to IO ini file<br />
;WriteIniStr &quot;$PLUGINSDIR\msnmsgr-nowplaying.ini&quot; &quot;Field 7&quot; &quot;State&quot; $R6<br />
;SendMessage $HWNDPARENT 0x408 0 0 ; Reload page<br />
; we just set the text<br />
FindWindow $R0 &quot;#32770&quot; &quot;&quot; $HWNDPARENT 0<br />
GetDlgItem $R0 $R0 1206<br />
SendMessage $R0 0xC 0 &quot;STR:$R6&quot;<br />
<br />
<br />
Abort<br />
FunctionEnd<br />
<br />
<br />
You can download the latest 7z archive with all the files here:<br />
msnmsgr-nowplaying.7z (34kB) (http://saivert.inthegray.com/download.php?get=Li91cGxvYWRzL25zaXMvbXNubXNnci1ub3dwbGF5aW5nLjd6)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>