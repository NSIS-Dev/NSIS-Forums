<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Delete Files System32, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Delete Files System32 NSIS Discussion" />
	
	<title> Delete Files System32 [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Delete Files System32</div>
<hr />
<div class="pda"><a href="t-330965.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=330965">Delete Files System32</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">jai123</div><div class="date">26th May 2011, 19:52</div></div><div class="posttext">Hello,<br />
<br />
I created a driver installer. In order to install cleanly, the driver has to first make sure that there are no previous drivers files in the system files. For example, I have to make sure that the paths below do not contain any driver file.<br />
<br />
../System32<br />
../System32/drivers<br />
../SysWOW64<br />
<br />
In window XP, I just use the delete instruction and they get erased. However, in windows 7, delete does not erase the files. Any idea why is this happening?<br />
<br />
Thanks,</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">26th May 2011, 20:02</div></div><div class="posttext">What code are you using?<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jai123</div><div class="date">26th May 2011, 20:08</div></div><div class="posttext">The code is below. I have already double check that the path is correct. <br />
<br />
The first delete uses $WINDIR\System32 instead of $SYSDIR because I thought that the path could be case sensitive. It did not make a difference.<br />
<br />
Thanks.<br />
<br />
Function cleanFileSystem<br />
<br />
    # Erase driver files from the system.<br />
    delete &quot;$WINDIR\System32\drivers\windrvr6.sys&quot;<br />
    delete &quot;$SYSDIR\drivers\pciservo.sys&quot;<br />
    delete &quot;$SYSDIR\drivers\pciservo2.sys&quot;<br />
    delete &quot;$SYSDIR\wdapi*.dll&quot;<br />
    delete &quot;$SYSDIR\drivers\TechnoPCIController.sys&quot; ; from here on, 64 bit only file<br />
    delete &quot;$WINDIR\SysWOW64\wdapi*.dll&quot;<br />
    <br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">26th May 2011, 20:10</div></div><div class="posttext">Running as admin? Got &quot;RequestExecutionLevel admin&quot;?<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jai123</div><div class="date">26th May 2011, 20:24</div></div><div class="posttext">I am administrator and even I added an admin check at the beginning of the code (added code below).<br />
<br />
what is that  &quot;RequestExecutionLevel admin&quot;? can I change the user privileges from the installer?<br />
<br />
Function .onInit<br />
<br />
    # call userInfo plugin to get user info.  The plugin puts the result in the stack<br />
    userInfo::getAccountType<br />
   <br />
    pop $0  ; pop the result from the stack into $0<br />
<br />
    # check if user is admin.<br />
    ${If} $0 != &quot;Admin&quot;<br />
        messageBox MB_OK &quot;To install the drivers, log in as administrator.&quot;<br />
        Abort<br />
    ${EndIf} <br />
 <br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">26th May 2011, 20:27</div></div><div class="posttext">RequestExecutionLevel is in the manual.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jai123</div><div class="date">26th May 2011, 20:39</div></div><div class="posttext">thanks, I will check it out.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">26th May 2011, 20:51</div></div><div class="posttext">Please note that requestexecutionlevel does absolutely nothing on older OS versions, or on Vista/7 with UAC disabled. So even if you requestexecutionlevel admin you'll always need to manually check for admin using the UserInfo plugin, like you did.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jai123</div><div class="date">26th May 2011, 21:59</div></div><div class="posttext">MSG, thank you for the observation. By chance, do you know how can I pop a message that clarifies that they need to be administrators before showing the admin password info? I see some users getting confused and thinking that the installer needs a password.<br />
<br />
Also, getting back to the original question that I had. I am running as admin, an it is still not erasing the files in the system folder. Do you have any idea why is this happening?<br />
<br />
Thanks,</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">26th May 2011, 23:08</div></div><div class="posttext">Have you disabled file system redirection (see x64.nsh)? If you haven't then Windows will redirect any reads/writes from system32 to syswow64 because NSIS is 32-bit. That is probably what your issue is.By chance, do you know how can I pop a message that clarifies that they need to be administrators before showing the admin password info?What's wrong with the code you've already posted? It does just that, does it not?<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">27th May 2011, 06:08</div></div><div class="posttext">Either that, or the files are in use?<br />
<br />
<br />
Have you disabled file system redirection (see x64.nsh)? If you haven't then Windows will redirect any reads/writes from system32 to syswow64 because NSIS is 32-bit. That is probably what your issue is.What's wrong with the code you've already posted? It does just that, does it not?<br />
He/she wants to pop an admin warning before elevation. This is possible with the UAC plugin: Simply pop a messagebox before !insertmacro UAC_RunElevated . But note that this is definitely the long way around. The password entry field shown by Windows is just that, a part of Windows. It's how it's designed. If people misunderstand, that's not your fault because you're only using Windows the way it's designed to be used. So in that vein, it's also not your problem really.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jai123</div><div class="date">27th May 2011, 15:43</div></div><div class="posttext">Afrow UK and MSG, both of you rock.<br />
<br />
I was missing the X64.nsh redirection macros; that is the reason that I was not erasing the files in the folders I was looking to. Now, I am able to delete the files in the right folders. However, there is still an inconsistency with the next code:<br />
<br />
        ${DisableX64FSRedirection}<br />
        CopyFiles $OUTDIR\pciservo.sys $SYSDIR\drivers\pciservo.sys<br />
<br />
        ${EnableX64FSRedirection}<br />
        CopyFiles $OUTDIR\wdapi1030.dll $SYSDIR\wdapi1030.dll<br />
<br />
The first call copies pciservo.sys into the ...\System32\drivers folder, and I would expect that the second one copies it into the ...\SysWOW64 folder, but it does not redirect to it. It still copies it into the ...\System32 folder. Is the X64.nsh limited to certain api calls?<br />
<br />
------<br />
About the message box before admin password pop, I agree with you guys. I believe it is descriptive and simple. So I will leave the pop with the password and the admin, that should be more than enough.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">27th May 2011, 17:42</div></div><div class="posttext">Hmm I've not had that problem before. However, I tend to use this script header in my NSIS projects that need to deal with dual x86/x64 installs (attached). It disables file system redirection by default (for the current thread by the way) and gives you a new $SYSWOW64 variable:<br />
<br />
Usage:<br />
${SystemDirsInit}<br />
<br />
x86:<br />
$SYSDIR = system32<br />
$SYSWOW64 = system32<br />
<br />
x64:<br />
$SYSDIR = system32<br />
$SYSWOW64 = syswow64<br />
<br />
So in other words you can just use $SYSWOW64 when you need to extract 32-bit files and you do not need to toggle file system redirection. (Also the header replaces RunningX64 with a non-System plug-in call method of detection.)<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jai123</div><div class="date">27th May 2011, 20:03</div></div><div class="posttext">Thanks Afrow UK, that sound like a good way to go.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>