<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" My first function, Push, Pop? what is wrong?, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  My first function, Push, Pop? what is wrong? NSIS Discussion" />
	
	<title> My first function, Push, Pop? what is wrong? [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  My first function, Push, Pop? what is wrong?</div>
<hr />
<div class="pda"><a href="t-138685.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=138685">My first function, Push, Pop? what is wrong?</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Lilla</div><div class="date">11th June 2003, 21:30</div></div><div class="posttext">I wrote the function below, based upon UserInfo.nsi<br />
The value of $R0 is correct at end of Function,<br />
but is wrong when I Pop below, what is wrong?<br />
<br />
I figure it must need a Push, or a Pop or something.<br />
I have never used Push, Pop, Exch before, so I <br />
would appreciate is someone could tell me what <br />
I am missing.<br />
<br />
Thanks, Lilla<br />
<br />
Call IsUserAdmin<br />
Pop $R0   <br />
<br />
; at this point $R0 should be &quot;true&quot; or &quot;false&quot;<br />
; but instead it is empty, why at is wrong?<br />
<br />
Function IsUserAdmin<br />
	Push $R0<br />
	ClearErrors<br />
	UserInfo::GetName<br />
	IfErrors Win9x<br />
	Pop $R1<br />
	UserInfo::GetAccountType<br />
	Pop $R2<br />
	StrCmp $R2 &quot;Admin&quot; 0 Continue2<br />
		; MessageBox MB_OK 'User &quot;$R1&quot; is in the Administrators group'<br />
		StrCpy $R0 &quot;true&quot;<br />
		Goto done<br />
	Continue2:<br />
		StrCmp $R2 &quot;Power&quot; 0 Continue3<br />
		; MessageBox MB_OK 'User &quot;$R1&quot; is in the Power Users group'<br />
		StrCpy $R0 &quot;false&quot;<br />
		Goto done<br />
	Continue3:	<br />
		StrCmp $R2 &quot;User&quot; 0 Continue4<br />
		; MessageBox MB_OK 'User &quot;$R1&quot; is just a regular user'<br />
		StrCpy $R0 &quot;false&quot;<br />
		Goto done<br />
	Continue4:	<br />
		StrCmp $R2 &quot;Guest&quot; 0 Continue5<br />
		; MessageBox MB_OK 'User &quot;$R1&quot; is a guest'<br />
		StrCpy $R0 &quot;false&quot;<br />
		Goto done<br />
	Continue5:<br />
		; I get here when running Win98SE, $R2 is empty<br />
		StrCmp $R2 &quot;&quot; 0 Continue6<br />
		;MessageBox MB_OK 'User &quot;$R1&quot; is a &lt;empty&gt;' <br />
   		Goto Win9x<br />
	Continue6:		<br />
		;MessageBox MB_OK &quot;Unknown account type: $R2&quot;<br />
		StrCpy $R0 &quot;false&quot;<br />
		Goto done<br />
	Win9x:<br />
		; This one means you don't need to care about admin or<br />
		; not admin because Windows 9x doesn't either<br />
		; MessageBox MB_OK &quot;Error! This DLL can't run under Windows 9x!&quot;<br />
		StrCpy $R0 &quot;true&quot;<br />
	done:<br />
	; contains 'true' or 'false' to answer IsUserAdmin<br />
	MessageBox MB_OK &quot;R1=$R1 R2=$R2 R0=$R0&quot; ; debug<br />
        ; at this point all three values are correct<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Sunjammer</div><div class="date">11th June 2003, 21:56</div></div><div class="posttext">Well why do you need to do Pop $R0 anyway? $R0 will have that value without doing the pop. The reason it changes when you do pop is that pulls the top value off the stack thereby *overwriting* $R0 with whatever was on top of the stack!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">11th June 2003, 21:58</div></div><div class="posttext">At the end use Exch $R0<br />
<br />
You can use Push $x at the start of your function to push variables onto the stack and then pop them off the stack again at the end of the function.<br />
This is used to save variables from changing (e.g. if $1 = hello, call myfunction, $1 still = hello afterwards)<br />
<br />
That function is a bit messy, so I shall have a look at it and see if I can clean it up!<br />
<br />
-Stu :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">11th June 2003, 22:01</div></div><div class="posttext">Function IsUserAdmin <br />
Push $R0<br />
Push $R1<br />
Push $R2<br />
<br />
ClearErrors<br />
UserInfo::GetName<br />
IfErrors Win9x<br />
Pop $R1<br />
UserInfo::GetAccountType<br />
Pop $R2<br />
StrCmp $R2 &quot;Admin&quot; 0 Continue1<br />
<br />
; MessageBox MB_OK 'User &quot;$R1&quot; is in the Administrators group'<br />
StrCpy $R0 &quot;true&quot;<br />
Goto done<br />
<br />
Continue1:<br />
StrCmp $R2 &quot;Power&quot; 0 Continue2<br />
; MessageBox MB_OK 'User &quot;$R1&quot; is in the Power Users group'<br />
StrCpy $R0 &quot;false&quot;<br />
Goto done<br />
<br />
Continue2:<br />
StrCmp $R2 &quot;User&quot; 0 Continue3<br />
; MessageBox MB_OK 'User &quot;$R1&quot; is just a regular user'<br />
StrCpy $R0 &quot;false&quot;<br />
Goto done<br />
<br />
Continue3:<br />
StrCmp $R2 &quot;Guest&quot; 0 Continue4<br />
; MessageBox MB_OK 'User &quot;$R1&quot; is a guest'<br />
StrCpy $R0 &quot;false&quot;<br />
Goto done<br />
<br />
Continue4:<br />
; I get here when running Win98SE, $R2 is empty<br />
StrCmp $R2 &quot;&quot; 0 Continue5<br />
;MessageBox MB_OK 'User &quot;$R1&quot; is a &lt;empty&gt;'<br />
Goto Continue6<br />
<br />
Continue5:<br />
;MessageBox MB_OK &quot;Unknown account type: $R2&quot;<br />
StrCpy $R0 &quot;false&quot;<br />
Goto done<br />
<br />
Continue6:<br />
; This one means you don't need to care about admin or<br />
; not admin because Windows 9x doesn't either<br />
; MessageBox MB_OK &quot;Error! This DLL can't run under Windows 9x!&quot;<br />
StrCpy $R0 &quot;true&quot;<br />
<br />
done:<br />
; contains 'true' or 'false' to answer IsUserAdmin<br />
MessageBox MB_OK &quot;R1=$R1 R2=$R2 R0=$R0&quot; ; debug<br />
; at this point all three values are correct<br />
<br />
Pop $R2<br />
Pop $R1<br />
Exch $R0<br />
FunctionEnd<br />
<br />
<br />
If it's a useful script, put it on the NSIS Archive!<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Lilla</div><div class="date">11th June 2003, 23:37</div></div><div class="posttext">Stu, thanks for the information, and the cleanup job. <br />
It looks better now.<br />
<br />
Glad you like it. I will put it on the Archive as you suggest. <br />
<br />
Lilla</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">12th June 2003, 14:24</div></div><div class="posttext">As you only want to know if the plug-in returned Admin you don't need to compare to the other values. If it's not Admin or nothing then it's false, no need to compare.<br />
<br />
Push/Pop/Exch information can be found here:<br />
http://nsis.sourceforge.net/archive/viewpage.php?pageid=216<br />
<br />
Please attach large scripts next time.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Lilla</div><div class="date">12th June 2003, 19:56</div></div><div class="posttext">Yes, I could shorten the function. <br />
<br />
At the time I wrote it, I thought it would be good to include all tests to make it easier to tweak. For example, a Power User might be enough for some purposes.<br />
<br />
Thanks for the link, and for let me know about attaching. I'm new and just feeling my way along here.<br />
<br />
Lilla</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Lilla</div><div class="date">12th June 2003, 21:55</div></div><div class="posttext">I decided Kichik's was right, no point to include those extra tests. I uploaded the updated version of this function to the ARCHIVE - Useful Functions section.<br />
<br />
Thanks Kichik for knudging me in the right direction.<br />
<br />
Lilla</div></div><hr />


<div class="post"><div class="posttop"><div class="username">virtlink</div><div class="date">13th June 2003, 12:01</div></div><div class="posttext">Oops, a little typo sneaked into my article: comment starting ';'-character was left on the previous line. Fixed.<br />
<br />
Pop $0;<br />
$0 contains: &quot;Value 2&quot;<br />
<br />
<br />
And another typo:<br />
<br />
StrCpy $0 &quot;Value X&quot;<br />
Exch $1<br />
;Exchanges the top value with the variable.<br />
;$0 contains &quot;Value 3&quot;<br />
<br />
Must of course be:<br />
<br />
StrCpy $0 &quot;Value X&quot;<br />
Exch $0<br />
;Exchanges the top value with the variable.<br />
;$0 contains &quot;Value 3&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Lilla</div><div class="date">13th June 2003, 18:48</div></div><div class="posttext">The latest version of UserInfo.dll has been updated to report Win98SE user as 'Admin'. This is good. <br />
<br />
I updated my IsUserAdmin function to reflect the new behavior of UserInfo.dll. The updated copy has been uploaded to the archive, Useful functions section.<br />
<br />
Lilla</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jar23</div><div class="date">22nd December 2003, 14:12</div></div><div class="posttext">Have you tested IsUserAdmin function in WinNT? It returns true because UserInfo::GetAccountType returns &quot;&quot;. Does any one knows why? Mayby it is because I tested it being loged in as user who is domain user not belongin to any local group?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comm@nder21</div><div class="date">23rd December 2003, 14:05</div></div><div class="posttext">BIG THANKS to virtlink for that great tutorial about the stack. i think, i've got it :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">23rd December 2003, 14:17</div></div><div class="posttext">Originally posted by jar23 <br />
Have you tested IsUserAdmin function in WinNT? It returns true because UserInfo::GetAccountType returns &quot;&quot;. Does any one knows why? Mayby it is because I tested it being loged in as user who is domain user not belongin to any local group? Are you saying it's always returning &quot;&quot; on your Windows NT, no matter what user?<br />
<br />
Is there any chance you can do some debugging and find out why it fails? I don't have Windows NT, and have no where to get it from.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>