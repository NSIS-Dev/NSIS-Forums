<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Vista Uninstall issue on 64bit system, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Vista Uninstall issue on 64bit system NSIS Discussion" />
	
	<title> Vista Uninstall issue on 64bit system [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Vista Uninstall issue on 64bit system</div>
<hr />
<div class="pda"><a href="t-269506.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=269506">Vista Uninstall issue on 64bit system</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">dantemw</div><div class="date">13th April 2007, 22:06</div></div><div class="posttext">When running my NSIS installer on a 64bit version of vista I am making the following entry (plus others) via NSIS to the registry:<br />
<br />
WriteRegStr HKLM &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Adobe Flash Player&quot; UninstallString $SYSDIR\Macromed\Flash\uninstall_activeX.exe&quot;<br />
<br />
However this gets translated by NSIS to the following in the registry:<br />
<br />
HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Adobe Flash Player UninstallString C:\windows\system32\macromed\flash\uninstall_activeX.exe<br />
<br />
The $SYSDIR on Vista64 (and where NSIS put all of the files that I specfied for $SYSDIR) into the following directory:<br />
<br />
C:\windows\sysWOW64\macromed\flash\<br />
<br />
Obviously this breaks add/remove programs.<br />
Can anyone be my guiding light here?<br />
<br />
Thank you,<br />
Michael</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">13th April 2007, 22:38</div></div><div class="posttext">So you're writing to the Wow32Node of HKLM, yet it fails to redirect C:\windows\system32 to C:\windows\syswow64? That's... Weird... :igor:<br />
<br />
You have a number of options. Disable file system redirection when writing the uninstaller, so it'd really get written to system32 (see Includes\x64.nsh). Manually get syswow64.System::Call &quot;kernel32::GetSystemWow64Directory( \<br />
  t .r0, i ${NSIS_MAX_STRLEN})&quot;<br />
DetailPrint $0 Write the uninstaller to $PROGRAMFILES.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dantemw</div><div class="date">13th April 2007, 22:49</div></div><div class="posttext">&quot;WriteRegStr&quot; when running on 64bit Vista writes to<br />
<br />
HKLM\Software\WOW6432Node\Microsoft\...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">13th April 2007, 23:00</div></div><div class="posttext">Yeah, that's what I meant. You'd expect the Add/Remove control panel to be smart enough on what it executes and enable redirection when reading from there.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dantemw</div><div class="date">13th April 2007, 23:03</div></div><div class="posttext">Sounds like a possible bug with Vista. I'll work around it for now using your suggestions. Thank you for the quick response.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">13th April 2007, 23:44</div></div><div class="posttext">Even weirder - it works on Windows XP x64. Are you sure that's the reason for the failure? Try running FileMon (http://www.microsoft.com/technet/sysinternals/FileAndDisk/Filemon.mspx) in the background and see exactly what it tries to open.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dantemw</div><div class="date">13th April 2007, 23:56</div></div><div class="posttext">It's pretty straight forward in the script. First do<br />
<br />
 InstallDir &quot;$SYSDIR\Macromed\Flash&quot;<br />
 WriteUninstaller $INSTDIR\uninstall_activeX.exe<br />
<br />
This copies the uninstaller to SysWOW64\Macromed\Flash<br />
<br />
When I do the following on Vista x64:<br />
 WriteRegStr HKLM &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)&quot; UninstallString $INSTDIR\uninstall_activeX.exe<br />
<br />
It puts the $INSTDIR value as &quot;SYSTEM32\Macromed\Flash&quot;. Everywhere else $INSTDIR is being properly redirected to SYSWOW64.<br />
<br />
I haven't tried on XP x64. I will check that out as well.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">14th April 2007, 00:01</div></div><div class="posttext">But does the Add/Remove Control Panel actually try to run the file from system32? WriteRegStr will always write system32 because that's how the file system redirector works. When a file is actually accessed, it changes system32 to syswow64. I believe they chose this method of registry shell folders' registry separation because a lot of developers wrote directly to system32 without using GetSystemDirectory. What I don't understand is why system64 wasn't created instead. Any old and unported application would access system32 anyway as it's compiled for x86.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dantemw</div><div class="date">14th April 2007, 00:04</div></div><div class="posttext">It does try to run it from the path in the registry (System32) and then Vista comes up with a dialog that says there is a problem with uninstall (and all of the files including the uninstaller are left on the system). When I change the registry entry to point to the correct location it works as expected. So my best guess is that the code that does the add/remove is not doing the file system mapping. <br />
<br />
Possibly there is another place in the registry that add/remove is supposed to live on Vista?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">14th April 2007, 00:07</div></div><div class="posttext">There isn't any other new place I've heard of...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dantemw</div><div class="date">14th April 2007, 00:27</div></div><div class="posttext">The behavior is the same on XP 64 as it is on Vista 64... So I have just made the following change and all is well.<br />
<br />
   ${If} ${RunningX64}<br />
        System::Call &quot;kernel32::GetSystemWow64Directory( \t .r0, i ${NSIS_MAX_STRLEN})&quot;<br />
        WriteRegStr HKLM &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)&quot; DisplayIcon $0\Macromed\Flash\uninstall_activeX.exe<br />
        WriteRegStr HKLM &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)&quot; UninstallString $0\Macromed\Flash\uninstall_activeX.exe<br />
    ${Else}<br />
        WriteRegStr HKLM &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)&quot; DisplayIcon $INSTDIR\uninstall_activeX.exe<br />
        WriteRegStr HKLM &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)&quot; UninstallString $INSTDIR\uninstall_activeX.exe<br />
    ${EndIf}<br />
<br />
I would think others would run into this problem as well... Is there a different way for entering the add/remove entry in NSIS than the way I am doing it that properly maps the path?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">14th April 2007, 00:37</div></div><div class="posttext">I've managed to reproduce this on XP x64 as well. All I had to do is put the uninstaller in a subfolder of syswow64 instead of syswow64 itself. That's an even weirder workaround that they've used. But I guess I can understand how it came to be. Instead of activating the redirector, they made a simple search and replace, only they compare the folder instead of really searching.<br />
<br />
The reason no one else has reported it is because usually people don't put uninstallers in $SYSDIR. The common location is $PROGRAMFILES.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dantemw</div><div class="date">14th April 2007, 00:41</div></div><div class="posttext">Ahh, yes. Program Files... Unfortunately being the Flash Player we have a strange location because we shipped as a part of XP... One day we will probably move out of there, but not as long as people are using XP :) Thanks for your help.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">14th April 2007, 00:43</div></div><div class="posttext">Well, the OCX itself can stay in system32, but I see no reason to keep the uninstaller there.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dantemw</div><div class="date">14th April 2007, 00:46</div></div><div class="posttext">True. We try to keep everything in one place so as not to pollute the system anymore than people already think we do... being evil Flash and all. I'll consider moving the uninstaller in the future if this continues to plague us.<br />
<br />
Thanks again.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dantemw</div><div class="date">14th April 2007, 00:49</div></div><div class="posttext">BTW: We just shipped (Yesterday) our full rewrite of our installers using NSIS. It has been a great experience.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>