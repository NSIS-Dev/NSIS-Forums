<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" nsSCM plugin tip, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  nsSCM plugin tip NSIS Discussion" />
	
	<title> nsSCM plugin tip [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  nsSCM plugin tip</div>
<hr />
<div class="pda"><a href="t-253190.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=253190">nsSCM plugin tip</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">burninator</div><div class="date">13th August 2006, 13:18</div></div><div class="posttext">Hi,<br />
<br />
Just wanted to share the solution to a very frustrating problem that has kept me busy for a while, I searched for old posts about this issue but found nothing, so here it is:<br />
<br />
I'm working on an installer for a small win32 service application, and using the nsSCM (http://nsis.sourceforge.net/Service_Control_Manager_plugin_(install_services_and_drivers_on_NT/2K/XP)) plugin to install/start/stop the service.<br />
<br />
So far it's all working fine on my PC system, however I did run into a problem when I tried to run the setup as an upgrade (service already installed and running) on a very slow VIA mini-ITX system. During the setup process the service should have been stopped so the service .exe can be overwritten with the new version, but appearantly this did not work properly.<br />
<br />
The main section contains code that calls nsSCM and then installs the new files:<br />
<br />
nsSCM::Stop /NOUNLOAD ${SERVICE_NAME}<br />
...<br />
File &quot;bunch of files...&quot;<br />
File &quot;bunch of files...&quot;<br />
File &quot;bunch of files...&quot;<br />
File &quot;name of service.exe&quot;<br />
<br />
Sometimes I would get a &quot;File is locked/in use&quot; or similar dialog for the service exe, however it worked when you would press &quot;retry&quot;.<br />
<br />
What I figured out is that the nsSCM::Stop command does not wait for the service process to fully terminate, which can take a few seconds on slow systems, depending on your application.<br />
<br />
Solution:<br />
<br />
I used the FindProcDLL (http://nsis.sourceforge.net/FindProcDLL_plug-in) plugin to wait for the process to terminate, not sure if this is the best way, but it works :)<br />
<br />
nsSCM::Stop /NOUNLOAD &quot;service name&quot;<br />
<br />
waitloop:<br />
  FindProcDLL::FindProc &quot;service name.exe&quot;<br />
  StrCmp $R0 1 0 waitdone<br />
  Sleep 500<br />
  goto waitloop<br />
waitdone:<br />
<br />
...<br />
File &quot;...<br />
<br />
<br />
The same code should also be added to the uninstaller, otherwise the service exe might be locked when the uninstaller attempts to delete the file.<br />
<br />
Just thought I'd share this approach, maybe it will be of use to someone ;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">hashem</div><div class="date">13th August 2006, 13:22</div></div><div class="posttext">Hi<br />
Available commands: <br />
<br />
nsSCM::Install [name_of_service] [display_name] [service_type] [start_type] [service_commandline] [load_order_group] [dependencies] [account] [password]<br />
nsSCM::Start [name_of_service] <br />
nsSCM::Stop [name_of_service] <br />
nsSCM::QueryStatus [name_of_service] <br />
nsSCM::Remove [name_of_service]Parameters: <br />
<br />
name_of_service - the name of the service used for Start/Stop commands and all further nsSCM commands <br />
display_name - the name as shown in the service control manager applet in system control <br />
service_type - one of the following codes <br />
1 - device driver <br />
16 - service <br />
272 - service with Desktop Interaction <br />
start_type - one of the following codes <br />
0 - driver boot stage start <br />
1 - driver sscm stage start <br />
2 - service auto start <br />
3 - driver/service manual start <br />
service_commandline - the path to the binary including all necessary parameters <br />
load_order_group - controls the order of service starts <br />
dependencies - needed services, controls which services have to be started before this one <br />
account - the account which should be used to run the service <br />
password - password of the aforementioned account to be able to logon as a service <br />
If you do not specify account/password, the local system account will be used to run the service.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>