<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Shut down computer, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Shut down computer NSIS Discussion" />
	
	<title> Shut down computer [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Shut down computer</div>
<hr />
<div class="pda"><a href="t-220905.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=220905">Shut down computer</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">7th July 2005, 18:47</div></div><div class="posttext">I'd like to add functionality to an updater thingy written in NSIS to shut down the computer when updates have been downloaded and installed. Can someone write me System plugin code to do this (I'd attempt it but I have no experience in that area)? <br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">7th July 2005, 19:44</div></div><div class="posttext">This is the code I made after looking at MSDN, but it doesn't work.<br />
<br />
System::Call &quot;cimwin32::Win32Shutdown(i 5,) i.r0&quot;<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comm@nder21</div><div class="date">7th July 2005, 19:51</div></div><div class="posttext">there are several win32-api functions to do this, documented on this page:<br />
http://msdn.microsoft.com/library/default.asp?url=/library/en-us/sysinfo/base/system_shutdown_functions.asp<br />
<br />
the code you need looks like this:<br />
System::Call &quot;user32::ExitWindowsEx(i 0x00000002, i 0x00030003) i .r0&quot;<br />
this will reboot windows immediatly (first parameter) with reason &quot;software - upgrade&quot; (second parameter).<br />
you also may use 0x00000008 (power off), 0x00000001 (shutdown) or 0 (logoff) instead of 0x00000002.<br />
exitwindowsex function reference (http://msdn.microsoft.com/library/en-us/sysinfo/base/exitwindowsex.asp?frame=true), with even more codes :)<br />
all system shutdown reason codes (http://msdn.microsoft.com/library/en-us/sysinfo/base/system_shutdown_reason_codes.asp)<br />
<br />
<br />
this functions have some more parameters:<br />
InitiateSystemShutdown (http://msdn.microsoft.com/library/en-us/sysinfo/base/initiatesystemshutdown.asp?frame=true)<br />
InitiateSystemShutdownEx (http://msdn.microsoft.com/library/en-us/sysinfo/base/initiatesystemshutdownex.asp?frame=true)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th July 2005, 19:51</div></div><div class="posttext">Use ExitWindowsEx (http://msdn.microsoft.com/library/en-us/sysinfo/base/exitwindowsex.asp). On Windows NT you'll have to adjust the process tokens. EnumUsersReg (http://nsis.sourceforge.net/wiki/EnumUsersReg) shows you how to do that.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comm@nder21</div><div class="date">7th July 2005, 19:54</div></div><div class="posttext">maybe you better use the InitiateSystemShutdown function.<br />
<br />
MSDN:<br />
The ExitWindowsEx function returns as soon as it has initiated the shutdown process. The shutdown or logoff then proceeds asynchronously. The function is designed to stop all processes in the caller's logon session. Therefore, if you are not the interactive user, the function can succeed without actually shutting down the computer. If you are not the interactive user, use the InitiateSystemShutdown or InitiateSystemShutdownEx function.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">7th July 2005, 19:56</div></div><div class="posttext">Comm@nder21, that doesn't seem to work here.<br />
<br />
System::Call &quot;user32::ExitWindowsEx(i 0x00000001, i 0x00030003) i .r0&quot;<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comm@nder21</div><div class="date">7th July 2005, 19:57</div></div><div class="posttext">hmm, maybe the values are wrong.<br />
i took them 1:1 from the msdn ...<br />
<br />
you may try a zero for both values.<br />
the system should initiate a logoff. then at least the function itself works the right way :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">7th July 2005, 20:00</div></div><div class="posttext">lol tried 0 and 0 for both but instead of logging me off it just closed a few programs and then stopped. Atleast we know something works (sort of!)<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comm@nder21</div><div class="date">7th July 2005, 20:05</div></div><div class="posttext">you may also try this one (win nt/xp/2k/2k3 only):<br />
System::Call &quot;Advapi32::InitiateSystemShutdown(t 0, t 0, i 0, i 0, i 1) i .r0&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">7th July 2005, 20:06</div></div><div class="posttext">That doesn't work either lol<br />
Takes a while to execute it though.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comm@nder21</div><div class="date">7th July 2005, 20:12</div></div><div class="posttext">this is very annoying ...<br />
msdn sucks.<br />
or system.dll does.<br />
or i do.<br />
dunno ...<br />
<br />
:)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th July 2005, 20:14</div></div><div class="posttext">NSIS denies exiting Windows while it's working (it returns FALSE to WM_QUERYENDSESSION).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">7th July 2005, 20:18</div></div><div class="posttext">Oh, so that means this isn't possible through NSIS?<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th July 2005, 20:22</div></div><div class="posttext">Not without a plug-in to avoid the denial or a source code change.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comm@nder21</div><div class="date">7th July 2005, 20:22</div></div><div class="posttext">there's a force parameter for this one ...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">7th July 2005, 22:25</div></div><div class="posttext">I ended up writing a small C++ app to do it. Shuts down computer after X seconds.<br />
<br />
// ShutDown.cpp : Defines the entry point for the console application.<br />
//<br />
<br />
#include &quot;stdafx.h&quot;<br />
#include &lt;windows.h&gt;<br />
#include &lt;mmsystem.h&gt;<br />
#include &lt;string&gt;<br />
#include &lt;stdio.h&gt;<br />
<br />
// Tell user usage format (if incorrect)<br />
void printUsageError() {<br />
	printf(&quot;Usage: shutdown &lt;seconds_untill_shutdown&gt;&quot;);<br />
}<br />
<br />
int _tmain(int argc, _TCHAR* argv[])<br />
{<br />
	if (argc &gt; 1)<br />
	{<br />
<br />
		// Get paramater (time in seconds)<br />
		long timer = atol(argv[1]);<br />
<br />
		if (timer &lt;= 0)<br />
		{<br />
			// Tell user usage format (if incorrect)<br />
			printUsageError();<br />
		}<br />
		else<br />
		{<br />
			// Calculate # of seconds<br />
			timer *= 1000;<br />
<br />
			// Confirm?<br />
			char szConfirm[2];<br />
			printf(&quot;This computer will shutdown in %s second(s).\r\nDo you want to continue (y|n)? &quot;, argv[1]);<br />
			gets(szConfirm);<br />
<br />
			if (strcmp(szConfirm, &quot;y&quot;) == 0)<br />
			{<br />
<br />
				// Perform sleep for [timer] seconds<br />
				Sleep(timer);<br />
<br />
				HANDLE hToken;<br />
				TOKEN_PRIVILEGES tkp;<br />
<br />
				// Get a token for this process.<br />
				OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &amp;hToken);<br />
<br />
				// Get the LUID for the shutdown privilege.<br />
				LookupPrivilegeValue(NULL, SE_SHUTDOWN_NAME, &amp;tkp.Privileges[0].Luid);<br />
<br />
				tkp.PrivilegeCount = 1; // one privilege to set<br />
				tkp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;<br />
<br />
				// Get the shutdown privilege for this process.<br />
				AdjustTokenPrivileges(hToken, FALSE, &amp;tkp, 0, (PTOKEN_PRIVILEGES)NULL, 0); <br />
<br />
				// Perform the shutdown!<br />
				ExitWindowsEx(EWX_SHUTDOWN | EWX_FORCE, 0);<br />
<br />
			}<br />
		}<br />
	}<br />
	else<br />
	{<br />
		// Tell user usage format (if incorrect)<br />
		printUsageError();<br />
	}<br />
	return 0;<br />
}<br />
<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">7th July 2005, 22:48</div></div><div class="posttext">Actually, now I've learnt a lot of C++ in about 2 hours I'll turn this into a plugin with the option of chosing which shutdown type to do (ie log off, shutdown etc)<br />
<br />
Not now though - at the weekend.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Brummelchen</div><div class="date">8th July 2005, 02:40</div></div><div class="posttext">try shutdown.exe from winxp (works also on 2k)<br />
<br />
%windir%\system32\shutdown.exe -s -t 90 -c &quot;Shutdown in 90secs&quot;<br />
<br />
so nsis is closed but shutdown is initiated.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">8th July 2005, 08:42</div></div><div class="posttext">Yeh thanks I was already aware of that but it doesn't seem to be on my Windows 98 machine so it's no use to me really. I also found this tool: http://www.budja.com/shutdown/<br />
but again he designed it only for Windows XP.<br />
Windows 98 and 95 has REBOOT95.EXE too, but that's got a GUI which I don't want.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Brummelchen</div><div class="date">8th July 2005, 10:29</div></div><div class="posttext">this one ?<br />
http://www.tdnsoftware.com/download.html<br />
<br />
http://www.freeware-download.com/downloaddetails/964.html<br />
Slawdog Smart Shutdown is a free commercial power shutdown utility. The program, based on a 1-2-3 interface and has huge number of shutdown options. It allows you to shut down, log off, reboot, lock, turn off, hibernate, disconnect from the Internet or network, enter standby mode in Windows, shut down and reboot computers in your network, both manually and automatically. Its built-in Smart Shutdown technology can shut down your computer if you are inactive for the specified period of time. Plus, with Easy Shutdown technology, you can shut down your computer with just a single click. The program shows options available in your OS only, supports command line and eats little resources. In addition, our exclusive Dependable Timer System technology, ErrorGuard and other similar features gives you 99.999% guaranty that your system will be shut down in any occasion, according to our tests.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">8th July 2005, 10:34</div></div><div class="posttext">Right here is my first NSIS plugin:<br />
http://nsis.sourceforge.net/mediawiki/images/f/f9/ShutDown.zip<br />
<br />
It's only 2.5kB :)<br />
Source and readme included.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">8th July 2005, 10:44</div></div><div class="posttext">If you're already using a plug-in, subclass the dialog and return TRUE for WM_QUERYSESSION instead of using EWX_FORCE.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">8th July 2005, 10:48</div></div><div class="posttext">I'll have a go :)<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">8th July 2005, 15:08</div></div><div class="posttext">Ok now I'm getting an error message with the heading:<br />
dwwin.exe - DLL Initialisation Failed<br />
<br />
The message is something along the lines of &quot;DLL failed to initialise because Windows is being shut down&quot;.<br />
<br />
Not the exact message because I can only see it for a split second. Any ideas?<br />
<br />
Should I attach the new source code?<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">8th July 2005, 16:49</div></div><div class="posttext">Ah right, dwwin.exe is Doctor Watson therefore I've got an error here somewhere.<br />
<br />
Attached C source code.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">9th July 2005, 14:56</div></div><div class="posttext">I was unable to get it to work, so I decided to go about it a different way.<br />
<br />
The plugin now calls DestroyWindow to close NSIS safely.<br />
If this fails, the ExitWindowsEx is not called.<br />
<br />
I've added optional switches to enable EWX_FORCE and one to turn this safety feature off (user can then call Quit to close NSIS instead - e.g. in Section).<br />
<br />
Am I right in using DestroyWindow, or should I be sending WM_CLOSE instead.<br />
<br />
http://nsis.sourceforge.net/mediawiki/images/8/89/ShutDown-0.2.zip<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">t0bb3</div><div class="date">12th February 2006, 16:55</div></div><div class="posttext">Is ShutDown-0.2.zip available for download anywhere?<br />
The link in the post above doesn't work</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">12th February 2006, 17:19</div></div><div class="posttext">http://nsis.sourceforge.net/File:ShutDown.zip<br />
<br />
Edit: The file appears to have been deleted! I shall re-upload.<br />
Edit #2: Done.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">t0bb3</div><div class="date">12th February 2006, 17:40</div></div><div class="posttext">Thanks :)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>