<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Summary of files in use, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Summary of files in use NSIS Discussion" />
	
	<title> Summary of files in use [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Summary of files in use</div>
<hr />
<div class="pda"><a href="t-286094.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=286094">Summary of files in use</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Barkruk</div><div class="date">1st February 2008, 12:47</div></div><div class="posttext">I want to switch from InstallShield to NSIS, but I have one problem;<br />
<br />
With InstallShield it is possible to check witch files are in use en show them (see attachment).<br />
<br />
I know I can do this also in NSIS with the following code:<br />
<br />
Push $R0<br />
ClearErrors<br />
FileOpen $R0 &quot;file.ext&quot; r<br />
FileClose $R0<br />
IfErrors 0 +2<br />
DetailPrint &quot;file.ext is locked!&quot;<br />
Pop $R0<br />
<br />
But with this piece of code I have to specify every single file.<br />
<br />
Because the monthly update of our program contains every time much updated, but also new files, I want to check for locked files by specifying only the installdir. Likewise how I install them:<br />
<br />
SetOutPath $INSTDIR<br />
File /r &quot;muchfiles\*.*&quot;<br />
<br />
How can I make this possible?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st February 2008, 14:57</div></div><div class="posttext">Use the LockedList plug-in (http://nsi.sf.net/LockedList_plug-in) for an advanced solution, otherwise you can attempt to rename the files which will result in the error flag being set.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Barkruk</div><div class="date">4th February 2008, 11:17</div></div><div class="posttext">I almost have what I want. But for some reason my ErrorFlag is set also when no files are in use. What is wrong?<br />
<br />
To test the code below change the INSTDIR in the MAIN section.<br />
Name &quot;Test&quot;<br />
Outfile test.exe<br />
ShowInstDetails show<br />
<br />
!include LogicLib.nsh<br />
<br />
Function CheckFilesInUse<br />
  Recheck:<br />
  ClearErrors<br />
  FindFirst $0 $1 &quot;$INSTDIR\*.*&quot;<br />
  Loop:<br />
    StrCmp $1 &quot;&quot; Done<br />
    StrCmp $1 &quot;.&quot; IsDir<br />
    StrCmp $1 &quot;..&quot; IsDir<br />
    IfFileExists &quot;$INSTDIR\$1\*.*&quot; IsDir<br />
    Push $R0<br />
    ClearErrors<br />
    FileOpen $R0 &quot;$INSTDIR\$1&quot; a<br />
    FileClose $R0<br />
    IfErrors 0 Next<br />
    DetailPrint &quot;$INSTDIR\$1 is is use.&quot;<br />
    Pop $R0<br />
    Next:<br />
    FindNext $0 $1<br />
    Goto Loop<br />
  IsDir:<br />
  ClearErrors<br />
  Goto Next<br />
  Done:<br />
  IfErrors 0 Finish<br />
  DetailPrint &quot;$1&quot;<br />
  MessageBox MB_RETRYCANCEL &quot;One or more files are in use.\<br />
    Close them and retry&quot; IDRETRY Retry<br />
  DetailPrint &quot;- Aborted.&quot;<br />
  Abort<br />
  Retry:<br />
  DetailPrint &quot;- Retry:&quot;<br />
  Goto Recheck<br />
  Finish:<br />
  DetailPrint &quot;Congrats, no files in use here.&quot;<br />
FunctionEnd<br />
<br />
Section &quot;Main&quot;<br />
  StrCpy $INSTDIR &quot;C:\&quot;<br />
  Call CheckFilesInUse<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">4th February 2008, 16:52</div></div><div class="posttext">Originally posted by Barkruk <br />
[B]I almost have what I want. But for some reason my ErrorFlag is set also when no files are in use. What is wrong?<br />
<br />
I think it's in here:<br />
<br />
  ClearErrors<br />
  Goto Next<br />
<br />
You clear the errors, then you go to the Next label.  This runs the code:<br />
<br />
    Next:<br />
    FindNext $0 $1<br />
    Goto Loop<br />
<br />
If no further file is found, the error flag is set.<br />
( &quot;the search is completed (there are no more files), filename_output is set to empty, and the error flag is set.&quot; )<br />
<br />
You check for this empty string after the Loop tag:<br />
<br />
Loop:<br />
    StrCmp $1 &quot;&quot; Done<br />
<br />
<br />
And jump to the Done tag, which is followed by a check for Errors.<br />
<br />
  Done:<br />
  IfErrors 0 Finish<br />
<br />
<br />
Whoops? :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Barkruk</div><div class="date">7th February 2008, 22:53</div></div><div class="posttext">Thanks I've got it working now.<br />
<br />
Now my function checks if all files in my instdir are writable, but I only need to know if only the files I want to overwrite are writable.<br />
<br />
I have searched the forum, examples and plugins, but I cannot find out how to know what files I have packed.<br />
<br />
In short; I want to know what files I'm gonna extract, and before I extract the whole bunch, I want to check if the already existed files are writable. Not all files in instdir, but only the ones I want to overwrite.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">7th February 2008, 23:41</div></div><div class="posttext">Originally posted by Barkruk <br />
Thanks I've got it working now.<br />
<br />
Excellent :)<br />
<br />
<br />
Originally posted by Barkruk I have searched the forum, examples and plugins, but I cannot find out how to know what files I have packed.<br />
You'll need a list of the files you're going to extract (along with, probably, where to).  You can either...<br />
A. hard-code this in your installer (or in an external file)<br />
B. generate your installer (or aforementioned external file) using another installer or a batch file you'd write that essentially creates the list for you, that you would execute before compiling your installer. (This, iirc, is what is usually recommended).<br />
( http://blogs.oracle.com/duffblog/2006/12/12 )<br />
C. extract your files to a temporary folder first, then use the usual FindFirst etc. to get their filenames. ( you could, later on, use delete+rename to prevent having to extract the files again )<br />
D. try installing the files anyway, now get the installation log file, find out which files failed, and prompt the user about these and try installing again. (or any of many variants on this)<br />
<br />
There's probably other methods.. B tends to be the one that gets recommended.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Barkruk</div><div class="date">8th February 2008, 15:59</div></div><div class="posttext">Thanks man, I finally got what I want! :)<br />
<br />
Some code sharing...<br />
<br />
My setup.nsi:!system &quot;CreateHeader.exe&quot; ;Generates MyHeader.nsh<br />
<br />
Function MyPrequisites<br />
  SetDetailsPrint textonly<br />
  Detailprint &quot;Checking for files in use...&quot;<br />
  SetDetailsPrint listonly<br />
  Loop:<br />
  !include MyHeader.nsh<br />
  StrCmp $R3 0 EndLoop<br />
  ;$R3 is set to 1 in the header when a file is in use<br />
  MessageBox MB_ICONEXCLAMATION|MB_RETRYCANCEL &quot;Some files \<br />
    are in use, please close them.&quot; IDRETRY Retry<br />
  SetDetailsPrint textonly<br />
  Detailprint &quot;The installation is aborted.&quot;<br />
  SetDetailsPrint listonly<br />
  Abort<br />
  Retry:<br />
  StrCpy $R3 0<br />
  DetailPrint &quot;&quot;<br />
  SetDetailsPrint both<br />
  Detailprint &quot;Rechecking for files in use...&quot;<br />
  SetDetailsPrint listonly<br />
  DetailPrint &quot;&quot;<br />
  Goto Loop<br />
  EndLoop:<br />
  SetDetailsPrint both<br />
FunctionEnd<br />
<br />
Section<br />
  Call MyPrequisites<br />
  SetOutPath $INSTDIR<br />
  File /r &quot;files\*.*&quot;<br />
SectionEndAnd here my CreateHeader.nsi (need to be compiled before compiling the setup):!define Header 'MyHeader.nsh'<br />
 <br />
OutFile 'CreateHeader.exe'<br />
silentinstall silent<br />
<br />
!include RecFind.nsh<br />
 <br />
Section<br />
  SetOutPath '$EXEDIR'<br />
  FileOpen $R2 ${Header} w<br />
  ${RecFindOpen} &quot;files&quot; $R0 $R1<br />
  ${RecFindFirst}<br />
  FileWrite $R2 'FileOpen $$R0 &quot;$$INSTDIR$R0\$R1&quot; a$\r$\n'<br />
  FileWrite $R2 'FileClose $$R0$\r$\n'<br />
  FileWrite $R2 'IfErrors 0 +3$\r$\n'<br />
  FileWrite $R2 'DetailPrint &quot;File in use: $$INSTDIR$R0\$R1&quot;$\r$\n'<br />
  FileWrite $R2 'StrCpy $$R3 1$\r$\n'<br />
  ${RecFindNext}<br />
  ${RecFindClose}<br />
  FileClose $R2<br />
SectionEndAnd here a piece of the generated Header.nsh:FileOpen $R0 &quot;$INSTDIR\adres.dll&quot; a<br />
FileClose $R0<br />
IfErrors 0 +3<br />
DetailPrint &quot;File in use: $INSTDIR\adres.dll&quot;<br />
StrCpy $R3 1<br />
FileOpen $R0 &quot;$INSTDIR\agenda.dll&quot; a<br />
FileClose $R0<br />
IfErrors 0 +3<br />
DetailPrint &quot;File in use: $INSTDIR\agenda.dll&quot;<br />
StrCpy $R3 1<br />
FileOpen $R0 &quot;$INSTDIR\alggeg.dll&quot; a<br />
FileClose $R0<br />
IfErrors 0 +3<br />
DetailPrint &quot;File in use: $INSTDIR\alggeg.dll&quot;<br />
StrCpy $R3 1<br />
FileOpen $R0 &quot;$INSTDIR\algm1.dll&quot; a<br />
FileClose $R0<br />
IfErrors 0 +3<br />
DetailPrint &quot;File in use: $INSTDIR\algm1.dll&quot;<br />
StrCpy $R3 1</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Barkruk</div><div class="date">8th February 2008, 17:09</div></div><div class="posttext">And see the differences from the attached file and the attached file from the start-post :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">8th February 2008, 20:58</div></div><div class="posttext">et voila :)  Glad it worked out for you!  NSIS can be a little daunting at first, but once you figure these types of things out, there's very little reason to even ponder an alternative anymore.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>