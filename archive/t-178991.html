<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Crypto Plugin, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Crypto Plugin NSIS Discussion" />
	
	<title> Crypto Plugin [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Crypto Plugin</div>
<hr />
<div class="pda"><a href="t-178991.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=178991">Crypto Plugin</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">GAG</div><div class="date">5th May 2004, 07:50</div></div><div class="posttext">Introduction <br />
<br />
<br />
This plugin provides you cryptographic interface using CryptoAPI. <br />
Using this plugin you can get common cryptographic hashes like MD5, SHA1, MD2, MD4. <br />
<br />
Plugin DLL size: 3 660 bytes (not packed), 2 886 bytes (upx packed) <br />
<br />
<br />
How to use <br />
<br />
1. Hash of string <br />
<br />
Crypto::HashData &quot;MD5&quot; &quot;String to be hashed&quot;<br />
Pop $0<br />
<br />
<br />
Supported algorithms: MD5|SHA1|MD2|MD4 <br />
<br />
2. Hash of file <br />
<br />
Crypto::HashFile &quot;MD5&quot; &quot;$WINDIR\notepad.exe&quot;<br />
Pop $0<br />
<br />
<br />
Supported algorithms: MD5|SHA1|MD2|MD4 <br />
<br />
Examples <br />
<br />
Hash Calculator: HashCalc.nsi <br />
Simple test: CryptoTest.nsi</div></div><hr />


<div class="post"><div class="posttop"><div class="username">GAG</div><div class="date">5th May 2004, 08:53</div></div><div class="posttext">Hash Calculator:<br />
Example usage of Crypto plugin</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CryptoNut</div><div class="date">22nd November 2005, 07:47</div></div><div class="posttext">Will this possibly support SHA-256 in the future?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">{ truparu }</div><div class="date">22nd November 2005, 14:04</div></div><div class="posttext">Great Plugin :) Is there source available for this plugin anywhere?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">GAG</div><div class="date">22nd November 2005, 18:39</div></div><div class="posttext">CryptoNut<br />
Hashing realized via Microsoft CryptoAPI, so if CryptoAPI supports such algo, this algo is supported by plugin too. SHA-1 is already supported.<br />
<br />
http://msdn.microsoft.com/library/en-us/seccrypto/security/cryptcreatehash.asp<br />
	<br />
{ truparu }<br />
Thank you!<br />
Yep, source will be available, when I'll rewrote it from scratch ;) coz I lost my sources ;) [no backup while crash... as always]</div></div><hr />


<div class="post"><div class="posttop"><div class="username">marcpeterson</div><div class="date">16th December 2005, 03:28</div></div><div class="posttext">I've used this dll on my development system without a problem.  But when I run the installer on some other systems, I get a CryptAcquireContext error 0x80090016.<br />
<br />
I did a bit of digging and found this:<br />
http://support.microsoft.com/default.aspx?scid=kb%3Ben-us%3B238187<br />
<br />
Do you know if your check for the NTE_BAD_KEYSET as it states on this line?<br />
<br />
if (GetLastError() == NTE_BAD_KEYSET)<br />
<br />
What are the chances of a new version coming out any time soon?  Thanks,<br />
<br />
Marc</div></div><hr />


<div class="post"><div class="posttop"><div class="username">GAG</div><div class="date">23rd December 2005, 18:56</div></div><div class="posttext">Hi, Marc<br />
I know about CryptAcquireContext error 0x80090016<br />
It's not related to link you posted.<br />
I used enhanced crypto provider instead of basic one. On some OS enhanced version isn't installed (due to old stupid export limitations or on Win98 w/o IE6 with strong crypto support)<br />
New version of this plugin will be published when I rewrote it from scratch :)<br />
as i already said in prev post, I lost my sources.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">sag47</div><div class="date">13th August 2007, 02:03</div></div><div class="posttext">Originally posted by GAG <br />
Hi, Marc<br />
I know about CryptAcquireContext error 0x80090016<br />
It's not related to link you posted.<br />
I used enhanced crypto provider instead of basic one. On some OS enhanced version isn't installed (due to old stupid export limitations or on Win98 w/o IE6 with strong crypto support)<br />
New version of this plugin will be published when I rewrote it from scratch :)<br />
as i already said in prev post, I lost my sources.  <br />
<br />
When you rewrite it can you include support for Whirlpool algorithm possibly?  Also your installer puts the documentation in the wrong place.  It goes in NSISDIR/Docs/Crypto and the source code (when you rewrite it) should go in NSISDIR/Contrib/Crypto.<br />
SAM</div></div><hr />


<div class="post"><div class="posttop"><div class="username">sag47</div><div class="date">13th August 2007, 07:36</div></div><div class="posttext">Originally posted by CryptoNut <br />
Will this possibly support SHA-256 in the future?  <br />
http :// msdn2. microsoft. com/en-us/library/ms937738.aspx<br />
(had to link this way because now this forum has some dumb link approval system)<br />
<br />
Take out the spaces and you'll have your link.<br />
That is all of the supported hash algorithms supported by the CryptAPI.<br />
<br />
I've also added a link in the plugin's wiki page on nsis.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">sag47</div><div class="date">13th August 2007, 07:44</div></div><div class="posttext">Hi GAG,<br />
Hopefully this little snippet will help you rewrite your code faster.  Here is a code example I downloaded from another community I belong to that uses the CryptoAPI.<br />
SAM</div></div><hr />


<div class="post"><div class="posttop"><div class="username">sag47</div><div class="date">13th August 2007, 08:14</div></div><div class="posttext">Here is a slightly modified version of the the one above.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">GAG</div><div class="date">15th August 2007, 12:08</div></div><div class="posttext">Hi sag47<br />
<br />
Thank you for you support and updated NSIS Wiki page about my plugin.<br />
<br />
When you rewrite it can you include support for Whirlpool algorithm possibly?<br />
Whirlpool isn't included in any CrypoAPI implementation, so it can be implemented only using non-CryptoAPI method. If you can explain why Whirlpool is better than SHA-256|512, I'll try to add this algo.<br />
<br />
Also your installer puts the documentation in the wrong place.<br />
ok, will be placed in accordance to NSIS folder structure<br />
<br />
That is all of the supported hash algorithms supported by the CryptAPI.<br />
just check ALG_ID at MSDN (http://msdn2.microsoft.com/en-us/library/aa375549.aspx) and you'll see this note above CALG_SHA_256:<br />
Windows XP and Windows 2000/NT::  This algorithm is not supported.<br />
<br />
the only way to include support for SHA &gt;=256 bits is to create a CryptoAPI-independent implementation which will increase plugin size (I do not really care about disk space anymore :)<br />
<br />
well, I'll try to find more time now to implement some of your wishes ;)<br />
<br />
P.S. url tag needs to be approved? (see above)<br />
P.P.S. ALG_ID at MSDN: http://msdn2.microsoft.com/en-us/library/aa375549.aspx</div></div><hr />


<div class="post"><div class="posttop"><div class="username">********</div><div class="date">23rd February 2008, 16:48</div></div><div class="posttext">Well, the plug is broken not only on 98, but on 2000 as well.<br />
<br />
CryptAcquireContext=0x80090016</div></div><hr />


<div class="post"><div class="posttop"><div class="username">GAG</div><div class="date">23rd February 2008, 17:58</div></div><div class="posttext">what do you mean 'broken' ?<br />
plugin was developed on Win2k sp4 and it works OK on many systems</div></div><hr />


<div class="post"><div class="posttop"><div class="username">sag47</div><div class="date">25th February 2008, 15:18</div></div><div class="posttext">Why was this added to the Wiki?<br />
Note that it will likely to fail with CryptAcquireContext=0x80090016 error on systems prior to WinXP.<br />
http://nsis.sourceforge.net/mediawiki/index.php?title=Crypto_plug-in&amp;diff=14789&amp;oldid=12942<br />
At the moment there doesn't appear to be sufficient research to indicate this problem with the exception of one person whose configuration could itself possibly be broken.<br />
<br />
I just tested the cryto 1.1 with the following script test using NSIS v2.34 on Windows 2000 SP4 user privileges only.<br />
 Crypto::HashFile &quot;MD5&quot;  &quot;$WINDIR\notepad.exe&quot;<br />
 Pop $0<br />
 MessageBox MB_OK $0<br />
The message returned was null and no hash was return yet I didn't get the error like the user above specified so I think before the wiki is edited that further testing is required.<br />
SAM</div></div><hr />


<div class="post"><div class="posttop"><div class="username">sag47</div><div class="date">25th February 2008, 15:28</div></div><div class="posttext">Originally posted by ******** <br />
Well, the plug is broken not only on 98, but on 2000 as well.<br />
<br />
CryptAcquireContext=0x80090016  <br />
<br />
Provide more specs as to how you got that error.  Just saying &quot;it's broken&quot; doesn't help with anything.  I can't (or don't know how) to produce that error.  Please provide the following:<br />
 Example of the code used to produce error<br />
 OS and service pack version (of all systems tested on)<br />
 user privileges on those systems<br />
 Any other valuable information that you think would lead to producing the error and/or fixing the problem.<br />
Thanks,<br />
SAM</div></div><hr />


<div class="post"><div class="posttop"><div class="username">********</div><div class="date">10th March 2008, 13:30</div></div><div class="posttext">Simply launched HashCalc.exe<br />
Windows2000 SP4<br />
Local Administrator<br />
No domain</div></div><hr />


<div class="post"><div class="posttop"><div class="username">GAG</div><div class="date">12th March 2008, 09:16</div></div><div class="posttext">Workaround for NTE_BAD_KEYSET error will be added.<br />
Anyway I do not understand, why someone named Techtonik added  to wiki article his note about mentioned error in Introduction  (!!!) section. If you want to say that it doesn't work on your system, do it in Remarks section, but in Introduction, please.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">sag47</div><div class="date">3rd April 2008, 15:53</div></div><div class="posttext">Originally posted by GAG <br />
Workaround for NTE_BAD_KEYSET error will be added.<br />
Anyway I do not understand, why someone named Techtonik added  to wiki article his note about mentioned error in Introduction  (!!!) section. If you want to say that it doesn't work on your system, do it in Remarks section, but in Introduction, please.  <br />
I don't know how to revert the history of the Wiki (hopefully you do GAG?).  I've tried to figure it out with no luck.  I'd prefer that the Note it will fail message in the Introduction stay out until whether or not this is a OS wide problem is figured out.<br />
SAM</div></div><hr />


<div class="post"><div class="posttop"><div class="username">7wolves</div><div class="date">15th May 2008, 09:52</div></div><div class="posttext">Who can tell me how I can get the source code? <br />
BTW, I encountered CryptAcquireContext=0x80090016 error in one of my machines with winxp sp2.<br />
Thanks</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">18th March 2009, 03:40</div></div><div class="posttext">just gonna cross-reference a post made to a wrong thread here:<br />
http://forums.winamp.com/showthread.php?postid=2497982#post2497982<br />
<br />
A user saw some odd behavior from the Crypto plugin, in that the Popped value appears empty, while $0 contains the actual result;<br />
[quote]I'd guess that nothing actually gets set on the stack (as the Pop results in the Errors flag being set) and instead the Crypto plugin dumps its result in $0 directly. Not a huge issue (although not encouraged), but something that should probably be noted in the docs.[/code]</div></div><hr />


<div class="post"><div class="posttop"><div class="username">GAG</div><div class="date">18th March 2009, 13:32</div></div><div class="posttext">see sample script CryptoTest.nsi:<br />
<br />
<br />
SubSection /e &quot;SHA1&quot;<br />
Section &quot;String Data&quot;<br />
  SectionIn 1 2<br />
  DetailPrint &quot;${Sep01}&quot;<br />
  DetailPrint &quot;SHA1 String Hash&quot;<br />
  DetailPrint &quot;&quot;<br />
  DetailPrint &quot;Crypto::HashData 'SHA1' '${HashStr}'&quot;<br />
  Crypto::HashData &quot;SHA1&quot; &quot;${HashStr}&quot;<br />
  Pop $0<br />
  DetailPrint &quot;Result:&quot;<br />
  DetailPrint &quot;String: '${HashStr}'&quot;<br />
  DetailPrint &quot;SHA1: [$0]&quot;<br />
  DetailPrint &quot;&quot;<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">18th March 2009, 13:41</div></div><div class="posttext">GAG:<br />
<br />
<br />
        StrCpy $0 &quot;D0&quot;<br />
        StrCpy $1 &quot;D1&quot;<br />
        Crypto::HashFile &quot;MD5&quot; &quot;$WINDIR\notepad.exe&quot;<br />
        ClearErrors<br />
        Pop $1<br />
        ${If} ${Errors}<br />
                MessageBox MB_OK &quot;Pop error!&quot;      <br />
        ${EndIf}<br />
        MessageBox MB_OK &quot;[$0][$1]&quot;<br />
<br />
Throws the Pop error messagebox, and the 2nd messagebox shows that $1 still reads &quot;D1&quot;, while $0 shows the MD5 hash.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">sag47</div><div class="date">8th September 2009, 15:23</div></div><div class="posttext">CryptAcquireContext=0x80090016<br />
Here is an MSDN article that describes the CryptAcquireContext error codes.<br />
<br />
http://support.microsoft.com/kb/238187<br />
<br />
Thought that would help with further development.  Specifically with that error:<br />
NTE_BAD_KEYSET (0x80090016) Key container does not exist.<br />
 You do not have access to the key container.<br />
 The Protected Storage Service is not running.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">nvit</div><div class="date">11th November 2010, 14:04</div></div><div class="posttext">I got CryptAcquireContext=0x80090016 error on 3 of 5 machines with Win XP SP3. <br />
The errors can be shown just by HashCalc.exe.<br />
Is there some workaround?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">nvit</div><div class="date">11th November 2010, 15:32</div></div><div class="posttext">Crypto plugin has a bug. It's 100%. <br />
So I've replaced it by MD5 plugin (http://nsis.sourceforge.net/MD5_plugin)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">sag47</div><div class="date">12th November 2010, 17:50</div></div><div class="posttext">Thanks for posting an alternative.  The source appears to be lost for the Crypto Plugin so I don't know if the bug will ever be fixed.  I'm not the original creator.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jdpipe</div><div class="date">27th March 2011, 10:29</div></div><div class="posttext">This plugin fails for me on Windows 7 using the provided 'HashCalc' example. The error NTE_BAD_KEYSET (0x80090016) is given. I built the installer and also tested the resulting HaskCalc on Windows XP and I get the same error.<br />
<br />
So I conclude that something might have changed in Windows Crypto and this plugin for NSIS is now completely unusable unless someone works out how to fix it.<br />
<br />
Update: it may be that users outside the United States see this error only, if this is something to do with the plugin depending on a hobbled version of some Windows DLL that doesn't provide the required functionality...?</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>