<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Code to handle file version, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Code to handle file version NSIS Discussion" />
	
	<title> Code to handle file version [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Code to handle file version</div>
<hr />
<div class="pda"><a href="t-247949.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=247949">Code to handle file version</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Maxim30</div><div class="date">5th June 2006, 23:56</div></div><div class="posttext">Hello,<br />
I would install some files only if them have version above those existing; so I have written the following code to recognize the file version, but it does not work:<br />
<br />
StrCpy $R0 &quot;Filename&quot;<br />
StrCpy $0 VersionMajor<br />
StrCpy $1 VersionMinor<br />
StrCpy $2 BuildMajor<br />
StrCpy $3 BuildMinor<br />
Call IfVersionAbove<br />
StrCmp $R1 &quot;DontCopy&quot; +2<br />
File Filename<br />
...<br />
<br />
<br />
Function IfVersionAbove<br />
<br />
  StrCpy $R1 &quot;DontCopy&quot;<br />
  GetDllVersion &quot;$WINDIR\System\$R0&quot; $8 $9<br />
  IntOp $R2 $8 / 0x00010000<br />
  IntOp $R3 $8 &amp; 0x0000FFFF<br />
  IntOp $R4 $9 / 0x00010000<br />
  IntOp $R5 $9 &amp; 0x0000FFFF<br />
  ${If} $R2 &lt; $0<br />
    StrCpy $R1 &quot;Copy&quot;<br />
    ${ElseIf} $R2 == $0<br />
    ${AndIf} $R3 &lt; $1<br />
    StrCpy $R1 &quot;Copy&quot;<br />
       ${ElseIf} $R3 == $1<br />
       ${AndIf} $R4 &lt; $2<br />
       StrCpy $R1 &quot;Copy&quot;<br />
          ${ElseIf} $R4 == $2<br />
          ${AndIf} $R5 &lt;= $3<br />
          StrCpy $R1 &quot;Copy&quot;<br />
  ${EndIf}<br />
FunctionEnd<br />
<br />
Can you give me the working code ?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comperio</div><div class="date">6th June 2006, 05:47</div></div><div class="posttext">There are some version handling functions included with NSIS.  (Look in your help files under Appendix E, &quot;Word Functions Header&quot;)<br />
<br />
You might find other examples in thedeveloper's section of the WIKI (http://nsis.sourceforge.net/Developer_Center)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">6th June 2006, 11:16</div></div><div class="posttext">http://nsis.sourceforge.net/VersionCompare<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Maxim30</div><div class="date">7th June 2006, 22:39</div></div><div class="posttext">Hello,<br />
<br />
I have the following code now but it does not work:<br />
<br />
  !include &quot;WordFunc.nsh&quot;<br />
  !insertmacro VersionCompare<br />
  ...<br />
  GetDllVersion &quot;$WINDIR\System\$Filename&quot; $R8 $R9<br />
  SetOverwrite on<br />
  IfErrors +9<br />
  IntOp $R1 $R8 / 0x00010000  ; Version major<br />
  IntOp $R2 $R8 &amp; 0x0000FFFF  ; Version minor<br />
  IntOp $R3 $R9 / 0x00010000  ; Build major<br />
  IntOp $R4 $R9 &amp; 0x0000FFFF  ; Build minor<br />
  StrCpy $R5 &quot;$R1.$R2.$R3.$R4&quot;    ; Version<br />
  ${VersionCompare} &quot;$R5&quot; &quot;$R7&quot; $R6<br />
  StrCmp $R6 2 +3<br />
  StrCmp $R6 1 +3    ; $R6=0, equal; $R6=1, Version is newer; $R6=2, Version is older<br />
  SetOverwrite ifnewer<br />
  File &quot;${SourceSetup}\$Filename&quot;<br />
<br />
I would install files only if existing have version below ($R6=2) or if existing have the same version and are older ($R6=0); but in the case $R6=2 (and it is checked) the +3 jump does not work not considering the 'File' instruction:  Why ?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">7th June 2006, 23:22</div></div><div class="posttext">Surely this will work:<br />
<br />
StrCmp $R6 1 +2<br />
File &quot;${SourceSetup}\$Filename&quot;<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Maxim30</div><div class="date">9th June 2006, 22:48</div></div><div class="posttext">Hello,<br />
I have found that the SetOverwrite instruction is not considered by the StrCmp jumps so it needs to decrease the goto by +1. But even so, one of the jumps does not work.<br />
I have had to use the LogicLib instructions to make the code works.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>