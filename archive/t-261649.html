<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Pass large array to external DLL using System::Call, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Pass large array to external DLL using System::Call NSIS Discussion" />
	
	<title> Pass large array to external DLL using System::Call [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Pass large array to external DLL using System::Call</div>
<hr />
<div class="pda"><a href="t-261649.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=261649">Pass large array to external DLL using System::Call</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">charlies</div><div class="date">12th December 2006, 23:11</div></div><div class="posttext">I am trying to call an external DLL that expects a 112 byte array of binary data. The 'C' prototype looks like:<br />
unsigned long ExternalFunction(unsigned long param1,<br />
unsigned char* pParam2,<br />
unsigned long param3,<br />
unsigned long param4,<br />
unsigned long* pParam5);<br />
<br />
It is pParam2 that needs to be a fixed buffer of 112 bytes of data. I am calling the function as follows and receiving a valid (but ERROR) return code.<br />
<br />
System::Call 'ExternalDLL::ExternalFunction(i,*i,i,i,*v) i (0x12345678,.r0r0,0x4321,10,.r1r1) .r2'<br />
<br />
Any suggestions about how to populate $0 with the address of an array of 112 constant, hexadecimal values?<br />
<br />
- Charlie</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comm@nder21</div><div class="date">13th December 2006, 17:49</div></div><div class="posttext">try this:<br />
<br />
System::Call 'ExternalDLL::ExternalFunction(i 0x12345678, t .r0, i 0x4321, i 10, *i .r1) i .r2'</div></div><hr />


<div class="post"><div class="posttop"><div class="username">charlies</div><div class="date">13th December 2006, 18:47</div></div><div class="posttext">comm@nder21,<br />
Thanks for the response, but that did not work either as the data in $0 may have NULLs. I have read brainsucker's System Plug-in doc and have a better idea about how things work, but have yet to get to a working solution. I am presently investigating the allocation of a structure of longlongs as follows:<br />
<br />
System::Call '*(l 0x1234567890123456, l ... ) i.s'<br />
Pop $0<br />
<br />
with the ... filled in with the remaining 13 longlong values in order to populate an allocated pointer with my 112 bytes of data. I then changed the call to be:<br />
<br />
System::Call 'MyDLL::MyFunction(i,i,i,i,*v) i (0x1234567,r0,0x321,10,.r1) .r2'<br />
<br />
I chose the parameter type (i r0) based upon the structure passing documentation in brainsucker's doc. Any idea if I am on the right path?<br />
<br />
- Charlie</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">14th December 2006, 20:10</div></div><div class="posttext">You are on the right track. The only problem I see in the current code is the last parameter type. `v` is not a valid parameter type, You should use `i`.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">charlies</div><div class="date">14th December 2006, 23:04</div></div><div class="posttext">kichik,<br />
Thanks for taking the time to look into my problem. After reading more of brainsucker's docs (and writing a C DLL in order to debug), I was finally to come up with a solution/hack.<br />
<br />
First, as you mention '*v' is not valid (except as a void return type I believe). 'v' might have worked. In any case, the Call interface became:<br />
<br />
System::Call 'MyDLL::MyFunction(i,i,i,i,i) i (0x1234567,r0,0x321,10,r1) .r2'<br />
<br />
Second, I had to slightly modify my method to fill a binary array because of Intel byte ordering (little endian).<br />
<br />
System::Call '*(l 0x1234567890123456, l ... ) i.s'<br />
Pop $0<br />
<br />
became<br />
<br />
System::Call '*(l 0x5634129078563412, l ... ) i.s'<br />
Pop $0<br />
<br />
Changing all 14 longlong definitions was a pain, but I could not find any other way to force the bytes into a buffer without incidental padding.<br />
<br />
e.g. System::Call '*(i 0x56, i 0x34, i 0x12 ... ) i.s'<br />
Pop $0<br />
<br />
yields 0x560000003400000012000000. I could have written a C DLL that performed the binary array declatation for me and called 'MyFunction' from the DLL, but I was hoping for a native NSIS solution. If anyone has a solution to filling a buffer with arbitrary binary data, I'd be happy to try it, but for now, I have a functional solution.<br />
<br />
- Charlie</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">14th December 2006, 23:24</div></div><div class="posttext">Use `&amp;i1` instead of just `i` to avoid the padding.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">charlies</div><div class="date">19th December 2006, 21:04</div></div><div class="posttext">kichik,<br />
Thanks for the suggestion. Some external changes to my application environment required that my 112 bytes of data be changed, so I decided to try your suggestion. I was eventually able to get it to work, but I could not use the &amp;i1 for all 112 bytes of data in a single call (perhaps too many function parameters?). I ended up using Alloc and then setting 16 bytes at a time, padding the lower bytes as follows:<br />
<br />
System::Call '*$0(&amp;i1 0x00, &amp;i1 0x01, ..., &amp;i1 0x0F)'<br />
System::Call '*$0($i16, &amp;i1 0x10, &amp;i1 0x11, ..., &amp;i1 0x1F)'<br />
...<br />
System::Call '*$0($i96, &amp;i1 0x60, &amp;i1 0x61, ..., &amp;i1 0x6F)'<br />
<br />
A bit crude, but acceptable and not too difficult to maintain.<br />
<br />
Thanks again for your insights.<br />
- Charlie</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>