<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Crash when getting user's groups, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Crash when getting user's groups NSIS Discussion" />
	
	<title> Crash when getting user's groups [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Crash when getting user's groups</div>
<hr />
<div class="pda"><a href="t-302450.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=302450">Crash when getting user's groups</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">TobbeSweden</div><div class="date">26th January 2009, 09:53</div></div><div class="posttext">Why does the following code crash sometimes when I run it?<br />
<br />
Name &quot;EnumUsersGroups&quot;<br />
OutFile &quot;EnumUsersGroups.exe&quot;<br />
<br />
!macro GetUserGroups SERVER_NAME USERNAME GROUP_ARRAY_NAME<br />
    Push $R0<br />
    Push $R1<br />
    Push $R2<br />
    Push $R3<br />
<br />
    # NET_API_STATUS NetUserGetLocalGroups(<br />
    #     __in   LPCWSTR servername,<br />
    #     __in   LPCWSTR username,<br />
    #     __in   DWORD level,<br />
    #     __in   DWORD flags,<br />
    #     __out  LPBYTE *bufptr,<br />
    #     __in   DWORD prefmaxlen,<br />
    #     __out  LPDWORD entriesread,<br />
    #     __out  LPDWORD totalentries<br />
    # );<br />
<br />
    # $R0 buffer with an array of LOCALGROUP_USERS_INFO_0 structures<br />
    # $R1 holds the number of entries processed<br />
    System::Call 'netapi32::NetUserGetLocalGroups(w &quot;${SERVER_NAME}&quot;, w &quot;${USERNAME}&quot;, \<br />
        i 0, i 0, *i .R0, i ${NSIS_MAX_STRLEN}, *i .R1, *i .R2) i .R3'<br />
    StrCpy $R2 $R0 ; Needed to free the buffer later<br />
<br />
    # check for error<br />
    StrCmp $R3 0 +1 +2<br />
<br />
    System::Call &quot;*$R0(w.R3)&quot;<br />
<br />
    # Cleanup<br />
    StrCmp $R2 0 +2<br />
        System::Call 'netapi32.dll::NetApiBufferFree(i R2) i .R0'<br />
<br />
    Pop $R3<br />
    Pop $R2<br />
    Pop $R1<br />
    Pop $R0<br />
!macroend<br />
<br />
!define GetUserGroups &quot;!insertmacro GetUserGroups&quot;<br />
<br />
ShowInstDetails show<br />
Page instfiles<br />
<br />
Section &quot;&quot;<br />
    ${GetUserGroups} &quot;&quot; &quot;Tobbe&quot; GroupArray<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TobbeSweden</div><div class="date">26th January 2009, 10:10</div></div><div class="posttext">I have trimmed the code down in the post above to show the minimal code that still crashes.<br />
<br />
If I remove the line 'System::Call &quot;*$R0(w.R3)&quot;' the crash goes away.<br />
<br />
What am I doing wrong?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">26th January 2009, 14:18</div></div><div class="posttext">other than the fact that you are passing NSIS_MAX_STRLEN for some weird reason, I don't see anything wrong<br />
<br />
this code works fine for me!define USERNAME Anders<br />
System::Call 'netapi32::NetUserGetLocalGroups(i 0, w &quot;${USERNAME}&quot;,i 0, i 0, *i .R0, i -1, *i .R1, *i .R2)i.R3'<br />
StrCpy $0 $R0<br />
loop:<br />
${If} $R1 &gt; 0<br />
	System::Call &quot;*$0(w.r1)&quot;<br />
	DetailPrint &quot;$R1: $1&quot;<br />
	IntOp $0 $0 + 4<br />
	IntOp $R1 $R1 - 1<br />
	goto loop<br />
${EndIf}<br />
System::Call 'netapi32.dll::NetApiBufferFree(i $R0)i.R0'<br />
<br />
Also, don't forget that a user might have deny only groups  in their token, so even if administrator is returned, your process might not have admin rights (use the userinfo plugin for this detection)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TobbeSweden</div><div class="date">26th January 2009, 14:34</div></div><div class="posttext">The reason I had NSIS_MAX_STRLEN was because that's what the original macro had... http://nsis.sourceforge.net/User_Management_using_API_calls#Get_User.E2.80.99s_Group.28s.29<br />
<br />
Using -1 instead stops it from crashing :D Thanks a lot!<br />
<br />
Am I correct in assuming that -1 is the biggest possible value for that parameter?<br />
<br />
Also, don't forget that a user might have deny only groups in their tokenI don't understand this. Can you please explain more?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">26th January 2009, 22:14</div></div><div class="posttext">-1 = MAX_PREFERRED_LENGTH<br />
<br />
I don't know why you need this code, but you just need to know that even if NetUserGetLocalGroups returns with Administrator as a group, it does not mean that you can do admin stuff, it is not the correct way to check if the current process has admin rights</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TobbeSweden</div><div class="date">26th January 2009, 23:11</div></div><div class="posttext">Thanks.<br />
<br />
I'm not using this to check if the current process has admin rights :)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>