<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" install folder name length limitation, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  install folder name length limitation NSIS Discussion" />
	
	<title> install folder name length limitation [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  install folder name length limitation</div>
<hr />
<div class="pda"><a href="t-261331.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=261331">install folder name length limitation</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">bowman2</div><div class="date">8th December 2006, 08:43</div></div><div class="posttext">What is the length limitation for the folder you wish to install to?<br />
<br />
When installing into a folder with a name of about 200 characters, a write error is issued and nothing is copied.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">8th December 2006, 10:22</div></div><div class="posttext">Windows<br />
#define MAX_PATH 260</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bowman2</div><div class="date">8th December 2006, 10:42</div></div><div class="posttext">Then why does the installer show the error box as in the attached image?<br />
<br />
The folder name is not that long. Is this a bug?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">8th December 2006, 11:08</div></div><div class="posttext">This limit includes both path and file name.<br />
Use CreateDirectory or SetOutPath to dest. folder first to ensure that folder exists. GetLastError can give error code http://forums.winamp.com/showthread.php?s=&amp;threadid=232489&amp;highlight=GetLastError</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dbyron</div><div class="date">6th October 2008, 04:10</div></div><div class="posttext">I think the MAX_PATH limit is only on relative paths, and any individual component of a path name.  At least that's my reading of http://msdn.microsoft.com/en-us/library/aa365247(VS.85).aspx.<br />
<br />
That page says the limit of an absolute path is ~32,000 characters.<br />
<br />
I ran into a snag where I entered a long filename as the installation directory.  The directory name is valid according to the above page, but I also have C code that can create it, remove it, etc.  I used:<br />
<br />
C:\Program Files\foo\XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX XXXXXXXXXX\foo<br />
<br />
The snag is that GetInstDirError tells me the directory is valid but SetOutPath fails to create the directory and sets the error flag.<br />
<br />
If I don't trap the error, I see a dialog box for the first File statement after SetOutPath that says &quot;Error opening file for writing.&quot;<br />
<br />
What are the chances of adding support for file/directory names &gt; MAX_PATH?  In the meantime, I have a feeling it'd be more consistent for GetInstDirError to report an invalid directory but I've only got a bit of experience with this function so I'm not sure yet.<br />
<br />
Thanks.<br />
<br />
-DB</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">6th October 2008, 06:34</div></div><div class="posttext">Only some of the windows api supports long paths, but you need to prefix the path with \\?\ and only the unicode api's supports this, so you will never see support for this in the ansi version of nsis</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dbyron</div><div class="date">6th October 2008, 12:52</div></div><div class="posttext">I didn't realize there was an ansi version of nsis.  Does this mean there's also a unicode version?<br />
<br />
What do you think about how GetInstDirErr handles this directory?  Shouldn't it report it as invalid?<br />
<br />
-DB</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">6th October 2008, 14:16</div></div><div class="posttext">the &quot;normal&quot; version you get from nsis.sf.net is ansi, unicode fork is @ http://www.scratchpaper.com/</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dbyron</div><div class="date">6th October 2008, 19:42</div></div><div class="posttext">Thanks for the link.  Still curious about the directory verification / GetInstDirErr.<br />
<br />
I just peeked into the NSIS source for the first time, but changing the EW_CREATEDIR code in exehead/exec.c to build a unicode string, prefix it with \\?\ and call CreateDirectoryW doesn't seem so bad.  It wouldn't get me all the way, but it seems like a step in the right direction.<br />
<br />
I'd probably need to call GetProcAddress to make sure the function is available...got to look around the code to see the nsis way of dealing with that.<br />
<br />
I took a quick look at is_valid_instpath.  I'll have to dig deeper to see what it would take to decide the path is invalid.  Looks like an explicit length check may be it.  I haven't found the definition of NSIS_MAX_STRLEN but it looks like is_valid_instpath only looks at that many characters of whatever it's passed.<br />
<br />
Any idea what the chances of patches for either place getting accepted are?<br />
<br />
-DB</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">6th October 2008, 21:24</div></div><div class="posttext">k, here is the deal, only the low level file api's support those long paths, not the shell stuff like ShellExecute(ExecShell) and probably CreateShortcut. So if you change nsis so it uses \\?\, some stuff would work and other stuff would not. NSIS_MAX_STRLEN is 1024 in default build</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dbyron</div><div class="date">6th October 2008, 21:43</div></div><div class="posttext">I realize that not all the windows APIs work with long filenames.  Just having SetOutPath and File work could be enough for some folks (like me) though.  Having some support seems better than none.<br />
<br />
Since Windows Explorer doesn't handle long filenames in all cases, maybe I'm just barking up the wrong tree.  Or maybe there are places where calling GetShortPathName to get things to work is the way to go.  That worked for me to get CreateProcessW to execute processes that have long names.  Maybe it would work for ShellExecute as well.<br />
<br />
A NSIS_MAX_STRLEN of 1024 means I need to dig in further.  The path I gave isn't that long so it wasn't getting truncated but somehow it's still considered valid which doesn't seem right.<br />
<br />
-DB</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">6th October 2008, 21:49</div></div><div class="posttext">you can use FileMon/Process Monitor to see if the path nsis tries to access is invalid or not</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dbyron</div><div class="date">6th October 2008, 22:30</div></div><div class="posttext">Interesting.  For a path of:<br />
<br />
C:\Program Files\foo\XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX XXXXXXXXXX\foo<br />
<br />
the only paths that show up in ProcMon are C:\, C:\Program Files and c:\Program Files\foo.<br />
<br />
From looking at the code, it seems like the FindFirstFile in file_exists returns INVALID_HANDLE_VALUE if the path is too long, so file_exists returns NULL.  That makes the code in is_valid_instpath just skip over that part of the path.<br />
<br />
I just did a quick test and FindFirstFile fails with GetLastError() set to ERROR_FILENAME_EXCED_RANGE (206) when given a filename that's too long.  Not sure what the most pleasing way to use that info is...the simplest way is probably to check<br />
if (!fd &amp;&amp; (GetLastError() == ERROR_FILENAME_EXCED_RANGE))<br />
  return 0;<br />
<br />
in is_valid_instpath but that's a bit unclean.  Keeping the GetLastError() code in file_exists probably means changing the signature of that function.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jamesrf</div><div class="date">7th January 2009, 18:10</div></div><div class="posttext">I am suffering this problem too. Are you saying that the Unicode build will allow long filenames?<br />
<br />
I just need File and SetOutPath to support long filenames...<br />
<br />
Cheers.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>