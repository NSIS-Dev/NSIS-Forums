<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Cookies, take 2, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Cookies, take 2 NSIS Discussion" />
	
	<title> Cookies, take 2 [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Cookies, take 2</div>
<hr />
<div class="pda"><a href="t-205287.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=205287">Cookies, take 2</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">DBecker</div><div class="date">18th January 2005, 20:38</div></div><div class="posttext">Hello all,<br />
We have created the following function that checks if specific cookies exist in the cookies folder (format: user@CookieName[3], user@CookieName[2], user@CookieName[1]. When a cookie is found it should take some text from within the cookie and plug it into the PC's registry. <br />
The problem is that it doesn't work the first time and the only predictable way is to run the setup twice (with no uninstall after the first time). During the second install it works.<br />
I am pasting the code here and would appreciate any ideas that users of this forum may have. <br />
Thanks a lot,<br />
David<br />
<br />
---- CODE STARTS HERE ----<br />
<br />
;Cookie read and record functions<br />
<br />
 ; TrimNewlines<br />
 ; input, top of stack  (e.g. whatever$\r$\n)<br />
 ; output, top of stack (replaces, with e.g. whatever)<br />
 ; modifies no other variables.<br />
 Function TrimNewlines<br />
   Exch $R0<br />
   Push $R1<br />
   Push $R2<br />
   StrCpy $R1 0<br />
<br />
 loop:<br />
   IntOp $R1 $R1 - 1<br />
   StrCpy $R2 $R0 1 $R1<br />
   StrCmp $R2 &quot;$\r&quot; loop<br />
   StrCmp $R2 &quot;$\n&quot; loop<br />
   IntOp $R1 $R1 + 1<br />
   IntCmp $R1 0 no_trim_needed<br />
   StrCpy $R0 $R0 $R1<br />
<br />
 no_trim_needed:<br />
   Pop $R2<br />
   Pop $R1<br />
   Exch $R0<br />
 FunctionEnd<br />
 <br />
;Will detect and register the Cookie in the registry<br />
Function RegisterKBID<br />
Push $R0<br />
;Search for the first cookie<br />
 FindFirst $R0 $R1 &quot;$COOKIES\*.*&quot;<br />
 Loop:<br />
  IfErrors Done<br />
   ;Find the most recent cookie - as the IE enumerates them by [x] value, while the biggest is the latest.<br />
   ;There shouldn't be more then 1, but for any case...<br />
   StrCpy $R2 $R1 &quot;&quot; -24<br />
   StrCmp $R2 &quot;@testcookie[3].txt&quot; OpenCookie<br />
   StrCmp $R2 &quot;@testcookie[2].txt&quot; OpenCookie<br />
   StrCmp $R2 &quot;@testcookie[1].txt&quot; 0 NextCookie<br />
;Open the cookie<br />
   OpenCookie:<br />
    FileOpen $R2 &quot;$COOKIES\$R1&quot; &quot;r&quot;<br />
    CookieLoop:<br />
     ClearErrors<br />
;Read the first line of the cookie<br />
     FileRead $R2 $R3<br />
      IfErrors CookieDone<br />
<br />
      ;Find the cookie id<br />
      Push $R3<br />
      ;Trim the /r and /n characters<br />
       Call TrimNewLines<br />
      Pop $R3<br />
      ;See whether it's a valid cookie, i.e. it contains the KBID identifier<br />
      StrCmp $R3 &quot;KBID&quot; 0 CookieLoop<br />
<br />
       ;Get the KBID value<br />
       FileRead $R2 $R3<br />
        Push $R3<br />
      ;Trim the /r and /n characters again<br />
         Call TrimNewLines<br />
        Pop $R3<br />
        <br />
        ;Write it in the registry<br />
        WriteRegStr HKLM &quot;Software\TestCookie&quot; &quot;client_id&quot; &quot;$R3&quot;<br />
<br />
       CookieDone:<br />
       FileClose $R2<br />
       Goto Done<br />
  ;Go to the next cookie<br />
  NextCookie:<br />
  ClearErrors<br />
  FindNext $R0 $R1<br />
  Goto Loop<br />
 Done:<br />
 FindClose $R0<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">robber98</div><div class="date">19th January 2005, 22:35</div></div><div class="posttext">Have you try &quot;InternetGetCookieEx&quot; from Wininet library?  You can use system.dll to call this function and &quot;retrieves data stored in cookies associated with a specified URL&quot;. <br />
<br />
FYI: http://msdn.microsoft.com/library/en-us/wininet/wininet/internetgetcookieex.asp?frame=true :)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>