<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" GetTempFileName bug on NT4, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  GetTempFileName bug on NT4 NSIS Discussion" />
	
	<title> GetTempFileName bug on NT4 [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  GetTempFileName bug on NT4</div>
<hr />
<div class="pda"><a href="t-130247.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=130247">GetTempFileName bug on NT4</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">nickm</div><div class="date">30th March 2003, 05:34</div></div><div class="posttext">I'm using NSIS 2.0b3, and when testing on NT4 SP3, I found a problem where my plugin DLL occasionally mysteriously failed to load.<br />
<br />
On closer inspection, it turned out to be that GetTempFileName was failing, with an 'Access Denied' status. On NT4, if GetTempFileName generates a name like &quot;C:\TEMP\NST1.tmp&quot;, and that directory already exists, it will fail. (Regular files are simply deleted, but directories are not.)<br />
<br />
I've worked around it by replacing the call to GetTempFileName in exec.c with this:<br />
<br />
<br />
BOOL MyGetTempFileName(LPCTSTR path, LPCTSTR prefix, UINT unique, LPTSTR name)<br />
{<br />
    UINT retryCount = 100;<br />
<br />
    while(retryCount--)<br />
        if(GetTempFileName(path, prefix, unique, name)) <br />
            return TRUE;<br />
<br />
    return FALSE;<br />
}</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">30th March 2003, 11:53</div></div><div class="posttext">Can you please explain exactly when GetTempFileName fails? Which directory should not exist?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">nickm</div><div class="date">30th March 2003, 13:33</div></div><div class="posttext">Ok, this is happening when trying to create the plugins directory, to extract a plugin dll. The EW_GETTEMPFILENAME opcode gets a temp filename like this:<br />
<br />
GetTempFileName(temp_directory,&quot;nst&quot;,0,textout))<br />
<br />
On NT4, subsequent calls to this API will generate filenames with ascending sequence numbers, like this:<br />
<br />
C:\TEMP\nst1.tmp<br />
C:\TEMP\nst2.tmp<br />
C:\TEMP\nst3.tmp<br />
etc..<br />
<br />
Now, say that C:\TEMP\nst3.tmp does not get deleted for some reason. (e.g. setup gets interrupted.) After a reboot, the sequence numbers will start again at 1.  If GetTempFileName is called 3 times, it will try to create &quot;C:\TEMP\nst3.tmp&quot; again. <br />
<br />
On later versions of Windows, if nst3.tmp exists, GetTempFileName would skip to the next sequence number, and try to create nst4.tmp. However on NT4, if the file exists, and it is a directory (which in this case it is), it will try to create nst3.tmp, and fail with an Access Denied, because it is already there. The result is that the plugin does not get extracted, and fails to load.<br />
<br />
If you call GetTempFileName again, it will try the next sequence number,  &quot;C:\TEMP\nst4.tmp&quot;, which will succeed. So in my fix above, I just call GetTempFileName repeatedly until it works, and bail out after 100 iterations to prevent a possible hang.<br />
<br />
Hope this clarifies it. If not, let me know :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">30th March 2003, 13:43</div></div><div class="posttext">From MSDN:<br />
<br />
If uUnique is zero, the function attempts to form a unique file name using the current system time. If the file already exists, the number is increased by one and the functions tests if this file already exists. This continues until a unique filename is found; the function creates a file by that name and closes it. Note that the function does not attempt to verify the uniqueness of the file name when uUnique is nonzero.<br />
<br />
Even though, I'll check.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">nickm</div><div class="date">30th March 2003, 13:57</div></div><div class="posttext">Yep, it seems to work as described in MSDN if it is a regular file. However, if it is a directory (which it is, in this case), and it's NT4, it doesn't work.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RDaneel</div><div class="date">30th March 2003, 19:13</div></div><div class="posttext">This is probably strongly related to the &quot;bug&quot; part of my current thread &quot;MUI installer error on NT4&quot;... in that, I already have the accumulating junk (including folders) problem, which then escalates to &quot;execution failure&quot; on NT4. ;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">31st March 2003, 16:32</div></div><div class="posttext">There seems to be a bug in the GetTempFileName API. The unique file check (inside the API) does not always work. If it does not generate a unique file, the API failes.<br />
<br />
A work-around will be added later today.<br />
<br />
RDaneel: Can you try to add the code in the start post and check whether this solves your problem?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RDaneel</div><div class="date">1st April 2003, 01:22</div></div><div class="posttext">Joost - <br />
<br />
I dropped the following code in, replacing the EW_GETTEMPFILENAME case with:<br />
<br />
<br />
    case EW_GETTEMPFILENAME:<br />
      {<br />
        char *textout=var0;<br />
	int n = 100;<br />
	while (n--)<br />
	  if (GetTempFileName(temp_directory,&quot;nst&quot;,0,textout))<br />
	    return 0;<br />
        g_flags.exec_error++;<br />
        *textout=0;<br />
      }<br />
    return 0;<br />
<br />
<br />
The behavior is only slightly modified - NOT fixed.  When doing the install-with-reboot followed immediately by an install again (still on NT4), it now gets one complete cycle without any problems... but on the third install (so we are saying install-with-reboot ... install-with-reboot ... install-attempt -&gt; error), we get the same error with &quot;\\ioSpecial.ini&quot; and the abort-retry-ignore dialog.  With the original version of the temp-file code, it fails on the SECOND install.<br />
<br />
I do still go along with the idea that this has something to do with temp files/folders... it just wasn't quite this simple. :(<br />
<br />
<br />
A question for you and kickik: when I was looking at the project settings in VS6 prior to doing the new build (based on my BETA &quot;3a&quot; sources that came with that release), I noticed that the SINGLE-threaded C libraries are being used... I am not sure I would be brave enough to build this way but still spawn and execute additional threads!:eek:<br />
<br />
I wonder if this has anything to do with that reported SMP problem where the user never followed up (&quot;[ 676056 ] Currupted Exe's with SMP machines&quot;)?  Threading problems are notorious for not showing up until you actually run on a multi-processor machine, given that most of us still develop and test on uni-processor. ;)<br />
<br />
Let me know if I can run any more tests for you, but be aware of one thing - the makensis.exe that I built is ~3KB larger than the &quot;release&quot; BETA 3 version!  I run VS6 with SP5 AND the latest Platform SDK, so something about this environment is causing the difference, even though I only changed the above source and no project settings.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">1st April 2003, 13:58</div></div><div class="posttext">The size difference is not a problem. Maybe it's the Processor Pack or something like that.<br />
<br />
Can you please add a messagebox in .onInit and check the contents of $PLUGINSDIR (add the InitPlugsinsDir command first)?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">1st April 2003, 15:03</div></div><div class="posttext">RDaneel, can you post your ICQ/MSN # so we can try fix this problem?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">1st April 2003, 15:07</div></div><div class="posttext">Or drop by IRC.<br />
<br />
Processor Pack:<br />
http://msdn.microsoft.com/vstudio/downloads/tools/ppack/default.asp<br />
<br />
NSIS doesn't use runtime libraries only Windows API functions.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">1st April 2003, 18:31</div></div><div class="posttext">I have uploaded a compiled version of makensis.exe with some new fixes. It removes the pluginsdir when rebooting and GetTempFileName will be called in a loop.<br />
<br />
Download it using NSIS Update and post the results :) Please try it with some folders left in your temp dir too.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RDaneel</div><div class="date">1st April 2003, 20:11</div></div><div class="posttext">Joost/kichik -<br />
<br />
I don't have ICQ/MSN/AIM/etc IDs! :D <br />
<br />
However, just for you guys I have installed a copy of Trillian, and would actually go ahead and communicate through one of these mediums - my take on it is that IRC requires the least &quot;registration&quot; on my part, but any relatively specific tips/suggestions would be appreciated. :)<br />
<br />
kicjik - thanks for the &quot;Processor Pack&quot; link... I had never noticed that before (I had sort of wondered how one got &quot;support&quot; for these instructions without using an Intel development product).<br />
<br />
Joost - I did the NSIS Update you requested (the &quot;latest, clean&quot; option) and get the following error when I try to build an installer:<br />
<br />
Error: could not resolve label &quot;t_init&quot; in function &quot;un.Initialize_____Plugins&quot;<br />
<br />
Remember, I was starting with a BETA &quot;3a&quot; installation except for the &quot;looping&quot; change from yesterday in exec.c - which appears to have been incorporated, as you said... what else should I be doing?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">1st April 2003, 21:25</div></div><div class="posttext">You don't need to register to use IRC, just download a client like mIRC and you can chat with us.<br />
<br />
Do other example scripts work fine? Can you attach the script?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RDaneel</div><div class="date">2nd April 2003, 03:35</div></div><div class="posttext">ChatZilla (installed with my Mozilla 1.3) seems to work just fine - talking to the bot SuperPimp...<br />
<br />
Anyway, things look ugly regarding that NSIS build-installer-time error I reported in my last post... my script compiles fine with the released Beta 3 version, but with today's CVS version, it does NOT.  What is more disturbing (to me, anyway) is that relatively minor random changes in the script cause the error to change:<br />
<br />
could not resolve label &quot;t_init&quot; in function &quot;un.Initialize_____Plugins&quot;<br />
<br />
changes to messed-up forms of other labels in the either MY script or your [MUI] scripts.  Really. :weird:<br />
<br />
What is happening is that AFTER the Uninstall section is processed, NSIS then spits out<br />
<br />
Processed 1 file, writing output:<br />
Adding plug-ins initializing function... setting uninstall mode to true<br />
Done!<br />
<br />
immediately before a complaint about some script label... I think that the error above is about the label &quot;reboot_init&quot; from the MUI scripts.  I can make the error shift to complaining about a label in one of my macros being instantiated in an uninstaller function, ALSO with characters dropped from the front. :(<br />
<br />
To answer your question, other simpler scripts work fine - your examples or some test scripts of mine.  I will attach my script since you ask, but it is 353 lines and refers [of course] to an EXE and a DLL of mine. ;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RDaneel</div><div class="date">2nd April 2003, 07:44</div></div><div class="posttext">Hmmm... that didn't seem to attach anything - I will try again. :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RDaneel</div><div class="date">2nd April 2003, 09:33</div></div><div class="posttext">I think I found the problem... well, not what causes it, but I have it down to a single script statement that causes NSIS to mess up its compilation:<br />
<br />
File /r &quot;d:\Help&quot;<br />
<br />
where &quot;d:\Help&quot; is a folder that I expect to be recursively included in the installer, and then expanded to &quot;$OUTDIR\Help&quot;.  This works fine (compilation and execution) with Beta &quot;3a&quot;, but with the current CVS Beta 4 causes the spurious<br />
<br />
Error: could not resolve label &quot;xxx&quot; in function &quot;Initialize_____Plugins&quot;<br />
<br />
error where the xxx is dependent on the rest of the script - which is suggestive of memory/pointer/length corruption. :(<br />
<br />
I have included a simplified version of my script showing the failure - comment out the &quot;File /r ...&quot; line and all is well, try to compile with it in, and...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">2nd April 2003, 09:40</div></div><div class="posttext">Thanks. I'll have a look at it later today. Please stay at the IRC channel, so we can chat when I'm back.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RDaneel</div><div class="date">2nd April 2003, 10:02</div></div><div class="posttext">Ummm... sure.  But do remember that I am in a GMT-8 time zone, which means that it is 2am right now, and I was planning on a bit of sleep (although I don't mind eating breakfast at my computer)... :D<br />
<br />
All of this means that I will be back (and on IRC) around 1730-1800 GMT.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">2nd April 2003, 15:50</div></div><div class="posttext">Think I fixed them all in the latest CVS version. Please check and report.<br />
<br />
It always amuses me how bullet proof to uninitialized memory problems my computer is and how bad Java can screw one's initializing skills ;)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>