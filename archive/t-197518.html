<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" DeleteRegKey shenanigans, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  DeleteRegKey shenanigans NSIS Discussion" />
	
	<title> DeleteRegKey shenanigans [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  DeleteRegKey shenanigans</div>
<hr />
<div class="pda"><a href="t-197518.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=197518">DeleteRegKey shenanigans</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">SmilingBandit</div><div class="date">26th October 2004, 18:55</div></div><div class="posttext">Ok, so I just hosed the registry entries for my program due to a bug/feature of DeleteRegKey.<br />
<br />
I am creating a registry key, with a few values.  During the uninstallation, I delete ONE of these registry values, then try to delete the registry key using /ifempty like this:<br />
DeleteRegKey /ifempty HKLM &quot;${REG_KEY}\CurrentVersion&quot;<br />
There are no sub-keys of the CurrentVersion key, but there are still values in the key.  So why does DeleteRegKey with delete that key when I'm using the ifempty?<br />
<br />
See attached script for a simple example</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pengyou</div><div class="date">26th October 2004, 19:25</div></div><div class="posttext">From the NSIS User Manual (http://nsis.sourceforge.net/Docs/Chapter4.html#4.9.2.3):If /ifempty is specified, the registry key will only be deleted if it has no subkeys (otherwise, the whole registry tree will be removed).The command is behaving as described in the manual.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">SmilingBandit</div><div class="date">26th October 2004, 19:43</div></div><div class="posttext">Ok, so I've found the root cause for this problem.  It turns out that the NSIS command DeleteRegKey is working just fine.  The C++ code behind it in 'NSIS\Source\exehead\exec.c' is actually calling RegDeleteKey.  According to the MSDN Platform SDK documentation, The RegDeleteKey function deletes a subkey, including all of its values. <br />
<br />
So thats how I hosed the registry values :( <br />
<br />
But I've found a solution.  SHDeleteEmptyKey will delete an empty key (one with no subkeys and no values) according to the MSDN docs.  That is a function of 'shlwapi.dll' which is a part of IE 4.0 and later.<br />
<br />
Now if anyone can tell me in a hurry how to call that function, please do.  Otherwise I'll figure it out eventually.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">27th October 2004, 04:39</div></div><div class="posttext">u can call SHDeleteEmptyKey with the system plugin...</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>