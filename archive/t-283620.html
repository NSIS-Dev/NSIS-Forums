<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Find and Replace within a text file, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Find and Replace within a text file NSIS Discussion" />
	
	<title> Find and Replace within a text file [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Find and Replace within a text file</div>
<hr />
<div class="pda"><a href="t-283620.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=283620">Find and Replace within a text file</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Das123</div><div class="date">22nd December 2007, 23:13</div></div><div class="posttext">Hello,<br />
<br />
I am a long time user of NSIS but only have a very superficial knowledge of what goes on under the hood. So please be very specific with what I need to do to get this to work if you can help. I've searched and found similar problems from other users but the answers appear to be more like 'hints' than instructions (I couldn't work them out at all).<br />
<br />
I essentially made a graphics mod installer for a game which just writes files into specific locations.<br />
<br />
The problem now is that the developer is updating the functionality of the game and adding options to the init file. My script simply replaces the whole init file (thus deleting any new options).<br />
<br />
What I want to do is have NSIS search through the existing init file and simply edit the lines with the new graphic options. There is no way of knowing if the line numbers will always be consistent (so I couldn't use LineFind), or if the option defaults will remain the same (so I need to be able to search using wildcards or partial lines).<br />
<br />
For example, I need to search through the file until it finds a line starting with:<br />
<br />
[GraphicOption:<br />
<br />
and then replace the whole line with:<br />
<br />
[GraphicOption: NewGraphicSet]<br />
<br />
I really hope someone can help me with this. I've looked at LineFind etc but I can't work them out.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">22nd December 2007, 23:39</div></div><div class="posttext">Here you are,<br />
!macro ReplaceStrFunc UN<br />
Function ${UN}ReplaceStr<br />
     Exch $0 <br />
     Exch<br />
     Exch $1 <br />
     Exch<br />
     Exch 2<br />
     Exch $2 <br />
     Push $3<br />
     Push $4<br />
     Push $5<br />
     Push $6<br />
<br />
        StrCpy $4 &quot;0&quot;<br />
        StrLen $5 &quot;$1&quot;<br />
        StrLen $6 &quot;$2&quot;<br />
        IntCmp $5 $6 0 0 _err<br />
        Intop $6 $6 - $5<br />
<br />
  _start:<br />
        StrCpy $3 &quot;$2&quot; $5 $4<br />
        StrCmp &quot;$3&quot; &quot;$1&quot; _next<br />
        IntCmp &quot;$4&quot; &quot;$6&quot; _err<br />
        Intop $4 $4 + 1<br />
        Goto _start<br />
<br />
   _next:<br />
        Intop $5 $5 + $4<br />
        StrCpy $3 &quot;$2&quot; &quot;$4&quot;<br />
        Push $3<br />
        StrCpy $3 &quot;$2&quot; &quot;&quot; &quot;$5&quot;<br />
        Push $3<br />
        Pop $5<br />
        Pop $4<br />
        StrCpy $0 &quot;$4$0$5&quot;<br />
        Goto _done<br />
<br />
    _err:<br />
        StrCpy $0 &quot;error&quot;<br />
<br />
   _done:<br />
     Pop $6<br />
     Pop $5<br />
     Pop $4<br />
     Pop $3<br />
     Pop $2<br />
     Pop $1<br />
     Exch $0<br />
FunctionEnd<br />
!macroend<br />
<br />
!macro ReplaceStrCall _UN _INPUT _FIND _REPLACE _RESULT<br />
    Push &quot;${_INPUT}&quot;<br />
    Push &quot;${_FIND}&quot;<br />
    Push &quot;${_REPLACE}&quot;<br />
    Call ${_UN}ReplaceStr<br />
    Pop &quot;${_RESULT}&quot;<br />
!macroend<br />
<br />
!macro FindRepStr<br />
    !define FindRepStr `!insertmacro ReplaceStrCall &quot;&quot;`<br />
    !insertmacro ReplaceStrFunc &quot;&quot;<br />
!macroend<br />
<br />
!macro un.FindRepStr<br />
    !define un.FindRepStr `!insertmacro ReplaceStrCall &quot;un.&quot;`<br />
    !insertmacro ReplaceStrFunc &quot;un.&quot;<br />
!macroend<br />
<br />
<br />
;----------------------------------------<br />
; Example of usage<br />
<br />
outfile 'test.exe'<br />
<br />
!define STRTOFIND  &quot;[GraphicOption:&quot;<br />
!define STRTOREPL  &quot;[GraphicOption: NewGraphicSet]&quot;<br />
<br />
!insertmacro FindRepStr<br />
;!insertmacro un.FindRepStr<br />
<br />
Section &quot;Usage Example&quot;<br />
  FileOpen $0 &quot;path_to_file_to_be_replaced&quot; r<br />
  FileOpen $1 &quot;$EXEDIR\example.txt&quot; w<br />
  loop:<br />
  FileRead $0 $2<br />
  IfErrors done<br />
  ${FindRepStr} &quot;$2&quot; &quot;${STRTOFIND}&quot; &quot;${STRTOREPL}&quot; &quot;$R0&quot;<br />
  StrCmp $R0 &quot;error&quot; 0 +3<br />
  FileWrite $1 &quot;$2&quot;<br />
  goto loop<br />
  FileWrite $1 &quot;$R0&quot;<br />
  goto loop<br />
  done:<br />
  FileClose $0<br />
  FileClose $1<br />
<br />
  ExecShell open &quot;$EXEDIR\example.txt&quot;<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Das123</div><div class="date">23rd December 2007, 01:02</div></div><div class="posttext">Thanks for your reply Red Wine.<br />
<br />
I've tried to test the script but I am getting a compile error. I placed the macros at the end of the script with the page functions but the compiler is not recognizing them.<br />
<br />
I was also unsure if this script will completely replace the line of code, or just the searched text. It is important that the whole line be replaced.<br />
<br />
Thanks</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">23rd December 2007, 07:39</div></div><div class="posttext">Name &quot;Test&quot;<br />
OutFile &quot;Test.exe&quot;<br />
<br />
!include &quot;TextFunc.nsh&quot;<br />
!insertmacro LineFind<br />
<br />
!define STRTOFIND &quot;[GraphicOption:&quot;<br />
!define STRTOREPL &quot;[GraphicOption: NewGraphicSet]&quot;<br />
<br />
Section<br />
	${LineFind} &quot;C:\Input.txt&quot; &quot;C:\Output.txt&quot; &quot;1:-1&quot; &quot;LineFindCallback&quot;<br />
<br />
	IfErrors 0 +2<br />
	MessageBox MB_OK &quot;Error&quot;<br />
SectionEnd<br />
<br />
Function LineFindCallback<br />
	StrLen $0 &quot;${STRTOFIND}&quot;<br />
	StrCpy $1 &quot;$R9&quot; $0<br />
	StrCmp $1 &quot;${STRTOFIND}&quot; 0 End<br />
	StrCpy $R9 &quot;${STRTOREPL}$\r$\n&quot;<br />
<br />
	End:<br />
	Push $0<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">23rd December 2007, 10:27</div></div><div class="posttext">Originally posted by Das123 <br />
Thanks for your reply Red Wine.<br />
<br />
I've tried to test the script but I am getting a compile error. I placed the macros at the end of the script with the page functions but the compiler is not recognizing them.<br />
<br />
I was also unsure if this script will completely replace the line of code, or just the searched text. It is important that the whole line be replaced.<br />
<br />
Thanks <br />
You should add the macro on the top of your code, same way like the provided example.<br />
Simply compile the provided example and watch the result if it satisfies you.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Das123</div><div class="date">23rd December 2007, 18:41</div></div><div class="posttext">Originally posted by Red Wine <br />
You should add the macro on the top of your code, same way like the provided example.<br />
Simply compile the provided example and watch the result if it satisfies you.  <br />
<br />
Thanks for the replies Red Wine and Instructor.<br />
<br />
I got the script to compile, Red Wine, but it still doesn't replace the whole line. It only replaces the searched text.<br />
<br />
I'll try Instructor's script and report back.<br />
<br />
Thanks again</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Das123</div><div class="date">23rd December 2007, 18:54</div></div><div class="posttext">Success!!<br />
<br />
Thanks Instructor. This works perfectly.<br />
<br />
One more question. How do I hide the process from the user? Is there a command to not show the section when it executes?</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>