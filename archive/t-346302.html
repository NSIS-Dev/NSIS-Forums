<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Impersonation Windows 7, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Impersonation Windows 7 NSIS Discussion" />
	
	<title> Impersonation Windows 7 [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Impersonation Windows 7</div>
<hr />
<div class="pda"><a href="t-346302.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=346302">Impersonation Windows 7</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">dr_awol</div><div class="date">12th July 2012, 11:31</div></div><div class="posttext">Im wondering is it possible to impersonate my admin user using nsis? I know the un and pw<br />
<br />
do i need to call System.dll,  how would i call the appropriate API functions?<br />
sorry if this is a silly question but im new to nsis.<br />
<br />
I will be logged in using with a standard user when running the installer <br />
<br />
Its this the correct route i should be following?<br />
<br />
http://forums.winamp.com/showthread.php?t=172544</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">12th July 2012, 11:41</div></div><div class="posttext">What is the goal? Why not just request admin rights like a normal installer?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dr_awol</div><div class="date">12th July 2012, 11:55</div></div><div class="posttext">the installer is going to have to make updates by impersonating admin, admin has a password which the standard user will not have access to(Restricted User), so when i call RequestExecutionLevel admin,this brings up UAC requesting the admin password which the standard user will never know.<br />
<br />
Is this possible with Nsis?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">14th July 2012, 12:19</div></div><div class="posttext">That post you linked has the code you want.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">14th July 2012, 12:44</div></div><div class="posttext">That post you linked has the code you want.<br />
<br />
Stu<br />
<br />
Just remember that impersonation is per thread (Will not affect CreateProcess, for that you have CreateProcess&lt;AsUser|With[Token|Logon]&gt; etc)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">15th July 2012, 23:50</div></div><div class="posttext">Yes and the code in Sections run in a different thread. So if you do impersonation in .onInit you will need to do it again in a first Section.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dr_awol</div><div class="date">16th July 2012, 10:31</div></div><div class="posttext">First thing thank you for the replys, ive tryied to implement the code as below, but im still running into problems:<br />
<br />
1st Massage box  : i get Number: 227633266688 this is a random number:<br />
2nd Massage box : i get Number: 25769803776<br />
then i get an Error message &quot;Error opening file for writing&quot; <br />
<br />
So i wondering if this is a permission thing? - not so sure of this as TestAdmin have full access rights on the c:\<br />
<br />
<br />
### User Impersanation <br />
!define USERNAME &quot;TestAdmin&quot;<br />
!define DOMAIN &quot;WIN-UJOVINKT6SI&quot;<br />
!define PASSWORD &quot;password1&quot;<br />
<br />
!define LOGON32_LOGON_INTERACTIVE       2<br />
!define LOGON32_LOGON_NETWORK           3<br />
!define LOGON32_LOGON_BATCH             4<br />
!define LOGON32_LOGON_SERVICE           5<br />
!define LOGON32_LOGON_UNLOCK            7<br />
!define LOGON32_LOGON_NETWORK_CLEARTEXT 8<br />
!define LOGON32_LOGON_NEW_CREDENTIALS   9<br />
<br />
!define LOGON32_PROVIDER_DEFAULT    0<br />
!define LOGON32_PROVIDER_WINNT35    1<br />
!define LOGON32_PROVIDER_WINNT40    2<br />
!define LOGON32_PROVIDER_WINNT50    3<br />
<br />
!define LogonUser &quot;advapi32::LogonUserA(t, t, t, i, i, *l) l&quot;<br />
!define ImpersonateLoggedOnUser &quot;advapi32::ImpersonateLoggedOnUser(l)l&quot;<br />
!define RevertToSelf &quot;advapi32::RevertToSelf() l&quot; <br />
<br />
<br />
Section &quot;App Applications&quot; App_Applications<br />
<br />
SetPluginUnload alwaysoff<br />
System::Call '${RevertToSelf}.r0'<br />
System::Call &quot;${LogonUser}('${USERNAME}', '${DOMAIN}', '${PASSWORD}', ${LOGON32_LOGON_INTERACTIVE}, ${LOGON32_PROVIDER_DEFAULT}, .r2) .r0&quot;<br />
messagebox mb_ok $0<br />
System::Call '${ImpersonateLoggedOnUser}(r2) .r0' <br />
messagebox mb_ok $0<br />
<br />
  setOutPath $INSTDIR\App_Applications<br />
      <br />
    #Program Files<br />
    file /r &quot;C:\App_Platform\Output\Debug\&quot; <br />
<br />
    System::Call '${RevertToSelf}.r0'<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">16th July 2012, 12:03</div></div><div class="posttext">Should probably be<br />
!define LogonUser &quot;advapi32::LogonUser(t, t, t, i, i, *i) i&quot; <br />
(change l to i) and since it returns BOOL really anything nonzero is success (but it is very rare that BOOL returning functions use anything other than 0 and 1)<br />
<br />
You should add ?e to the end of the command to get the windows error code.<br />
<br />
...and finally, if someone really wanted to they could find the password (Debugger, decompile installer or look at the memory at the right moment in process explorer)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>