<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" UAC plugin - bring installer window to foreground, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  UAC plugin - bring installer window to foreground NSIS Discussion" />
	
	<title> UAC plugin - bring installer window to foreground [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  UAC plugin - bring installer window to foreground</div>
<hr />
<div class="pda"><a href="t-324514.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=324514">UAC plugin - bring installer window to foreground</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">SteveRidout</div><div class="date">2nd December 2010, 11:36</div></div><div class="posttext">Hey,<br />
<br />
Thanks Anders for sharing your UAC plugin!<br />
<br />
I've got it working in our installer but there's one major problem, the installer window doesn't come to the foreground.<br />
<br />
I'm using v0.2.2c and I know that you've said there were some ugly hacks to get this working in an earlier version. My questions:<br />
<br />
1. Did the hacks result in any undesirable behaviour?<br />
<br />
2. Is there anything changed in v0.2.2c which would not allow them to work?<br />
<br />
3. Would it be easy for me to patch v0.2.2c to get this working?<br />
<br />
Before I delve in and try playing around with allowSetForeground(), setForeground(), etc.. I thought you could give me maybe give me some advice?<br />
<br />
Thanks again!<br />
<br />
Steve</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">2nd December 2010, 20:22</div></div><div class="posttext">I don't think there was any undesirable behavior, but IIRC the hack that works is to create a window with WS_EX_TRANSPARENT|WS_EX_LAYERED|WS_EX_TOOLWINDOW ex styles, this creates a transparent window in a hacky way. I don't think WS_EX_TRANSPARENT on a top level window is really supported etc.<br />
<br />
I never figured out the actual cause of the problem, but my guess is that the nsis verify CRC dialog is the issue, and once you lose &quot;foreground&quot;, SetForegroundWindow stops working.<br />
<br />
You should be able to find the hacks by looking for the UAC_HACK_* #ifdef's.<br />
<br />
It feels like years since I last messed around with this problem so I don't remember the details or how to reproduce it, drop by IRC and maybe we can come up with some new workaround...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">7th December 2010, 23:57</div></div><div class="posttext">Hello.<br />
<br />
I would also be interested in a fix for that issue. With v0.2.2d I encounter the problem that the UAC dialog insn't triggered automatically, but delayed until the user clicks the installer icon in the task-bar. This means that when you launch the installer nothing will happen. Well, except for a blinking icon in the task-bar. Not every user may notice. (This was the result under Windows 7).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">8th December 2010, 00:31</div></div><div class="posttext">I have come to the conclusion that elevating in .oninit is just not going to work, and .onguiinit will have to be used instead, this of course is problematic for silent installers.<br />
<br />
I'm guessing you guys still want silent installers to prompt (while I actually just think the process should exit with the proper error code :) )<br />
<br />
The nsis design makes this hard to implement, but I'll try to come up with some sort of hack</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">8th December 2010, 15:47</div></div><div class="posttext">I have come to the conclusion that elevating in .oninit is just not going to work, and .onguiinit will have to be used instead, this of course is problematic for silent installers.<br />
<br />
So do do you suggest that simply moving the UAC initialization from .onInit to .onGuiInit will do the trick or will it require modifications inside your UAC plugin itself? Anyway, I'm going to play around with it a bit now...<br />
<br />
BTW: currently I don't care about &quot;silent&quot; installers. This may easily become different in a future project, of course ;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">8th December 2010, 16:13</div></div><div class="posttext">(double post, by accident. srry)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">8th December 2010, 16:15</div></div><div class="posttext">Update:<br />
<br />
It seems moving the UAC initialization to .onGuiInit indeed does the trick :)<br />
<br />
However in a MUI2-based installer, I have to use something like:<br />
!define MUI_CUSTOMFUNCTION_GUIINIT myUacInit<br />
<br />
You think it might conflict with anything MUI2 does in its own .onGuiInit functions?<br />
<br />
Thanks!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">8th December 2010, 16:42</div></div><div class="posttext">That just inserts Call myUacInit in .onGUIInit so it should be fine.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">8th December 2010, 16:57</div></div><div class="posttext">That just inserts Call myUacInit in .onGUIInit so it should be fine.<br />
<br />
Stu<br />
<br />
Yeah, but it also executes other MUI2-specific stuff before my custom GuiInit function. We probably don't want that to happen before UAC init or at all (in the &quot;outer&quot; installer).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">8th December 2010, 17:50</div></div><div class="posttext">I'm going to rewrite some stuff maybe, not sure what to do yet</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">11th December 2010, 15:48</div></div><div class="posttext">Now that the &quot;bring installer window to foreground&quot; problem is resolved by doing the UAC init in .onGuiInit, a new question arises:<br />
<br />
Where to call the &quot;MUI_LANGDLL_DISPLAY&quot; macro? :confused:<br />
<br />
Before I did this in .onInit, but *after* the UAC init. And it worked as expected.<br />
<br />
Now after the UAC init has moved to .onGuiInit, I get the MUI_LANGDLL_DISPLAY dialog twice, which isn't surprising.<br />
<br />
Unfortunately moving MUI_LANGDLL_DISPLAY after UAC init again (in .onGuiInit) doesn't work. The language isn't applied!<br />
<br />
So I assume that MUI_LANGDLL_DISPLAY must be called from .onInit rather than .onGuiInit to work correctly.<br />
<br />
My workaround for this which appears to do the trick:<br />
<br />
Function .onInit<br />
	${If} ${UAC_IsInnerInstance}<br />
		!insertmacro MUI_LANGDLL_DISPLAY<br />
	${EndIf}  <br />
FunctionEnd<br />
<br />
But is it considered &quot;safe&quot; to use ${UAC_IsInnerInstance} even before the actual UAC initialization ???<br />
<br />
Thanks :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">11th December 2010, 16:14</div></div><div class="posttext">Yes, it should be safe.<br />
<br />
I am planning to actually make some changes so that calling from onguiint is less painful, I was thinking that it would be a two stage thing, using both oninit and onguiinit.<br />
<br />
I'm not really sure how to do it in practice, getting the correct language loaded in both instances is going to be a problem...<br />
<br />
Or maybe it would be possible to change the plugin api so that plugins can change the language after oninit.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">SteveRidout</div><div class="date">13th December 2010, 11:11</div></div><div class="posttext">It sounds like you guys have a better and simpler fix using onGuiInit, but I thought I'd share my patch to v0.2.2 which works for me and does the following:<br />
<br />
1. Reintroduce Ander's hack from version 0.0.11d which creates an invisible window to retain ability to set foreground<br />
<br />
2. Call AllowSetForeground in inner process on outer process before running an outer operation.<br />
<br />
3. Sleep for 5 seconds before outer window is destroyed (stops focus ability getting lost before my app splash screen shows)<br />
<br />
It's not pretty but works for my case. Here it is: (applies to v0.2.2) http://steveridout.com/sharedFiles/uac.patch<br />
 <br />
Thanks Anders for the help over IRC</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>