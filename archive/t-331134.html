<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Uninstall icon in Start Menu isn't shown, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Uninstall icon in Start Menu isn't shown NSIS Discussion" />
	
	<title> Uninstall icon in Start Menu isn't shown [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Uninstall icon in Start Menu isn't shown</div>
<hr />
<div class="pda"><a href="t-331134.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=331134">Uninstall icon in Start Menu isn't shown</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">juliarg</div><div class="date">1st June 2011, 15:02</div></div><div class="posttext">Hello,<br />
After installing the application, the installer and uninstaller icons are properly shown in application folder in Start menu, but the uninstaller icon is missing from the main Start menu (see attachment)<br />
What am I missing here?<br />
<br />
It's 64-bit Windows, program is installed in Program Files (x86). But looks like it's not the same problem as discussed in http://forums.winamp.com/showthread.php?t=327806</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st June 2011, 19:25</div></div><div class="posttext">Could you give us some code?<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">juliarg</div><div class="date">2nd June 2011, 08:49</div></div><div class="posttext">!define MUI_ICON myapp_install.ico<br />
!define MUI_UNICON myapp_uninstall.ico<br />
<br />
In install section:<br />
<br />
CreateDirectory &quot;$SMPROGRAMS\${APP_NAME}&quot;<br />
CreateShortCut &quot;$SMPROGRAMS\${APP_NAME}\${APP_NAME}.lnk&quot; &quot;$INSTDIR\${APPFILE}&quot;<br />
CreateShortCut '$SMPROGRAMS\${APP_NAME}\${UNINSTALL_SHORTCUT}.lnk' &quot;${UNINST_EXE}&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">juliarg</div><div class="date">2nd June 2011, 09:50</div></div><div class="posttext">The problem appears only when installing in Program Files (x86) folder. When I install to another folder, select uninstaller icon and do &quot;Pin to Start Menu&quot;, the uninstaller icon is ok. If I install to Program Files (x86), same actions lead to a default icon in start menu (as on the image attacted).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">juliarg</div><div class="date">2nd June 2011, 10:03</div></div><div class="posttext">If I select the menu item with the default icon and choose &quot;Properties-&gt;Change Icon&quot; I see the path to file with icons looking like this:<br />
<br />
C:\Program Files (x86)\App\Uninstall.exe<br />
<br />
The icon is seen in icon view below in properties. But it still doesn't appear in menu.<br />
<br />
If I change it to <br />
<br />
%ProgramFiles% (x86)\App\Uninstall.exe<br />
<br />
and save this setting, the uninstaller icon appears ok.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">3rd June 2011, 07:43</div></div><div class="posttext">Could you upload this .lnk somewhere?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">juliarg</div><div class="date">3rd June 2011, 10:45</div></div><div class="posttext">Here it is. I've renamed it to .lnkk for convenient uploading.<br />
http://www.sendspace.com/file/7jl8qq<br />
This .lnk is both in Programs/AppName/ and in main start menu (on attached image). In Programs/AppName/ the icon is ok.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">3rd June 2011, 11:20</div></div><div class="posttext">That lnk does not contain a icon block so it should just use the icon of the target. Does clicking the shortcut with the broken icon actually work?<br />
<br />
Flags: 0x99<br />
	ShItemIdList<br />
	HasRelativePath<br />
	HasWorkDir<br />
	Unicode<br />
TargetFileAttributes: 0x0<br />
TargetCreated: N/A<br />
TargetLastAccess: N/A<br />
TargetModified: N/A<br />
TargetSize: 0<br />
IconIndex: 0<br />
ShowCmd: NORMAL<br />
HotKey: 0x0<br />
<br />
RelativePath: ..\..\..\..\..\..\Program Files (x86)\Yota\Play\Uninstall.exe<br />
WorkDir: C:\Program Files (x86)\Yota\Play<br />
<br />
ShItemIdList<br />
------------<br />
Length: 415<br />
9D 01 14 00 1F 50 E0 4F D0 20 EA 3A 69 10 A2 D8 .....P.O...:i...<br />
08 00 2B 30 30 9D 19 00 2F 43 3A 5C 00 00 00 00 ..+00.../C:\....<br />
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 76 ...............v<br />
00 31 00 00 00 00 00 00 00 00 00 10 00 50 72 6F .1...........Pro<br />
67 72 61 6D 20 46 69 6C 65 73 20 28 78 38 36 29 gram.Files.(x86)<br />
00 54 00 08 00 04 00 EF BE 00 00 00 00 00 00 00 .T..............<br />
00 2A 00 00 00 00 00 00 00 00 00 00 00 00 00 00 .*..............<br />
00 00 00 00 00 00 00 00 00 00 00 50 00 72 00 6F ...........P.r.o<br />
00 67 00 72 00 61 00 6D 00 20 00 46 00 69 00 6C .g.r.a.m...F.i.l<br />
00 65 00 73 00 20 00 28 00 78 00 38 00 36 00 29 .e.s...(.x.8.6.)<br />
00 00 00 22 00 4A 00 31 00 00 00 00 00 00 00 00 ...&quot;.J.1........<br />
00 10 00 59 6F 74 61 00 00 36 00 08 00 04 00 EF ...Yota..6......<br />
BE 00 00 00 00 00 00 00 00 2A 00 00 00 00 00 00 .........*......<br />
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................<br />
00 00 00 59 00 6F 00 74 00 61 00 00 00 14 00 4A ...Y.o.t.a.....J<br />
00 31 00 00 00 00 00 00 00 00 00 10 00 50 6C 61 .1...........Pla<br />
79 00 00 36 00 08 00 04 00 EF BE 00 00 00 00 00 y..6............<br />
00 00 00 2A 00 00 00 00 00 00 00 00 00 00 00 00 ...*............<br />
00 00 00 00 00 00 00 00 00 00 00 00 00 50 00 6C .............P.l<br />
00 61 00 79 00 00 00 14 00 64 00 32 00 00 00 00 .a.y.....d.2....<br />
00 00 00 00 00 00 00 55 6E 69 6E 73 74 61 6C 6C .......Uninstall<br />
2E 65 78 65 00 48 00 08 00 04 00 EF BE 00 00 00 .exe.H..........<br />
00 00 00 00 00 2A 00 00 00 00 00 00 00 00 00 00 .....*..........<br />
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 55 ...............U<br />
00 6E 00 69 00 6E 00 73 00 74 00 61 00 6C 00 6C .n.i.n.s.t.a.l.l<br />
00 2E 00 65 00 78 00 65 00 00 00 1C 00 00 00    ...e.x.e.......<br />
<br />
SpecialFolderDataBlock<br />
----------------------<br />
SpecialFolderId: 0x2A<br />
PIDL Offset: 163<br />
<br />
KnownFolderDataBlock<br />
--------------------<br />
KnownFolder: {7C5A40EF-A0FB-4BFC-874A-C0F2e0b9fa8e}<br />
PIDL Offset: 163<br />
<br />
What I wanted to check was SpecialFolderId and KnownFolder, if they specify the non x86 version of the shell constant it can fail on x64, but then launching the thing should also fail (Not sure if the icon lookup uses the same algorithm as the execution) 0x2A should be the x86 specific constant.<br />
<br />
Could it be a icon cache problem? Did you try on another machine or another user?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">juliarg</div><div class="date">3rd June 2011, 11:43</div></div><div class="posttext">Yes, the problem persists if another user on another machine installs the app.<br />
Clicking on this shortcut actually works.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">juliarg</div><div class="date">3rd June 2011, 11:58</div></div><div class="posttext">How do you explore the .lnk file?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">3rd June 2011, 12:58</div></div><div class="posttext">How do you explore the .lnk file?<br />
<br />
I used my own private tool, sorry.<br />
<br />
The file format is documented @ http://msdn.microsoft.com/en-us/library/dd871305(PROT.10).aspx#[MS-SHLLINK]: Shell Link (.LNK) Binary File Format</div></div><hr />


<div class="post"><div class="posttop"><div class="username">juliarg</div><div class="date">3rd June 2011, 14:01</div></div><div class="posttext">Could you then please have a look at this .lnk file?<br />
<br />
http://www.sendspace.com/file/nqi7am<br />
<br />
It's after I changed the &quot;search for icons in the following file&quot; property from<br />
<br />
C:\Program Files (x86)\App\Uninstall.exe<br />
<br />
to<br />
<br />
%ProgramFiles% (x86)\App\Uninstall.exe<br />
<br />
and then, the icon is there.<br />
<br />
I wonder how the .lnk has changed, maybe it could give a clue.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">3rd June 2011, 16:39</div></div><div class="posttext">...<br />
RelativePath: ..\..\..\..\..\..\Program Files (x86)\Yota\Play\Uninstall.exe<br />
WorkDir: C:\Program Files (x86)\Yota\Play<br />
IconPath: %ProgramFiles% (x86)\Yota\Play\Uninstall.exe<br />
<br />
ShItemIdList<br />
...But &quot;%ProgramFiles% (x86)&quot; is not really a valid thing, you are just getting lucky.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">juliarg</div><div class="date">6th June 2011, 13:20</div></div><div class="posttext">Is there a way to put this IconPath in the .lnk via NSIS? I'm puzzled.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">7th June 2011, 09:41</div></div><div class="posttext">Is there a way to put this IconPath in the .lnk via NSIS? I'm puzzled.<br />
<br />
You can set a specific icon in the CreateShortcut call (But it should NOT be required when it is the same as the target)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">7th June 2011, 10:14</div></div><div class="posttext">I have been playing around with some code, but I don't know how to get the icon path used when a .lnk does not specify a specific icon (I could probably fall back to the path from IShellLink::GetPath but I was hoping there was some shell function that would provide it for me)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">juliarg</div><div class="date">7th June 2011, 14:18</div></div><div class="posttext">I ran your code for the problem .lnk.<br />
<br />
GetPath:0=C:\Program Files (x86)\Yota\Play\Uninstall.exe<br />
GetIconLocation:0=,0<br />
IShellLink HR=0<br />
GetIconLocation:0=*|idx=7 flags=12<br />
Extract:0=HICON=508627137<br />
SHGetFileInfo=1|,0<br />
SHMapPIDLToSystemImageListIndex=7</div></div><hr />


<div class="post"><div class="posttop"><div class="username">juliarg</div><div class="date">7th June 2011, 15:01</div></div><div class="posttext">I tried the following:<br />
CreateShortCut &quot;$SMPROGRAMS\${APP_NAME}\${UNINSTALL_SHORTCUT}.lnk&quot; &quot;${UNINST_EXE}&quot; &quot;&quot; &quot;${UNINST_EXE}&quot;<br />
<br />
After this, the icon remained default and on attempt to look at &quot;Look for icons in this file&quot; property I got &quot;&quot;Windows cannot find the file %ProgramFiles%\Yota\Play\uninstall.exe&quot;<br />
<br />
I applied the workaround from this topic http://forums.winamp.com/showthread.php?t=327806 and the message stopped appearing, &quot;Look for icons in this file&quot; path is correct. But the icon remains default.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">7th June 2011, 15:54</div></div><div class="posttext">I ran your code for the problem .lnk.<br />
<br />
<br />
Did the application icon change to the correct icon on the instfiles page?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">juliarg</div><div class="date">7th June 2011, 16:11</div></div><div class="posttext">Problem is not with the app icon, but with the uninstaller icon. On all the uninstaller pages, the icon is ok. It does not show only in the Start Menu (see attachment).<br />
I am inclined to think that this is a Windows icon cache issue, because after I install and then update the app, the icon is ok.<br />
<br />
I do this call for refreshing icons.<br />
System::Call 'Shell32::SHChangeNotify(i 0x8000000, i 0, i 0, i 0)'<br />
<br />
There is no specific code in installer to add an icon to the main Start menu (in attachment). Maybe this happens when installer is deinitialized, which is after the call to SHChangeNotify</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">7th June 2011, 16:12</div></div><div class="posttext">I was actually talking about the little sample code I posted, it tries to set the icon from the .lnk</div></div><hr />


<div class="post"><div class="posttop"><div class="username">juliarg</div><div class="date">7th June 2011, 16:31</div></div><div class="posttext">If I point it to the uninstaller .lnk, it sets the default icon to the instfiles page. I also tried pointing it to the application .lnk, it works - the application icon appears on the instfiles page.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">7th June 2011, 17:59</div></div><div class="posttext">Looking at the link dump again I see that TargetFileAttributes and TargetSize are both 0 in my dump (I did not have the target file on my system). Are you creating the shortcut before the uninstaller has been written? The shortcut target should exist when you create the shortcut...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">juliarg</div><div class="date">8th June 2011, 09:39</div></div><div class="posttext">:) Yes, you're right. I write the uninstaller in .onInstSuccess using Advanced Uninstall Log. The shortcuts are created in the install section.<br />
<br />
I found out that if I do this <br />
<br />
System::Call 'Shell32::SHChangeNotify(i 0x8000000, i 0, i 0, i 0)'<br />
<br />
not at the end of install section, but on .onGuiEnd,<br />
<br />
the icon is ok. Everything looks pretty simple now - the icon cache was refreshed when the uninstaller still was not there.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">8th June 2011, 10:21</div></div><div class="posttext">Don't use that in .onGUIEnd because it will get called when people cancel your install. You don't need to use .onInstSuccess either; just add an unnamed Section after all your sections and put any final unconditionally executed code in there.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">juliarg</div><div class="date">8th June 2011, 10:53</div></div><div class="posttext">But, in the documentation to Advanced Uninstall Log, they recommend to call the macro which creates the uninstaller in .onInstSuccess. That's how it's done now in my installer. And I need to refresh the cache after the uninstaller is created.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Yathosho</div><div class="date">8th June 2011, 11:21</div></div><div class="posttext">@Anders<br />
wait til MSG finds out about this post, he'll teach you to attach large chunks of code :p</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">8th June 2011, 12:06</div></div><div class="posttext">At least Anders has the sense not to use the broken code tag &gt;_&gt;<br />
<br />
<br />
(btw @admins: please get to fixing that already...)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DrO</div><div class="date">8th June 2011, 13:02</div></div><div class="posttext">actually it was me that converted it to a quote block and i'll go through the posts in a few minutes and convert things to attachments as applicable.<br />
<br />
as for fixing the code block issue, it is logged but it's massively down at the bottom of the list of things to do (though why VB3.x does it different is beyond me).<br />
<br />
-daz</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">8th June 2011, 13:22</div></div><div class="posttext">In that case, can't you just workaround it to let vB interpret all code tags as php or quote instead? That'd be infinitely better than the mess that currently is the code tag.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Yathosho</div><div class="date">8th June 2011, 14:11</div></div><div class="posttext">@MSG<br />
just kidding</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DrO</div><div class="date">8th June 2011, 14:34</div></div><div class="posttext">MSG: that still involves someone doing something though why going from VB2.x to VB3.x broke it i just don't know. there are things listed and i've mentioned it many times but the forums are low on the list of everything else that needs to be allocated resources. same as fixing some of the attachment upload issues, etc etc.<br />
<br />
-daz</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">8th June 2011, 15:14</div></div><div class="posttext">At least Anders has the sense not to use the broken code tag &gt;_&gt;<br />
<br />
<br />
The PHP formating eats the \ so I had to go with CODE</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>