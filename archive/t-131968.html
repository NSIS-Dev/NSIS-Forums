<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Need Help with Set and Release Mutex!, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Need Help with Set and Release Mutex! NSIS Discussion" />
	
	<title> Need Help with Set and Release Mutex! [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Need Help with Set and Release Mutex!</div>
<hr />
<div class="pda"><a href="t-131968.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=131968">Need Help with Set and Release Mutex!</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">billym</div><div class="date">16th April 2003, 18:38</div></div><div class="posttext">Can someone please assist with the proper way to call the createmutex API? What I am trying to do is to set a mutex flag while I am installing an update so that if my application is executed anytime during the update process, the application will not start until the mutex is released. An example would be great on how to do set the flag and remove it. Thanks<br />
<br />
<br />
<br />
<br />
!define PATCHEXE &quot;MutexTest.exe&quot;<br />
<br />
Name &quot;Mutex Test&quot;<br />
<br />
OutFile &quot;MutexTest.exe&quot;<br />
<br />
SilentInstall silent<br />
<br />
<br />
Section &quot;MainSection&quot;<br />
<br />
	System::Call 'kernel32::CreateMutex( s, b, s) i(.r0, FALSE, &quot;{E27D1C1E-B4D8-4439-83B4-0173E03C5D11}&quot;) .r3'<br />
<br />
<br />
SectionEnd ; end the section</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">16th April 2003, 20:39</div></div><div class="posttext">1) You need to do is call this from .onInit so it will set the mutex when the installer starts and not when it starts installing.<br />
2) You need to do is call CreateMutexA because there is no function called CreateMutex, only CreateMutexA for MBCS and CreateMutexW for Unicode.<br />
3) You should specify t for strings and not s. Also, b is not a valid type, use i for int (same as BOOL).<br />
4) lpMutexAttributes is a pointer and therefore should be defined as i and not s.<br />
5) You need to call GetLastError after this call and compare it to ERROR_ALREADY_EXISTS (183) to know if the mutex already exists.<br />
<br />
Your code should be (not tested, plesae test):<br />
<br />
Function .onInit<br />
  System::Call 'kernel32::CreateMutexA(i, i, s) i(0, 0, &quot;myMutex&quot;)'<br />
  System::Call 'kernel32::GetLastError() i() .r0'<br />
  StrCmp $0 183 0 +3<br />
    MessageBox MB_OK &quot;installer already running&quot;<br />
    Abort<br />
  StrCmp $0 0 done<br />
    MessageBox MB_OK &quot;error creating mutex, getlasterror didn't return success&quot;<br />
  done:<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">billym</div><div class="date">16th April 2003, 22:11</div></div><div class="posttext">This still is not working properly, this is what I tried, it provided me with no errors and allowed multiple instances.<br />
<br />
!define PATCHEXE &quot;MutexTest.exe&quot;<br />
<br />
Name &quot;Mutex Test&quot;<br />
<br />
OutFile &quot;MutexTest.exe&quot;<br />
<br />
SilentInstall silent<br />
<br />
<br />
Function .onInit<br />
  System::Call 'kernel32::CreateMutexA(i, i, s) i(0, 0, &quot;myMutex&quot;)'<br />
  System::Call 'kernel32::GetLastError() i() .r0'<br />
  StrCmp $0 183 0 +3<br />
    MessageBox MB_OK &quot;installer already running&quot;<br />
    Abort<br />
  StrCmp $0 0 done<br />
    MessageBox MB_OK &quot;error creating mutex, getlasterror didn't return success&quot;<br />
  done:<br />
    MessageBox MB_OK &quot;mutex set&quot;<br />
FunctionEnd<br />
<br />
Section Test<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">17th April 2003, 11:41</div></div><div class="posttext">The problem is between GetLastError and the actual function call there are some other functions called... I'll talk to the creator of the plug-in about finding a solution for this, but in the mean while you can use this little plug-in I have just created (attached). Here's an example:<br />
<br />
Function .onInit<br />
  Mutex::Create &quot;myMutex&quot;<br />
  Pop $0<br />
  StrCmp $0 0 done<br />
  StrCmp $0 1 0 error<br />
    MessageBox MB_OK|MB_ICONSTOP &quot;Installer already running...&quot;<br />
    Abort<br />
  error:<br />
    MessageBox MB_OK|MB_ICONSTOP &quot;Error creating mutex (probably bad mutex name)&quot;<br />
  done:<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">billym</div><div class="date">17th April 2003, 15:29</div></div><div class="posttext">Thanks alot, the plugin worked wonderfully!!!!!. For anyone who has had the problem with updating files becouse they are in use or becouse the application was ran during your update, this is the best fix I have found. I would even reccomend that this be an option on the installer becouse it would help prevent install or update failures. Thanks again for the solution.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">brainsucker</div><div class="date">17th April 2003, 21:20</div></div><div class="posttext">Ok, minor bug (with calling any proc(void)) fixed, and GetLastError() option added. Use &quot;?e&quot; at proc specification, and pop first value from stack as getlasterror result.<br />
<br />
Here what you want (and update dll and sources please):<br />
<br />
  System::Call 'kernel32::CreateMutexA(i 0, i 0, t &quot;myMutex&quot;) i .r1 ?e'<br />
  pop $0<br />
  StrCmp $0 183 0 +3<br />
    MessageBox MB_OK &quot;installer already running&quot;<br />
    Abort<br />
  StrCmp $0 0 done<br />
    MessageBox MB_OK &quot;error creating mutex, getlasterror didn't return success&quot;<br />
  done:</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">18th April 2003, 12:20</div></div><div class="posttext">Updated CVS, thanks.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Brummelchen</div><div class="date">8th July 2003, 13:36</div></div><div class="posttext">what is &quot;mutex&quot; in detail?<br />
i dont know about ther kernel routines and M$ ist not very useful to me.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">8th July 2003, 13:44</div></div><div class="posttext">Well, seems pretty clear to me:<br />
<br />
A mutex object is a synchronization object whose state is set to signaled when it is not owned by any thread, and nonsignaled when it is owned. Only one thread at a time can own a mutex object, whose name comes from the fact that it is useful in coordinating mutually exclusive access to a shared resource. For example, to prevent two threads from writing to shared memory at the same time, each thread waits for ownership of a mutex object before executing the code that accesses the memory. After writing to the shared memory, the thread releases the mutex object.<br />
<br />
Any more details you want to know?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Brummelchen</div><div class="date">8th July 2003, 14:31</div></div><div class="posttext">huh?<br />
<br />
is it possible to explain it with simple words to me?<br />
<br />
What about &quot;myMutex&quot; - that's the object?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">8th July 2003, 14:41</div></div><div class="posttext">A mutex is a lock. It can be locked by one program so the other can't open it. In our case, your program creates a mutex and locks it. The installer tries to open this mutex, and if it sees that the mutex is locked it concludes that your program is running.<br />
<br />
Every mutex has an unique name, in the example above it's &quot;myMutex&quot;.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Brummelchen</div><div class="date">8th July 2003, 14:46</div></div><div class="posttext">is a &quot;mutex&quot; an option from that program or is it automatically created?<br />
<br />
on 1st it not sure that program is really running - or am i wrong?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">8th July 2003, 14:51</div></div><div class="posttext">Your program has to create a mutex using a function called CreateMutex.<br />
<br />
I don't understand the second question, what is unsure and when?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">8th July 2003, 17:47</div></div><div class="posttext">That's very interesting Kichik...<br />
<br />
Is it possible to find mutex names (if any) from all applications?<br />
It could be useful if Quake2 (game) is still running when it musn't be..<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">8th July 2003, 17:51</div></div><div class="posttext">If the application has created a mutex it's possible. All you need to know is the name. Mutexes are global or at least global on the current session (in XP fast-switching or NT terminal services).<br />
<br />
Mutexes also have security attributes, so the application can deny you from opening the mutex. But you'll still be able to know the application is there because the mutex exists :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">8th July 2003, 18:15</div></div><div class="posttext">So, say if the exe or game is called quake2, then the mutex will probably be called quake2 right?<br />
I'll look into this...<br />
<br />
Thanks again btw<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">9th July 2003, 12:21</div></div><div class="posttext">No, that's not a sure thing. Wasn't Quake 2 originally a DOS game? It might not set a mutex at all. Open it using Dependency Walker (http://www.dependencywalker.com/) and see if it calls CreateMutex (under kernel32.dll).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Vytautas</div><div class="date">18th September 2003, 05:40</div></div><div class="posttext">Originally posted by brainsucker <br />
<br />
  System::Call 'kernel32::CreateMutexA(i 0, i 0, t &quot;myMutex&quot;) i .r1 ?e'<br />
  pop $0<br />
  StrCmp $0 183 0 +3<br />
    MessageBox MB_OK &quot;installer already running&quot;<br />
    Abort<br />
  StrCmp $0 0 done<br />
    MessageBox MB_OK &quot;error creating mutex, getlasterror didn't return success&quot;<br />
  done:<br />
  do I need to destroy the Mutex I create in the .onInit Function or is that done automatically?  <br />
<br />
Vytautas</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">18th September 2003, 13:43</div></div><div class="posttext">You can close it using ReleaseMutex / CloseHandle. However, it's not really required, because it will be released when the process has ended.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">putty</div><div class="date">14th November 2003, 19:04</div></div><div class="posttext">Originally posted by brainsucker <br />
Ok, minor bug (with calling any proc(void)) fixed, and GetLastError() option added. Use &quot;?e&quot; at proc specification, and pop first value from stack as getlasterror result.<br />
[/PHP]  <br />
<br />
can you explain what Use &quot;?e&quot; at proc specification means? when i used this code in my script it always went to the error leg. why can't i create the mutex successfully? sorry, i'm very ignorant when it comes to windows API.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">14th November 2003, 19:07</div></div><div class="posttext">Tried this code?<br />
<br />
http://nsis.sourceforge.net/site/index.php?id=19&amp;backPID=15&amp;tx_faq_faq=29</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">14th November 2003, 19:08</div></div><div class="posttext">?e tells System.dll to return the return value of GetLastError on the stack. It is only available in the latest CVS version, so unless you're using that System.dll will probably fail. Get it using NSIS Update or the nightly snapshot in the NSIS homepage.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">putty</div><div class="date">14th November 2003, 20:55</div></div><div class="posttext">Thanks! It worked after i copied the new System.dll.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dpbluegreen</div><div class="date">12th July 2004, 23:11</div></div><div class="posttext">It seems to me that one would want to use this technique in both .onInit and un.onInit. For example, one's module might control a shared component, and a user might unknowingly think it's okay to uninstall one app using that component while installing another.<br />
<br />
But one can't actually use this technique for that purpose, because if you're doing an upgrade, you might have to run the uninstaller before placing the new files, which would mean 2 threads using the same mutex.<br />
<br />
Is there a suggested way to handle this?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Vytautas</div><div class="date">12th July 2004, 23:48</div></div><div class="posttext">Have the uninstaller create the mutex only if a certain command-line switch was NOT present and have the upgrade installer launch the uninstaller with that switch, but the standard unsinstall shortcuts/entries should launch without the switch.<br />
<br />
Vytautas</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Brummelchen</div><div class="date">13th July 2004, 11:48</div></div><div class="posttext">Do i need the plugins mentioned above on the v2 final ?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">13th July 2004, 13:06</div></div><div class="posttext">No, you only have to use the standard System plug-in.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Brummelchen</div><div class="date">13th July 2004, 14:44</div></div><div class="posttext">thx</div></div><hr />


<div class="post"><div class="posttop"><div class="username">klopfdreh</div><div class="date">9th May 2011, 07:17</div></div><div class="posttext">I'm trying to create a mutex and use the installer on windows 7.<br />
<br />
My problem here is that windows 7 always reports that the installer is running, even at the first startup. <br />
<br />
This is the code I use:<br />
<br />
        ; Allow only one installer instance<br />
        System::Call 'kernel32::CreateMutexA(i 0, i 0, t &quot;myMutex&quot;) i .r1 ?e'<br />
        Pop $R0<br />
        StrCmp $R0 0 +3<br />
            MessageBox MB_OK &quot;Running&quot;<br />
            Quit  <br />
<br />
<br />
Maybe there is something wrong with my code.<br />
<br />
I would be pleased if someone is able to find out what the problem is here.<br />
<br />
Thanks a lot!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">9th May 2011, 09:38</div></div><div class="posttext">I think it should be &quot;CreateMutexA(i 0, i 0, t &quot;myMutex&quot;) i .r0 ?e&quot;.<br />
See: http://nsis.sourceforge.net/Allow_only_one_installer_instance</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">9th May 2011, 17:13</div></div><div class="posttext">I don't think you should use GetLastError (?e) to determine the result of CreateMutex. Instead of i.r0 ?e on the end, just use i.s. The rest of the code can stay the same as CreateMutex will return 0 (NULL) on failure.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">klopfdreh</div><div class="date">10th May 2011, 07:11</div></div><div class="posttext">I think it should be &quot;CreateMutexA(i 0, i 0, t &quot;myMutex&quot;) i .r0 ?e&quot;.<br />
See: http://nsis.sourceforge.net/Allow_on...aller_instance<br />
<br />
<br />
This doesn't work for me either<br />
<br />
I don't think you should use GetLastError (?e) to determine the result of CreateMutex. Instead of i.r0 ?e on the end, just use .s. The rest of the code can stay the same as CreateMutex will return 0 (NULL) on failure.<br />
<br />
I used the following code to check out .s:<br />
System::Call 'kernel32::CreateMutexA(i 0, i 0, t &quot;myMutex&quot;) .s'<br />
<br />
But this time the CreateMutex results in nothing - not even a number. I tested it with MessageBox MB_OK $R0<br />
<br />
Edit: Ah! What I found out is that I'm using the UAC library and because of this the program seems to start twice at the first time - I printed out the message of the return value of createMutex and it appears twice! It may not relate to this topic.<br />
<br />
I'm going to ask my question in the related plugin topic, so if someone of you got an answer please answer in that topic</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">10th May 2011, 11:13</div></div><div class="posttext">Sorry I meant i.s not .s.<br />
<br />
Stu</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>