<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Problem with WriteRegStr and AppCompatFlags, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Problem with WriteRegStr and AppCompatFlags NSIS Discussion" />
	
	<title> Problem with WriteRegStr and AppCompatFlags [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Problem with WriteRegStr and AppCompatFlags</div>
<hr />
<div class="pda"><a href="t-273063.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=273063">Problem with WriteRegStr and AppCompatFlags</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Gato Muerto</div><div class="date">19th June 2007, 02:51</div></div><div class="posttext">Program requires compatibility mode (Win98/ME) to run properly in Vista.  To streamline this, I have added some generic code to a series of installer scripts in order to &quot;Plug and Run&quot;.  Unfortunately, the script is not writing the required registry entry.  I am likely missing something quite obvious, but was wondering if anyone else has an idea.  Here is the important code:<br />
<br />
!define APPCOMPATMODE &quot;WIN98&quot;<br />
  # Registry entry in order to enable compatibility mode settings for the application.<br />
  # Put a space between each mode selected.<br />
  # The following modes are available:<br />
  #    {WIN95 WIN98 NT4SP5 WIN2000 WINXPSP2}<br />
  #    256COLOR<br />
  #    640X480<br />
  #    DISABLETHEMES<br />
  #    DISABLEDWM<br />
  #    HIGHDPIAWARE<br />
  #    RUNASADMIN<br />
#snip loads of code...<br />
<br />
Section &quot;Base Components&quot; BASECOMPONENTS<br />
#snip loads of code...<br />
<br />
  !ifdef APPCOMPATMODE<br />
    WriteRegStr HKLM &quot;Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Layers&quot; &quot;$INSTDIR\${PROGEXE}&quot; &quot;${APPCOMPATMODE}&quot;<br />
  !endif<br />
#snip loads of code...<br />
<br />
SectionEnd<br />
<br />
The odd thing is that if I change HKLM to HKCU, the code works perfectly, the registry entry appears correctly (in CU), and the program works (for that one user).  Perhaps I am missing something obvious, but what is wrong here?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">19th June 2007, 04:49</div></div><div class="posttext">your installer needs admin rights to write to HKLM, use &quot;RequestExecutionLevel admin&quot; in your script</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gato Muerto</div><div class="date">19th June 2007, 17:48</div></div><div class="posttext">Thanks.  Like I said, was missing something rather obvious.  :P<br />
Actually thought that since Admin rights are needed to execute anyways, the installer was already running with Admin rights.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gato Muerto</div><div class="date">11th July 2007, 02:29</div></div><div class="posttext">Thanks for the help.  Have a very similar issue, and believe reposting in the same thread would be better all around.<br />
<br />
I am reusing the same code for a new installer and running into another almost identical problem. Run the code on Vista, everything is great, works fine.  Move to a machine running the 64 bit version of Vista, and no joy.  Again, HKLM fails, HLCU works, which leads to believe that the ReqExeLev isn't working for some reason.  Same CDROM on both the 32bit and 64bit OS, so rather confused as to the cause here.  Is there a difference for how the x64 version of Vista handles &quot;RequestExecutionLevel&quot;?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">11th July 2007, 12:57</div></div><div class="posttext">Probably registry redirection. Try using SetRegView 64</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gato Muerto</div><div class="date">11th July 2007, 18:50</div></div><div class="posttext">Thanks, that did it. <br />
Does this setting do anything if the OS is 32-bit instead of 64-bit?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">11th July 2007, 20:44</div></div><div class="posttext">Well, the extra flag for RegOpen/CreateKey is still there probably, but should not do any damage. You can use the RunningOnx64 test in x64.nsh and only use SetRegView on x64 if you want.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gato Muerto</div><div class="date">11th July 2007, 20:47</div></div><div class="posttext">Thanks.  I have tested it on x32 machines, and couldn't see any difference, but that doesn't mean anything...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">11th July 2007, 20:54</div></div><div class="posttext">The flag for the registry functions are passed regardless of the architecture, if SetRegView is used. It still works on XP and some other versions of Windows I've tested, but you can never know what an unsupported flag can do. It's best to only use SetRegView for Windows x64.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gato Muerto</div><div class="date">11th July 2007, 21:04</div></div><div class="posttext">Augh.  More code to add and debug.  &gt;_&lt;<br />
<br />
Well, glad to know.  Doing the work now could mean a lot less work in the future, when x64 architecture is more common.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gato Muerto</div><div class="date">14th August 2007, 01:47</div></div><div class="posttext">Going back over my list of &quot;to be done&quot; projects.  Noted that the x64.nsh uses DisableX64FSRedirection &amp; EnableX64FSRedirection.  However, according to M$, this is no longer proper, and they recommend using the Wow64DisableWow64FsRedirection and Wow64RevertWow64FsRedirection functions.<br />
http://msdn2.microsoft.com/en-us/library/aa365744.aspx<br />
<br />
Should this be corrected?<br />
<br />
Additionally, my education in programming stopped with grade-school BASIC and some minor self-taught Pascal.  I am somewhat clueless regarding system:call and such, so forgive me if I am asking obvious questions.<br />
<br />
It doesn't appear that x64.nsh/DisableX64FSRedirection checks to see if it is running on a x64 OS before attempting to run.   Am I missing something, or was this an oversight?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">14th August 2007, 08:52</div></div><div class="posttext">They say the problem is with nested calls, this probably does not apply to nsis. I would guess its more if you create a 3rd party library and then you don't know what state to revert to when you are done. Also, if we changed to the &quot;new&quot; functions (MSDN lists XPx64 support) we would have to remember the original state in a variable. But it guess kichik has to chime in with the final answer. <br />
<br />
As for the lack of OS check, the system plugin checks with GetProcAddress if the function you want to call exists, if it doesnt, its no big deal, the call just doesnt take place.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">14th August 2007, 20:50</div></div><div class="posttext">What Anders said + the new functions have higher version requirements.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>