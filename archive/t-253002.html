<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" EnumRegKey - infinite loop on some Win98 machine, but not others?, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  EnumRegKey - infinite loop on some Win98 machine, but not others? NSIS Discussion" />
	
	<title> EnumRegKey - infinite loop on some Win98 machine, but not others? [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  EnumRegKey - infinite loop on some Win98 machine, but not others?</div>
<hr />
<div class="pda"><a href="t-253002.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=253002">EnumRegKey - infinite loop on some Win98 machine, but not others?</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">beano_okc</div><div class="date">10th August 2006, 18:30</div></div><div class="posttext">I need to enumerate Outlook profiles on Windows 98 machines as part of my NSIS script.  I have 42 machines as an initial group I'm working with, and of the 42, I had 6 that went into an infinite loop when trying to enumerate &quot;HKCU\Software\Microsoft\Windows Messaging Subsystem\Profiles&quot;.  I can't see anything different on these machines, they all have anywhere from 1 to 7-8 Outlook profiles configured.  I'm doing some testing on one of the machines and can't determine why this loops endlessly:<br />
<br />
Machine has only one Outlook profile, &quot;GTriplett&quot;, so beneath Profiles in the registry, that is the only key present, and should therefore be the only key EnumRegKey sees before it returns an empty string or errors out.  I've added some debugging stuff (well, attempt at debugging) to the loop so I can see the condition of variables and whatnot via DetailPrint, but I'm stumped.<br />
<br />
The NSIS loop is (debugging stuff is still in it): <br />
<br />
--------------------------------<br />
; First build a stack of Outlook profiles<br />
	StrCpy $1 0<br />
	StrCpy $2 0<br />
	DetailPrint &quot;Building a list of Outlook profiles...&quot;<br />
	loop_getprofs:<br />
		ClearErrors<br />
		DetailPrint &quot;Var 1 is $1, now reading registry&quot;<br />
		EnumRegKey $1 HKCU &quot;Software\Microsoft\Windows Messaging Subsystem\Profiles&quot; $2<br />
		IfErrors getprof_error<br />
		StrCmp $1 &quot;&quot; done_getprofs<br />
		Push $1<br />
		DetailPrint &quot;    $2. $1&quot;<br />
		IntOp $2 $2 + 1<br />
		StrCpy $1 0<br />
		StrCmp $2 30 EndIt<br />
		Goto loop_getprofs<br />
		<br />
		getprof_error:<br />
		DetailPrint &quot;Ran into an error reading HKCU\Sofware\MS\WMS\Profiles at index $2&quot;<br />
	done_getprofs:<br />
-----------------------------------<br />
<br />
<br />
The Details window of NSIS shows this:<br />
<br />
----------------------------------------<br />
Building a list of Outlook profiles...<br />
Var 1 is 0, now reading registry<br />
    0. GTriplett<br />
Var 1 is 0, now reading registry<br />
    1. GTriplett<br />
Var 1 is 0, now reading registry<br />
    2. GTriplett<br />
Var 1 is 0, now reading registry<br />
    3. GTriplett<br />
  --- snip ---<br />
Var 1 is 0, now reading registry<br />
    28. GTriplett<br />
Var 1 is 0, now reading registry<br />
    29. GTriplett<br />
Completed<br />
------------------------------------<br />
<br />
So you can see that $2 is incrementing, and therefore EnumRegKey is being told to read an incrementing index, yet it always returns &quot;GTriplett&quot;, and will loop infinitely on it.  The majority of my machines went just fine, is this a bug in EnumRegKey, or registry corruption, or...  any other ideas?<br />
<br />
Thanks very much,<br />
Mark</div></div><hr />


<div class="post"><div class="posttop"><div class="username">beano_okc</div><div class="date">10th August 2006, 23:07</div></div><div class="posttext">As an update, it appears that on the Windows 98 machines where I saw an issue, that I can enumerate *any* registry key and get an infinite loop.  I am very definitely incrementing the key index with IntOp, and echoing the registry key name, and can see that the script goes through the values as you would expect, listing each one individually.  When it exhausts the keys, though, it just keeps listing the last key it hit, over and over, and the key index just keeps climbing from the IntOp (the line in my script snippet above, &quot;DetailPrint $2. $1&quot; is showing me the key index and the result of that particular enumeration).<br />
<br />
Has anyone else run into something like this?  Is there some update to Windows that these machines have missed, and they have a broken API &quot;RegEnumKey&quot; function?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">19th August 2006, 14:24</div></div><div class="posttext">Run the attached executable on a machine which shows this behavior and let me know what is the result you get from it. It will call RegEnumKey with an index above the number of available subkeys and show the result.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>