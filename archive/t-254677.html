<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Bug in ExecDos, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Bug in ExecDos NSIS Discussion" />
	
	<title> Bug in ExecDos [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Bug in ExecDos</div>
<hr />
<div class="pda"><a href="t-254677.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=254677">Bug in ExecDos</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">3rd September 2006, 05:39</div></div><div class="posttext">I have found what I think is a bug in the NSIS compiler or in ExecDos.<br />
<br />
I have ExecDos set with a very standard line of code, which causes the program to spawn a second copy of its process into memory!<br />
<br />
ExecDos::exec /NOUNLOAD /TIMEOUT=10000 &quot;$TORDIRECTORY\TorCircuitStatus 82&quot; <br />
<br />
which usually causes torcircuitstatus.exe to run, instead causes the main program to spawn another instance of itself and torcircuitstatus never runs at all!<br />
<br />
It used to work, and now it doesn't.<br />
<br />
I can provide full source if need be, but I am 100% sure it is that line that is the error.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">3rd September 2006, 06:39</div></div><div class="posttext">Is 'main' program your installer or some other application? Not long ago I made changes in ExecDos (added 'output to stack' option), but you can test situation with previous plug-in version from this page http://nsis.sourceforge.net/File:ExecDos.zip Can you reproduce 'fork' with any other application? ExecDos call exit code (Pop)?<br />
Also. You should set a full file name in the command line including extension, torcircuitstatus.exe, otherwise, while we not using shell, file will not be found. And '/nounload' switch in the sync mode usefull for serial dll calls only. Short script sample (with files required) may help.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">3rd September 2006, 15:38</div></div><div class="posttext">Main program is indeed my installer.<br />
<br />
The strange issue is that when I have some entirely unrelated files around, it works just fine. Very very strange.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">3rd September 2006, 16:05</div></div><div class="posttext">I have a new development. The programs don't work if they are moved at all whatsoever! If I move the directory, and exact copy of it, to anywhere else, the installer forks.<br />
<br />
Further, when I removed the /NOUNLOAD i got this:<br />
The instruction at &quot;0x011613a5&quot; referenced memory at &quot;0xffffffff&quot;. The memory could not be &quot;read&quot;. <br />
<br />
I have seen this problem happen with the correct program being run instead of the main installer program. I am thinking it is possible that execdos is infact running the correct program, but that it is using the main installers name. However Execdos isn't allowing the program to throw back a code from the stack. BTW, unless your execdos is of a different size, I was using your old version (July 1st).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">3rd September 2006, 16:31</div></div><div class="posttext">I substituted NsExec in place of ExecDOS... Now there isn't just one extra copy of the loader but more and more continually.<br />
<br />
And I am indeed using the exact and full path of the program. Yet still it breaks and runs the new process under the name of the installer.<br />
<br />
Could this be an issue with the NSIS compiler?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">3rd September 2006, 17:28</div></div><div class="posttext">One more.. If path includes blank spaces use double quotas:<br />
'&quot;$TORDIRECTORY\TorCircuitStatus&quot; 82'<br />
Both ExecDos and nsExec start one process only.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">3rd September 2006, 19:06</div></div><div class="posttext">Still no good. I'm about to post the source and programs so you can see the insanity for yourself. I've found a new error as well in FindProcDLL:FindProc that may be related to this problem.<br />
<br />
In my code I have:<br />
DoneWithFlagCheck:	<br />
  MessageBox MB_OK `R0 = $R0`<br />
  FindProcDLL::FindProc &quot;tor.exe&quot; ;Make sure tor.exe is still running<br />
  Pop $R0<br />
  MessageBox MB_OK `The value returned was: $R0`<br />
   <br />
<br />
The first message box returns &quot;R0 = 0&quot;<br />
The second message box returns &quot;The value returned was: I:\soapbox2\App\tor\TorCircuitStatus.exe 82&quot;<br />
<br />
This is really strange because that is the string I am sending to ExecDos. And for some reason, FindProcDLL pulls that from somewhere and returns it as $R0!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">3rd September 2006, 19:16</div></div><div class="posttext">Okay, the issue isn't with FindProcDLL, it has to do with something with ExecDOS or the compiler or environment.<br />
<br />
I changed the code:<br />
<br />
<br />
DoneWithFlagCheck:	<br />
	MessageBox MB_OK `R0 = $R0`<br />
	FindProcDLL::FindProc &quot;tor.exe&quot; ;Make sure tor.exe is still running<br />
	Pop $R1<br />
	StrCmp $DEBUGON 1 &quot;&quot; +2<br />
	MessageBox MB_OK `R0: $R0, R1 = $R1`<br />
<br />
<br />
The output was:<br />
R0 = 0<br />
R0 = 1 R1 = I:\soapbox2\App\tor\TorCircuitStatus.exe 82<br />
<br />
So apparently ExecDos is forcing the string &quot;I:\soapbox2\App\tor\TorCircuitStatus.exe 82&quot; on the stack.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">3rd September 2006, 20:14</div></div><div class="posttext">Okay. The i have removed all &quot;POP $R0&quot; after FindProcDLL as they are all useless since FindProcDLL pushes the return to $R0.<br />
<br />
The problem is very odd. When the directory is on a USB stick, it runs fine. If it is in a certain directory on my computer, it runs fine. If it is moved anywhere else, the installer &quot;Torpark.exe&quot; keeps respawning its process anytime i try to ExecDos TorCircuitStatus.exe.<br />
<br />
Check it for yourself. Put it into debug mode by running it with /debug like so &quot;Torpark /debug&quot; from the command prompt.<br />
<br />
Full BIN, dir structure, and source available here:<br />
http://torpark.nfshost.com/soapbox2.zip<br />
<br />
The strangest thing of all... I used to have a message at the beginning of the installer, and that is what kept popping up when the process restarted. I changed that message slightly and recompiled it, and when it ran the installer again it gave me the original message! Very strange.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">3rd September 2006, 22:41</div></div><div class="posttext">Okay. I think it is the environment, but it may be effected by the compiler.<br />
<br />
When I compile the program and run it, often, it will fork two other processes that I am calling with ExecDos. Not just torpark.exe, but sometimes an extra tor.exe will show up.<br />
<br />
When I take that same code, copy it to a different medium and run it from there, no problems. <br />
<br />
So I rebooted and ran the program from the original location. It started forking again. I tried the one at the different drive and it was fine, just as before.<br />
<br />
Is it possible that versions of the program are being called from the system cache, and that is what is causing the appearance of multiple processes?<br />
<br />
Admittedly, I highly doubt this as the machine I am experiencing this problem on has no pagefile / 0MB set, as it has 1.5GB Ram.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">8th September 2006, 17:48</div></div><div class="posttext">All of your ExecDos calls cause stack corruption. You pass only the application to run and not the stdin string and the log file name. Seeing FindProc returning/getting parts of the stack of ExecDos, you definitely have a stack corruption and it might be related to this issue.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">12th September 2006, 05:37</div></div><div class="posttext">Why would execdos calls be causing stack corruption? Is this because of the formatting I have used?<br />
<br />
How should syntax be if I am running, with no log file:<br />
<br />
$TORDIRECTORY\TorCircuitStatus 82<br />
<br />
It was said that it was: '&quot;$TORDIRECTORY\TorCircuitStatus&quot; 82' but this does not address the log file.<br />
<br />
So I assume it should be:<br />
'&quot;$TORDIRECTORY\TorCircuitStatus&quot; 82' &quot;&quot; &quot;&quot;<br />
<br />
BTW, I tried the program on a different machine, and was able to reproduce forking after running and exiting the program 10 or so times.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">15th September 2006, 09:13</div></div><div class="posttext">It's because of the way you've used ExecDos. You've passed only one argument where ExecDos expects 3 (numbers might be off, see the readme for the exact numbers). This makes it pop two more arguments from the stack that have nothing to do with ExecDos. It causes stack corruption because something else was expecting those stack items.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>