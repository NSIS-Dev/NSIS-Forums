<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" function for writing REG_MULTI_SZ strings, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  function for writing REG_MULTI_SZ strings NSIS Discussion" />
	
	<title> function for writing REG_MULTI_SZ strings [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  function for writing REG_MULTI_SZ strings</div>
<hr />
<div class="pda"><a href="t-172312.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=172312">function for writing REG_MULTI_SZ strings</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">mancini</div><div class="date">6th March 2004, 17:53</div></div><div class="posttext">i need to write a reg_multi_sz string fomr my installer and i found this nsis code writen by KiCHiK that reads such strings http://www.cusec.ca/doc/DocSrc/SectionC.7.html<br />
<br />
KiCHiK can you make that code into a function that instead of reading such a string creates it ?<br />
<br />
or at least help me modify that code into a function that does this <br />
<br />
i really need this and it is nesesarry that it be a function so i dont have to write all the code every time i have a multy_sz string to make</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">6th March 2004, 18:52</div></div><div class="posttext">Sorry, no time. You'd have to try it on your own.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mancini</div><div class="date">6th March 2004, 21:42</div></div><div class="posttext">well here is my best shot<br />
however i dont understand where i should put the data<br />
<br />
<br />
OutFile &quot;REG_MULTI_SZ_writer.exe&quot;<br />
Name &quot;REG_MULTI_SZ&quot;<br />
ShowInstDetails show<br />
<br />
!define HKEY_CLASSES_ROOT        0x80000000<br />
!define HKEY_CURRENT_USER        0x80000001<br />
!define HKEY_LOCAL_MACHINE       0x80000002<br />
!define HKEY_USERS               0x80000003<br />
!define HKEY_PERFORMANCE_DATA    0x80000004<br />
!define HKEY_PERFORMANCE_TEXT    0x80000050<br />
!define HKEY_PERFORMANCE_NLSTEXT 0x80000060<br />
!define HKEY_CURRENT_CONFIG      0x80000005<br />
!define HKEY_DYN_DATA            0x80000006<br />
<br />
!define KEY_SET_VALUE		0x0002<br />
!define KEY_CREATE_SUB_KEY	0x0004<br />
<br />
!define REG_NONE                 0<br />
!define REG_SZ                   1<br />
!define REG_EXPAND_SZ            2<br />
!define REG_BINARY               3<br />
!define REG_DWORD                4<br />
!define REG_DWORD_LITTLE_ENDIAN  4<br />
!define REG_DWORD_BIG_ENDIAN     5<br />
!define REG_LINK                 6<br />
!define REG_MULTI_SZ             7<br />
<br />
!define RegCreateKeyEx     &quot;Advapi32::RegCreateKeyA(i, t, i, i, i) i&quot;<br />
!define RegSetValueEx	&quot;Advapi32::RegSetValueExA(i, t, i, i, i, i, i) i&quot;<br />
!define RegCloseKey      &quot;Advapi32::RegCloseKeyA(i) i&quot;<br />
<br />
####### Edit this!<br />
!define ROOT_KEY         &quot;${HKEY_LOCAL_MACHINE}&quot;<br />
!define SUB_KEY          &quot;SYSTEM\CurrentControlSet\Services\Apache2(SSL)\Parameters&quot;<br />
!define VALUE            &quot;ConfigArgs&quot;<br />
!define DATA            &quot;-f c:\apache2\conf\httpd.conf&quot;<br />
####### Stop editing<br />
<br />
Section &quot;Write&quot;<br />
  StrCpy $0 &quot;&quot;<br />
  StrCpy $1 &quot;&quot;<br />
  StrCpy $2 &quot;&quot;<br />
  StrCpy $3 &quot;&quot;<br />
  SetPluginUnload alwaysoff<br />
  System::Call &quot;*(i) i (0) .r0&quot;<br />
  System::Call &quot;*(i) i (0) .r1&quot;<br />
  System::Call &quot;*(i) i (0) .r2&quot;<br />
  System::Call &quot;${RegCreateKeyEx}(${ROOT_KEY}, '${SUB_KEY}', \<br />
	 0, ${KEY_SET_VALUE}|${KEY_CREATE_SUB_KEY}, r0) .r3&quot;<br />
<br />
  StrCmp $3 0 write<br />
    MessageBox MB_OK|MB_ICONSTOP &quot;Can't write registry key! ($3)&quot;<br />
    Goto done<br />
write:<br />
<br />
  System::Call &quot;*$0(&amp;i4 .r4)&quot;<br />
  System::Call &quot;${RegSetValueEx}(r4, '${VALUE}', 0, r1, 0, r2) .r3&quot;<br />
<br />
  StrCmp $3 0 done<br />
    MessageBox MB_OK|MB_ICONSTOP &quot;Can't set key value! ($3)&quot;<br />
    Goto done<br />
done:<br />
<br />
  System::Free $2<br />
  System::Free $1<br />
<br />
  StrCmp $0 0 noClose<br />
    System::Call &quot;${RegCloseKey}(r0)&quot;<br />
<br />
noClose:<br />
<br />
  SetPluginUnload manual<br />
  System::Free $0<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mancini</div><div class="date">7th March 2004, 11:04</div></div><div class="posttext">ok figured where to put the data but i dont know how to calculate its size<br />
<br />
<br />
OutFile &quot;REG_MULTI_SZ_writer.exe&quot;<br />
Name &quot;REG_MULTI_SZ&quot;<br />
ShowInstDetails show<br />
<br />
!define HKEY_CLASSES_ROOT        0x80000000<br />
!define HKEY_CURRENT_USER        0x80000001<br />
!define HKEY_LOCAL_MACHINE       0x80000002<br />
!define HKEY_USERS               0x80000003<br />
!define HKEY_PERFORMANCE_DATA    0x80000004<br />
!define HKEY_PERFORMANCE_TEXT    0x80000050<br />
!define HKEY_PERFORMANCE_NLSTEXT 0x80000060<br />
!define HKEY_CURRENT_CONFIG      0x80000005<br />
!define HKEY_DYN_DATA            0x80000006<br />
<br />
!define KEY_QUERY_VALUE		0x0001<br />
!define KEY_SET_VALUE		0x0002<br />
!define KEY_CREATE_SUB_KEY	0x0004<br />
!define KEY_ENUMERATE_SUB_KEYS	0x0008<br />
!define KEY_NOTIFY		0x0010<br />
!define KEY_CREATE_LINK		0x0020<br />
<br />
!define REG_NONE                 0<br />
!define REG_SZ                   1<br />
!define REG_EXPAND_SZ            2<br />
!define REG_BINARY               3<br />
!define REG_DWORD                4<br />
!define REG_DWORD_LITTLE_ENDIAN  4<br />
!define REG_DWORD_BIG_ENDIAN     5<br />
!define REG_LINK                 6<br />
!define REG_MULTI_SZ             7<br />
<br />
!define RegCreateKeyEx     &quot;Advapi32::RegCreateKeyA(i, t, i) i&quot;<br />
!define RegSetValueEx	&quot;Advapi32::RegSetValueExA(i, t, i, i, t, i) i&quot;<br />
!define RegCloseKey      &quot;Advapi32::RegCloseKeyA(i) i&quot;<br />
<br />
####### Edit this!<br />
!define SUB_KEY          &quot;SYSTEM\CurrentControlSet\Services\Apache2(SSL)\Parameters&quot;<br />
!define VALUE            &quot;ConfigArgs&quot;<br />
!define DATA            &quot;-f c:\apache2\conf\httpd.conf&quot;<br />
####### Stop editing<br />
<br />
Section &quot;Write&quot;<br />
  StrCpy $0 &quot;&quot;<br />
  StrCpy $1 &quot;&quot;<br />
  StrCpy $2 &quot;&quot;<br />
  StrCpy $3 &quot;&quot;<br />
  SetPluginUnload alwaysoff<br />
  System::Call &quot;*(i) i (0) .r0&quot;<br />
  System::Call &quot;*(i) i (0) .r1&quot;<br />
  System::Call &quot;*(i) i (0) .r2&quot;<br />
  System::Call &quot;${RegCreateKeyEx}(${HKEY_LOCAL_MACHINE},'${SUB_KEY}',r0) .r3&quot;<br />
;${RegCreateKeyEx}(root key,sub key,subkey handle)<br />
<br />
  StrCmp $3 0 write<br />
    MessageBox MB_OK|MB_ICONSTOP &quot;Can't write registry key! ($3)&quot;<br />
    Goto done<br />
write:<br />
<br />
;  System::Call &quot;*$0(&amp;i4 .r4)&quot;<br />
  System::Call &quot;${RegSetValueEx}(r0,'${VALUE}',0,${REG_MULTI_SZ},'${DATA}',29) .r3&quot;<br />
;${RegSetValueEx}(subkey handle,value name,must be zero,value type,value data,lenght of data)<br />
<br />
  StrCmp $3 0 done<br />
    MessageBox MB_OK|MB_ICONSTOP &quot;Can't set key value! ($3)&quot;<br />
    Goto done<br />
done:<br />
<br />
  System::Free $2<br />
  System::Free $1<br />
<br />
  StrCmp $0 0 noClose<br />
    System::Call &quot;${RegCloseKey}(r0)&quot;<br />
<br />
noClose:<br />
<br />
  SetPluginUnload manual<br />
  System::Free $0<br />
SectionEnd<br />
<br />
<br />
can you at least tell me what  System::Call &quot;*$0(&amp;i4 .r4)&quot; is for and does ?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">deguix</div><div class="date">7th March 2004, 13:01</div></div><div class="posttext">I have problems with the value insertion, is required from strings with REG_MULTI_SZ the ending of 2 null chars, and a common string has just 1.<br />
<br />
The error given was:<br />
<br />
ERROR_INVALID_PARAMETER (87)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mancini</div><div class="date">7th March 2004, 19:33</div></div><div class="posttext">well i figured out how to get the string lenght (silly me)<br />
but i still dont know what is the symbol for null char in nsis or if there is one<br />
<br />
<br />
OutFile &quot;REG_MULTI_SZ_writer.exe&quot;<br />
Name &quot;REG_MULTI_SZ&quot;<br />
ShowInstDetails show<br />
<br />
!define HKEY_CLASSES_ROOT        0x80000000<br />
!define HKEY_CURRENT_USER        0x80000001<br />
!define HKEY_LOCAL_MACHINE       0x80000002<br />
!define HKEY_USERS               0x80000003<br />
!define HKEY_PERFORMANCE_DATA    0x80000004<br />
!define HKEY_PERFORMANCE_TEXT    0x80000050<br />
!define HKEY_PERFORMANCE_NLSTEXT 0x80000060<br />
!define HKEY_CURRENT_CONFIG      0x80000005<br />
!define HKEY_DYN_DATA            0x80000006<br />
<br />
!define KEY_QUERY_VALUE		0x0001<br />
!define KEY_SET_VALUE		0x0002<br />
!define KEY_CREATE_SUB_KEY	0x0004<br />
!define KEY_ENUMERATE_SUB_KEYS	0x0008<br />
!define KEY_NOTIFY		0x0010<br />
!define KEY_CREATE_LINK		0x0020<br />
<br />
!define REG_NONE                 0<br />
!define REG_SZ                   1<br />
!define REG_EXPAND_SZ            2<br />
!define REG_BINARY               3<br />
!define REG_DWORD                4<br />
!define REG_DWORD_LITTLE_ENDIAN  4<br />
!define REG_DWORD_BIG_ENDIAN     5<br />
!define REG_LINK                 6<br />
!define REG_MULTI_SZ             7<br />
<br />
!define RegCreateKeyEx     &quot;Advapi32::RegCreateKeyA(i, t, i) i&quot;<br />
!define RegSetValueEx	&quot;Advapi32::RegSetValueExA(i, t, i, i, t, i) i&quot;<br />
!define RegCloseKey      &quot;Advapi32::RegCloseKeyA(i) i&quot;<br />
<br />
####### Edit this!<br />
!define SUB_KEY          &quot;SYSTEM\CurrentControlSet\Services\Apache2(SSL)\Parameters&quot;<br />
!define VALUE            &quot;ConfigArgs&quot;<br />
!define DATA            &quot;-f\0c:\apache2\conf\httpd.conf\0\0&quot;<br />
####### Stop editing<br />
<br />
Section &quot;Write&quot;<br />
  StrCpy $0 &quot;&quot;<br />
  StrCpy $1 &quot;&quot;<br />
  StrCpy $2 &quot;&quot;<br />
  StrCpy $3 &quot;&quot;<br />
  SetPluginUnload alwaysoff<br />
  System::Call &quot;*(i) i (0) .r0&quot;<br />
  System::Call &quot;*(i) i (0) .r1&quot;<br />
  System::Call &quot;*(i) i (0) .r2&quot;<br />
  System::Call &quot;${RegCreateKeyEx}(${HKEY_LOCAL_MACHINE},'${SUB_KEY}',r0) .r3&quot;<br />
;${RegCreateKeyEx}(root key,sub key,subkey handle)<br />
<br />
  StrCmp $3 0 write<br />
    MessageBox MB_OK|MB_ICONSTOP &quot;Can't write registry key! ($3)&quot;<br />
    Goto done<br />
write:<br />
<br />
;  System::Call &quot;*$0(&amp;i4 .r4)&quot;<br />
   StrLen $9 '${DATA}'<br />
   IntOp $9 $9 + 1<br />
  System::Call &quot;${RegSetValueEx}(r0,'${VALUE}',0,${REG_MULTI_SZ},'${DATA}',$9) .r3&quot;<br />
;${RegSetValueEx}(subkey handle,value name,must be zero,value type,value data,lenght of data)<br />
<br />
  StrCmp $3 0 done<br />
    MessageBox MB_OK|MB_ICONSTOP &quot;Can't set key value! ($3)&quot;<br />
    Goto done<br />
done:<br />
<br />
  System::Free $2<br />
  System::Free $1<br />
<br />
  StrCmp $0 0 noClose<br />
    System::Call &quot;${RegCloseKey}(r0)&quot;<br />
<br />
noClose:<br />
<br />
  SetPluginUnload manual<br />
  System::Free $0<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">7th March 2004, 19:34</div></div><div class="posttext">NSIS strings are automatically cut off when there is a null char.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mancini</div><div class="date">7th March 2004, 19:52</div></div><div class="posttext">ok .. well then there is no solution to this ?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">deguix</div><div class="date">8th March 2004, 03:22</div></div><div class="posttext">Did you get working the first part of your code? (I'm working to fix the code)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mancini</div><div class="date">8th March 2004, 16:47</div></div><div class="posttext">everything works for me besides the RegSetValue call</div></div><hr />


<div class="post"><div class="posttop"><div class="username">deguix</div><div class="date">8th March 2004, 22:36</div></div><div class="posttext">Yep, as everybody is using more the System plugin, new requirements exist, one of them is to add support to include null strings in variables, in NSIS or System plugin.<br />
<br />
For me your first part code doesn't work for me, what OS are you using? Win 98? (I have Win XP)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">eccles</div><div class="date">9th March 2004, 00:00</div></div><div class="posttext">Enjoy :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">deguix</div><div class="date">9th March 2004, 01:27</div></div><div class="posttext">Oh man! That is awsome! Where did you find that? It HAS to be in the documentation of System plugin.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">deguix</div><div class="date">9th March 2004, 09:59</div></div><div class="posttext">Ah, now I know, the old brainsucker lessons. Now I've a lot to do...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">eccles</div><div class="date">9th March 2004, 13:37</div></div><div class="posttext">Where did you find that?It's basically the same as kichik's original example but with the innards reversed. The key to both routines is the &amp;t stuff. At no time is the whole multi_sz value in a NSIS string, so we don't need to worry about the NSIS null-in-string restriction.<br />
<br />
I also used the * syntax to simplify the code that deals with the registry handle.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mancini</div><div class="date">9th March 2004, 16:25</div></div><div class="posttext">thanks eccles<br />
<br />
and here is that code turned into a function that can be called multiple times with diferent values from inside a section<br />
<br />
however there is a problem .. it only works on versions newer than 20beta3.. because the var comand was implemented in 20beta4<br />
<br />
<br />
OutFile &quot;REG_MULTI_SZ_writer.exe&quot;<br />
Name &quot;REG_MULTI_SZ&quot;<br />
ShowInstDetails show<br />
<br />
var SUB_KEY<br />
var VALUE<br />
var DATA_1<br />
var DATA_2<br />
<br />
Section Test<br />
strcpy $SUB_KEY                  &quot;SYSTEM\CurrentControlSet\Services\Apache2\Parameters&quot;<br />
strcpy $VALUE                    &quot;ConfigArgs&quot;<br />
strcpy $DATA_1                   &quot;-f&quot;<br />
strcpy $DATA_2                   &quot;c:\apache2\conf\httpd.conf&quot;<br />
Call RegWrite<br />
<br />
strcpy $SUB_KEY                  &quot;SYSTEM\CurrentControlSet\Services\Apache2(SSL)\Parameters&quot;<br />
strcpy $VALUE                    &quot;ConfigArgs&quot;<br />
strcpy $DATA_1                   &quot;-f&quot;<br />
strcpy $DATA_2                   &quot;c:\apache2\conf\httpd.conf&quot;<br />
Call RegWrite<br />
SectionEnd<br />
<br />
Function RegWrite<br />
!define HKEY_CLASSES_ROOT        0x80000000<br />
!define HKEY_CURRENT_USER        0x80000001<br />
!define HKEY_LOCAL_MACHINE       0x80000002<br />
!define HKEY_USERS               0x80000003<br />
!define HKEY_PERFORMANCE_DATA    0x80000004<br />
!define HKEY_PERFORMANCE_TEXT    0x80000050<br />
!define HKEY_PERFORMANCE_NLSTEXT 0x80000060<br />
!define HKEY_CURRENT_CONFIG      0x80000005<br />
!define HKEY_DYN_DATA            0x80000006<br />
<br />
!define KEY_QUERY_VALUE          0x0001<br />
!define KEY_SET_VALUE            0x0002<br />
!define KEY_CREATE_SUB_KEY       0x0004<br />
!define KEY_ENUMERATE_SUB_KEYS   0x0008<br />
!define KEY_NOTIFY               0x0010<br />
!define KEY_CREATE_LINK          0x0020<br />
<br />
!define REG_NONE                 0<br />
!define REG_SZ                   1<br />
!define REG_EXPAND_SZ            2<br />
!define REG_BINARY               3<br />
!define REG_DWORD                4<br />
!define REG_DWORD_LITTLE_ENDIAN  4<br />
!define REG_DWORD_BIG_ENDIAN     5<br />
!define REG_LINK                 6<br />
!define REG_MULTI_SZ             7<br />
<br />
!define RegCreateKey             &quot;Advapi32::RegCreateKeyA(i, t, *i) i&quot;<br />
!define RegSetValueEx            &quot;Advapi32::RegSetValueExA(i, t, i, i, i, i) i&quot;<br />
!define RegCloseKey              &quot;Advapi32::RegCloseKeyA(i) i&quot;<br />
<br />
  SetPluginUnload alwaysoff<br />
  ; Create a buffer for the multi_sz value<br />
  System::Call &quot;*(&amp;t${NSIS_MAX_STRLEN}) i.r1&quot;<br />
  ; Open/create the registry key<br />
  System::Call &quot;${RegCreateKey}(${HKEY_LOCAL_MACHINE}, '$SUB_KEY', .r0) .r9&quot;<br />
  ; Failed?<br />
  IntCmp $9 0 write<br />
    MessageBox MB_OK|MB_ICONSTOP &quot;Can't create registry key! ($9)&quot;<br />
    Goto noClose<br />
<br />
  write:<br />
    ; Fill in the buffer with our strings<br />
    StrCpy $2 $1                            ; Initial position<br />
<br />
    StrLen $9 '$DATA_1'                   ; Length of first string<br />
    IntOp $9 $9 + 1                         ; Plus null<br />
    System::Call &quot;*$2(&amp;t$9 '$DATA_1')&quot;    ; Place the string<br />
    IntOp $2 $2 + $9                        ; Advance to the next position<br />
<br />
    StrLen $9 '$DATA_2'                   ; Length of second string<br />
    IntOp $9 $9 + 1                         ; Plus null<br />
    System::Call &quot;*$2(&amp;t$9 '$DATA_2')&quot;    ; Place the string<br />
    IntOp $2 $2 + $9                        ; Advance to the next position<br />
<br />
    System::Call &quot;*$2(&amp;t1 '')&quot;              ; Place the terminating null<br />
    IntOp $2 $2 + 1                         ; Advance to the next position<br />
<br />
    ; Create/write the value<br />
    IntOp $2 $2 - $1                        ; Total length<br />
    System::Call &quot;${RegSetValueEx}(r0, '$VALUE', 0, ${REG_MULTI_SZ}, r1, r2) .r9&quot;<br />
    ; Failed?<br />
    IntCmp $9 0 done<br />
      MessageBox MB_OK|MB_ICONSTOP &quot;Can't set key value! ($9)&quot;<br />
      Goto done<br />
<br />
  done:<br />
    ; Close the registry key<br />
    System::Call &quot;${RegCloseKey}(r0)&quot;<br />
<br />
noClose:<br />
  ; Clear the buffer<br />
  SetPluginUnload manual<br />
  System::Free $1<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">deguix</div><div class="date">9th March 2004, 21:39</div></div><div class="posttext">Continue to request System codes, I'm collecting them all, including all the old ones...</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>