<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Silent uninstall will not abort if application is in use, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Silent uninstall will not abort if application is in use NSIS Discussion" />
	
	<title> Silent uninstall will not abort if application is in use [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Silent uninstall will not abort if application is in use</div>
<hr />
<div class="pda"><a href="t-262969.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=262969">Silent uninstall will not abort if application is in use</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">QMastor</div><div class="date">4th January 2007, 00:51</div></div><div class="posttext">I have an uninstaller that checks whether the application it is removing is currently in use (Using iceman_k's &quot;FindProc&quot; plugin), and is supposed to abort if it is.<br />
<br />
When running the uninstaller normally, a custom page is displayed (Using the MUI) informing the user that they need to exit the application before continuing. This works as expected.<br />
<br />
However, if the uninstaller is run silently, it should abort during the initialization phase. This is NOT working as expected. Every time I run the uninstaller silently, it will continue with the uninstallation process regardless of whether the application is currently in use or not.<br />
<br />
The following is a simplified version of my uninstaller:<br />
<br />
<br />
!insertmacro MUI_UNPAGE_WELCOME<br />
UninstPage CUSTOM un.ApplicationInUse_EnterPage un.ApplicationInUse_ExitPage<br />
!insertmacro MUI_UNPAGE_CONFIRM<br />
!insertmacro MUI_UNPAGE_INSTFILES<br />
!insertmacro MUI_UNPAGE_FINISH<br />
<br />
<br />
Section &quot;Uninstall&quot;<br />
  ; These instructions are reused by &quot;onInstFailed&quot;<br />
  !include &quot;Uninstallation.nsi&quot;<br />
<br />
  SetAutoClose TRUE<br />
SectionEnd<br />
<br />
<br />
Function un.onInit<br />
  IfSilent +3 0<br />
  !insertmacro MUI_INSTALLOPTIONS_EXTRACT &quot;CustomPage.ini&quot;<br />
  GoTo End<br />
<br />
  FindProcDLL::FindProc &quot;MyApplication.exe&quot;<br />
  Pop $R0<br />
  ${If} $R0 == 1<br />
    Abort<br />
  ${EndIf}<br />
<br />
  End:<br />
FunctionEnd<br />
<br />
<br />
Function un.ApplicationInUse_EnterPage<br />
  FindProcDLL::FindProc &quot;MyApplication.exe&quot;<br />
  Pop $R0<br />
<br />
  ${If} $R0 == 1<br />
    !insertmacro MUI_INSTALLOPTIONS_DISPLAY &quot;CustomPage.ini&quot;<br />
  ${EndIf}<br />
FunctionEnd<br />
<br />
<br />
Function un.ApplicationInUse_ExitPage<br />
  Quit<br />
FunctionEnd<br />
<br />
<br />
Note that the &quot;FindProc&quot; call only returns a value of &quot;1&quot; if the application can definitely be determined to be in use.<br />
<br />
So, the question is, what's the problem? The script being used in the &quot;un.onInit&quot; and &quot;un.ApplicationInUse_EnterPage&quot; functions is the same, yet only the latter works as expected.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">4th January 2007, 05:47</div></div><div class="posttext">The code as it appears here seems correct.<br />
Did you try to debug the silent return of FindProcDll with a message box? e.g.<br />
<br />
Function un.onInit<br />
  IfSilent 0 end<br />
  FindProcDLL::FindProc &quot;MyApplication.exe&quot;<br />
  Pop $R0<br />
  MessageBox MB_OK '$$R0 == {$R0}'<br />
  ${If} $R0 == 1<br />
    Abort<br />
  ${EndIf}<br />
  End:<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">QMastor</div><div class="date">4th January 2007, 06:08</div></div><div class="posttext">Originally posted by Red Wine <br />
Did you try to debug the silent return of FindProcDll with a message box?<br />
<br />
I was of the belief that MessageBoxes didn't display in Silent mode, and since no MessageBox was displayed when I tested your suggestion code, it looks like I may have been right... ;)<br />
<br />
Should the MessageBox be displayed when Silent mode is on, or is there another (Preferrably easy) way of outputting debug information?<br />
<br />
Either way, I would hope that the plugin should behave the same way regardless of the uninstaller's &quot;silence&quot;. I can't think of any reason why it shouldn't...?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">4th January 2007, 06:32</div></div><div class="posttext">This doesn't work for you?<br />
<br />
OutFile 'test.exe'<br />
<br />
Section &quot;boo&quot;<br />
        call func<br />
SectionEnd<br />
<br />
function func<br />
      IfSilent +1 +2<br />
      Messagebox MB_OK 'We re running silent'  idok end<br />
      Messagebox MB_OK 'poof'<br />
end:<br />
functionend<br />
<br />
function .onInit<br />
      SetSilent silent<br />
functionend</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">4th January 2007, 06:54</div></div><div class="posttext">is there another (Preferrably easy) way of outputting debug information?<br />
<br />
Function un.onInit<br />
FileOpen $0 '$EXEDIR\debug.txt' w<br />
IfSilent 0 end<br />
FindProcDLL::FindProc &quot;MyApplication.exe&quot;<br />
Pop $R0<br />
;MessageBox MB_OK '$$R0 == {$R0}'<br />
FileWrite $0  'We re running silent$\r$\n'<br />
FileWrite $0  '$$R0 == {$R0}$\n$\n'<br />
FileClose $0<br />
ExecShell open '$EXEDIR\debug.txt'<br />
${If} $R0 == 1<br />
Abort<br />
${EndIf}<br />
End:<br />
FileWrite $0  'We re NOT running silent'<br />
FileClose $0<br />
ExecShell open '$EXEDIR\debug.txt'<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">QMastor</div><div class="date">4th January 2007, 22:55</div></div><div class="posttext">Previous attempts to make a MessageBox appear when running in Silent mode did not work, but recent ones did, so I'll lump that in with the other great mysteries of life for the time-being.<br />
<br />
When I did eventually get my MessageBox, it indicated that the plugin was working as expected, so I started looking at other things.<br />
<br />
One small change I tried, was changing the label used to direct program execution when it was determined that the uninstaller was running in Silent mode. Instead of a &quot;+3&quot;, to skip over the extraction of a custom GUI page, I created a label just before the start of the &quot;Silent mode&quot; script, and explicitly named it. Strangely enough, it worked perfectly!<br />
<br />
So, by changing the &quot;un.onInit&quot; function to this...<br />
<br />
<br />
Function un.onInit<br />
  IfSilent SilentMode 0<br />
  !insertmacro MUI_INSTALLOPTIONS_EXTRACT &quot;CustomPage.ini&quot;<br />
  GoTo End<br />
<br />
  SilentMode:<br />
    FindProcDLL::FindProc &quot;MyApplication.exe&quot;<br />
    Pop $R0<br />
    ${If} $R0 == 1<br />
      Abort<br />
    ${EndIf}<br />
<br />
  End:<br />
FunctionEnd<br />
<br />
<br />
...I got it working the way I had expected it to all along.<br />
<br />
I have to admit that I've occassionally run into issues with numbered labels like this before, but this one definitely looked like it should have worked... Oh well.<br />
<br />
Thankyou very much for your help anyway.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">5th January 2007, 04:21</div></div><div class="posttext">You're welcome!<br />
You may want to refer to NSIS manual 4.9.4.15 MessageBox,<br />
or accept living the life with those great &quot;mysteries&quot;. :-)<br />
BTW while studying the manual, you'll find useful info regarding to labels and relative jumps (numbered labels) :-)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>