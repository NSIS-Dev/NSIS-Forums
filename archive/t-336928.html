<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Setup crashes - Stack Overflow, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Setup crashes - Stack Overflow NSIS Discussion" />
	
	<title> Setup crashes - Stack Overflow [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Setup crashes - Stack Overflow</div>
<hr />
<div class="pda"><a href="t-336928.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=336928">Setup crashes - Stack Overflow</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">demiller9</div><div class="date">2nd November 2011, 15:58</div></div><div class="posttext">When I create a custom page and then decide not to display it I called Abort. The following page (Finish) crashes. The crash is a Stack Overflow, and the stack is full of 4 function calls: nsDialogs.dll!10001441() / USER32.dll!_UserCallWinProc@20() / USER32.dll!_CallWindowProcAorW@24() / USER32.dll!_CallWindowProcA@20().<br />
<br />
Standard NSIS 2.46 using MUI2, WinXP SP3 (and Win2000).<br />
<br />
I rewrote my installer to decide if the page will be shown before calling Create, so I don't have the problem anymore, but this smells like a bug.<br />
<br />
DonOutFile Test.exe<br />
!include &quot;MUI2.nsh&quot;<br />
!insertmacro MUI_PAGE_WELCOME<br />
Page custom MyPage<br />
!define MUI_PAGE_CUSTOMFUNCTION_PRE Finish.Pre<br />
!define MUI_PAGE_CUSTOMFUNCTION_SHOW Finish.Show<br />
!insertmacro MUI_PAGE_FINISH<br />
!insertmacro MUI_LANGUAGE &quot;English&quot;<br />
Section<br />
SectionEnd<br />
Function MyPage<br />
	${IfCmd} MessageBox MB_OKCANCEL &quot;OK = Call nsDialogs::Create$\nCancel = Abort the custom page&quot; IDCANCEL ${||} Abort ${|}<br />
	nsDialogs::Create 1018<br />
	Pop $0<br />
	${IfCmd} MessageBox MB_OKCANCEL &quot;OK = Show the custom page$\nCancel = Abort the custom page / Crash&quot; IDCANCEL ${||} Abort ${|}<br />
	!insertmacro MUI_HEADER_TEXT &quot;Custom page&quot; &quot;Aborting a custom page after the inner dialog is created crashes the installer.&quot;<br />
	nsDialogs::Show<br />
FunctionEnd<br />
Function Finish.Pre<br />
	MessageBox MB_OK &quot;This is the Pre callback&quot;<br />
FunctionEnd<br />
Function Finish.Show<br />
	MessageBox MB_OK &quot;This is the Show callback&quot;<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">2nd November 2011, 16:03</div></div><div class="posttext">Calling Abort after creating the custom page will no doubt cause unpredictable behaviour as it is not something you should be doing.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">demiller9</div><div class="date">2nd November 2011, 16:44</div></div><div class="posttext">Stu<br />
I agree that Abort is something to avoid after calling Create, but the 'bug' still happens - without calling Abort - if I simply skip the nsDialogs::Show function.<br />
<br />
This version doesn't call Abort after calling Create. Crashes when asked to not show the custom page.<br />
DonOutFile Test_1.exe<br />
!include &quot;MUI2.nsh&quot;<br />
!insertmacro MUI_PAGE_WELCOME<br />
Page custom MyPage<br />
!define MUI_PAGE_CUSTOMFUNCTION_PRE Finish.Pre<br />
!define MUI_PAGE_CUSTOMFUNCTION_SHOW Finish.Show<br />
!insertmacro MUI_PAGE_FINISH<br />
!insertmacro MUI_LANGUAGE &quot;English&quot;<br />
Section<br />
SectionEnd<br />
Function MyPage<br />
	${IfCmd} MessageBox MB_OKCANCEL &quot;OK = Call nsDialogs::Create$\nCancel = Abort the custom page&quot; IDCANCEL ${||} Abort ${|}<br />
	nsDialogs::Create 1018<br />
	Pop $0<br />
	!insertmacro MUI_HEADER_TEXT &quot;Custom page&quot; &quot;Aborting a custom page after the inner dialog is created crashes the installer.&quot;<br />
	${IfCmd} MessageBox MB_OKCANCEL &quot;OK = Show the custom page$\nCancel = Don$\'t show the custom page / Crash&quot; IDOK ${||} nsDialogs::Show ${|}<br />
FunctionEnd<br />
Function Finish.Pre<br />
	MessageBox MB_OK &quot;This is the Pre callback&quot;<br />
FunctionEnd<br />
Function Finish.Show<br />
	MessageBox MB_OK &quot;This is the Show callback&quot;<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">2nd November 2011, 18:05</div></div><div class="posttext">The fact that you are skipping Show is what is causing the crash. It has nothing to do with calling Abort as such. It is because you are creating the dialog but never showing it thus allowing the installer to load the next page without allowing the plug-in to cleanup and de-subclass any window procedures. The plug-in could be fixed to not crash, but why add the extra C code when the scripter shouldn't be doing this in the first place.<br />
<br />
Edit: Basically the 'bug' is with your code, not the plug-ins'.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">T.Slappy</div><div class="date">3rd November 2011, 07:30</div></div><div class="posttext">Simply to say: you use nsDialogs::Create without nsDialogs::Show, that is causing all issues.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">demiller9</div><div class="date">3rd November 2011, 14:37</div></div><div class="posttext">I know that's what causes it; I think that it shouldn't cause a stack overflow. Who knows - maybe a one line code change could avoid the crash.<br />
<br />
My installer no longer does anything like this, so I won't see it crash. I started the thread to see if anyone was interested in fixing the root cause of the crash.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">8th November 2011, 01:10</div></div><div class="posttext">With the custom page plugins; once you say A you have to say B :) (There is probably some subclassing going on to catch the page change messages)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">anandsunku</div><div class="date">16th November 2011, 12:23</div></div><div class="posttext">if the installer crashes after installation is complete due to some reason, how can we do the crash dump analysis. like we do for the c++ code with windbg. like collecting symbols, loading symbols , etc.,</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>