<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" string replacement fun, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  string replacement fun NSIS Discussion" />
	
	<title> string replacement fun [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  string replacement fun</div>
<hr />
<div class="pda"><a href="t-232584.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=232584">string replacement fun</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">jfrapper</div><div class="date">5th December 2005, 12:52</div></div><div class="posttext">Hi,<br />
<br />
I am a new user and have tried a few ways to multiple text replaces in a file.  I have checked the macro lib and many Instructor posts.  This example is an attempt to use a suggestion in the post http://forums.winamp.com/showthread.php?threadid=205146&amp;highlight=replace   <br />
<br />
The result of running the following installer is a messagebox with &quot;Error&quot; in it.<br />
<br />
; The name of the installer<br />
Name &quot;try&quot;<br />
<br />
; The default installation directory<br />
InstallDir $PROGRAMFILES\try<br />
  <br />
; The file to write<br />
OutFile &quot;try.exe&quot;<br />
<br />
;--------------------------------<br />
; Pages<br />
Page directory<br />
Page instfiles<br />
;--------------------------------<br />
<br />
!include &quot;TextFunc.nsh&quot;<br />
!insertmacro LineFind<br />
!include &quot;WordFunc.nsh&quot;<br />
!insertmacro WordReplace<br />
<br />
; The stuff to install<br />
Section &quot;&quot; ;No components page, name is not important<br />
<br />
    File /nonfatal web.config<br />
    <br />
    SetOutPath $INSTDIR<br />
 <br />
	${LineFind} &quot;web.conf&quot; &quot;web.conf&quot; &quot;1:-1&quot; &quot;LineFindCallback&quot;<br />
<br />
	IfErrors 0 +2<br />
	MessageBox MB_OK &quot;Error&quot;<br />
<br />
    ;Push &quot;&lt;!--&lt;identity impersonate='true' /&gt;--&gt;&quot;<br />
    ;Push &quot;&lt;identity impersonate='true' /&gt;&quot;<br />
    <br />
    WriteUninstaller uninstall.exe<br />
    <br />
	IfErrors 0 +2<br />
	MessageBox MB_OK &quot;Error&quot;<br />
<br />
SectionEnd ; end the section<br />
<br />
Function LineFindCallback<br />
	${WordReplace} '$R9' '~/images/' '/images/' '+*' $R9<br />
;	${WordReplace} '$R9' '123' '321' '+' $R9<br />
<br />
	Push $0<br />
FunctionEnd<br />
<br />
Section &quot;Uninstall&quot;<br />
  <br />
  ; Remove files and uninstaller<br />
  Delete $INSTDIR\try.nsi<br />
  Delete $INSTDIR\uninstall.exe<br />
<br />
  ; Remove directories used<br />
  RMDir /r &quot;$INSTDIR&quot;<br />
<br />
SectionEnd<br />
<br />
<br />
Another attempt was to use the replace in file function in the macro library.  What happened was that the first replace would work, but the second one would not.  Even if I flip flopped them.  Here is the script for that attempt.<br />
<br />
;!include &quot;$PROGRAMFILES\NSIS\Include\StrReplace.nsh&quot;<br />
<br />
; The name of the installer<br />
Name &quot;try&quot;<br />
<br />
; The default installation directory<br />
InstallDir $PROGRAMFILES\try<br />
  <br />
; The file to write<br />
OutFile &quot;try.exe&quot;<br />
<br />
;--------------------------------<br />
; Pages<br />
Page directory<br />
Page instfiles<br />
;--------------------------------<br />
<br />
!include &quot;${NSISDIR}\Include\LogicLib.nsh&quot;<br />
!define StrRep &quot;!insertmacro StrRep&quot;<br />
 <br />
!macro StrRep ResultVar String SubString RepString<br />
  Push &quot;${String}&quot;<br />
  Push &quot;${SubString}&quot;<br />
  Push &quot;${RepString}&quot;<br />
  Call StrRep<br />
  Pop &quot;${ResultVar}&quot;<br />
!macroend<br />
<br />
Function RIF<br />
 <br />
  ClearErrors  ; want to be a newborn<br />
 <br />
  Exch $0      ; REPLACEMENT<br />
  Exch<br />
  Exch $1      ; SEARCH_TEXT<br />
  Exch 2<br />
  Exch $2      ; SOURCE_FILE<br />
 <br />
  Push $R0     ; SOURCE_FILE file handle<br />
  Push $R1     ; temporary file handle<br />
  Push $R2     ; unique temporary file name<br />
  Push $R3     ; a line to sar/save<br />
  Push $R4     ; shift puffer<br />
 <br />
  IfFileExists $2 +1 RIF_error      ; knock-knock<br />
  FileOpen $R0 $2 &quot;r&quot;               ; open the door<br />
 <br />
  GetTempFileName $R2               ; who's new?<br />
  FileOpen $R1 $R2 &quot;w&quot;              ; the escape, please!<br />
 <br />
  RIF_loop:                         ; round'n'round we go<br />
    FileRead $R0 $R3                ; read one line<br />
    IfErrors RIF_leaveloop          ; enough is enough<br />
    RIF_sar:                        ; sar - search and replace<br />
      Push &quot;$R3&quot;                    ; (hair)stack<br />
      Push &quot;$1&quot;                     ; needle<br />
      Push &quot;$0&quot;                     ; blood<br />
      Call StrRep               ; do the bartwalk<br />
      StrCpy $R4 &quot;$R3&quot;              ; remember previous state<br />
      Pop $R3                       ; gimme s.th. back in return!<br />
      StrCmp &quot;$R3&quot; &quot;$R4&quot; +1 RIF_sar ; loop, might change again!<br />
    FileWrite $R1 &quot;$R3&quot;             ; save the newbie<br />
  Goto RIF_loop                     ; gimme more<br />
 <br />
  RIF_leaveloop:                    ; over'n'out, Sir!<br />
    FileClose $R1                   ; S'rry, Ma'am - clos'n now<br />
    FileClose $R0                   ; me 2<br />
 <br />
    Delete &quot;$2.old&quot;                 ; go away, Sire<br />
    Rename &quot;$2&quot; &quot;$2.old&quot;            ; step aside, Ma'am<br />
    Rename &quot;$R2&quot; &quot;$2&quot;               ; hi, baby!<br />
 <br />
    ClearErrors                     ; now i AM a newborn<br />
    Goto RIF_out                    ; out'n'away<br />
 <br />
  RIF_error:                        ; ups - s.th. went wrong...<br />
    SetErrors                       ; ...so cry, boy!<br />
 <br />
  RIF_out:                          ; your wardrobe?<br />
  Pop $R4<br />
  Pop $R3<br />
  Pop $R2<br />
  Pop $R1<br />
  Pop $R0<br />
  Pop $2<br />
  Pop $0<br />
  Pop $1<br />
 <br />
FunctionEnd<br />
<br />
!macro ReplaceInFile SOURCE_FILE SEARCH_TEXT REPLACEMENT<br />
  Push &quot;${SOURCE_FILE}&quot;<br />
  Push &quot;${SEARCH_TEXT}&quot;<br />
  Push &quot;${REPLACEMENT}&quot;<br />
  Call RIF<br />
!macroend<br />
<br />
<br />
<br />
Function StrRep<br />
/*After this point:<br />
  ------------------------------------------<br />
  $R0 = RepString (input)<br />
  $R1 = SubString (input)<br />
  $R2 = String (input)<br />
  $R3 = RepStrLen (temp)<br />
  $R4 = SubStrLen (temp)<br />
  $R5 = StrLen (temp)<br />
  $R6 = StartCharPos (temp)<br />
  $R7 = TempStrL (temp)<br />
  $R8 = TempStrR (temp)*/<br />
 <br />
  ;Get input from user<br />
  Exch $R0<br />
  Exch<br />
  Exch $R1<br />
  Exch<br />
  Exch 2<br />
  Exch $R2<br />
  Push $R3<br />
  Push $R4<br />
  Push $R5<br />
  Push $R6<br />
  Push $R7<br />
  Push $R8<br />
 <br />
  ; Return &quot;String&quot; if &quot;SubString&quot; is &quot;&quot;<br />
  ${IfThen} $R1 == &quot;&quot; ${|} Goto Done ${|}<br />
 <br />
  ;Get &quot;RepString&quot;, &quot;String&quot; and &quot;SubString&quot; length<br />
  StrLen $R3 $R0<br />
  StrLen $R4 $R1<br />
  StrLen $R5 $R2<br />
  ;Start &quot;StartCharPos&quot; counter<br />
  StrCpy $R6 0<br />
 <br />
  ;Loop until &quot;SubString&quot; is found or &quot;String&quot; reaches its end<br />
  ${Do}<br />
    ;Remove everything before and after the searched part (&quot;TempStrL&quot;)<br />
    StrCpy $R7 $R2 $R4 $R6<br />
 <br />
    ;Compare &quot;TempStrL&quot; with &quot;SubString&quot;<br />
    ${If} $R7 == $R1<br />
      ;Split &quot;String&quot; to replace the string wanted<br />
      StrCpy $R7 $R2 $R6 ;TempStrL<br />
 <br />
      ;Calc: &quot;StartCharPos&quot; + &quot;SubStrLen&quot; = EndCharPos<br />
      IntOp $R8 $R6 + $R4<br />
 <br />
      StrCpy $R8 $R2 &quot;&quot; $R8 ;TempStrR<br />
 <br />
      ;Insert the new string between the two separated parts of &quot;String&quot;<br />
      StrCpy $R2 $R7$R0$R8<br />
      ;Now calculate the new &quot;StrLen&quot; and &quot;StartCharPos&quot;<br />
      StrLen $R5 $R2<br />
      IntOp $R6 $R6 + $R3<br />
      ${Continue}<br />
    ${EndIf}<br />
 <br />
    ;If not &quot;SubString&quot;, this could be &quot;String&quot; end<br />
    ${IfThen} $R6 &gt;= $R5 ${|} ${ExitDo} ${|}<br />
    ;If not, continue the loop<br />
    IntOp $R6 $R6 + 1<br />
  ${Loop}<br />
 <br />
  Done:<br />
 <br />
  ;Return output to user<br />
  StrCpy $R0 $R2<br />
 <br />
/*After this point:<br />
  ------------------------------------------<br />
  $R0 = ResultVar (output)*/<br />
 <br />
  Pop $R8<br />
  Pop $R7<br />
  Pop $R6<br />
  Pop $R5<br />
  Pop $R4<br />
  Pop $R3<br />
  Pop $R2<br />
  Pop $R1<br />
  Exch $R0<br />
FunctionEnd<br />
<br />
<br />
<br />
; The stuff to install<br />
Section &quot;&quot; ;No components page, name is not important<br />
<br />
    ; Set output path to the installation directory.<br />
    SetOutPath $INSTDIR<br />
  <br />
    File /nonfatal web.config<br />
    ;!insertmacro ReplaceInFile web.config &quot;&lt;!--&lt;identity impersonate='true' /&gt;--&gt;&quot; &quot;&lt;identity impersonate='true' /&gt;&quot;<br />
    ;!insertmacro ReplaceInFile web.config &quot;~/images/&quot; &quot;/images/&quot;<br />
    Push &quot;web.config&quot;<br />
    Push &quot;~/images/&quot;<br />
    Push &quot;/images/&quot;<br />
    Call RIF<br />
    Push &quot;web.config&quot;<br />
    Push &quot;&lt;!--&lt;identity impersonate='true' /&gt;--&gt;&quot;<br />
    Push &quot;&lt;identity impersonate='true' /&gt;&quot;<br />
    Call RIF<br />
    <br />
    WriteUninstaller uninstall.exe<br />
SectionEnd ; end the section<br />
<br />
<br />
Section &quot;Uninstall&quot;<br />
  <br />
  ; Remove files and uninstaller<br />
  Delete $INSTDIR\try.nsi<br />
  Delete $INSTDIR\uninstall.exe<br />
<br />
  ; Remove directories used<br />
  RMDir /r &quot;$INSTDIR&quot;<br />
<br />
SectionEnd<br />
<br />
In this script I just pasted in the text functions.  Again the result was no error, but just the first string replacement would work.  Any help would be appreciated.<br />
<br />
Cheers,<br />
JF</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">5th December 2005, 13:41</div></div><div class="posttext">Maybe:...<br />
SetOutPath $INSTDIR<br />
File /nonfatal web.config<br />
<br />
${LineFind} &quot;$INSTDIR\web.conf&quot; &quot;$INSTDIR\web.conf&quot; &quot;1:-1&quot; &quot;LineFindCallback&quot;<br />
...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">5th December 2005, 13:59</div></div><div class="posttext">Also don't forget to use ClearErrors before ${LineFind} because something else in the script before it at run time could be setting the error flag.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">5th December 2005, 14:25</div></div><div class="posttext">In that case, it is not necessary, function LineFind have ClearErrors at the beginning. I think if function uses SetErrors command, then to avoid misoperation need to put ClearErrors at the beginning of the function code.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jfrapper</div><div class="date">5th December 2005, 16:06</div></div><div class="posttext">Originally posted by Instructor <br />
Maybe:...<br />
SetOutPath $INSTDIR<br />
File /nonfatal web.config<br />
<br />
${LineFind} &quot;$INSTDIR\web.conf&quot; &quot;$INSTDIR\web.conf&quot; &quot;1:-1&quot; &quot;LineFindCallback&quot;<br />
...  <br />
<br />
Greetings instructor,<br />
<br />
I tried the above suggestion with the same result.  After seaching the message boards it doesn't seem as though anyone has had this exact problem before.  All I need to do is to do multiple replacements in a file.  If this isn't possible, I may not be able to use nsis to assist in our deployments.  Is there anything else that I can provide that would be of some help?<br />
<br />
Cheers,<br />
JF</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">5th December 2005, 16:57</div></div><div class="posttext">I see :) File does not exist because file name is &quot;web.config&quot; not &quot;web.conf&quot;<br />
SetOutPath $INSTDIR<br />
File /nonfatal web.config<br />
<br />
${LineFind} &quot;$INSTDIR\web.config&quot; &quot;$INSTDIR\web.config&quot; &quot;1:-1&quot; &quot;LineFindCallback&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jfrapper</div><div class="date">5th December 2005, 20:18</div></div><div class="posttext">Originally posted by Instructor <br />
I see :) File does not exist because file name is &quot;web.config&quot; not &quot;web.conf&quot;<br />
SetOutPath $INSTDIR<br />
File /nonfatal web.config<br />
<br />
${LineFind} &quot;$INSTDIR\web.config&quot; &quot;$INSTDIR\web.config&quot; &quot;1:-1&quot; &quot;LineFindCallback&quot;  <br />
<br />
<br />
Excellent, the callback is working now.  Thank you.<br />
<br />
JF</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>