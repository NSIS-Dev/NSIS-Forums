<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Re-read updated registry value, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Re-read updated registry value NSIS Discussion" />
	
	<title> Re-read updated registry value [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Re-read updated registry value</div>
<hr />
<div class="pda"><a href="t-132798.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=132798">Re-read updated registry value</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">hackingbear</div><div class="date">23rd April 2003, 03:25</div></div><div class="posttext">Hi,<br />
<br />
I'm attempting to do following:<br />
<br />
1. Read a registry value into $R0 (J2SDK installed path)<br />
2. If not set, run the external program (J2SDK installer)<br />
3. Read the same registry value set by the external program into $R0<br />
4. If not set, abort<br />
5. continue<br />
<br />
I found that the second read does not return me the new value set by the external program. I couldn't find anything that allows me to resync the registry. Did I do something wrong?<br />
<br />
Thanks.<br />
-HB</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Sunjammer</div><div class="date">23rd April 2003, 08:57</div></div><div class="posttext">Hmmm I guess Windows could be caching writes to the registry, in fact the presence of a Windows API called RegFlushKey() makes me believe that even more. I doubt there is a way to sync the entire registry since that would be very costly, I guess you could try using the System plugin to invoke RegFlushKey (and yes it does work on the major branches of the registry, e.g. HKLM or HKCU).<br />
<br />
Microsoft MSDN informationa about RegFlushKey can be found here (http://msdn.microsoft.com/library/default.asp?url=/library/en-us/sysinfo/base/regflushkey.asp).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">23rd April 2003, 13:49</div></div><div class="posttext">I would first check if you have used Exec or ExecWait to execute the other installer. ExecWait will wait for the installer to finish while Exec will continue right on without waiting. If you have used ExecWait make sure it really does wait. Some installers extract a temporary executable and call it and return immediately which makes NSIS think that the program has finished, which is of course not true. If this is the case see this thread (http://forums.winamp.com/showthread.php?s=&amp;threadid=125550&amp;highlight=%2FSMS). If your installer does wait as required use Sunjammer's solution.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">psyke</div><div class="date">1st May 2003, 04:54</div></div><div class="posttext">any more info on this hackingbear? (or anyone else ;))<br />
<br />
was it an exec vs/ execwait issue as kichik indicated, or was a registry flush required?<br />
<br />
i'm just curious since i often write a registry key and then read it later on with no problems (at least i haven't become aware of any errors - lol).<br />
<br />
I have even manipulated a key in an installer, changed the same registry key from another program and then read the updated value into the installer with nor problems without doing a registry flush.<br />
<br />
I'm concerned becaused Sunjammer's approach makes sense to me and appers to be a very safe way to do what I'm doing, but i'd really rather not revise my installer script unless this flushing is really necessary. :P<br />
<br />
Cheers. :D</div></div><hr />


<div class="post"><div class="posttop"><div class="username">faetter</div><div class="date">15th June 2004, 12:22</div></div><div class="posttext">I have kind of the same problem as hackingbear. Although registry values are changed by en external program the NSIS uninstaller still reads the old values.<br />
<br />
Here's what's in my Uninstall section:<br />
1. Call my application with a command line parameter to remove registry entries.<br />
2. My application's files are removed.<br />
3. NSIS removes it's registry entries.<br />
<br />
The removal of reg. entries in step 1 is quite complicated so the easiest way to do it is simply to call my application .<br />
<br />
The funny thing is, that if I make my app show a messagebox and thereby pausing its execution and then check the reg.values in regedit, they have updated correctly. But when my app has exited and the uninstaller is at step 2 the old values magically has returned.<br />
<br />
I have checked and ExecWait correctly waits till my app has exited. I have even made the uninstaller Sleep 10000 msecs (after ExecWait has executed) and that doesn't change anything. I call the Windows API's RegFlushKey() from my app but it does not change a thing...<br />
<br />
This is strange me thinks!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">15th June 2004, 13:34</div></div><div class="posttext">faetter:<br />
The only situation I can imagine is that registry values still remain in HKLM, so if you removed HKCU values, Window substitutes HKLM ones.<br />
<br />
RegFlushKey() - this call may flush current open reg. key or section (HKLM), but do this (I guess, because who knows how MS lazy flusher was done) for current process only and not touches another process ( Java SDK installation). But this is still very strange, good idea is to test installation on few platforms - W2K, XP, W98 (and W95 Gold :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">faetter</div><div class="date">15th June 2004, 14:00</div></div><div class="posttext">The only situation I can imagine is that registry values still remain in HKLM, so if you removed HKCU values, Window substitutes HKLM ones.<br />
The registry entries that my application removes are located in HKEY_CLASSES_ROOT so it is probably not the issue. <br />
<br />
That RegFlushKey() is so badly coded that it only flushes for the current proces sounds so unbelievable that I'm willing to believe you! :rolleyes: <br />
<br />
Arrgh, I must find some other smart way to do it then i guess... Suddently everything gets sooo complicated and silly me who though I could do things the easy way -sigh-.<br />
<br />
Btw. I'm using XP Pro.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">faetter</div><div class="date">15th June 2004, 14:06</div></div><div class="posttext">Hmmm... maybe I could work around it by doing this:<br />
<br />
1. When you click the Uninstall icon in the Start Menu it launches &quot;MyApplication.exe -uninstall&quot;.<br />
2. My application is then launced and removes the registry entries.<br />
3. When done, my app will terminate itself and make the NSIS uninstaller run right after (can this be done??).<br />
<br />
What do you think?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">15th June 2004, 14:29</div></div><div class="posttext">and in some other situations. But you know all file names, so it is easy to add a part of uninstall code to your application and run uninstaller (using WinExec() for example).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">faetter</div><div class="date">15th June 2004, 15:37</div></div><div class="posttext">It will not be a big problem but it is not very nice I know :).<br />
<br />
The problem is that my application must not run while NSIS is uninstalling it. Have you got an idea on how to accomplish that? <br />
<br />
I looked at WinExec() but wont it require that my app is running at the same time as NSIS?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">faetter</div><div class="date">15th June 2004, 16:08</div></div><div class="posttext">I looked at WinExec() but wont it require that my app is running at the same time as NSIS? <br />
No it wont - I'll try WinExec() :D</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>