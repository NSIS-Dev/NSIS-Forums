<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Simple patch to add explicit 32/64-bit registry support, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Simple patch to add explicit 32/64-bit registry support NSIS Discussion" />
	
	<title> Simple patch to add explicit 32/64-bit registry support [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Simple patch to add explicit 32/64-bit registry support</div>
<hr />
<div class="pda"><a href="t-261166.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=261166">Simple patch to add explicit 32/64-bit registry support</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">benmartz</div><div class="date">5th December 2006, 21:47</div></div><div class="posttext">Let me start off by saying that NSIS rocks and I really appreciate everyone who has worked so hard on this software.<br />
<br />
The biggest problem I've run into is my need to install a .NET application on a 64-bit system using this 32-bit installer. I realized that the simplest solution to my problem was to explicitly write into the 64-bit registry space from 32-bit land. This patch provides a very simple way to accomplish this by allowing the user to pass in additional flags to the &quot;REGSAM samDesired&quot; parameter of the Win32 RegXXX functions.<br />
<br />
This is probably not the correct way to do this but my total experience with the NSIS source code is about 1 hour. It definitely does what I need and I hope it helps someone else in a similar situation. If the concept fits the NSIS development model, it would be great if someone else wants to refine this code (maybe make the flags an optional parameter?).<br />
<br />
Anyways, thanks again to the NSIS developers.<br />
<br />
Cheers,<br />
Ben Martz<br />
<br />
<br />
Index: D:/SVN/3.0/installer/nsis-2.22-src/Source/tokens.cpp<br />
===================================================================<br />
--- D:/SVN/3.0/installer/nsis-2.22-src/Source/tokens.cpp	(revision 586)<br />
+++ D:/SVN/3.0/installer/nsis-2.22-src/Source/tokens.cpp	(revision 587)<br />
@@ -69,8 +69,8 @@<br />
 {TOK_DBOPTIMIZE,&quot;SetDatablockOptimize&quot;,1,0,&quot;(off|on)&quot;,TP_ALL},<br />
 {TOK_DELETEINISEC,&quot;DeleteINISec&quot;,2,0,&quot;ini_file section_name&quot;,TP_CODE},<br />
 {TOK_DELETEINISTR,&quot;DeleteINIStr&quot;,3,0,&quot;ini_file section_name entry_name&quot;,TP_CODE},<br />
-{TOK_DELETEREGKEY,&quot;DeleteRegKey&quot;,2,1,&quot;[/ifempty] root_key subkey\n    root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
-{TOK_DELETEREGVALUE,&quot;DeleteRegValue&quot;,3,0,&quot;root_key subkey entry_name\n    root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
+{TOK_DELETEREGKEY,&quot;DeleteRegKey&quot;,3,1,&quot;[/ifempty] root_key subkey rootkeyflags\n    root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
+{TOK_DELETEREGVALUE,&quot;DeleteRegValue&quot;,4,0,&quot;root_key subkey entry_name rootkeyflags\n    root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
 {TOK_DELETE,&quot;Delete&quot;,1,1,&quot;[/REBOOTOK] filespec&quot;,TP_CODE},<br />
 {TOK_DETAILPRINT,&quot;DetailPrint&quot;,1,0,&quot;message&quot;,TP_CODE},<br />
 {TOK_DIRTEXT,&quot;DirText&quot;,0,4,&quot;[directory_page_description] [directory_page_subtext] [browse_button_text] [browse_dlg_text]&quot;,TP_PG},<br />
@@ -82,8 +82,8 @@<br />
 {TOK_ROOTDIRINST,&quot;AllowRootDirInstall&quot;,1,0,&quot;(true|false)&quot;,TP_GLOBAL},<br />
 {TOK_CHECKBITMAP,&quot;CheckBitmap&quot;,1,0,&quot;local_bitmap.bmp&quot;,TP_GLOBAL},<br />
 {TOK_ENABLEWINDOW,&quot;EnableWindow&quot;,2,0,&quot;hwnd (1|0)&quot;,TP_CODE},<br />
-{TOK_ENUMREGKEY,&quot;EnumRegKey&quot;,4,0,&quot;$(user_var: output) rootkey subkey index\n    root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
-{TOK_ENUMREGVAL,&quot;EnumRegValue&quot;,4,0,&quot;$(user_var: output) rootkey subkey index\n    root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
+{TOK_ENUMREGKEY,&quot;EnumRegKey&quot;,5,0,&quot;$(user_var: output) rootkey subkey index rootkeyflags\n    root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
+{TOK_ENUMREGVAL,&quot;EnumRegValue&quot;,5,0,&quot;$(user_var: output) rootkey subkey index rootkeyflags\n    root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
 {TOK_EXCH,&quot;Exch&quot;,0,1,&quot;[$(user_var)] | [stack_item_index]&quot;,TP_CODE},<br />
 {TOK_EXEC,&quot;Exec&quot;,1,0,&quot;command_line&quot;,TP_CODE},<br />
 {TOK_EXECWAIT,&quot;ExecWait&quot;,1,1,&quot;command_line [$(user_var: return value)]&quot;,TP_CODE},<br />
@@ -117,7 +117,7 @@<br />
 {TOK_IFFILEEXISTS,&quot;IfFileExists&quot;,2,1,&quot;filename label_to_goto_if_file_exists [label_to_goto_otherwise]&quot;,TP_CODE},<br />
 {TOK_IFREBOOTFLAG,&quot;IfRebootFlag&quot;,1,1,&quot;jump_if_set [jump_if_not_set]&quot;,TP_CODE},<br />
 {TOK_IFSILENT,&quot;IfSilent&quot;,1,1,&quot;jump_if_silent [jump_if_not_silent]&quot;,TP_CODE},<br />
-{TOK_INSTALLDIRREGKEY,&quot;InstallDirRegKey&quot;,3,0,&quot;root_key subkey entry_name\n    root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD)&quot;,TP_GLOBAL},<br />
+{TOK_INSTALLDIRREGKEY,&quot;InstallDirRegKey&quot;,4,0,&quot;root_key subkey entry_name rootkeyflags\n    root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD)&quot;,TP_GLOBAL},<br />
 {TOK_INSTCOLORS,&quot;InstallColors&quot;,1,1,&quot;(/windows | (foreground_color background_color))&quot;,TP_GLOBAL},<br />
 {TOK_INSTDIR,&quot;InstallDir&quot;,1,0,&quot;default_install_directory&quot;,TP_GLOBAL},<br />
 {TOK_INSTPROGRESSFLAGS,&quot;InstProgressFlags&quot;,0,-1,&quot;[flag [...]]\n    flag={smooth|colored}&quot;,TP_GLOBAL},<br />
@@ -155,8 +155,8 @@<br />
 {TOK_PUSH,&quot;Push&quot;,1,0,&quot;string&quot;,TP_CODE},<br />
 {TOK_QUIT,&quot;Quit&quot;,0,0,&quot;&quot;,TP_CODE},<br />
 {TOK_READINISTR,&quot;ReadINIStr&quot;,4,0,&quot;$(user_var: output) ini_file section entry_name&quot;,TP_CODE},<br />
-{TOK_READREGDWORD,&quot;ReadRegDWORD&quot;,4,0,&quot;$(user_var: output) rootkey subkey entry\n   root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
-{TOK_READREGSTR,&quot;ReadRegStr&quot;,4,0,&quot;$(user_var: output) rootkey subkey entry\n   root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
+{TOK_READREGDWORD,&quot;ReadRegDWORD&quot;,5,0,&quot;$(user_var: output) rootkey subkey entry rootkeyflags\n   root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
+{TOK_READREGSTR,&quot;ReadRegStr&quot;,5,0,&quot;$(user_var: output) rootkey subkey entry rootkeyflags\n   root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
 {TOK_READENVSTR,&quot;ReadEnvStr&quot;,2,0,&quot;$(user_var: output) name&quot;,TP_CODE},<br />
 {TOK_REBOOT,&quot;Reboot&quot;,0,0,&quot;&quot;,TP_CODE},<br />
 {TOK_REGDLL,&quot;RegDLL&quot;,1,1,&quot;dll_path_on_target.dll [entrypoint_symbol]&quot;,TP_CODE},<br />
@@ -229,10 +229,10 @@<br />
 {TOK_UNREGDLL,&quot;UnRegDLL&quot;,1,0,&quot;dll_path_on_target.dll&quot;,TP_CODE},<br />
 {TOK_WINDOWICON,&quot;WindowIcon&quot;,1,0,&quot;on|off&quot;,TP_GLOBAL},<br />
 {TOK_WRITEINISTR,&quot;WriteINIStr&quot;,4,0,&quot;ini_file section_name entry_name new_value&quot;,TP_CODE},<br />
-{TOK_WRITEREGBIN,&quot;WriteRegBin&quot;,4,0,&quot;rootkey subkey entry_name hex_string_like_12848412AB\n    root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
-{TOK_WRITEREGDWORD,&quot;WriteRegDWORD&quot;,4,0,&quot;rootkey subkey entry_name new_value_dword\n    root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
-{TOK_WRITEREGSTR,&quot;WriteRegStr&quot;,4,0,&quot;rootkey subkey entry_name new_value_string\n    root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
-{TOK_WRITEREGEXPANDSTR,&quot;WriteRegExpandStr&quot;,4,0,&quot;rootkey subkey entry_name new_value_string\n    root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
+{TOK_WRITEREGBIN,&quot;WriteRegBin&quot;,5,0,&quot;rootkey subkey entry_name hex_string_like_12848412AB rootkeyflags\n    root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
+{TOK_WRITEREGDWORD,&quot;WriteRegDWORD&quot;,5,0,&quot;rootkey subkey entry_name new_value_dword rootkeyflags\n    root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
+{TOK_WRITEREGSTR,&quot;WriteRegStr&quot;,5,0,&quot;rootkey subkey entry_name new_value_string rootkeyflags\n    root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
+{TOK_WRITEREGEXPANDSTR,&quot;WriteRegExpandStr&quot;,5,0,&quot;rootkey subkey entry_name new_value_string rootkeyflags\n    root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD|SHCTX)&quot;,TP_CODE},<br />
 {TOK_WRITEUNINSTALLER,&quot;WriteUninstaller&quot;,1,0,&quot;uninstall_exe_name&quot;,TP_CODE},<br />
 {TOK_XPSTYLE, &quot;XPStyle&quot;,1,0,&quot;(on|off)&quot;,TP_GLOBAL},<br />
 {TOK_REQEXECLEVEL, &quot;RequestExecutionLevel&quot;,1,0,&quot;none|user|highest|admin&quot;,TP_GLOBAL},<br />
Index: D:/SVN/3.0/installer/nsis-2.22-src/Source/script.cpp<br />
===================================================================<br />
--- D:/SVN/3.0/installer/nsis-2.22-src/Source/script.cpp	(revision 586)<br />
+++ D:/SVN/3.0/installer/nsis-2.22-src/Source/script.cpp	(revision 587)<br />
@@ -5005,7 +5005,7 @@<br />
         int k=line.gettoken_enum(2,rootkeys[0]);<br />
         if (k == -1) k=line.gettoken_enum(2,rootkeys[1]);<br />
         if (ent.offsets[0] == -1 || k == -1) PRINTHELP()<br />
-        ent.offsets[1]=(int)rootkey_tab[k];<br />
+        ent.offsets[1]=(int)rootkey_tab[k] | line.gettoken_int(5);	// benmartz: add support for root key flags<br />
         ent.offsets[2]=add_string(line.gettoken_str(3));<br />
         ent.offsets[3]=add_string(line.gettoken_str(4));<br />
         if (which_token == TOK_READREGDWORD) ent.offsets[4]=1;<br />
@@ -5013,8 +5013,8 @@<br />
         if (line.gettoken_str(3)[0] == '\\')<br />
           warning_fl(&quot;%s: registry path name begins with \'\\\', may cause problems&quot;,line.gettoken_str(0));<br />
 <br />
-        SCRIPT_MSG(&quot;%s %s %s\\%s\\%s\n&quot;,line.gettoken_str(0),<br />
-          line.gettoken_str(1),line.gettoken_str(2),line.gettoken_str(3),line.gettoken_str(4));<br />
+        SCRIPT_MSG(&quot;%s: %s\\%s\\%s\\%s flags=0x%08x\n&quot;,line.gettoken_str(0),<br />
+          line.gettoken_str(1),line.gettoken_str(2),line.gettoken_str(3),line.gettoken_str(4),line.gettoken_int(5));<br />
       }<br />
     return add_entry(&amp;ent);<br />
     case TOK_DELETEREGVALUE:<br />
@@ -5031,21 +5031,21 @@<br />
             a++;<br />
             ent.offsets[4]=3;<br />
           }<br />
-          if (line.gettoken_str(a+2)[0]) PRINTHELP()<br />
+          if (line.gettoken_str(a+3)[0]) PRINTHELP()<br />
         }<br />
         int k=line.gettoken_enum(a,rootkeys[0]);<br />
         if (k == -1) k=line.gettoken_enum(a,rootkeys[1]);<br />
         if (k == -1) PRINTHELP()<br />
         ent.which=EW_DELREG;<br />
-        ent.offsets[1]=(int)rootkey_tab[k];<br />
+        ent.offsets[1]=(int)rootkey_tab[k] | line.gettoken_int(a+3);	// benmartz: add support for root key flags<br />
         ent.offsets[2]=add_string(line.gettoken_str(a+1));<br />
         ent.offsets[3]=(which_token==TOK_DELETEREGKEY)?0:add_string(line.gettoken_str(a+2));<br />
         if (line.gettoken_str(a+1)[0] == '\\')<br />
           warning_fl(&quot;%s: registry path name begins with \'\\\', may cause problems&quot;,line.gettoken_str(0));<br />
         if (which_token==TOK_DELETEREGKEY)<br />
-          SCRIPT_MSG(&quot;DeleteRegKey: %s\\%s\n&quot;,line.gettoken_str(a),line.gettoken_str(a+1));<br />
+          SCRIPT_MSG(&quot;DeleteRegKey: %s\\%s flags=0x%08x\n&quot;,line.gettoken_str(a),line.gettoken_str(a+1),line.gettoken_int(a+2));<br />
         else<br />
-          SCRIPT_MSG(&quot;DeleteRegValue: %s\\%s\\%s\n&quot;,line.gettoken_str(a),line.gettoken_str(a+1),line.gettoken_str(a+2));<br />
+          SCRIPT_MSG(&quot;DeleteRegValue: %s\\%s\\%s flags=0x%08x\n&quot;,line.gettoken_str(a),line.gettoken_str(a+1),line.gettoken_str(a+2),line.gettoken_int(a+3));<br />
       }<br />
     return add_entry(&amp;ent);<br />
     case TOK_WRITEREGSTR:<br />
@@ -5057,15 +5057,15 @@<br />
         if (k == -1) k=line.gettoken_enum(1,rootkeys[1]);<br />
         if (k == -1) PRINTHELP()<br />
         ent.which=EW_WRITEREG;<br />
-        ent.offsets[0]=(int)rootkey_tab[k];<br />
+        ent.offsets[0]=(int)rootkey_tab[k] | line.gettoken_int(5);	// benmartz: add support for root key flags<br />
         ent.offsets[1]=add_string(line.gettoken_str(2));<br />
         if (line.gettoken_str(2)[0] == '\\')<br />
           warning_fl(&quot;%s: registry path name begins with \'\\\', may cause problems&quot;,line.gettoken_str(0));<br />
         ent.offsets[2]=add_string(line.gettoken_str(3));<br />
         if (which_token == TOK_WRITEREGSTR || which_token == TOK_WRITEREGEXPANDSTR)<br />
         {<br />
-          SCRIPT_MSG(&quot;%s: %s\\%s\\%s=%s\n&quot;,<br />
-            line.gettoken_str(0),line.gettoken_str(1),line.gettoken_str(2),line.gettoken_str(3),line.gettoken_str(4));<br />
+          SCRIPT_MSG(&quot;%s: %s\\%s\\%s=%s flags=0x%08x\n&quot;,<br />
+            line.gettoken_str(0),line.gettoken_str(1),line.gettoken_str(2),line.gettoken_str(3),line.gettoken_str(4),line.gettoken_int(5));<br />
           ent.offsets[3]=add_string(line.gettoken_str(4));<br />
           ent.offsets[4]=ent.offsets[5]=REG_SZ;<br />
           if (which_token == TOK_WRITEREGEXPANDSTR)<br />
@@ -5102,8 +5102,8 @@<br />
             data[data_len++]=c;<br />
           }<br />
           if (*p) PRINTHELP()<br />
-          SCRIPT_MSG(&quot;WriteRegBin: %s\\%s\\%s=%s\n&quot;,<br />
-            line.gettoken_str(1),line.gettoken_str(2),line.gettoken_str(3),line.gettoken_str(4));<br />
+          SCRIPT_MSG(&quot;WriteRegBin: %s\\%s\\%s=%s flags=%08x\n&quot;,<br />
+            line.gettoken_str(1),line.gettoken_str(2),line.gettoken_str(3),line.gettoken_str(4),line.gettoken_int(5));<br />
           ent.offsets[3]=add_db_data(data,data_len);<br />
           if (ent.offsets[3] &lt; 0) return PS_ERROR;<br />
           ent.offsets[4]=ent.offsets[5]=REG_BINARY;<br />
@@ -5113,8 +5113,8 @@<br />
           ent.offsets[3]=add_string(line.gettoken_str(4));<br />
           ent.offsets[4]=ent.offsets[5]=REG_DWORD;<br />
 <br />
-          SCRIPT_MSG(&quot;WriteRegDWORD: %s\\%s\\%s=%s\n&quot;,<br />
-            line.gettoken_str(1),line.gettoken_str(2),line.gettoken_str(3),line.gettoken_str(4));<br />
+          SCRIPT_MSG(&quot;WriteRegDWORD: %s\\%s\\%s=%s flags=%08x\n&quot;,<br />
+            line.gettoken_str(1),line.gettoken_str(2),line.gettoken_str(3),line.gettoken_str(4),line.gettoken_int(5));<br />
         }<br />
       }<br />
     return add_entry(&amp;ent);<br />
@@ -5126,13 +5126,13 @@<br />
         int k=line.gettoken_enum(2,rootkeys[0]);<br />
         if (k == -1) k=line.gettoken_enum(2,rootkeys[1]);<br />
         if (ent.offsets[0] == -1 || k == -1) PRINTHELP()<br />
-        ent.offsets[1]=(int)rootkey_tab[k];<br />
+        ent.offsets[1]=(int)rootkey_tab[k] | line.gettoken_int(5);	// benmartz: add support for root key flags<br />
         ent.offsets[2]=add_string(line.gettoken_str(3));<br />
         ent.offsets[3]=add_string(line.gettoken_str(4));<br />
         ent.offsets[4]=which_token == TOK_ENUMREGKEY;<br />
         if (line.gettoken_str(3)[0] == '\\') warning_fl(&quot;%s: registry path name begins with \'\\\', may cause problems&quot;,line.gettoken_str(0));<br />
-        SCRIPT_MSG(&quot;%s %s %s\\%s\\%s\n&quot;,which_token == TOK_ENUMREGKEY ? &quot;EnumRegKey&quot; : &quot;EnumRegValue&quot;,<br />
-          line.gettoken_str(1),line.gettoken_str(2),line.gettoken_str(3),line.gettoken_str(4));<br />
+        SCRIPT_MSG(&quot;%s %s %s\\%s\\%s flags=%08x\n&quot;,which_token == TOK_ENUMREGKEY ? &quot;EnumRegKey&quot; : &quot;EnumRegValue&quot;,<br />
+          line.gettoken_str(1),line.gettoken_str(2),line.gettoken_str(3),line.gettoken_str(4),line.gettoken_int(5));<br />
       }<br />
     return add_entry(&amp;ent);<br />
 #else//!NSIS_SUPPORT_REGISTRYFUNCTIONS<br />
Index: D:/SVN/3.0/installer/nsis-2.22-src/Source/exehead/exec.c<br />
===================================================================<br />
--- D:/SVN/3.0/installer/nsis-2.22-src/Source/exehead/exec.c	(revision 586)<br />
+++ D:/SVN/3.0/installer/nsis-2.22-src/Source/exehead/exec.c	(revision 587)<br />
@@ -131,7 +131,7 @@<br />
 static LONG NSISCALL myRegDeleteKeyEx(HKEY thiskey, LPCTSTR lpSubKey, int onlyifempty)<br />
 {<br />
   HKEY key;<br />
-  int retval=RegOpenKeyEx(thiskey,lpSubKey,0,KEY_ENUMERATE_SUB_KEYS,&amp;key);<br />
+  int retval=RegOpenKeyEx((HKEY)(((int)thiskey) &amp; ~0x300),lpSubKey,0,KEY_ENUMERATE_SUB_KEYS | ((int)thiskey &amp; 0x300),&amp;key);<br />
   if (retval==ERROR_SUCCESS)<br />
   {<br />
     // NB - don't change this to static (recursive function)<br />
@@ -163,7 +163,7 @@<br />
 static HKEY NSISCALL myRegOpenKey(REGSAM samDesired)<br />
 {<br />
   HKEY hKey;<br />
-  if (RegOpenKeyEx(GetRegRootKey(parms[1]), GetStringFromParm(0x22), 0, samDesired, &amp;hKey) == ERROR_SUCCESS)<br />
+  if (RegOpenKeyEx(GetRegRootKey(parms[1] &amp; ~0x300), GetStringFromParm(0x22), 0, samDesired | (parms[1] &amp; 0x300), &amp;hKey) == ERROR_SUCCESS)<br />
   {<br />
     return hKey;<br />
   }<br />
@@ -1187,7 +1187,7 @@<br />
         const char *rkn=RegKeyHandleToName(rootkey);<br />
 <br />
         exec_error++;<br />
-        if (RegCreateKeyEx(rootkey,buf1,0,0,REG_OPTION_NON_VOLATILE,KEY_SET_VALUE,0,&amp;hKey,0) == ERROR_SUCCESS)<br />
+        if (RegCreateKeyEx((HKEY)(((int)parm0) &amp; ~0x300),buf1,0,0,REG_OPTION_NON_VOLATILE,KEY_SET_VALUE | ((int)parm0 &amp; 0x300),0,&amp;hKey,0) == ERROR_SUCCESS)<br />
         {<br />
           LPBYTE data = (LPBYTE) buf2;<br />
           DWORD size = 0;<br />
Index: D:/SVN/3.0/installer/nsis-2.22-src/JPR README.txt<br />
===================================================================<br />
--- D:/SVN/3.0/installer/nsis-2.22-src/JPR README.txt	(revision 0)<br />
+++ D:/SVN/3.0/installer/nsis-2.22-src/JPR README.txt	(revision 587)<br />
@@ -0,0 +1,16 @@<br />
+1. Install Python and SCONS as specified.<br />
+2. Open your VS2005 command line and run<br />
+	scons TEMP_MSVC2005=yes PREFIX=&quot;C:\Program Files\NSIS&quot; install<br />
+<br />
+That's it! All RegXXX commands now have an additional parameter where we can pass<br />
+${KEY_WOW64_64KEY} or ${KEY_WOW64_32KEY} as needed.<br />
+<br />
+You may need the following defines if not including CDMS_Common.nsh:<br />
+<br />
+!define KEY_WOW64_64KEY          0x0100    ; always access 64-bit key<br />
+!define KEY_WOW64_32KEY          0x0200    ; always access 32-bit key<br />
+<br />
+<br />
+Have fun!<br />
+Ben Martz<br />
+4 December 2006</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">23rd December 2006, 16:22</div></div><div class="posttext">Nice patch, thanks. Please submit it to the patch tracker (http://sourceforge.net/tracker/?group_id=22049&amp;atid=373087) so it doesn't get lost in the forum mist.<br />
<br />
You've got the changes right. Though there are a few optimizations that can be done. For example, the entire SAM can be passed as a parameter so the compiler can do all the work. I'd also have it as a switch instead of an arbitrary integer passed as the last parameter. Maybe /WOW64...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">23rd December 2006, 18:28</div></div><div class="posttext">Very good that InstallDirRegKey included to &quot;registry reflection patch&quot;, but what about system.nsh (and other nsh) ReadRegStr, first of all - langDll defines? Both variants (rootkeyflags parameter and /wow option) require many macro to be re-worked. What about installer (changable) option (like SetDetailsView)?<br />
Edited BTW how reflection works if RegConnectRegistry() used with NULL or local host name?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">benmartz</div><div class="date">4th January 2007, 00:16</div></div><div class="posttext">Kichik,<br />
<br />
I agree that it could definitely use some improvement. In the meanwhile, I've posted it to the patch tracker as you requested. I'm hoping that someone might be willing to take up the torch, otherwise it may be a while before I can get to it.<br />
<br />
Cheers,<br />
Ben<br />
<br />
P.S. Something that most users might not know is that if you pass in KEY_WOW64_64KEY when running 32-bit on 32-bit, the bit is ignored so the same Read/WriteReg call in your NSIS script will work &quot;correctly&quot; on 32-bit and 64-bit host platforms. For example, the following line will always read from the native registry:<br />
<br />
  ReadRegStr $2 HKLM &quot;SOFTWARE\Crystal Decisions\10.2\Crystal Reports&quot; &quot;CommonFiles&quot; ${KEY_WOW64_64KEY}</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>