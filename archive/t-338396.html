<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" [Solution] Getting file size at compile time, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  [Solution] Getting file size at compile time NSIS Discussion" />
	
	<title> [Solution] Getting file size at compile time [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  [Solution] Getting file size at compile time</div>
<hr />
<div class="pda"><a href="t-338396.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=338396">[Solution] Getting file size at compile time</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">stopasking</div><div class="date">28th November 2011, 16:13</div></div><div class="posttext">Hi guys.<br />
<br />
I managed to solve my previous issue (http://forums.winamp.com/showthread.php?t=338354), here's the code I came up with to get a size of file at compile time:<br />
<br />
!macro CTFileSize _FILE _RESULT<br />
<br />
!echo 'CTFileSize: &quot;${_FILE}&quot;'<br />
<br />
!verbose push<br />
!verbose 3<br />
<br />
!tempfile __TEMP_BAT_FILE<br />
!delfile &quot;${__TEMP_BAT_FILE}&quot;<br />
!tempfile __TEMP_NSH_FILE<br />
!delfile &quot;${__TEMP_NSH_FILE}&quot;<br />
<br />
!system 'cmd /C ECHO @ECHO Push %~z1 &gt; &quot;${__TEMP_BAT_FILE}.bat&quot;'<br />
!system '&quot;${__TEMP_BAT_FILE}.bat&quot; &quot;${_FILE}&quot; &gt; &quot;${__TEMP_NSH_FILE}.nsh&quot;'<br />
!include &quot;${__TEMP_NSH_FILE}.nsh&quot;<br />
<br />
!delfile &quot;${__TEMP_BAT_FILE}.bat&quot;<br />
!undef __TEMP_BAT_FILE<br />
!delfile &quot;${__TEMP_NSH_FILE}.nsh&quot;<br />
!undef __TEMP_NSH_FILE<br />
<br />
Pop ${_RESULT}<br />
<br />
!verbose pop<br />
<br />
!macroend<br />
<br />
Usage:<br />
<br />
!insertmacro CTFileSize &quot;C:\Windows\notepad.exe&quot; $R0<br />
MessageBox MB_OK &quot;Size of notepad: $R0 bytes&quot;<br />
<br />
Perhaps somebody else will find it useful.<br />
<br />
P.S. I use this code to calculate the size of a section for several install modes, and change it at runtime, using the SectionSetSize function.<br />
The docs say:<br />
&quot;The Value for Size must be entered in KiloByte and supports only whole numbers.&quot;<br />
Only whole KBs? Why the heck is that? o_0</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">28th November 2011, 17:06</div></div><div class="posttext">Whole KBs is probably to allow larger sizes within a 32 bits variable.<br />
<br />
Next time, please post the solution in the thread where you asked the question.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">28th November 2011, 17:19</div></div><div class="posttext">Why post a new thread?<br />
<br />
My take on this:<br />
!macro GetFileSize define file<br />
!tempfile __GetFileSize<br />
!execute 'cmd /E:ON /V:OFF /C if 1==1 for %A in (&quot;${file}&quot;) do echo !define ${define} &quot;%~zA&quot; &gt; &quot;${__GetFileSize}&quot;'<br />
!include &quot;${__GetFileSize}&quot;<br />
!delfile &quot;${__GetFileSize}&quot;<br />
!undef __GetFileSize<br />
!macroend<br />
<br />
!insertmacro GetFileSize thesize &quot;$%windir%\explorer.exe&quot;<br />
!echo thesize=${thesize}<br />
<br />
Edit: Added missing !undef</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stopasking</div><div class="date">28th November 2011, 18:12</div></div><div class="posttext">Next time, please post the solution in the thread where you asked the question.<br />
OK, sorry, I just thought that it would be easier for others to find it that way. (SEO, page title, etc.)<br />
Also, maybe it's worth to add this to the wiki?<br />
<br />
Whole KBs is probably to allow larger sizes within a 32 bits variable.<br />
More than 4 GB for an installer?<br />
I don't think so (I bet it won't work anyway).<br />
If you know another way of e.g. setting a section size in bytes and not in KBs, tell me. It's not a must but it looks nicer. After all, NSIS does that by default.<br />
<br />
My take on this<br />
Wow, nice! :)<br />
I'm not too good at working with cmd, so I would never come up with this.<br />
A couple of corrections, though:<br />
* A &quot;/Q&quot; parameter for cmd to turn off echo.<br />
* What is the &quot;if 1==1&quot; for? I guess nothing.<br />
* You forgot to undef __GetFileSize.<br />
<br />
Also, it's more convenient for me to get the size to a variable, and not to a define, so here's my version:<br />
!macro CTFileSize _FILE _RESULT<br />
!tempfile __TEMP_NSH_FILE<br />
!execute 'cmd /Q /E:ON /V:OFF /C for %A in (&quot;${_FILE}&quot;) do echo StrCpy ${_RESULT} %~zA &gt; &quot;${__TEMP_NSH_FILE}&quot;'<br />
!include &quot;${__TEMP_NSH_FILE}&quot;<br />
!delfile &quot;${__TEMP_NSH_FILE}&quot;<br />
!undef __TEMP_NSH_FILE<br />
!macroend<br />
<br />
Usage is the same as in the first post:<br />
!insertmacro CTFileSize &quot;C:\Windows\notepad.exe&quot; $R0<br />
MessageBox MB_OK &quot;Size of notepad: $R0 bytes&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">28th November 2011, 18:16</div></div><div class="posttext">IF 1==1 does &quot;nothing&quot; yes, but it fixes bugs in cmd.exe</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stopasking</div><div class="date">28th November 2011, 18:32</div></div><div class="posttext">That's interesting, what bugs does it fix?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">28th November 2011, 18:57</div></div><div class="posttext">More than 4 GB for an installer?<br />
I don't think so (I bet it won't work anyway).<br />
I have one. CopyFiles and AddSize are your friends.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stopthemess</div><div class="date">14th December 2012, 14:49</div></div><div class="posttext">I need to get a size of a folder at compile time.<br />
I came up with the following batch script:<br />
@ECHO OFF<br />
SET sum=0<br />
FOR /R %1 %%A IN (*) DO ( SET /A sum+=%%~zA )<br />
echo %sum%<br />
<br />
It works.<br />
Now I want to use it as a command line parameter of cmd.<br />
I tried the following:<br />
cmd /Q /E:ON /V:OFF /K SET sum=0 &amp; FOR /R &quot;%userprofile%\Desktop\&quot; %A IN (*) DO ( SET /A sum+=%~zA ) &amp; ECHO %sum%<br />
but it doesn't work as expected.<br />
<br />
Help me please.<br />
<br />
--EDIT--<br />
<br />
That's what I came up with:<br />
!macro CTFolderSize _FOLDER _RESULT<br />
	!tempfile __TEMP_NSH_FILE<br />
	!execute 'cmd /Q /E:ON /V:OFF /C (SET sum=0) &amp; (FOR /R &quot;${_FOLDER}&quot; %A IN (*) DO SET /A &quot;sum+=%~zA&quot; &gt; NUL ) &amp; ( CALL ECHO StrCpy ${_RESULT} %sum% &gt; &quot;${__TEMP_NSH_FILE}&quot; )'<br />
	!include &quot;${__TEMP_NSH_FILE}&quot;<br />
	!delfile &quot;${__TEMP_NSH_FILE}&quot;<br />
	!undef __TEMP_NSH_FILE<br />
!macroend<br />
<br />
I'm not sure how good is the solution, but it seems to work.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>