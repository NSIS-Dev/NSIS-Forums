<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Rename /REBOOTOK Questions, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Rename /REBOOTOK Questions NSIS Discussion" />
	
	<title> Rename /REBOOTOK Questions [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Rename /REBOOTOK Questions</div>
<hr />
<div class="pda"><a href="t-148045.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=148045">Rename /REBOOTOK Questions</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">JaffaDog</div><div class="date">3rd September 2003, 22:51</div></div><div class="posttext">Hello All,<br />
<br />
1. How does this achieve it's &quot;rebootok&quot; magic?  I've checked the runonce keys and it does not appear to be loading anything there.  Where is it scheduling anything to happen on reboot?<br />
<br />
2. When I use Rename /rebootok and the target file exists, it will always choose to schedule this for reboot.  Even if the target file is not locked.  I can precede the rename with a delete, but this seems unnecessary.  <br />
<br />
TIA,<br />
Jeremy</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RDaneel</div><div class="date">4th September 2003, 03:37</div></div><div class="posttext">Check out the SDK docs on MoveFile and MoveFileEx.<br />
<br />
Basically, NSIS will try a MoveFile, which  *always* fails if the dst exists.  Then it trys a MoveFileEx, which *can* work if the dst is present, but only asks for the rename to be scheduled at reboot time... if MoveFileEx isn't present (it showed up in NT4), then an entry is made in &quot;wininit.ini&quot; to handle things.<br />
<br />
I have tried (in vain) to get KiCHiK to adjust this logic so that MoveFileEx is the preferred API, only falling back to the older stuff in case of failure, but it hasn't worked. :(<br />
<br />
I even tried to imply that I would make the changes myself (well, I *would*) and hand them over. :)<br />
<br />
I think he prefers the model of use the oldest APIs if possible, rather than to model things after the newer APIs and fall back to old stuff as required... and since he &quot;owns&quot; this area of the code, that's the way it is (for now).<br />
<br />
OTOH, his judgement is usually good, and he does work cheap... :D</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">4th September 2003, 12:42</div></div><div class="posttext">So I'm a sweatshop worker now? :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JaffaDog</div><div class="date">4th September 2003, 19:34</div></div><div class="posttext">Thanks.  The Win SDK spells this out nicely (http://msdn.microsoft.com/library/default.asp?url=/library/en-us/fileio/base/movefileex.asp).  I'm using NSIS to put together a patcher, replacing files which may be in use (some are locked by the explorer.exe shell).  I'll share the macro I've put together (so far):<br />
<br />
!macro UpdateFile FILENAME DESTPATH<br />
<br />
  DetailPrint &quot;&quot;<br />
<br />
  ; Add this file to the install package<br />
  File &quot;files\${FILENAME}&quot;<br />
<br />
  ; Check if this file is present on the target PC<br />
  IfFileExists &quot;${DESTPATH}\${FILENAME}&quot; &quot;check_${DESTPATH}\${FILENAME}&quot;<br />
<br />
  DetailPrint &quot;File does not exist ${DESTPATH}\${FILENAME}&quot;<br />
  Goto &quot;update_${DESTPATH}\${FILENAME}&quot;<br />
<br />
&quot;check_${DESTPATH}\${FILENAME}:&quot;<br />
  ; If the file is found on the target PC, check its date to determine if it is the same as the file in the install package<br />
  DetailPrint &quot;Checking version of ${DESTPATH}\${FILENAME}&quot;<br />
<br />
  ; Get date of update file from install package (SetOutPath $TEMP)<br />
  GetFileTime &quot;$TEMP\${FILENAME}&quot; $R0 $R1<br />
  StrCpy $0 &quot;$R0.$R1&quot;<br />
<br />
  ; Get date of existing file on target PC<br />
  GetFileTime &quot;${DESTPATH}\${FILENAME}&quot; $R0 $R1<br />
  StrCpy $1 &quot;$R0.$R1&quot;<br />
<br />
  DetailPrint &quot;Comparing dates &lt;$0&gt; &lt;$1&gt;&quot;<br />
  StrCmp $0 $1 0 &quot;update_${DESTPATH}\${FILENAME}&quot;<br />
<br />
  DetailPrint &quot;This file is up to date - No update needed&quot;<br />
  goto &quot;done_${DESTPATH}\${FILENAME}&quot;<br />
<br />
&quot;update_${DESTPATH}\${FILENAME}:&quot;<br />
  ; Update the file; delete the old version and replace it with the new version<br />
  DetailPrint &quot;Updating this file&quot;<br />
  Delete &quot;${DESTPATH}\${FILENAME}&quot;<br />
  Rename /REBOOTOK &quot;$TEMP\${FILENAME}&quot; &quot;${DESTPATH}\${FILENAME}&quot;<br />
<br />
&quot;done_${DESTPATH}\${FILENAME}:&quot;<br />
<br />
!macroend</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>