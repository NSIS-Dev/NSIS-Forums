<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Help with Dll function usage, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Help with Dll function usage NSIS Discussion" />
	
	<title> Help with Dll function usage [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Help with Dll function usage</div>
<hr />
<div class="pda"><a href="t-246815.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=246815">Help with Dll function usage</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">smoura</div><div class="date">23rd May 2006, 10:21</div></div><div class="posttext">Hi,<br />
<br />
I've been trying NSIS for a couple of days now.<br />
<br />
I'm creating a serial validation page with 4 fields 5 chars each. I've read the forums, the read-me's for InstallOptions and System, and some examples in the WiKi, and still cant put this to work!<br />
<br />
I'd thank any help at this.<br />
<br />
Here are my two functions, along with the initialization code.<br />
<br />
<br />
!define Key1 $R1 	; Serial Part 1<br />
!define Key2 $R2 	; Serial Part 2<br />
!define Key3 $R3 	; Serial Part 3<br />
!define Key4 $R4 	; Serial Part 4<br />
<br />
; Things that need to be extracted on startup (keep these lines before ; any File command!)<br />
; Use ReserveFile for your own InstallOptions INI files too!<br />
ReserveFile &quot;wndSerial.ini&quot;<br />
ReserveFile &quot;files\other\ValidateSN.dll&quot;<br />
ReserveFile &quot;${NSISDIR}\Plugins\InstallOptions.dll&quot;<br />
<br />
Function SetCustom<br />
  ;Display the InstallOptions dialog<br />
  Push ${Key1}<br />
  Push ${Key2}<br />
  Push ${Key3}<br />
  Push ${Key4}<br />
  Push $R0<br />
  InstallOptions::dialog &quot;$PLUGINSDIR\wndSerial.ini&quot;<br />
  Pop $R0<br />
  Pop ${Key4}<br />
  Pop ${Key3}<br />
  Pop ${Key2}<br />
  Pop ${Key1}<br />
FunctionEnd<br />
<br />
Function ValidateCustom<br />
  FlushINI &quot;$PLUGINSDIR\wndSerial.ini&quot;<br />
<br />
  ; Serial number inits<br />
  !insertmacro MUI_INSTALLOPTIONS_READ ${Key1} &quot;$PLUGINSDIR\wndSerial.ini&quot; &quot;Field 2&quot; &quot;State&quot;<br />
  !insertmacro MUI_INSTALLOPTIONS_READ ${Key2} &quot;$PLUGINSDIR\wndSerial.ini&quot; &quot;Field 3&quot; &quot;State&quot;<br />
  !insertmacro MUI_INSTALLOPTIONS_READ ${Key3} &quot;$PLUGINSDIR\wndSerial.ini&quot; &quot;Field 4&quot; &quot;State&quot;<br />
  !insertmacro MUI_INSTALLOPTIONS_READ ${Key4} &quot;$PLUGINSDIR\wndSerial.ini&quot; &quot;Field 5&quot; &quot;State&quot;<br />
<br />
  SetPluginUnload  alwaysoff<br />
	<br />
  ; Call the function to validate the netmamma serial number<br />
  System::Call &quot;user32::MessageBox(i $HWNDPARENT, t .r1, t 'Test', i 0)&quot;<br />
	<br />
  System::Call &quot;$PLUGINSDIR\ValidateSN.dll::ValidateSN (t,t,t,t)i (.${Key1},.${Key2},.${Key3},.${Key4}).r0&quot;<br />
		<br />
  ; --- get output<br />
  Pop $0<br />
  StrCmp $0 &quot;1&quot; serial_ok serial_wrong<br />
<br />
serial_ok:<br />
  MessageBox MB_OK &quot;OK-OK-OK-OK&quot;<br />
  Goto done<br />
<br />
serial_wrong:<br />
  MessageBox MB_OK &quot;$0&quot;<br />
  Abort<br />
<br />
done:<br />
  ; Continue installation<br />
  MessageBox MB_OK &quot;$0&quot;<br />
<br />
FunctionEnd<br />
<br />
<br />
<br />
Can anyone help out with this, any help will be greatly appreciated! :( <br />
<br />
Thanks in advance,<br />
smoura</div></div><hr />


<div class="post"><div class="posttop"><div class="username">smoura</div><div class="date">23rd May 2006, 10:31</div></div><div class="posttext">The thing is that I'm not being able to get the values typed in the wndSerial.ini page back to the variables... :P</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">23rd May 2006, 12:06</div></div><div class="posttext">From a quick look on your script:<br />
you use defines to get values, this is not correct.<br />
You must use variables to get the values from INI fields.<br />
e.g.<br />
change this:<br />
  !insertmacro MUI_INSTALLOPTIONS_READ ${Key1} &quot;$PLUGINSDIRwndSerial.ini&quot; &quot;Field 2&quot; &quot;State&quot; <br />
to this:<br />
  !insertmacro MUI_INSTALLOPTIONS_READ $R0 &quot;$PLUGINSDIRwndSerial.ini&quot; &quot;Field 2&quot; &quot;State&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">smoura</div><div class="date">23rd May 2006, 13:53</div></div><div class="posttext">Thanks for the fast reply ;)<br />
<br />
I've replaced Has you've said the 4 instructions on my code, though it continues not to extract the data from the fields.<br />
<br />
Here's the changes I've made to the above source:<br />
<br />
<br />
<br />
; Serial number inits<br />
!insertmacro MUI_INSTALLOPTIONS_READ $R1 &quot;$PLUGINSDIR\wndSerial.ini&quot; &quot;Field 2&quot; &quot;State&quot;<br />
!insertmacro MUI_INSTALLOPTIONS_READ $R2 &quot;$PLUGINSDIR\wndSerial.ini&quot; &quot;Field 3&quot; &quot;State&quot;<br />
!insertmacro MUI_INSTALLOPTIONS_READ $R3 &quot;$PLUGINSDIR\wndSerial.ini&quot; &quot;Field 4&quot; &quot;State&quot;<br />
!insertmacro MUI_INSTALLOPTIONS_READ $R4 &quot;$PLUGINSDIR\wndSerial.ini&quot; &quot;Field 5&quot; &quot;State&quot;<br />
	<br />
; Call the function to validate the serial number<br />
MessageBox MB_OK &quot;$R1&quot;<br />
<br />
<br />
I suppose that this message box should prompt the first field in the Serial number dialog. At least this is what I'm trying to do :P</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">23rd May 2006, 13:57</div></div><div class="posttext">replace this:<br />
!insertmacro MUI_INSTALLOPTIONS_READ $R1 &quot;$PLUGINSDIRwndSerial.ini&quot; &quot;Field 2&quot; &quot;State&quot;<br />
with this:<br />
!insertmacro MUI_INSTALLOPTIONS_READ $R1 &quot;$PLUGINSDIR\wndSerial.ini&quot; &quot;Field 2&quot; &quot;State&quot;<br />
<br />
wndSerial.ini must be the exact name of the IO ini file you have extracted on $PLUGINSDIR<br />
<br />
Just now I noticed you're making the same mistake in the whole script.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">23rd May 2006, 14:05</div></div><div class="posttext">There is a missing backslash almost everywhere on your script :-)<br />
When I shaw it first time I focused to to the defines.<br />
You should read the script line by line and add the missing backslashes :-)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">smoura</div><div class="date">23rd May 2006, 14:16</div></div><div class="posttext">:) the backslashes are in the code, it seems that when I copy the code from the editor to the post form it removes the backslashes... :P</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">23rd May 2006, 17:28</div></div><div class="posttext">I don't know if the system call to the plugin dll is correct thus working.<br />
Besides that if the INI file extraction is right and your custom page appears normally, this code should read the values from ini fields:<br />
Function ValidateCustom<br />
ReadIniStr $R1 '$PLUGINSDIR\wndSerial.ini' 'Field 2' 'State'<br />
messagebox mb_ok &quot;$R1&quot;<br />
...................</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">23rd May 2006, 23:03</div></div><div class="posttext">I also noticed some code that is not particularly 'clean':<br />
<br />
InstallOptions::dialog &quot;$PLUGINSDIRwndSerial.ini&quot; <br />
Pop $R0<br />
<br />
Should be:<br />
<br />
InstallOptions::dialog &quot;$PLUGINSDIRwndSerial.ini&quot;   <br />
Pop $R0<br />
Pop $R0<br />
<br />
This just erases the return value from InstallOptions::dialog (it is pushed onto the stack).<br />
<br />
I also just noticed this: Why are you calling a messagebox function with the System plugin? NSIS already has a messagebox function (you probably aready know this).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">smoura</div><div class="date">24th May 2006, 09:06</div></div><div class="posttext">Thanks all for the replys.<br />
<br />
Red Wine:<br />
<br />
The custom page does indeed appear absolutly normal with the 4 fields to fill. I'm just not being able to get the values back from the fields (the code you've placed is exacly what I'm trying to put to work here).<br />
<br />
JasonFriday13:<br />
<br />
Thanks for the note on the Pop, I've put the other Pop instruction on the code still, cant get anything from the form.<br />
Has for the message boxes their only for test purposes, to see the value in the first one and then check if I can use the system plugin correctly, hence the real purpose for this issue is serial validation through an auxiliar dll.<br />
<br />
I'll try to create a clean install to sharpen my skills.<br />
<br />
All sugestions will be greatly appreciated ;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">smoura</div><div class="date">24th May 2006, 11:17</div></div><div class="posttext">Well I've managed to get the values back from the custom page by using the ReadINIStr instead of the MUI macro, though the problem was that Pop that Jason said, since before using the macro I was using the ReadINIStr to read...<br />
<br />
I'll now try to see why the dll doesn't get called, any help on this would be greatly apreciated! :)<br />
<br />
I suppose that this:<br />
<br />
System::Call &quot;user32::MessageBox (i $HWNDPARENT, t r11, t 'Test', i 0)&quot;<br />
<br />
<br />
should show a message box with the $R1 variable of NSIS script, I'm not getting any message at all :P.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">24th May 2006, 12:14</div></div><div class="posttext">I guess you want to pop up a messagebox for debug...<br />
Anyway try this:<br />
MessageBox MB_OK|MB_ICONINFORMATION &quot;$$R1==$R1&quot;<br />
Native message boxes work perfectly, you may want to refer to NSIS documentation for details.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">smoura</div><div class="date">24th May 2006, 12:15</div></div><div class="posttext">Dammm :D:D:D it's working. Thanks all for the replys.<br />
<br />
The problem with the call to the dll function was that I used the .dll in the System::Call function, rather then using only the DLL name. The final line looks like this:<br />
<br />
<br />
System::Call &quot;$PLUGINSDIR\\ValidateSN::ValidateSN(t r11, t r12,t r13,t r14)i r0&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">smoura</div><div class="date">24th May 2006, 12:17</div></div><div class="posttext">Thanks RedWine! But I was using the Native Message box to try an easier function than my on dll with the System plugin. :)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>