<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Push/Pop/Exch my head is spinning!, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Push/Pop/Exch my head is spinning! NSIS Discussion" />
	
	<title> Push/Pop/Exch my head is spinning! [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Push/Pop/Exch my head is spinning!</div>
<hr />
<div class="pda"><a href="t-259023.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=259023">Push/Pop/Exch my head is spinning!</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">davidnewcomb</div><div class="date">6th November 2006, 17:30</div></div><div class="posttext">I must have written about 100 functions, and each time, I spend longer trying to figure out what order to push/pop/exch at the start and even longer figuring out what order to push/pop/exch at the end. It takes ages to figure it out and makes my head spin :(<br />
<br />
Is there an easy trick I am missing to write saving 4 variables, popping 3 then pushing 2 and restoring 4.<br />
<br />
Is there any chance this is going to be somthing that is going to be addressed? I was thinking of function-local stack? Eg same everything on the local stack, pop what you want, do work, push what you want, restore from function-local stack. Easy?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">6th November 2006, 18:06</div></div><div class="posttext">If your problem is parameter-passing to functions with the stack, you should have look at http://nsis.sourceforge.net/NfUtils_header_file, especially http://nsis.sourceforge.net/NfUtils_header_file#nfu..21InstallFunction, <br />
http://nsis.sourceforge.net/NfUtils_header_file#nfu..21AddFunction,<br />
http://nsis.sourceforge.net/NfUtils_header_file#nfu.Function and<br />
http://nsis.sourceforge.net/NfUtils_header_file#nfu.FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">davidnewcomb</div><div class="date">6th November 2006, 18:23</div></div><div class="posttext">Thanks looks like that will be useful. Please can you give me an example to fit the following:<br />
<br />
!macro GetPoolNameFromPoolId P_ID P_RET<br />
  Push &quot;${TMP_POOLS_FILE}&quot;<br />
  Push &quot;${COLUMN_POOL_ID}&quot;<br />
  Push &quot;${P_ID}&quot;<br />
  Push &quot;${COLUMN_POOL_NAME}&quot;<br />
  Call GetMatchInFile<br />
  Pop ${P_RET}<br />
!macroend<br />
<br />
Function GetMatchInFile<br />
<br />
# My temp variables are $0, $1, $2, $4<br />
# Then push something on the stack<br />
<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">6th November 2006, 19:03</div></div><div class="posttext">Untested:<br />
<br />
<br />
<br />
${nfu.Function} GetMatchInFile out $9 in $0 in $1 in $2 in $4 '' '' '' '' '' '' '' '' '' '' <br />
; you may use TMP_POOLS_FILE,COLUMN_POOL_ID,P_ID,COLUMN_POOL_NAME in $0,$1,$2,$4, <br />
; collect result in $9<br />
; your code, push and pop whatever you want:<br />
; ...<br />
; at this point the stack should be cleared from your 'local' stack-ops <br />
${nfu.FunctionEnd}<br />
<br />
${nfu.!InstallFunction} &quot;&quot; GetMatchInFile out RetVal in TmpPoolsFile in ColPoolID in pID in ColPoolName '' '' '' '' '' '' '' '' '' '' 'SomeDescription'<br />
<br />
${nfu.!AddFunction} GetMatchInFile<br />
<br />
!macro GetPoolNameFromPoolId P_ID P_RET<br />
${GetMatchInFile} ${P_RET} &quot;${TMP_POOLS_FILE}&quot; &quot;${COLUMN_POOL_ID}&quot; &quot;${P_ID}&quot; &quot;${COLUMN_POOL_NAME}&quot;<br />
!macroend</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">6th November 2006, 19:13</div></div><div class="posttext">The System plug-in can create a private stack for your function. See System::Store usage in Examples\System.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">7th November 2006, 11:43</div></div><div class="posttext">I was just about to leave the office when I got notified of your 2nd post, so I was not really concentrated with my reply. I forgot some essentials (in red), OutFile is still missing:<br />
<br />
<br />
!include nfUtils.nsh<br />
<br />
!define TMP_POOLS_FILE 10<br />
!define COLUMN_POOL_ID 20<br />
!define COLUMN_POOL_NAME 30<br />
<br />
!macro GetMatchInFile Un1 Un2 <br />
${nfu.Function} ${Un2}GetMatchInFile out $9 in $0 in $1 in $2 in $4 '' '' '' '' '' '' '' '' '' ''<br />
!verbose push<br />
!verbose 4                 ; show my code<br />
; you may use TMP_POOLS_FILE,COLUMN_POOL_ID,P_ID,COLUMN_POOL_NAME in $0,$1,$2,$4,<br />
; collect result in $9<br />
; your code, push and pop whatever you want:<br />
 StrCpy $9 &quot;Result: $0$1$2$4&quot;<br />
; at this point the stack should be cleared from your 'local' stack-ops<br />
!verbose pop<br />
${nfu.FunctionEnd}<br />
!macroend <br />
<br />
${nfu.!InstallFunction} &quot;&quot; GetMatchInFile out RetVal in TmpPoolsFile in ColPoolID in pID in ColPoolName '' '' '' '' '' '' '' '' '' '' 'SomeDescription'<br />
<br />
${nfu.!AddFunction} GetMatchInFile<br />
<br />
!macro GetPoolNameFromPoolId P_ID P_RET<br />
${GetMatchInFile} ${P_RET} &quot;${TMP_POOLS_FILE}&quot; &quot;${COLUMN_POOL_ID}&quot; &quot;${P_ID}&quot; &quot;${COLUMN_POOL_NAME}&quot;<br />
!macroend<br />
<br />
Section<br />
SectionEnd<br />
<br />
Function .onInit<br />
; test the function<br />
!insertmacro GetPoolNameFromPoolId 1 $8<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">davidnewcomb</div><div class="date">7th November 2006, 12:10</div></div><div class="posttext">If there are any other poor unfortunate individuals who are having stack problems then, this was the easiest way of solving all my problems. I'm sure that it is not as efficient as it could be, but at the end of the day its just an installer. The real goodies are in the payload!<br />
<br />
# Written by David Newcomb<br />
!include &quot;WinMessages.nsh&quot;<br />
<br />
Name &quot;Store test&quot;<br />
OutFile &quot;Store.exe&quot;<br />
ShowInstDetails show<br />
<br />
Var answer<br />
<br />
Function .onInit<br />
FunctionEnd<br />
<br />
Function StoreProt<br />
<br />
	# Place stack protection code here<br />
	System::Store /NOUNLOAD &quot;s&quot;<br />
<br />
	# Read parameters<br />
	Pop $0<br />
	Pop $1<br />
	Pop $2<br />
	Pop $3<br />
	Pop $4<br />
<br />
	# -= Do sums =-<br />
<br />
	# Push anser<br />
	Push &quot;six&quot;<br />
<br />
	# Restore stack<br />
	System::Store &quot;l&quot;<br />
<br />
FunctionEnd<br />
<br />
Section<br />
<br />
	StrCpy $0 &quot;safe0&quot;<br />
	StrCpy $1 &quot;safe1&quot;<br />
	StrCpy $2 &quot;safe2&quot;<br />
	StrCpy $3 &quot;safe3&quot;<br />
	StrCpy $4 &quot;safe4&quot;<br />
	StrCpy $5 &quot;safe5&quot;<br />
	StrCpy $6 &quot;safe6&quot;<br />
	StrCpy $7 &quot;safe7&quot;<br />
	StrCpy $8 &quot;safe8&quot;<br />
	StrCpy $9 &quot;safe9&quot;<br />
<br />
	StrCpy $R0 &quot;safeR0&quot;<br />
	StrCpy $R1 &quot;safeR1&quot;<br />
	StrCpy $R2 &quot;safeR2&quot;<br />
	StrCpy $R3 &quot;safeR3&quot;<br />
	StrCpy $R4 &quot;safeR4&quot;<br />
	StrCpy $R5 &quot;safeR5&quot;<br />
	StrCpy $R6 &quot;safeR6&quot;<br />
	StrCpy $R7 &quot;safeR7&quot;<br />
	StrCpy $R8 &quot;safeR8&quot;<br />
	StrCpy $R9 &quot;safeR9&quot;<br />
<br />
	Push &quot;one&quot;<br />
	Push &quot;two&quot;<br />
	Push &quot;three&quot;<br />
	Push &quot;four&quot;<br />
	Push &quot;five&quot;<br />
<br />
	Call StoreProt<br />
<br />
	Pop $answer<br />
<br />
	DetailPrint &quot;answer=$answer&quot;<br />
<br />
	DetailPrint &quot;0 = $0&quot;<br />
	DetailPrint &quot;1 = $1&quot;<br />
	DetailPrint &quot;2 = $2&quot;<br />
	DetailPrint &quot;3 = $3&quot;<br />
	DetailPrint &quot;4 = $4&quot;<br />
	DetailPrint &quot;5 = $5&quot;<br />
	DetailPrint &quot;6 = $6&quot;<br />
	DetailPrint &quot;7 = $7&quot;<br />
	DetailPrint &quot;8 = $8&quot;<br />
	DetailPrint &quot;9 = $9&quot;<br />
<br />
	DetailPrint &quot;R0 = $R0&quot;<br />
	DetailPrint &quot;R1 = $R1&quot;<br />
	DetailPrint &quot;R2 = $R2&quot;<br />
	DetailPrint &quot;R3 = $R3&quot;<br />
	DetailPrint &quot;R4 = $R4&quot;<br />
	DetailPrint &quot;R5 = $R5&quot;<br />
	DetailPrint &quot;R6 = $R6&quot;<br />
	DetailPrint &quot;R7 = $R7&quot;<br />
	DetailPrint &quot;R8 = $R8&quot;<br />
	DetailPrint &quot;R9 = $R9&quot;<br />
<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comm@nder21</div><div class="date">7th November 2006, 19:50</div></div><div class="posttext">i recommend reading Pop, Push, Exch... The Stack (http://nsis.sourceforge.net/Pop%2C_Push%2C_Exch..._The_Stack)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">davidnewcomb</div><div class="date">8th November 2006, 13:40</div></div><div class="posttext">I did read it, and I refer you to my orginal post.<br />
When you have a function which pushs 4, uses 3 and pops 2 you have to spend 30 minutes drawing pictures of stacks to figure out whether to Exch 4 or 5.<br />
Next time you write a function which pushs 2, uses 2 and pops 1, you have to do it all again, but slightly differently. I feel it is a bit of a waste of time.<br />
Or you can Store/Restore and not care.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">8th November 2006, 13:54</div></div><div class="posttext">Or you use nfUtils' macros to wrap your function - and do not care ;)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>