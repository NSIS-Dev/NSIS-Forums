<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Start Menu Folder displays &quot;0&quot; in UAC plug in sample, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Start Menu Folder displays &quot;0&quot; in UAC plug in sample NSIS Discussion" />
	
	<title> Start Menu Folder displays &quot;0&quot; in UAC plug in sample [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Start Menu Folder displays &quot;0&quot; in UAC plug in sample</div>
<hr />
<div class="pda"><a href="t-305361.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=305361">Start Menu Folder displays &quot;0&quot; in UAC plug in sample</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">bedbuffer</div><div class="date">15th April 2009, 07:41</div></div><div class="posttext">Hi All, <br />
<br />
I downloaded the UAC plugin from NSIS' site and along with the plug in are some samples for it, I came across &quot;UAC_GetUserShellFolderPath.nsi.&quot; It works great but there seems to be a small problem with it. <br />
<br />
When you get to the installation page that says &quot;Choose Start Menu Folder,&quot; the destination folder for the start menu by default is &quot;0&quot; when you select &quot;user&quot; for install type, and &quot;1&quot; when you select &quot;admin&quot; for install type. It's suppose to display the name of your application by default, not a number. <br />
<br />
Please help... <br />
<br />
Here's the script of the sample. <br />
<br />
/*<br />
This sample supports two modes, installing as a normal user (single user install) AND as admin (all users install)<br />
This sample uses the registry plugin, so you need to download that if you don't already have it<br />
*/<br />
<br />
!define APPNAME &quot;UAC_RealWorldFullyLoadedDualMode&quot;<br />
!define ELEVATIONTITLE &quot;${APPNAME}: Elevate&quot; ;displayed during elevation on our custom page<br />
!define SMSUBDIR &quot;${APPNAME}&quot;<br />
!define UNINSTALLER_NAME &quot;Uninstall ${APPNAME}.exe&quot;<br />
!define UNINSTALLER_REGSECTION &quot;${APPNAME}&quot;<br />
!define RegPath.MSUninstall &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall&quot;<br />
Name &quot;${APPNAME}&quot;<br />
OutFile &quot;${APPNAME}.exe&quot;<br />
ShowInstDetails show<br />
SetCompressor LZMA<br />
RequestExecutionLevel user /* RequestExecutionLevel REQUIRED! */<br />
!include MUI.nsh<br />
!include UAC.nsh<br />
!include LogicLib.nsh<br />
!include Registry.nsh<br />
!include nsDialogs.nsh	;for our custom page<br />
!include FileFunc.nsh	;we need to parse the command line<br />
<br />
!insertmacro GetParameters<br />
!insertmacro GetOptions<br />
<br />
!define MUI_CUSTOMFUNCTION_ABORT onAbort<br />
!define MUI_CUSTOMFUNCTION_GUIINIT onGuiInit<br />
!define MUI_COMPONENTSPAGE_NODESC<br />
!define MUI_FINISHPAGE_NOAUTOCLOSE<br />
!define MUI_ICON &quot;${NSISDIR}\Contrib\Graphics\Icons\llama-blue.ico&quot;<br />
!define MUI_UNICON &quot;${NSISDIR}\Contrib\Graphics\Icons\llama-blue.ico&quot;<br />
!define MUI_WELCOMEPAGE_TITLE_3LINES<br />
<br />
var InstMode 	# 0: Single user, 1:All users, &gt;1:elevated instance, perform page jump<br />
var hKey 		# Reg hive<br />
var hSelModeAdminRadio<br />
<br />
/*!define MUI_CUSTOMFUNCTION_ABORT onUserAbort<br />
Function onUserAbort<br />
messagebox mb_ok onUserAbort<br />
FunctionEnd<br />
*/<br />
<br />
!macro SetMode IsAdmin<br />
!if &quot;${IsAdmin}&quot; &gt; 0<br />
	SetShellVarContext all<br />
	StrCpy $InstMode 1<br />
	StrCpy $hKey HKLM<br />
	!else<br />
	SetShellVarContext current<br />
	StrCpy $InstMode 0<br />
	StrCpy $hKey HKCU<br />
	!endif<br />
!macroend<br />
<br />
Function .OnInit<br />
!insertmacro SetMode 0<br />
${GetParameters} $R9<br />
${GetOptions} &quot;$R9&quot; UAC $0 ;look for special /UAC:???? parameter (sort of undocumented)<br />
${Unless} ${Errors}<br />
	UAC::IsAdmin<br />
	${If} $0 &lt; 1 <br />
		SetErrorLevel 666 ;special return value for outer instance so it knows we did not have admin rights<br />
		Quit <br />
		${EndIf}<br />
	!insertmacro SetMode 1<br />
	StrCpy $InstMode 2<br />
	${EndIf}<br />
FunctionEnd<br />
<br />
Function onGuiInit<br />
${If} $InstMode &gt;= 2<br />
	${UAC.GetOuterInstanceHwndParent} $0<br />
	${If} $0 &lt;&gt; 0 <br />
		System::Call /NOUNLOAD &quot;*(i,i,i,i)i.r1&quot;<br />
		System::Call /NOUNLOAD 'user32::GetWindowRect(i $0,i r1)i.r2'<br />
		${If} $2 &lt;&gt; 0<br />
			System::Call /NOUNLOAD &quot;*$1(i.r2,i.r3)&quot;<br />
			System::Call /NOUNLOAD 'user32::SetWindowPos(i $hwndParent,i0,ir2,ir3,i0,i0,i 4|1)'<br />
			${EndIf}<br />
		ShowWindow $hwndParent ${SW_SHOW}<br />
		ShowWindow $0 ${SW_HIDE} ;hide outer instance installer window<br />
		System::Free $1<br />
		${EndIf}<br />
	${EndIf}<br />
FunctionEnd<br />
<br />
Function Un.OnInit<br />
!insertmacro SetMode 0<br />
ReadRegDWORD $0 HKLM &quot;${RegPath.MSUninstall}\${UNINSTALLER_REGSECTION}&quot; InstMode ;We saved the &quot;mode&quot; in the installer<br />
${If} $0 U&gt; 0<br />
	; If it was installed for all users, we have to be admin to uninstall it<br />
	${UAC.U.Elevate.AdminOnly} &quot;${UNINSTALLER_NAME}&quot;<br />
	!insertmacro SetMode 1<br />
	${EndIf}<br />
FunctionEnd<br />
<br />
Function onAbort<br />
${UAC.Unload}<br />
FunctionEnd<br />
<br />
${UAC.AutoCodeUnload} 1 ;Auto-generate .OnInstFailed and .OnInstSuccess functions<br />
<br />
!define MUI_PAGE_CUSTOMFUNCTION_PRE SkipPageInElvModePreCB<br />
!insertmacro MUI_PAGE_WELCOME<br />
Page Custom ModeSelectionPageCreate ModeSelectionPageLeave<br />
!define MUI_PAGE_CUSTOMFUNCTION_PRE CmpntsPreCB<br />
!insertmacro MUI_PAGE_COMPONENTS<br />
!define MUI_PAGE_CUSTOMFUNCTION_PRE DirPreCB<br />
!insertmacro MUI_PAGE_DIRECTORY<br />
!insertmacro MUI_PAGE_STARTMENU 1 $9<br />
!insertmacro MUI_PAGE_INSTFILES<br />
!define MUI_FINISHPAGE_TITLE_3LINES<br />
!define MUI_FINISHPAGE_RUN<br />
!define MUI_FINISHPAGE_RUN_FUNCTION FinishRunCB<br />
!insertmacro MUI_PAGE_FINISH<br />
!define MUI_WELCOMEPAGE_TITLE_3LINES<br />
!insertmacro MUI_UNPAGE_WELCOME<br />
!insertmacro MUI_UNPAGE_INSTFILES<br />
!insertmacro MUI_LANGUAGE &quot;English&quot;<br />
<br />
Function CmpntsPreCB<br />
GetDlgItem $0 $hwndparent 3<br />
${IfThen} $InstMode &gt;= 1 ${|} EnableWindow $0 0 ${|} ;prevent user from going back and selecting single user so noobs don't end up installing as the wrong user<br />
FunctionEnd<br />
<br />
Function SkipPageInElvModePreCB<br />
${IfThen} $InstMode &gt; 1 ${|} Abort ${|} ;skip this page so we get to the mode selection page<br />
FunctionEnd<br />
<br />
Function ModeSelectionPageCreate<br />
${If} $InstMode &gt; 1 <br />
	StrCpy $InstMode 1<br />
	Abort ;skip this page and contine where the &quot;parent&quot; would have gone<br />
	${EndIf}<br />
!insertmacro MUI_HEADER_TEXT_PAGE &quot;Select install type&quot; &quot;Blah blah blah blah&quot;<br />
nsDialogs::Create /NOUNLOAD 1018<br />
Pop $0<br />
${NSD_CreateLabel} 0 20u 75% 20u &quot;Blah blah blah blah select install type...&quot;<br />
Pop $0<br />
System::Call &quot;advapi32::GetUserName(t.r0, *i ${NSIS_MAX_STRLEN}r1) i.r2&quot;<br />
${NSD_CreateRadioButton} 0 40u 75% 15u &quot;Single User ($0)&quot;<br />
Pop $0<br />
${IfThen} $InstMode U&lt; 1 ${|} SendMessage $0 ${BM_SETCHECK} 1 0 ${|}<br />
${NSD_CreateRadioButton} 0 60u 75% 15u &quot;All users&quot;<br />
Pop $hSelModeAdminRadio<br />
${IfThen} $InstMode U&gt; 0 ${|} SendMessage $hSelModeAdminRadio ${BM_SETCHECK} 1 0 ${|}<br />
nsDialogs::Show<br />
FunctionEnd<br />
<br />
!macro EnableCtrl dlg id state<br />
push $0<br />
GetDlgItem $0 ${dlg} ${id}<br />
EnableWindow $0 ${state}<br />
pop $0<br />
!macroend<br />
<br />
Function ModeSelectionPageLeave<br />
SendMessage $hSelModeAdminRadio ${BM_GETCHECK} 0 0 $9<br />
UAC::IsAdmin<br />
${If} $9 U&gt; 0<br />
${AndIf} $0 U&lt; 1<br />
	System::Call /NoUnload 'user32::GetWindowText(i $HwndParent,t.R1,i ${NSIS_MAX_STRLEN})' ;get original window title<br />
	System::Call /NoUnload 'user32::SetWindowText(i $HwndParent,t &quot;${ELEVATIONTITLE}&quot;)' ;set out special title<br />
	StrCpy $2 &quot;&quot; ;reset special return, only gets set when sub process is executed, not when user cancels<br />
	!insertmacro EnableCtrl $HWNDParent 1 0 ;Disable next button, just because it looks good ;)<br />
	${UAC.RunElevatedAndProcessMessages}<br />
	!insertmacro EnableCtrl $HWNDParent 1 1<br />
	System::Call 'user32::SetWindowText(i $HwndParent,t &quot;$R1&quot;)' ;restore title<br />
	${If} $2 = 666 ;our special return, the new process was not admin after all <br />
		MessageBox mb_iconExclamation &quot;You need to login with an account that is a member of the admin group to continue...&quot;<br />
			Abort <br />
		${ElseIf} $0 = 1223 ;cancel<br />
			Abort<br />
		${Else}<br />
			${If} $0 &lt;&gt; 0<br />
				${If} $0 = 1062<br />
						MessageBox mb_iconstop &quot;Unable to elevate, Secondary Logon service not running!&quot;<br />
					${Else}<br />
						MessageBox mb_iconstop &quot;Unable to elevate, error $0 ($1,$2,$3)&quot;<br />
					${EndIf} <br />
				Abort<br />
			${EndIf}<br />
		${EndIf} <br />
	Quit ;We now have a new process, the install will continue there, we have nothing left to do here<br />
	${EndIf}<br />
FunctionEnd<br />
<br />
Function DirPreCB<br />
${If} $InstDir == &quot;&quot;<br />
	${If} $InstMode U&gt; 0<br />
		StrCpy $InstDir &quot;$PROGRAMFILES\${APPNAME}&quot;<br />
		${Else}<br />
		StrCpy $InstDir &quot;$APPDATA\${APPNAME}&quot;<br />
		${EndIf}<br />
	${EndIf}<br />
FunctionEnd<br />
<br />
Function FinishRunCB<br />
UAC::Exec &quot;&quot; &quot;Notepad.exe&quot; &quot;$Windir\Win.INI&quot; &quot;$InstDir&quot;<br />
FunctionEnd<br />
<br />
Function CreateSMShortcuts<br />
CreateDirectory &quot;$SMPrograms\${SMSUBDIR}&quot;<br />
CreateShortcut &quot;$SMPrograms\${SMSUBDIR}\${APPNAME}.lnk&quot; &quot;$Windir\Notepad.exe&quot;<br />
CreateShortcut &quot;$SMPrograms\${SMSUBDIR}\Uninstall ${APPNAME}.lnk&quot; &quot;$InstDir\${UNINSTALLER_NAME}&quot;<br />
FunctionEnd<br />
Function CreateDeskShortcuts<br />
CreateShortcut &quot;$Desktop\${APPNAME}.lnk&quot; &quot;$Windir\Notepad.exe&quot;<br />
FunctionEnd<br />
<br />
Section &quot;!Required files&quot;<br />
SectionIn RO<br />
SetOutPath -<br />
!insertmacro _UAC.DbgDetailPrint ;some debug info, useful during testing<br />
;Install files here...<br />
WriteUninstaller &quot;$InstDir\${UNINSTALLER_NAME}&quot;<br />
${registry::Write} &quot;$hKey\${RegPath.MSUninstall}\${UNINSTALLER_REGSECTION}&quot; DisplayName &quot;${APPNAME}&quot; REG_SZ $0<br />
${registry::Write} &quot;$hKey\${RegPath.MSUninstall}\${UNINSTALLER_REGSECTION}&quot; UninstallString &quot;$InstDir\${UNINSTALLER_NAME}&quot; REG_SZ $0<br />
${registry::Write} &quot;$hKey\${RegPath.MSUninstall}\${UNINSTALLER_REGSECTION}&quot; InstMode $InstMode REG_DWORD $0<br />
${registry::Unload}<br />
SectionEnd<br />
<br />
; CREATING SHORTCUTS FOR THE INTERACTIVE USER IN A &quot;ALL USERS&quot; TYPE INSTALL IS BAD PRACTICE, <br />
; BUT WE DO IT HERE FOR DEMONSTRATION PURPOSES<br />
Section &quot;Startmenu Shortcuts&quot;<br />
${UAC.CallFunctionAsUser} CreateSMShortcuts<br />
SectionEnd<br />
Section &quot;Desktop Shortcut&quot;<br />
${UAC.CallFunctionAsUser} CreateDeskShortcuts<br />
SectionEnd<br />
<br />
Section Uninstall<br />
Delete &quot;$InstDir\${UNINSTALLER_NAME}&quot;<br />
Delete &quot;$SMPrograms\${SMSUBDIR}\${APPNAME}.lnk&quot;<br />
Delete &quot;$SMPrograms\${SMSUBDIR}\Uninstall ${APPNAME}.lnk&quot;<br />
RMDir &quot;$SMPrograms\${SMSUBDIR}&quot;<br />
Delete &quot;$Desktop\${APPNAME}.lnk&quot;<br />
<br />
RMDir &quot;$InstDir&quot;<br />
${registry::DeleteKey} &quot;$hKey\${RegPath.MSUninstall}\${UNINSTALLER_REGSECTION}&quot; $0<br />
${registry::Unload}<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">15th April 2009, 09:46</div></div><div class="posttext">you should not use $9 as the startmenu variable, make a new var and define SMSUBDIR as that var (That code is just a example, and the startmenu folder name was hardcoded, it will be fixed in the next version)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bedbuffer</div><div class="date">16th April 2009, 03:26</div></div><div class="posttext">My other question is that !insertmacro MUI_STARTMENU_GETFOLDER 1 $9 uses &quot;1&quot; before the variable $9. Usually what I see is !insertmacro MUI_STARTMENU_GETFOLDER Application $StartMenuFolder. What's the difference? thanks...</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>