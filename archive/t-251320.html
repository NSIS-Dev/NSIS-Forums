<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Problems with Installer on Win 2k, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Problems with Installer on Win 2k NSIS Discussion" />
	
	<title> Problems with Installer on Win 2k [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Problems with Installer on Win 2k</div>
<hr />
<div class="pda"><a href="t-251320.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=251320">Problems with Installer on Win 2k</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">kgobel</div><div class="date">17th July 2006, 17:10</div></div><div class="posttext">Hello,<br />
My installer requires users to enter a valid CD Key, when they enter the CD Key, the Installer Calls a function from an included DLL and the DLL checks on the internet if the key is valid..<br />
<br />
this works great on windows xp...but on every windows 2000 machine i've tried it on it always comes up with the &quot;Incorrect Registration ID&quot; message...which is the default message (even if the Dll is not found it will come up with that message.<br />
<br />
Anyone know why this is happening? Or is there something different in the calling of DLLs from Windows 2000?<br />
<br />
Thanks</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kgobel</div><div class="date">17th July 2006, 18:58</div></div><div class="posttext">Hello, I'm wondering what character set NSIS would send to the DLL?<br />
<br />
Unicode? or Ansi?<br />
<br />
If that switches with operating systems that would explain what's going on maybe?<br />
<br />
Does this sound logical?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kgobel</div><div class="date">17th July 2006, 19:56</div></div><div class="posttext">Alright, well I made some changes to the DLL and now can confirm that the DLL function is not being called on Windows 2000, but is being called on Windows XP<br />
<br />
the System.Dll plugin does work on Windows 2k Right?<br />
<br />
Here is my code that uses the DLL<br />
<br />
<br />
Function CheckID<br />
<br />
  ReadINIStr $0 &quot;$PLUGINSDIR\reg.ini&quot; &quot;Settings&quot; &quot;State&quot;<br />
  StrCmp $0 0 0 done<br />
<br />
  ReadINIStr ${Key} &quot;$PLUGINSDIR\reg.ini&quot; &quot;Field 2&quot; &quot;State&quot;<br />
  <br />
  System::Call /NOUNLOAD 'Register::Check(t, i) i(&quot;${Key}&quot;, &quot;4&quot;) .r0'<br />
<br />
  StrCmp $0 &quot;1&quot; done<br />
  StrCmp $0 &quot;2&quot; incorrect<br />
  StrCmp $0 &quot;3&quot; toomany<br />
  <br />
  incorrect:<br />
  MessageBox MB_ICONEXCLAMATION|MB_OK &quot;Incorrect Registration ID&quot;<br />
  Abort<br />
  <br />
  toomany:<br />
  MessageBox MB_ICONEXCLAMATION|MB_OK &quot;This Registration ID has been used too many times.  Please call 800-XXX-XXXX&quot;<br />
  Abort<br />
<br />
  done:<br />
  <br />
FunctionEnd<br />
<br />
<br />
Anyone see anything that looks funny or would make Win 2k not call the DLL?  Is there a way to check and make sure it's finding the correct file or any types of error checking with the System.dll?<br />
<br />
Currently I just leave the DLL with the Setup.exe, is this where it's suppose to go? Same directory (I never specify in the code that's where it goes)<br />
<br />
Also, does this rule out the possiblility of it being a .dll coding problem?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kgobel</div><div class="date">17th July 2006, 20:48</div></div><div class="posttext">I tried just a basic user32::MessageBox function and that worked fine, so obviously it's something with my .DLL.<br />
<br />
I simplified my code a bit to<br />
<br />
<br />
Function CheckID<br />
<br />
  ReadINIStr $0 &quot;$PLUGINSDIR\reg.ini&quot; &quot;Settings&quot; &quot;State&quot;<br />
  StrCmp $0 0 0 done<br />
<br />
  ReadINIStr ${Key} &quot;$PLUGINSDIR\reg.ini&quot; &quot;Field 2&quot; &quot;State&quot;<br />
 <br />
  System::Call &quot;Registration::Check(t) i('${Key}') .r0&quot;<br />
<br />
  MessageBox MB_ICONEXCLAMATION|MB_OK $0<br />
  StrCmp $0 &quot;1&quot; done<br />
  StrCmp $0 &quot;2&quot; incorrect<br />
  StrCmp $0 &quot;3&quot; toomany<br />
  <br />
  incorrect:<br />
  MessageBox MB_ICONEXCLAMATION|MB_OK &quot;Incorrect Registration ID&quot;<br />
  Abort<br />
  <br />
  toomany:<br />
  MessageBox MB_ICONEXCLAMATION|MB_OK &quot;This Registration ID has been used too many times.  Please call 800-XXX-XXXX&quot;<br />
  Abort<br />
<br />
  done:<br />
  <br />
FunctionEnd<br />
<br />
<br />
After I do the System::Call, I try to MessageBox the result($0) and it displays &quot;error&quot; on the screen.  Is there a way I can get better error results?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kgobel</div><div class="date">17th July 2006, 22:10</div></div><div class="posttext">Function CheckID<br />
<br />
  ReadINIStr $0 &quot;$PLUGINSDIR\reg.ini&quot; &quot;Settings&quot; &quot;State&quot;<br />
  StrCmp $0 0 0 done<br />
<br />
  ReadINIStr ${Key} &quot;$PLUGINSDIR\reg.ini&quot; &quot;Field 2&quot; &quot;State&quot;<br />
  SetOutPath $PLUGINSDIR<br />
  File &quot;Registration.dll&quot;<br />
  System::Call &quot;Registration::Check(t) i('${Key}') .r0 ?e&quot;  <br />
  Delete $PLUGINSDIR\Registration.dll <br />
  <br />
  MessageBox MB_ICONEXCLAMATION|MB_OK $0<br />
  StrCmp $0 &quot;1&quot; done<br />
  StrCmp $0 &quot;2&quot; incorrect<br />
  StrCmp $0 &quot;3&quot; toomany<br />
  <br />
  incorrect:<br />
  MessageBox MB_ICONEXCLAMATION|MB_OK &quot;Incorrect Registration ID&quot;<br />
  Abort<br />
  <br />
  toomany:<br />
  MessageBox MB_ICONEXCLAMATION|MB_OK &quot;This Registration ID has been used too many times.  Please call 800-405-2100&quot;<br />
  Abort<br />
<br />
  done:<br />
  <br />
FunctionEnd<br />
<br />
<br />
completely rebuilt the dll, checked with Dependancey Watcher and it finds the Check function, but in win 2k the installer will not run the function (the reason I know this is because in the DLL function i have it set to pop up message boxes..which don't occur)...I don't know what the '?e' part does on the system::call function...I can't seem to receive any error value, the MessageBox MB_ICONEXCLAMATION|MB_OK $0 still shows a messagebox with 'error' as the text.<br />
<br />
Anyone, any Ideas?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">18th July 2006, 11:18</div></div><div class="posttext">Perhaps you need to register it first with RegDLL (then unregister with UnRegDLL)?<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kgobel</div><div class="date">18th July 2006, 15:50</div></div><div class="posttext">Thank you very much for the reply Afrow UK,<br />
<br />
I added RegDLL and UnRegDLL like you said (not sure if it's where it's suppose to be)..<br />
<br />
So this is my function<br />
<br />
Function CheckID<br />
<br />
  ReadINIStr $0 &quot;$PLUGINSDIR\reg.ini&quot; &quot;Settings&quot; &quot;State&quot;<br />
  StrCmp $0 0 0 done<br />
<br />
  ReadINIStr ${Key} &quot;$PLUGINSDIR\reg.ini&quot; &quot;Field 2&quot; &quot;State&quot;<br />
  SetOutPath $PLUGINSDIR<br />
  File &quot;Registration.dll&quot;<br />
  RegDLL $PLUGINSDIR\Registration.dll<br />
  System::Call &quot;Registration::Check(t) i('${Key}') .r0 ?e&quot;  <br />
  <br />
  UnRegDLL $PLUGINSDIR\Registration.dll<br />
  Delete $PLUGINSDIR\Registration.dll <br />
  <br />
  MessageBox MB_ICONEXCLAMATION|MB_OK $0<br />
  StrCmp $0 &quot;1&quot; done<br />
  StrCmp $0 &quot;2&quot; incorrect<br />
  StrCmp $0 &quot;3&quot; toomany<br />
  <br />
  incorrect:<br />
  MessageBox MB_ICONEXCLAMATION|MB_OK &quot;Incorrect Registration ID&quot;<br />
  Abort<br />
  <br />
  toomany:<br />
  MessageBox MB_ICONEXCLAMATION|MB_OK &quot;This Registration ID has been used too many times.  Please call 800-XXX-XXXX&quot;<br />
  Abort<br />
<br />
  done:<br />
  <br />
FunctionEnd<br />
<br />
<br />
I also trimmed down my DLL to just a windows MessageBox...I'm pretty sure i'm building it right..Created a blank VS 2005 Win32 DLL Project, with this header file (.h)<br />
<br />
 #ifndef _DLLREG_H_<br />
 #define _DLLREG_H_<br />
<br />
#include &lt;windows.h&gt;<br />
#include &lt;iostream&gt;<br />
<br />
 extern &quot;C&quot; __declspec(dllexport) int Check(char * code);<br />
<br />
 #endif<br />
<br />
<br />
and this source file (.cpp)<br />
<br />
#include &quot;Reg.h&quot;<br />
<br />
extern &quot;C&quot; __declspec(dllexport)<br />
int Check(char * code)<br />
{<br />
MessageBox(0, &quot;The Code&quot;, code, 0);<br />
return 0;<br />
}<br />
<br />
<br />
And I still get the same response as before ('error').<br />
<br />
If anyone could just at least confirm* that my source is fine that would be great.  Has anyone tried using the System::Call on a Win2k machine before?<br />
<br />
Thanks again!<br />
-Kyle</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">18th July 2006, 15:53</div></div><div class="posttext">I've never written a DLL to be called with the System plugin. If I need to execute some C/C++ code, I just put it into an NSIS plugin.<br />
<br />
See Contrib\ExDll\exdll.c in the NSIS source distribution.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kgobel</div><div class="date">18th July 2006, 16:05</div></div><div class="posttext">Hrmm <br />
<br />
If I need to execute some C/C++ code, I just put it into an NSIS plugin.<br />
<br />
<br />
I'm not too familier with the NSIS source (just downloaded it now actually...but I would like to try this, but have no idea where to put my code or how the .nsi scripts call the functions...Is there a place for me to learn?  Or is it simple enough to be explained over the forums?<br />
<br />
<br />
and btw..in the file you mentions I see a exported function called myFunction..then in the comments a &quot;do your stuff here&quot;...does this code ever get called?  If so..where?  can you simply just write in the NSIS script Call myFunction ?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Mr Inches</div><div class="date">18th July 2006, 16:08</div></div><div class="posttext">It could be that your library references the MS Runtime library (MSVCRTxx.DLL). It is not hard to do by accident - I know I did twice in my projects.<br />
<br />
Windows 2000 likely has a different version of this library to Windows XP, if it is even present at all in Win2K.<br />
<br />
I think VS2005 projects expect to find either version 7 or version 8 of the runtime library. The .NET Framework also installs a version of the runtime (usually v7) and this will affect your development PC (since it will now have the required DLL).<br />
<br />
It could be that it can find a suitable version on XP (v7) but no version on Win2K (v6).<br />
<br />
Double-check you dependencies in Dependency Walker and confirm  the versions of all libraries that are being used i.e. no just that a library with the right name exists but the date/time stamp is the same. Also, check that you are using the static linking rather than dynamic linking for the MS C/C++ runtime.<br />
<br />
BTW: The System function call works fine on Win2K, I have used in several updaters/installers that run on Win2K.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kgobel</div><div class="date">18th July 2006, 16:19</div></div><div class="posttext">Just opened up my Registration DLL in Dependency Walker and found MSVCRT80.dll...so I'm hoping this is the problem, and the Win2k machine would not have this...<br />
<br />
Now sure how to get rid of it though..workin on it..</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">18th July 2006, 17:26</div></div><div class="posttext">BTW you can use existing tools for communication with server instead of your own dll. NSISdl included to distribution, InetLoad (http://nsis.sourceforge.net/InetLoad_plug-in) also supports POST. Last plug-in solves most of intercommunication problems we found on this forum last year ;)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>