<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" INSTDIR remembers previous setting, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  INSTDIR remembers previous setting NSIS Discussion" />
	
	<title> INSTDIR remembers previous setting [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  INSTDIR remembers previous setting</div>
<hr />
<div class="pda"><a href="t-277627.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=277627">INSTDIR remembers previous setting</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">DrPeggs</div><div class="date">20th September 2007, 11:59</div></div><div class="posttext">Hi<br />
<br />
I am having trouble with a couple of scripts and i am not sure whether this is a nsis bug or intended behaviour.<br />
<br />
I have a zip file that the user extracts to some dir and then runs my nsis exe installer to just re-arrange a couple of directories and install a desktop and 2 start menu shortcuts (one for my app and one for an uninstaller).<br />
<br />
I have a virtually identical 2nd script which does all the same stuff but for a slightly different flavour of my software.<br />
<br />
So basically, in essence, i have installer_X and installer_Y and uninstaller_X and uninstaller_Y in the appropriate and completely separate X and Y dirs.<br />
<br />
All seems to work fine if you only work with one app, either X or Y, doesn't matter, installs fine, uninstalls fine.<br />
<br />
Now the problem comes if i install one app, lets say app X and then app Y then i attempt to uninstall X. The X uninstaller seems to use the INSTDIR variable from the last used installer on the machine, in this case Y!! The result is that uninstaller_X removes the files in the Y dir!<br />
<br />
So to summarise, INSTDIR for the uninstaller seems to remember the value from the last used installer.<br />
<br />
<br />
So my questions and plees for help are:<br />
<br />
1) Can anyone repeat this?<br />
2) Is it known or expected or intended or is it a bug i should report?<br />
3) Is there a work-around i can try?<br />
<br />
I suspect i have just misunderstood the proper INSTDIR usage<br />
Thanks a lot in advance<br />
Steve<br />
:)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">20th September 2007, 12:02</div></div><div class="posttext">You are probably using the same InstallDirRegKey for both.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DrPeggs</div><div class="date">20th September 2007, 12:14</div></div><div class="posttext">Here is my script - originally generated in Eclipse then edited by hand (i have added comments and censored some info for this post, hope that is ok):<br />
<br />
# Auto-generated by EclipseNSIS Script Wizard<br />
# 06-Aug-2007 13:53:41<br />
# Then butchered by the fingers of xxx on 07-Aug-2007<br />
# 20/09/07 xxx updated with a new shortcut icon<br />
<br />
Name MyApp<br />
<br />
# Defines<br />
!define REGKEY &quot;SOFTWARE\$(^Name)&quot;<br />
!define VERSION 1_06				&lt;---- This is the only thing that is different in the 2 scripts<br />
!define COMPANY &quot;MyCompany&quot;<br />
!define URL www.url.com<br />
<br />
# Included files<br />
!include Sections.nsh<br />
<br />
# Reserved Files<br />
ReserveFile &quot;${NSISDIR}\Plugins\StartMenu.dll&quot;<br />
<br />
# Variables<br />
Var StartMenuGroup<br />
<br />
# Installer pages<br />
Page custom StartMenuGroupSelect &quot;&quot; &quot;: Start Menu Folder&quot;<br />
Page instfiles<br />
<br />
# Installer attributes<br />
OutFile InstallMyApp.exe<br />
InstallDir $EXEDIR<br />
CRCCheck on<br />
XPStyle on<br />
Icon &quot;${NSISDIR}\Contrib\Graphics\Icons\classic-install.ico&quot;<br />
ShowInstDetails show<br />
AutoCloseWindow true<br />
VIProductVersion 1.0.0.0<br />
VIAddVersionKey ProductName MyApp<br />
VIAddVersionKey ProductVersion &quot;${VERSION}&quot;<br />
VIAddVersionKey CompanyName &quot;${COMPANY}&quot;<br />
VIAddVersionKey CompanyWebsite &quot;${URL}&quot;<br />
VIAddVersionKey FileVersion &quot;&quot;<br />
VIAddVersionKey FileDescription &quot;&quot;<br />
VIAddVersionKey LegalCopyright &quot;&quot;<br />
InstallDirRegKey HKLM &quot;${REGKEY}&quot; Path<br />
UninstallIcon &quot;${NSISDIR}\Contrib\Graphics\Icons\classic-uninstall.ico&quot;<br />
ShowUninstDetails show<br />
<br />
# Installer sections<br />
!macro CREATE_SMGROUP_SHORTCUT NAME PATH<br />
    Push &quot;${NAME}&quot;<br />
    Push &quot;${PATH}&quot;<br />
    Call CreateSMGroupShortcut<br />
!macroend<br />
<br />
Section -Main SEC0000<br />
    SetOutPath $INSTDIR\MyApp  <br />
    CreateShortcut &quot;$DESKTOP\MyApp_${VERSION}.lnk&quot; &quot;$EXEDIR\MyApp\MyApp.jar&quot; &quot;&quot; &quot;$EXEDIR\MyApp\MyApp.ico&quot;<br />
    CreateDirectory $EXEDIR\bin<br />
    CopyFiles /SILENT /FILESONLY $EXEDIR\MyApp\My_App.exe $EXEDIR\bin<br />
    CopyFiles /SILENT /FILESONLY $EXEDIR\MyApp\dlls\cygwin1.dll $EXEDIR\bin<br />
    CopyFiles /SILENT /FILESONLY $EXEDIR\MyApp\dlls\MyCompanyRunner.dll $EXEDIR\MyApp<br />
    CopyFiles /SILENT /FILESONLY $EXEDIR\MyApp\dlls\MyCompanyDLL.dll $EXEDIR\MyApp<br />
    CopyFiles /SILENT /FILESONLY $EXEDIR\MyApp\dlls\jspWin.dll $EXEDIR\MyApp<br />
    WriteRegStr HKLM &quot;${REGKEY}\Components&quot; Main 1<br />
SectionEnd<br />
<br />
Section -post SEC0001<br />
    WriteRegStr HKLM &quot;${REGKEY}&quot; Path $INSTDIR<br />
    WriteRegStr HKLM &quot;${REGKEY}&quot; StartMenuGroup $StartMenuGroup<br />
    SetOutPath $INSTDIR<br />
    WriteUninstaller $INSTDIR\UninstallMyApp_${VERSION}.exe<br />
    !insertmacro CREATE_SMGROUP_SHORTCUT &quot;Uninstall $(^Name) ${VERSION}&quot; $INSTDIR\UninstallMyApp_${VERSION}.exe<br />
    WriteRegStr HKLM &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)&quot; DisplayName &quot;$(^Name)&quot;<br />
    WriteRegStr HKLM &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)&quot; DisplayVersion &quot;${VERSION}&quot;<br />
    WriteRegStr HKLM &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)&quot; Publisher &quot;${COMPANY}&quot;<br />
    WriteRegStr HKLM &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)&quot; URLInfoAbout &quot;${URL}&quot;<br />
    WriteRegStr HKLM &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)&quot; DisplayIcon $INSTDIR\UninstallMyApp_${VERSION}.exe<br />
    WriteRegStr HKLM &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)&quot; UninstallString $INSTDIR\UninstallMyApp_${VERSION}.exe<br />
    WriteRegDWORD HKLM &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)&quot; NoModify 1<br />
    WriteRegDWORD HKLM &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)&quot; NoRepair 1<br />
    SetOutPath $INSTDIR\MyApp  <br />
    CreateShortcut &quot;$SMPROGRAMS\$StartMenuGroup\MyApp_${VERSION}.lnk&quot; &quot;$EXEDIR\MyApp\MyApp.jar&quot; &quot;&quot; &quot;$EXEDIR\MyApp\MyApp.ico&quot;  <br />
SectionEnd<br />
<br />
# Macro for selecting uninstaller sections<br />
!macro SELECT_UNSECTION SECTION_NAME UNSECTION_ID<br />
    Push $R0<br />
    ReadRegStr $R0 HKLM &quot;${REGKEY}\Components&quot; &quot;${SECTION_NAME}&quot;<br />
    StrCmp $R0 1 0 next${UNSECTION_ID}<br />
    !insertmacro SelectSection &quot;${UNSECTION_ID}&quot;<br />
    GoTo done${UNSECTION_ID}<br />
next${UNSECTION_ID}:<br />
    !insertmacro UnselectSection &quot;${UNSECTION_ID}&quot;<br />
done${UNSECTION_ID}:<br />
    Pop $R0<br />
!macroend<br />
<br />
# Uninstaller sections<br />
!macro DELETE_SMGROUP_SHORTCUT NAME<br />
    Push &quot;${NAME}&quot;<br />
    Call un.DeleteSMGroupShortcut<br />
!macroend<br />
<br />
Section /o un.Main UNSEC0000<br />
    Delete /REBOOTOK $DESKTOP\MyApp_${VERSION}.lnk<br />
    DeleteRegValue HKLM &quot;${REGKEY}\Components&quot; Main<br />
SectionEnd<br />
<br />
Section un.post UNSEC0001<br />
    Delete $INSTDIR\bin\My_App.exe<br />
    Delete $INSTDIR\bin\cygwin1.dll<br />
    Delete $INSTDIR\MyApp\MyCompanyRunner.dll<br />
    Delete $INSTDIR\MyApp\MyCompanyDLL.dll<br />
    Delete $INSTDIR\MyApp\jspWin.dll<br />
    RMDir $INSTDIR\bin<br />
    DeleteRegKey HKLM &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)&quot;<br />
    !insertmacro DELETE_SMGROUP_SHORTCUT &quot;Uninstall $(^Name) ${VERSION}&quot;<br />
    !insertmacro DELETE_SMGROUP_SHORTCUT &quot;MyApp_${VERSION}&quot;    <br />
    Delete /REBOOTOK $INSTDIR\UninstallMyApp_${VERSION}.exe<br />
    DeleteRegValue HKLM &quot;${REGKEY}&quot; StartMenuGroup<br />
    DeleteRegValue HKLM &quot;${REGKEY}&quot; Path<br />
    DeleteRegKey /IfEmpty HKLM &quot;${REGKEY}\Components&quot;<br />
    DeleteRegKey /IfEmpty HKLM &quot;${REGKEY}&quot;<br />
    RMDir $SMPROGRAMS\$StartMenuGroup<br />
    Push $R0<br />
    StrCpy $R0 $StartMenuGroup 1<br />
    StrCmp $R0 &quot;&gt;&quot; no_smgroup<br />
no_smgroup:<br />
    Pop $R0<br />
SectionEnd<br />
<br />
# Installer functions<br />
Function StartMenuGroupSelect<br />
    Push $R1<br />
    StartMenu::Select /checknoshortcuts &quot;Do not create shortcuts&quot; /autoadd /text &quot;Select the Start Menu folder in which to create the program's shortcuts:&quot; /lastused $StartMenuGroup MyCompanyMyApp<br />
    Pop $R1<br />
    StrCmp $R1 success success<br />
    StrCmp $R1 cancel done<br />
    MessageBox MB_OK $R1<br />
    Goto done<br />
success:<br />
    Pop $StartMenuGroup<br />
done:<br />
    Pop $R1<br />
FunctionEnd<br />
<br />
Function .onInit<br />
    InitPluginsDir<br />
FunctionEnd<br />
<br />
Function CreateSMGroupShortcut<br />
    Exch $R0 ;PATH<br />
    Exch<br />
    Exch $R1 ;NAME<br />
    Push $R2<br />
    StrCpy $R2 $StartMenuGroup 1<br />
    StrCmp $R2 &quot;&gt;&quot; no_smgroup<br />
    SetOutPath $SMPROGRAMS\$StartMenuGroup <br />
    CreateShortcut &quot;$SMPROGRAMS\$StartMenuGroup\$R1.lnk&quot; $R0<br />
no_smgroup:<br />
    Pop $R2<br />
    Pop $R1<br />
    Pop $R0<br />
FunctionEnd<br />
<br />
<br />
# Uninstaller functions<br />
Function un.onInit<br />
    ReadRegStr $INSTDIR HKLM &quot;${REGKEY}&quot; Path<br />
    ReadRegStr $StartMenuGroup HKLM &quot;${REGKEY}&quot; StartMenuGroup<br />
    !insertmacro SELECT_UNSECTION Main ${UNSEC0000}<br />
FunctionEnd<br />
<br />
Function un.DeleteSMGroupShortcut<br />
    Exch $R1 ;NAME<br />
    Push $R2<br />
    StrCpy $R2 $StartMenuGroup 1<br />
    StrCmp $R2 &quot;&gt;&quot; no_smgroup<br />
    Delete /REBOOTOK &quot;$SMPROGRAMS\$StartMenuGroup\$R1.lnk&quot;<br />
no_smgroup:<br />
    Pop $R2<br />
    Pop $R1<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DrPeggs</div><div class="date">20th September 2007, 12:17</div></div><div class="posttext">You are probably using the same InstallDirRegKey for both <br />
<br />
ah, thanks for the quick response, i clearly don't understand that bit:<br />
<br />
InstallDirRegKey HKLM &quot;${REGKEY}&quot; Path<br />
<br />
Do i just make the HKLM bit different for both like:<br />
<br />
InstallDirRegKey MyApp_${VERSION} &quot;${REGKEY}&quot; Path<br />
<br />
<br />
thanks again</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">20th September 2007, 12:20</div></div><div class="posttext">You need to change this line in both scripts:<br />
Name MyApp<br />
<br />
REGKEY is set to Software\$(^Name) which is Software\MyApp. Therefore as I expected, both your installers are saving their install directory path under the same registry key value.<br />
<br />
And HKLM is HKEY_LOCAL_MACHINE so leave that.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DrPeggs</div><div class="date">20th September 2007, 12:23</div></div><div class="posttext">fantastic, many thanks fella</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>