<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Second install directory not uninstalled, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Second install directory not uninstalled NSIS Discussion" />
	
	<title> Second install directory not uninstalled [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Second install directory not uninstalled</div>
<hr />
<div class="pda"><a href="t-318535.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=318535">Second install directory not uninstalled</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">hawkmaster</div><div class="date">20th April 2010, 12:57</div></div><div class="posttext">Hello<br />
I tried a script with two page directories. One for program files and one for data.<br />
All works fine except the uninstall of the data directory.<br />
All files and the the main install dir $INSTDIR are removed but not the<br />
$INSTDIR2 folder.<br />
<br />
I assume that $INSTDIR is not recogniced if uninstaller is starting?<br />
<br />
Thanks for any help.<br />
<br />
Here a part of my NSI code<br />
<br />
-----------------------------------------------<br />
# First directory page for program files.<br />
!insertmacro MUI_PAGE_DIRECTORY<br />
; Instfiles page<br />
!insertmacro MUI_PAGE_INSTFILES<br />
<br />
##########################################################<br />
##########################################################<br />
# Second directory page for data files.<br />
var INSTDIR2<br />
!define MUI_DIRECTORYPAGE_VARIABLE $INSTDIR2<br />
!define MUI_PAGE_CUSTOMFUNCTION_PRE DirectoryPre<br />
!insertmacro MUI_PAGE_DIRECTORY<br />
!insertmacro MUI_PAGE_INSTFILES<br />
<br />
Function DirectoryPre<br />
 StrCpy $INSTDIR2 &quot;$PROGRAMFILES\Data&quot;<br />
FunctionEnd<br />
<br />
##########################################################<br />
##########################################################<br />
<br />
; Finish page<br />
!insertmacro MUI_PAGE_FINISH<br />
<br />
; Uninstaller pages<br />
!insertmacro MUI_UNPAGE_INSTFILES<br />
<br />
; Language files<br />
!insertmacro MUI_LANGUAGE &quot;English&quot;<br />
!insertmacro MUI_LANGUAGE &quot;French&quot;<br />
!insertmacro MUI_LANGUAGE &quot;German&quot;<br />
<br />
; MUI end ------<br />
<br />
Name &quot;${PRODUCT_NAME} ${PRODUCT_VERSION}&quot;<br />
OutFile &quot;Setup.exe&quot;<br />
InstallDir &quot;$PROGRAMFILES\ITest&quot;<br />
ShowInstDetails show<br />
ShowUnInstDetails show<br />
....<br />
....<br />
Section Uninstall<br />
  RMDir /r &quot;$INSTDIR2/Data&quot;<br />
  <br />
  Delete &quot;$INSTDIR\${PRODUCT_NAME}.url&quot;<br />
  Delete &quot;$INSTDIR\uninst.exe&quot;<br />
  Delete &quot;$INSTDIR\index.php&quot;<br />
  Delete &quot;$INSTDIR\index.html&quot;<br />
<br />
  Delete &quot;$SMPROGRAMS\ITest\Uninstall.lnk&quot;<br />
  Delete &quot;$SMPROGRAMS\ITest\Website.lnk&quot;<br />
<br />
  RMDir &quot;$SMPROGRAMS\ITest&quot;<br />
  RMDir &quot;$INSTDIR&quot;<br />
<br />
  DeleteRegKey ${PRODUCT_UNINST_ROOT_KEY} &quot;${PRODUCT_UNINST_KEY}&quot;<br />
  SetAutoClose true<br />
SectionEnd<br />
--------------------------------------------------</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">20th April 2010, 13:37</div></div><div class="posttext">Variables are not transferred from the installer to the uninstaller. $INSTDIR is also not transferred. Instead, it contains the path where uninstall.exe is stored (in the hopes that this is the same as $INSTDIR was in the installer...). To transfer variables, use the registry or write the values to a file.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">hawkmaster</div><div class="date">20th April 2010, 13:49</div></div><div class="posttext">Hello,<br />
thanks a lot for your help<br />
<br />
Variables are not transferred from the installer to the uninstaller. $INSTDIR is also not transferred. Instead, it contains the path where uninstall.exe is stored (in the hopes that this is the same as $INSTDIR was in the installer...). To transfer variables, use the registry or write the values to a file.<br />
<br />
Now I have written the variable $Instdir2 to the registry<br />
WriteRegStr ${PRODUCT_UNINST_ROOT_KEY} &quot;${PRODUCT_UNINST_KEY}&quot; &quot;DataDirectory&quot; &quot;$INSTDIR2\Directories&quot;<br />
<br />
and in the unistall section I read the path from registry<br />
ReadRegStr $R1 ${PRODUCT_UNINST_ROOT_KEY} &quot;${PRODUCT_UNINST_KEY}&quot; &quot;DataDirectory&quot;<br />
   RMDir /r &quot;$R1&quot;<br />
...<br />
<br />
It works. If there is any problem with this code or if there is something to improve, please let me know.<br />
<br />
best regards<br />
Hawk</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">20th April 2010, 14:16</div></div><div class="posttext">While the basic idea is correct, there are two possible problems with that code. First of all, the regkey may not exist for some reason. In that case you'll end up calling RmDir /r &quot;&quot;, which probably does nothing, but might perhaps also delete something you don't want deleted at all. So add a check: ${If} $R1 != &quot;&quot;  RmDir etc ${EndIf}. Second, using the /r flag in RmDir is extremely dangerous. If some idiot end-user decided to put stuff inside your INSTDIR, you'll be deleting things the user doesn't want deleted. So it's almost always better to delete only those files you KNOW you want to delete:<br />
Delete $R1\filename1.ext<br />
Delete $R1\filename2.ext<br />
RmDir $R1</div></div><hr />


<div class="post"><div class="posttop"><div class="username">hawkmaster</div><div class="date">20th April 2010, 14:25</div></div><div class="posttext">Hello MSG,<br />
thanks again for this tip.<br />
Normally I always delete the files and directory like you recommend.<br />
But, how can you delete and remove files from directories which have files included that are not recognized from installer?<br />
Like in my Data directory. In this directory after installation there are many files copied, there a session files from the system. There are tmp files from Windows. All these files I do not know before installation.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">hawkmaster</div><div class="date">21st April 2010, 08:01</div></div><div class="posttext">Hello,<br />
I want to ask again:<br />
I know that RMdir /r is not a good way for uninstalling files and directories.<br />
But how can you make an uninstall of a directory which containts temporary files, like session files or log files?<br />
all these files are created after the installation. So you cannot include it into the uninstall section.<br />
<br />
Thanks for any hint.<br />
<br />
regards<br />
hawk</div></div><hr />


<div class="post"><div class="posttop"><div class="username">hawkmaster</div><div class="date">21st April 2010, 08:18</div></div><div class="posttext">Hello,<br />
I know that RMDIR /r is not a good way.<br />
But how can you make an uninstall of a directory which contains files after installation?<br />
For example Session files or log files which are created temporarely.<br />
Or if other programs copies files in this directory.<br />
All these files are not known while installing and cannot be added into the uninstall section<br />
<br />
Thanks for any idea.<br />
regards<br />
hawl</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">21st April 2010, 14:46</div></div><div class="posttext">You can delete files in a folder with wildcards, but you really should only remove the files you installed and files you know your program makes/might make and can safely be deleted.  Any other files, such as a user's configuration settings and files written by other applications, either leave them alone or ask the user if they want to delete those, too.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">22nd April 2010, 14:28</div></div><div class="posttext">I would never use RMDir /r in uninstall. If you give it an empty string and you have not set the current working directory ($OUTDIR) you will remove everything from C:\. I have heard of this happening after uninstalls and I would not be surprised if it was a lazily written NSIS uninstaller.<br />
<br />
If you must be lazy and use RMDir /r, look at validating the contents of $INSTDIR before using it:<br />
http://nsis.sourceforge.net/Validating_$INSTDIR_before_uninstall<br />
<br />
Stu</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>