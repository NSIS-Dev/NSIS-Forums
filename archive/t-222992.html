<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" debugging InstallOptions problem [linux], media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  debugging InstallOptions problem [linux] NSIS Discussion" />
	
	<title> debugging InstallOptions problem [linux] [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  debugging InstallOptions problem [linux]</div>
<hr />
<div class="pda"><a href="t-222992.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=222992">debugging InstallOptions problem [linux]</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">31st July 2005, 14:38</div></div><div class="posttext">Hi all,<br />
<br />
When I compile the 2.08 InstallOptions plugin on debian, and use it in the WordFunc.nsi example, it fails to show the dialog due to the call to CreateDialog returning NULL. The error returned from GetLastError is 0 &quot;the operation completed successfully&quot; :/<br />
<br />
The weird thing is that the makefile system I hacked up for 2.06 works, while the Scons build stuff in 2.08 does not. The resulting installer segfaults, but the same happens with installers that use the windows-compiled plugin, so thats a separate issue.<br />
<br />
Anyone have any idea what might be wrong with the Scons stuff? I tried adding -mwindows and a couple of other things, no change though.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">2nd August 2005, 20:41</div></div><div class="posttext">Something very similar happened here (http://forums.winamp.com/showthread.php?s=&amp;threadid=212630&amp;highlight=linux). The generated installer failed on CreateDialog in exactly the same way. I think it might be a problem with the dialog resource, but I've never really researched it deeply enough.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">3rd August 2005, 07:13</div></div><div class="posttext">Hmm, thing is that the 2.06 compile works, but 2.08 does not.<br />
<br />
Also, when I dump the resources from each dll using ResHacker, the text version is exactly the same.<br />
<br />
Hmm, perhaps the mingw-exehead incorrectly decompresses the plugin file?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">4th August 2005, 13:13</div></div><div class="posttext">I noticed that, of the example nsi files, only a couple actually work with the scons built 2.08 debian package.<br />
<br />
I tested them all under cygwin gdb on winxp and got the following backtraces (many were similar/the same):<br />
<br />
#0  0x77f5ac87 in ntdll!RtlUnicodeToMultiByteSize () from ntdll.dll<br />
#1  0x77f5abb5 in ntdll!RtlUnicodeStringToCountedOemString () from ntdll.dll<br />
#2  0x77e712d2 in KERNEL32!GetTempFileNameA () from /c/WINDOWS/system32/kernel32.dll<br />
#3  0x00405e1b in ?? ()<br />
-------------------------------<br />
#0  0x77e727aa in lstrcpynA () from /c/WINDOWS/system32/kernel32.dll<br />
#1  0x0025ad49 in ?? ()<br />
-------------------------------<br />
#0  0x77d4fe10 in wsprintfA () from /c/WINDOWS/system32/user32.dll<br />
#1  0x00465000 in ?? ()<br />
-------------------------------<br />
#0  0x00401e1f in ?? ()<br />
-------------------------------<br />
#0  0x77f75a59 in ntdll!DbgUiConnectToDbg () from ntdll.dll<br />
#1  0x77f9cb5e in ntdll!RtlpNtEnumerateSubKey () from ntdll.dll<br />
Previous frame inner to this frame (corrupt stack?)<br />
<br />
A number of them seemed to cause problems for gdb - exhaustion of virtual memory and internal errors and stuff.<br />
<br />
I'm not sure where to go from here, apart from keeping 2.06 in debian, since the examples have only a couple of segfaults and minimal problems.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">4th August 2005, 22:32</div></div><div class="posttext">Can you attach an example installer? If it's too big, use stashbox (http://stashbox.org/).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">5th August 2005, 04:56</div></div><div class="posttext">I've uploaded all the examples built with the debian nsis 2.08 package to here:<br />
<br />
http://bonedaddy.net/pabs3/files/tmp/examples.zip (1.4M)<br />
<br />
Where the example uses System.dll, I used the one from the windows package of nsis 2.08.<br />
<br />
I've also uploaded the stubs and plugins to here:<br />
<br />
http://bonedaddy.net/pabs3/files/tmp/stubs-plugins.zip (222K)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">5th August 2005, 12:37</div></div><div class="posttext">I've managed to get the installer not to segfault (attached). It has the exact same problem as in the other thread (http://forums.winamp.com/showthread.php?s=&amp;threadid=212630&amp;highlight=linux). I've checked out 2.06's deb, and it also contains bad section order and was probably working just by chance. It seems like the linker script never really worked.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">onad</div><div class="date">5th August 2005, 13:11</div></div><div class="posttext">Good to know I'm not stupid anyhow :-) , building on FreeBSD is difficult and challenging to say the least. Did not have much time last weeks but as soon as possible I'll bug the forum again with problem when buiding on other OS's. I also will be procative as soon as I have ONCE a succesful build on FreeBSD via SCons. A Wiki page will be extended explaining what to do to create a successful build on Linux, FreeBSD, and if possible a MAC Intel.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">5th August 2005, 14:18</div></div><div class="posttext">InstallOptions fails because MinGW decided DllMain isn't the main function. It's set its own entry point and ignored DllMain. Because of this, m_hInstance is not defined properly and CreateDialog can't find the appropriate resource. The problem is the entry flag for ld which points to _DllMain@16 instead of _DllMain@12. ld doesn't complain and so the wrong entry point is used. I've fixed this in the latest CVS version. I'll upload a patch once I find a fix for the first problem too.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">5th August 2005, 16:43</div></div><div class="posttext">I've ended up using ld's default linker script. It's probably version specific and might not work that well with other versions, but it's better than the last one. I've also fixed its usage. Previously, it was passed to ld using -Wl and not -T as it should be.<br />
<br />
Attached is a patch genereated with:<br />
<br />
cvs -q patch -R -u -D yesterday -D now . &gt; deb.patch.txt</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">6th August 2005, 11:22</div></div><div class="posttext">The patch worked perfectly, all of the installers worked fine and didn't show any strange problems. I've applied this patch to debian nsis 2.08-3 and will upload it to debian eperimental soon.<br />
<br />
One exception was BgImage Test.exe, which segfaulted. The backtrace was something like this:<br />
<br />
ntdll<br />
ntdll<br />
SetBg<br />
SetBg<br />
?<br />
?<br />
?<br />
...<br />
<br />
I'll recompile the plugin with debugging info and get a real backtrace and fix for this issue either later tonight or tomorrow morning.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">7th August 2005, 10:19</div></div><div class="posttext">Ok, the problem with BgImage.dll is that the critical section object is not initialised, because DllMain is not entered. According to objectdump -x and the MSVC dependency walker, BgImage.dll doesn't even export a DllMain. The windows nsis 2.08 Plugins don't seem to export the DllMain either.<br />
<br />
This is with the patch. I've attached the BgImage plugin (with debugging messageboxes).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">7th August 2005, 11:01</div></div><div class="posttext">OK, I tested the InstallOptions plugin, and the DllMain from  it also does not get called. However, the Banner plugin does get it's DllMain call. After testing some more of the plugins, it seems like the C++ plugins are the ones that are broken, the C ones are fine.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">9th August 2005, 17:06</div></div><div class="posttext">Uff, MinGW is so annoying. Try adding extern &quot;C&quot; to DllMain.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">10th August 2005, 11:31</div></div><div class="posttext">Thanks, that fixes it. Patch uploaded to sourceforge. New package soon to be in debian.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>