<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Delete Files and Directory not working, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Delete Files and Directory not working NSIS Discussion" />
	
	<title> Delete Files and Directory not working [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Delete Files and Directory not working</div>
<hr />
<div class="pda"><a href="t-175437.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=175437">Delete Files and Directory not working</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">stonkers</div><div class="date">5th April 2004, 17:34</div></div><div class="posttext">I'm having problems getting files and directory deleted.  My Uninstall routine is:<br />
<br />
_________________________________<br />
<br />
Section Uninstall<br />
  ;Delete Files<br />
  Delete &quot;$INSTDIR\*.*&quot;<br />
<br />
  ;Delete Uninstaller And Unistall Registry Entries<br />
  Delete &quot;$INSTDIR\Uninst.exe&quot;<br />
  DeleteRegKey HKEY_LOCAL_MACHINE &quot;SOFTWARE\MyApp&quot;<br />
  DeleteRegKey HKEY_LOCAL_MACHINE &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\MyApp&quot;<br />
  RMDir /r &quot;$INSTDIR&quot;<br />
<br />
__________________________________<br />
<br />
After the Uninstall method is run, the $INSTDIR including all subdirectories and files is still there.  Any help?<br />
<br />
Thanks,<br />
Eric</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">5th April 2004, 19:14</div></div><div class="posttext">* Is the uninstaller located in the directory you want to delete?<br />
<br />
* Is the directory not in use? Can you delete it manually?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stonkers</div><div class="date">5th April 2004, 23:28</div></div><div class="posttext">Uninstaller should no longer be there by the point in the code where it should be deleting the directory.  I have no problems deleting the directory manually.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">VegetaSan</div><div class="date">5th April 2004, 23:36</div></div><div class="posttext">Try this : <br />
<br />
<br />
<br />
Section Uninstall<br />
<br />
Delete &quot;$INSTDIR\*.*&quot;<br />
Delete &quot;$INSTDIR\Uninst.exe&quot;<br />
DeleteRegKey HKLM &quot;SOFTWARE\MyApp&quot;<br />
DeleteRegKey HKLM &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\MyApp&quot;<br />
RMDir /r &quot;$INSTDIR&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stonkers</div><div class="date">6th April 2004, 16:12</div></div><div class="posttext">I'm confused by your reply Vegetasan.  I'm not having problems with the registry.  The problem I'm having is with:<br />
<br />
RMDir /r &quot;$INSTDIR&quot;<br />
<br />
The installer recognizes when the app is already installed...  Can you give me more info on this change if I'm not understanding?<br />
<br />
Thanks,<br />
Eric</div></div><hr />


<div class="post"><div class="posttop"><div class="username">VegetaSan</div><div class="date">6th April 2004, 16:38</div></div><div class="posttext">No I just set it between the script like you <br />
 <br />
Your script<br />
<br />
<br />
Section Uninstall<br />
;Delete Files<br />
Delete &quot;$INSTDIR\*.*&quot;<br />
<br />
;Delete Uninstaller And Unistall Registry Entries<br />
Delete &quot;$INSTDIR\Uninst.exe&quot;<br />
DeleteRegKey HKEY_LOCAL_MACHINE &quot;SOFTWARE\MyApp&quot;<br />
DeleteRegKey HKEY_LOCAL_MACHINE &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\MyApp&quot;<br />
RMDir /r &quot;$INSTDIR&quot;<br />
<br />
<br />
<br />
So I did it like you. But without the registry:<br />
<br />
<br />
Delete &quot;$INSTDIR\*.*&quot;<br />
Delete &quot;$INSTDIR\Uninst.exe&quot;<br />
RMDir /r &quot;$INSTDIR&quot;<br />
<br />
<br />
Just try this one and say if it works</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">6th April 2004, 17:08</div></div><div class="posttext">That will make no difference. Are you sure $INSTDIR is correct?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stonkers</div><div class="date">6th April 2004, 21:50</div></div><div class="posttext">Joost,<br />
<br />
Here's the entire script.  Looks to me like it would be right, but I'm not positive.  See a problem?<br />
<br />
______________________________________<br />
<br />
;NSIS Script<br />
<br />
;Backgound Colors<br />
BGGradient 800080 000000 FFFFFF<br />
BrandingText &quot; &quot;<br />
<br />
;Title Of Your Application<br />
Name &quot;MyApp&quot;<br />
<br />
;Do A CRC Check<br />
CRCCheck On<br />
<br />
;Included file(s)<br />
!include servicelib.nsh<br />
<br />
;Output File Name<br />
OutFile &quot;InstallMyApp.exe&quot;<br />
<br />
;The Default Installation Directory<br />
InstallDir &quot;D:\Program Files\MyApp&quot;<br />
<br />
;The text to prompt the user to enter a directory<br />
DirText &quot;Please select the folder below&quot;<br />
<br />
Section &quot;Install&quot;<br />
  ;Install Files<br />
  SetOutPath $INSTDIR<br />
  SetCompress Auto<br />
  SetOverwrite IfNewer<br />
  File /r &quot;D:\projects\MyApp\*.*&quot;<br />
<br />
  ; Write the uninstall keys for Windows<br />
  WriteRegStr HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\MyApp&quot; &quot;DisplayName&quot; &quot;MyApp (remove only)&quot;<br />
  WriteRegStr HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\MyApp&quot; &quot;UninstallString&quot; &quot;$INSTDIR\Uninst.exe&quot;<br />
WriteUninstaller &quot;Uninst.exe&quot;<br />
SectionEnd<br />
<br />
Section &quot;Shortcuts&quot;<br />
  ;Add Shortcuts<br />
SectionEnd<br />
<br />
UninstallText &quot;This will uninstall MyApp from your system&quot;<br />
<br />
Section Uninstall<br />
  ;Delete Files<br />
  Delete &quot;$INSTDIR\*.*&quot;<br />
<br />
  ;Delete Uninstaller And Unistall Registry Entries<br />
  Delete &quot;$INSTDIR\Uninst.exe&quot;<br />
  DeleteRegKey HKEY_LOCAL_MACHINE &quot;SOFTWARE\MyApp&quot;<br />
  DeleteRegKey HKEY_LOCAL_MACHINE &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\MyApp&quot;<br />
  RMDir /r &quot;$INSTDIR&quot;<br />
SectionEnd<br />
<br />
;-------------------------------- <br />
;Installer Functions <br />
<br />
Function .onInit<br />
<br />
  ReadRegStr $R0 HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\MyApp&quot; &quot;UninstallString&quot;<br />
  StrCmp $R0 &quot;&quot; done<br />
<br />
  MessageBox MB_OKCANCEL|MB_ICONEXCLAMATION \<br />
  &quot;MyApp is already installed. $\n$\nClick `OK` to remove the \<br />
  previous version or `Cancel` to cancel this upgrade.&quot; \<br />
  IDOK uninst<br />
  Abort<br />
  <br />
;Run the uninstaller<br />
uninst:<br />
  ClearErrors<br />
  ExecWait '&quot;$R0&quot; _?=$INSTDIR' ;Do not copy the uninstaller to a temp file<br />
<br />
  <br />
done:<br />
<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">6th April 2004, 22:09</div></div><div class="posttext">Are you running the uninstaller manually and in the right directory? <br />
<br />
Is there a possible problem with user rights?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stonkers</div><div class="date">6th April 2004, 22:56</div></div><div class="posttext">No, I don't run it manually.  The executable asks me if I want to uninstall and I say yes.  Are you saying that the &quot;Uninstall&quot; section won't get run?  Sorry, it's been quite a while since I created these scripts.<br />
<br />
I'm administrator on all the machines that I'm installing on.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">7th April 2004, 16:52</div></div><div class="posttext">So what happends when you start the uninstaller manually? Are the installation directories of the installer and uninstaller equal?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stonkers</div><div class="date">7th April 2004, 22:28</div></div><div class="posttext">Hmmmmmmm.  If I run the uninstaller manually, it works fine.  The log shows it deleting the folder and it does.  However, when I run the installer and do uninstall first, it doesn't even show the line being executed (as if it doesn't exist).  Obviously something is wrong in my code.  Any clue?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stonkers</div><div class="date">7th April 2004, 22:39</div></div><div class="posttext">So when I run the installer manually, I see output from the entire thing running.  When I run the uninstaller from the installer, it does everything except for the rmdir.  In other words:<br />
<br />
Delete &quot;$INSTDIR\*.*&quot;<br />
<br />
does happen and the app gets unregistered.  I'm REALLY lost!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">8th April 2004, 13:13</div></div><div class="posttext">What is the value of $INSTDIR in the uninstaller? You are setting it using the command line, make sure that the installer $INSTDIR is the folder to uninstall from.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stonkers</div><div class="date">9th April 2004, 16:23</div></div><div class="posttext">$INSTDIR has to be correct because the lines:<br />
<br />
Delete &quot;$INSTDIR\*.*&quot;<br />
and<br />
Delete &quot;$INSTDIR\Uninst.exe&quot;<br />
<br />
are deleting from the correct place; the directory that I want to delete with:<br />
<br />
RMDir /r &quot;$INSTDIR&quot;<br />
<br />
Which doesn't even get attempted based on the log.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stonkers</div><div class="date">9th April 2004, 17:23</div></div><div class="posttext">I hard coded the path to delete:<br />
<br />
RMDir /r &quot;D:\MyApp&quot;<br />
<br />
and got the same results.  The uninstaller doesn't even attempt to perform the command.  Do I need to put the delete of the uninstaller after my RMDir?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">9th April 2004, 20:31</div></div><div class="posttext">And does it make any difference whether you start it manually or not?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stonkers</div><div class="date">10th April 2004, 02:33</div></div><div class="posttext">It always works when I start it manually which makes no sense to me.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stonkers</div><div class="date">13th April 2004, 20:48</div></div><div class="posttext">Bump</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">13th April 2004, 22:19</div></div><div class="posttext">You can submit a bug report at the project page. Also attach a script that reproduces the bug and nothing else (no registry entries, files etc.).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">15th April 2004, 16:09</div></div><div class="posttext">When you start it from the installer directory itself, it can't delete itself. RMDir /R stops if it can't delete one of the files and therefore you are left with more than just the uninstaller. Simply copy the uninstaller somewhere else just like it does on its own when executed without the _?= switch.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stonkers</div><div class="date">15th April 2004, 23:11</div></div><div class="posttext">So if I take out the _?= switch, I should be fine?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">15th April 2004, 23:49</div></div><div class="posttext">Yes, but the installer won't wait for the uninstaller to finish.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stonkers</div><div class="date">16th April 2004, 20:59</div></div><div class="posttext">I'm not sure what you mean by copy it somewhere else.  Do you mean to have it run from a different place in the first place or move it before doing the RMDIR?  How about if I use the Rename command just before the RMDIR?  Sorry, I'm very green with this...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">16th April 2004, 21:02</div></div><div class="posttext">Copy the uninsatller somewhere else before you execute it. For example, the temporary directory ($TEMP).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stonkers</div><div class="date">16th April 2004, 21:43</div></div><div class="posttext">OK, I tried this.  I must be doing something wrong.  Here's what I changed:<br />
<br />
---------------------------------<br />
Before<br />
---------------------------------<br />
<br />
;Run the uninstaller<br />
uninst:<br />
ClearErrors<br />
ExecWait '&quot;$R0&quot; _?=$INSTDIR' ;Do not copy the uninstaller to a temp file<br />
<br />
---------------------------------<br />
After<br />
---------------------------------<br />
<br />
ClearErrors <br />
 CopyFiles /SILENT /FILESONLY &quot;$INSTDIR\Uninst.exe&quot; &quot;$TEMP\Uninst.exe&quot;<br />
  ExecWait '&quot;$TEMP\Uninst.exe&quot; _?=$INSTDIR'<br />
<br />
<br />
---------------------------------<br />
<br />
Am I missing something else?  I apologize if I'm being dense!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stonkers</div><div class="date">16th April 2004, 21:50</div></div><div class="posttext">Please excuse the double post, I used Quick Reply and it doesn't seem to update the &quot;Last Post&quot; information.  Please see my previous post.  Thanks - Eric</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">16th April 2004, 21:54</div></div><div class="posttext">Are you sure $R0 is &quot;$INSTDIR\Uninst.exe&quot;? Other than that, it looks ok.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stonkers</div><div class="date">16th April 2004, 22:06</div></div><div class="posttext">Part of my change was to quit using $R0.  I'm running the Uninst.exe from where I copy it to now:<br />
<br />
CopyFiles /SILENT /FILESONLY &quot;$INSTDIR\Uninst.exe&quot; &quot;$TEMP\Uninst.exe&quot;<br />
ExecWait '&quot;$TEMP\Uninst.exe&quot; _?=$INSTDIR'<br />
<br />
<br />
so that the uninstaller doesn't keep a hold on that directory keeping me from deleting it.  Seems like it should work to me, but doesn't execute the RMDIR command still.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">16th April 2004, 22:10</div></div><div class="posttext">So the uninstaller is executed but nothing is deleted? Can you attach a minimal complete example so I can test this on my own computer and see what's wrong?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stonkers</div><div class="date">16th April 2004, 22:42</div></div><div class="posttext">This is so frustrating.  I ripped out the substance and it works fine.  I didn't change my Uninstall functionality at all.  I'm taking a break from this.  Thanks for trying!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stonkers</div><div class="date">16th April 2004, 22:50</div></div><div class="posttext">Well, one difference I found when compiling with substance vs. without substance.  When I build the one that doesn't work, I get the warnings:<br />
<br />
2 warnings:<br />
  uninstall function &quot;un.Service&quot; not referenced - zeroing code (0-278) out<br />
<br />
  install function &quot;Service&quot; not referenced - zeroing code (0-278) out<br />
<br />
<br />
Could this have something to do with it?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">16th April 2004, 22:55</div></div><div class="posttext">No, that only means those functions were not used and were therefore deleted from the output.<br />
<br />
Maybe if you can attach both the working script and the script that doesn't work I can spot the difference.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MysticHead</div><div class="date">25th February 2005, 16:44</div></div><div class="posttext">Did anything every happen with this? I'm also trying to get an unistaller to run prior to installing new (updated)files and it doesn't seem to be working. I was just curious if there was something very specific in Stonkers script, or a more general error that  might apply to my situation as well.<br />
<br />
thanks,<br />
<br />
   -marc</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">25th February 2005, 20:27</div></div><div class="posttext">As there was no other response from stonkers, the issue was never resolved. Looking at it again, it seems $INSTDIR was simply not initialized with the correct value in .onInit in his last attempt (no InstallDirRegKey in the big script above). I think his issue is pretty specific to his script. If you have a problem with calling the uninstaller, open up another thread with more details.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>