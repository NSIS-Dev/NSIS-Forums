<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Please help me with FileWrite and FileClose, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Please help me with FileWrite and FileClose NSIS Discussion" />
	
	<title> Please help me with FileWrite and FileClose [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Please help me with FileWrite and FileClose</div>
<hr />
<div class="pda"><a href="t-260829.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=260829">Please help me with FileWrite and FileClose</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">sunlight112</div><div class="date">1st December 2006, 06:32</div></div><div class="posttext">With many supporters in forum, I can run database well. However, I have one problem which I can explain why it happens. I had worked well last week. But in this week, my code run is error although I do not repair any code line in it. I do not know why!<br />
My code here:<br />
<br />
Function DropSchema<br />
   Detailprint &quot;Delete database if it exists&quot;<br />
   GetTempFileName $8<br />
   Detailprint &quot;Get Temp File Name: $8&quot;   ##C:\Document.....<br />
   StrCpy $8 &quot;drop.bat&quot;<br />
   FileOpen $9 $8 &quot;w&quot;<br />
   FileWrite $9 &quot;@echo off$\r$\n&quot;<br />
   StrCpy $7 $TEMP 2     ##C:<br />
   FileWrite $9 &quot;$7$\r$\n&quot;<br />
   FileWrite $9 &quot;mysql.exe --user=$root --password=$passroot &lt; c:\drop_db.sql$\r$\n&quot;<br />
   FileWrite $9 &quot;pause$\r$\n&quot;<br />
   FileClose $9<br />
   nsExec::exec &quot;$8&quot;<br />
   Pop $8<br />
   StrCmp $8 &quot;0&quot; 0 Error<br />
     Delete $8<br />
     Detailprint &quot;Delete database successful&quot;<br />
     Goto End<br />
   Error:<br />
      Detailprint &quot;Delete database fail&quot;<br />
      Detailprint &quot;Error: $8&quot;<br />
      MessageBox MB_OK|MB_ICONSTOP &quot;Delete database is error.$\r$\nPlease try again latter&quot;<br />
      Abort<br />
   End:<br />
FunctionEnd<br />
<br />
Section SetupSchema_RunDB<br />
   Call DropSchema<br />
   Detailprint &quot;Create database&quot;<br />
   GetTempFileName $5<br />
   Detailprint &quot;Get Temp File Name: $5&quot;   ##C:\Document.....<br />
   StrCpy $5 &quot;db.bat&quot;<br />
   FileOpen $6 $5 &quot;w&quot;<br />
   FileWrite $6 &quot;@echo off$\r$\n&quot;<br />
   StrCpy $7 $TEMP 2     ##C:<br />
   FileWrite $6 &quot;$7$\r$\n&quot;<br />
   FileWrite $6 &quot;mysql.exe --user=$root --password=$passroot &lt; c:\schema.sql$\r$\n&quot;<br />
   FileWrite $6 &quot;pause $\r$\n&quot;<br />
   FileClose $6<br />
   nsExec::exec &quot;$5&quot;<br />
   Pop $5<br />
   StrCmp $5 &quot;0&quot; 0 Error<br />
      Delete $5<br />
      Detailprint &quot;Create database successful&quot;<br />
      Goto Next<br />
   Error:<br />
      Detailprint &quot;Create database fail&quot;<br />
      Detailprint &quot;Error: $5&quot;<br />
      MessageBox MB_OK|MB_ICONSTOP &quot;Create database is error.Do you type correctly password?$\r$\nRun server will be error.Please try again latter&quot;<br />
      Goto End<br />
   Next:<br />
   Detailprint &quot;Run script&quot;<br />
   GetTempFileName $0<br />
   Detailprint &quot;Get Temp File Name: $0&quot;   ##C:\Document.....<br />
   StrCpy $0 &quot;sql.bat&quot;<br />
   FileOpen $1 $0 &quot;w&quot;<br />
   FileWrite $1 &quot;@echo off$\r$\n&quot;<br />
   StrCpy $2 $TEMP 2     ##C:<br />
   FileWrite $1 &quot;$2$\r$\n&quot;<br />
   FileWrite $1 &quot;mysql.exe OpenIM --user=$root --password=$passroot &lt; c:\openim.sql$\r$\n&quot;<br />
   FileWrite $1 &quot;pause$\r$\n&quot;<br />
   FileClose $1<br />
   nsExec::exec &quot;$0&quot;<br />
   Pop $0<br />
   StrCmp $0 &quot;0&quot; 0 lblError<br />
      Delete $0<br />
      Detailprint &quot;Run database successful&quot;<br />
      Goto End<br />
   lblError:<br />
      Detailprint &quot;Run database fail&quot;<br />
      Detailprint &quot;$0&quot;<br />
      MessageBox MB_OK|MB_ICONSTOP &quot;Run database is error.Do you type correctly password?$\r$\nRun server will be error.Please try again latter&quot;<br />
      Goto End<br />
   End:<br />
SectionEnd<br />
<br />
Now I do not explain why I run it error.<br />
I aslo compile it many times and run it again, again too much but sometime, It runs well. Sometimes, it does not run :(<br />
Somebody know please tell me why?<br />
Thank a lot,</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bholliger</div><div class="date">1st December 2006, 09:52</div></div><div class="posttext">Hi sunlight112!<br />
<br />
If there's a problem with the database, redirect the output to a file for further diagnose.<br />
<br />
<br />
mysql.exe --user=$root --password=$passroot &lt; c:\drop_db.sql &gt; c:\error.log<br />
<br />
<br />
Cheers<br />
<br />
Bruno</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">1st December 2006, 10:03</div></div><div class="posttext">Just a quick look on your script, try this, it may help,<br />
remove the line  StrCpy $8 &quot;drop.bat&quot;<br />
after FileClose use rename e.g <br />
Rename '$8' '$TEMP\drop.bat'<br />
nsExec::exec '$TEMP\drop.bat'</div></div><hr />


<div class="post"><div class="posttop"><div class="username">sunlight112</div><div class="date">4th December 2006, 02:42</div></div><div class="posttext">Thank bholliger and Red Wine a lot,<br />
I has tryed with your ideas but It still can not work well.<br />
With file error.log, after I run installer, nothing has in this file.<br />
At that time, my installer run well. It means no error but database can not be created.<br />
With this same installer, I run the same way, the first, It runs well.However,the second, it is still not to create database again( i has delete database from mysql before I install my installer again to check why it is wrong)<br />
I can not explain why sometimes it works well and sometimes it can not work.<br />
Please help me!<br />
Does my code has some problems?<br />
Please tell me if you do not clearly what I say :)<br />
Thank in advance,</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bholliger</div><div class="date">4th December 2006, 03:58</div></div><div class="posttext">Hi sunlight112!<br />
<br />
I forgot something. Maybe the STDERR stream is not included in the file. Try using 2&gt;&amp;1 as well.<br />
<br />
mysql.exe --user=$root --password=$passroot &lt; c:\drop_db.sql 2&gt;&amp;1 &gt; c:\error.log<br />
<br />
<br />
As Red Wine wrote before, I wouldn't use GetTempFileName. I'd use $TEMP\myfile.bat.<br />
<br />
Is mysql.exe in the path variable? What happens if you execute the string in the prompt?<br />
<br />
Cheers<br />
<br />
Bruno</div></div><hr />


<div class="post"><div class="posttop"><div class="username">sunlight112</div><div class="date">4th December 2006, 06:22</div></div><div class="posttext">Thank bholliger,<br />
I am sure the path variable has set. I also check my command with command line and it works well.<br />
I has changed my path to become $TEMP like this:<br />
<br />
Function DropSchema<br />
   ClearErrors<br />
   FileOpen $9 $8 &quot;w&quot;<br />
   FileWrite $9 &quot;@echo off$\r$\n&quot;<br />
   StrCpy $7 $TEMP 2     ##C:<br />
   FileWrite $9 &quot;$7$\r$\n&quot;<br />
   FileWrite $9 &quot;mysql.exe --user=$root --password=$passroot &lt; c:\drop_db.sql &gt; c:\error.log$\r$\n&quot;<br />
   FileWrite $9 &quot;pause$\r$\n&quot;<br />
   FileClose $9<br />
   Rename '$8' '$TEMP\drop.bat'<br />
   StrCpy $Variable '$TEMP\drop.bat'<br />
   nsExec::exec '$Variable'<br />
   Pop $Variable<br />
   StrCmp $Variable &quot;0&quot; 0 Error<br />
   Delete $Variable<br />
      Detailprint &quot;Delete database successful&quot;<br />
      Goto End<br />
   Error:<br />
      Detailprint &quot;Delete database fail&quot;<br />
      Detailprint &quot;Error: $Variable&quot;<br />
      MessageBox MB_OK|MB_ICONSTOP &quot;Delete database is error.$\r$\nPlease try again latter&quot;<br />
      Abort<br />
   End:<br />
FunctionEnd<br />
<br />
It still does not works although I try with your idea &quot; 2&gt;&amp;1 &quot; <br />
I try with &quot;2&gt;&amp;1&quot; logfile does not appear when I run my installer.<br />
I think my installer run unstable. But I can not repair it and make it better.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">sunlight112</div><div class="date">4th December 2006, 08:31</div></div><div class="posttext">Now I can know why my installer run is wrong<br />
It may be my error.<br />
When I create installer, I set environment after that I run database. I think it can be this problem because sometimes it does not understand path variable of mysql. So, I can be error. However, I close my installer, I run my batch file. At that time, my batch file run well. <br />
I know when I set environment variable I should restart computer. But it do it, how can I run my database for user?<br />
Somebody used to pass this problem, please help me!<br />
Your help is very useful for me!<br />
Thank a lot,</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bholliger</div><div class="date">4th December 2006, 11:36</div></div><div class="posttext">Hi sunlight112!<br />
<br />
This link [1] might help you.<br />
<br />
[1] http://dev.mysql.com/doc/refman/5.0/en/windows-start-command-line.html<br />
<br />
Cheers<br />
<br />
Bruno</div></div><hr />


<div class="post"><div class="posttop"><div class="username">sunlight112</div><div class="date">5th December 2006, 02:40</div></div><div class="posttext">Thank bholliger a lot,<br />
Now I can run my installer to create database but I am worry about root and password to run it.<br />
I allow user to type it in my installer. But I run with the wrong password, my installer still announce &quot;RUN DATABASE SUCCESSFUL&quot;<br />
<br />
   Detailprint &quot;Run script&quot;<br />
   GetTempFileName $0 $TEMP<br />
;   StrCpy $0 &quot;sql.bat&quot;<br />
   FileOpen $1 $0 &quot;w&quot;<br />
   FileWrite $1 &quot;@echo off$\r$\n&quot;<br />
   StrCpy $2 $TEMP 2     ##C:<br />
   FileWrite $1 &quot;$2$\r$\n&quot;<br />
   FileWrite $1 '&quot;$Mysql\mysql.exe&quot; --user=$root --password=$passroot -D openim&lt; &quot;$path_openim\home\database\openim.sql&quot;$\r$\n'<br />
   FileWrite $1 &quot;pause$\r$\n&quot;<br />
   FileClose $1<br />
   Rename $0 '$TEMP\run.bat'<br />
   StrCpy $9 '$TEMP\run.bat'<br />
   nsExec::exec &quot;$9&quot;<br />
   Pop $9<br />
   Detailprint &quot;$$9 : $9&quot;<br />
   StrCmp $9 &quot;0&quot; 0 lblError<br />
      Delete '$TEMP\run.bat'<br />
      Detailprint &quot;Run database successful&quot;<br />
      Goto End<br />
   lblError:<br />
      Detailprint &quot;Run database fail&quot;<br />
      Detailprint &quot;$9&quot;<br />
      MessageBox MB_OK|MB_ICONSTOP &quot;Run database is error.Do you type correctly password?$\r$\nRun server will be error.Please try again latter&quot;<br />
      Goto End<br />
   End:<br />
<br />
Almost POP $9 always give &quot;0&quot; although run database successful or fail.<br />
How can I know to run database is error if user typed wrong password and root.<br />
Please help me!<br />
Thank a lot,</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bholliger</div><div class="date">5th December 2006, 03:39</div></div><div class="posttext">Hi sunlight112!<br />
<br />
I'd use ExecWait to run mysql.exe. It allows you to get the return code of mysql.exe in a variable. I believe that you have to change the command. Instead of &quot;&lt;&quot; use -e &quot;sourcefile&quot;. Have a look at [1] for more information.<br />
<br />
Altough I can't check it, the return codes mitght be those described in [2].<br />
<br />
Due to this change you don't have to worry about writing sql files and deleting them afterwards.<br />
<br />
[1] http://dev.mysql.com/doc/refman/5.0/en/batch-mode.html<br />
[2] http://dev.mysql.com/doc/refman/5.0/en/error-messages-client.html<br />
<br />
Have fun!<br />
<br />
Cheers<br />
<br />
Bruno</div></div><hr />


<div class="post"><div class="posttop"><div class="username">sunlight112</div><div class="date">5th December 2006, 06:25</div></div><div class="posttext">Thank bholliger a million,<br />
Now my installer run well<br />
:D</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>