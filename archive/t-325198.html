<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" windows exit, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  windows exit NSIS Discussion" />
	
	<title> windows exit [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  windows exit</div>
<hr />
<div class="pda"><a href="t-325198.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=325198">windows exit</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">hnedka</div><div class="date">23rd December 2010, 22:56</div></div><div class="posttext">Hi, I'm using NSIS to make applications I use portable, but here is a problem - when I click to shutdown/restart windows and the launcher is still running (in ExecWait function, waiting for the application to exit), it exits immediately and is not given a chance to cleanup whatever is needed. How can I force Windows to wait instead, until the launcher does whatever needs to be done and exits? There must be some API or something.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">24th December 2010, 08:37</div></div><div class="posttext">http://forums.winamp.com/showthread.php?s=&amp;threadid=168092&amp;highlight=shutdown</div></div><hr />


<div class="post"><div class="posttop"><div class="username">hnedka</div><div class="date">24th December 2010, 09:14</div></div><div class="posttext">Thank you very much! ;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">hnedka</div><div class="date">24th December 2010, 22:59</div></div><div class="posttext">Unfortunately, it doesn't work. It works only when the NSIS launcher window is visible, which is not what I want. When it is in silent mode or when I hide its window using ShowWindow, it doesn't work. My system is Windows 7, btw. Any ideas? I don't want to prevent windows shutdown completely, I just want to give my portable apps few seconds to do their cleanup (currently, they get terminated immediately). One other thing that doesn't seem to work is &quot;ShutdownBlockReasonCreate&quot; API, which probably requires a visible window as well (not to mention it works only on Vista and newer).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">25th December 2010, 13:21</div></div><div class="posttext">Unless I have misunderstood your problem, it would make more sense for the program(s) you are launching to act on WM_QUERYENDSESSION and clean up accordingly. If they don't have a window then you must create one (it can be hidden).<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">hnedka</div><div class="date">25th December 2010, 20:13</div></div><div class="posttext">Modifying the launched program is not an option - after all, that's the whole point of portable launchers - to cleanup after application, that doesn't do it itself (even when it's open source, modifying it is not a good idea, because you would need to update the code everytime you download a new version + plus you would need to setup you machine for the right compiler).<br />
<br />
Anyway, I have found a partial solution and it's surprisingly simple. All that I needed to do is to create a window and now, the launcher gets 5 seconds (default Windows value, can be changed in HKEY_CURRENT_USER\Control Panel\Desktop) to cleanup, which should suffice most of the time.<br />
<br />
 System::Call `kernel32::GetModuleHandle(i 0) i.R3`<br />
 System::Call `user32::CreateWindowEx(i 0, t &quot;STATIC&quot;, t &quot;&quot;, i 0, i 0x80000000, i 0x80000000, i 0x80000000, i 0x80000000, i $HWNDPARENT, i 0, i R3, i 0) i.R1`<br />
<br />
But it would be nice to be able to control it via the message loop. Will do more experiments.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">hnedka</div><div class="date">25th December 2010, 22:55</div></div><div class="posttext">OK, this is a final solution:<br />
  System::Call `kernel32::GetModuleHandle(i 0) i.r3`<br />
  System::Call `user32::CreateWindowEx(i 0, t &quot;STATIC&quot;, t &quot;MyApp Portable Launcher&quot;, i 0, i 0, i 0, i 0, i 0, i $HWNDPARENT, i 0, i r3, i 0) i.r1`<br />
  System::Call `user32::ShutdownBlockReasonCreate(i r1, w &quot;MyApp Portable Launcher Cleanup&quot;) i.r0`<br />
<br />
The first two calls create a long (probably indefinite) block on Windows XP and older. On Vista and newer, the app would get terminated in 5 seconds. For that case, there is the call to &quot;ShutdownBlockReasonCreate&quot;, which will override that limit. This function is not present in XP and will fail there, but is not needed there anyway.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>