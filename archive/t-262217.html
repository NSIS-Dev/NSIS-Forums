<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Help with ReleaseMutex, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Help with ReleaseMutex NSIS Discussion" />
	
	<title> Help with ReleaseMutex [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Help with ReleaseMutex</div>
<hr />
<div class="pda"><a href="t-262217.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=262217">Help with ReleaseMutex</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Clammerz</div><div class="date">21st December 2006, 16:45</div></div><div class="posttext">Hi, I was wondering if anyone could advise me on how to go about using this (http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dllproc/base/releasemutex.asp) API call.<br />
<br />
BOOL WINAPI ReleaseMutex(<br />
  HANDLE hMutex<br />
);<br />
<br />
I have a macro, provided by the wiki pages:<br />
!macro MutexCheck _mutexname _outvar<br />
System::Call 'kernel32::CreateMutexA(i 0, i 0, t &quot;${_mutexname}&quot;) i .${_outvar} ?e'<br />
pop ${_outvar}<br />
!macroend<br />
<br />
Upon reading the &quot;Synchronization Object Security and Access Rights&quot; (http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dllproc/base/synchronization_object_security_and_access_rights.asp) page on MSDN, I noticed this:<br />
MUTEX_MODIFY_STATE (0x0001) 	Modify state access, which is required for the ReleaseMutex function.<br />
<br />
I need to change my macro to include this? So that the installer can modify it?<br />
<br />
I'm also not exactly sure how to get the Handle of the Mutex. I'm guessing it's not simply it's name right?<br />
<br />
The reason I want to release the Mutex, is that my installer  creates two mutex's. One identical to the game I'm trying to patch (so they cannot run the game while trying to patch), and one of it's own, so the user can't run it twice. (reason there being two is that I can set a specific message depending on what the situation is.)<br />
<br />
Anyways. At the finish page, I have the option to lauch said game I'm patching. The game won't lauch if it loads faster than the installer can close itself (almost always). So I want to release the Mutex in my Finish Page preFunction.<br />
<br />
Thank you very much for your time in reading this.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">21st December 2006, 17:09</div></div><div class="posttext">There is a plugin at wiki http://nsis.sourceforge.net/CreateMutex_plug-in that might be helpful.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Clammerz</div><div class="date">21st December 2006, 20:12</div></div><div class="posttext">Unfortunately that plug-in only deals with the creation of a mutex. Not releasing one.<br />
<br />
Maybe I wasn't direct enough in my first post, I apologise.<br />
What I am after is a basic example of how to use the ReleaseMutex (http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dllproc/base/releasemutex.asp) API call using the System plug-in. And also if I need to modify the existing Macro to allow for permissions to release it.<br />
<br />
Thank you for your assistance : )</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">21st December 2006, 20:31</div></div><div class="posttext">You're welcome!<br />
Just found this forum thread.<br />
http://forums.winamp.com/showthread.php?s=&amp;threadid=131968 <br />
I hope that should be helpful.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Clammerz</div><div class="date">22nd December 2006, 02:55</div></div><div class="posttext">Ah, I also came across that thread during my search. While it seemed promising from the title, after the user found out how to create the Mutex, they didn't bother discussing anything further on how to release it. Hee hee~<br />
<br />
I guess all the System/API guru's are on holiday at the moment? : (<br />
Oh well, I might have to remove the 'run' tickbox at the end.<br />
<br />
Thanks again for your reply.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">demiller9</div><div class="date">22nd December 2006, 05:53</div></div><div class="posttext">The MSDN page for CreateMutex (http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dllproc/base/createmutex.asp)    says the return value is the mutex handle. The macro you have is storing the handle (the return code) in _outvar, but then pops the System::Call return code from GetLastError into the same variable. I suggest changing the macro to put the handle into its own variable:<br />
<br />
!macro MutexCheck _mutexname _outvar hMutex<br />
System::Call 'kernel32::CreateMutexA(i 0, i 0, t &quot;${_mutexname}&quot;) i .${_hMutex} ?e'<br />
pop ${_outvar}<br />
!macroend<br />
<br />
And use it something like this:<br />
<br />
!insertmacro MutexCheck &quot;myMutex&quot; $0 $1<br />
intCmp $1 0 MutexError<br />
...<br />
System::Call 'kernel32::ReleaseMutexA(i $1) i.r0'<br />
IntCmp $0 0 MutexError2<br />
<br />
<br />
Don</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Mr Inches</div><div class="date">22nd December 2006, 07:01</div></div><div class="posttext">Don't forget to use CloseHandle on the mutex when you are done with it - Windows won't destroy it until all processes that have an open handle on the mutex close it. <br />
<br />
While it is true that Windows will clean up when the process exits, relying on this is really a sign of poor code; you should always clean up your own resources explicitly.<br />
<br />
Duncan</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Clammerz</div><div class="date">22nd December 2006, 10:27</div></div><div class="posttext">Thank you all very much for your replies!<br />
<br />
Here is what I have so far:<br />
Macro:<br />
!macro MutexCheck _mutexname _outvar _hMutex<br />
System::Call 'kernel32::CreateMutexA(i 0, i 0, t &quot;${_mutexname}&quot;) i .${_hMutex} ?e'<br />
pop ${_outvar}<br />
!macroend<br />
<br />
Usage:<br />
!insertmacro MutexCheck &quot;${MyMutexName}&quot; $0 $9<br />
StrCpy $MutexHandle $9<br />
StrCmp $0 0 launch<br />
  StrLen $0 &quot;$(^Name)&quot;<br />
  IntOp $0 $0 + 1<br />
 loop:<br />
   FindWindow $1 '#32770' '' 0 $1<br />
   IntCmp $1 0 +4<br />
   System::Call &quot;user32::GetWindowText(i r1, t .r2, i r0) i.&quot;<br />
   StrCmp $2 &quot;$(^Name)&quot; 0 loop<br />
   System::Call &quot;user32::SetForegroundWindow(i r1) i.&quot;<br />
   Abort<br />
 launch:<br />
<br />
Release:<br />
System::Call 'kernel32::ReleaseMutexA(i $MutexHandle) i.r0'<br />
MessageBox MB_OK &quot;Unlocked. Return: $0&quot;<br />
<br />
MessageBox is displaying &quot;Return: error&quot;<br />
Hmm, when I use...<br />
<br />
System::Call 'kernel32::CloseHandle(i $MutexHandle) i.r0'<br />
MessageBox MB_OK &quot;Unlocked. Return: $0&quot;<br />
It returns 0, but still doesn't lat me lauch.<br />
<br />
Does the loop have something to do with it?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">22nd December 2006, 12:02</div></div><div class="posttext">Your MutexCheck macro has syntax errors. i.$$0 is not a valid parameter definition for the System plug-in. You should pass i.r0 instead.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Clammerz</div><div class="date">22nd December 2006, 19:50</div></div><div class="posttext">Thanks kichik for your reply.<br />
<br />
I was wondering if you could explain a little further about my error.<br />
Sorry to say, but I'm still pretty green on the System plug-in, API calls, and the using the internal NSIS stack itself.<br />
<br />
I'm not sure how you are getting i.$$0<br />
Is that from &quot;i .${_hMutex}&quot; ?<br />
<br />
I've tried many other arrangements, and I'm still not able to get it working. I even stripped everything down to the very basics:<br />
System::Call 'kernel32::CreateMutexA(i 0, i 0, t &quot;${MyMutexName}&quot;) i.r0 ?e'<br />
Pop $0<br />
StrCpy $MutexHandle $0<br />
StrCmp $0 0 launch<br />
MessageBox MB_OK &quot;Mutant inuse&quot;<br />
   Abort<br />
  launch:<br />
MessageBox MB_OK &quot;Mutex open&quot;<br />
System::Call 'kernel32::ReleaseMutexA(i $MutexHandle) i.r0'<br />
MessageBox MB_OK &quot;Mutex released. Return: $0&quot;<br />
<br />
This is very puzzling for me, as I'm really not sure what's going on.<br />
It is returning error. Is that because I'm using invalid parameter definition?<br />
Or is it because I need to change the default security settings of the Mutext itself?<br />
<br />
Thank you again for your time.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">23rd December 2006, 03:47</div></div><div class="posttext">It was supposed to be just `i.$0`, I had a typo. System plug-in parameters are divided into three - type, input and output. When you use $0 for the output, the actual value of $0 will be copied into there and you'll eventually get something like `i.123`. This doesn't tell System where to put the value it gets, it tells it what value to put there. You must tell it in which register you want to put the value, and that can only be done with `r*`.<br />
<br />
You also have another error there, where the type is wrong. It's a pointer to an integer, not an integer. Use an asterisk before the `i`.<br />
<br />
For more information, read the System manual, it has a few step by step guides and some examples.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Clammerz</div><div class="date">23rd December 2006, 12:58</div></div><div class="posttext">Thank you kichik.<br />
<br />
I finally got it working : )<br />
<br />
Here's a snippet if anyone else is having any issues with it:<br />
!define MyMutexName &quot;MutexNameHere&quot;<br />
!macro MutexCheck _mutexname _outvar _handle<br />
System::Call 'kernel32::CreateMutexA(i 0, i 0, t &quot;${_mutexname}&quot; ) i.r1 ?e'<br />
StrCpy ${_handle} $1<br />
Pop ${_outvar}<br />
!macroend<br />
<br />
Function .onInit<br />
!insertmacro MutexCheck &quot;${MyMutexName}&quot; $0 $9<br />
StrCmp $0 0 launch<br />
  StrLen $0 &quot;$(^Name)&quot;<br />
  IntOp $0 $0 + 1<br />
 loop:<br />
   FindWindow $1 '#32770' '' 0 $1<br />
   StrCmp $1 0 +1 +2<br />
   IntOp $3 $3 + 1<br />
   IntCmp $3 3 +5<br />
   System::Call &quot;user32::GetWindowText(i r1, t .r2, i r0) i.&quot;<br />
   StrCmp $2 &quot;$(^Name)&quot; 0 loop<br />
   System::Call &quot;user32::SetForegroundWindow(i r1) i.&quot;<br />
   System::Call &quot;user32::ShowWindow(i r1,i 9) i.&quot;<br />
   Abort<br />
 launch:<br />
!insertmacro MutexCheck &quot;GameMutexHere&quot; $0 $MutexHandle<br />
StrCmp $0 0 launchB<br />
StrLen $0 &quot;GameWindowNameHere&quot;<br />
  IntOp $0 $0 + 1<br />
 loopB:<br />
   FindWindow $1 [&quot;ClassHere&quot;] [&quot;GameWindowNameHere&quot;] &quot;&quot;<br />
   IntCmp $1 0 +3<br />
   System::Call &quot;user32::GetWindowText(i r1, t .r2, i r0) i.&quot;<br />
   StrCmp $2 &quot;GameWindowNameHere&quot; 0 loopB<br />
   MessageBox MB_OK|MB_ICONEXCLAMATION &quot;Please close Game before continuing.&quot;<br />
   System::Call &quot;user32::SetForegroundWindow(i r1) i.&quot;<br />
   System::Call &quot;user32::ShowWindow(i r1,i 9) i.&quot;<br />
   Abort<br />
 launchB:<br />
FunctionEnd<br />
<br />
Function &quot;PreFinishFunc&quot; ;Finish Page 'pre_function'<br />
System::Call 'kernel32::CloseHandle(i $MutexHandle) i.'<br />
FunctionEnd<br />
<br />
Also, for some strange reason, when using FindWindow, and the '#32770' class, it was returning *every* result before my installer. Even 'console', and '0' ?<br />
So I had to put in a little counter of sorts, to let it find 0 once before skipping ahead to the abort.<br />
<br />
As you can see, I'm not the neatest, or most innovative scripter about, so don't expect anything special : P<br />
<br />
Thanks once again for everyone's help.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comm@nder21</div><div class="date">23rd December 2006, 16:08</div></div><div class="posttext">sorry, small question:<br />
what do you need &quot;ReleaseMutex&quot; for? :)<br />
<br />
i never used it, because every mutex my installers create on startup seem to be released automatically with their shutdown again.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">{_trueparuex^}</div><div class="date">23rd December 2006, 18:16</div></div><div class="posttext">Originally posted by Comm@nder21 <br />
sorry, small question:<br />
what do you need &quot;ReleaseMutex&quot; for? :)<br />
<br />
i never used it, because every mutex my installers create on startup seem to be released automatically with their shutdown again. <br />
It's in the first post. :p</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comm@nder21</div><div class="date">24th December 2006, 12:42</div></div><div class="posttext">ah, read it!<br />
sounds reasonable :)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>