<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Need another pair of eyes.., media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Need another pair of eyes.. NSIS Discussion" />
	
	<title> Need another pair of eyes.. [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Need another pair of eyes..</div>
<hr />
<div class="pda"><a href="t-271175.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=271175">Need another pair of eyes..</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">sbabineau</div><div class="date">15th May 2007, 04:18</div></div><div class="posttext">I've been racking my brain for a couple days on this one function. <br />
<br />
  The purpose is to read the file info strings from an executable (or dll, ocx, etc). Not all executables have them, but if you right-click on an executable, select Properties, then click the Version tab (if it's there) you will see the information I am trying to retrieve.<br />
<br />
  Once fixed, I think it makes a good candidate for a NSIS Example wiki page..<br />
<br />
 Anyway, I'm messing with the stack and the System plugin and it is wreaking havoc on my program throwing spurious &quot;invalid opcode&quot; and &quot;Access denied&quot; (while reading a memory address). Can someone else take a look at this with me and help me figure it out?<br />
<br />
 I think the key to fixing the problem is near the &quot;System::Call &quot;*$4(&amp;t$5 .r7)&quot;&quot; line.  When I comment that out all my problems seem to disappear.  What am I doing wrong? :mad: <br />
<br />
<br />
Var PROGRAMINFO<br />
<br />
; Call like this: <br />
; !insertmacro GetInfoFromExeHeader &quot;ProductName&quot; &quot;c:\programs\myexecutable.exe&quot;<br />
!macro GetInfoFromExeHeader DataType ProgramExe<br />
  Push ${DataType}<br />
  Push ${ProgramExe}<br />
  Call GetInfoFromExeHeader<br />
  Pop $PROGRAMINFO<br />
!macroend<br />
<br />
Function GetInfoFromExeHeader<br />
; Valid Data Types:<br />
;   ProductName<br />
;   InternalName<br />
;   ProductVersion<br />
;   SpecialBuild<br />
;   PrivateBuild<br />
;   LegalCopyright<br />
;   LegalTrademarks<br />
;   Comments<br />
;   CompanyName<br />
;   FileVersion<br />
;   FileDescription<br />
<br />
  Exch $R0 ; path to EXE<br />
  IfFileExists $R0 +4 0<br />
    MessageBox MB_OK &quot;$R0 doesn't exist! Please correct this.&quot;<br />
    Exch $R0 ; Put the path back on the stack<br />
    Return<br />
<br />
  Exch<br />
  Exch $R1 ; Data type<br />
  <br />
  Push $1<br />
  Push $2<br />
  Push $3<br />
  Push $4<br />
  Push $5<br />
  Push $6<br />
  Push $7<br />
<br />
  StrCpy $1 &quot;0&quot;<br />
  StrCpy $3 &quot;0&quot;<br />
  StrCpy $7 &quot;&quot;<br />
  StrCpy $2 &quot;0&quot;<br />
  <br />
  System::Call &quot;version::GetFileVersionInfoSize(t '$R0', t /NUL) i .r2&quot; ;returns size of version block in header<br />
  IntCmp $2 0 Done Done 0 ; $2 needs to be greater than 0<br />
    System::Call &quot;version::GetFileVersionInfo(t '$R0', i 0, i r2, *i .r3) i .r1&quot; ; returns 1 or 0 with r3 being the fileinfo struct<br />
    IntCmp $1 0 Done 0 0 ; $1 needs to be &lt;&gt; 0<br />
      System::Call &quot;version::VerQueryValue(*i r3, t '\StringFileInfo\040904E4\$R1', *i .r4, *i .r5) i .r6&quot;<br />
      IntCmp $6 0 Done 0 0 ; $6 needs to be &lt;&gt; 0<br />
        IntCmp $5 0 Done Done 0<br />
          ;IntOp $5 $5 + 1<br />
          System::Call &quot;*$4(&amp;t$5 .r7)&quot;<br />
<br />
  Done:<br />
    System::Free $R0<br />
    System::Free $R1<br />
    System::Free $1<br />
    System::Free $2<br />
    System::Free $3<br />
    System::Free $4<br />
    System::Free $5<br />
    System::Free $6<br />
<br />
    ;SetPluginUnload &quot;manual&quot;<br />
    Push $7<br />
    <br />
    Exch 9 ; put $7 on the bottom<br />
    Pop $7<br />
    Pop $6<br />
    Pop $5<br />
    Pop $4<br />
    Pop $3<br />
    Pop $2<br />
    Pop $1<br />
    Pop $R0<br />
    Pop $R1<br />
FunctionEnd<br />
<br />
<br />
  Documentation on the three version functions:<br />
<br />
GetFileVersionInfoSize: http://msdn2.microsoft.com/en-us/library/ms647005.aspx <br />
<br />
GetFileVersionInfo: http://msdn2.microsoft.com/en-us/library/ms647003.aspx<br />
<br />
VerQueryValue: http://msdn2.microsoft.com/en-us/library/ms647464.aspx<br />
<br />
-Steve.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">15th May 2007, 05:05</div></div><div class="posttext">Have you seen the MoreInfo plugin? It's so easy ;)<br />
<br />
http://nsis.sourceforge.net/MoreInfo_plug-in</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">15th May 2007, 18:36</div></div><div class="posttext">File path may contain quotes, so it's better to use R0 instead of '$R0' when passing it to System::Call. /NUL is not a valid parameter. Either use n for NULL or pass a real pointer. You must allocate a buffer for GetFileVersionInfo with System::Alloc. You just passed it pointer to an integer which it fills and then some. That's corrupting the heap.<br />
Once fixed, I think it makes a good candidate for a NSIS Example wiki page..Everything makes a good candidate for that. Feel free to create Wiki pages with what you'd consider useful information.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>