<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Upgrade_Macro Corrected, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Upgrade_Macro Corrected NSIS Discussion" />
	
	<title> Upgrade_Macro Corrected [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Upgrade_Macro Corrected</div>
<hr />
<div class="pda"><a href="t-77771.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=77771">Upgrade_Macro Corrected</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Bugge T. Jensen</div><div class="date">28th February 2002, 15:00</div></div><div class="posttext">Hi<br />
Found and corrected a bug in the Update_macro .<br />
<br />
Now it also works for changes in minor version numbers<br />
<br />
<br />
Can someone please include that in the next release....</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mmullikin</div><div class="date">31st March 2002, 17:50</div></div><div class="posttext">Here is one that combines yours with CodeSquid's and my fix that seems to do it all!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mmullikin</div><div class="date">2nd April 2002, 01:04</div></div><div class="posttext">Damn, the attachment failed. Let's try it again.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">simham_uk</div><div class="date">29th June 2002, 12:46</div></div><div class="posttext">I have part modified the already modified UpgradeDLL Macro, to add a prompt (if defined) to ask the user &quot;Do you want to overwrite this file&quot; type of thing.<br />
<br />
I've also modifed it so that the push described in usage isn't required anymore.<br />
<br />
You can now run the macro like:<br />
<br />
<br />
!insertmacro UpgradeDLL &quot;atl.dll&quot; &quot;$SYSDIR\\atl.dll&quot; &quot;PARANOID&quot;<br />
!insertmacro UpgradeDLL &quot;atl.dll&quot; &quot;$SYSDIR\\atl.dll&quot; &quot;EASYGOING&quot;<br />
<br />
<br />
The first one prompts the user, the second one doesn't.<br />
<br />
Now, it still needs work, and the reason is that I haev replaced all the $0 with ${DLL_LOCATION} for usage changes above, so since I'm not really confident working the stack, I haven't changed any other vars or the push/pop's in the macro.<br />
<br />
Perhaps someone could have a look at the attachment, and make the necessary changes.<br />
<br />
BTW, if the changes I've made are utter rubbish, please let me know!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">simham_uk</div><div class="date">29th June 2002, 12:51</div></div><div class="posttext">Just a quick query, but if this were a function would it create less bloat than being a macro.<br />
<br />
What I mean is, does the macro get inserted into the code (during compile) every time it is called?  and does this happen with functions?<br />
<br />
The reason I ask, is I'm playing with an installer that will add some 25 DLL/OCX/EXE's that I may have to run through this, so I'm just thinking of trying to keep the size down.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Sunjammer</div><div class="date">29th June 2002, 13:52</div></div><div class="posttext">Yes a macro is inserted every time it is called. You can see this if you create a simple macro that has a label in it. If you !insertmacro the simple macro twice in a row in the same scope the compiler moans about a duplicate defined label.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">simham_uk</div><div class="date">29th June 2002, 13:53</div></div><div class="posttext">I've made another modification to the macro to allow for a path to the file.<br />
<br />
The macro would now be called with:<br />
<br />
<br />
!insertmacro UpgradeDLL &quot;D:\\DEV\\Poject\\&quot; &quot;atl.dll&quot; &quot;$SYSDIR\\\atl.dll&quot; &quot;PARANOID&quot;<br />
!insertmacro UpgradeDLL &quot;D:\\\DEV\\\Poject\\\&quot; &quot;atl.dll&quot; &quot;$SYSDIR\\\atl.dll&quot; &quot;EASYGOING&quot;<br />
<br />
<br />
And the changes to the &quot;File/s&quot; are:<br />
<br />
<br />
File /oname=$5 &quot;${DLL_FILE_PATH}${DLL_NAME}&quot;<br />
; and <br />
File /oname=${DLL_LOCATION} &quot;${DLL_FILE_PATH}${DLL_NAME}&quot;<br />
<br />
<br />
I hope I aint barking up the wroong tree here, but this will make the macro more flexible regarding the location of &quot;File&quot;<br />
<br />
Does this make sense?<br />
<br />
(modified script attached)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">eccles</div><div class="date">29th June 2002, 22:51</div></div><div class="posttext">Simon,<br />
<br />
The 'GetDLLVersionLocal' and 'File' commands in there stop the whole thing being a function, as the filenames to those commands need to be fixed at script compile time, which isn't possible with something like &quot;File $1&quot;.<br />
<br />
As for $0 - you can safely just remove the &quot;Exch $0&quot; and &quot;Pop $0&quot; lines now that it is not used.<br />
<br />
Back to macro/function - everything other than the commands mentioned would be perfectly fine in a function.  Maybe things can be changed so that those bits are in a function with a small macro to perform the File commands before passing on to the function.<br />
<br />
I could have a go at doing that if you like, but you'd have to test it ;)<br />
<br />
-- <br />
Dave.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">simham_uk</div><div class="date">29th June 2002, 23:52</div></div><div class="posttext">Thanks!<br />
<br />
Testing something like this is tricky.  I test other software, and when messing with windows system files, it can get ugly...thankfully it wasn't me building the installers (IS...uggh), but we did kill a few systems!<br />
<br />
Anyhoo, I'm obviously trying to do this because I AM intending to use it, and test it of course, so I'll give it a go.<br />
<br />
What I'm essentially trying to do is build a macro that will handle all file installations, by checking versions, or file dates.<br />
<br />
I think ultimately this would be best handled in 2 separate macros, but I'm also thinking, if I can't get a version of the file, I'd like to fallback and check the date of the file.<br />
<br />
Now, its getting tricky again, and also because, if I'm replacing these system files, I want to back them up, so when I uninstall I can restore the system to its original state.<br />
<br />
I've built the backup stuff into the macro already - another define (BACKUP or NOT) - the files goto $INSTDIR\install_backup if they are replaced.<br />
<br />
So now I need a macro that will work for the uninstaller, which will firstly, check if the file that replaced the original during the install, is still the same file, and not something installed by another app since....if so, then dont restore.<br />
<br />
Then copy the files back over their replacements setting all the reg stuff and reboot flags.<br />
<br />
It's kinda like building a wrapper for installing and uninstalling files, safely, and ensuring you only install what you need...handy for online installs.<br />
<br />
BUT, when you think like that, it would be much more sensible to do to all the version/date checking first, write that info to an ini file, then check the versions of all the existing files (if any) from the INI, against another INI, containing all the info of the files your installing.  This way, if the installer IS an online installer (or not), all the operations can be grouped: FileCheck, File Copy/download, UnReg(if needed), UnRegShared(if needed), backup, FileRename, Reg(if needed), RegShared(if needed), etc.  and then in reverse for the uninstaller :-).<br />
<br />
Don't ya just love Saturday nights!! :-(<br />
<br />
I've attached what I have for now...if anyone has ideas for the above-mentioned, or the attached, please don't hold back!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">eccles</div><div class="date">30th June 2002, 00:44</div></div><div class="posttext">Here's a function-ised version, as promised.  It will certainly reduce the overhead per-dll, but there are a couple of question marks over it.  (I haven't even attempted to compile it, for one!)<br />
<br />
Now there's just one File command, which is always performed and to a temporary name.  Maybe this could be undesirable - extracting lots of DLLs which may turn out not to be needed, which are then deleted.<br />
<br />
The DLL version of the new file is now taken by using GetDLLVersion on the extracted temporary file.  I don't know if not having a .DLL extension (or whatever) will upset GetDLLVersion.  If so, I suppose the original GetDLLVersionLocal could be restored as part of the small macro stub.<br />
<br />
Anyway, see what you think.  If you do start going towards the multi-stage route you describe, I'll certainly be interested in how you get on (although I don't have to deal with DLLs in my installers) (thankfully!).<br />
<br />
-- <br />
Dave.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">simham_uk</div><div class="date">30th June 2002, 14:20</div></div><div class="posttext">Thanks!<br />
<br />
I have tried to break it up into the groups as mentioned in the previous post, and so far it looks good (I think).<br />
<br />
I have NOT tested it yet, but have attached it here to see if you can spot anything stooopid before I go any further.<br />
<br />
It looks like this is building into a nice utility!!<br />
<br />
Please have a look and let me know what you think...suggestions are very welcome!<br />
<br />
Thanks again!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">eccles</div><div class="date">30th June 2002, 15:34</div></div><div class="posttext">Ok, initial thoughts (although I've not had time to study it yet).<br />
<br />
 The !undefs are not required (which is why I removed them in the last post...)<br />
 Your concatenation of the two parts of the version number into 1 are unsafe - for one, the result may end up being a number too big for NSIS to handle (the reason they're in two parts in the first place)<br />
 Your use of the stack is a bit suspect.  :D  You should be Pushing variables before changing them, so that the Pops restore them to their original values.  If keeping variables untouched is not really a problem for you then you could maybe take out all Push/Pop/Exch, at least for now.  Nothing stopping that sort of thing being added when things have settled down.<br />
 I'm not sure what part the GetTempFileName is playing now, since your changes.  The Rename in dont_unreg could probably take the file directly from the extracted/downloaded copy in the $TEMP directory from CheckInstallMacro (or I'm just misunderstanding what the CopyFiles bit is all about...)<br />
<br />
<br />
Anyway, I've already spent more time than I was planning to for now... :p <br />
<br />
Have fun!<br />
<br />
Dave.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">simham_uk</div><div class="date">30th June 2002, 16:19</div></div><div class="posttext">Thanks once again Dave!<br />
<br />
I have removed the !undef's as suggested, and hopefully tidied up the push/pops into the right order, as well as fix some typos and bits and pieces.<br />
<br />
Regarding the version numbers, I believe these are DWORD's and 32bit, so they have a maxlength (if I'm not mistaken?), which when concatenated and added into a INI file seems to be OK from past experience using this method.<br />
<br />
The GetTempFile could probably be done away with, but may be useful for extending...who knows.  I think it should be OK as is.<br />
<br />
I've aslo made some further changes to allow definiton of the install_type, so that when calling the macro you can choose INSIDE, MEDIA, or DOWNLOAD to decide where you want to install from, and also a cleanup function.<br />
<br />
I've attached for anyone to see!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kingfishers</div><div class="date">11th August 2002, 02:21</div></div><div class="posttext">i'm a little new at this and i love this awesome tool.  but i need a little help, please.  you seem to have accomplished here just what i've been trying to figure out.  i have downloaded the file you attached here.  but i am not sure what to do with it.<br />
<br />
it looks like it needs busted into at least 2 files (.inc files).  it also looks like some of the code then goes directly in my .nsi file.<br />
<br />
where do the .inc files need to be... in the NSIS directory or in the project directory for the .nsi file?<br />
<br />
which parts of the file go where?<br />
<br />
sorry if this is mundane.  i just stumbled onto NSIS a few days ago and am trying to figure it all out on my own.<br />
<br />
thanks,<br />
kingfishers</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">11th August 2002, 11:05</div></div><div class="posttext">.inc files, or .nsh files (the extension doesn't really matter) are supposed to be included into your script using !include. When you use !include the pre-processor will just copy the file into your file. This allows you to save space and to change just one file if you find a bug.<br />
<br />
To use the macro in your script (after you have included the .inc file) just use !insertmacro like exampled above.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Sunjammer</div><div class="date">11th August 2002, 12:43</div></div><div class="posttext">Hi - what's the deal with this upgrade macro stuff, is it in a usable state? Basically if it's good and working I'd like to update the stuff on my archive site but it looks like a lot of ideas have been thrown around on this thread and I don't want to put a page up (or update existing material) if I'm not sure about (a) what this stuff is actually capable of now and (b) if it actually works.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kingfishers</div><div class="date">11th August 2002, 13:31</div></div><div class="posttext">i'm a little slow here.  i'm not sure i get it yet.<br />
<br />
which directory do the .inc files go... i think they must go in the project directory with the .nsi file.<br />
<br />
any other advice on how to use this?<br />
<br />
like... there isn't a way to define  this all once and call it generically by passing the parameter for the name of the dll to upgrade??<br />
<br />
<br />
thanks,<br />
kingfishers</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">11th August 2002, 13:40</div></div><div class="posttext">It doesn't matter where you put the file as long as you remember where you put it :D<br />
It is best to put it in the project directory because then you don't need to give the full path to it, just the relative.<br />
<br />
When a file is included it will be processed by NSIS as well so every function/macro in it will be available in your script too. All you need to do is add !insertmacro if it is a macro or Call if it is a function. See the above examples.<br />
<br />
If you still don't understand try reading the documentation of NSIS first (makensis.htm). Focus on macros and !include in the documentation. If you still don't understand after the documentation you are more than welcome to ask again.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">simham_uk</div><div class="date">11th August 2002, 16:46</div></div><div class="posttext">I have some scripts that I can contribute Sunjammer...just got to take out my progrma specific stuff.<br />
<br />
They are a bit incomplete from what I can remember as I had to give the project a back seat for the moment, but'll dig them out, and post, or email to you.<br />
<br />
Simon</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Kypec</div><div class="date">25th September 2002, 16:53</div></div><div class="posttext">Hi pals,<br />
<br />
After few days of work I put together this (see attachment).<br />
It is in general a macro but with just minimal overhead<br />
because the most of code is contained in a function.<br />
Please have a look at it and test it as much as possible.<br />
It should work with most of DLL and OCX files.<br />
You will need an external plugin &quot;x18sysinfoV0.1.dll&quot; available<br />
from Sunjammer's webpage. I'm using its GetFileVersion function <br />
because it returns the most compact file version information<br />
i.e. always (AFAIK) &quot;MAJOR.MINOR.REVISION.BUILD&quot; formatted number.<br />
Any additional work like adding and removing shared DLL's must<br />
be done separately after macro code finished.<br />
Please note that my macro uses $R0 for temporary local file so<br />
don't forget to save it's content if you need it ;) <br />
<br />
Feel free to respond or contribute to this :D</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Kypec</div><div class="date">26th September 2002, 14:36</div></div><div class="posttext">-added few lines there -&gt; now your $R0 is preserved inside the macro<br />
-added two functions+comments from other sources (AddSharedDLL,<br />
un.RemoveSharedDLL)<br />
Hope you find it helpful!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Koen van de Sande</div><div class="date">29th September 2002, 15:57</div></div><div class="posttext">This is my personal version of the UpgradeDLL macro... I made it at the same time as Kypec. However, it does not need any additional plugins like his version.<br />
Hope you like it.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">roele</div><div class="date">15th October 2002, 12:22</div></div><div class="posttext">I'm a newbie in using NSIS and wrote a simple install script which installes a ActiveX Object... now i can't get the uninstall to work cause the .dll is in use while uninstalling !!! <br />
<br />
Any tips or suggestions ?!<br />
<br />
Here's my current script</div></div><hr />


<div class="post"><div class="posttop"><div class="username">roele</div><div class="date">15th October 2002, 13:09</div></div><div class="posttext">Sorry... i found a way which seems to work ;)<br />
<br />
THX anyway.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>