<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Trying to check if program installed already, if so, warn, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Trying to check if program installed already, if so, warn NSIS Discussion" />
	
	<title> Trying to check if program installed already, if so, warn [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Trying to check if program installed already, if so, warn</div>
<hr />
<div class="pda"><a href="t-268050.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=268050">Trying to check if program installed already, if so, warn</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Zethris</div><div class="date">19th March 2007, 17:13</div></div><div class="posttext">Function ClientCheck<br />
    IfFileExists &quot;$INSTDIR\File Upload Service\File.exe&quot; warn<br />
<br />
warn:<br />
    MessageBox MB_OKCANCEL|MB_ICONSTOP &quot;You are trying to install over an existing installation \<br />
        of the Client.$\nPlease uninstall the existing version and run the installer again by \<br />
        clicking on $\&quot;Ok$\&quot; or click on $\&quot;Cancel$\&quot; to abort this installation.&quot; \<br />
    /SD IDOK IDOK  QuietUninstall IDCANCEL<br />
    Goto done<br />
    <br />
QuietUninstall:<br />
    ExecWait '&quot;$INSTDIR\uninstall.exe&quot; /S _=$INSTDIR'<br />
    Goto done<br />
<br />
done:<br />
    abort<br />
FunctionEnd<br />
<br />
The issue I am having is that whether or not it sees the file, the warning still comes up and it seems that no matter if they click on cancel, it will continue installation when I would like for it to fully abort. Then if they click on &quot;OK&quot; it will uninstall, but then continue with installation right after rather than completing the uninstall and relaunching the installer or aborting the installation totally as the current message I have says to re-launch after uninstallation. <br />
<br />
The reason for this is that the installer when on a clean install, it creates a folder and shares it on the network. Then installs a service and starts it after everything is installed. <br />
<br />
When uninstall runs, the network shared file un-shares and is deleted, then it stops and uninstalls an installed service and it will remove the remaining files after a reboot (or, at least, the files cannot be unwritten or deleted until the service has fully stopped and uninstalled and I haven't found a way to set a time delay to wait for the service to stop yet)<br />
<br />
So what happens now, if someone re-runs the installer again and goes to the point where it begins copying files to the install directory, it gets a file write error as the folder may be connected to by other computers on the network and the service is also still running. <br />
<br />
Re-Running the setup is a needed ability to both easily be able to uninstall it (for the less computer literate) and also be able to modify a configuration file using the ReplaceInFile method when a user on a custom page, which has a drop down menu, makes a particular selection then passes it to the leave page that changes the environment of the installed client.<br />
<br />
What might you recommend the approach to this might be? Am I on the right track?<br />
<br />
I am definitely newer to using NSIS, but I have been able to get a lot out of the support system here and I thank you all for that!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">19th March 2007, 17:17</div></div><div class="posttext">warn is the label just below the IfFileExists instruction so one way or another it goes there ;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Zethris</div><div class="date">19th March 2007, 17:21</div></div><div class="posttext">Function ClientCheck<br />
    IfFileExists &quot;$INSTDIR\File Upload Service\File.exe&quot; warn<br />
    Goto done<br />
warn:<br />
    MessageBox MB_OKCANCEL|MB_ICONSTOP &quot;You are trying to install over an existing installation \<br />
        of the Client.$\nPlease uninstall the existing version and run the installer again by \<br />
        clicking on $\&quot;Ok$\&quot; or click on $\&quot;Cancel$\&quot; to abort this installation.&quot; \<br />
    /SD IDOK IDOK  QuietUninstall IDCANCEL<br />
    Goto done<br />
    <br />
QuietUninstall:<br />
    ExecWait '&quot;$INSTDIR\uninstall.exe&quot; /S _=$INSTDIR'<br />
    Goto done<br />
<br />
done:<br />
    abort<br />
FunctionEnd<br />
<br />
<br />
Adding the Goto done seems to still do the same thing and not abort where appropriate. I am about one week into this and was on a roll by Friday but then the weekend happened... Seem a lot of stuff I was learning and finally understanding with how NSIS is set up kind of got mushy in my brain over the weekend. <br />
<br />
Is my approach all wrong here?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">19th March 2007, 17:27</div></div><div class="posttext">try it like this,<br />
!include &quot;LogicLib.nsh&quot;<br />
<br />
Function ClientCheck<br />
  ${If} ${FileExists} &quot;$INSTDIR\File Upload Service\File.exe&quot;<br />
<br />
    MessageBox MB_OKCANCEL|MB_ICONSTOP &quot;You are trying to install over an existing installation \<br />
        of the Client.$\nPlease uninstall the existing version and run the installer again by \<br />
        clicking on $\&quot;Ok$\&quot; or click on $\&quot;Cancel$\&quot; to abort this installation.&quot; \<br />
    /SD IDOK IDCANCEL done<br />
<br />
    ExecWait '&quot;$INSTDIR\uninstall.exe&quot; /S _=$INSTDIR'<br />
<br />
  done:<br />
    Quit<br />
<br />
  ${EndIf}<br />
FunctionEnd<br />
EDIT: Gee! sorry I didn't see it... it's Quit no abort :(</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Zethris</div><div class="date">19th March 2007, 19:01</div></div><div class="posttext">Slaps own forehead* doh! I forgot Quit too. Still this looks like a much better approach with how you have it.  <br />
<br />
That seems to work great and taught me something. Thanks. <br />
<br />
I think they need to add an extra &quot;major&quot; to your ranking to show &quot;major major dude&quot; :D<br />
<br />
One thing that this did bring up however, and maybe you might have a suggestion, is if they uninstall the software and have not yet reboot to remove the files that were previously untouchable as it was running as a service as I am sure you know windows has them on lock down. <br />
<br />
What is happening is if they uninstall the program only to just re-install it right after, it is still detecting the software as being &quot;installed&quot; because the .exe file is still there. <br />
<br />
We do need to actually still keep a semi-silent install of this software as it can be running on a server or a shared box that only can reboot at scheduled times. So a forced reboot is not going to work unfortunately.<br />
<br />
Is there a way to detect if there is a &quot;remove files after reboot&quot; flag so that at a time they might uninstall and immediately after re-install, a message pop's up to instruct them to first reboot the machine before initiating another installation and quits once they click ok? <br />
<br />
Or would you recommend rather than detecting a file like above, look for a registry entry that is more easily removable live while an uninstall is processing as apposed to a previously running service? edit: of course that still doesn't resolve the issue with the .exe file being there still, so I suspect that a reboot warning is necessary.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">19th March 2007, 19:22</div></div><div class="posttext">Is there a way to detect if there is a &quot;remove files after reboot&quot; flag so that at a time they might uninstall and immediately after re-install, a message pop's up to instruct them to first reboot the machine before initiating another installation and quits once they click ok?<br />
Regarding to the OS you should be able to check the winint.ini file (9x/Me) and the registry under HKLM &quot;SYSTEM\ControlSet#\Control\Session Manager&quot; &quot;PendingFileRenameOperations&quot; (NT).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Zethris</div><div class="date">19th March 2007, 19:41</div></div><div class="posttext">Originally posted by Red Wine <br />
Regarding to the OS you should be able to check the winint.ini file (9x/Me) and the registry under HKLM &quot;SYSTEM\ControlSet#\Control\Session Manager&quot; &quot;PendingFileRenameOperations&quot; (NT).  <br />
<br />
Yeah I think that approach would be best. Do you happen to know what the 001 and 002 under ControlSet# denotes when I looked at it under regedit? Are they for particular users? <br />
Will it matter which one I use?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">19th March 2007, 19:47</div></div><div class="posttext">You should always use CurrentControlSet which points to the currently used ControlSet and not ControlSet#. See KB100010 (http://support.microsoft.com/kb/100010) for more information about this.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">19th March 2007, 20:02</div></div><div class="posttext">Thanks kichik, :) that's so clear and easy against my method where I had to enumerate ControlSets to find the value.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Zethris</div><div class="date">19th March 2007, 20:24</div></div><div class="posttext">Aha! ok. Thanks Kichik and Red Wine!<br />
<br />
Now, the point is, is to look for the actual key of &quot;PendingFileRenameOperations&quot; and if it is not present, then continue or if it is show the warning that they must reboot first, right?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">19th March 2007, 20:34</div></div><div class="posttext">You should be able to determine, <br />
<br />
a) if exists value data, <br />
b) if the name of your exe exists in there.<br />
<br />
For b see ${StrStr} into the included StrFunc.nsh</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">19th March 2007, 20:43</div></div><div class="posttext">PendingFileRenameOperations is REG_MULTI_SZ. It's not that simple to read it. You can create a reader based on the following example:<br />
<br />
http://nsis.sourceforge.net/REG_MULTI_SZ_Reader</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">19th March 2007, 21:22</div></div><div class="posttext">This requires registry plugin,<br />
<br />
http://nsis.sourceforge.net/Registry_plug-in<br />
!define TEST_FILE &quot;File.txt&quot;<br />
<br />
outfile boo.exe<br />
<br />
!include &quot;LogicLib.nsh&quot;<br />
!include &quot;StrFunc.nsh&quot;<br />
!include &quot;Registry.nsh&quot;<br />
<br />
${StrStr}<br />
<br />
section<br />
FileOpen $0 &quot;$EXEDIR\${TEST_FILE}&quot; w<br />
Delete /rebootok &quot;$EXEDIR\${TEST_FILE}&quot;<br />
<br />
${registry::Read} &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager&quot;\<br />
 &quot;PendingFileRenameOperations&quot; $0 $1<br />
MessageBox MB_OK &quot;$0&quot;<br />
${registry::Unload}<br />
<br />
${If} $0 != &quot;&quot;<br />
<br />
StrLen $2 &quot;${TEST_FILE}&quot;<br />
${StrStr} $1 &quot;$0&quot; &quot;${TEST_FILE}&quot;<br />
StrCpy $3 $1 $2<br />
MessageBox MB_OK &quot;[$3]&quot;<br />
<br />
${AndIf} $3 == &quot;${TEST_FILE}&quot;<br />
MessageBox MB_OK &quot;please reboot&quot;<br />
<br />
${EndIf}<br />
sectionend</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Zethris</div><div class="date">19th March 2007, 21:56</div></div><div class="posttext">Thank you guys very much for your help on this.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>