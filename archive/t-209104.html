<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Problem with detecting invalid directory, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Problem with detecting invalid directory NSIS Discussion" />
	
	<title> Problem with detecting invalid directory [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Problem with detecting invalid directory</div>
<hr />
<div class="pda"><a href="t-209104.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=209104">Problem with detecting invalid directory</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">azbanu</div><div class="date">28th February 2005, 13:02</div></div><div class="posttext">Using version 2.0.b3 of NSIS and the MUI, how do I validate the installed directory and why is GetInstDirError an invalid command?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">28th February 2005, 15:06</div></div><div class="posttext">In what way do you want to validate the installation directory?<br />
<br />
Make sure you use GetInstDirError inside a Section or Function.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">1st March 2005, 18:07</div></div><div class="posttext">GetInstDirError was added in NSIS 2 RC1. It was not present in 2.0b3. To validate the installed directory, use the .onVerifyInstDir callback function.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">azbanu</div><div class="date">2nd March 2005, 14:18</div></div><div class="posttext">Hi,<br />
  <br />
Basically If a user enters an invalid directory, I want to display a message box and return back to the MUI_PAGECOMMAND_DIRECTORY page. So far,the  MUI_PAGE_CUSTOMFUNCTION_LEAVE ignores the validation funtion.<br />
<br />
...<br />
 !define MUI_DIRECTORYPAGE<br />
...<br />
<br />
!insertmacro MUI_PAGECOMMAND_LICENSE<br />
!define MUI_PAGE_CUSTOMFUNCTION_LEAVE &quot;validateDirectory&quot;<br />
!insertmacro MUI_PAGECOMMAND_DIRECTORY<br />
!insertmacro MUI_PAGECOMMAND_INSTFILES<br />
Page custom  ValidateAdminPassword<br />
!insertmacro MUI_PAGECOMMAND_FINISH<br />
<br />
...<br />
<br />
Function validateDirectory<br />
;display message box if install directory can not be         ;created  <br />
 MessageBox MB_OK|MB_ICONEXCLAMATION \<br />
   &quot;Invalid directory try again.&quot; IDOK<br />
 Abort<br />
 End:<br />
FunctionEnd<br />
<br />
How do I achieve this using version 2.0.b3 ? <br />
<br />
Thanks.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">2nd March 2005, 14:30</div></div><div class="posttext">Probably, but you really should upgrade. You might get code that works on the latest version of NSIS, but not on the older one.<br />
<br />
However, try this in your leave function:<br />
ClearErrors<br />
SetOutPath $INSTDIR<br />
IfErrors 0 +3<br />
 MessageBox ...<br />
 Abort<br />
<br />
It might not work though. Even in the latest docs it does not say under SetOutPath that the error flag is set if SetOutPath fails...<br />
<br />
Edit: A better way would be to use IfFileExists &quot;$INSTDIR\*.*&quot; +3 after SetOutPath.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">azbanu</div><div class="date">2nd March 2005, 15:29</div></div><div class="posttext">Ok, That is better. It can now detect invalid directory using IfFileExists &quot;$INSTDIR\*.*&quot; . But the back button on the MUI_PAGECOMMAND_INSTFILES page is disabled and there is no way   of going back. What do i need to do to enable it? <br />
Thanks</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">2nd March 2005, 17:18</div></div><div class="posttext">Why would you want to enable the Back button on the InstFiles page?<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">azbanu</div><div class="date">2nd March 2005, 20:00</div></div><div class="posttext">Hello, I want the back button enabled because the validation check actually takes place on the InstFile page, not on the directory page.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">2nd March 2005, 20:45</div></div><div class="posttext">You should use the code in the .onVerifyInstDir function, which is used when the user loses focus on the directory field (ie when they click next), and while browsing for a folder. Calling Abort in .onVerifyInstDir will stop the user selecting that path, and thus from continuing off the Directory page in the first place!<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">azbanu</div><div class="date">3rd March 2005, 10:14</div></div><div class="posttext">Hi,<br />
<br />
Function .onVerifyInstDir<br />
  SetOutPath $INSTDIR<br />
  IfFileExists &quot;$INSTDIR\*.*&quot; +2<br />
  Abort<br />
  End:<br />
FunctionEnd<br />
<br />
The downside of the above is that it creats a new folder every time the .onVerifyInstDir function is called. So I ends up with lots of empty folder when editing the install directory.<br />
<br />
Removing the set 'SetOutPath $INSTDIR' stops me from specifying a directory that doesn't yet exist. This  is because of the 'IfFileExists' test. <br />
<br />
What i am after is a way of dectecting if a directory path is valid.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">3rd March 2005, 14:01</div></div><div class="posttext">Ah yes, in that case, you'd have to change the code quite a bit...<br />
<br />
Function .onVerifyInstDir<br />
IfFileExists &quot;$INSTDIR\*.*&quot; 0 End<br />
Push $R0<br />
 ClearErrors<br />
 FileOpen $R0 &quot;$INSTDIR\try.tmp&quot; w<br />
 FileWrite $R0 &quot;&quot;<br />
 FileClose $R0<br />
Pop $R0<br />
 IfErrors +3<br />
  Delete &quot;$INSTDIR\try.tmp&quot;<br />
 Goto End<br />
 MessageBox MB_OK|MB_ICONEXCLAMATION &quot;Path is not writable, please enter a new path!&quot;<br />
Abort<br />
End:<br />
FunctionEnd<br />
<br />
<br />
So basically, this will write a file to the current path if the path exists to check if the path is writable. It won't try and create the path.<br />
<br />
You should use the old code from before to check if the final path is writable. You should call that code in your page's Leave function.<br />
<br />
For the latest Modern UI, you'd use:<br />
!define MUI_CUSTOMFUNCTION_LEAVE &quot;testInstDir&quot;<br />
!insertmacro MUI_PAGE_INSTFILES<br />
<br />
However, you are using an old version therefore I can't help you with setting up a Leave function.<br />
<br />
-Stu</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>