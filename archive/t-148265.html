<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Problem with InstallOptions &quot;WMCommandProc&quot;, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Problem with InstallOptions &quot;WMCommandProc&quot; NSIS Discussion" />
	
	<title> Problem with InstallOptions &quot;WMCommandProc&quot; [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Problem with InstallOptions &quot;WMCommandProc&quot;</div>
<hr />
<div class="pda"><a href="t-148265.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=148265">Problem with InstallOptions &quot;WMCommandProc&quot;</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">rsegal</div><div class="date">5th September 2003, 21:30</div></div><div class="posttext">Possibly a problem with WMCommandProc function in the InstallOptions DLL.  This is the current function.  A possible crash exists as nIdx is not checked for a value &lt; 0 before it is used which would result in an invalid array index.<br />
<br />
<br />
LRESULT WMCommandProc(HWND hWnd, UINT id, HWND hwndCtl, UINT codeNotify) {<br />
	switch (codeNotify) {<br />
		case BN_CLICKED:<br />
      {<br />
        int nIdx = FindControlIdx(id);<br />
		<br />
        if (pFields[nIdx].nType == FIELD_BROWSEBUTTON) {<br />
          int nParentIdx = pFields[nIdx].nParentIdx;<br />
          switch(pFields[nParentIdx].nType) {<br />
          case FIELD_FILEREQUEST:<br />
            BrowseForFile(nParentIdx);<br />
            break;<br />
          case FIELD_DIRREQUEST:<br />
            BrowseForFolder(nParentIdx);<br />
            break;<br />
          }<br />
          break;<br />
        } else if (pFields[nIdx].nType == FIELD_LINK) {<br />
          ShellExecute(hMainWindow, NULL, pFields[nIdx].pszState, NULL, NULL, SW_SHOWDEFAULT);<br />
        }<br />
      }<br />
			break;<br />
	}<br />
	return 0;<br />
}<br />
<br />
          <br />
        <br />
<br />
<br />
The modified version with the array bounds check,<br />
<br />
<br />
LRESULT WMCommandProc(HWND hWnd, UINT id, HWND hwndCtl, UINT codeNotify) {<br />
	switch (codeNotify) {<br />
		case BN_CLICKED:<br />
      {<br />
        int nIdx = FindControlIdx(id);<br />
		<br />
                // I only added the next two lines for some error  <br />
                // checking<br />
		if (nIdx &lt; 0)<br />
             	  break;<br />
<br />
        if (pFields[nIdx].nType == FIELD_BROWSEBUTTON) {<br />
          int nParentIdx = pFields[nIdx].nParentIdx;<br />
          switch(pFields[nParentIdx].nType) {<br />
          case FIELD_FILEREQUEST:<br />
            BrowseForFile(nParentIdx);<br />
            break;<br />
          case FIELD_DIRREQUEST:<br />
            BrowseForFolder(nParentIdx);<br />
            break;<br />
          }<br />
          break;<br />
        } else if (pFields[nIdx].nType == FIELD_LINK) {<br />
          ShellExecute(hMainWindow, NULL, pFields[nIdx].pszState, NULL, NULL, SW_SHOWDEFAULT);<br />
        }<br />
      }<br />
			break;<br />
	}<br />
	return 0;<br />
}<br />
<br />
<br />
End result, everything is super.  I do wonder why I was getting an array index less than 0 but I was.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th September 2003, 15:28</div></div><div class="posttext">Thanks, I have uploaded a version that checks the return value of FindControlIdx. I'm still waiting for Ramon to look over it to see where the problem really comes from.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">ramon18</div><div class="date">8th September 2003, 10:45</div></div><div class="posttext">Hi rsegal,<br />
<br />
Can you upload the ini file that cause this problems? thanks.<br />
The reason why I don't check the return value from FindControlIdx is to save some code bytes, so the problem should be elsewhere, just because FindControlIdx should always find the right control when receiving messages through WMCommandProc, but, hummm, I must admit parent WM_COMMAND messages are forward now to child windows if not handled by main window (ie: Back, Next, Cancel buttons), maybe the problem arise here!<br />
<br />
Perhaps, your fix is really needed there. But I want to inspect with the ini that cause the problems<br />
<br />
Ramon,<br />
cyas</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>