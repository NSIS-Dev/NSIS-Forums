<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" ReplaceOnline repeats line problem, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  ReplaceOnline repeats line problem NSIS Discussion" />
	
	<title> ReplaceOnline repeats line problem [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  ReplaceOnline repeats line problem</div>
<hr />
<div class="pda"><a href="t-303801.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=303801">ReplaceOnline repeats line problem</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">BerSerK6996</div><div class="date">5th March 2009, 18:39</div></div><div class="posttext">Hi,<br />
<br />
I'm trying to use a simple ReplaceOnLine to replace the text on 1 line from a text file.<br />
<br />
here's my code ;<br />
!include LogicLib.nsh<br />
!include TextFunc.nsh<br />
!include functions.nsh<br />
!insertmacro GetDrives<br />
!insertmacro GetTime<br />
<br />
Name &quot;add_text_file&quot;<br />
OutFile &quot;add_text_file.exe&quot;<br />
XPStyle on<br />
ShowInstDetails show<br />
InstallDir &quot;C:\&quot;<br />
<br />
Page directory<br />
Page instfiles<br />
<br />
LoadLanguageFile &quot;${NSISDIR}\Contrib\Language files\French.nlf&quot;<br />
<br />
Section &quot;&quot;;<br />
<br />
InitPluginsDir<br />
<br />
SetOutPath $INSTDIR<br />
<br />
ClearErrors<br />
Push 'test1'<br />
Push 'test2'<br />
Push 1<br />
Push &quot;C:\file.txt&quot;<br />
Call ReplaceOnLine<br />
<br />
SectionEnd<br />
<br />
Content of file.txt before ;<br />
test1<br />
<br />
Content of file.txt after ;<br />
test2test1test2test2test2test1test2test2test2test2test2test2test2test1test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test1test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2 test2test2test2test2test2test2test2test2test2test2test2test1test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2 test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test1test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2 test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2 test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2 test2test2test2test1test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2 test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2 test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2 test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2 test2test2test2test2test2test2test2test2tes <br />
<br />
Content of functions.nsh ;<br />
Function DriveType<br />
	StrCmp $9 $R0 0 +3<br />
	StrCpy $R1 $8<br />
	StrCpy $0 StopGetDrives<br />
<br />
	Push $0<br />
FunctionEnd<br />
<br />
Function ReplaceOnLine<br />
Exch $R0 ;file<br />
Exch<br />
Exch $R1 ;line<br />
Exch 2<br />
Exch $R2 ;replace with<br />
Exch 2<br />
Exch 3<br />
Exch $R3 ;string to replace<br />
Exch 3<br />
Push $R4<br />
Push $R5<br />
Push $R6<br />
Push $R7<br />
Push $R8<br />
Push $R9<br />
Push $9<br />
 FileOpen $R4 $R0 r<br />
 GetTempFileName $R5<br />
 FileOpen $R6 $R5 w<br />
Top:<br />
  FileRead $R4 $R7<br />
  IntOp $R8 $R8 + 1<br />
  StrCmp $R8 $R1 +3<br />
  FileWrite $R6 $R7<br />
  Goto Top<br />
   StrLen $9 $R3<br />
Loop_Top:<br />
   StrCpy $R8 0<br />
Loop:<br />
   IntOp $R8 $R8 - 1<br />
   StrCpy $R9 $R7 $9 $R8<br />
   StrCmp $R9 &quot;&quot; Finish<br />
   StrCmp $R9 $R3 0 Loop<br />
    StrCpy $R9 $R7 $R8<br />
    IntOp $R8 $R8 + $9<br />
    StrCpy $R7 $R7 &quot;&quot; $R8<br />
    StrCpy $R7 $R9$R2$R7<br />
;detailprint $R7<br />
    FileWrite $R6 $R7<br />
    Goto Loop_Top<br />
Finish:<br />
  ClearErrors<br />
  FileRead $R4 $R7<br />
  IfErrors +3<br />
  FileWrite $R6 $R7<br />
  Goto Finish<br />
FileClose $R4<br />
FileClose $R6<br />
SetDetailsPrint none<br />
Delete $R0<br />
Rename $R5 $R0<br />
SetDetailsPrint both<br />
Pop $9<br />
Pop $R9<br />
Pop $R8<br />
Pop $R7<br />
Pop $R6<br />
Pop $R5<br />
Pop $R4<br />
Pop $R3<br />
Pop $R2<br />
Pop $R1<br />
Pop $R0<br />
FunctionEnd<br />
<br />
Function GetServicePack<br />
	Push $R0<br />
	Push $R1<br />
 <br />
	ReadRegDWORD $R0 HKLM &quot;System\CurrentControlSet\Control\Windows&quot; &quot;CSDVersion&quot;<br />
	IntOp $R1 $R0 % 256			;get minor version<br />
	IntOp $R0 $R0 / 256			;get major version<br />
 <br />
	Exch $R1<br />
	Exch<br />
	Exch $R0<br />
FunctionEnd<br />
<br />
Function GetWindowsVersion <br />
  Push $R0<br />
  Push $R1<br />
 <br />
  ClearErrors<br />
 <br />
  ReadRegStr $R0 HKLM \<br />
  &quot;SOFTWARE\Microsoft\Windows NT\CurrentVersion&quot; CurrentVersion<br />
 <br />
  IfErrors 0 lbl_winnt<br />
  <br />
  ; we are not NT<br />
  ReadRegStr $R0 HKLM \<br />
  &quot;SOFTWARE\Microsoft\Windows\CurrentVersion&quot; VersionNumber<br />
 <br />
  StrCpy $R1 $R0 1<br />
  StrCmp $R1 '4' 0 lbl_error<br />
 <br />
  StrCpy $R1 $R0 3<br />
 <br />
  StrCmp $R1 '4.0' lbl_win32_95<br />
  StrCmp $R1 '4.9' lbl_win32_ME lbl_win32_98<br />
 <br />
  lbl_win32_95:<br />
    StrCpy $R0 '95'<br />
  Goto lbl_done<br />
 <br />
  lbl_win32_98:<br />
    StrCpy $R0 '98'<br />
  Goto lbl_done<br />
 <br />
  lbl_win32_ME:<br />
    StrCpy $R0 'ME'<br />
  Goto lbl_done<br />
 <br />
  lbl_winnt:<br />
 <br />
  StrCpy $R1 $R0 1<br />
 <br />
  StrCmp $R1 '3' lbl_winnt_x<br />
  StrCmp $R1 '4' lbl_winnt_x<br />
 <br />
  StrCpy $R1 $R0 3<br />
 <br />
  StrCmp $R1 '5.0' lbl_winnt_2000<br />
  StrCmp $R1 '5.1' lbl_winnt_XP<br />
  StrCmp $R1 '5.2' lbl_winnt_2003<br />
  StrCmp $R1 '6.0' lbl_winnt_vista lbl_error<br />
 <br />
  lbl_winnt_x:<br />
    ;StrCpy $R0 &quot;NT $R0&quot; 6<br />
    StrCpy $R0 'NT'<br />
  Goto lbl_done<br />
 <br />
  lbl_winnt_2000:<br />
    Strcpy $R0 '2000'<br />
  Goto lbl_done<br />
 <br />
  lbl_winnt_XP:<br />
    Strcpy $R0 'XP'<br />
  Goto lbl_done<br />
 <br />
  lbl_winnt_2003:<br />
    Strcpy $R0 '2003'<br />
  Goto lbl_done<br />
 <br />
  lbl_winnt_vista:<br />
    Strcpy $R0 'Vista'<br />
  Goto lbl_done<br />
 <br />
  lbl_error:<br />
    Strcpy $R0 ''<br />
  lbl_done:<br />
 <br />
  Pop $R1<br />
  Exch $R0<br />
FunctionEnd<br />
<br />
Function FileSearch<br />
Exch $R0 ;search for<br />
Exch<br />
Exch $R1 ;input file<br />
Push $R2<br />
Push $R3<br />
Push $R4<br />
Push $R5<br />
Push $R6<br />
Push $R7<br />
Push $R8<br />
Push $R9<br />
 <br />
  StrLen $R4 $R0<br />
  StrCpy $R7 0<br />
  StrCpy $R8 0<br />
 <br />
  ClearErrors<br />
  FileOpen $R2 $R1 r<br />
  IfErrors Done<br />
 <br />
  LoopRead:<br />
    ClearErrors<br />
    FileRead $R2 $R3<br />
    IfErrors DoneRead<br />
 <br />
    IntOp $R7 $R7 + 1<br />
    StrCpy $R5 -1<br />
    StrCpy $R9 0<br />
 <br />
    LoopParse:<br />
      IntOp $R5 $R5 + 1<br />
      StrCpy $R6 $R3 $R4 $R5<br />
      StrCmp $R6 &quot;&quot; 0 +4<br />
        StrCmp $R9 1 LoopRead<br />
          IntOp $R7 $R7 - 1<br />
          Goto LoopRead<br />
      StrCmp $R6 $R0 0 LoopParse<br />
        StrCpy $R9 1<br />
        IntOp $R8 $R8 + 1<br />
        Goto LoopParse<br />
 <br />
  DoneRead:<br />
    FileClose $R2<br />
  Done:<br />
    StrCpy $R0 $R8<br />
    StrCpy $R1 $R7<br />
 <br />
Pop $R9<br />
Pop $R8<br />
Pop $R7<br />
Pop $R6<br />
Pop $R5<br />
Pop $R4<br />
Pop $R3<br />
Pop $R2<br />
Exch $R1 ;number of lines found on<br />
Exch<br />
Exch $R0 ;output count found<br />
FunctionEnd<br />
<br />
<br />
ANY help would be greatly appreciated!<br />
<br />
Thanks</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bubustoober</div><div class="date">5th May 2009, 11:03</div></div><div class="posttext">I just went through a similar problem in using ReplaceOnLine. Ultimately I realized that ReplaceOnLine's usage of memory registers was stepping on (or being stepped on by) my usage of memory registers. I'm no expert at NSIS, but I suggest you check your memory usage very carefully. <br />
<br />
I was getting output that was repeating itself in various shapes... <br />
<br />
pre-execution file contents:<br />
line 1: blah blah<br />
line 2: original content<br />
line 3: <br />
<br />
     Push &quot;original content&quot;<br />
     Push &quot;replacement&quot;<br />
     Push 2<br />
     Push &quot;some\path\file.txt&quot;<br />
     Call ReplaceOnLine<br />
<br />
post-execution file contents:<br />
<br />
line 1: blah blah<br />
line 2: replacement replacement<br />
line 3: replacement replacement replacement<br />
line 4: replacement replacement replacement replacement<br />
etc.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">BerSerK6996</div><div class="date">5th May 2009, 12:55</div></div><div class="posttext">ok thanks, I'll look into it.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>