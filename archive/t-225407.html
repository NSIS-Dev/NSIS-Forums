<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Invoking RAPI functions with System.dll, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Invoking RAPI functions with System.dll NSIS Discussion" />
	
	<title> Invoking RAPI functions with System.dll [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Invoking RAPI functions with System.dll</div>
<hr />
<div class="pda"><a href="t-225407.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=225407">Invoking RAPI functions with System.dll</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">gurrie</div><div class="date">7th September 2005, 15:53</div></div><div class="posttext">Hi,<br />
<br />
I am trying to copy a text file containing program settings to a Pocket PC device using RAPI. My problem is that nothing seems to work when I invoke the call. The script I am executing is below :<br />
<br />
File C:\WINDOWS\system32\rapi.dll     ; copy dll there<br />
<br />
  StrCpy $0 &quot;$INSTDIR\swanRDASetup.txt\0&quot;<br />
  StrCpy $1 &quot;\My Documents\swanRDASetup.txt\0&quot;<br />
  StrCpy $2 FALSE<br />
  System::Call 'rapi.dll::CeCopyFile(*l r0, *l r1, b r2) b .r3'<br />
  DetailPrint 'Return Value: &quot;$3&quot;'<br />
<br />
System::Free 0<br />
<br />
Is this the correct way to do this? The file is never copied across to the PDA and the return value is always empty! Is there an easier way to do this? Any help would be HUGELY appreciated!<br />
<br />
Thanks in advance<br />
<br />
Brian</div></div><hr />


<div class="post"><div class="posttop"><div class="username">gurrie</div><div class="date">7th September 2005, 17:53</div></div><div class="posttext">BTW I realized that I needed to call   System::Call 'rapi.dll::CeRapiInit() i r0'<br />
 before the CeCopyFile call, however it still doesn't work! <br />
<br />
But this brings up another problem, in that the value returned from CeRapiInit is a HRESULT and I am not sure what type to map this to in NSIS?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">KrYpT</div><div class="date">7th September 2005, 22:23</div></div><div class="posttext">Try this:<br />
<br />
<br />
System::Call &quot;rapi::CeRapiInit() i .r0&quot;<br />
System::Call &quot;rapi::CeCopyFile(t '$INSTDIR\swanRDASetup.txt', \<br />
  t '\My Documents\swanRDASetup.txt', i 0) b .r0&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">gurrie</div><div class="date">9th September 2005, 09:47</div></div><div class="posttext">Hi Guys, <br />
<br />
I figured out that what I was trying to do was completely wrong. The CeCopyFile procedure only copies a file from one place to another ON the PDA, not from the desktop to the PDA. The documentation on this procedure is not very clear. The correct way to copy a file from the PC to the PDA is as follows :<br />
<br />
Function createSettingsFile<br />
;Init RAPI<br />
<br />
;----------------------<br />
;Dll Call Structure<br />
;<br />
;HRESULT CeRapiInit(void);<br />
System::Call &quot;rapi::CeRapiInit() i .r0&quot;<br />
<br />
;Create the file on the PDA<br />
<br />
;----------------------<br />
;Dll Call Structure<br />
;<br />
;HANDLE CeCreateFile(<br />
;  LPCWSTR lpFileName,<br />
;  DWORD dwDesiredAccess,<br />
;  DWORD dwShareMode,<br />
;  LPSECURITY_ATTRIBUTES lpSecurityAttributes,<br />
;  DWORD dwCreationDisposition,<br />
;  DWORD dwFlagsAndAttributes,<br />
;  HANDLE hTemplateFile<br />
;);<br />
;<br />
; Access Mode Values :<br />
;       GENERIC_READ = 0x80000000;<br />
;       GENERIC_WRITE = 0x40000000;<br />
;<br />
; Creation Disposition Value :<br />
;	CREATE_NEW = 1;<br />
;	CREATE_ALWAYS = 2;<br />
;	OPEN_EXISTING = 3;	<br />
;<br />
; Flag and attribute values<br />
;	FILE_ATTRIBUTE_NORMAL = 0x80;<br />
;	FILE_ATTRIBUTE_DIRECTORY = 0x10;<br />
;	FILE_ATTRIBUTE_TEMPORARY = 0x100;<br />
<br />
System::Call &quot;rapi::CeCreateFile(w '\swanRDASetup.txt', \<br />
                                 i 0x80000000|0x40000000, \<br />
                                 i 0, i 0, i 2, \<br />
                                 i 0x80, i 0) i .r10&quot;<br />
<br />
;Write your data across. Can be done in a loop etc.<br />
StrCpy $1 'blah=$0$\r$\n'<br />
StrLen $2 $1<br />
<br />
;----------------------<br />
;Dll Call Structure<br />
;<br />
;BOOL CeWriteFile(<br />
;  HANDLE hFile,<br />
;  LPCVOID lpBuffer,<br />
;  DWORD nNumberOfBytesToWrite,<br />
;  LPDWORD lpNumberOfBytesWritten,<br />
;  LPOVERLAPPED lpOverlapped<br />
;);<br />
System::Call &quot;rapi::CeWriteFile(i r10., t r1, i r2, i 0, i 0) i .r11&quot;<br />
<br />
;----------------------<br />
;Dll Call Structure<br />
;<br />
;BOOL CeCloseHandle( <br />
;  HANDLE hObject<br />
;); <br />
<br />
;Close the file on the PDA<br />
System::Call &quot;rapi::CeCloseHandle(i r10) i .r1&quot;<br />
<br />
 System::Free 0<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">ezequiel.aceto</div><div class="date">24th August 2006, 16:49</div></div><div class="posttext">Hello,<br />
<br />
I have seen the example on NSIS Web site about copyng file to PDA. My problem is that I would like to create a directory and, eventhough I have modified that example, I cannot reach out this. <br />
May somebody guide me? I would like to create, and delete directories, or maybe move it, and also files, from the installer.<br />
<br />
Thanks very much.<br />
Ezequiel.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">ezequiel.aceto</div><div class="date">24th August 2006, 17:01</div></div><div class="posttext">also... Is it possible in the function described by Gurrie to &quot;pass&quot; the file name of the file to create, as a parameter? Because there it's hardcoded.<br />
Thanks!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">gurrie</div><div class="date">11th September 2006, 10:43</div></div><div class="posttext">I would recommend reading the RAPI documentation, which can be found here.<br />
<br />
http://msdn.microsoft.com/library/default.asp?url=/library/en-us/wceappenduser5/html/wce50grfRemoteApplicationProgrammingInterfaceRAPIReference.asp</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Okyn</div><div class="date">16th July 2007, 10:33</div></div><div class="posttext">I wanted to know if someone finally found the answer, bcause I need to make an installer which unzip a ZIP file on the PDA SDCard, and then run a CAB file.<br />
<br />
So, can anyone tell me where to find the path to the memory card from the Desktop ?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">16th July 2007, 19:11</div></div><div class="posttext">There are few relevant articles in the wiki. They're all under the PDA category.<br />
<br />
http://nsis.sourceforge.net/Category:PDA_Examples</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Okyn</div><div class="date">17th July 2007, 11:22</div></div><div class="posttext">I already read those articles, but they did not answer that kind of problem.<br />
<br />
To have the path from the desktop to the PDA, I try to do :<br />
${registry::Open} &quot;HKCU\Software\Microsoft\Windows CE Services\Partners&quot; &quot;/V=0 /N=PnPDeviceId /T=REG_SZ /B=2&quot; $R0<br />
${registry::Find} &quot;$R0&quot; $n1 $n2 $n3 $n4<br />
${Do}<br />
${registry::Find} &quot;$R0&quot; $n1 $n2 $n3 $n4<br />
${If} $n4 == BANNER<br />
	${ExitDo}<br />
${EndIf}<br />
${Loop}<br />
${registry::Read} &quot;HKCU\$n1&quot; &quot;PnPDeviceId&quot; $R1 $R2<br />
StrCpy $PDALocation $R1<br />
${registry::Unload}<br />
<br />
It seems to work, but the path returned do not work in the script however it works when I use it in the explorer.<br />
<br />
And when I try examples given on the wiki, it does not work at all... :cry: <br />
<br />
Has anybody an idea ?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Okyn</div><div class="date">17th July 2007, 16:24</div></div><div class="posttext">Do not consider my previous post.<br />
<br />
The fact is I do not know how work RAPI...<br />
<br />
I try to create some directory, but it does not work.<br />
<br />
System::Call &quot;rapi::CeCreateDirectory(t '\$CeSDCardLocation\My Folder', i 0) i.r0&quot; <br />
<br />
When I try to copy a file with the code given on the wiki, I think I do not know how to make a loop to copy all data...<br />
<br />
<br />
  ${Do}<br />
  FileRead $0 $1<br />
  ${If} $1 == &quot;&quot;<br />
    ${ExitDo}<br />
  ${EndIf}<br />
  ;Get the length of the string read<br />
  StrLen $2 $1<br />
  System::Call &quot;rapi::CeWriteFile(i r0., t r1, i r2, i 0, i 0) i .r0&quot;<br />
  ${Loop} <br />
<br />
I am sure all the file is read (I used MessageBox to verify $1 ^^)<br />
<br />
Do anybody see any error ?<br />
Is there any link to learn how to use RAPI with NSIS ?<br />
<br />
And I would like to know why a simple CeCopyFile does not work ?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">17th July 2007, 17:53</div></div><div class="posttext">I don't get from your code if $0 is a handle to a file on the PC or on the PDA. You use it for both set of functions. There's an example in the wiki (http://nsis.sourceforge.net/Copying_files_to_pda) which writes files to the PDA and also an example (http://nsis.sourceforge.net/Pocket_PC_Installer_Using_ActiveSync) that installs a program using a CAB.<br />
<br />
As far as I know, that's the information available on RAPI. If those aren't enough, it'd be nice if you can create a new page with more details once you get a working example.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>