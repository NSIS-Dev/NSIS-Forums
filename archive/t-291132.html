<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Newbie Help With Updater Code, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Newbie Help With Updater Code NSIS Discussion" />
	
	<title> Newbie Help With Updater Code [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Newbie Help With Updater Code</div>
<hr />
<div class="pda"><a href="t-291132.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=291132">Newbie Help With Updater Code</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">grendell2099</div><div class="date">1st May 2008, 17:54</div></div><div class="posttext">Hi all, I am working on my first NSIS updater project and need some help. I am trying to create an updater that compares an ini file on our internal web site (â€œupdateâ€) with a shared user local ini file (â€œinstallâ€). If the update version is higher than the install, it will download the specified file to the userâ€™s folder &amp; edit the version number in the install ini. After checking for/ downloading the updates, it will open the â€œapplicationâ€.<br />
   So, I found a great example here that would loop through each line in an ini file and return the section, key, and value and then tried to add my code:<br />
    First, I wanted to be able to prevent users from opening the â€œappâ€ in case I needed to do some maintenance on the system. So the updater should look at the â€œlockoutâ€ key first and either exit or continue on. This seems to work fine.<br />
     Next I wanted it to search for users computer name in the update file (the â€œappâ€ has several files housed on a share drive and one file that sits on the users C drive) and update that if necessary. This also seems to work fine.<br />
After that, it should loop through all of the entries in the [Files] section, compare to the install ini, and update if necessary. This is where I am stuck.<br />
    I have tested the individual pieces and they seem to work, but I am clearly missing something when it comes to stitching it all together. It fails at the â€œReadINIFileKeysâ€ section. I do not think I am handling/passing my variables correctly- but I cannot figure it out. Below is the code- I would greatly appreciate any input.<br />
<br />
THE CODE:<br />
OutFile &quot;LOOP_TEST.exe&quot;<br />
SilentInstall silent<br />
<br />
Var Ufile ;update ini file on sharepoint ($R0)<br />
Var Ifile ;install ini file installed on F drive ($R1)<br />
Var Usection ;section header of update ini file ($Usection)<br />
Var Ukey ;key of update ini file ($R4)<br />
Var Uval ;key value of update ini file ($R5)<br />
Var LockOutSetting<br />
Var LockoutMsg ;lockout message from update ini file<br />
Var UserName ;user computer name<br />
Var Uversion ;front end version in update ini<br />
Var Iversion ;front end version in install ini<br />
Var UPath ;path to update file location on sharepoint<br />
Var DPath ;path to download the update file to<br />
Var MyFileName ;name of file to download<br />
<br />
Function .onInit<br />
#-------Start New Code Added By Me-------------	<br />
	#get computer name<br />
	ReadRegStr $UserName HKLM &quot;System\CurrentControlSet\Control\ComputerName\ActiveComputerName&quot; &quot;ComputerName&quot;<br />
	#MessageBox MB_OK &quot;$UserName&quot;<br />
	StrCpy $Ufile &quot;R:\SANDBOX\NSIS\METACupdate.ini&quot;<br />
	StrCpy $Ifile &quot;R:\SANDBOX\NSIS\METACinstall.ini&quot;<br />
	;check to see if system is locked out<br />
	ReadINIStr $LockOutSetting $Ufile &quot;Settings&quot; &quot;LockOut&quot;<br />
	StrCmp $LockOutSetting &quot;yes&quot; LockedOut NotLockedOut<br />
LockedOut:<br />
	ReadINIStr $LockOutMsg $Ufile &quot;Settings&quot; &quot;LockOutMsg&quot;<br />
	MessageBox MB_OK &quot;$LockOutMsg&quot;<br />
	abort <br />
NotLockedOut:<br />
	MessageBox MB_OK &quot;Not Locked Out&quot;<br />
	;check the computers version number- if computer name isn't found, close<br />
	ReadINIStr $Uversion $Ufile &quot;Files&quot; $UserName <br />
	StrCmp $Uversion &quot;&quot; &quot;&quot; FoundIt<br />
	MessageBox MB_OK &quot;Could not identify computer- application will close&quot;<br />
	abort <br />
FoundIt: ;compare the version numbers<br />
	MessageBox MB_OK &quot;Found Uversion&quot;<br />
	ReadINIStr $Iversion $Ifile &quot;Files&quot; $UserName <br />
	StrCmp $Uversion $Iversion NoUpdate GetUpdate<br />
GetUpdate:<br />
	StrCpy $Ukey $UserName<br />
	StrCpy $MyFileName &quot;mylicense.txt&quot;<br />
	call DownloadUpdate <br />
	WriteINIStr $Ifile &quot;Files&quot; $UserName $Uversion<br />
	;abort<br />
NoUpdate:	<br />
<br />
MessageBox MB_OK &quot;Before ReadINIFileKeys loop: Usection= $Usection : Ukey= $Ukey : Uval= $Uval&quot;<br />
#----End New Code Added by Me---------------------	<br />
	Call ReadINIFileKeys<br />
	<br />
FunctionEnd<br />
Function StrTrimNewlines<br />
  Exch $Ufile<br />
  Push $Ifile<br />
  Push $R2<br />
  StrCpy $Ifile 0<br />
<br />
 loop:<br />
  IntOp $Ifile $Ifile - 1<br />
  StrCpy $R2 $Ufile 1 $Ifile<br />
  StrCmp $R2 &quot;$\r&quot; loop<br />
  StrCmp $R2 &quot;$\n&quot; loop<br />
  <br />
  IntOp $Ifile $Ifile + 1<br />
  IntCmp $Ifile 0 no_trim_needed<br />
  StrCpy $Ufile $Ufile $Ifile<br />
<br />
 no_trim_needed:<br />
  Pop $R2<br />
  Pop $Ifile<br />
  Exch $Ufile<br />
 FunctionEnd<br />
<br />
 Function SplitFirstStrPart<br />
  Exch $Ufile<br />
  Push $Ifile<br />
  Push $R2<br />
  StrLen $Ifile $Ufile<br />
  IntOp $Ifile $Ifile + 1<br />
  loop:<br />
    IntOp $Ifile $Ifile - 1<br />
    StrCpy $R2 $Ufile 1 -$Ifile<br />
    StrCmp $Ifile 0 exit0<br />
    StrCmp $R2 &quot;=&quot; exit1 loop ; Change &quot; &quot; to &quot;\&quot; if str=dirpath<br />
  exit0:<br />
  StrCpy $Ifile &quot;&quot;<br />
  Goto exit2<br />
  exit1:<br />
    IntOp $Ifile $Ifile - 1<br />
    StrCpy $R2 $Ufile &quot;&quot; -$Ifile<br />
    IntOp $Ifile $Ifile + 1<br />
    StrCpy $Ufile $Ufile -$Ifile<br />
    StrCpy $Ifile $R2<br />
  exit2:<br />
  Pop $R2<br />
  Exch $Ifile ;rest<br />
  Exch<br />
  Exch $Ufile ;first<br />
 FunctionEnd<br />
Function ReadINIFileKeys<br />
      Exch $Ifile ;INI file to write<br />
      Exch<br />
      Exch $Ufile ;INI file to read<br />
      Push $R2<br />
      Push $R3<br />
      Push $Ukey ;uni var<br />
      Push $Uval ;uni var<br />
      Push $Usection ;last INI section<br />
 <br />
      FileOpen $R2 $Ufile r<br />
 <br />
      Loop:<br />
       FileRead $R2 $R3   ;get next line into R3<br />
       IfErrors Exit<br />
 <br />
       Push $R3<br />
        Call StrTrimNewLines <br />
		#Call TrimNewLines<br />
       Pop $R3<br />
 <br />
       StrCmp $R3 &quot;&quot; Loop   ;if blank line, skip<br />
       <br />
       StrCpy $Ukey $R3 1   ;get first char into R4<br />
       StrCmp $Ukey &quot;;&quot; Loop   ;check it for semicolon and skip line if so(ini comment)<br />
 <br />
       StrCpy $Ukey $R3 &quot;&quot; -1   ;get last char of line into R4<br />
       StrCmp $Ukey &quot;]&quot; 0 +6     ;if last char is ], parse section name, else jump to parse key/value<br />
       StrCpy $Usection $R3 -1   ;get all except last char<br />
       StrLen $Ukey $Usection     ;get str length<br />
       IntOp $Ukey $Ukey - 1    ;subtract one from length<br />
       StrCpy $Usection $Usection &quot;&quot; -$Ukey   ;copy all but first char to trim leading [, placing the section name in R6<br />
      Goto Loop<br />
       <br />
       Push &quot;=&quot;  ;push delimiting char<br />
       Push $R3<br />
        Call SplitFirstStrPart<br />
       Pop $Ukey<br />
       Pop $Uval       <br />
     <br />
#---------------Start New Code Added By Me-----------	 <br />
		MessageBox MB_OK &quot;Usection= $Usection : Ukey= $Ukey : Uval= $Uval&quot;<br />
<br />
	StrCmp $Usection &quot;Settings&quot; NoUpdateA NotSettings ;already checked the settings section, so skip here<br />
NotSettings:<br />
	MessageBox MB_OK &quot;NotSettings&quot;<br />
	StrCmp $Usection &quot;FilePaths&quot; exit NotFilePaths	;stop when loop gets to the filepaths section<br />
NotFilePaths:	<br />
	MessageBox MB_OK &quot;NotFilePaths&quot;<br />
	MessageBox MB_OK &quot;Updateversion= $Uval&quot;<br />
	;get the install file version number for Ukey<br />
	ReadINIStr $Iversion $Ifile $Usection $Ukey <br />
	MessageBox MB_OK &quot;Ifile= $Ifile: Usection= $Usection: Ukey= $Ukey: Iversion= $Iversion&quot;<br />
	;compare the install version number to the update version number<br />
	StrCmp $Uversion $Iversion NoUpdateA GetUpdateA<br />
GetUpdateA:<br />
	StrCpy $MyFileName $Ukey <br />
	Call DownloadUpdate<br />
NoUpdateA:<br />
	 <br />
#---------------End New Code Added By Me-----------------<br />
      Goto Loop<br />
      Exit:<br />
      FileClose $R2<br />
      Pop $Usection<br />
      Pop $Uval<br />
      Pop $Ukey<br />
      Pop $R3<br />
      Pop $R2<br />
      Pop $Ufile<br />
      Pop $Ifile<br />
	  <br />
	#launch the front end<br />
	execshell &quot;&quot; &quot;R:\SANDBOX\NSIS\MAIN_APP.txt&quot;<br />
Quit<br />
FunctionEnd<br />
<br />
Function DownloadUpdate ;NEW FUNCTION ADDED BY ME<br />
	StrCpy $UPath &quot;http://sharepoint/cross-functional/H2QCE/interior/Site%20Appearance/Forms/AllItems.aspx?RootFolder=%2fcross%2dfunctional%2fH2QCE%2finterior%2fSite%20Appearance%2fMETAC&amp;View=%7bFB5ABE34%2d4B2C%2d475C%2d80A2%2dFC460C24D942%7d/&quot; ;DOWNLOAD_TEST_FILE.TXT&quot; &quot;$5\DOWNLOAD_TEST_FILE.TXT&quot;<br />
	ReadINIStr $Dpath $Ufile &quot;Filepaths&quot; $Ukey<br />
	MessageBox MB_OK &quot;download from: $Upath$MyFileName&quot;<br />
	MessageBox MB_OK &quot;download to: $Dpath$MyFileName&quot;<br />
	#InetLoad::load /POPUP &quot;Front End Software Update&quot; &quot;http://sharepoint/cross-functional/H2QCE/interior/Site%20Appearance/Forms/AllItems.aspx?RootFolder=%2fcross%2dfunctional%2fH2QCE%2finterior%2fSite%20Appearance%2fMETAC&amp;View=%7bFB5ABE34%2d4B2C%2d475C%2d80A2%2dFC460C24D942%7d/DOWNLOAD_TEST_FILE.TXT&quot; &quot;$5\DOWNLOAD_TEST_FILE.TXT&quot;<br />
	InetLoad::load /POPUP &quot;Front End Software Update&quot; &quot;$Upath$MyFileName&quot; &quot;$Dpath$MyFileName&quot;<br />
	Pop $9 # return value = exit code, &quot;OK&quot; if OK<br />
    MessageBox MB_OK &quot;Download Status: $9&quot;<br />
FunctionEnd<br />
<br />
# default section start; every NSIS script has at least one section.<br />
section &quot;dummy&quot;	<br />
 <br />
# default section end<br />
sectionEnd<br />
AutoCloseWindow true</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>