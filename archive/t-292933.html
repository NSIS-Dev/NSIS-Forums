<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" GetWindowsVersion does not work!, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  GetWindowsVersion does not work! NSIS Discussion" />
	
	<title> GetWindowsVersion does not work! [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  GetWindowsVersion does not work!</div>
<hr />
<div class="pda"><a href="t-292933.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=292933">GetWindowsVersion does not work!</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">richiebabes</div><div class="date">9th June 2008, 19:36</div></div><div class="posttext">I added this to my NSIS script:<br />
<br />
Call GetWindowsVersion<br />
Pop $R0<br />
<br />
When I ran the script I got the following error:<br />
<br />
Error: command Call not valid outside Section or Function<br />
Error in script &quot;C:\aasource\32 bit apps\7.3 trunk\client install\Install Script.nsi&quot; on line 22 -- aborting creation process<br />
<br />
Not sure what to do. I have JUST begun using NSIS.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comperio</div><div class="date">9th June 2008, 19:52</div></div><div class="posttext">Just as the error says, you can't call functions from outside a function or section.<br />
<br />
Place your code inside a section or function.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">richiebabes</div><div class="date">9th June 2008, 21:17</div></div><div class="posttext">I put it inside a section and it said I couldn't use INSTDIR inside a section! If I put it inside a function don't I still need to use CALL to call the function?<br />
<br />
Help!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">richiebabes</div><div class="date">9th June 2008, 21:44</div></div><div class="posttext">I was getting errors from this:<br />
<br />
;Default installation folder<br />
  ; RGM 20080606 check for Vista first<br />
Section &quot;Install Path&quot;<br />
  Call GetWindowsVersion<br />
  Pop $R0<br />
SectionEnd<br />
  <br />
  ${If} $R0 == &quot;Vista&quot;<br />
  InstallDir &quot;blah&quot;<br />
  ${Else}<br />
  InstallDir &quot;blah&quot;<br />
  ${EndIf}</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comperio</div><div class="date">9th June 2008, 21:58</div></div><div class="posttext">Call can only be used inside a function/section, whereas InstallDir can only be used outside a function/section.<br />
<br />
If you want to set $INSTDIR from within a section or function, just set it using StrCpy to set.<br />
<br />
BTW:  You say you want to set the default install directory, but you are doing this within a section.  It'd probably be better to do this in the .onInit function so that it's set BEFORE you display the directory page to the user.<br />
<br />
Example:<br />
Function .onInit<br />
 &quot;Install Path&quot;<br />
  Call GetWindowsVersion<br />
  Pop $R0<br />
<br />
  ${If} $R0 == &quot;Vista&quot;<br />
    StrCpy $INSTDIR &quot;blah&quot;<br />
  ${Else}<br />
    StrCpy $INSTDIR &quot;other blah&quot;<br />
  ${EndIf}<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">richiebabes</div><div class="date">9th June 2008, 23:00</div></div><div class="posttext">With that code I get:<br />
<br />
Error: resolving install function &quot;GetWindowsVersion&quot; in function &quot;.onInit&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">richiebabes</div><div class="date">9th June 2008, 23:06</div></div><div class="posttext">I removed &quot;Install Path&quot; from your code by the way, since it created an error. <br />
<br />
Also I added a Call .onInit before the function to see if that worked, but to no avail.<br />
<br />
Different world this NSIS!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">9th June 2008, 23:57</div></div><div class="posttext">You need to put the entire GetWindowsVersion function in your script as well.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">richiebabes</div><div class="date">10th June 2008, 00:29</div></div><div class="posttext">:-o</div></div><hr />


<div class="post"><div class="posttop"><div class="username">richiebabes</div><div class="date">10th June 2008, 00:40</div></div><div class="posttext">I get the same error. Here is my code now:<br />
<br />
Function GetWindowsVersion<br />
 <br />
  Push $R0<br />
  Push $R1<br />
 <br />
  ClearErrors<br />
 <br />
  ReadRegStr $R0 HKLM \<br />
  &quot;SOFTWARE\Microsoft\Windows NT\CurrentVersion&quot; CurrentVersion<br />
 <br />
  IfErrors 0 lbl_winnt<br />
 <br />
  ; we are not NT<br />
  ReadRegStr $R0 HKLM \<br />
  &quot;SOFTWARE\Microsoft\Windows\CurrentVersion&quot; VersionNumber<br />
 <br />
  StrCpy $R1 $R0 1<br />
  StrCmp $R1 '4' 0 lbl_error<br />
 <br />
  StrCpy $R1 $R0 3<br />
 <br />
  StrCmp $R1 '4.0' lbl_win32_95<br />
  StrCmp $R1 '4.9' lbl_win32_ME lbl_win32_98<br />
 <br />
  lbl_win32_95:<br />
    StrCpy $R0 '95'<br />
  Goto lbl_done<br />
 <br />
  lbl_win32_98:<br />
    StrCpy $R0 '98'<br />
  Goto lbl_done<br />
 <br />
  lbl_win32_ME:<br />
    StrCpy $R0 'ME'<br />
  Goto lbl_done<br />
 <br />
  lbl_winnt:<br />
 <br />
  StrCpy $R1 $R0 1<br />
 <br />
  StrCmp $R1 '3' lbl_winnt_x<br />
  StrCmp $R1 '4' lbl_winnt_x<br />
 <br />
  StrCpy $R1 $R0 3<br />
 <br />
  StrCmp $R1 '5.0' lbl_winnt_2000<br />
  StrCmp $R1 '5.1' lbl_winnt_XP<br />
  StrCmp $R1 '5.2' lbl_winnt_2003<br />
  StrCmp $R1 '6.0' lbl_winnt_vista lbl_error<br />
 <br />
  lbl_winnt_x:<br />
    StrCpy $R0 &quot;NT $R0&quot; 6<br />
  Goto lbl_done<br />
 <br />
  lbl_winnt_2000:<br />
    Strcpy $R0 '2000'<br />
  Goto lbl_done<br />
 <br />
  lbl_winnt_XP:<br />
    Strcpy $R0 'XP'<br />
  Goto lbl_done<br />
 <br />
  lbl_winnt_2003:<br />
    Strcpy $R0 '2003'<br />
  Goto lbl_done<br />
 <br />
  lbl_winnt_vista:<br />
    Strcpy $R0 'Vista'<br />
  Goto lbl_done<br />
 <br />
  lbl_error:<br />
    Strcpy $R0 ''<br />
  lbl_done:<br />
 <br />
  Pop $R1<br />
  Exch $R0<br />
 <br />
FunctionEnd<br />
<br />
Function .onInit<br />
  Call GetWindowsVersion<br />
  Pop $R0<br />
<br />
  ${If} $R0 == &quot;Vista&quot;<br />
    StrCpy $INSTDIR &quot;blah&quot;<br />
  ${Else}<br />
    StrCpy $INSTDIR &quot;other blah&quot;<br />
  ${EndIf}<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">10th June 2008, 05:18</div></div><div class="posttext">Why are you not using WinVer.nsh?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">richiebabes</div><div class="date">10th June 2008, 17:38</div></div><div class="posttext">I included that and still get this message:<br />
<br />
Error: resolving install function &quot;GetWindowsVersion&quot; in function &quot;.onInit&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comperio</div><div class="date">10th June 2008, 17:53</div></div><div class="posttext">Try this.  <br />
<br />
At the top of your script, you need:<br />
<br />
<br />
!include WinVer.nsh<br />
<br />
<br />
Then, simplifying .onInit:<br />
(Note: I put the message boxes in the code just so that you can test and see that it's giving you the right results.  Remove them for the &quot;production&quot; code.)<br />
<br />
Function .onInit<br />
  ${If} ${IsVista}<br />
    StrCpy $INSTDIR &quot;blah&quot;<br />
    MessageBox MB_OK &quot;VISTA&quot;<br />
  ${Else}<br />
      StrCpy $INSTDIR &quot;other blah&quot;<br />
      MessageBox MB_OK &quot;Something else&quot;<br />
  ${EndIf}<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">richiebabes</div><div class="date">10th June 2008, 18:08</div></div><div class="posttext">I feel quite embarrassed. It is now working. Thanks!</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>