<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" UAC plugin: strange behaviour when UAC is off and installer is run from browser, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  UAC plugin: strange behaviour when UAC is off and installer is run from browser NSIS Discussion" />
	
	<title> UAC plugin: strange behaviour when UAC is off and installer is run from browser [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  UAC plugin: strange behaviour when UAC is off and installer is run from browser</div>
<hr />
<div class="pda"><a href="t-331276.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=331276">UAC plugin: strange behaviour when UAC is off and installer is run from browser</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">juliarg</div><div class="date">6th June 2011, 15:32</div></div><div class="posttext">I stumbled upon some strange behaviour when running downloaded installer from different browsers.<br />
<br />
The problem is as follows:<br />
I switch off UAC and do not reboot the computer.<br />
Run the installer, choose install path which requires admin rights. UAC is run.<br />
Installer shows &quot;Run as&quot; dialog. Select &quot;Current user&quot;.<br />
<br />
If I do all this running the downloaded installer from Windows Explorer, or from Internet Explorer or Firefox browsers (after downloading it),  the following check works:<br />
<br />
Function .onInit<br />
    ${If} ${UAC_IsInnerInstance}        <br />
        ${IfNot} ${UAC_IsAdmin}           <br />
            SetErrorLevel 0x666666 ;couldn't elevate<br />
            Quit<br />
        ${EndIf} <br />
    ${EndIf} <br />
...<br />
<br />
Then, this error level is returned after running<br />
<br />
!insertmacro UAC_RunElevated<br />
<br />
 in $2 to the outer instance and I can check for it.<br />
<br />
if I run the downloaded installer from Chrome, inner instance .onInit doesn't get called and the value in $2 is 2. This value is similar to NSIS return value &quot;aborted by script&quot;.<br />
<br />
I wonder why this can happen and what can I do to handle this situation. Would greatly appreciate your ideas.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">7th June 2011, 08:18</div></div><div class="posttext">$2 is only valid if $0==0. If you don't reboot, the system is probably in a weird unsupported state. What happens after reboot?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">juliarg</div><div class="date">7th June 2011, 10:06</div></div><div class="posttext">$0 is 0 in this case. $0 $1 $2 $3 are 0 1 2 0.<br />
<br />
This behaviour appears both before reboot when UAC is turned off and after reboot if current user is non-admin.<br />
<br />
But!<br />
<br />
I've found out that this happens only if a file with same name already exists in the directory and Chrome renames the installer, for example, install (1).exe</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">7th June 2011, 10:18</div></div><div class="posttext">Maybe you could try MessageBox mb_ok $exepath in .oninit</div></div><hr />


<div class="post"><div class="posttop"><div class="username">juliarg</div><div class="date">7th June 2011, 10:45</div></div><div class="posttext">Thank you!!! I tried this and it led me to the solution.<br />
<br />
The $exepath in the inner instance contains not the actual, but the original filename. The ${If} ${UAC_IsInnerInstance} in .onInit isn't true either and the execution goes to the outer instance branch. There, the script quits because it encounters a check for multiple instances of the installer. I will now be setting an errorlevel there and thus recognize this situation in UacElevation macro.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>