<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Compiler Error with Dictionary Size &gt; 149 MB, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Compiler Error with Dictionary Size &gt; 149 MB NSIS Discussion" />
	
	<title> Compiler Error with Dictionary Size &gt; 149 MB [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Compiler Error with Dictionary Size &gt; 149 MB</div>
<hr />
<div class="pda"><a href="t-291948.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=291948">Compiler Error with Dictionary Size &gt; 149 MB</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">18th May 2008, 00:05</div></div><div class="posttext">Hi!<br />
<br />
I noticed that makensis.exe fails to compile my script when I use LZMA compression with 150 MB dictionary size or even more. I get an &quot;internal compiler error&quot; and &quot;failed to create uninstaller&quot;. Using 149 MB dictionary size seems to be the highest value that works. Is that an expected behavior or a bug?<br />
<br />
Cheeeeeeeeers<br />
MuldeR</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">18th May 2008, 13:07</div></div><div class="posttext">Here is a log file that shows the problem:<br />
<br />
MakeNSIS v2.37 - Copyright 1995-2008 Contributors<br />
See the file COPYING for license details.<br />
Credits can be found in the Users Manual.<br />
<br />
...<br />
<br />
Processing script file: &quot;Installer.nsi&quot;<br />
<br />
...<br />
<br />
SetCompressor: /SOLID LZMA<br />
SetCompressorDictSize: 150 mb<br />
<br />
...<br />
<br />
Generating uninstaller... Internal compiler error #12345:<br />
  deflateInit() failed(initialization failed [-2]).<br />
<br />
Note: you may have one or two (large) stale temporary file(s)<br />
left in your temporary directory (Generally this only happens on Windows 9x).<br />
!system: returned 1, aborting<br />
Error in script &quot;D:\MPUI\!_Build.nsi&quot; on line 41 -- aborting creation process<br />
<br />
Sorry for double posting, time limit to edit initial post was over :confused:</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">18th May 2008, 19:31</div></div><div class="posttext">That large of a dictionary requires over 1.5GB of free memory. Do you have enough?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">18th May 2008, 19:37</div></div><div class="posttext">4 GB of physical RAM plus 4 GB swap file should be enough ;) <br />
<br />
I often use 7-Zip with LZMA mode and 256 MB of dictionary (occupies ~3,7 GB of RAM) and I'd like to do the same with NSIS...<br />
<br />
Did anybody manage to compile an installer with 150+ MB dictionary size yet?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">21st May 2008, 04:26</div></div><div class="posttext">I noticed that the maximum dictionary size depends on the contents of the installer! I changed my installer quite a bit and now makensis suddenly fails (reproducible) with 149 MB dictionary size. Had to lower it to 144 MB to make my script compile again. Also makensis simply crashes when I use the !packhdr command to call UPX. Not using UPX plus successively lowering the dictionary size seems to workaround the compilation error...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">23rd May 2008, 14:24</div></div><div class="posttext">Sorry for posting again, but was anybody able to reproduce this problem? I think it's a bug in makensis and it should be addressed. It's not only that I have to lower the dictionary size (and waste some compression ratio), I even can't use UPX (or UPack) any more...<br />
<br />
If some more info is needed, please tell me what to do...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">24th May 2008, 22:24</div></div><div class="posttext">UPX works fine for me.<br />
<br />
As for the dictionary, I only have 1.5GB of memory so I can't test it. I can say it fails at the right place - calling VirtualAlloc.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">24th May 2008, 22:33</div></div><div class="posttext">Originally posted by kichik <br />
UPX works fine for me. <br />
<br />
It usually does work here too. But this pretty big/complex installer (the same that encounters the compiler error with dictionary size) definitely fails to compile as soon as I use !packhdr command.<br />
<br />
Originally posted by kichik As for the dictionary, I only have 1.5GB of memory so I can't test it. I can say it fails at the right place - calling VirtualAlloc. [/B]<br />
<br />
I can assure you that I have 4 GB of RAM available and the physical RAM definitely isn't out of memory. And even if so, I'd still have enough Swap File size on my HDD. Furthermore I use 7-Zip, which is the reference implementation of LZMA, quite often. And I use LZMA with 256 MB dictionary size to compress my HDD backups. That is much(!) more data than the installer has to handle, but it never failed. So I'm pretty sure that this error cannot be explained with &quot;out of memory&quot; error...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">24th May 2008, 22:44</div></div><div class="posttext">There's more to it than the number of RAM chips you have. As far as I can tell from the source code, you need 1.5GB of contiguous memory. That's on top of whatever you need for the other file handling of NSIS. On a 32-bit system, that's a heavy requirement. Edit BigAlloc in Source\7zip\Common\Alloc.cpp and see if it really fails there or somewhere else.<br />
<br />
As for UPX, I need details as it works fine for me.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">24th May 2008, 23:11</div></div><div class="posttext">Originally posted by kichik <br />
There's more to it than the number of RAM chips you have. As far as I can tell from the source code, you need 1.5GB of contiguous memory. That's on top of whatever you need for the other file handling of NSIS. On a 32-bit system, that's a heavy requirement. Edit BigAlloc in Source\7zip\Common\Alloc.cpp and see if it really fails there or somewhere else.<br />
 <br />
<br />
Sorry, I don't have a build environment set up here. And even if so, my C++ skills are limited. So I'd need some more information on what exactly I need to edit to get more information about the problem...<br />
<br />
BTW: I'm running on a 64-Bit System (WinXP x64). NSIS is a 32-Bit process though.<br />
<br />
Originally posted by kichik <br />
As for UPX, I need details as it works fine for me. <br />
<br />
Screenshot:<br />
http://img502.imageshack.us/my.php?image=nsiscrashjh1.png<br />
<br />
Log File:<br />
http://pastebin.com/fc36186b<br />
<br />
Compiles fine without the !packhdr command...<br />
<br />
The strange thing is: When I compile the &quot;full&quot; (bigger) version of my installer, it will work with UPX just fine. Only if I compile the &quot;light&quot; (smaller) version, which has some files left out via !ifdef..!endif (but is identical in all other places!), it will crash using UPX! I can compile both versions just fine by removing the !packhadr command...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">{_trueparuex^}</div><div class="date">24th May 2008, 23:22</div></div><div class="posttext">I did compile couple installers with 149 MB dictionary size without any problems and I only have 1GB of physical. Though I  only packed about 20 MB installers. I did start compiling 300 MB installer too, but I didn't have the patience to wait it finish.<br />
<br />
Wherever 149 MB dictionary size is feasible is a completely different matter. :p <br />
<br />
PaR</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">24th May 2008, 23:35</div></div><div class="posttext">Originally posted by {_trueparuex^} <br />
Wherever 149 MB dictionary size is feasible is a completely different matter. :p <br />
My installer is compressing ~160 MB of data, mostly EXE/DLL files. At the moment I squeezed the installer down to 24,8 MB. If you have to handle more than 20.000 downloads per month (~10 GB of traffic per day), every byte counts ^^</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">21st July 2008, 02:58</div></div><div class="posttext">After updating to NSIS 3.28, I still get the infamous &quot;Internal compiler error #12345: deflateInit() failed(initialization failed [-2])&quot; error at &quot;Generating uninstaller...&quot; when compiling my installer with to large dictionary. At the moment 145 MB works. Bigger dictonary size doesn't work...<br />
<br />
Furthermore MakeNSIS will still crash when using !packhdr with UPX:<br />
http://img516.imageshack.us/img516/3171/makensiscrashmr1.png<br />
<br />
:cry:</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>