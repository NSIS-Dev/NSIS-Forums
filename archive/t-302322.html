<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" UserMgr Plugin, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  UserMgr Plugin NSIS Discussion" />
	
	<title> UserMgr Plugin [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  UserMgr Plugin</div>
<hr />
<div class="pda"><a href="t-302322.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=302322">UserMgr Plugin</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">22nd January 2009, 08:17</div></div><div class="posttext">Hello Ivan,<br />
<br />
I uploaded a new version of the plugin, which has a new Function &quot;GetCurrentDomain&quot;.<br />
<br />
http://nsis.sourceforge.net/UserMgr_plug-in<br />
<br />
This function will return the domainname you are currently logged in to (in your case &quot;mshome&quot;).<br />
<br />
Best regards,<br />
jpderuiter<br />
<br />
P.S.: this is a follow up of the &quot;New Plugin&quot; thread on this forum:<br />
http://forums.winamp.com/showthread.php?s=&amp;postid=2477038</div></div><hr />


<div class="post"><div class="posttop"><div class="username">coppolo</div><div class="date">22nd January 2009, 16:45</div></div><div class="posttext">Hi all,<br />
<br />
After I created a new user, I make some shortcuts in the start menÃ¹, but I find those shortcuts in the &quot;newuser&quot; menÃ¹, not in the current user menÃ¹. (but I want them in the current user menÃ¹!)<br />
It seems like UserMgr pluging changed the environmental variable when creating the user.<br />
<br />
Any suggestions?<br />
<br />
Many thanks,<br />
Luca<br />
<br />
This is my nsis code:<br />
<br />
UserMgr::CreateAccountEx &quot;newuser&quot; &quot;password&quot; &quot;-&quot; &quot;-&quot; &quot;-&quot; &quot;UF_PASSWD_CANT_CHANGE|UF_DONT_EXPIRE_PASSWD&quot;<br />
Pop $0<br />
${If} $0 != &quot;OK&quot;<br />
Quit<br />
${EndIf}<br />
<br />
UserMgr::AddToGroup ${AEPUSER} &quot;Users&quot;<br />
Pop $0<br />
${If} $0 != &quot;OK&quot;<br />
Quit<br />
${EndIf}<br />
<br />
UserMgr::BuiltAccountEnv ${AEPUSER} ${AEPPWD}<br />
Pop $0<br />
${If} $0 != &quot;OK&quot;<br />
Quit<br />
${EndIf}<br />
<br />
CreateDirectory &quot;$SMPROGRAMS\myapp&quot;<br />
CreateShortCut &quot;$SMPROGRAMS\myapp\myapp.lnk&quot; &quot;$INSTDIR\myapp.exe&quot; &quot;&quot; &quot;$INSTDIR\myapp.exe&quot; 0</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">22nd January 2009, 17:27</div></div><div class="posttext">Hello coppolo,<br />
<br />
I tried the following:<br />
<br />
<br />
	SetShellVarContext current<br />
 <br />
	MessageBox MB_OK &quot;$SMPROGRAMS&quot;<br />
<br />
	UserMgr::CreateAccountEx &quot;myuserA&quot; &quot;mypassword&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;UF_PASSWD_NOTREQD|UF_DONT_EXPIRE_PASSWD&quot;<br />
	Pop $0<br />
 <br />
	UserMgr::BuiltAccountEnv &quot;myuserA&quot; &quot;mypassword&quot;<br />
	Pop $0<br />
 <br />
	MessageBox MB_OK &quot;$SMPROGRAMS&quot;<br />
<br />
	UserMgr::DeleteAccount &quot;myuserA&quot;<br />
	Pop $0<br />
 <br />
	MessageBox MB_OK &quot;$SMPROGRAMS&quot;<br />
<br />
<br />
All 3 Messageboxes show the Startmenu programs folder of the current user, not the new created user.<br />
<br />
But as soon as I comment the first messagebox out, the other 2 Messageboxes both show the Startmenu programs folder of the new created user!<br />
<br />
I'm not sure what is causing this, but as far as I can see the UserMgr plugin does not change the environmental variable at all.<br />
<br />
Anyone else?<br />
<br />
Regards,<br />
jpderuiter</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Ivan Andreevich</div><div class="date">22nd January 2009, 18:40</div></div><div class="posttext">Originally posted by jpderuiter <br />
[B]Hello Ivan,<br />
<br />
I uploaded a new version of the plugin, which has a new Function &quot;GetCurrentDomain&quot;.<br />
<br />
http://nsis.sourceforge.net/UserMgr_plug-in<br />
<br />
This function will return the domainname you are currently logged in to (in your case &quot;mshome&quot;).<br />
 <br />
<br />
Thanks, this is exactly what I need. Unfortunately, when I call this new function the installer just crashes.<br />
<br />
I have an actual domain here, not a workgroup. Not sure if this would affect anything. I tested it on 2 different domains and 2 different machines and the behavior is the same. <br />
<br />
Exception Information<br />
Code: 0xc0000005   Flags: 0x00000000<br />
Record 0x00...00 Address: 0x00...05c</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">22nd January 2009, 19:37</div></div><div class="posttext">Hello Ivan,<br />
<br />
unfortunately I'm in a workgroup, and it was working correctly for me.<br />
<br />
But a used another combination of API's to get the domainname, and I uploaded it to the wiki.<br />
<br />
Can you try if it works now?<br />
<br />
Best regards,<br />
Jan Pieter</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Ivan Andreevich</div><div class="date">22nd January 2009, 20:05</div></div><div class="posttext">Originally posted by jpderuiter <br />
Hello Ivan,<br />
<br />
unfortunately I'm in a workgroup, and it was working correctly for me.<br />
<br />
But a used another combination of API's to get the domainname, and I uploaded it to the wiki.<br />
<br />
Can you try if it works now?<br />
<br />
Best regards,<br />
Jan Pieter  <br />
The result is pretty much the same. I have to complete some other work, but I want to come back to this. <br />
<br />
Can you create a pdb file and upload it somewhere so I can debug? It's a pain to build the project myself since I am running different Visual Studio version, and don't have libc.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">22nd January 2009, 20:27</div></div><div class="posttext">Hello Ivan,<br />
<br />
I'm sorry to hear that, and that I'm unable to help now.<br />
<br />
I sent you a private message with a link to the Debug version, incl the pdb.<br />
I also altered the GetCurrentDomain again, so maybe it's working now.<br />
<br />
Best regards,<br />
Jan Pieter</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TobbeSweden</div><div class="date">23rd January 2009, 14:06</div></div><div class="posttext">This installer crashes every time I try to run it:<br />
Name &quot;UsrMgrTest&quot;<br />
OutFile &quot;UsrMgrTest.exe&quot;<br />
ShowInstDetails show<br />
Page instfiles<br />
<br />
Section &quot;&quot; ;No components page, name is not important<br />
	UserMgr::HasPrivilege &quot;Tobbe&quot; &quot;SeInteractiveLogonRight &quot;<br />
	Pop $0<br />
	DetailPrint &quot;&gt;$0&lt;&quot;<br />
SectionEnd<br />
Am I doing something wrong here?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">23rd January 2009, 17:33</div></div><div class="posttext">Hello all,<br />
<br />
I uploaded a new version of the plugin with a bugfix for the crashing installer.<br />
<br />
@Tobbe:<br />
I tried your script, and it's not crashing anymore, but it wasn't crashing before on the HasPrivilege call, only when exiting the installer.<br />
<br />
@Ivan:<br />
I tried the GetCurrentDomain function at work, and it's returning the domain properly.<br />
<br />
@coppolo:<br />
Your problem isn't solved yet.<br />
A workaround could be creating the shortcuts before calling BuiltAccountEnv, or storing the $SMPROGRAMS string in another variable.<br />
<br />
Best regards,<br />
jpderuiter</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TobbeSweden</div><div class="date">23rd January 2009, 17:50</div></div><div class="posttext">It still crashes for me. It crashes before it prints anything to the log window.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">23rd January 2009, 17:54</div></div><div class="posttext">Hmm, strange.<br />
<br />
I assume you are using NSIS v2.42?<br />
Are other UserMgr funtions crashing the installer as well?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TobbeSweden</div><div class="date">23rd January 2009, 18:03</div></div><div class="posttext">Hmm, I'm using 2.37. Let me upgrade and I'll report back</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TobbeSweden</div><div class="date">23rd January 2009, 18:31</div></div><div class="posttext">So I upgraded to 2.42 and now I get different results :)<br />
<br />
With the latest version of UserMgr I get this:<br />
Invalid command: UserMgr::HasPrivilege<br />
Invalid command: UserMgr::GetCurrentUserName<br />
<br />
UserMgr::GetUserInfo &quot;Tobbe&quot; &quot;HOMEDIR&quot; doesn't give me the Invalid command error, but it only returns an empty string.<br />
<br />
My installer does not crash however :)<br />
<br />
With the old version I don't get any Invalid command errors, but &quot;HasPrivilege&quot; returns ERROR LsaEnumerateAccountRights and GetUserInfo only returns an empty string. GetCurrentUserName does however correctly return &quot;Tobbe&quot;<br />
<br />
EDIT: With the old version I get the behavior you describe with the installer crashing when closing it.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Ivan Andreevich</div><div class="date">23rd January 2009, 18:35</div></div><div class="posttext">Originally posted by jpderuiter <br />
Hmm, strange.<br />
<br />
I assume you are using NSIS v2.42?<br />
Are other UserMgr funtions crashing the installer as well?  <br />
I am getting a crash from calling any function now - tried a few. I am on NSIS 2.41 but can't upgrade for now.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">23rd January 2009, 18:41</div></div><div class="posttext">Well, I have used the new NSIS Plugin API coming with NSIS v2.42, so I think that's the reason why it's crashing.<br />
So you should upgrade to 2.42 to make the plugin work.<br />
<br />
For the time being you can use the older plugin version dated 22:06, 1 February 2008:<br />
http://nsis.sourceforge.net/File:UserMgr.zip</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Ivan Andreevich</div><div class="date">23rd January 2009, 20:22</div></div><div class="posttext">Originally posted by jpderuiter <br />
Well, I have used the new NSIS Plugin API coming with NSIS v2.42, so I think that's the reason why it's crashing.<br />
So you should upgrade to 2.42 to make the plugin work.<br />
<br />
For the time being you can use the older plugin version dated 22:06, 1 February 2008:<br />
http://nsis.sourceforge.net/File:UserMgr.zip  <br />
Ok, that makes sense :D <br />
<br />
You should make a note in BOLD letters on the wiki page that this version is for 2.42+ only. Also include a link to older versions as well there :)<br />
<br />
I'll give 2.42 a shot. I just hope it doesn't break the old plugins I am using.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Ivan Andreevich</div><div class="date">23rd January 2009, 20:52</div></div><div class="posttext">Awesome, it works perfectly with NSIS 2.42. It didn't break any old plugins either :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">23rd January 2009, 20:55</div></div><div class="posttext">Ivan,<br />
<br />
The way I see it is that you should always have to use the newest version.<br />
And well, I haven't noticed any plugin didn't work with v2.42.<br />
v2.42 is supposed to be backwards compatible with pre-v2.42 plugins.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">23rd January 2009, 21:04</div></div><div class="posttext">@Ivan:<br />
Ah, you already found out ;-)<br />
<br />
@Tobbe:<br />
Sorry, I missed your last post.<br />
Did you place the UserMgr plugin in the Plugins directory again after upgrading to v2.42.<br />
Since the installer removes all plugin...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TobbeSweden</div><div class="date">23rd January 2009, 21:08</div></div><div class="posttext">Firefox seems to be caching the download or something... Could you please add a version number to the downloadable file? Thanks</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">23rd January 2009, 21:18</div></div><div class="posttext">Well, that's not how the NSIS wiki page works, or I'll have to make a new file page for each new version.<br />
<br />
But I'll attach the plugin with this post.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TobbeSweden</div><div class="date">23rd January 2009, 21:22</div></div><div class="posttext">Perfect! Thank you :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Ivan Andreevich</div><div class="date">23rd January 2009, 21:26</div></div><div class="posttext">Originally posted by jpderuiter <br />
Ivan,<br />
<br />
The way I see it is that you should always have to use the newest version.<br />
And well, I haven't noticed any plugin didn't work with v2.42.<br />
v2.42 is supposed to be backwards compatible with pre-v2.42 plugins.  <br />
I would still make a note of the minimum required version of NSIS, because 99% of the plugins don't require 2.42 yet. Someone might not even realize 2.42 is out or they might be too lazy to upgrade if they feel the changelog doesn't affect them. ;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TobbeSweden</div><div class="date">23rd January 2009, 21:27</div></div><div class="posttext">Now I can run the plugin but there is one thing I find weird...<br />
Name &quot;UsrMgrTest&quot;<br />
OutFile &quot;UsrMgrTest.exe&quot;<br />
ShowInstDetails show<br />
Page instfiles<br />
<br />
Section &quot;&quot;<br />
	UserMgr::GetCurrentUserName<br />
	Pop $0<br />
	DetailPrint &quot;&gt;$0&lt;&quot;<br />
	UserMgr::GetUserInfo $0 &quot;HOMEDIR&quot;<br />
	Pop $1<br />
	DetailPrint &quot;&gt;$1&lt;&quot;<br />
    UserMgr::HasPrivilege $0 &quot;SeInteractiveLogonRight&quot;<br />
    Pop $2<br />
    DetailPrint &quot;&gt;$2&lt;&quot;<br />
SectionEnd<br />
$1 is just an empty string when I run that. And $2 is &quot;ERROR LsaEnumerateAccountRights&quot;. $0 does contain my username.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">23rd January 2009, 22:17</div></div><div class="posttext">OK, I'm not sure why the HOMEDIR is an empty string, I'll try to look into that.<br />
<br />
Can you do the same with the attached test plugin, and tell me what the error message on the HasPrivilege function.<br />
(It will give an error code as well now)<br />
<br />
Regards,<br />
Jan Pieter</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">23rd January 2009, 22:19</div></div><div class="posttext">Originally posted by Ivan Andreevich <br />
I would still make a note of the minimum required version of NSIS, because 99% of the plugins don't require 2.42 yet. Someone might not even realize 2.42 is out or they might be too lazy to upgrade if they feel the changelog doesn't affect them. ;)  <br />
Done</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TobbeSweden</div><div class="date">23rd January 2009, 23:06</div></div><div class="posttext">I get &quot;ERROR LsaEnumerateAccountRights 1&quot; with the test1 version</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">23rd January 2009, 23:06</div></div><div class="posttext">Originally posted by jpderuiter <br />
OK, I'm not sure why the HOMEDIR is an empty string, I'll try to look into that.<br />
 <br />
Hmm, appearantly the HOMEDIR is actually an empty string by default.<br />
At least the one used for the NetUserGetInfo API does.<br />
When you set a value using<br />
UserMgr::SetUserInfo $0 &quot;HOMEDIR&quot; &quot;SomeDir&quot;<br />
you will get this directory back when using GetUserInfo...<br />
<br />
Not very usefull though...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">23rd January 2009, 23:20</div></div><div class="posttext">Originally posted by TobbeSweden <br />
I get &quot;ERROR LsaEnumerateAccountRights 1&quot; with the test1 version  <br />
Hmm, that means &quot;The requested operation was unsuccessful.&quot;...<br />
<br />
Would it be possible that the user does not have any rights?<br />
<br />
Does this happen on each user on your system?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Ivan Andreevich</div><div class="date">23rd January 2009, 23:29</div></div><div class="posttext">What do UserMgr::GetCurrentUserName and UserMgr::GetCurrentDomain return if there is some problem? I want to do some error checking on my end.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TobbeSweden</div><div class="date">23rd January 2009, 23:42</div></div><div class="posttext">The user I'm testing with is myself. And I'm an administrator... I tried with the admin account and got the same error. It does work with the guest account though. It returns TRUE.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">24th January 2009, 00:03</div></div><div class="posttext">Originally posted by Ivan Andreevich <br />
What do UserMgr::GetCurrentUserName and UserMgr::GetCurrentDomain return if there is some problem? I want to do some error checking on my end.  <br />
They both return &quot;ERROR {errorcode}&quot;<br />
<br />
Originally posted by TobbeSweden <br />
The user I'm testing with is myself. And I'm an administrator... I tried with the admin account and got the same error. It does work with the guest account though. It returns TRUE.  <br />
I tried the same, and I don't get an error for both users.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">24th January 2009, 11:11</div></div><div class="posttext">Tobbe,<br />
<br />
have you tried the following code:<br />
http://nsis.sourceforge.net/Enumerate_User_Privileges<br />
<br />
Is the same error code returned (the error code in $R8)?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TobbeSweden</div><div class="date">24th January 2009, 12:09</div></div><div class="posttext">No, $R8 is -1073741772<br />
<br />
I have been researching this, and it seems as if I should get an error, and that script gives me that error (in $R9).<br />
<br />
I can't compile the source code for the plugin, but could you please make the following changes and post a build?<br />
<br />
NTSTATUS nts; // This should be declared up at the top<br />
nts = LsaEnumerateAccountRights(my_policy_handle, user_sid, (LSA_UNICODE_STRING **) &amp;lucPrivilege, &amp;count);<br />
if (nts != STATUS_SUCCESS)<br />
{<br />
    DWORD e;<br />
    if (lucPrivilege != NULL)LsaFreeMemory(&amp;lucPrivilege);<br />
    LsaClose(my_policy_handle);<br />
    e = LsaNtStatusToWinError(nts);<br />
    if (e == 2)<br />
    {<br />
        pushstring(&quot;ERROR LsaEnumerateAccountRights - User only has inherited rights&quot;);<br />
    }<br />
    else<br />
    {<br />
        pushstring(&quot;ERROR LsaEnumerateAccountRights&quot;);<br />
    }<br />
    return;<br />
}</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">25th January 2009, 22:45</div></div><div class="posttext">Hello Tobbe<br />
<br />
I uploaded a new version which return the errorcode for LsaEnumerateAccountRights (either the System errorcode if available, else the NTSTATUS errorcode).<br />
<br />
I used the following code:<br />
<br />
if (ntStatus = LsaEnumerateAccountRights(my_policy_handle, user_sid, (LSA_UNICODE_STRING **) &amp;lucPrivilege, &amp;count) != STATUS_SUCCESS)<br />
{<br />
   if (lucPrivilege != NULL)LsaFreeMemory(&amp;lucPrivilege);<br />
   LsaClose(my_policy_handle);<br />
   dwError = LsaNtStatusToWinError(ntStatus);<br />
   if(dwError == ERROR_FILE_NOT_FOUND)<br />
   {// No privileges found for the user<br />
      sprintf(tempbuf,&quot;FALSE&quot;);<br />
   }<br />
   else if(dwError == ERROR_MR_MID_NOT_FOUND)<br />
   {// System errorcode not found for ntStatus<br />
      sprintf(tempbuf,&quot;ERROR LsaEnumerateAccountRights n%d&quot;, ntStatus);<br />
   }<br />
   else <br />
   {<br />
      sprintf(tempbuf,&quot;ERROR LsaEnumerateAccountRights w%d&quot;, dwError);<br />
   }<br />
   pushstring(tempbuf);<br />
   return;<br />
}<br />
<br />
<br />
(Attached newest version to this post)<br />
<br />
Regards,<br />
jpderuiter</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TobbeSweden</div><div class="date">25th January 2009, 23:03</div></div><div class="posttext">For some reason your code returns &quot;ERROR LsaEnumerateAccountRights n1&quot;<br />
<br />
http://nsis.sourceforge.net/Enumerate_User_Privileges returns FILE_NOT_FOUND<br />
<br />
I believe the correct return value in my case is FILE_NOT_FOUND</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Ivan Andreevich</div><div class="date">26th January 2009, 19:15</div></div><div class="posttext">I have a feature request. How about a function that checks whether the specified Username (password too, if needed) has access rights to go to a specified path. Is that feasible, or is this outside the scope of this plug-in?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Ivan Andreevich</div><div class="date">27th January 2009, 21:55</div></div><div class="posttext">Cancel that. My studio has been closed down and we've all been fired today. <br />
<br />
But thanks so much for the hard work you put in with this plug-in!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">28th January 2009, 17:38</div></div><div class="posttext">@Tobbe:<br />
I'm sorry, but I'm not able to solve the HasPrivilege problem.<br />
The function LsaEnumerateAccountRights returns 1 on every error, and I can't find a solution for it.<br />
So I'm afraid you'll have to use the Macro mentioned before as a workaround.<br />
<br />
@Ivan:<br />
I'm really sorry to hear that.<br />
I hope you will find yourself a new job soon.<br />
About your feature request: I think it's a usefull feature so I'm thinking about adding it anyway as soon as I have the time for it.<br />
<br />
Regards,<br />
Jan Pieter</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TobbeSweden</div><div class="date">28th January 2009, 17:51</div></div><div class="posttext">I compiled and ran this code: http://win32.mvps.org/lsa/lsa_lear.cpp<br />
<br />
It uses LsaEnumerateAccountRights and I got the &quot;FILE_NOT_FOUND&quot; error. Maybe you can work off of that?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">28th January 2009, 18:49</div></div><div class="posttext">Well, as far I can see I'm doing exactly the same.<br />
And there is nothing wrong with the parameters I'm passing to LsaEnumerateAccountRights, since it returns no error if the user does have privileges.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">2nd September 2009, 19:46</div></div><div class="posttext">I uploaded a new version of this plugin:<br />
 - Added GetUserNameFromSID function<br />
 - Added GetSIDFromUserName function<br />
 - Fixed a problem in the RegLoadUserHive function when a user was deleted and then recreatedOriginally posted by TobbeSweden <br />
Now I can run the plugin but there is one thing I find weird...<br />
Name &quot;UsrMgrTest&quot;<br />
OutFile &quot;UsrMgrTest.exe&quot;<br />
ShowInstDetails show<br />
Page instfiles<br />
<br />
Section &quot;&quot;<br />
	UserMgr::GetCurrentUserName<br />
	Pop $0<br />
	DetailPrint &quot;&gt;$0&lt;&quot;<br />
	UserMgr::GetUserInfo $0 &quot;HOMEDIR&quot;<br />
	Pop $1<br />
	DetailPrint &quot;&gt;$1&lt;&quot;<br />
    UserMgr::HasPrivilege $0 &quot;SeInteractiveLogonRight&quot;<br />
    Pop $2<br />
    DetailPrint &quot;&gt;$2&lt;&quot;<br />
SectionEnd<br />
$1 is just an empty string when I run that. And $2 is &quot;ERROR LsaEnumerateAccountRights&quot;. $0 does contain my username. Thanks to ginglese I found a better way to get the HOMEDIR:http://forums.winamp.com/showthread.php?s=&amp;postid=2558509UserMgr::GetCurrentUserName<br />
Pop $0<br />
UserMgr::GetSIDFromUserName &quot;&quot; $0<br />
Pop $1<br />
ReadRegStr $2 HKLM &quot;SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList\$1&quot; &quot;ProfileImagePath&quot;<br />
ExpandEnvStrings $3 $2<br />
DetailPrint &quot;Homedir: $3&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">langdon</div><div class="date">1st September 2011, 20:59</div></div><div class="posttext">Having some trouble with this plugin on my work machine (which is joined to a domain, and I'm logged with a domain account).  I keep getting ERROR 2221 (NERR_UserNotFound) from the following:<br />
<br />
UserMgr::GetUserInfo &quot;domain\username&quot; &quot;exists&quot;<br />
Pop $0<br />
MessageBox MB_OK &quot;$0&quot;<br />
UserMgr::GetSIDFromUserName &quot;domain&quot; &quot;username&quot;<br />
Pop $1<br />
MessageBox MB_OK &quot;$1&quot;<br />
<br />
1st MessageBox: &quot;ERROR 2221&quot;<br />
2nd MessageBox: &quot;ERROR GetAccountSid&quot;<br />
<br />
There's a slight delay when calling GetSIDFromUserName (like 1-2 seconds).<br />
<br />
I've double and triple checked that I have the correct domain and username.  I even went as far as pulling the SID from the registry and calling it sequence:<br />
<br />
UserMgr::GetUserNameFromSID &quot;S-1-5-21-4264112824-276356272-3790957511-1754&quot;<br />
Pop $0<br />
MessageBox MB_OK &quot;$0&quot;<br />
UserMgr::GetUserInfo &quot;$0&quot; &quot;exists&quot;<br />
Pop $1<br />
MessageBox MB_OK &quot;$1&quot;<br />
<br />
I still get ERROR 2221 (NERR_UserNotFound) with this.<br />
<br />
Any ideas?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">1st September 2011, 22:24</div></div><div class="posttext">Hi,<br />
<br />
what do you get when using the GetCurrentUserName and GetCurrentDomain functions?<br />
<br />
And what do you get when using the following command in the DOS cmd:<br />
net user {username} /domain<br />
(replace {username} with your username)?<br />
<br />
JP</div></div><hr />


<div class="post"><div class="posttop"><div class="username">langdon</div><div class="date">1st September 2011, 22:40</div></div><div class="posttext">Re: GetCurrentUserName/Domain, these are identical:<br />
<br />
UserMgr::GetUserNameFromSID &quot;S-1-5-21-4264112824-276356272-3790957511-1754&quot;<br />
Pop $0<br />
UserMgr::GetCurrentDomain <br />
Pop $1<br />
UserMgr::GetCurrentUserName<br />
Pop $2<br />
MessageBox MB_OK &quot;$0 vs $1\$2&quot;<br />
<br />
The net user command tells somewhat of a different tale -- it appends &quot;.com&quot; onto the domain when it describes the request.<br />
<br />
Going back and changing the code above to domain.com\username, still gets me the error, BUT calling GetSIDFromUsername with domain.com and my username, yields the correct SID.<br />
<br />
What do you make of this?<br />
<br />
C:\Users\oliverlw&gt;net user oliverlw /domain<br />
The request will be processed at a domain controller for domain xxxx.com.<br />
<br />
User name                    xxxx<br />
Full Name                    xxxx xxxx<br />
Comment<br />
User's comment<br />
Country code                 000 (System Default)<br />
Account active               Yes<br />
Account expires              Never<br />
<br />
Password last set            8/5/2011 7:56:20 AM<br />
Password expires             11/3/2011 7:56:20 AM<br />
Password changeable          8/6/2011 7:56:20 AM<br />
Password required            Yes<br />
User may change password     Yes<br />
<br />
Workstations allowed         All<br />
Logon script<br />
User profile<br />
Home directory<br />
Last logon                   9/1/2011 3:28:51 PM<br />
<br />
Logon hours allowed          All<br />
<br />
Local Group Memberships<br />
Global Group memberships     *xxxx<br />
<br />
The command completed successfully.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">1st September 2011, 22:42</div></div><div class="posttext">Sorry, I was too quick to answer.<br />
<br />
The reason is GetUserInfo only works for local accounts...<br />
The plugin should be updated to support domain users for GetUserInfo.<br />
You can try to use the system plugin to get the information you need:<br />
http://forums.winamp.com/showpost.php?p=1908091&amp;postcount=14<br />
Search for NetUserGetInfo in that post.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">langdon</div><div class="date">1st September 2011, 22:47</div></div><div class="posttext">Ahh, thanks, I'll give that a whirl.<br />
<br />
I posted a response to your questions, but it's pending moderator approval?</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>