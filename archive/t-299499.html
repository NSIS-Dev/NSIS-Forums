<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Find size of file before downloading?, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Find size of file before downloading? NSIS Discussion" />
	
	<title> Find size of file before downloading? [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Find size of file before downloading?</div>
<hr />
<div class="pda"><a href="t-299499.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=299499">Find size of file before downloading?</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">hinmanj</div><div class="date">3rd November 2008, 04:48</div></div><div class="posttext">I'm using NSISdl to download files remotely, and I would love to know how to find the size of a file out before downloading, so when on the components page I know how big a component is. I wish I could do something like AddSize 5000 or whatever, but I since the installer doesn't download the file until after the components page, I can't check for the file size on the system.<br />
<br />
Is there a built in function in NSISdl or another plugin that could allow this? I've looked around the internet functions in the Developer Center and came up empty handed, any help would be greatly appreciated!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Yathosho</div><div class="date">3rd November 2008, 13:44</div></div><div class="posttext">i'm using curl to do so, though it's the most elegant solution maybe and it might not work with all servers</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">3rd November 2008, 19:07</div></div><div class="posttext">http://nsis.sourceforge.net/Inetc_plug-in#head_DLL_Function</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">3rd November 2008, 21:13</div></div><div class="posttext">Just to expand a little on what Takhir means - you can use inetc:head to get just the headers off of the server.  This -should- contain the size of the file.. but always check..some servers do not provide this information in the headers; <br />
if you've ever tried downloading a file and it can't tell you how far along it is in its download / how much longer it will take, it's because the server did not provide that information.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">hinmanj</div><div class="date">4th November 2008, 04:49</div></div><div class="posttext">Hmm... so I'd have to call inetc::head and then parse through the file that it outputs for the Content-Length and then AddSize that? ugh... I haven't done any file parsing in NSIS and wouldn't have the slightest idea where to begin.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">5th November 2008, 19:02</div></div><div class="posttext">it's not so bad, hinmanj - here's a quick example script:<br />
<br />
<br />
!define DOWNLOAD_URL &quot;http://www.google.com/intl/en_ALL/images/logo.gif&quot;<br />
<br />
; inetc.dll in the same folder as the source script.<br />
; can remove this line if you've got it in NSIS\Plugins<br />
!addplugindir &quot;.&quot;<br />
<br />
OutFile &quot;content-length_test.exe&quot;<br />
<br />
Section<br />
	inetc::head /TIMEOUT 10000 ${DOWNLOAD_URL} &quot;$EXEDIR\http.headers&quot;<br />
	Pop $0<br />
	StrCmp $0 &quot;OK&quot; _ok<br />
	_error:<br />
	    MessageBox MB_OK &quot;Could not download.&quot;<br />
	    goto _end<br />
	_ok:<br />
	    StrCpy $R0 -1<br />
		FileOpen $0 &quot;$EXEDIR\http.headers&quot; &quot;r&quot;<br />
		_nextline:<br />
		    ClearErrors<br />
		    FileRead $0 $1<br />
		    IfErrors _closeFile<br />
		    StrCpy $2 $1 16<br />
		    StrCmp $2 &quot;Content-Length: &quot; _found _nextline<br />
		    _found:<br />
		        StrCpy $R0 $1 &quot;&quot; 16<br />
		        goto _closeFile<br />
	_closeFile:<br />
	FileClose $0<br />
	MessageBox MB_OK &quot;File size: $R0 bytes&quot;<br />
	_end:<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Grytolle</div><div class="date">23rd June 2010, 13:40</div></div><div class="posttext">The above code example worked great for me, but now I realize that it detects the compressed size of my remote zip-files. Could anyone tell me how to detect the unzipped size without downloading the file, or is that not possible?<br />
<br />
I turned Animaether's code into a macro, perhaps it could be of use to other beginners like me too:<br />
<br />
Usage: !insertmacro SetRemoteFileSize section url-of-remote-file<br />
<br />
!macro SetRemoteFileSize sectie bestand<br />
	inetc::head /TIMEOUT 10000 ${bestand} &quot;$EXEDIR\http.headers&quot;<br />
	Pop $0<br />
	StrCmp $0 &quot;OK&quot; _ok${sectie} _error${sectie}<br />
	_error${sectie}:<br />
	    MessageBox MB_OK &quot;Non-fatal error! Could not detect file size of remote media $\&quot;${sectie}$\&quot;.&quot;<br />
	    goto _end${sectie}<br />
	_ok${sectie}:<br />
	    StrCpy $R0 -1<br />
		FileOpen $0 &quot;$EXEDIR\http.headers&quot; &quot;r&quot;<br />
		_nextline${sectie}:<br />
		    ClearErrors<br />
		    FileRead $0 $1<br />
		    IfErrors _closeFile${sectie}<br />
		    StrCpy $2 $1 16<br />
		    StrCmp $2 &quot;Content-Length: &quot; _found${sectie} _nextline${sectie}<br />
		    _found${sectie}:<br />
		        StrCpy $R0 $1 &quot;&quot; 16<br />
		        goto _closeFile${sectie}<br />
	_closeFile${sectie}:<br />
	FileClose $0<br />
	IntOp $R0 $R0 / 1024				;SectionSize requires kilobytes<br />
	SectionSetSize ${${sectie}} $R0<br />
	_end${sectie}:	<br />
!macroend</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">23rd June 2010, 13:43</div></div><div class="posttext">You need to provide that information yourself; perhaps include a plain text file with the same name as the compressed file and download that first.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Grytolle</div><div class="date">23rd June 2010, 13:52</div></div><div class="posttext">Alright, that's what I feared. One of the files is hosted on a host of mine, so I could easily put together a little php-script for this purpose. The other one is not, but perhaps I can persuade the maker to provide that information somewhere.<br />
<br />
Anyway, thanks for your help!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">23rd June 2010, 13:54</div></div><div class="posttext">Unless that information is stored in the header of the Zip file itself you'd need to decompress the Zip file to find out the uncompressed size - maybe a one time PHP script that does it and writes your text file.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Grytolle</div><div class="date">23rd June 2010, 14:52</div></div><div class="posttext">Yes :)<br />
<br />
Edit: here's my solution<br />
<br />
Create a new php file in the same folder as the file that is to be downloaded:<br />
&lt;?php<br />
$totalsize=0;<br />
$zip = zip_open($saveToDir.&quot;something.zip&quot;);           <br />
while($z = zip_read($zip)) {				<br />
	$totalfilesize += zip_entry_filesize($z);<br />
}<br />
zip_close($zip);<br />
echo &quot;UnzippedLength: &quot;.$totalfilesize;<br />
?&gt;<br />
<br />
Modified code to retrieve the generated string by the php-file:<br />
!addplugindir &quot;.&quot;<br />
RequestExecutionLevel user<br />
OutFile &quot;content-length_test.exe&quot;<br />
<br />
Section<br />
	NSISdl::download_quiet &quot;YOUR URL.php&quot; &quot;$EXEDIR\filesize-za.txt&quot;<br />
	Pop $0<br />
	StrCmp $0 &quot;success&quot; _ok<br />
	    MessageBox MB_OK &quot;Could not download.&quot;<br />
	    goto _end<br />
	_ok:<br />
	    StrCpy $R0 -1<br />
		FileOpen $0 &quot;$EXEDIR\filesize-za.txt&quot; &quot;r&quot;<br />
		_nextline:<br />
		    ClearErrors<br />
		    FileRead $0 $1<br />
		    IfErrors _closeFile<br />
		    StrCpy $2 $1 16<br />
		    StrCmp $2 &quot;UnzippedLength: &quot; _found _nextline<br />
		    _found:<br />
		        StrCpy $R0 $1 &quot;&quot; 16<br />
		        goto _closeFile<br />
	_closeFile:<br />
	FileClose $0<br />
	IntOp $R0 $R0 / 1024		;bytes -&gt; kilobytes<br />
	MessageBox MB_OK &quot;retrieved unzipped size: $R0 KB&quot;<br />
	Delete &quot;$EXEDIR\filesize-za.txt&quot;<br />
	_end:<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">24th June 2010, 10:45</div></div><div class="posttext">Just a thought: You might as well remove the if(zip_entry_filesize($z)==0) continue; line. Quicker to add 0 than to call zip_entry_filesize() twice.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Grytolle</div><div class="date">24th June 2010, 14:46</div></div><div class="posttext">Good point. I can't seem to edit the code above though</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>