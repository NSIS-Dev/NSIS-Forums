<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Problem with C++ class in plugin, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Problem with C++ class in plugin NSIS Discussion" />
	
	<title> Problem with C++ class in plugin [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Problem with C++ class in plugin</div>
<hr />
<div class="pda"><a href="t-226815.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=226815">Problem with C++ class in plugin</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">24th September 2005, 10:58</div></div><div class="posttext">I have no errors when compiling:<br />
<br />
...<br />
TiXmlDocument doc;<br />
<br />
extern &quot;C&quot; void __declspec(dllexport) LoadFile(HWND hwndParent, int string_size, <br />
                                      char *variables, stack_t **stacktop)<br />
{<br />
...<br />
	if (!doc.LoadFile(szBuf))<br />
...<br />
}<br />
<br />
<br />
But it crash when calling &quot;doc.LoadFile(szBuf)&quot;.<br />
If I write like this:<br />
<br />
...<br />
extern &quot;C&quot; void __declspec(dllexport) LoadFile(HWND hwndParent, int string_size, <br />
                                      char *variables, stack_t **stacktop)<br />
{<br />
...<br />
	TiXmlDocument doc;<br />
	if (!doc.LoadFile(szBuf))<br />
...<br />
}<br />
<br />
all working fine, but &quot;TiXmlDocument doc&quot; need to be global for other functions.<br />
<br />
When I write console application no errors were occupied:<br />
<br />
...<br />
TiXmlDocument doc;<br />
<br />
void loadit();<br />
void parseit();<br />
void saveit();<br />
<br />
void main()<br />
{<br />
	loadit();<br />
	parseit();<br />
	saveit();<br />
}<br />
<br />
void loadit()<br />
{<br />
...<br />
	if ( !doc.LoadFile(szBuf) )<br />
...<br />
}<br />
<br />
Any suggestions?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">24th September 2005, 11:16</div></div><div class="posttext">Use /NOUNLOAD or give the user a handle. The global is destroyed when the DLL is unloaded.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">24th September 2005, 11:35</div></div><div class="posttext">I use /NOUNLOAD, but it is unimportant, because it is crash after first call &quot;xml::LoadFile&quot;:<br />
<br />
<br />
Section<br />
	xml::LoadFile /NOUNLOAD &quot;demotest.xml&quot; .r0<br />
	xml::Parse /NOUNLOAD .r0<br />
	xml::SaveFile .r0<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">24th September 2005, 11:43</div></div><div class="posttext">Then something else is probably happening inside xml::LoadFile. Not much can be said without more information.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">24th September 2005, 13:59</div></div><div class="posttext">Minimal variant of the strange error:<br />
<br />
#include &lt;windows.h&gt;<br />
#include &quot;tinyxml.h&quot;<br />
<br />
typedef struct _stack_t {<br />
	struct _stack_t *next;<br />
	char text[1024];<br />
} stack_t;<br />
<br />
stack_t **g_stacktop;<br />
<br />
<br />
TiXmlDocument doc;<br />
<br />
extern &quot;C&quot; void __declspec(dllexport) Load(HWND hwndParent, int string_size, <br />
                                      char *variables, stack_t **stacktop)<br />
{<br />
	doc.LoadFile(&quot;demotest.xml&quot;);<br />
}<br />
<br />
BOOL WINAPI DllMain(HANDLE hInst, ULONG ul_reason_for_call, LPVOID lpReserved)<br />
{<br />
	return TRUE;<br />
}<br />
<br />
<br />
Without error:<br />
<br />
#include &lt;windows.h&gt;<br />
#include &quot;tinyxml.h&quot;<br />
<br />
typedef struct _stack_t {<br />
	struct _stack_t *next;<br />
	char text[1024];<br />
} stack_t;<br />
<br />
stack_t **g_stacktop;<br />
<br />
<br />
extern &quot;C&quot; void __declspec(dllexport) Load(HWND hwndParent, int string_size, <br />
                                      char *variables, stack_t **stacktop)<br />
{<br />
	TiXmlDocument doc;<br />
	doc.LoadFile(&quot;demotest.xml&quot;);<br />
}<br />
<br />
BOOL WINAPI DllMain(HANDLE hInst, ULONG ul_reason_for_call, LPVOID lpReserved)<br />
{<br />
	return TRUE;<br />
}</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">24th September 2005, 15:02</div></div><div class="posttext">You need to manually initialize doc. Without libc, constructors for global variables aren't called.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">24th September 2005, 15:48</div></div><div class="posttext">I got it, thanks!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">24th September 2005, 18:28</div></div><div class="posttext">I had a little played with compiler options and here that have found out. I have erased entry point (/entry:&quot;DllMain&quot;-&gt;&quot;&quot;) and no errors were occupied!</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>