<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" FileCopy Fail on Windows ServerCore, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  FileCopy Fail on Windows ServerCore NSIS Discussion" />
	
	<title> FileCopy Fail on Windows ServerCore [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  FileCopy Fail on Windows ServerCore</div>
<hr />
<div class="pda"><a href="t-359958.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=359958">FileCopy Fail on Windows ServerCore</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">jhop</div><div class="date">23rd April 2013, 17:02</div></div><div class="posttext">Hi, I am making an installer with NSIS.<br />
<br />
I have come across a strange behaviour on Windows ServerCore<br />
<br />
What I am doing is in an upgrade situation, I am copying the existing configuration files to the $TEMP directory.  Then I do an install of the new files.  After that I copy the configuration from $TEMP back into InstDir.<br />
<br />
This works fine on Windows7, but on ServerCore I am getting file copy errors.<br />
<br />
To try to get some error message back from the Copy, I used cmd to copy the files, and then, that worked!  So using the DOS copy command works, but CopyFiles doesnt. <br />
<br />
Any Ideas why?<br />
<br />
	;Restore the pre-existing settings files		<br />
		ClearErrors<br />
		Delete &quot;$INSTDIR\My.cfg&quot;<br />
		${If} ${Errors}<br />
			!insertmacro Log 2 &quot;ERROR: Can't delete $INSTDIR\My.cfg&quot; <br />
			ClearErrors<br />
		${Else}			<br />
			!insertmacro Log 3 &quot;Deleted $INSTDIR\My.cfg&quot; <br />
		${EndIf}<br />
				<br />
		ClearErrors					<br />
		CopyFiles &quot;$TEMP\My.cfg&quot; &quot;$INSTDIR\My.cfg&quot;<br />
				<br />
		${If} ${Errors}		<br />
		    !insertmacro Log 2 &quot;ERROR: Copy Files $TEMP\My.cfg $INSTDIR\My.cfg&quot; <br />
		    Exec 'cmd /K copy &quot;$TEMP\My.cfg&quot; &quot;$INSTDIR\My.cfg&quot; '			<br />
		${EndIf}</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">23rd April 2013, 18:45</div></div><div class="posttext">Have you tried using $PLUGINSDIR instead?<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">24th April 2013, 01:20</div></div><div class="posttext">Copyfiles uses SHFileOperation internally, it is not listed on http://msdn.microsoft.com/en-us/library/ee391633%28v=vs.85%29.aspx not sure if that means it is not going to work...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jhop</div><div class="date">24th April 2013, 09:18</div></div><div class="posttext">CopyFiles is 'core' NSIS functionality?   Can I get a definitive answer if it is expected to work?<br />
<br />
I guess I can us my DOS hack to get by, but I'd rather use proper functions.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">24th April 2013, 09:57</div></div><div class="posttext">SHFileOperation has been a part of Windows since Windows95 which is why NSIS uses it as the workhorse of the CopyFiles instruction. What MS defines as core 15 years later is not really under our control...<br />
<br />
You could call the low level version with: System::Call 'kernel32::CopyFile(t &quot;c:\file.ext&quot;, t &quot;c:\newfile.ext&quot;, i 0)i.r0' and $0 will be 0 on errors</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jhop</div><div class="date">24th April 2013, 12:16</div></div><div class="posttext">that kernel32::CopyFile works.  Thanks a million.<br />
<br />
No idea why, I use a lot of CopyFile calls, and most work, except those two.  They are copying into ProgramFiles, that might be linked...though I installed into C:\&lt;MyFolder&gt;  and had the same issue.<br />
<br />
but...its working.<br />
<br />
Thanks again for the prompt replies.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">25th April 2013, 04:30</div></div><div class="posttext">If some of the CopyFile calls work they should all work, this sounds very weird...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">25th April 2013, 13:13</div></div><div class="posttext">Could it be a CopyFiles popup that is causing the copy to fail (i.e. try using /silent)? I guess you could try with a large file to find out.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bnicer</div><div class="date">25th April 2013, 17:52</div></div><div class="posttext">Hi,<br />
Hope I'm not butting in ...<br />
<br />
You can ignore this.<br />
<br />
It occurs to me that to disable the log text &quot;Copy to:&quot; and &quot;Copy failed&quot; when you use CopyFiles, 'kernel32::CopyFile' is a solution. Pop $0 to see if copying succeeded or failed and insert custom log text. You don't have to resort to SetDetailsPrint none.<br />
<br />
Just an obversation I'd make. I don't know what's causing CopyFiles to not work.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bnicer</div><div class="date">25th April 2013, 23:13</div></div><div class="posttext">Speaking of weird -- I'm copying a group of small files, some of which are locked.<br />
<br />
System::Call 'kernel32::CopyFile(t &quot;$PLUGINSDIR\${folder}\${file}&quot;, t &quot;$OUTDIR\${file}&quot;, i 0)i.r0'<br />
Pop $0<br />
DetailPrint $0<br />
<br />
The log output gives me something entirely weird:<br />
<br />
10881542<br />
Copy to add000.htm<br />
7866318<br />
Copy to add001.htm<br />
4720712<br />
Copy to add002.htm<br />
3409852<br />
Copy to add003.htm<br />
8062710<br />
Copy to add004.htm<br />
7080108<br />
Copy to add005.htm<br />
10881116<br />
Copy to add006.htm<br />
10750470<br />
Copy to add007.htm<br />
0<br />
Copy failed: add008.htm<br />
<br />
All of the files are locked and the exit code for each should be zero. I can swap any nine locked files. The result is consistently that it takes until the nineth one before the Pop $0 returns 0. None of the files do get copied, because they're all locked. Once the nineth file has been passed, the copying behavior is correct. Pop $0 returns 0 or 1, depending on whether the file is locked or not.<br />
<br />
Luckily CopyFiles does work. I'm on Windows 7. I think you may have to Push and Exch in order to fix 'kernel32::CopyFile'. I'm too lazy to give it a go.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">26th April 2013, 05:32</div></div><div class="posttext">Who told you to pop? If you want to pop then the system code should end with ...)i.s'</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bnicer</div><div class="date">26th April 2013, 10:17</div></div><div class="posttext">Yes, it works perfectly. Thanks. Without Pop. :o<br />
<br />
It seems a lot faster than CopyFiles. I use the error code to pop up a message. A lot faster with many messages.<br />
<br />
Is there no drawback, like that it would not run silently, when you copy large files? I know it probably does run silently, but if there's the slightest chance of a window popping up, ...<br />
<br />
Thank you very much indeed, Anders.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">26th April 2013, 12:24</div></div><div class="posttext">CopyFiles uses the same copy engine as Explorer, kernel32::CopyFile is a much more low level copy and should never display anything when called from NSIS</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>