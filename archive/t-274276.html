<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" AccessControl SetRegKeyOwner failing, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  AccessControl SetRegKeyOwner failing NSIS Discussion" />
	
	<title> AccessControl SetRegKeyOwner failing [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  AccessControl SetRegKeyOwner failing</div>
<hr />
<div class="pda"><a href="t-274276.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=274276">AccessControl SetRegKeyOwner failing</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">arrow15</div><div class="date">12th July 2007, 20:28</div></div><div class="posttext">Hi.<br />
<br />
So basically, I'm trying to use AccessControl to gain control of several registry keys before changing their permissions to FullAccess for Everyone, then deleting them. Windows Vista forces every user, including administrators to first take control of a registry key before they can make any modifications to it, if they do not already have explicit write control.<br />
<br />
I've been successful with GrantOnRegKey:<br />
AccessControl::GrantOnRegKey HKLM $KeyPath &quot;Everyone&quot; &quot;FullAccess&quot;<br />
This works perfectly.<br />
<br />
I haven't had the same success with SetRegKeyOwner.<br />
AccessControl::SetRegKeyOwner HKLM $KeyPath &quot;user&quot;<br />
When I pop the errors off the stack for a few of these SetRegKeyOwner, GrantOnRegKey owner sequences, there are no errors for GrantOnRegKey, but for SetRegKeyOwner calls I get the following for the first:<br />
Cannot apply new ownership.<br />
Error code: 0<br />
Then for the rest:<br />
Cannot apply new ownership.<br />
Error code: 997<br />
Error code 997 is ERROR_IO_PENDING, which doesn't really make sense to me, as permissions changes work, and then the first error code reads as 0 (even though it shouldn't error on 0). The user name is correct, because if I put in a bad one, it gives me a bad trustee error.<br />
<br />
Any ideas?...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">arrow15</div><div class="date">12th July 2007, 22:59</div></div><div class="posttext">Follow up:<br />
<br />
So I tried manually changing the registry key's permissions to full control to everyone, and the change of ownership worked. So basically as I see it here's how things stand on Vista:<br />
<br />
-To edit permissions of the registry key (no write owner control), I have to first have the user take control of the key from the administrators group<br />
<br />
-To take control of the key from the administrators group, I must first take write owner control permissions.<br />
<br />
:igor: :igor: :igor:</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">13th July 2007, 09:57</div></div><div class="posttext">I don't know why it fails, but you get the wrong error codes because of a bug in AccessControl. It uses GetLastError() to get the last error of SetNamedSecurityInfo, but SetNamedSecurityInfo uses the return value for specifying the error.<br />
<br />
I've attached a fixed version. Let me know if it works before I upload it to the Wiki.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">arrow15</div><div class="date">13th July 2007, 19:47</div></div><div class="posttext">Yes, thank you, the new version's error codes are accurate. (That's what I suspected might be happening when I looked at the source code) I now get error code 5 (Access denied), which is far more believable, and seems to be what is going wrong. As for finding a solution, I'm still looking, and I'll post it if I find something. From what I've read though, many people consider this registry permissions / ownership business a bug with Vista, because it seems to basically trap you.<br />
<br />
Thanks again.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Lyra78</div><div class="date">27th December 2007, 16:34</div></div><div class="posttext">Hi everybody.<br />
I tried kichik's version of the plug-in and the most recent (November 2007). <br />
I realized that &quot;GrantOnRegKey&quot; doesn't work properly in the last version. Kichik's version works fine.<br />
<br />
Does anyone know why kichik's changes seem to be lost in the last official version?<br />
<br />
Thanks!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">27th December 2007, 17:30</div></div><div class="posttext">In what way does it not work correctly?<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Lyra78</div><div class="date">28th December 2007, 07:48</div></div><div class="posttext">Setting full access on a registry key in local machine doesn't work. It just sets this permission for administrators and power users, not for users. The previous version I mentioned works correctly.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">28th December 2007, 13:04</div></div><div class="posttext">Something else is wrong. The code to change a file or registry ACL has not changed between those two version with the exception of /noinherit.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Lyra78</div><div class="date">28th December 2007, 14:23</div></div><div class="posttext">I'd like to try the intermediate version of AccessControl.dll (August 2007), but I'm not able to find it. Can you help me?<br />
<br />
Anyway, that's what happens: in my installation I create a registry key in local machine, then I set full access for all users by &quot;GrantOnRegKey&quot; function. If I compile the script with the latest version of AccessControl.dll (in ProgramFiles\NSIS\Plugins), and execute the file, then in my registry I get just &quot;reading permissions&quot; for Users.<br />
But if I compile with kichik's version installed, then I get the right permissions for all users of that registry key.<br />
I executed both the compiled files on Windows XP and Vista, and found the same curious behaviour.<br />
<br />
This is my code:<br />
WriteRegStr HKLM &quot;Software\${COMPANY}\$REG_KEY&quot; &quot;$REG_VALUE&quot; &quot;$REG_DATA&quot;<br />
AccessControl::GrantOnRegKey \ <br />
    HKLM &quot;Software\${COMPANY}\$REG_KEY&quot; &quot;(S-1-5-32-545)&quot; &quot;FullAccess&quot;<br />
<br />
Thanks for help.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">31st December 2007, 11:15</div></div><div class="posttext">Any error messages on the stack?<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">7th January 2008, 19:59</div></div><div class="posttext">There was a bug.<br />
http://nsis.sourceforge.net/File:AccessControl.zip<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Lyra78</div><div class="date">8th January 2008, 09:58</div></div><div class="posttext">That's why there weren't any errors on the stack! :-)<br />
<br />
Thanks for the correction: now it works fine!</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>