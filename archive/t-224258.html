<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" $DOCUMENTS does not change to Shared Documents with SetShellVarContext, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  $DOCUMENTS does not change to Shared Documents with SetShellVarContext NSIS Discussion" />
	
	<title> $DOCUMENTS does not change to Shared Documents with SetShellVarContext [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  $DOCUMENTS does not change to Shared Documents with SetShellVarContext</div>
<hr />
<div class="pda"><a href="t-224258.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=224258">$DOCUMENTS does not change to Shared Documents with SetShellVarContext</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">timbuck</div><div class="date">19th August 2005, 13:31</div></div><div class="posttext">Hi there, I've tried to find the answer on this website with no luck, although I am pretty sure someone else must have seen this. :)<br />
<br />
I want to install some files to the 'shared documents' folder.<br />
<br />
The documentation says...<br />
<br />
<br />
$DOCUMENTS<br />
<br />
The documents directory. A typical path for the current user is C:\Documents and Settings\Foo\My Documents. The context of this constant (All Users or Current user) depends on the SetShellVarContext setting. The default is the current user.<br />
<br />
<br />
But if I compile the following script and run it on NT4 or XP PRO I only get the users documents folder. Strangely it works on XP Home.<br />
<br />
<br />
Name &quot;Test&quot;<br />
OutFile &quot;Setup.exe&quot;<br />
<br />
Function .onInit<br />
   MessageBox MB_OK &quot;$DOCUMENTS&quot;<br />
   MessageBox MB_OK &quot;$SMPROGRAMS&quot;<br />
<br />
   SetShellVarContext &quot;all&quot;<br />
   MessageBox MB_OK &quot;$DOCUMENTS&quot;<br />
   MessageBox MB_OK &quot;$SMPROGRAMS&quot;<br />
FunctionEnd<br />
<br />
Section &quot;default&quot;<br />
SectionEnd<br />
 <br />
<br />
(I should add that $SMPROGRAMS functions correctly, but not $DOCUMENTS)<br />
<br />
Does anyone know why this is, or is there a suggested workaround?<br />
<br />
From a C++ windows API point of view the Shared Documents file does exist on these systems and is retrieved by a call to SHGetSpecialFolderPath(...) so I am not sure why $DOCUMENTS would differ from this.<br />
<br />
I'd just like to add that I really have preffered NSIS over other certain offerings that do a lot of (irritating) things by default and you spend ages trying to turn it all off. NSIS on the other hand just does what you tell it to. Nice. ;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">timbuck</div><div class="date">19th August 2005, 14:06</div></div><div class="posttext">Well... I've had to come up with a workaround that uses a new method in our plugin dll (taken from the example exdll).<br />
<br />
I'd still like to know if I could avoid it though!<br />
<br />
Here is the workaround<br />
<br />
C++:<br />
<br />
void __declspec(dllexport) GetSharedFolderLocation<br />
   (<br />
   HWND hwndParent,          // <br />
   int string_size,          // <br />
   char *variables,          // <br />
   stack_t **stacktop,       // <br />
   extra_parameters *extra   // <br />
   ) <br />
{<br />
   g_hwndParent=hwndParent;<br />
   <br />
   EXDLL_INIT();<br />
 <br />
   // do your stuff here<br />
   {<br />
      // Get the Shared Folder<br />
      // get path of Shared Documents<br />
      char sharedDocsPath[MAX_PATH];<br />
      SHGetSpecialFolderPath(NULL, sharedDocsPath, CSIDL_COMMON_DOCUMENTS, 0);<br />
      pushstring( sharedDocsPath );<br />
   }<br />
}<br />
<br />
<br />
   <br />
NSIS:<br />
<br />
   utils::GetSharedFolderLocation<br />
   Pop $0<br />
   MessageBox MB_OK &quot;$0&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">19th August 2005, 16:19</div></div><div class="posttext">$DOCUMENTS is implanted using SHGetSpecialFolderLocation with CSIDL_COMMON_DOCUMENTS, which should be no different. I have no idea why it should work differently at all, and specifically on different versions of XP. We can not use SHGetSpecialFolderPath because it's not available on all supported versions of Windows.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">timbuck</div><div class="date">19th August 2005, 21:34</div></div><div class="posttext">Hi, thanks for your reply!<br />
<br />
That IS strange, I am going to do a little test and I'll post the results on monday when I can get to the other machines.<br />
<br />
Apparently a quick read suggests SHGetFolderPath superceded both of our functions with Win 2000/ME and it looks like it exists in both Shfolder.dll and Shell32.dll depending on what you link with I think. I wonder if one function is linking into one and the other into the other?<br />
<br />
Thankfully, I am ok to call this function during the installation because we install the shfolder.dll redistributable (shfolder.exe) before we call it.<br />
<br />
Anyway, I'll let you know what the other Shell functions are returning on these machines when I get back in to work!<br />
<br />
(I am probably unlucky and our systems dept have our machines setup weirdly! We'll see.)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">timbuck</div><div class="date">19th August 2005, 21:38</div></div><div class="posttext">Just thought, I hadn't installed the ShFolder.dll on the NT box before running the test, which may explain it's behavior, but that still leaves me with the XP Pro/Home mystery.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>