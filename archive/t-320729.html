<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" VersionCompare fails, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  VersionCompare fails NSIS Discussion" />
	
	<title> VersionCompare fails [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  VersionCompare fails</div>
<hr />
<div class="pda"><a href="t-320729.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=320729">VersionCompare fails</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">dbach</div><div class="date">12th July 2010, 14:27</div></div><div class="posttext">Hi Community.<br />
<br />
I wrote a macro named GetMostRecentFile. It compares two files and delivers the winner back.<br />
<br />
Example call of Macro:<br />
${GetMostRecentFile} &quot;$PLUGINSDIR\${DLL}&quot; &quot;${_platformpath}\${_applicationpath}\${DLL}&quot; $0<br />
<br />
<br />
<br />
The &quot;GetVersion&quot; Macro:<br />
; --- Requirements<br />
!ifndef LOGICLIB<br />
	!include &quot;LogicLib.nsh&quot;<br />
!endif<br />
<br />
; -- GetVersion<br />
!define MACRO_GETVERSION_INCLUDED<br />
!define GetVersion &quot;!insertmacro GetVersion&quot;<br />
!macro GetVersion _GetVersionFile _GetVersionVar<br />
	ClearErrors<br />
	<br />
	StrCpy $R0 &quot;&quot;<br />
	StrCpy $R1 &quot;&quot;<br />
	StrCpy $R2 &quot;&quot;<br />
	StrCpy $R3 &quot;&quot;<br />
	StrCpy $R4 &quot;&quot;<br />
	StrCpy $R5 &quot;&quot;<br />
	<br />
	GetDLLVersion &quot;${_GetVersionFile}&quot; $R0 $R1<br />
	${If} ${Errors}<br />
		DetailPrint &quot;Could not get version info from '${_GetVersionFile}'&quot;<br />
	${EndIf}<br />
		<br />
	IntOp $R2 $R0 / 0x00010000 ; $R2 now contains major version<br />
	IntOp $R3 $R0 &amp; 0x0000FFFF ; $R3 now contains minor version<br />
	IntOp $R4 $R1 / 0x00010000 ; $R4 now contains release<br />
	IntOp $R5 $R1 &amp; 0x0000FFFF ; $R5 now contains build<br />
	<br />
	StrCpy ${_GetVersionVar} &quot;$R2.$R3.$R4.$R5&quot;<br />
!macroend<br />
<br />
<br />
The GetMostRecentFile macro:<br />
; --- Requirements<br />
!ifndef LOGICLIB<br />
	!include &quot;LogicLib.nsh&quot;<br />
!endif<br />
<br />
!ifndef WORDFUNC_INCLUDED<br />
	!include &quot;WordFunc.nsh&quot;<br />
!endif<br />
<br />
!ifndef MACRO_GETVERSION_INCLUDED<br />
	!include &quot;macro.getversion.nsh&quot;<br />
!endif<br />
<br />
!insertmacro VersionCompare<br />
Var _VersionCompareFile1<br />
Var _VersionCompareFile2<br />
Var _VersionCompareResult<br />
<br />
<br />
; --- GetMostRecentFile<br />
!define GetMostRecentFile '!insertmacro GetMostRecentFile'<br />
!define MACRO_GETMOSTRECENTFILE_INCLUDED<br />
<br />
!macro GetMostRecentFile _file1 _file2 _var<br />
ClearErrors<br />
${If} 	 ${FileExists} &quot;${_file1}&quot;<br />
${AndIf} ${FileExists} &quot;${_file2}&quot;<br />
	<br />
	LogText &quot;${_file1}: Getting version&quot;<br />
	${GetVersion} &quot;${_file1}&quot; $_VersionCompareFile1<br />
	LogText &quot;${_file1}: Version - $_VersionCompareFile1&quot;<br />
	<br />
	${IfNot} ${Errors}<br />
		<br />
		LogText &quot;${_file2}: Getting version&quot;<br />
		${GetVersion} &quot;${_file2}&quot; $_VersionCompareFile2<br />
		LogText &quot;${_file2}: Version - $_VersionCompareFile2&quot;<br />
		<br />
		${IfNot} ${Errors}<br />
			<br />
			LogText &quot;Comparing: '${_file1}' vs. '${_file2}'&quot;<br />
			${VersionCompare} &quot;${_file1}&quot; &quot;${_file2}&quot; $_VersionCompareResult<br />
			LogText &quot;Result: $_VersionCompareResult&quot;<br />
			<br />
			${If} $_VersionCompareResult == &quot;0&quot; ; equal<br />
				LogText &quot;Result mean: Equal&quot;<br />
				StrCpy ${_var} &quot;${_file1}&quot; ; copy back the first value<br />
				<br />
			${ElseIf} $_VersionCompareResult == &quot;1&quot; ; file 1 newer<br />
				LogText &quot;Result mean: ${_file1} is newer&quot;<br />
				StrCpy ${_var} &quot;${_file1}&quot; ; copy back the first value<br />
				<br />
			${ElseIf} $_VersionCompareResult == &quot;2&quot; ; file 2 newer<br />
				LogText &quot;Result mean: ${_file2} is newer&quot;<br />
				StrCpy ${_var} &quot;${_file2}&quot; ; copy back the second value<br />
				<br />
			${EndIf}<br />
<br />
		${Else}<br />
			DetailPrint &quot;GetMostRecentFile failed on '${_file2}'. Returning ${_file1} as result.&quot;<br />
			StrCpy ${_var} &quot;${_file2}&quot; <br />
			<br />
		${EndIf}<br />
			<br />
	${Else}<br />
		DetailPrint &quot;GetMostRecentFile failed on '${_file1}'. Returning ${_file1} as result.&quot;<br />
		StrCpy ${_var} &quot;${_file1}&quot; <br />
<br />
	${EndIf}<br />
	<br />
<br />
${Else}<br />
	${IfNot} ${FileExists} &quot;${_file1}&quot;<br />
		DetailPrint &quot;GetMostRecentFile Error: '${_file1}' does not exists.&quot;<br />
		StrCpy ${_var} &quot;${_file2}&quot; <br />
		<br />
	${EndIf}<br />
	<br />
	${IfNot} ${FileExists} &quot;${_file2}&quot;<br />
		DetailPrint &quot;GetMostRecentFile Error: '${_file2}' does not exists.&quot;<br />
		StrCpy ${_var} &quot;${_file1}&quot; <br />
		<br />
	${EndIf}<br />
${EndIf}<br />
!macroend<br />
<br />
<br />
And the (frustrating) result:<br />
IfFileExists: file &quot;C:\DOCUME~1\VIRTUA~1\LOCALS~1\Temp\nssF.tmp\NAMEOF.dll&quot; exists, jumping 0<br />
IfFileExists: file &quot;C:\Program Files\product\NAMEOF.dll&quot; exists, jumping 0<br />
C:\DOCUME~1\VIRTUA~1\LOCALS~1\Temp\nssF.tmp\NAMEOF.dll: Getting version<br />
C:\DOCUME~1\VIRTUA~1\LOCALS~1\Temp\nssF.tmp\NAMEOF.dll: Version - 4.2.0.33<br />
C:\Program Files\product\NAMEOF.dll: Getting version<br />
C:\Program Files\product\NAMEOF.dll: Version - 4.4.0.22<br />
Comparing: 'C:\DOCUME~1\VIRTUA~1\LOCALS~1\Temp\nssF.tmp\NAMEOF.dll' vs. 'C:\Program Files\product\NAMEOF.dll'<br />
Call: 859<br />
Jump: 915<br />
Jump: 926<br />
Result: 1<br />
Result mean: C:\DOCUME~1\VIRTUA~1\LOCALS~1\Temp\nssF.tmp\NAMEOF.dll is newer<br />
Jump: 939<br />
Jump: 942<br />
Jump: 945<br />
Jump: 952<br />
Most recent version 'C:\DOCUME~1\VIRTUA~1\LOCALS~1\Temp\nssF.tmp\NAMEOF.dll' is copied to 'C:\Program Files\product\'<br />
<br />
<br />
The older version is detected as newer version? Am I doing something wrong which I don't see here? :|<br />
<br />
thnx</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dbach</div><div class="date">12th July 2010, 15:35</div></div><div class="posttext">Changed: ${VersionCompare} &quot;${_file1}&quot; &quot;${_file2}&quot; $_VersionCompareResult <br />
To:  ${VersionCompare} &quot;$_VersionCompareFile1&quot; &quot;$_VersionCompareFile2&quot; $_VersionCompareResult <br />
<br />
Now its working. ;)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>