<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Can I detect the number of CPUs in a multiprocessor machine?, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Can I detect the number of CPUs in a multiprocessor machine? NSIS Discussion" />
	
	<title> Can I detect the number of CPUs in a multiprocessor machine? [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Can I detect the number of CPUs in a multiprocessor machine?</div>
<hr />
<div class="pda"><a href="t-168893.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=168893">Can I detect the number of CPUs in a multiprocessor machine?</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Ythan</div><div class="date">10th February 2004, 23:27</div></div><div class="posttext">I just started working with the NSIS and I love its power and flexibility, but I have a question. I was wondering if there's any way to detect the number of processors in a computer. It seems like it might be possible using the System plugin, but I can't figure out how. If anyone has experience in this area, I'd sure appreciate any help you can offer.<br />
<br />
Thanks in advance!<br />
<br />
-Y</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">10th February 2004, 23:35</div></div><div class="posttext">See the MSDN documentation for information about the GetSystemInfo API.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Ythan</div><div class="date">11th February 2004, 08:46</div></div><div class="posttext">Cool, thanks so much for your help! I apologize in advance for asking what I'm sure is an obvious questions, but my background is in PHP scripting so this Windows API stuff is pretty foreign to me.<br />
<br />
Anyway, I researched this and found that GetSystemInfo returns information in the following order: OEM ID, page size, minimum application address, maximum application address, active cpu mask, number of cpus, cpu type, allocation granularity, reserved. Given this, is my code to store the number of CPUs in $1 correct?<br />
<br />
System::Alloc 32<br />
Pop $0<br />
System::Call &quot;Kernel32::GetSystemInfo(i) v (r0)&quot;<br />
System::Call &quot;*$0(v,v,v,v,v,&amp;i4 .r1)&quot;<br />
System::Free $0<br />
<br />
I tested this and I'm pretty sure it returns the right value. However, I wrote it from bits and pieces of other examples I found around the net and I'm not sure exactly what I'm doing. What I really want to know is whether the code is sloppy, or if it's 'correct' for what I'm trying to do. Hopefully someone with a little more experience using the system plugin to call DLLs can tell me whether I should make any changes.<br />
<br />
Thanks again,<br />
<br />
-Y</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">13th February 2004, 09:14</div></div><div class="posttext">SYSTEM_INFO is 36 bytes so you should allocate 36 bytes and not 32. Other than that, it all seems correct, thought just to be sure I'd replace all the v's on line 4 with i's, because it is DWORD and not void.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Ythan</div><div class="date">13th February 2004, 19:27</div></div><div class="posttext">Awesome! That's just what I needed to know. Thanks both of you for all your help.<br />
<br />
-Y</div></div><hr />


<div class="post"><div class="posttop"><div class="username">vicokoby</div><div class="date">29th June 2011, 23:34</div></div><div class="posttext">why 36?, please give a explanation?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">29th June 2011, 23:40</div></div><div class="posttext">why 36?, please give a explanation?<br />
<br />
The size of SYSTEM_INFO on a 32 bit system</div></div><hr />


<div class="post"><div class="posttop"><div class="username">vicokoby</div><div class="date">29th June 2011, 23:57</div></div><div class="posttext">How can I get the architecture?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">vicokoby</div><div class="date">30th June 2011, 00:40</div></div><div class="posttext">;This is my try to get the Processor Architecture:<br />
<br />
System::Alloc 32<br />
Pop $0<br />
System::Call &quot;Kernel32::GetSystemInfo(i r0)&quot;<br />
System::Call &quot;*$0(i, &amp;i2 .r1)&quot;<br />
System::Free $0<br />
DetailPrint &quot;Processor Architecture: $1&quot; ; This print 4096 but it not a valid value!<br />
<br />
Please help me!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">30th June 2011, 18:21</div></div><div class="posttext">This whole thread is about using 36 as the size and you continue to use 32???</div></div><hr />


<div class="post"><div class="posttop"><div class="username">vicokoby</div><div class="date">30th June 2011, 18:26</div></div><div class="posttext">Sorry,<br />
<br />
Wich is the size in a 64 bit System?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">30th June 2011, 18:41</div></div><div class="posttext">Sorry,<br />
<br />
Wich is the size in a 64 bit System?<br />
<br />
NSIS is still 32bit. (If you wanted to call GetNativeSystemInfo, then the info might change but this thread is not about the native version)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">vicokoby</div><div class="date">30th June 2011, 18:48</div></div><div class="posttext">Thanks!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TrifonovS</div><div class="date">1st March 2012, 08:20</div></div><div class="posttext">There is still problem with this code. I tested the following lines (allocated memory is 36 bytes):<br />
<br />
System::Alloc 36<br />
Pop $0<br />
${If} $0 &lt;&gt; 0<br />
  MessageBox MB_OK &quot;Allocation done!&quot;<br />
  System::Call &quot;Kernel32::GetSystemInfo(i r0)&quot;<br />
  System::Call &quot;*$0(i, &amp;i2 .r1)&quot;<br />
  System::Free $0<br />
${Else}<br />
  MessageBox MB_OK &quot;Allocation failed!&quot;<br />
${EndIf}<br />
MessageBox MB_OK &quot;Results: $1&quot; ; The result is 4096 (tested on XP and 7)<br />
<br />
Why the result in $1 is always 4096? Little help, please!!!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st March 2012, 11:37</div></div><div class="posttext">You're trying to detect the system architecture? Just use x64.nsh.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">1st March 2012, 11:45</div></div><div class="posttext">System::Call &quot;*$0(i, &amp;i2 .r1)&quot;<br />
That code makes no sense at all, you are grabbing a invalid field by doing this.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TrifonovS</div><div class="date">1st March 2012, 15:33</div></div><div class="posttext">You're trying to detect the system architecture? Just use x64.nsh.<br />
<br />
Stu<br />
<br />
I already done it and it works, but I just want to understand why I can not make it with the function GetSystemInfo().<br />
<br />
That code makes no sense at all, you are grabbing a invalid field by doing this.<br />
Yes, I saw this (sorry that I didn't mentioned it). I need the first word from the union in the beginning of the structure of type SYSTEM_INFO, because:<br />
<br />
typedef struct _SYSTEM_INFO {<br />
  union {<br />
    DWORD  dwOemId;<br />
    struct {<br />
      WORD wProcessorArchitecture;<br />
      WORD wReserved;<br />
    };<br />
  };<br />
  DWORD     dwPageSize;<br />
  LPVOID    lpMinimumApplicationAddress;<br />
  LPVOID    lpMaximumApplicationAddress;<br />
  DWORD_PTR dwActiveProcessorMask;<br />
  DWORD     dwNumberOfProcessors;<br />
  DWORD     dwProcessorType;<br />
  DWORD     dwAllocationGranularity;<br />
  WORD      wProcessorLevel;<br />
  WORD      wProcessorRevision;<br />
} SYSTEM_INFO;<br />
<br />
So if I understood correct the syntax, I have to use:<br />
<br />
System::Call &quot;*$0(&amp;i2 .r1)&quot;<br />
<br />
I tried this and I tried also:<br />
<br />
System::Call &quot;*$0(i .r1)&quot;<br />
<br />
... and I always get 4096. Where is my mistake? When I try to get  dwNumberOfProcessors and dwProcessorType, I see meaningful values.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st March 2012, 15:41</div></div><div class="posttext">The correct call is:<br />
System::Call `*$0(&amp;i2 .r1)`<br />
<br />
However you will always get 0 because NSIS is 32-bit (that's what I get with the above). The correct way is how x64.nsh does it in the _RunningX64 macro.<br />
<br />
Stu</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>