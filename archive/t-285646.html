<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Installer not setting environment variables second time around., media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Installer not setting environment variables second time around. NSIS Discussion" />
	
	<title> Installer not setting environment variables second time around. [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Installer not setting environment variables second time around.</div>
<hr />
<div class="pda"><a href="t-285646.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=285646">Installer not setting environment variables second time around.</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">pgg1</div><div class="date">25th January 2008, 16:15</div></div><div class="posttext">Hi<br />
<br />
I have an installer that installs my application and sets environment variables. I set these variables using kichik's script and the SetEnv.dll. I use SetEnv.dll to launch the application from the finish page. Everything work greats.<br />
<br />
I've recently changed my script so now we uninstall any older versions of our application (if one is installed) and then install the newer one.<br />
<br />
The problem is that the environment variables do not get set the second time around, for example:<br />
<br />
(1) Install application (adds Environment variables).<br />
(2) Uninstall the application using installer.exe, this removes the environment variables.<br />
(3) Install application (DOES NOT add the Environment variables) therefore application cannot start.<br />
<br />
Does anyone have any suggestions?<br />
<br />
Regards<br />
<br />
Paul</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">26th January 2008, 15:51</div></div><div class="posttext">Did you execute the uninstaller from the installer? If so, the installer didn't get a chance to update its environment table and so it thinks the environment variable is still set and therefore doesn't set it again.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pgg1</div><div class="date">27th January 2008, 16:45</div></div><div class="posttext">Yes I did execute the uninstaller from the installer. How do I get around this problem?<br />
<br />
Regards<br />
<br />
Paul</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">27th January 2008, 17:52</div></div><div class="posttext">Manually modify the environment variables for the working installer as well. Use:<br />
<br />
http://nsis.sourceforge.net/Setting_Environment_Variables_to_Active_Installer_Process</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pgg1</div><div class="date">27th January 2008, 19:08</div></div><div class="posttext">Sorry I don't quite get what your saying. Could you clarify what you meant please.<br />
<br />
At the moment I use: http://nsis.sourceforge.net/Path_Manipulation<br />
to set my environment variables, and this is done within a section.<br />
<br />
I am already using:<br />
http://nsis.sourceforge.net/Setting_Environment_Variables_to_Active_Installer_Process<br />
in a function, and this function gets called from the active installer (i.e. finish page) so I can launch the application from the installer.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">27th January 2008, 22:33</div></div><div class="posttext">But you don't remove the path from the installer's environment after the uninstaller is executed.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pgg1</div><div class="date">28th January 2008, 06:17</div></div><div class="posttext">Isn't that just solving one problem and creating another? If I don't clean up after an uninstall then after numerous installs each one representing a newer release I will be adding duplicate environment variables. I've just tested:<br />
<br />
http://nsis.sourceforge.net/Path_Manipulation<br />
<br />
and it just concatenates to the end without any checking to determine if the environment variable your adding is already contained within.<br />
<br />
Regards<br />
<br />
Paul</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pgg1</div><div class="date">28th January 2008, 13:53</div></div><div class="posttext">I have a solution, I'll post what I have done later as I don't have time right now.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pgg1</div><div class="date">28th January 2008, 18:17</div></div><div class="posttext">I've taken this from a post last year.<br />
<br />
<br />
; This function allows us to add/remove directories to/from the system path.<br />
!macro SetSystemPath un_<br />
   function ${un_}SetSystemPath<br />
      # stack top: &lt;'string to add'&gt; / &lt;AppendFlag&gt;<br />
      Exch $0	; new string<br />
      Exch<br />
      Exch $1   ; append = 2, prefix = 1, remove = 0<br />
      Push $R0	; saved working registers<br />
<br />
      ReadRegStr $R0 HKLM &quot;${REGISTRY_ENVIRONMENT}&quot; &quot;Path&quot;<br />
<br />
      ${Select} $1<br />
         ${Case} 0<br />
         	${${un_}WordAdd} &quot;$R0&quot; &quot;;&quot; &quot;-$0&quot; $R0<br />
         ${Case} 1<br />
    		${${un_}WordAdd} &quot;$0&quot; &quot;;&quot; &quot;+$R0&quot; $R0<br />
         ${Case} 2<br />
    		${${un_}WordAdd} &quot;$R0&quot; &quot;;&quot; &quot;+$0&quot; $R0<br />
       ${EndSelect}<br />
<br />
       WriteRegExpandStr HKLM &quot;${REGISTRY_ENVIRONMENT}&quot; &quot;Path&quot; &quot;$R0&quot;<br />
       Pop $R0				; restore registers<br />
       Pop $1<br />
       Pop $0<br />
       SendMessage ${HWND_BROADCAST} ${WM_WININICHANGE} 0 &quot;STR:Environment&quot; /TIMEOUT=5000<br />
    functionEnd<br />
!macroend<br />
!insertmacro SetSystemPath &quot;&quot;<br />
!insertmacro SetSystemPath &quot;un.&quot;<br />
<br />
<br />
I then use it like this in a section:<br />
<br />
Push 2 ; 2 = append.<br />
Push ${DLLS_ABSOLUTE_PATH}<br />
Call SetSystemPath<br />
<br />
WriteRegExpandStr HKLM &quot;${REGISTRY_ENVIRONMENT}&quot; &quot;${ZANG_HOME}&quot; &quot;$INSTDIR&quot;<br />
  SendMessage ${HWND_BROADCAST} ${WM_WININICHANGE} 0 &quot;STR:Environment&quot; /TIMEOUT=5000<br />
<br />
WriteRegExpandStr HKLM &quot;${REGISTRY_ENVIRONMENT}&quot; &quot;${FFMPEG_HOME}&quot; &quot;$INSTDIR\ffmpeg&quot;<br />
  SendMessage ${HWND_BROADCAST} ${WM_WININICHANGE} 0 &quot;STR:Environment&quot; /TIMEOUT=5000<br />
<br />
<br />
and uninstall:<br />
<br />
<br />
; Remove System variables.<br />
  Push 0 ; 0 = remove<br />
  Push ${DLLS_ABSOLUTE_PATH}<br />
  Call Un.SetSystemPath<br />
  <br />
  ; Remove User variables.<br />
  Push ${ZANG_HOME}<br />
  Push $INSTDIR<br />
  Call un.RemoveFromEnvVar<br />
  <br />
  Push ${FFMPEG_HOME}<br />
  Push &quot;$INSTDIR\ffmpeg&quot;<br />
  Call un.RemoveFromEnvVar<br />
<br />
<br />
It's ugly but it works, if anyone has any further thoughts I'd appreciate them.<br />
<br />
Regards<br />
<br />
Paul</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>