<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" UAC plug-in and MultiUser dialog, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  UAC plug-in and MultiUser dialog NSIS Discussion" />
	
	<title> UAC plug-in and MultiUser dialog [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  UAC plug-in and MultiUser dialog</div>
<hr />
<div class="pda"><a href="t-314869.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=314869">UAC plug-in and MultiUser dialog</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">TrifonovS</div><div class="date">26th November 2009, 10:10</div></div><div class="posttext">Hi,<br />
I'm trying to use UAC plug-in in my script which already uses the MultiUser dialog for selection between all-users and current-user installation. Here it comes the problem. For UAC plug-in I have to set the user level to user, but then I get an error from MultiUser macro, because it needs admin rights. But I need both things in my script. Can you advice me how to solve my problem? I don't want to make my own MultiUser page, because I'm not very familiar with this and it will take time until I make it. Is there an easy solution?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">26th November 2009, 10:29</div></div><div class="posttext">If you want to use the UAC plugin, you will have to use a custom dialog. The design of MultiUser is broken IMHO, if you set requestexecutionlevel to admin, you can't do a &quot;single user&quot; install</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TrifonovS</div><div class="date">26th November 2009, 10:34</div></div><div class="posttext">Tanks Anders,<br />
I expected that this will be the answer. However, is there anybody who can share some code for such a custom multi-user dialog?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">26th November 2009, 10:36</div></div><div class="posttext">Use nsDialogs to create a custom page.<br />
<br />
NSIS\Examples\nsDialogs\example.nsi<br />
NSIS\Docs\nsDialogs\Readme.html<br />
<br />
Edit: Here, I'll share some code that I've been writing for my elevate-only-when-necessary installer:<br />
<br />
Function MODESELECT<br />
  nsDialogs::Create /NOUNLOAD 1018<br />
  Pop $2<br />
  ${NSD_CreateGroupBox} 0u 40u 300u 92u &quot;Installation User Policy&quot;<br />
  Pop $2<br />
  ${If} $ACCESSLEVEL == &quot;User&quot;<br />
    ${NSD_CreateLabel} 10u 53u 280u 25u &quot;Setup can install this software \<br />
                       either for this user, or for all users on this \<br />
                       computer. You will require Administrator privileges \<br />
                       to install this software for all users. Select the \<br />
                       required option below and click Next to continue.&quot;<br />
  ${Else}<br />
    ${NSD_CreateLabel} 10u 53u 280u 25u &quot;Setup can install this software \<br />
                       either for this user, or for all users on this \<br />
                       computer. Select the required option below and \<br />
                       click Next to continue.&quot;<br />
  ${EndIf}<br />
  Pop $2<br />
  System::Call &quot;advapi32::GetUserName(t.r2, *i ${NSIS_MAX_STRLEN})&quot;<br />
  ${NSD_CreateRadioButton} 10u 83u 280u 14u &quot;Install only for this &amp;user ($2)&quot;<br />
  Pop $NSDFIELD1<br />
  ${NSD_OnClick} $NSDFIELD1 MODESELECTRadioButton<br />
  ${NSD_CreateRadioButton} 10u 97u 280u 14u &quot;Install for &amp;all users&quot;<br />
  Pop $NSDFIELD2<br />
  ${NSD_OnClick} $NSDFIELD2 MODESELECTRadioButton<br />
  ${If} $ACCESSLEVEL == &quot;User&quot;<br />
    SendMessage $NSDFIELD1 ${BM_SETCHECK} 1 0<br />
    ${NSD_SetFocus} $NSDFIELD1<br />
  ${Else}<br />
    SendMessage $NSDFIELD2 ${BM_SETCHECK} 1 0<br />
    ${NSD_SetFocus} $NSDFIELD2<br />
  ${EndIf}<br />
  call MODESELECTRadioButton<br />
  !insertmacro MUI_HEADER_TEXT &quot;Select Installation Type&quot; \<br />
                               &quot;Choose how you want to install $(^Name).&quot;<br />
  nsDialogs::Show<br />
FunctionEnd<br />
<br />
Function MODESELECTRadioButton<br />
  ${If} $ACCESSLEVEL == &quot;User&quot;<br />
    ${NSD_GetState} $NSDFIELD2 $2<br />
    GetDlgItem $0 $hwndParent 1<br />
    SendMessage $0 /*BCM_SETSHIELD*/0x0000160C 0 $2<br />
  ${EndIf}<br />
FunctionEnd<br />
<br />
Function MODESELECTLeave<br />
  SendMessage $NSDFIELD2 ${BM_GETCHECK} 0 0 $ALLUSERS<br />
  ${If} $ALLUSERS == 1<br />
  ${AndIf} $ACCESSLEVEL == &quot;User&quot;<br />
    ;Call for elevation.<br />
    StrCpy $ELEVATIONPAGE &quot;MODESELECT&quot;<br />
    ${SelfElevation}<br />
  ${EndIf}<br />
FunctionEnd<br />
<br />
Please don't copy paste this code, as it hasn't even been tested to compile yet. Also it is closely tied in to a shitload of other code, that I'm not going to describe here. But it may serve to give you an idea of how to go about doing this your own way.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TrifonovS</div><div class="date">26th November 2009, 10:54</div></div><div class="posttext">Thanks MSG! I will try to understand it and use it :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TrifonovS</div><div class="date">27th November 2009, 07:23</div></div><div class="posttext">Hi MSG,<br />
Now I made my dialog. The next step is to implement the UAC plug-in. In connection to this I have two questions:<br />
1. You make the elevation when leaving the multi-user dialog. Is it possible? I thought that this must be done in .onInit function before creation of the first dialog.<br />
2. You make the elevation only when installation for all users is selected and the current level is user. I think that there will be a problem to install something that tries to install DLLs in Windows/System32 if you select current user installation and the current level is user. What do you think? Isn't it necessary to make elevation always if the current level is user?<br />
I hope that I got the correct idea what the UAC is doing, but I really need some more help. I read some treads, connected to his problem, but some pieces of information are still missing :(.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">27th November 2009, 08:45</div></div><div class="posttext">Originally posted by TrifonovS <br />
1. You make the elevation when leaving the multi-user dialog. Is it possible? I thought that this must be done in .onInit function before creation of the first dialog.<br />
I knew you were going to ask that. :-)  Yes, it is possible but rather complicated. Look at UAC_DualMode.nsi in the experimental build. Here's what I use:<br />
<br />
(Oops, let me pastebin that...)<br />
http://nsis.pastebin.com/f14fb0a6a<br />
Please note that all the UAC magic is taken from UAC_DualMode as designed by Anders. I wouldn't be able to come up with all this stuff on my own, I'm sure.<br />
<br />
Originally posted by TrifonovS <br />
2. You make the elevation only when installation for all users is selected and the current level is user. I think that there will be a problem to install something that tries to install DLLs in Windows/System32 if you select current user installation and the current level is user. What do you think? Isn't it necessary to make elevation always if the current level is user?<br />
Yes, if you need to do anything admin-ish, then you might as well elevate in .onInit and save yourself all the trouble. The point of my whole exercise is to have an installer that supports user-level installation, for those applications that don't specifically *must* be installed as admin. So what I do is elevate only when necessary, for example when trying to install into a protected directory, or trying to install for all users.<br />
<br />
Using the above idea, the installer will only ask for elevation after the user selects some admin-ish option. The installer is elevated, all important variables that may have already been given values ($INSTDIR etc) are synchronized into the new admin-instance, I use the $ELEVATIONPAGE variable to jump to the same page they just elevated from... And voila, all the user notices is a popup asking for the admin password.<br />
<br />
<br />
Of course, I had to add piles of peripheral code to support win9x, power users on win2k/XP, detection of whether a directory is writable by the user, disable the page's Back button after elevation, and so on and so forth. But that's all in a day's work. :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TrifonovS</div><div class="date">27th November 2009, 11:00</div></div><div class="posttext">MSG, thanks a lot for the huge help. I got the idea. Actually I have one more question (for now) :) ... Now I'm thinking about how to jump to the page using the information from the variable $ELEVATIONPAGE. Is there an easy way, or I have to go trough all pages and skip them until I reach the needed one?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">27th November 2009, 11:10</div></div><div class="posttext">http://nsis.pastebin.com/ff7389e9<br />
<br />
Of course, the jumps are relative so you'll have to change &quot;3&quot;, &quot;4&quot;, &quot;5&quot; and &quot;6&quot; to the proper values. And you'll have to disable the Back button after some (or all) jumps, for example to prevent someone from doing &quot;Install for all users&quot;-&gt;Next-&gt;(Elevate)-&gt;Back-&gt;&quot;Install for this user (Administrator)&quot;.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TrifonovS</div><div class="date">27th November 2009, 14:52</div></div><div class="posttext">Oops, one more question. In the example UAC_DualMode.nsi the plug-in is not unloaded. Is it correct? In the repository is described that the following calls must be included in the code:<br />
<br />
Function .OnInstFailed<br />
    UAC::Unload ;Must call unload!<br />
FunctionEnd<br />
 <br />
Function .OnInstSuccess<br />
    UAC::Unload ;Must call unload!<br />
FunctionEnd<br />
<br />
When I put this to my code it can not be compiled. Can you tell me what I'm doing wrong?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">27th November 2009, 15:23</div></div><div class="posttext">The latest versions of NSIS use a new plugin model: plugins no longer require manual unloading. UAC applies this new plugin model.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TrifonovS</div><div class="date">30th November 2009, 10:31</div></div><div class="posttext">Hi again,<br />
One more question. How can I check the current level? I want to know if the account from where the installer is called has admin level or not. Simply said I need to know how to initialize the mentioned above variable ACCESSLEVEL...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">30th November 2009, 13:56</div></div><div class="posttext">userinfo plugin.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>