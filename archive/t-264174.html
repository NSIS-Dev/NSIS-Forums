<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" admin limitations on Vista?, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  admin limitations on Vista? NSIS Discussion" />
	
	<title> admin limitations on Vista? [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  admin limitations on Vista?</div>
<hr />
<div class="pda"><a href="t-264174.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=264174">admin limitations on Vista?</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">22nd January 2007, 16:35</div></div><div class="posttext">I have small application (http://ineum.narod*****mgr_en.htm) (sorry, download is fast inside Russia only, but package is 120 kB, thanks NSIS :) ). The problem is following: on Vista when application starts first time  from installer' finish page with admins privilegies from installer as child process (installer running with RequestExecutionLevel or not - both cases Vista displays UAC and elevates level to admin, installers auto-recognition feature), it not gets drag-n-drop messages and some other communication messages as well. The same happen if I start it with 'run as administrator' option later. But if I simply launch it from desktop or start menu icon (execution level 'user', admin not required) all works correct. This behavior not depends on current (start) folder. Brief google search not gave me any good links..</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">22nd January 2007, 20:55</div></div><div class="posttext">It's called User Interface Privilege Isolation. More information about this is available in MSDN (http://msdn2.microsoft.com/en-us/library/aa480150.aspx).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">23rd January 2007, 06:41</div></div><div class="posttext">Thanks, kichik! Nice feature... I added manifest with asInvoker, but this not helped. The only way I see now is to remove 'Run' checkbox from finish page and ask user to start program manually :( But user still can run application as admin.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">23rd January 2007, 09:43</div></div><div class="posttext">There's some code to handle this in another forum thread:<br />
<br />
http://forums.winamp.com/showthread.php?s=&amp;threadid=260722&amp;highlight=vista<br />
<br />
Andres also wrote a plug-in, I think.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">23rd January 2007, 10:09</div></div><div class="posttext">Thanks again, sometimes forum search is better then google :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">23rd January 2007, 17:48</div></div><div class="posttext">You can try the SAFER (http://nsis.sourceforge.net/SAFER_plug-in) plugin.<br />
<br />
Use MUI_FINISHPAGE_RUN_FUNCTION and call the safer plugin with SAFER_LEVELID_NORMALUSER level.<br />
<br />
SAFER::Exec NORMAL &quot;$instdir\\myapp.exe&quot;<br />
 <br />
<br />
If your installer supports pre XP versions you should call SAFER::SupportsSAFER and just use normal Exec if the SAFER api is not supported</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">23rd January 2007, 19:16</div></div><div class="posttext">Thanks, Anders! I not tested it yet, but looks interesting. And I have feature request for 0.2 version :) Now I should write 3 or more lines of code:if(supportsSafer)<br />
  SAFER::Exec NORMAL &quot;$instdir\myapp.exe&quot;<br />
else<br />
  Exec &quot;$instdir\myapp.exe&quot;<br />
Is it possible to do it all in a single call (CreateProcess() if no entry points in dll) and keep my brains for other fun ;) ?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">23rd January 2007, 20:15</div></div><div class="posttext">thats what macros are for, something like:<br />
<br />
!macro ExecSAFER _level _cmdline<br />
SAFER::SupportsSAFER<br />
StrCmp $0 0 +3<br />
SAFER::Exec ${_level} '${_cmdline}'<br />
Goto +2<br />
Exec '${_cmdline}'<br />
!macroend<br />
<br />
<br />
!insertmacro ExecSAFER NORMAL 'calc.exe'</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">24th January 2007, 08:15</div></div><div class="posttext">Tested. With SAFER token program fails to open file for write in $INSTDIR. I'll think later if I can use appdata folder for this file, but if I stop program and start it again - all works correct (can write file).<br />
!insertmacro ExecSAFER NORMAL &quot;$INSTDIR\${APP_EXE}&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">onad</div><div class="date">24th January 2007, 11:34</div></div><div class="posttext">IDEA:<br />
1) Copy a manifest document were level is asInvoker (asInvoker is the new term on Vista versoin &gt;=Beta2) to the application directory where the application resides you want to start.<br />
2) Start the application<br />
3) Delete the manifest document <br />
<br />
NOTE:<br />
(XML data is called a &quot;XML document&quot;, not &quot;XML file&quot;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">24th January 2007, 11:44</div></div><div class="posttext">2 onad:<br />
I wrote about this in my second post :)<br />
Not works :(<br />
Looks like child thread inheritation priority is high then manifests (while I not tested embedded manifest, but file priority is higher).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">24th January 2007, 11:47</div></div><div class="posttext">There's an article on MSDN that suggests bootstrapping the installer with another application that'd run as the user and will later also execute the installed application. I really hate this method, but it does work.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">24th January 2007, 15:03</div></div><div class="posttext">Originally posted by Takhir <br />
Tested. With SAFER token program fails to open file for write in $INSTDIR. I'll think later if I can use appdata folder for this file, but if I stop program and start it again - all works correct (can write file).<br />
!insertmacro ExecSAFER NORMAL &quot;$INSTDIR\${APP_EXE}&quot;  <br />
<br />
A normal user cannot write to ProgramFiles so im not sure why it works if you start the program manually</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">24th January 2007, 15:39</div></div><div class="posttext">I tested program with app data folder. Launched from installer it could not write to application data/company/prog_name as well. The only place where it could was GetTempPath(). I can use tmp folder for this file, but program saves other (user's configuration) file to app_data, so this is a problem. File is too big for registry (access to registry works correct)..</div></div><hr />


<div class="post"><div class="posttop"><div class="username">onad</div><div class="date">24th January 2007, 16:12</div></div><div class="posttext">Anders, you can write there because of Vista Virtualisation, this is a kind of backwards compatibility layer on Vista to solve problems with &quot;old&quot; software.<br />
<br />
IDEA1)<br />
Do a run dll of an INF file there you can add an RUN entry, since the INF format description as not fully made public by MS this can be difficulult<br />
<br />
IDEA2)<br />
As menationed before a bootstrap application which starts the installer with admin privileges and if finished starts another app with regular priviliges<br />
<br />
IDEA3)<br />
Downgrade the options of the running process, hmmm<br />
<br />
IDEA4)<br />
Set app compatibility flag to W98, test if works?<br />
<br />
IDEA5 ??)<br />
Tell it to us please, be creative in thoughts....</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">24th January 2007, 16:27</div></div><div class="posttext">What about CreateLowProcess from MSDN (http://msdn.microsoft.com/library/default.asp?url=/library/en-us/ietechcol/dnwebgen/protectedmode.asp). It looks promising, as long as you can find out the SID for the medium integrity access level. There's code a page below CreateLowProcess that retrieves the current integrity access level. It can probably be used from a normal process to get that SID.<br />
<br />
Looks like SAFER is a wrapper for this as the terms are pretty similar, but who knows... I have to get myself Vista access again :(</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">24th January 2007, 16:33</div></div><div class="posttext">You can inspect the process token SAFER creates with process explorer, its probably not the exact same thing as running the program manually<br />
<br />
There is another way to start a program non elevated on vista, documented @ http://www.tweak-uac.com/programming/vista-tools/ (RunAsStdUser) I dont have Vista so I can not test or implement it</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>