<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" NSIS FileOpen in read mode is shared?, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  NSIS FileOpen in read mode is shared? NSIS Discussion" />
	
	<title> NSIS FileOpen in read mode is shared? [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  NSIS FileOpen in read mode is shared?</div>
<hr />
<div class="pda"><a href="t-336345.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=336345">NSIS FileOpen in read mode is shared?</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">SJSJ</div><div class="date">21st October 2011, 04:33</div></div><div class="posttext">Hello,<br />
<br />
When I open a file in mode &quot;r&quot; - FileOpen &quot;filename&quot; r, does it lock the file for exclusive use? I believe, in &quot;r&quot; mode, the process shouldn't lock the resource. <br />
<br />
I have a common file which is written by a java program and read by NSIS. When NSIS opens the file in &quot;r&quot; mode and reads it, the java program throws an exception during its write with the message that the file is in use by another program.<br />
<br />
Is there a way in NSIS to open shared resource for reading without locking it? <br />
<br />
Thank you!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">21st October 2011, 14:04</div></div><div class="posttext">When a file is open for reading, it usually is shared for reading (i.e. no exclusive lock), but not for writing.<br />
<br />
And it seems that is what NSIS does:<br />
HANDLE NSISCALL myOpenFile(const char *fn, DWORD da, DWORD cd)<br />
{<br />
  int attr = GetFileAttributes(fn);<br />
  return CreateFile(<br />
    fn,<br />
    da,<br />
    FILE_SHARE_READ,<br />
    NULL,<br />
    cd,<br />
    attr == INVALID_FILE_ATTRIBUTES ? 0 : attr,<br />
    NULL<br />
  );<br />
}<br />
<br />
Sharing a file for writing, while you still are reading from it, is inherently dangerous...<br />
<br />
(And, as FILE_SHARE_READ is hardcoded, you cannot change it without re-compiling the EXE headers)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Lloigor</div><div class="date">21st October 2011, 14:12</div></div><div class="posttext">Just made that, hope that can help.. ;)<br />
<br />
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br />
;; Easily opens files with more options than FileOpen<br />
;;   P1 :o: Handle returned<br />
;;   P2 :i: File name<br />
;;   P3 :i: Access Mode<br />
;;         'r'  : Readonly<br />
;;         'w'  : Writeonly<br />
;;         'rw' : Read+Write<br />
;;   P4 :i: Share mode<br />
;;         ''    : None<br />
;;         'r'   : Readonly<br />
;;         'rw'  : Read+Write<br />
;;         'rwd' : Read+Write+Delete<br />
;;   P5 :i: Create mode<br />
;;         ''  : Open existing only<br />
;;         'c' : Create if not exist<br />
;;         'o' : Create and Overwrite<br />
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br />
!define FileOpenEx &quot;!insertmacro _FileOpenEx&quot;<br />
!macro _FileOpenEx _Handle_ _File_ _Access_ _Share_ _Create_<br />
   Push &quot;${_Create_}&quot;<br />
   Push &quot;${_Share_}&quot;<br />
   Push &quot;${_Access_}&quot;<br />
   Push &quot;${_File_}&quot;<br />
   Call FileOpenEx<br />
   Pop ${_Handle_}<br />
!macroend<br />
<br />
Function FileOpenEx  ;; $0:File, $1:Access, $2:Sharing, $3:Create<br />
   Exch $0<br />
   Exch<br />
   Exch $1<br />
   Exch 2<br />
   Exch $2<br />
   Exch 3<br />
   Exch $3<br />
<br />
   StrCmp &quot;r&quot; $1 0 +3<br />
      StrCpy $1 0x80000000  ;; GENERIC_READ<br />
      Goto +6<br />
   StrCmp &quot;w&quot; $1 0 +3<br />
      StrCpy $1 0x40000000  ;; GENERIC_WRITE<br />
      Goto +3<br />
   StrCmp &quot;rw&quot; $1 0 +3<br />
      StrCpy $1 0xC0000000  ;; GENERIC_READ | GENERIC_WRITE<br />
<br />
   StrCmp &quot;&quot; $2 0 +3<br />
      StrCpy $2 0   ;; FILE_SHARE_NONE<br />
      Goto +9<br />
   StrCmp &quot;r&quot; $2 0 +3<br />
      StrCpy $2 1   ;; FILE_SHARE_READ<br />
      Goto +6<br />
   StrCmp &quot;rw&quot; $2 0 +3<br />
      StrCpy $2 3   ;; FILE_SHARE_READ | FILE_SHARE_WRITE<br />
      Goto +3<br />
   StrCmp &quot;rwd&quot; $2 0 +3<br />
      StrCpy $2 7   ;; FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE<br />
<br />
   StrCmp &quot;&quot; $3 0 +3<br />
      StrCpy $3 3   ;; OPEN_EXISTING<br />
      Goto +6<br />
   StrCmp &quot;c&quot; $3 0 +3<br />
      StrCpy $3 4   ;; OPEN_ALWAYS<br />
      Goto +3<br />
   StrCmp &quot;o&quot; $3 0 +3<br />
      StrCpy $3 2   ;; CREATE_ALWAYS<br />
<br />
   System::Call 'Kernel32::CreateFile(t, i, i, i, i, i, i) i (r0, r1, r2, 0, r3, 0x80, 0) .r2'  ;; Open/Create file<br />
<br />
   Pop $3<br />
   Pop $0<br />
   Pop $1<br />
   Exch $2<br />
FunctionEnd<br />
<br />
Example:<br />
${FileOpenEx} $0 &quot;SomeFile.ext&quot; &quot;r&quot; &quot;rwd&quot; &quot;&quot;    ;; opens SomeFile.ext in read mode with full share access, if it exists<br />
<br />
*</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">24th October 2011, 16:09</div></div><div class="posttext">It might be worth changing all those run time string comparisons to compile time (by using !if).<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">SJSJ</div><div class="date">31st October 2011, 06:25</div></div><div class="posttext">Thank you, all :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Lloigor</div><div class="date">31st October 2011, 13:16</div></div><div class="posttext">If you really nead maximum speed, ex: if you open a large amount of files in a tight loop, you may want a more direct approach, something like:<br />
!define ApiCreateFile &quot;!insertmacro _ApiCreateFile&quot;<br />
!macro _ApiCreateFile _Handle_ _File_ _Access_ _Share_ _Create_<br />
   System::Call 'Kernel32::CreateFile(t, i, i, i, i, i, i) i (&quot;${_File_}&quot;, ${_Access_}, ${_Share_}, 0, ${_Create_}, 0x80, 0) .s'  ;; Open/Create file<br />
   Pop ${_Handle_}<br />
!macroend</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>