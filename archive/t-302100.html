<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" SHBrowseForFolder problem, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  SHBrowseForFolder problem NSIS Discussion" />
	
	<title> SHBrowseForFolder problem [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  SHBrowseForFolder problem</div>
<hr />
<div class="pda"><a href="t-302100.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=302100">SHBrowseForFolder problem</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">wraithdu</div><div class="date">15th January 2009, 19:43</div></div><div class="posttext">Vista SP1 32-bit<br />
NSIS 2.41 (ANSI)<br />
<br />
I have 2 problems with this script fragment, and I'm stumped.<br />
<br />
1)  The icon index always returns 0.  I don't think my code is wrong.<br />
2)  9 times out of 10 the script crashes on exit.  This is AFTER the System plugin is unloaded.  The crash is either in ole32.dll or ntdll.dll.  Again, I have no idea why.<br />
<br />
Any insight is appreciated!<br />
<br />
;=== Program Details<br />
Name &quot;Folder Test&quot;<br />
OutFile &quot;foldertest.exe&quot;<br />
Caption &quot;Folder Test&quot;<br />
<br />
;=== Runtime Switches<br />
CRCCheck On<br />
WindowIcon off<br />
SilentInstall Silent<br />
AutoCloseWindow True<br />
RequestExecutionLevel user<br />
XPStyle on<br />
<br />
; Best Compression<br />
SetCompress Auto<br />
SetCompressor /SOLID lzma<br />
SetCompressorDictSize 32<br />
SetDatablockOptimize On<br />
<br />
Section<br />
	System::Call /NOUNLOAD '*(&amp;t 260)i .r0' ; $0 = address to namebuff<br />
	; BROWSEINFO struct<br />
	System::Call /NOUNLOAD '*(i n, i n, i r0, t &quot;Folder Dialog Title&quot;, i 0x40, i n, i n, i n)i .R0' ; $R0 = address of struct<br />
	<br />
	System::Call /NOUNLOAD 'shell32::SHBrowseForFolderA(i R0)i .r5'<br />
	<br />
	System::Call /NOUNLOAD '*$0(&amp;t260 .r3)' ; read namebuff<br />
	MessageBox MB_OK &quot;Selected folder:  $3&quot;<br />
	<br />
	System::Call /NOUNLOAD 'shell32::SHGetPathFromIDListA(i r5, i $0)i'<br />
	System::Call /NOUNLOAD '*$0(&amp;t260 .r3)' ; read namebuff<br />
	MessageBox MB_OK &quot;Selected folder path:  $3&quot;<br />
	<br />
	System::Call /NOUNLOAD '*$R0(i,i,i,t,i,i,i, i .r2)' ; read icon index<br />
	MessageBox MB_OK &quot;Icon index:  $2&quot;<br />
	<br />
	; cleanup<br />
	System::Call /NOUNLOAD 'ole32::CoTaskMemFree(i r5)v' ; free returned PIDL<br />
	System::Free /NOUNLOAD $0 ; free namebuff<br />
	System::Free $R0 ; free BROWSEINFO<br />
	<br />
	MessageBox MB_OK &quot;done&quot;<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">15th January 2009, 20:25</div></div><div class="posttext">I always use SHGetFileInfo to get a icon/iconindex, did not even know that BROWSEINFO had it. But the docs say icon index for folder, not file or drive (it failed on my documents also, so who knows) Do you even need the icon index? or just the HICON?<br />
<br />
You also really should add a HWND to BROWSEINFO...<br />
<br />
I played around with it a bit and the iconindex is 0 for me also every time. (XP SP2)<br />
<br />
<br />
Section<br />
	System::Call /NOUNLOAD '*(&amp;t 261)i .r0' ; $0 = address to namebuff<br />
	; BROWSEINFO struct<br />
System::Call /NOUNLOAD '*(i $hwndparent,i, i r0, t &quot;Folder Dialog Title&quot;, i 0x40|0x4000,i,i,i)i.R0' <br />
	<br />
	System::Call /NOUNLOAD 'shell32::SHBrowseForFolderA(i R0)i .r5'<br />
	<br />
	System::Call /NOUNLOAD '*$0(&amp;t260 .r3)' ; read namebuff<br />
	DetailPrint &quot;ret = $5, Selected folder:  $3&quot;<br />
	<br />
	System::Call /NOUNLOAD 'shell32::SHGetPathFromIDListA(i r5, i $0)i'<br />
	System::Call /NOUNLOAD '*$0(&amp;t260 .r3)' ; read namebuff<br />
	DetailPrint &quot;Selected folder path:  $3&quot;<br />
	<br />
	System::Call /NOUNLOAD '*$R0(i,i,i,i,i,i,i,i.r2)' ; read icon index<br />
	DetailPrint &quot;Icon index:  $2&quot;<br />
	<br />
	; cleanup<br />
	System::Call /NOUNLOAD 'ole32::CoTaskMemFree(i r5)v' ; free returned PIDL<br />
	System::Free /NOUNLOAD $0 ; free namebuff<br />
	System::Free $R0 ; free BROWSEINFO<br />
	<br />
	DetailPrint &quot;done-----------------&quot;<br />
	/*typedef struct _SHFILEINFO {<br />
    HICON hIcon;<br />
    int iIcon;<br />
    DWORD dwAttributes;<br />
    TCHAR szDisplayName[MAX_PATH];<br />
    TCHAR szTypeName[80];<br />
} SHFILEINFO;*/<br />
	!define STRUCTSIZE_SHFILEINFOA 352<br />
	#DEFINE SHGFI_ICON 0x000000100<br />
	System::Call '*(i,i,i,&amp;t260,&amp;t80)i.r0'<br />
	System::Call 'shell32::SHGetFileInfoA(t &quot;$3&quot;,i,i $0,i 352,i 0x100)i.r9'<br />
	DetailPrint ret=$9,inpath=$3<br />
	System::Call '*$0(i.r1,i.r2)'<br />
	DetailPrint hIco=$1,icoIdx=$2<br />
	System::Free $0<br />
	FindWindow $0 &quot;#32770&quot; &quot;&quot; $HWNDPARENT<br />
	GetDlgItem $0 $0 0x407<br />
	SendMessage $0 ${STM_SETICON} $1 0<br />
	<br />
SectionEnd<br />
<br />
<br />
note that it is also possible to use a PIDL with SHGetFileInfo (you did not specify the filesystemonly flag, so you could get virtual paths)<br />
<br />
Also, I'm using 2.42 so I don't have to bother with /NOUNLOAD</div></div><hr />


<div class="post"><div class="posttop"><div class="username">wraithdu</div><div class="date">15th January 2009, 20:58</div></div><div class="posttext">I don't need the icon index for the folder, but was just curious why it wasn't working.<br />
<br />
The bigger issue is why it's crashing consistently on exit on Vista.  I'm assuming that it's not crashing on XP since you've tried it...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">wraithdu</div><div class="date">15th January 2009, 21:09</div></div><div class="posttext">I just checked with 2.42 and removing /NOUNLOAD, still crashes most of the time.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">15th January 2009, 21:26</div></div><div class="posttext">and if you don't call CoTaskMemFree or free the buffers?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">wraithdu</div><div class="date">16th January 2009, 04:40</div></div><div class="posttext">Still crashes unfortunately.  And I've seen the faulting module as both ole32.dll and ntdll.dll.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">16th January 2009, 10:03</div></div><div class="posttext">You have a space between &amp;t and 260. The buffer you allocate is therefore sized 1 bytes and the initial value of that string is &quot;260&quot;.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">wraithdu</div><div class="date">16th January 2009, 15:20</div></div><div class="posttext">Wow.  Thanks kickik, that did it.  I can't believe that was the problem.  So it was a buffer overrun type of crash then?<br />
<br />
Well, since I have a topic already here instead of starting a new one, can you briefly explain how the &amp;l is used for structure size?  The manual doesn't have an example of usage, and I don't see the N for N bytes after it like the others.  Thanks again!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">16th January 2009, 15:29</div></div><div class="posttext">Yes, it caused a heap overflow.<br />
<br />
&amp;l is used to get the structure size. It doesn't really set a struct member but only gets the size.System::Call &quot;*${stBITMAP} (_, &amp;l0 .R7) .R9&quot;<br />
System::Call &quot;${sysGetObject} (r6, R7, R9)&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">wraithdu</div><div class="date">16th January 2009, 15:57</div></div><div class="posttext">Ok.  So in the above example, the _ character 'skips' all the params and lets you add one to the end of the struct?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">16th January 2009, 16:06</div></div><div class="posttext">Indeed.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">wraithdu</div><div class="date">16th January 2009, 16:47</div></div><div class="posttext">Thanks for all the help!<br />
<br />
Maybe add those few tips about &amp;l and _ to the System Plugin Documentation when you have an opportunity.<br />
<br />
Keep up the great work!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">16th January 2009, 17:53</div></div><div class="posttext">DOH, not sure how I missed this one, copy&amp;paste without checking is baaad mmmkay</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>