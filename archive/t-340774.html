<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" In 64bit installer AccessControl fail to set registry permission, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  In 64bit installer AccessControl fail to set registry permission NSIS Discussion" />
	
	<title> In 64bit installer AccessControl fail to set registry permission [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  In 64bit installer AccessControl fail to set registry permission</div>
<hr />
<div class="pda"><a href="t-340774.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=340774">In 64bit installer AccessControl fail to set registry permission</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">rijukk</div><div class="date">17th January 2012, 16:00</div></div><div class="posttext">I was using NSIS AccessControl plug-in to grant registry access permission <br />
<br />
AccessControl::GrantOnRegKey HKLM &quot;Software\Demo&quot; &quot;(S-1-5-20)&quot; &quot;FullAccess&quot; ;&quot;NETWORK SERVICE&quot;<br />
<br />
It was working perfect, now I upgraded my installer to 64bit using &quot;x64.nsh&quot;'s ${RunningX64} <br />
 and SetRegView 64<br />
<br />
Now <br />
AccessControl::GrantOnRegKey HKLM &quot;Software\Demo&quot; &quot;(S-1-5-20)&quot; &quot;FullAccess&quot; <br />
<br />
it fail to grant permission; however i create a key in redirected node (Wow6432Node) like HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Demo. It providing proper grant permission.<br />
<br />
Any help will be greatly appreciated<br />
<br />
Thank you,<br />
Riju</div></div><hr />


<div class="post"><div class="posttop"><div class="username">T.Slappy</div><div class="date">18th January 2012, 06:09</div></div><div class="posttext">Are you running 32bit application on x64 machine?<br />
If yes then this situation is correct because 32bit applications use Wow6432Node in Registry.<br />
<br />
Your assumption is wrong:<br />
by I upgraded my installer to 64bit using &quot;x64.nsh&quot;'s ${RunningX64} <br />
Creating 64bit installer is possible only by recompiling NSIS as 64bit application.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">rijukk</div><div class="date">18th January 2012, 07:40</div></div><div class="posttext">Hi T. Slappy,<br />
<br />
I am upgrading the installer script with guideline provided in this link<br />
http://bojan-komazec.blogspot.com/2011/10/nsis-installer-for-64-bit-windows.html<br />
<br />
<br />
<br />
I am able to read\write registry from HKLM\Software\Demo after using &quot;SetRegView 64&quot;.<br />
<br />
; disable registry redirection (enable access to 64-bit portion of registry)<br />
   SetRegView 64<br />
<br />
Only registry fails on <br />
AccessControl::GrantOnRegKey HKLM &quot;SOFTWARE\Demo&quot; &quot;(S-1-5-20)&quot; &quot;FullAccess&quot;<br />
<br />
my installer is working perfectly in 64bit PC without any other issues <br />
<br />
<br />
Thank you,<br />
Riju</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">18th January 2012, 09:59</div></div><div class="posttext">Could it be that the AccessControl plugin cannot handle x64 registry yet?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">18th January 2012, 10:01</div></div><div class="posttext">Could it be that the AccessControl plugin doesn't support x64 registry yet?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">18th January 2012, 19:12</div></div><div class="posttext">AccessControl plug-in needs updating to handle SetRegView. I will do it when I have some time (maybe tomorrow).<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">rijukk</div><div class="date">19th January 2012, 05:59</div></div><div class="posttext">Hi Stu,<br />
<br />
So nice of you :)<br />
<br />
Thank you,<br />
Riju</div></div><hr />


<div class="post"><div class="posttop"><div class="username">rijukk</div><div class="date">23rd January 2012, 05:23</div></div><div class="posttext">What i read from internet in order to accomplish this; we need to use advapi32.dll's RegSetKeySecurity in the AccessControl plugin.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">25th January 2012, 23:48</div></div><div class="posttext">It took a little longer than expected due to SetNamedSecurityInfo/GetNamedSecurityInfo complete lack of support for KEY_WOW64_64KEY (as you pointed out) so a lot of the code had to be changed quite drastically. It may also mean the plug-in will no longer work on Windows 2000, but we may have to live with that.<br />
<br />
v1.0.5.0 - 25th January 2012 ~ Afrow UK<br />
<br />
 Removed IsUserTheAdministrator.<br />
 Added NameToSid.<br />
 Major code cleanup/rewrite.<br />
 Proper Unicode build (with Unicode plugin API).<br />
 Support for 64-bit registry (SetRegView 64).<br />
 Functions now return &quot;ok&quot; on success or &quot;error&quot; otherwise. On &quot;error&quot;, the next item on the stack will be the error description.<br />
 Added version information resource.<br />
Edit: I removed IsUserTheAdministrator because you can quite easily test for that yourself using the new NameToSid. Just check the result of NameToSid ends with -500.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">26th January 2012, 00:47</div></div><div class="posttext">It may also mean the plug-in will no longer work on Windows 2000, but we may have to live with that.<br />
<br />
<br />
IMHO the Ansi version needs to support NT4/Win95 (I don't know what the old behavior was but it can just return ok on 9x) and the unicode build 2000+ (It is unclear at this point if NT4 will be supported as unicode)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">26th January 2012, 11:11</div></div><div class="posttext">When was ConvertSidToStringSid/ConvertStringSidToSid added to Windows? The plug-in has been using those for some time. Now it's using RegOpenKeyEx as well.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">26th January 2012, 11:59</div></div><div class="posttext">RegOpenKeyEx was added in Win95/NT4 IIRC and I don't remember off the top of my head but I'm guessing ConvertSidToStringSid was added in 2000 (You cannot trust MSDN, you must check the dll exports)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">26th January 2012, 12:46</div></div><div class="posttext">How about RegSetKeySecurity? I will look into writing replacements for ConvertSidToStringSid/ConvertStringSidToSid.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">26th January 2012, 17:56</div></div><div class="posttext">v1.0.6.0 - 26th January 2012 - Afrow UK<br />
<br />
 Wrote replacements for ConvertSidToStringSid/ConvertStringSidToSid for backwards compatibility with Windows NT4/ME (ANSI build only).<br />
 Loads RegSetKeySecurity/RegGetKeySecurity functions at run-time for backwards compatibility with Windows NT4/ME (ANSI build only).<br />
 Removed commented out legacy code.<br />
Note that RegSetKeySecurity/RegGetKeySecurity is only used when SetRegView 64 is set.<br />
<br />
http://nsis.sourceforge.net/AccessControl_plug-in<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">26th January 2012, 18:52</div></div><div class="posttext">Hate to be a nagger, but... Wasn't NT4 also unicode? Not that I feel strongly about NT4 support one way or the other, but yeah.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">26th January 2012, 19:55</div></div><div class="posttext">As Anders says I don't think Unicode NSIS supports below Windows 2000 anyway so there is no point the Unicode plug-in doing so.<br />
<br />
Edit: If someone needs the Unicode build for NT4 they can just rebuild with ACCESS_CONTROL_NT4 preprocessor directive. Otherwise the Unicode build links to the native Windows 2000+ API's to save on code size.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">26th January 2012, 22:07</div></div><div class="posttext">I did not check out the code yet but I hope you are only going down the wow64 path on NT5.2+, I don't know what happens if you pass the WOW64 flag to older registry functions...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">27th January 2012, 00:15</div></div><div class="posttext">According to MSDN KEY_WOW64_64KEY is ignored on 32-bit Windows (and Windows 2000) so I assume that means older versions of Windows too. The registry functions are only used if SetRegView 64 is set but I suppose a test for a 64-bit OS would be good too.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">rijukk</div><div class="date">2nd February 2012, 16:19</div></div><div class="posttext">Thank you Stu... i will test it tomorrow and let you know the feedbacks<br />
<br />
Riju</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kalverson</div><div class="date">8th February 2012, 20:01</div></div><div class="posttext">Are you running 32bit application on x64 machine?<br />
If yes then this situation is correct because 32bit applications use Wow6432Node in Registry.<br />
<br />
Your assumption is wrong:<br />
<br />
Creating 64bit installer is possible only by recompiling NSIS as 64bit application.<br />
<br />
Is there a NSIS 64 bit compiled engine/install available somewhere for download?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">8th February 2012, 20:43</div></div><div class="posttext">No. Why do you need it?<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">9th February 2012, 15:27</div></div><div class="posttext">No. Why do you need it?<br />
<br />
Stu<br />
<br />
Server Core :(</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>