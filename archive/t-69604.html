<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Removing empty dir after reboot, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Removing empty dir after reboot NSIS Discussion" />
	
	<title> Removing empty dir after reboot [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Removing empty dir after reboot</div>
<hr />
<div class="pda"><a href="t-69604.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=69604">Removing empty dir after reboot</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">chag</div><div class="date">22nd December 2001, 22:37</div></div><div class="posttext">Hi, <br />
<br />
Is it possible to remove an empty dir after a reboot ?<br />
<br />
I need to reboot to remove a DLL.<br />
I used the code : <br />
<br />
Delete /REBOOTOK &quot;$INSTDIR\mydll.dll&quot;<br />
<br />
After the reboot, my dll is deleted but I still have an empty directory : &quot;c:\program files\myapp&quot;<br />
<br />
Is it possible to remove this directory (that's now empty and can then be removed successfully) ?<br />
<br />
Thanks for your help<br />
<br />
Chag</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Koen van de Sande</div><div class="date">23rd December 2001, 09:06</div></div><div class="posttext">AFAIK this isn't possible easily - hence all those empty folders in my Program Files folder :(</div></div><hr />


<div class="post"><div class="posttop"><div class="username">petersa</div><div class="date">25th December 2001, 09:30</div></div><div class="posttext">Couldn't you just do this?<br />
<br />
  Delete /REBOOTOK $INSTDIR\MyDLL.dll<br />
  Delete /REBOOTOK $INSTDIR</div></div><hr />


<div class="post"><div class="posttop"><div class="username">petersa</div><div class="date">25th December 2001, 09:32</div></div><div class="posttext">Adding an entry to the WININIT.INI file may work. I'm not sure how it works or if you can do it on NT systems, but something like:<br />
<br />
  WriteINIStr $WINDIR\WININIT.INI Rename Nul $INSTDIRor:  WriteINIStr $WINDIR\WININIT.INI Rename Nul $INSTDIR\NUL</div></div><hr />


<div class="post"><div class="posttop"><div class="username">chag</div><div class="date">3rd January 2002, 20:32</div></div><div class="posttext">Hi, i tried<br />
<br />
Delete /REBOOTOK $INSTDIR<br />
but it doesn't work<br />
<br />
and i'd liked to avoid modifying ini files.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">SQwerl</div><div class="date">4th January 2002, 02:48</div></div><div class="posttext">Try this:<br />
Delete /REBOOTOK &quot;$INSTDIR\mydll.dll&quot;<br />
RMDir /r &quot;$INSTDIR&quot;<br />
<br />
RMDir will delete the folder/directory. :)<br />
and the &quot;/r&quot; switch will delete it recursively.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">rainwater</div><div class="date">4th January 2002, 04:16</div></div><div class="posttext">Originally posted by SQwerl <br />
Try this:<br />
Delete /REBOOTOK &quot;$INSTDIR\mydll.dll&quot;<br />
RMDir /r &quot;$INSTDIR&quot;<br />
<br />
RMDir will delete the folder/directory. :)<br />
and the &quot;/r&quot; switch will delete it recursively. <br />
<br />
The problem is if it has to reboot, RMDir /r &quot;$INSTDIR&quot; will never have a chance to run.  Perhaps an /REBOOTOK option for RMDir is needed?<br />
<br />
Robert</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">4th January 2002, 23:25</div></div><div class="posttext">Old topic, but I have the same problem. Is there a solution now? A /REBOOTOK option for RMDir would be nice...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">5th January 2002, 14:40</div></div><div class="posttext">Oops :) My mistake, I thought that this would be a problem, but the uninstaller runs from a different location or something, so Uninstall.exe can always be deleted.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DuaneJeffers</div><div class="date">6th January 2002, 03:44</div></div><div class="posttext">Yea, it generates a couple of files in the TEMP folder in the WINDOWS Dir. That way, the Uninstaller can &quot;self-delete&quot; itself.<br />
<br />
-Duane</div></div><hr />


<div class="post"><div class="posttop"><div class="username">petersa</div><div class="date">6th January 2002, 06:11</div></div><div class="posttext">Originally posted by chag <br />
i'd liked to avoid modifying ini files.This is how the /REBOOTOK option works.<br />
<br />
All of the installers I know use the WININIT.INI file to delete files on reboot. I just don't know how these things work on NT systems. I'd go to the Win98 computer but it's dead.<br />
<br />
I'll do some research.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">6th January 2002, 13:15</div></div><div class="posttext">Originally posted by petersa <br />
This is how the /REBOOTOK option works.<br />
<br />
All of the installers I know use the WININIT.INI file to delete files on reboot. I just don't know how these things work on NT systems. I'd go to the Win98 computer but it's dead.<br />
<br />
I'll do some research. <br />
There is a registry location for it on WinNT systems.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">petersa</div><div class="date">9th January 2002, 13:22</div></div><div class="posttext">I just tried a quick check using Registry Monitor (http://www.sysinternals.com/ntw2k/source/regmon.shtml), but I couldn't find anything...<br />
<br />
Justin? How exactly does the /REBOOTOK option work? What registry or file changes does it involve?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">9th January 2002, 13:51</div></div><div class="posttext">Here is the function in the source code that is called if the /REBOOTOK flag appears.<br />
<br />
BOOL MoveFileOnReboot(LPCTSTR pszExisting, LPCTSTR pszNew)<br />
{<br />
  BOOL fOk = 0;<br />
  HMODULE hLib=LoadLibrary(&quot;kernel32.dll&quot;);<br />
  if (hLib)<br />
  {<br />
    typedef BOOL (WINAPI *mfea_t)(LPCSTR lpExistingFileName,LPCSTR lpNewFileName,DWORD dwFlags);<br />
    mfea_t mfea;<br />
    mfea=(mfea_t) GetProcAddress(hLib,&quot;MoveFileExA&quot;);<br />
    if (mfea)<br />
    {<br />
      fOk=mfea(pszExisting, pszNew, MOVEFILE_DELAY_UNTIL_REBOOT|MOVEFILE_REPLACE_EXISTING);<br />
    }<br />
    FreeLibrary(hLib);<br />
  }<br />
<br />
  if (!fOk)<br />
  {<br />
    static char szRenameLine[1024];<br />
    static char wininit[1024];<br />
    static char tmpbuf[1024];<br />
    int cchRenameLine;<br />
    char *szRenameSec = &quot;[Rename]\r\n&quot;;<br />
    HANDLE hfile, hfilemap;<br />
    DWORD dwFileSize, dwRenameLinePos;<br />
    static const char nulint[4]=&quot;NUL&quot;;<br />
<br />
    if (pszNew) GetShortPathName(pszNew,tmpbuf,1024);<br />
    else *((int *)tmpbuf) = *((int *)nulint);<br />
    // wininit is used as a temporary here<br />
    GetShortPathName(pszExisting,wininit,1024);<br />
    cchRenameLine = wsprintf(szRenameLine,&quot;%s=%s\r\n&quot;,tmpbuf,wininit);<br />
  <br />
    GetWindowsDirectory(wininit, 1024-16);<br />
    lstrcat(wininit, &quot;\\wininit.ini&quot;);<br />
    hfile = CreateFile(wininit,      <br />
        GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_ALWAYS, <br />
        FILE_ATTRIBUTE_NORMAL | FILE_FLAG_SEQUENTIAL_SCAN, NULL);<br />
<br />
    if (hfile != INVALID_HANDLE_VALUE) <br />
    {<br />
      dwFileSize = GetFileSize(hfile, NULL);<br />
      hfilemap = CreateFileMapping(hfile, NULL, PAGE_READWRITE, 0, dwFileSize + cchRenameLine + 10, NULL);<br />
<br />
      if (hfilemap != NULL) <br />
      {<br />
        LPSTR pszWinInit = (LPSTR) MapViewOfFile(hfilemap, FILE_MAP_WRITE, 0, 0, 0);<br />
<br />
        if (pszWinInit != NULL) <br />
        {<br />
          int do_write=0;<br />
          LPSTR pszRenameSecInFile = findinmem(pszWinInit, szRenameSec,-1);<br />
          if (pszRenameSecInFile == NULL) <br />
          {<br />
            lstrcpy(pszWinInit+dwFileSize, szRenameSec);<br />
            dwFileSize += 10;<br />
            dwRenameLinePos = dwFileSize;<br />
            do_write++;<br />
          } <br />
          else <br />
          {<br />
            char *pszFirstRenameLine = findinmem(pszRenameSecInFile, &quot;\n&quot;,-1)+1;<br />
            int l=pszWinInit + dwFileSize-pszFirstRenameLine;<br />
            if (!findinmem(pszFirstRenameLine,szRenameLine,l))<br />
            {<br />
              void* data=(void*)GlobalAlloc(GMEM_FIXED,l);<br />
              mini_memcpy(data, pszFirstRenameLine, l);<br />
              mini_memcpy(pszFirstRenameLine + cchRenameLine, data, l);<br />
              GlobalFree((HGLOBAL)data);<br />
<br />
              dwRenameLinePos = pszFirstRenameLine - pszWinInit;<br />
              do_write++;<br />
            }<br />
          }<br />
<br />
          if (do_write) <br />
          {<br />
            mini_memcpy(&amp;pszWinInit[dwRenameLinePos], szRenameLine,cchRenameLine);<br />
            dwFileSize += cchRenameLine;<br />
          }<br />
<br />
          UnmapViewOfFile(pszWinInit);<br />
<br />
          fOk++;<br />
        }<br />
        CloseHandle(hfilemap);<br />
      }<br />
      SetFilePointer(hfile, dwFileSize, NULL, FILE_BEGIN);<br />
      SetEndOfFile(hfile);<br />
      CloseHandle(hfile);<br />
    }<br />
  }<br />
  return fOk;<br />
}<br />
<br />
As you can see it writes to the WININIT.INI weather it's 9x or NT.<br />
<br />
KiCHiK</div></div><hr />


<div class="post"><div class="posttop"><div class="username">petersa</div><div class="date">9th January 2002, 14:30</div></div><div class="posttext">Thanks, KiCHiK, we're a step closer but I'm no programmer so this doesn't mean much to me. Any translators out there?<br />
<br />
I'm guessing it adds a NUL=[file to delete] line to the [Rename] section of the $WINDIR\WININIT.INI file. How close am I?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">9th January 2002, 14:54</div></div><div class="posttext">Almost :) It only write NUL=... if it got pszNew as a null string. That means that can also rename to pszNew.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">petersa</div><div class="date">11th January 2002, 13:11</div></div><div class="posttext">So when does it write pszNew?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">11th January 2002, 13:17</div></div><div class="posttext">It writes it when you use Rename /REBOOTOK. If you want to delete use NUL.<br />
<br />
KiCHiK</div></div><hr />


<div class="post"><div class="posttop"><div class="username">petersa</div><div class="date">11th January 2002, 13:23</div></div><div class="posttext">Okay, thanks KiCHiK! Now we all know how /REBOOTOK works, I reckon we could probably get rid of the functionality and put it into FUNCTIONS.HTM, or something?  ClearErrors<br />
  Delete C:\WINDOWS\FileIn.Use<br />
  IfErrors 0 +2 ; if it was deleted then skip the next line<br />
  WriteINIStr $WINDIR\WININIT.INI Rename NUL C:\WINDOWS\FileIn.UseOne thing I don't understand, is why +2 is necessary instead of +1, i.e. [skip over the next 1 line].</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Schultz</div><div class="date">11th January 2002, 13:47</div></div><div class="posttext">Originally posted by petersa <br />
One thing I don't understand, is why +2 is necessary instead of +1, i.e. [skip over the next 1 line]. <br />
<br />
I belive it is because it means Goto 2 lines from here.. So if you did 1 it would goto the first line after it..</div></div><hr />


<div class="post"><div class="posttop"><div class="username">justin</div><div class="date">12th January 2002, 04:55</div></div><div class="posttext">Originally posted by petersa <br />
Okay, thanks KiCHiK! Now we all know how /REBOOTOK works, I reckon we could probably get rid of the functionality and put it into FUNCTIONS.HTM, or something?  ClearErrors<br />
  Delete C:\WINDOWS\FileIn.Use<br />
  IfErrors 0 +2 ; if it was deleted then skip the next line<br />
  WriteINIStr $WINDIR\WININIT.INI Rename NUL C:\WINDOWS\FileIn.UseOne thing I don't understand, is why +2 is necessary instead of +1, i.e. [skip over the next 1 line]. <br />
<br />
a) The code in NSIS tries to do the remove-on-reboot the NT way and if that fails it drops back to the win9x way.<br />
<br />
b)The WriteINIStr way won't work, because WriteINIStr will update<br />
any entry that already begins with NUL=.<br />
<br />
c) +2 is necessary because +1 jumps to the next instruction (+0 does the instruction again, +1 goes to next, +2 skips the next, etc).<br />
<br />
-Justin</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">12th January 2002, 09:43</div></div><div class="posttext">Oops... Sorry I mixed you up. I accidentally ignored the first block of code :( :hang:</div></div><hr />


<div class="post"><div class="posttop"><div class="username">petersa</div><div class="date">12th January 2002, 09:57</div></div><div class="posttext">Right, so 0 and +0 are different...that makes sense then.<br />
<br />
Okay, so how does the NT way work?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">12th January 2002, 10:37</div></div><div class="posttext">The NT way is MoveFileExA.<br />
Read at MSDN on MoveFileEx and you will understand it all.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>