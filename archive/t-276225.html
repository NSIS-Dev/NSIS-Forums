<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Post installer-build events?, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Post installer-build events? NSIS Discussion" />
	
	<title> Post installer-build events? [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Post installer-build events?</div>
<hr />
<div class="pda"><a href="t-276225.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=276225">Post installer-build events?</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">vbguy</div><div class="date">21st August 2007, 02:46</div></div><div class="posttext">I want to execute a signing tool after the installer has been built, and I want to do it within the script.<br />
<br />
Right now I have:<br />
<br />
!system 'Signing\SignMe.exe &quot;Releases\installer.exe&quot;'<br />
<br />
at the end of the NSI file, but this signs the file before it has been really created.<br />
<br />
Is there a way to sign the installer after it has been made? Also, how would I be able to reference the OutFile location, without hardcoding the output path?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">michaelcsikos</div><div class="date">21st August 2007, 03:28</div></div><div class="posttext">Why don't you just make a build.bat file to build your installer?<br />
&quot;C:\Program Files\NSIS\makensis.exe&quot; &quot;My Installer.nsi&quot;<br />
Signing\SignMe.exe &quot;Releases\installer.exe&quot;<br />
<br />
If you put the batch file in the same folder as the .nsi file it should all work.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">vbguy</div><div class="date">21st August 2007, 03:54</div></div><div class="posttext">Well, normally I would do that but I'm running a number of post installer-build events and I want them to all use the OutFile variable, and if that's not possible I'd still like them all in the same place.<br />
<br />
Is it impossible to run a command within the nsi file after the installer has been built?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">michaelcsikos</div><div class="date">21st August 2007, 04:36</div></div><div class="posttext">I don't know of a way to do a post build event from within an NSIS script.<br />
<br />
You could pass in the OutFile to the build batch file and pass it along to makensis. Then you can use the variable for whatever post events you want:<br />
@echo off<br />
<br />
IF &quot;%~1&quot;==&quot;&quot; (<br />
  echo Usage: build OutFile.exe<br />
  pause<br />
  exit<br />
) ELSE (SET OutFile=%~1)<br />
<br />
&quot;C:\Progam Files\NSIS\makensis.exe&quot; &quot;My Installer.nsi&quot; &quot;/XOutFile %OutFile%&quot;<br />
NSIS\makensis.exe &quot;My Installer.nsi&quot; &quot;/XOutFile %OutFile%&quot;<br />
Signing\SignMe.exe &quot;Releases\%OutFile%&quot;<br />
xcopy &quot;Releases\%OutFile%&quot; \\MyServer\Backup<br />
...<br />
pause</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">21st August 2007, 05:31</div></div><div class="posttext">SignMe.exe should be used same way as an external packer,<br />
<br />
http://nsis.sourceforge.net/Docs/Chapter5.html#5.1.10</div></div><hr />


<div class="post"><div class="posttop"><div class="username">demiller9</div><div class="date">21st August 2007, 07:43</div></div><div class="posttext">You can use !execute or !system, but they both wait for the called program to finish before they let makensis finish.<br />
<br />
If you !execute a program that will start another one (and not wait for it to finish), you could have your second program wait for makensis to complete, and then do the commands you are trying to do.<br />
<br />
Rather round-about, but possible.<br />
<br />
Don</div></div><hr />


<div class="post"><div class="posttop"><div class="username">demiller9</div><div class="date">21st August 2007, 08:25</div></div><div class="posttext">Here's a vbscript that can wait for makensis to exit, and then call SignMe.exe. Put this into a file called SignNsi.vbs, in the same folder as your nsi script:<br />
Set sh=Wscript.CreateObject(&quot;WScript.Shell&quot;)<br />
Set wmi = GetObject(&quot;winmgmts:{impersonationLevel=impersonate}!\\.\root\cimv2&quot;)<br />
<br />
ExeName = Wscript.Arguments(0)<br />
WQL = &quot;Select Name from Win32_Process Where Name='makensis.exe'&quot;<br />
<br />
Do While MakeNsisActive<br />
	Wscript.Sleep 250<br />
Loop<br />
<br />
sh.Run &quot;Signing\SignMe.exe Releases\&quot; &amp; ExeName<br />
<br />
Function MakeNsisActive<br />
	MakeNsisActive = CBool(Wmi.ExecQuery(WQL).Count &gt; 0)<br />
End Function<br />
<br />
Here's the code that would go at the end of the NSIS script. Note that I have used a define called FILENAME for the output file, and used your relative path Releases:<br />
!define ExeName &quot;Releases\${FILENAME}&quot;<br />
!tempfile FILE<br />
!appendfile &quot;${FILE}.vbs&quot; 'set s=CreateObject(&quot;WScript.Shell&quot;)$\n'<br />
!appendfile &quot;${FILE}.vbs&quot; 's.run &quot;wscript SignNsi.vbs ${ExeName}&quot;,0,False$\n'<br />
# execute (and wait for) the two-line script above<br />
!execute &quot;wscript ${FILE}.vbs&quot;<br />
# delete the vbs and tempfile now<br />
!delfile &quot;${FILE}.vbs&quot;<br />
!delfile &quot;${FILE}&quot;<br />
<br />
Don</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">21st August 2007, 15:10</div></div><div class="posttext">you dont need the first script(edit: last in your post, but the first executed :) ), something like<br />
<br />
!execute '$%COMSPEC% /c start wscript.exe SignNsi.vbs ${ExeName}'<br />
<br />
should probably do it</div></div><hr />


<div class="post"><div class="posttop"><div class="username">demiller9</div><div class="date">21st August 2007, 17:02</div></div><div class="posttext">During the testing I did before I posted, it looked like makensis waited for the %COMSPEC% program to complete before it creates the final installer (nsi executable). The first script I call terminates (after starting the second one) and thus the installer gets created.<br />
<br />
I'll repeat the testing to confirm it.<br />
<br />
Don</div></div><hr />


<div class="post"><div class="posttop"><div class="username">demiller9</div><div class="date">21st August 2007, 17:28</div></div><div class="posttext">@Anders: I see, you combined COMSPEC and Start. I agree with you, it works and that simplifies the code at the end of the nsi script.<br />
<br />
I notice that I have the path Release coded in the vbscript and also added it in the !define ExeName before calling the vbscript. One of them should be removed.<br />
<br />
Don</div></div><hr />


<div class="post"><div class="posttop"><div class="username">vbguy</div><div class="date">31st August 2007, 08:24</div></div><div class="posttext">Red Wine: That signs the installer before it has been fully created, thus the signature is valid for an incomplete installer, but invalid for the entirely complete installer.<br />
<br />
Demiller9: Your method worked, though I ended up writing a small c# console program instead of vbscript, mainly because I wouldn't be able to maintain the script. But your idea of waiting for makensis to exit made the difference.<br />
<br />
I still have one problem though: I have <br />
<br />
OutFile &quot;Releases\setup.exe&quot;<br />
<br />
defined in the script. Is there a way to reference the OutFile variable? Namely, to pass it as commandline argument. Right now I have to redefine the output location when I sign the file:<br />
<br />
!system '&quot;Signing\SignMe.exe&quot; &quot;Releases\setup.exe&quot; /w'<br />
<br />
I've tried $EXEPATH, but that seems to be an install-time variable.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">31st August 2007, 15:56</div></div><div class="posttext">you could use a define.<br />
<br />
Maybe someone should add a feature request for something like !systemEOF or something that executes after makensis is done writing to the installer</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">31st August 2007, 16:42</div></div><div class="posttext">I requested for something similar, !macro CompileDone or something it was. I think the answer currently is to use a batch file.<br />
<br />
Stu</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>