<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" CopyFiles problem on Win7 x64, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  CopyFiles problem on Win7 x64 NSIS Discussion" />
	
	<title> CopyFiles problem on Win7 x64 [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  CopyFiles problem on Win7 x64</div>
<hr />
<div class="pda"><a href="t-317650.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=317650">CopyFiles problem on Win7 x64</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">ngildea</div><div class="date">11th March 2010, 14:39</div></div><div class="posttext">I'm have a problem with CopyFiles on Windows 7 x64. I use CopyFiles to firstly back up an existing file from another program's installation, then to copy another file from my installation into the directory to replace the backed-up file.<br />
<br />
Under Windows XP, Vista and Windows 7 32-bit this all works correctly. Under Windows 7 x64 both the CopyFile operations fail. Initially, I thought it may be a permissions issue but running as administrator makes no difference. I then considered that there may be some problem with the underlying operation so I replaced the use of CopyFiles with direct calls to CopyFileA in kernel32.dll, and still the problem persisted. I made a small test app which perfoms the same operations using CopyFileA from kernel32 which does work, even without Admin privilidges.<br />
<br />
Does anyone have any idea why this is the case?<br />
<br />
Edit:<br />
<br />
I have built a plugin DLL with the following function (just a wrapper around CopyFileA) which does work.<br />
<br />
<br />
void __declspec(dllexport) copy(<br />
	HWND hWndParent, int string_size, char* variables, stack_t** stacktop, extra_parameters* extraParams)<br />
{<br />
	char srcPath[1024], dstPath[1024];<br />
	DWORD error;<br />
<br />
	g_hwndParent = hWndParent;<br />
	EXDLL_INIT();<br />
<br />
	memset(srcPath, 0, 1024);<br />
	memset(dstPath, 0, 1024);<br />
	<br />
	if (popstringn(srcPath, 1023) || popstringn(dstPath, 1023))<br />
	{<br />
		return;<br />
	}<br />
<br />
	if (!CopyFileA(srcPath, dstPath, FALSE))<br />
	{<br />
		char buffer[1024];<br />
		memset(buffer, 0, 1024);<br />
<br />
		error = GetLastError();<br />
		sprintf(buffer, &quot;error: %d\n&quot;, error);<br />
		MessageBoxA(hWndParent, buffer, &quot;CopyFile failed.&quot;, MB_OK);<br />
	}<br />
}<br />
<br />
<br />
I can't imagine why this works, but the builtin CopyFiles command itself fails. Surely CopyFiles just does this, along with some other book keeping and error checking?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pengyou</div><div class="date">11th March 2010, 20:38</div></div><div class="posttext">CopyFiles works OK on my Windows 7 x64 system when I use it to copy single files silently.<br />
<br />
It would help if you showed the code that fails. How does it fail? (do you get an error, what appears in the installer log)<br />
<br />
Which version of NSIS are you using?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">ngildea</div><div class="date">12th March 2010, 12:43</div></div><div class="posttext">Here's a cut down version of the script that shows the problem:<br />
<br />
<br />
Name &quot;CopyFilesError&quot;<br />
OutFile &quot;copyfiles.exe&quot;<br />
InstallDir $PROGRAMFILES\CopyFilesError<br />
RequestExecutionLevel admin<br />
<br />
Page directory<br />
Page instfiles<br />
<br />
Var VC_BIN_FOLDER<br />
Var VC_CL_PATH<br />
<br />
Function InstallFile<br />
	ReadRegStr $0 HKLM &quot;Software\Microsoft\VisualStudio\${VISUAL_STUDIO_VERSION}\Setup\VC&quot; &quot;ProductDir&quot;<br />
	StrCpy $VC_BIN_FOLDER &quot;$0\bin&quot;<br />
	StrCpy $VC_CL_PATH &quot;$VC_BIN_FOLDER\cl.exe&quot;<br />
	<br />
	CopyFiles $VC_CL_PATH &quot;$VC_BIN_FOLDER\cl_backup.exe&quot;	; will fail<br />
	CopyFiles /SILENT $VC_CL_PATH &quot;$VC_BIN_FOLDER\cl_backup_silent.exe&quot;	; will fail<br />
	CopyFiles /FILESONLY $VC_CL_PATH &quot;$VC_BIN_FOLDER\cl_backup_filesonly.exe&quot;	; will fail<br />
	exdll::copy $VC_CL_PATH &quot;$VC_BIN_FOLDER\cl_backup_dll.exe&quot;	; will succeed<br />
FunctionEnd<br />
<br />
Section &quot;&quot; <br />
	SetOutPath $INSTDIR	<br />
	Call InstallFile<br />
SectionEnd<br />
<br />
<br />
The installer log says &quot;Copy failed.&quot;. Is there any way to get better error information?<br />
<br />
I'm using version 2.46.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pengyou</div><div class="date">12th March 2010, 12:51</div></div><div class="posttext">Have you triedCopyFiles &quot;$VC_CL_PATH&quot; &quot;$VC_BIN_FOLDER\cl_backup.exe&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">ngildea</div><div class="date">12th March 2010, 16:27</div></div><div class="posttext">Thanks for the replies. I have now tried adding the extra quotes, that didn't work either.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pengyou</div><div class="date">12th March 2010, 18:13</div></div><div class="posttext">I don't have Visual Studio or your special plugin so I had to make some changes to your sample script ... and it also failed for me.<br />
<br />
Edit:<br />
Oops! My idea was rubbish! I should have commented out your plugin call instead of deleting it.<br />
<br />
I had found that to access the uninstall entry for the 32-bit version of the Visual C++ 2008 redistributable I had to use SetRegView 64 before reading from the registry. So I jumped to the wrong conclusion...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">thek</div><div class="date">12th March 2010, 22:20</div></div><div class="posttext">I'm currently not able to check it myself but try removing<br />
&quot;RequestExecutionLevel admin&quot;<br />
If this is not set, Win7 does some *magic* compatibility stuff</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pengyou</div><div class="date">13th March 2010, 17:37</div></div><div class="posttext">Have you checked the value of $0 to see what is being read from the registry?<br />
<br />
In your CopyFilesError script try changingReadRegStr $0 HKLM &quot;Software\Microsoft\VisualStudio\${VISUAL_STUDIO_VERSION}\Setup\VC&quot; &quot;ProductDir&quot;<br />
StrCpy $VC_BIN_FOLDER &quot;$0\bin&quot;<br />
StrCpy $VC_CL_PATH &quot;$VC_BIN_FOLDER\cl.exe&quot;toReadRegStr $0 HKLM &quot;Software\Microsoft\VisualStudio\${VISUAL_STUDIO_VERSION}\Setup\VC&quot; &quot;ProductDir&quot;<br />
StrCpy $VC_BIN_FOLDER &quot;$0\bin&quot;<br />
StrCpy $VC_CL_PATH &quot;$VC_BIN_FOLDER\cl.exe&quot;<br />
<br />
DetailPrint &quot;$$0=$0&quot;<br />
DetailPrint &quot;$$VC_BIN_FOLDER=$VC_BIN_FOLDER&quot;<br />
DetailPrint &quot;$$VC_CL_PATH=$VC_CL_PATH&quot;and check the log to see the values which are being used.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">ngildea</div><div class="date">15th March 2010, 16:16</div></div><div class="posttext">I have discovered the problem, the CopyFiles instruction will fail when there are multiple directory separators in a row. My code was building the path &quot;c:\Program Files (x86)\Microsoft Visual Studio 8\VC\\bin&quot; which works correctly in the direct API calls, but for some reason NSIS chokes on this.<br />
<br />
Thanks for the help!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">onurk</div><div class="date">24th August 2010, 17:02</div></div><div class="posttext">ngildea, thanks a lot for sharing your ideas on this issue. you have been really helpful. I wonder if you could send me the DLL you built as a workaround. I am not familiar with C++ development so even if you posted your code here, I could not make use of it.<br />
<br />
I also wonder whether you have a way of fixing the file path (multiple directory separators) so that CopyFiles would work fine.<br />
<br />
I appreciate any kind of help.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">24th August 2010, 17:17</div></div><div class="posttext">WordReplace?<br />
<br />
Stu</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>