<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" add/remove programs - impossible file size, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  add/remove programs - impossible file size NSIS Discussion" />
	
	<title> add/remove programs - impossible file size [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  add/remove programs - impossible file size</div>
<hr />
<div class="pda"><a href="t-128462.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=128462">add/remove programs - impossible file size</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">rkaltenbach</div><div class="date">14th March 2003, 22:18</div></div><div class="posttext">An earlier thread mentioned a problem with impossible file sizes showing up when using add/remove programs to uninstall a file.<br />
<br />
I have the same problem.  Has anyone found a solution?<br />
<br />
Thanks,<br />
  Randy</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">14th March 2003, 22:25</div></div><div class="posttext">The file size is calculated by Windows, it has nothing to do with NSIS. I think it takes the size of the directory.<br />
<br />
Did you write a &quot;InstallLocation&quot; string value with the $INSTDIR?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">rkaltenbach</div><div class="date">18th March 2003, 22:23</div></div><div class="posttext">I did set a default directory using InstallDirRegKey and modified it to point to a subdirectory into which I installed the file.  (This problem occurred with the sample code I posted for the webapps install).<br />
<br />
If, indeed, the size is based on the directory that already exists (webapps is big), then that would explain the problem.  Odd, though, that the calculation is made on the whole directory, rather than what is installed.<br />
<br />
   Randy</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">18th March 2003, 22:50</div></div><div class="posttext">Windows doesn't keep the list of files your installer have installed, that would be a crazy thing to do. Therefore it relies on the data it does have, which is what you give it. If your files are in a sub directory of webapps then you should narrow Windows' search with InstallLocation as Joost mentioned. If that's not the case then you'll have to find a way to tell Windows to not calculate that size. If you find such a way please tell us :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">rkaltenbach</div><div class="date">19th March 2003, 00:23</div></div><div class="posttext">No, I am not installing into a subdirectory of webapps.  What the Tomcat server does is automatically expand web applications that are &quot;zipped .war&quot; files into subdirectories.  So I am just installing a file into that webapps subdirectory that will be expanded later by the server.  (This is why, at the end of my uninstall, I delete a directory that I did not originally install - it is built by Tomcat.)<br />
<br />
Oh well....<br />
<br />
As the farmer told me, &quot;Sorry, you can't get there from here.&quot; ;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">AndrewKoransky</div><div class="date">3rd June 2003, 19:57</div></div><div class="posttext">Try the following:<br />
<br />
    WriteRegDWORD HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\${INSTALLERDISPLAYNAME}&quot; &quot;EstimatedSize&quot; &lt;size&gt; <br />
<br />
Your mileage may vary by operating system.<br />
<br />
However, from what I can tell, NSIS doesn't provide a way to get the size of a section.  Nor is there a way to get the size of all files that are being installed.  Ideally, NSIS would provide a way of getting the total size of everything that's going to install so I can write it to that to the aforementioned registry location.<br />
<br />
Thanks Nullsoft for a great product!<br />
<br />
Take care,<br />
Andrew Koransky<br />
www.koransky.com</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">3rd June 2003, 20:37</div></div><div class="posttext">Ah, what about this?<br />
<br />
http://nsis.sourceforge.net/Docs/Chapter4.html#4.9.13.8<br />
<br />
Not sure if that does what you need (get section size)<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">AndrewKoransky</div><div class="date">3rd June 2003, 20:58</div></div><div class="posttext">Hmmm... I thought I was on the latest released (stable?) build?  New for 2.0b4, eh?  Looks like my wait will be brief.  :-)<br />
<br />
I guess to get the total size of an executing install (IE while writing uninstaller reg entry), I'll have to write a macro/function to iterate through sections, see if they are checked, and give me a total size.  I'll try to post it when I have something.<br />
<br />
Thanks for the heads up!<br />
<br />
Take care,<br />
Andrew Koransky<br />
www.koransky.com</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">4th June 2003, 12:00</div></div><div class="posttext">Yep, a simple loop that stops when an error rises will be easy enough to implement.<br />
<br />
I couldn't resist :)<br />
<br />
StrCpy $0 0<br />
StrCpy $2 0<br />
loop:<br />
  SectionGetSize $0 $1<br />
  IfErrors done<br />
  IntOp $2 $2 + $1<br />
  IntOp $0 $0 + 1<br />
  Goto loop<br />
done:<br />
  DetailPrint &quot;total of $2KB&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">AndrewKoransky</div><div class="date">2nd March 2004, 20:02</div></div><div class="posttext">I couldn't resist either.  :p<br />
<br />
I'm finally getting around to adding this to our installers.  Your sample didn't take into account whether or not the section is selected... thought I'd post it in case anyone else finds it of use.  <br />
<br />
FYI... the registry entry below is basically ignored by Microsoft, at least in my copy of W2K.  &lt;sigh&gt;  So far as I can tell, Microsoft doesn't have a way to get the size correct in the add/remove programs control panel applet.  If anyone has found a way, please let me know!<br />
<br />
<br />
!define SF_SELECTED   1<br />
    ; Calculate estimated size of the installation in K<br />
    <br />
    ; save off variable state<br />
    Push $0 ; section counter<br />
    Push $1 ; current section size<br />
    Push $2 ; running total of selected section sizes<br />
    Push $3 ; current section flags<br />
    <br />
    StrCpy $0 0<br />
    StrCpy $2 0<br />
    CreateUninstaller_SectionGetSize_Loop:<br />
      <br />
      ; get section size, break if we run out<br />
      ClearErrors<br />
      SectionGetSize $0 $1<br />
      IfErrors CreateUninstaller_SectionGetSize_LoopDone<br />
      <br />
      ; check to see if it is selected, otherwise, &quot;continue&quot; (increment counter and restart loop)<br />
      SectionGetFlags $0 $3<br />
      IntOp $3 $3 &amp; ${SF_SELECTED}<br />
      IntCmp ${SF_SELECTED} $3 0 CreateUninstaller_SectionGetSize_LoopContinue CreateUninstaller_SectionGetSize_LoopContinue<br />
 <br />
      ; add the total up...<br />
      IntOp $2 $2 + $1<br />
<br />
      CreateUninstaller_SectionGetSize_LoopContinue:<br />
      IntOp $0 $0 + 1 ; loop increment<br />
      Goto CreateUninstaller_SectionGetSize_Loop<br />
    CreateUninstaller_SectionGetSize_LoopDone:<br />
    <br />
    ; write it to the registry<br />
    WriteRegDWORD HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\${INSTALLERDISPLAYNAME}&quot; &quot;EstimatedSize&quot; $2<br />
    <br />
    ; restore the variables<br />
    Pop $3<br />
    Pop $2<br />
    Pop $1<br />
    Pop $0</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">3rd March 2004, 17:29</div></div><div class="posttext">i think EstimatedSize only works with msi installers...<br />
<br />
WindowsInstaller(dword)=1, but im not sure if that works</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mrsdonovan</div><div class="date">28th July 2004, 00:20</div></div><div class="posttext">Actually, this article (http://www.pcmag.com/article2/0,1759,1159867,00.asp) (PCMag.com) covers where the (A)dd and (R)emove (P)rograms (ARP) &quot;EstimatedSize&quot; information is set in the registry and it's under:<br />
Software\Microsoft\Windows\CurrentVersion\App Management\ARPCache\&lt;same uninstall key&gt;&quot; under  &quot;SlowInfoCache&quot;<br />
(As an aside, doesn't that key make more sense if it was spelt &quot;ShowInfoCache&quot; :weird: )<br />
<br />
I modified the code listed by Andrew above, but I ran into a problem I couldn't find a solution to, even reading the NSIS forums and manuals.<br />
<br />
The code I came up with is:<br />
<br />
; Convert the result to Hex for the ARP cache<br />
; It has a format of:<br />
; Len  - HasName           - EstimatedSize<br />
; 2802 - 00 00 00 00 00 00 - 00 00 00 00 00 00 00 00 - &lt;etc&gt;<br />
IntFmt $0 &quot;2802000000000000%08X&quot; $2<br />
; Then write it to ARP cache<br />
WriteRegBin HKLM \<br />
&quot;Software\Microsoft\Windows\CurrentVersion\App Management\ARPCache\${PRODUCT_PUBLISHER}&quot; &quot;SlowInfoCache&quot; $0<br />
<br />
<br />
Looks right, no?  But the compiler complains and it's because of the &quot;$0&quot; variable.  If I just hard code a value instead of $0, it works.  I also tried putting quotations around the variable, tried different variables like $R0, etc, but no luck :eek: .<br />
<br />
What is wrong?  Do I have to define the variable as a hex type? Bug?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">28th July 2004, 00:47</div></div><div class="posttext">It says in the user manual that the format is<br />
<br />
IntFmt user_var(output) format numberstring<br />
<br />
and your code fits that format, so I don't know...<br />
<br />
Edit: Just tried that code, and it works fine. Are you running latest CVS?<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mrsdonovan</div><div class="date">28th July 2004, 03:39</div></div><div class="posttext">No, but after your post, I got the latest release build (Feb 7th, 2004), and alas, the same error.  I then got the latest development build (July 21st, 2004) and same thing.<br />
<br />
I tried the code just by itself:<br />
<br />
OutFile &quot;MyTest.exe&quot;<br />
Section -Post<br />
    Push $0<br />
    StrCpy $0 12321<br />
     WriteRegBin HKLM &quot;Software\Microsoft\Windows\CurrentVersion\App Management\ARPCache\Test&quot; &quot;SlowInfoCacheBak&quot; $0<br />
SectionEnd     <br />
<br />
That should work right?  But the same error occurs:<br />
<br />
Usage: WriteRegBin rootkey subkey entry_name hex_string_like_12848412AB<br />
    root_key=(HKCR|HKLM|HKCU|HKU|HKCC|HKDD|HKPD)<br />
Error in script &quot;C:\MyScripts\test.nsi&quot; on line 8 -- aborting creation process<br />
<br />
<br />
I thought one factor might be the that I am compiling in HM NIS edit 2.0rc2, but I tried MakenSISW and same thing.  Any compile settings, etc. that I should check?<br />
<br />
I've noticed other people have the same problem (http://forums.winamp.com/showthread.php?postid=1348165#post1348165) (note - he fixes the HKLM problem in a post farther down).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mrsdonovan</div><div class="date">28th July 2004, 03:46</div></div><div class="posttext">Oops, maybe this (http://nsis.sourceforge.net/archive/viewpage.php?pageid=280) is what I need...  To quote:<br />
<br />
RegBin.dll - NSIS extension DLL<br />
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<br />
<br />
Writes an arbitrarily large binary value (which can be set at runtime) to the Windows Registry.<br />
This overcomes two shortcomings of the standard WriteRegBin command:<br />
a) Binary values have to specified at compile-time.<br />
b) Maximum size of the value is 511 bytes.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mrsdonovan</div><div class="date">28th July 2004, 05:46</div></div><div class="posttext">Yup, works now! :up: Get the dll from the RegBin (http://nsis.sourceforge.net/archive/viewpage.php?pageid=280) plugin and put it in your NSIS\plugins directory.<br />
<br />
But can someone convert the decimal result into an Int64 and then into hex?  The code below doesn't show the size correctly in the ARP dialog window:<br />
<br />
<br />
    ; Convert the result to Hex for the ARP cache<br />
    ; It has a format of:<br />
    ; Len  - HasName?          - EstimatedSize (int64)<br />
    ; 2802 - 00 00 00 00 00 00 - 00 00 00 00 00 00 00 00 - &lt;etc&gt;<br />
    IntFmt $0 &quot;2802000000000000%016X0000000000000000FFFFFFFF000000000000000&quot; $2  ; &lt;-- this is messed <br />
<br />
    ; Then write it to ARP cache, use RegBin plugin<br />
    RegBin::WriteRegBin HKLM \ <br />
      &quot;Software\Microsoft\Windows\CurrentVersion\App Management\ARPCache\${INSTALLERDISPLAYNAME}&quot; \<br />
      &quot;SlowInfoCache&quot; $0<br />
<br />
<br />
It would also be cool to get the current time in the &quot;FileTime&quot; format to replace the &quot;FFFFFFFF&quot; which just clear that field.<br />
<br />
Cheers!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">iceman_k</div><div class="date">28th July 2004, 05:47</div></div><div class="posttext">The reason that MakeNSIS does not accept variables for the binary value is that it packs the binary value into the installer at compile time.<br />
Anyway, glad to see that someone else has found a use for the plugin.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>