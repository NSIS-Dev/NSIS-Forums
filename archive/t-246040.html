<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Multi user environment shortcut problem, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Multi user environment shortcut problem NSIS Discussion" />
	
	<title> Multi user environment shortcut problem [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Multi user environment shortcut problem</div>
<hr />
<div class="pda"><a href="t-246040.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=246040">Multi user environment shortcut problem</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">longoja</div><div class="date">12th May 2006, 14:17</div></div><div class="posttext">I am currently installing an app on Windows XP, and installing shortcuts in both All Users and a specifer user, let's say Joe.<br />
<br />
SetShellVarContext all<br />
SetOutPath &quot;$INSTDIR\test\bin&quot;<br />
CreateShortCut &quot;$StartMenu\my.lnk&quot; &quot;$INSTDIR\test\bin\my.bat&quot;<br />
<br />
that works just fine and all the time for All Users<br />
<br />
But then I try this<br />
<br />
SetOutPath &quot;$INSTDIR\test\bin&quot;<br />
CreateShortCut &quot;C:\Documents and Settings\Joe\Start Menu\my.lnk&quot; &quot;$INSTDIR\test\bin\my.bat&quot;<br />
<br />
I can't seem to get this to work at all.  The software pushing this and running the installer has Administration rights.<br />
<br />
Any ideas?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">14th May 2006, 18:48</div></div><div class="posttext">CreateShortCut &quot;C:\Documents and Settings\Joe\Start Menu\my.lnk&quot;<br />
This will never work unless the logged user is Joe and Joe has his profile stored in the given path.<br />
Hard coding it's not good idea. Even if you're sure that Joe's profile is in that path, it is possible that Joe's account is protected, so you can't access his profile if the logged user is Bill.<br />
SetShellVarContext takes 2 parameters, the default current, and all. So you may use it like this:<br />
SetShellVarContext all<br />
SetOutPath &quot;$INSTDIR\test\bin&quot;<br />
CreateShortCut &quot;$SMPROGRAMS\my.lnk&quot; &quot;$INSTDIR\test\bin\my.bat&quot;<br />
<br />
To create shortcuts for all users and/or some other installation actions,<br />
SetShellVarContext current ; optional<br />
SetOutPath &quot;$INSTDIR\test\bin&quot;<br />
CreateShortCut &quot;$SMPROGRAMS\my.lnk&quot; &quot;$INSTDIR\test\bin\my.bat&quot;<br />
<br />
to create shortcuts and/or some other installation actions for the current logged user.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">longoja</div><div class="date">15th May 2006, 13:58</div></div><div class="posttext">There is no way to install this as Joe.  Currently we have a disabled user that we enable, then add to a Administration Group, do an install, then we remove it from that and disable it again.<br />
<br />
So during the install, the user doing the install, does have Administration rights and that profile for Joe does exist.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">17th May 2006, 13:03</div></div><div class="posttext">There is no way to install this as JoeHow about impersonating that user (Joe) and running the part of the installer that writes the shortcut, using his security context?<br />
CF</div></div><hr />


<div class="post"><div class="posttop"><div class="username">longoja</div><div class="date">17th May 2006, 14:15</div></div><div class="posttext">I can't install this as Joe or impersonate him :-)<br />
<br />
What I'm going to try now, is a batch solution, if I get that to work, then I may try to create a plugin for NSIS and incorporate that logic.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">17th May 2006, 15:11</div></div><div class="posttext">There is no way to install this as Joe. Currently we have a disabled user that we enable, then add to a Administration Group, do an install, then we remove it from that and disable it again.There is no way to install this as Joe<br />
???<br />
<br />
Is 'Joe' the disabled account or not?<br />
<br />
If yes, how about this:<br />
Start the installation as some admin user. Enable Joe + add admin privileges. Then create a token in Joe's sec context and swap to that context, create the shortcut then kill the token (ie revert to the initial admin user), strip Joe's admin privileges, disable him, then go on with the rest of the installation.<br />
<br />
I can provide the impersonation part of the code, I have written something similar and works as stated above<br />
<br />
CF</div></div><hr />


<div class="post"><div class="posttop"><div class="username">longoja</div><div class="date">17th May 2006, 16:04</div></div><div class="posttext">Joe is not the disabled account, but the user that ultimately uses the application after reboot.<br />
<br />
There is a different disabled account, that gets enabled, receives admin rights, does the install, admin rights are taken away, and the account is disabled, then the computer reboots.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">17th May 2006, 20:29</div></div><div class="posttext">Is Joe an active account? Do you know his password? Can you use something like LogonUser to get a token for Joe then create the shortcut using Joe's security context? Or is it some random account that you need to create a shortcut in its profile folder? If you know the password you can impersonate the user, if not I see the problem :)<br />
CF</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>