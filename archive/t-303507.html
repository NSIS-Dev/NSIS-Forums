<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Why NSIS installer read environment variable incorrectly?, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Why NSIS installer read environment variable incorrectly? NSIS Discussion" />
	
	<title> Why NSIS installer read environment variable incorrectly? [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Why NSIS installer read environment variable incorrectly?</div>
<hr />
<div class="pda"><a href="t-303507.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=303507">Why NSIS installer read environment variable incorrectly?</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">v_automation</div><div class="date">25th February 2009, 22:52</div></div><div class="posttext">Hi<br />
<br />
Why NSIS installer read environment variable incorrectly?<br />
<br />
I read processor_architecture variable on Windows x64 and installer returns x86 instead of AMD64. Why?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comperio</div><div class="date">26th February 2009, 00:19</div></div><div class="posttext">From what I was able to gather from Google searches was that a 32-bit process returns &quot;x86&quot;, while a 64-bit process will return &quot;AMD64&quot; or &quot;IA64&quot;.  (and as you may have guessed by now, NSIS is 32-bit.)<br />
<br />
This is explained better here:<br />
http://msdn.microsoft.com/en-us/library/aa384274(VS.85).aspx</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">26th February 2009, 00:46</div></div><div class="posttext">use x64.nsh</div></div><hr />


<div class="post"><div class="posttop"><div class="username">v_automation</div><div class="date">26th February 2009, 07:49</div></div><div class="posttext">Hello Comperio, Anders!<br />
<br />
Thank you for your replays!<br />
<br />
NSIS is installer and the only reason for getting processor_architecture variable is to know in what environmen it is executed, so NSIS installer must returns correct value according to OS type.<br />
<br />
It is not inportant how windows changes variables, installer must allways return correct values.<br />
<br />
I do not want to use x64.nsh, because it require adding of additional libraries/plug-ins to installer, for something so simple and natural for any installer.<br />
<br />
There a lot of indirect ways OS type to be detected, so I do not need x64.nsh, but installer, must report variables accordingly, so this is bug that must be fixed!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comperio</div><div class="date">26th February 2009, 16:48</div></div><div class="posttext">what &quot;bug&quot;?  The link I provided from MS indicates that this problem happens on ANY 32-bit app.<br />
<br />
The only solution therefore would be to create a 64-bit version of NSIS.  Unfortunately, converting NSIS to native 64-bit is not an easy task.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">26th February 2009, 18:54</div></div><div class="posttext">Simple and natural? Reading environment variables is never the best way to get info, since you know, THE USER CAN CHANGE THEM. x64.nsh is part of the default nsis install, you should consider it as a part of NSIS (If you are using Modern UI, you are already using a plugin)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">26th February 2009, 20:16</div></div><div class="posttext">If for whatever reason you still don't want to use the proper method, on Vista, %windir%\Sysnative redirects to the 64 bit system folder, you can use IfFileExist to check it's content and tell if you are on 64 bit or not</div></div><hr />


<div class="post"><div class="posttop"><div class="username">v_automation</div><div class="date">27th February 2009, 10:00</div></div><div class="posttext">Hello Anders, Comperio!<br />
<br />
Thank you for your replays!<br />
<br />
Replays of both of you I evaluate as useful.<br />
<br />
I need a most simple way to detect OS type, so I now use PROCESSOR_ARCHITEW6432 variable to check OS type.<br />
<br />
I call this bug because we talk for installer, but not for text editor. If NSIS is installer it must provide predefined constants as $sysdir and $windir, that to return OS version and type by simply reading them. Why I need to write code to get OS type or version, when this are parameters that are related to any setup and everyone need them by one or other reason.<br />
<br />
OS type and version as so natural and important to installer constants as directory constants, even more, because I can get folders paths from registry, but not and OS type<br />
<br />
I do not need native 64bit version of installer, because 32bit version is doing the job perfectly, while 64bit version cannot run on 32bit OS, and obviously I need it to run as on 32bit as well on 64bit, and this is why I need to detect OS type</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">14th March 2009, 22:49</div></div><div class="posttext">That information is provided, as Anders mentioned, in functions defined in x64.nsh. Further functions for version detection are available in WinVer.nsh.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">rrobinson</div><div class="date">2nd May 2009, 17:30</div></div><div class="posttext">You might want to try this to get the native cpu architecture.  Google GetNativeSystemInfo to get the meaning of the result returned on the stack.<br />
<br />
Function GetCPUArchitecture<br />
  Push $2<br />
  Push $1<br />
  System::Alloc 36 ; new SYSTEM_INFO<br />
  Pop $1           ; $1 = new SYSTEM_INFO<br />
  System::Call &quot;Kernel32::GetNativeSystemInfo(i r1)&quot;  ; GetNativeSystemInfo($1)<br />
  System::Call &quot;*$1(&amp;i2.r2)&quot; ; $2 = ((WORD*)$1)[0], which is the wProcessorArchitecture field<br />
  System::Free $1 ; delete $1<br />
  Pop $1<br />
  Exch $2  ;so the register $1 and $2 are preserved and the result is on the top of the stack<br />
FunctionEnd</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>