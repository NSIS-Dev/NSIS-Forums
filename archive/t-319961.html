<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Quoted path to file not found.  Should it be?, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Quoted path to file not found.  Should it be? NSIS Discussion" />
	
	<title> Quoted path to file not found.  Should it be? [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Quoted path to file not found.  Should it be?</div>
<hr />
<div class="pda"><a href="t-319961.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=319961">Quoted path to file not found.  Should it be?</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">dbyron</div><div class="date">15th June 2010, 02:16</div></div><div class="posttext">I've run into an annoying situation.  My installer reads a registry key to get the path to some executable.  In this case it's the default value of HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\wmplayer.exe.<br />
<br />
It then checks to see if the path I read actually exists.  In general this works fine, but on some machines (I've seen in on 64-bit Win7, a European version I believe) the path that's there is surrounded by quotes.  As in<br />
<br />
&quot;%ProgramFiles(x86)%\Windows Media Player&quot;<br />
<br />
To be brutally explicit, the quotes above are actually in the registry.<br />
<br />
Normally, I see the default value of this key with no quotes.<br />
<br />
My installer isn't working because it takes the value figured out by ReadRegStr and passes it to IfFileExists.  IfFileExists ends up calling file_exists in Source/exehead/util.c which calls FindFirstFile which thinks the file doesn't exist.<br />
<br />
I can add logic to my installer to look for these quotes and remove them, but I wonder how many other folks will run into this, and with who knows what other registry keys.  Another approach is to patch file_exists to look for surrounding quotes and to remove them before calling FindFirstFile, or perhaps changing the IfFileExists implementation instead so all the other callers of file_exists don't change.<br />
<br />
I can see the slippery slope here...Does this mean FileOpen needs to handle surrounding quotes as well?  And I'm sure there are others.  It's annoying.  And it could be that one of my customers or some non-MS program edited the registry so it's not a widespread thing.  But, I figured I'd throw this out there to see what people think.  Maybe you think changing file_exists is reasonable?  Or maybe you have another solution.<br />
<br />
Thanks for your help.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">15th June 2010, 18:49</div></div><div class="posttext">I think if you suspect a path could have quotes you should put the code in there. If the code is in IfFileExists and it's not used in most cases then that is (albeit small) extra overhead.<br />
<br />
In script, it's just 6 lines:<br />
<br />
  StrCpy $R0 $Path 1<br />
  StrCmp $R0 `&quot;` 0 +2<br />
    StrCpy $Path $Path `` 1<br />
  StrCpy $R0 $Path `` -1<br />
  StrCmp $R0 `&quot;` 0 +2<br />
    StrCpy $Path $Path -1<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dbyron</div><div class="date">15th June 2010, 20:52</div></div><div class="posttext">I bet you're right that changing NSIS itself to handle this isn't right.  Here's what I came up with to remove the quotes -- only when a string both starts and ends with a quote do I remove them.  Thanks for a push in the right direction.<br />
<br />
Function RemoveSurroundingQuotes<br />
  Exch $0 ; The string in question<br />
  Push $2 ; the first character<br />
  Push $3 ; the last character<br />
<br />
  StrCpy $2 $0 1<br />
  StrCpy $3 $0 &quot;&quot; -1<br />
<br />
  StrCmp $2 '&quot;' 0 no_leading_quote<br />
    StrCmp $3 '&quot;' 0 no_trailing_quote<br />
      StrCpy $0 $0 -1 1<br />
<br />
no_leading_quote:<br />
no_trailing_quote:<br />
  Pop $3<br />
  Pop $2<br />
  Exch $0<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jiake</div><div class="date">18th June 2010, 09:27</div></div><div class="posttext">StrCpy $0 `&quot;C:\Program Files\Internet Explorer\iexplore.exe&quot;`<br />
System::Call 'Shlwapi::PathUnquoteSpaces(t r0r0)'<br />
# $0=C:\Program Files\Internet Explorer\iexplore.exe</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dbyron</div><div class="date">18th June 2010, 17:54</div></div><div class="posttext">Fancy, though http://msdn.microsoft.com/en-us/library/bb773763%28VS.85%29.aspx says it's limited to MAX_PATH characters.  With any luck NSIS will support \\?\-prefixed filenames one day and we'll moved beyond that limitation.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>