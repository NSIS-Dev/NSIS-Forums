<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Set focus to installer window, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Set focus to installer window NSIS Discussion" />
	
	<title> Set focus to installer window [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Set focus to installer window</div>
<hr />
<div class="pda"><a href="t-187302.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=187302">Set focus to installer window</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">kobus</div><div class="date">21st July 2004, 11:12</div></div><div class="posttext">Hi,<br />
<br />
I'am trying to prevent user to run installer more then once at a time. (it works) :)<br />
<br />
In such a case I want to display message about it and set focus to already working installer winodw.<br />
<br />
my code:<br />
<br />
<br />
Function .onInit<br />
System::Call 'kernel32::CreateMutexA(i 0, i 0, t &quot;myMutexS&quot;) i .r1 ?e'<br />
  Pop $R0<br />
<br />
  StrCmp $R0 0 ok  <br />
  MessageBox MB_OK|MB_ICONSTOP &quot;Installer already working&quot;<br />
  FindWindow $1 &quot;&quot; &quot;${PRODUCT_NAME}&quot; 0 0<br />
  SendMessage $1 0x00007 0 0   'send WM_SETFOCUS<br />
  Abort<br />
ok:<br />
  ...<br />
FunctionEnd <br />
<br />
why it didn't work ? Any idea ?<br />
with WM_CLOSE (0x00010) it works perfectly ...<br />
<br />
thanks in advance<br />
<br />
kobus</div></div><hr />


<div class="post"><div class="posttop"><div class="username">deguix</div><div class="date">21st July 2004, 11:58</div></div><div class="posttext">You're calling it in .onInit, at this time the installer GUI wasn't loaded so it will never find a window and set focus to it. Use .onGUIInit instead.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kobus</div><div class="date">21st July 2004, 12:04</div></div><div class="posttext">Originally posted by deguix <br />
You're calling it in .onInit, at this time the installer GUI wasn't loaded so it will never find a window and set focus to it. Use .onGUIInit instead.  <br />
<br />
The scenario is different. <br />
User run installer (instance no 1). Then run installer agian (instance no 2). <br />
And now instance no 2. should inform user that installer is already working, set focus to window with instance no 1 and close itself (instance no 2).<br />
<br />
anyway ... with .onGuiInit didn't work too. :(<br />
<br />
kobus</div></div><hr />


<div class="post"><div class="posttop"><div class="username">iceman_k</div><div class="date">21st July 2004, 14:25</div></div><div class="posttext">Interesting. The code seems to be good. Can you upload your script?<br />
<br />
<br />
OK, this works:<br />
<br />
<br />
Function .onInit<br />
System::Call 'kernel32::CreateMutexA(i 0, i 0, t &quot;myMutexS&quot;) i .r1 ?e'<br />
Pop $R0<br />
<br />
StrCmp $R0 0 ok<br />
MessageBox MB_OK|MB_ICONSTOP &quot;Installer already working&quot;<br />
FindWindow $1 &quot;&quot; &quot;${PRODUCT_NAME} ${PRODUCT_VERSION} Setup&quot; 0 0<br />
System::call &quot;user32::SetWindowPos(i r1, i -1, i 0, i 0, i 0, i 0, i 0x02|0x01) i.r1&quot;<br />
Pop $1<br />
Abort<br />
ok:<br />
...<br />
FunctionEnd<br />
<br />
<br />
When you issue the FindWindow instruction, make sure to specify the installer name followed by &quot; Setup&quot;. In my case the installer name was &quot;${PRODUCT_NAME} ${PRODUCT_VERSION}&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kobus</div><div class="date">22nd July 2004, 07:20</div></div><div class="posttext">When you issue the FindWindow instruction, make sure to specify the installer name followed by &quot; Setup&quot;. In my case the installer name was &quot;${PRODUCT_NAME} ${PRODUCT_VERSION}&quot; <br />
<br />
I set title with caption for &quot;${PRODUCT NAME}&quot; so when I am trying to find window I use &quot;${PRODUCT NAME}&quot; as a title without &quot;setup&quot; word and it works ! - WM_CLOSE message close desired window. Only WM_SETFOCUS didn't work ...<br />
<br />
I attach the code (sorry the UI is in Polish ...)<br />
The problematic code is in onInit funcion <br />
<br />
thanks for spending time with my problems<br />
<br />
kobus</div></div><hr />


<div class="post"><div class="posttop"><div class="username">iceman_k</div><div class="date">22nd July 2004, 13:04</div></div><div class="posttext">Your attachment is missing.<br />
Anyway, did you try SetWindowPos as in my example:<br />
<br />
<br />
System::call &quot;user32::SetWindowPos(i r1, i -1, i 0, i 0, i 0, i 0, i 0x02|0x01) i.r1&quot;<br />
Pop $1<br />
<br />
<br />
This seems to work.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kobus</div><div class="date">22nd July 2004, 13:29</div></div><div class="posttext">Yes, it's really works !!!  :up: <br />
<br />
That's was my typo error :(<br />
<br />
thanks a lot <br />
kobus</div></div><hr />


<div class="post"><div class="posttop"><div class="username">externe</div><div class="date">17th November 2004, 00:12</div></div><div class="posttext">Hello,<br />
I just saw this post and test the code above. But it won't work for me.<br />
<br />
I rewrite it here.<br />
<br />
!define PRODUCT_NAME &quot;My application&quot;<br />
!define PRODUCT_VERSION &quot;1.0&quot;<br />
<br />
Name &quot;${PRODUCT_NAME} ${PRODUCT_VERSION}&quot;<br />
outfile &quot;test.exe&quot;<br />
<br />
Function .onInit<br />
System::Call 'kernel32::CreateMutexA(i 0, i 0, t &quot;myMutexS&quot;) i .r1 ?e'<br />
Pop $R0<br />
<br />
StrCmp $R0 0 ok<br />
MessageBox MB_OK|MB_ICONSTOP &quot;Installer already working&quot;<br />
FindWindow $1 &quot;&quot; &quot;${PRODUCT_NAME} ${PRODUCT_VERSION} Setup&quot;<br />
System::call &quot;user32::SetWindowPos(i r1, i -1, i 0, i 0, i 0, i 0, i 0x02|0x01) i.r1&quot;<br />
Pop $1<br />
Abort<br />
ok:<br />
<br />
FunctionEnd<br />
<br />
section &quot;Install&quot;<br />
sectionend<br />
<br />
Can someone see why that doesn't work ?<br />
Thanks :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">17th November 2004, 14:44</div></div><div class="posttext">I found that it won't work for that example because once the installation has completed, the window title will become:<br />
${PRODUCT_NAME} ${PRODUCT_VERSION} Setup: Completed<br />
<br />
If you change it to that (in FindWindow) then it works fine. This will be a problem though because the title is never going to be the same.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comm@nder21</div><div class="date">17th November 2004, 14:48</div></div><div class="posttext">why didn't you try the usual way?<br />
FindWindow $1 &quot;#32770&quot;<br />
should work for every title ...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">17th November 2004, 15:32</div></div><div class="posttext">Doesn't work :p<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">17th November 2004, 18:23</div></div><div class="posttext">Originally posted by externe <br />
Can someone see why that doesn't work ?<br />
 <br />
<br />
Tested on Win98, NSIS 2.01 - works fine.<br />
BTW in one of my apps customer asked do not show second &quot;already running&quot; message box, but close 3-rd instance silently :(<br />
<br />
#32770 window class - few and not installer dialog windows may present on the desktop :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">externe</div><div class="date">17th November 2004, 19:02</div></div><div class="posttext">Hey thanks, I never seen that the titlebar name changed...<br />
<br />
Now it work ( code below )<br />
But the focus are not really doing. (The window is gray) <br />
Is it normal ?<br />
<br />
Thanks<br />
:)<br />
<br />
<br />
!define PRODUCT_NAME &quot;My application&quot;<br />
!define PRODUCT_VERSION &quot;1.0&quot;<br />
<br />
Name &quot;${PRODUCT_NAME} ${PRODUCT_VERSION}&quot;<br />
outfile &quot;test.exe&quot;<br />
<br />
Function .onInit<br />
System::Call 'kernel32::CreateMutexA(i 0, i 0, t &quot;myMutexS&quot;) i .r1 ?e'<br />
Pop $R0<br />
<br />
StrCmp $R0 0 ok<br />
MessageBox MB_OK|MB_ICONSTOP &quot;Installer already working&quot;<br />
FindWindow $1 &quot;&quot; &quot;${PRODUCT_NAME} ${PRODUCT_VERSION} Setup&quot;<br />
System::call &quot;user32::SetWindowPos(i r1, i -1, i 0, i 0, i 0, i 0, i 0x02|0x01) i.r1&quot;<br />
Pop $1<br />
Abort<br />
ok:<br />
<br />
FunctionEnd<br />
<br />
section &quot;Install&quot;<br />
MessageBox MB_OK|MB_ICONSTOP &quot;I'm running...                             Launch another instance for testing...                &quot;<br />
sectionend</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">17th November 2004, 20:05</div></div><div class="posttext">It won't be working because the title will be &quot;${PRODUCT_NAME} ${PRODUCT_VERSION} Setup: Installing Files&quot; and so on.<br />
<br />
I'm going to have to modify that script...<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">17th November 2004, 20:09</div></div><div class="posttext">!define PRODUCT_NAME &quot;My application&quot;<br />
!define PRODUCT_VERSION &quot;1.0&quot;<br />
<br />
Name &quot;${PRODUCT_NAME} ${PRODUCT_VERSION}&quot;<br />
outfile &quot;test.exe&quot;<br />
<br />
Function .onInit<br />
System::Call 'kernel32::CreateMutexA(i 0, i 0, t &quot;myMutexS&quot;) i .r1 ?e'<br />
Pop $R0<br />
<br />
StrCmp $R0 0 ok<br />
MessageBox MB_OK|MB_ICONSTOP &quot;Installer already working&quot;<br />
FindWindow $1 &quot;&quot; &quot;${PRODUCT_NAME} ${PRODUCT_VERSION} Setup&quot;<br />
 StrCmp $1 0 0 setFocus<br />
FindWindow $1 &quot;&quot; &quot;${PRODUCT_NAME} ${PRODUCT_VERSION} Setup: License Agreement&quot;<br />
 StrCmp $1 0 0 setFocus<br />
FindWindow $1 &quot;&quot; &quot;${PRODUCT_NAME} ${PRODUCT_VERSION} Setup: Installation Options&quot;<br />
 StrCmp $1 0 0 setFocus<br />
FindWindow $1 &quot;&quot; &quot;${PRODUCT_NAME} ${PRODUCT_VERSION} Setup: Directory&quot;<br />
 StrCmp $1 0 0 setFocus<br />
FindWindow $1 &quot;&quot; &quot;${PRODUCT_NAME} ${PRODUCT_VERSION} Setup: Installing Files&quot;<br />
 StrCmp $1 0 0 setFocus<br />
FindWindow $1 &quot;&quot; &quot;${PRODUCT_NAME} ${PRODUCT_VERSION} Setup: Completed&quot;<br />
setFocus:<br />
System::call &quot;user32::SetWindowPos(i r1, i -1, i 0, i 0, i 0, i 0, i 0x02|0x01) i.r1&quot;<br />
Pop $1<br />
Abort<br />
ok:<br />
<br />
FunctionEnd<br />
<br />
Section &quot;Install&quot;<br />
...<br />
SectionEnd<br />
<br />
This should work (might want to try it).<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">externe</div><div class="date">18th November 2004, 07:25</div></div><div class="posttext">Nice, Thanks Afrow UK. :)<br />
<br />
I understand the way well now :p <br />
<br />
Is it possible to list the windows ? I mean create a macro who's loop in the list of all window and search the words &quot;${PRODUCT_NAME}&quot; and &quot;Setup&quot;.<br />
<br />
Nice idea no ?<br />
<br />
Bye.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">18th November 2004, 07:45</div></div><div class="posttext">Program can check all top level dialog windows - this should work with custom installer pages too.<br />
<br />
Function .onInit<br />
<br />
   System::Call 'kernel32::CreateMutexA(i 0, i 0, t &quot;myMutexS&quot;) i .r1 ?e'<br />
   Pop $R0<br />
   StrCmp $R0 0 ok<br />
   MessageBox MB_OK|MB_ICONSTOP &quot;Installer already working&quot;<br />
<br />
   StrLen $5 &quot;${PRODUCT_NAME} ${PRODUCT_VERSION}&quot;<br />
 loop:<br />
    FindWindow $0 '#32770' '' 0 $0<br />
    IntCmp $0 0 ok<br />
    StrCpy $3 ${NSIS_MAX_STRLEN}<br />
    System::Call &quot;user32.dll::GetWindowText(i r0, t r1, i r3) i.r4&quot;<br />
    StrCpy $6 $1 $5<br />
    StrCmp $6 &quot;${PRODUCT_NAME} ${PRODUCT_VERSION}&quot; 0 loop<br />
    System::call &quot;user32::SetWindowPos(i r1, i -1, i 0, i 0, i 0, i 0, i 0x02|0x01) i.r1&quot;<br />
    Pop $1<br />
    Abort<br />
 ok:<br />
<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">externe</div><div class="date">18th November 2004, 10:37</div></div><div class="posttext">Well, sorry if i'm a few OT, but I want to understand what return exactly :<br />
FindWindow $0 '#32770' '' 0 $0<br />
<br />
So I write this little test : A 10 loop wich open a messagebox with the return of FindWindow.<br />
<br />
outfile &quot;test.exe&quot;<br />
<br />
Section &quot;Install&quot;<br />
<br />
StrCpy $9 0<br />
<br />
loop:<br />
FindWindow $0 '#32770' '' 0 $0<br />
MessageBox MB_OK|MB_ICONSTOP $0<br />
<br />
IntOp $9 $9 + 1<br />
StrCmp $9 10 0 loop<br />
<br />
SectionEnd<br />
<br />
And that give me numbers : 918078, 66148, 66188, 1180982, 0, ...<br />
<br />
Can someone tell me what mean those numbers ?<br />
Thanks :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">18th November 2004, 11:48</div></div><div class="posttext">This means that you have 4 dialog type windows (class #32770) on the desktop, and numbers are system window handles. Using handle program can read window caption (this case).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">externe</div><div class="date">18th November 2004, 12:39</div></div><div class="posttext">Ok,<br />
#32770 mean USER dialog boxes thanks!<br />
I found info also here : MSDN (http://msdn.microsoft.com/library/default.asp?url=/library/en-us/msaa/msaapndx_6qlh.asp)<br />
<br />
You say : &quot;Using handle program can read window caption&quot;.<br />
This is what the line System::Call &quot;user32.dll::GetWindowText(i r0, t r1, i r3) i.r4&quot; does ? Right ?<br />
Well I try this ( from reading your previous code )<br />
But that return nohing ( I try to have the caption in the messagebox ) <br />
<br />
<br />
outfile &quot;test.exe&quot;<br />
<br />
Section &quot;Install&quot;<br />
<br />
StrCpy $9 0<br />
<br />
loop:<br />
FindWindow $0 '#32770' '' 0 $0<br />
System::Call &quot;user32.dll::GetWindowText(i r0, t r1, i r3) i.r4&quot;<br />
StrCpy $6 $1<br />
<br />
MessageBox MB_OK|MB_ICONSTOP $6<br />
<br />
IntOp $9 $9 + 1<br />
StrCmp $9 3 0 loop<br />
<br />
SectionEnd<br />
<br />
<br />
Can you help me once again please ? :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">18th November 2004, 13:31</div></div><div class="posttext">Caption text is second parameter, use $1 in the MessageBox.<br />
StrCpy copies from $1 to $6 first part of caption only ($5 is length).<br />
You have nothing because not defines buffer length (last parameter, MSDN please :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comm@nder21</div><div class="date">18th November 2004, 16:12</div></div><div class="posttext">#32770 window class - few and not installer dialog windows may present on the desktop<br />
damn :)<br />
<br />
improved and shortened the code a bit:<br />
	System::Call	'kernel32::CreateMutexA(i 0, i 0, t &quot;$(^Name)&quot;) i .r0 ?e'<br />
	Pop		$0<br />
	StrCmp		$0  0  ok<br />
	MessageBox	MB_OK|MB_ICONEXCLAMATION  &quot;Installer already running.&quot;<br />
	StrLen	$0  &quot;$(^Name)&quot;<br />
	loop:<br />
	FindWindow	$1  '#32770'  ''  0  $1<br />
	IntCmp	$1  0  ok<br />
	System::Call	&quot;user32.dll::GetWindowText(i r1, t .r2, i ${NSIS_MAX_STRLEN}) i.&quot;<br />
	StrCpy	$2  $1  $0<br />
	StrCmp	$2  &quot;$(^Name)&quot;  0  loop<br />
	System::call	&quot;user32::SetWindowPos(i r1, i -1, i 0, i 0, i 0, i 0, i 0x02|0x01) i.&quot;<br />
	Abort<br />
	ok:</div></div><hr />


<div class="post"><div class="posttop"><div class="username">externe</div><div class="date">18th November 2004, 17:41</div></div><div class="posttext">Well, I try a lot of time... But impossible to open MessageBox(s) with the name of the caption of each of window...<br />
:(</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>