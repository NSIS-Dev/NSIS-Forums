<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Inserting line halfway down an INI, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Inserting line halfway down an INI NSIS Discussion" />
	
	<title> Inserting line halfway down an INI [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Inserting line halfway down an INI</div>
<hr />
<div class="pda"><a href="t-301141.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=301141">Inserting line halfway down an INI</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">miguez</div><div class="date">17th December 2008, 04:31</div></div><div class="posttext">First post.<br />
<br />
I've done searches here and in the wiki, and asked questions (to no avail) in the IRC.<br />
<br />
First off, NSIS rocks!  I've been at it for a week now and I really like the scripting language, very simple yet powerful.<br />
<br />
My installer needs to open an existing INI file, search for a section, then add a new section immediately after that.  That means that everything else that already existed after the section I search for should be shifted down to make room for this new section.<br />
<br />
By using WriteINIStr I can add my section, but it shows at the end of the INI file.<br />
<br />
By using FileWrite I can add it where I want the section to be, but it overwrites the existing text from that point on.<br />
<br />
Can anyone help me with this?<br />
<br />
Thanks,</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comperio</div><div class="date">17th December 2008, 05:05</div></div><div class="posttext">An INI file doesn't have to be in any particular order since any INI file parser will find the proper section no matter where it lies in the file.  <br />
<br />
But, if you want to force it that way, here's a rough outline of what you might do: Make  copy of the file. (Use $PLUGINSDIR for this)<br />
 open the copy as read-only; open the real file in either append or write mode.<br />
 Read the copy and write to the real file line by line until you get to the point where you want to insert your section.<br />
 Write your new section to the file.<br />
 Continue then reading from the copy and writing to the real file.<br />
 Close both files and delete your copy.(All you really need to do with the steps above is get the section header in the right place.  Once you've done that, you can then use WriteINIStr for the rest of the data.)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">miguez</div><div class="date">20th December 2008, 00:29</div></div><div class="posttext">Comperio,<br />
<br />
This worked like a charm!  I first had to figure out how to copy a file, which I did with:<br />
<br />
Rename $AircraftCFG &quot;$PLUGINSDIR\aircraft.cfg&quot;<br />
<br />
Where aircraft.cfg is the file to be copied, the original residing in a variable $AircraftCFG, which holds a path.  As you can see, I followed your recommendation of copying it to the $PLUGINSDIR.<br />
<br />
Then I read through the copy line by line, writing to the original as I went, until I found the place to add the new text.  I added the new text, then resumed the writing of the original file.<br />
<br />
By the way, I agree with you, in an INI file the order or location of the sections does not matter.  In my case, though, the file is commonly edited by end users, so it needed to look tidy.<br />
<br />
Here's the final function code, if anyone is interested.  I am open to any suggestions on improving how I do this, as I am very far from being a good programmer.<br />
<br />
Oh, and for those doing about the same thing, don't forget to delete the copy of the INI file at the end!<br />
<br />
Function UpdateFSXINI<br />
Push $R0<br />
Push $R1<br />
Push $R2<br />
Push $R3<br />
Push $R4<br />
<br />
 StrCpy $AircraftCFG &quot;$INSTDIR\SimObjects\Airplanes\PMDG747-400\aircraft.cfg&quot;<br />
 Rename $AircraftCFG &quot;$PLUGINSDIR\aircraft.cfg&quot;<br />
 Call FindNumberPlanes<br />
 FileOpen $R0 $AircraftCFG a<br />
 FileOpen $R2 &quot;$PLUGINSDIR\aircraft.cfg&quot; r<br />
 StrCpy $FSXINIsearch &quot;[General]&quot;<br />
 Loop:<br />
  FileRead $R2 $R3<br />
  StrCpy $R4 $R3 9<br />
  StrCmp $R4 &quot;[General]&quot; +1 +2<br />
   Call AddFSXAoAAircraft<br />
  StrCmp $R3 &quot;&quot; +3 +1<br />
  FileWrite $R0 $R3<br />
  Goto Loop<br />
 FileClose $R0<br />
 FileClose $R2<br />
<br />
 Delete &quot;$PLUGINSDIR\aircraft.cfg&quot;<br />
 FlushINI &quot;$PLUGINSDIR\aircraft.cfg&quot;<br />
<br />
Pop $R4<br />
Pop $R3<br />
Pop $R2<br />
Pop $R1<br />
Pop $R0<br />
FunctionEnd<br />
<br />
Thanks for NSIS, and for all the help!!<br />
<br />
Best regards,</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>