<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Using external DLL's, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Using external DLL's NSIS Discussion" />
	
	<title> Using external DLL's [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Using external DLL's</div>
<hr />
<div class="pda"><a href="t-124306.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=124306">Using external DLL's</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">djc</div><div class="date">8th February 2003, 06:08</div></div><div class="posttext">I'm developing a Palm app &amp; conduit. As part of the installation, the conduit has to be 'registered' with the Palm Hotsync manager using functions in the palm supplied &quot;CondMgr.dll&quot;.<br />
<br />
How do I call/use functions in an external DLL? I've looked in the &quot;System.dll&quot; add on by brainsucker, but I'm not a Windows programmer and things aren't making much sense to me....<br />
<br />
All help/pointers/links gratefully accepted.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">8th February 2003, 12:40</div></div><div class="posttext">For this you will first have to know how exactly that function that you want to call was defined. If it's a regular registration function (DllRegisterServer) then you can just use RegDLL. If it's anything else you'll have to know the exact prototype (how the function was defined) and use System.dll to call it. If you get me the prototype I can help you write the line you need to use with System.dll.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">virtlink</div><div class="date">8th February 2003, 15:17</div></div><div class="posttext">KiCHiK, he's not a Windows programmer. With all you definition, regular registration and prototype talk, I think that you made him even more confused than he already is.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">8th February 2003, 15:54</div></div><div class="posttext">Virtlink, I think he can answer by himself... If he could have typed the first post he must have a keyboard or at least a voice recognition application and a microphone... ;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Sunjammer</div><div class="date">8th February 2003, 17:07</div></div><div class="posttext">To be fair KiCHiK not only posted helpful information but offered to help further if needed. I don't think there is a non techy answer to the original question so I think KiCHiK did the only thing anyone can for a non-programmer. I'm sure given more time KiCHiK would gladly write the solution to this particular problem but he can't do that *and* try to perfect NSIS *and* be a forum moderator all at the same time!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">8th February 2003, 17:21</div></div><div class="posttext">Thank you Sunjammer :D</div></div><hr />


<div class="post"><div class="posttop"><div class="username">djc</div><div class="date">8th February 2003, 22:43</div></div><div class="posttext">Hi kichik,<br />
<br />
According to the DLL doco, the function I need to us is defined as:<br />
<br />
int CmGetHotSyncExecPath(TCHAR *pPath, int *piSize);<br />
<br />
where<br />
pPath is a pointer to a character buffer. Upon return, this is the path &amp; file name of the installed HotSync manager.<br />
<br />
piSize is a pointer to an integer that specifies the size (in TCHAR's), of the buffer referenced by the pPath parameter. <br />
<br />
result: 0 if no error, else error value<br />
<br />
Thanks for the offer of help. Sorry to take so long to reply, but I'm in Australia and have only just got out of bed! As Sunjammer notes, there is probably no non-technical answer to this question. As I noted before, I'm not a Windows programmer (certainly not to this level) - embedded micro's are more my area.<br />
<br />
Thanks again for the assistance.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Sunjammer</div><div class="date">9th February 2003, 00:40</div></div><div class="posttext">Hmm I've just spent half an hour staring at System.txt, System.nsh,SysFunc.nsh and System.nsi. I feel like I'm soo close to being able to tell you how to use the System plugin to do this but I have to be honest, I can't quite work it out.<br />
<br />
If anyone else can help the point I got stuck on is this: the function populates a string, fair enough, so I use System::Alloc to alloc some space but then after the call when I've filled that space how on Earth do I get that string from the memory in the System plugin into an NSIS variable? (the variable populated by the System::Alloc call contains a pointer which is no use, I want a variable containing the string itself).<br />
<br />
The docs are, ahem, somewhat greek even to someone who regularly uses Windows API calls. It mostly makes sense, but I can't seem to find an example of how to deal with a function that populates a char array, all I can find is how to extract values from structures... so close and yet so far!<br />
<br />
I'm off to bed now, good luck!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">djc</div><div class="date">9th February 2003, 04:07</div></div><div class="posttext">Thanks for spending the time Sunjammer. I'm glad I'm not the only one who finds the System plugin doco a bit cryptic.<br />
<br />
Hopefully someone else has had to do this and can pass on their knowledge....</div></div><hr />


<div class="post"><div class="posttop"><div class="username">virtlink</div><div class="date">9th February 2003, 09:42</div></div><div class="posttext">Everyone has problems with that cryptic documentation, so flizebogen and Dark_boy are going to rewrite the documentation and I (propably some others also) will help.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Sunjammer</div><div class="date">9th February 2003, 09:49</div></div><div class="posttext">If I understand you correctly virtlink then it's great that not only the core NSIS documentation will be revised but also that of the plugins, especially System! :D</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">9th February 2003, 14:26</div></div><div class="posttext">Sunjammer, you are dreaming. The only one that can rewrite that readme is Brainsucker himself :p<br />
<br />
Anyway, back to the original subject... I know Sunjammer has already sent you a little DLL that does this but I still had to give it a go :D<br />
<br />
Try:<br />
SetOutPath &quot;C:\\Palm\\DLL\\Path&quot;<br />
StrCpy $1 ${NSIS_MAX_STRLEN}<br />
System::Call 'dll_name::CmGetHotSyncExecPath(t, *i) i(.r0, .r1).r2'<br />
DetailPrint 'Path: &quot;$0&quot;'<br />
DetailPrint &quot;Path length (I think): $1&quot;<br />
DetailPrint &quot;Return value: $2&quot;<br />
<br />
Use this with the latest CVS version and it should work. Even if Sunjammer's DLL worked, please try this, I am curious :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Sunjammer</div><div class="date">9th February 2003, 15:36</div></div><div class="posttext">I think you're being optimistic KiCHiK, theoretically my DLL should work but whether or not I got it right first time who knows... then again theoretically it should be easily done using System too :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">9th February 2003, 15:53</div></div><div class="posttext">Optimisem rocks! :p<br />
You'll see... One day, I am telling you! One day I will know how to use System.dll! :D</div></div><hr />


<div class="post"><div class="posttop"><div class="username">djc</div><div class="date">10th February 2003, 05:05</div></div><div class="posttext">OK, I tried kichik's code, using the latest CVS Zip file from Sourceforge. Unfortunately, no go. My code:<br />
<br />
<br />
  SetOutPath $TEMP\eInspect             ; create temp directory<br />
  File bin\CondMgr.dll                  ; copy dll there<br />
  <br />
  StrCpy $1 &quot; &quot; 1024<br />
  System::Call 'CondMgr::CmGetHotSyncExecPath(t, *i) i(.r0, .r1).r2'<br />
  DetailPrint 'Path: &quot;$0&quot;'<br />
  DetailPrint &quot;Path length (I think): $1&quot;<br />
  DetailPrint &quot;Return value: $2&quot;<br />
<br />
<br />
and the results:<br />
<br />
<br />
Output folder: c:\windows\TEMP\eInspect<br />
Extract: CondMgr.dll<br />
Path: &quot;&quot;<br />
Path length (I think): 25<br />
Return value: -1010<br />
<br />
<br />
Do I have to use &quot;RegDll&quot; before I can run this code?<br />
<br />
I've attached a zipped version of the DLL in question.<br />
<br />
Another question:<br />
Can you please explain the syntax in the System::Call command you are using?<br />
<br />
<br />
System::Call 'CondMgr::CmGetHotSyncExecPath(t, *i) i(.r0, .r1).r2'<br />
<br />
<br />
My understanding is:<br />
'CondMgr::CmGetHotSyncExecPath(t, *i) i'  is the call to the function where t is a text string, *i is a pointer to an integer and i is an integer return value.<br />
I also understand that r0, r1 &amp; r2 map to the NSIS variables $0, $1, $2 respectively.<br />
What do the '.' (dots) signify? And why is the variable list presented after the function definition?<br />
<br />
Thanks for the assistance.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">10th February 2003, 13:27</div></div><div class="posttext">It should be:<br />
StrCpy $1 1024<br />
not:<br />
StrCpy $1 &quot; &quot; 1024<br />
<br />
Your code copied the first 1024 chars of the string &quot; &quot;. I will try this myself too now that I have the DLL, and let you know.<br />
<br />
It will also be better if you use ${NSIS_MAX_STRLEN} instead of 1024, so you can be sure it's the right number.<br />
<br />
Now, for the command itself:<br />
'CondMgr::CmGetHotSyncExecPath(t, *i) i' is indeed the prototype of the function. The last 'i' is the return type. The second list is the actualy parameters that are passed on. The dot &quot;makes no change to source&quot;. I have no idea why we need this, but it worked with wsprintf this way. I have tried this DLL on my computer with HotSync running but it returned error -1010 yet again. Can you please find out what that error means from this DLL's docs?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Sunjammer</div><div class="date">10th February 2003, 14:04</div></div><div class="posttext">KiCHiK, what does System do about calling conventions? Windows API calls are __stdcall but I have a feeling this dll is __cdecl.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">10th February 2003, 14:45</div></div><div class="posttext">Nope Sunjammer, __stdcall. Just checked that with VC. Can't get it to work with VC either though =/<br />
It returns 0, 1 in the int pointer and nothing in the path.<br />
<br />
Try this one please:<br />
System::Call 'CondMgr::CmGetHotSyncExecPath(t, *i) i(.r0, r1).r2'</div></div><hr />


<div class="post"><div class="posttop"><div class="username">djc</div><div class="date">10th February 2003, 21:17</div></div><div class="posttext">Morning All.<br />
<br />
kichik, I tried the code<br />
StrCpy $1 1024<br />
and my compiler barfed. I'll try to check out the latest CVS build again this morning and try the code again.<br />
<br />
Error codes from this function:<br />
<br />
0: No error<br />
-1: A non-specific error occurred<br />
ERR_REGISTRY_ACCESS(-1006):Unable to access the Palm configuration entries<br />
ERR_BUFFER_TOO_SMALL(-1010): The buffer is too small to hold the requested information<br />
ERR_INVALID_POINTER(-1013):The specified pointer is not a valid pointer<br />
<br />
Also, if the buffer is too small the value in *int is the size (in TCHARs) that the buffer should be.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">djc</div><div class="date">10th February 2003, 21:21</div></div><div class="posttext">YeeHa!<br />
<br />
We're away. Tried the latest mods that kichik suggested (i.e. remove the '.' from the pointer variable) and we're up.<br />
<br />
<br />
Calling loadDll<br />
Output folder: c:\windows\TEMP\eInspect<br />
Extract: CondMgr.dll<br />
Path: &quot;C:\Dave\palm\Hotsync.exe&quot;<br />
Path length (I think): 1024<br />
Return value: 0<br />
<br />
<br />
Sunjammer: I'll try your DLL as well after breakfast.<br />
<br />
Thanks **VERY** much everyone for the assistance, and for the excellent installer package.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Sunjammer</div><div class="date">10th February 2003, 21:39</div></div><div class="posttext">DJC: Don't bother with the DLL, system is a much better solution.<br />
<br />
Could you do me a real favour please, pretty please :) Could you create a page in the Archive showing how to call your DLL function using System. It doesn't matter that others don't have your DLL, it shows a use of System that had to be figured out and that's worth showing to others.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">djc</div><div class="date">11th February 2003, 00:55</div></div><div class="posttext">Sunjammer: I've posted up an example in the Archive as you suggested. See<br />
<br />
'Calling an external DLL using the System.dll plugin'<br />
<br />
in the examples section.<br />
<br />
Thanks everyone for your assistance anf forebearance.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">11th February 2003, 15:09</div></div><div class="posttext">Told you optimisem rocks :D</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>