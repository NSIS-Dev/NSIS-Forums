<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Get # of cores AND logical processors, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Get # of cores AND logical processors NSIS Discussion" />
	
	<title> Get # of cores AND logical processors [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Get # of cores AND logical processors</div>
<hr />
<div class="pda"><a href="t-321596.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=321596">Get # of cores AND logical processors</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">redxii</div><div class="date">12th August 2010, 08:46</div></div><div class="posttext">This is probably what I am looking for: http://msdn.microsoft.com/en-us/library/ms683194.aspx<br />
<br />
This is actually way over my head, I don't understand a damn thing about using System plug-in even after reading the readme. I want to get the number of cores when hyperthreading is involved. It should say I have 2 cores/processors and not 4.<br />
<br />
CPUDesc was last compiled in 2003, and it's not unicode.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">12th August 2010, 09:27</div></div><div class="posttext">(You can use the CallAnsiPlugin plug-in to execute ansi plugins on unicode NSIS.)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">redxii</div><div class="date">12th August 2010, 18:24</div></div><div class="posttext">Well, it also counts hyperthreading as a cpu.. even Atom processors are hyperthreaded.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">f0rt</div><div class="date">13th August 2010, 17:28</div></div><div class="posttext">I took the challenge and came up with the following script.<br />
<br />
<br />
OutFile &quot;cpuinfo.exe&quot;<br />
<br />
!include &quot;LogicLib.nsh&quot;<br />
<br />
!define FALSE                     0 <br />
!define TRUE                      1<br />
<br />
!define ERROR_INSUFFICIENT_BUFFER 122<br />
<br />
; Size of SYSTEM_LOGICAL_PROCESSOR_INFORMATION on 32-bit systems<br />
!define SYS_LOG_PROC_INFO_SIZE    24<br />
; Offset of Relationship in the SYSTEM_LOGICAL_PROCESSOR_INFORMATION structure<br />
!define RELATIONSHIP_OFFSET       4<br />
; Enum value of Relationship identifying Processor Core<br />
!define RELATIONPROCESSORCORE     0<br />
<br />
; Count the number of bits set in given value<br />
; Parameters: value<br />
; Returns: number of bits set in given value<br />
Function countbits<br />
   Exch $0<br />
   Push $1<br />
   Push $2<br />
<br />
   ; Set initial value for number of bits set in $0<br />
   StrCpy $1 0<br />
<br />
   ${While} $0 &gt; 0<br />
      ; Clear least significant bit set<br />
      IntOp $2 $0 - 1<br />
      IntOp $0 $0 &amp; $2<br />
      ; Increment number of bits set<br />
      IntOp $1 $1 + 1<br />
   ${EndWhile}<br />
<br />
   ; Return number of bits set<br />
   StrCpy $0 $1<br />
<br />
   Pop $2<br />
   Pop $1<br />
   Exch $0<br />
FunctionEnd<br />
<br />
; Evaluate processor information<br />
; Paramaters: buffer, length<br />
; Returns: number of cores<br />
Function evalcpuinfo<br />
   Exch $0 ; length<br />
   Exch<br />
   Exch $1 ; buffer<br />
   Push $2<br />
   Push $3<br />
   Push $4<br />
   Push $5 ; Processor Cores<br />
   Push $6 ; Logical Processors<br />
<br />
   ; Set buffer offset at the end of the buffer<br />
   StrCpy $2 $0<br />
<br />
   ; Initialize number of Processor Cores and Logical Processors<br />
   StrCpy $5 0<br />
   StrCpy $6 0<br />
<br />
   ; Iterate through buffer starting from end<br />
   ${While} $2 &gt;= ${SYS_LOG_PROC_INFO_SIZE}<br />
       ; Calculate start address of an element<br />
       IntOp $2 $2 - ${SYS_LOG_PROC_INFO_SIZE}<br />
       IntOp $3 $1 + $2<br />
       ; Get ProcessorMask value from element<br />
       System::Call &quot;*$3(i.r4)&quot;<br />
       Push $4<br />
       IntOp $3 $3 + ${RELATIONSHIP_OFFSET}<br />
       ; Get Relationship value from element<br />
       System::Call &quot;*$3(i.r4)&quot;<br />
       ${If} $4 == ${RELATIONPROCESSORCORE}<br />
           ; Increment Processor cores<br />
           IntOp $5 $5 + 1<br />
           ; Determine number of Logical Processor by counting the bits<br />
           ; set in the value of ProcessorMask<br />
           Call countbits<br />
           Pop $4<br />
           ; Sum up Logical Processors<br />
           IntOp $6 $6 + $4<br />
       ${Else}<br />
           Pop $4<br />
       ${EndIf}<br />
   ${EndWhile}<br />
 <br />
   ; Set processor information as return value<br />
   StrCpy $0 &quot;Processor Core(s): $5 Logical Processor(s): $6&quot;<br />
 <br />
   Pop $6<br />
   Pop $5<br />
   Pop $4<br />
   Pop $3<br />
   Pop $2<br />
   Pop $1<br />
   Exch $0<br />
FunctionEnd<br />
<br />
; Get processor information<br />
; Returns: number of Processor Cores and Logical Processors<br />
Function getcpuinfo<br />
  Push $0<br />
  Push $1<br />
  Push $2<br />
  Push $3<br />
  Push $4<br />
<br />
  ; GetLogicalProcessorInformation is only available on <br />
  ; Windows XP SP3 or its successors.<br />
<br />
  ; Initialize buffer and its length<br />
  StrCpy $1 0<br />
  StrCpy $2 0<br />
<br />
  ; Determine required length of buffer<br />
  System::Call &quot;kernel32::GetLogicalProcessorInformation(ir1, *ir2r2) i.r3 ? e&quot;<br />
  Pop $4<br />
  ${If} $3 == ${FALSE}<br />
     ${If} $4 == ${ERROR_INSUFFICIENT_BUFFER}<br />
         ; Allocate buffer<br />
         System::Alloc $2<br />
         Pop $1<br />
         ${If} $1 != 0<br />
             ; Get processor information<br />
             System::Call &quot;kernel32::GetLogicalProcessorInformation(ir1, *ir2r2) i.r3 ? e&quot;<br />
             Pop $4<br />
             ${If} $3 != ${TRUE}<br />
                 StrCpy $0 &quot;Error: $4&quot;<br />
             ${Else}<br />
                 Push $1 ; buffer<br />
                 Push $2 ; length<br />
                 Call evalcpuinfo<br />
                 Pop $0<br />
             ${EndIf}<br />
             ; Deallocate buffer<br />
             System::Free $1<br />
         ${Else}<br />
             StrCpy $0 &quot;Error: memory allocation failed!&quot;<br />
         ${EndIf}<br />
     ${Else}<br />
         StrCpy $0 &quot;Error: $4&quot;<br />
     ${EndIf}<br />
  ${Else}<br />
     StrCpy $0 &quot;GetLogicalProcessorInformation is not available on your system!&quot;<br />
  ${EndIf}<br />
  <br />
  Pop $4<br />
  Pop $3<br />
  Pop $2<br />
  Pop $1<br />
  Exch $0<br />
FunctionEnd<br />
<br />
Function .onInit<br />
  InitPluginsDir<br />
  Call getcpuinfo<br />
  Pop $0<br />
  MessageBox MB_OK &quot;$0&quot;<br />
  Quit<br />
FunctionEnd<br />
<br />
Section <br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">redxii</div><div class="date">13th August 2010, 20:29</div></div><div class="posttext">Works for me, 64-bit Win 7, reports 2 cores/4 logical . Anyone else want to test it out?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">redxii</div><div class="date">13th August 2010, 23:12</div></div><div class="posttext">I tried on my AMD Turion X2 laptop and it reported correctly, and had someone test his and it reported correctly on his Core i7.<br />
<br />
You should wiki it since I am sure other people will find it of use.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">14th August 2010, 08:33</div></div><div class="posttext">&quot;Processor core(s): 1 Logical Processor(s): 2&quot; for my C2D E6750 on Windows Server 2003 SP2 (actual OS).<br />
&quot;GetLogicalProcessorInformation is not available on your system!&quot; for same CPU on Windows 98 SE virtual machine.<br />
&quot;GetLogicalProcessorInformation is not available on your system!&quot; for same CPU on Windows 2000 pro VM. (Is there an alternative here?)<br />
&quot;Processor core(s): 2 Logical Processor(s): 2&quot; for same CPU on Windows Vista VM.<br />
&quot;Processor core(s): 2 Logical Processor(s): 2&quot; for same CPU on Windows 7 pro x64 VM.<br />
&quot;Processor core(s): 2 Logical Processor(s): 2&quot; for same CPU on Windows XP pro x64 VM.<br />
<br />
VMs are run on VMWare Workstation. Obviously there are still some kinks that need to be solved, but the help on the SYSTEM_LOGICAL_PROCESSOR_INFORMATION struct is rather confusing... If I'm reading it correctly, Windows Server 2003 and Windows XP Professional x64 Edition should both return the same thing. So maybe it's VMWare that's simulating the two C2D cores as two physical CPUs?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">redxii</div><div class="date">14th August 2010, 08:53</div></div><div class="posttext">Using unicode anyway, Win 2000 users in this particular application is a very very small minority, the market share of Win 2000 isn't even half a percent. The particular program being packaged does not support 9x/ME/NT.<br />
<br />
Every system I tested had Win 7 64-bit.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>