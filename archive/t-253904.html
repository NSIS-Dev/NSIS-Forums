<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" IsUserAdmin?, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  IsUserAdmin? NSIS Discussion" />
	
	<title> IsUserAdmin? [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  IsUserAdmin?</div>
<hr />
<div class="pda"><a href="t-253904.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=253904">IsUserAdmin?</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">23rd August 2006, 09:51</div></div><div class="posttext">I have seen similar functionality in a plugin and I wanted to achieve the same using the system plugin, thus trimming down the size of my installer a bit. It turned out to be quite easy :)<br />
<br />
The following code uses the CheckTokenMembership (http://msdn.microsoft.com/library/default.asp?url=/library/en-us/secauthz/security/checktokenmembership.asp) function of advapi32.dll, works in NT/2k/XP etc and it returns 1 if the user belongs to the administrator's group, 0 if not and -1 if an error occurs:!macro IsUserAdmin RESULT<br />
 !define Index &quot;Line${__LINE__}&quot;<br />
   StrCpy ${RESULT} 0<br />
   System::Call '*(&amp;i1 0,&amp;i4 0,&amp;i1 5)i.r0'<br />
   System::Call 'advapi32::AllocateAndInitializeSid(i r0,i 2,i 32,i 544,i 0,i 0,i 0,i 0,i 0,i 0,*i .R0)i.r5'<br />
   System::Free $0<br />
   System::Call 'advapi32::CheckTokenMembership(i n,i R0,*i .R1)i.r5'<br />
   StrCmp $5 0 ${Index}_Error<br />
   StrCpy ${RESULT} $R1<br />
   Goto ${Index}_End<br />
 ${Index}_Error:<br />
   StrCpy ${RESULT} -1<br />
 ${Index}_End:<br />
   System::Call 'advapi32::FreeSid(i R0)i.r5'<br />
 !undef Index<br />
!macroend<br />
Usage:...<br />
!insertmacro IsUserAdmin $1<br />
; $1 = 1 true<br />
; $1 = 0 false<br />
; $1 = -1 there was an error<br />
...<br />
I hope this is useful for others as well :)<br />
CF</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">25th August 2006, 12:44</div></div><div class="posttext">CheckTokenMembership is a nice little useful function, but sadly it's not available on NT. You should use a different method, if you intend to support NT.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">26th August 2006, 12:10</div></div><div class="posttext">Good point kichik, thanks for pointing that out :o<br />
<br />
Using the IsAdministrator functionality from the XtInfoPlugin (http://nsis.sourceforge.net/XtInfoPlugin_plug-in) plugin I wrote the following code which uses the system plugin:!define TOKEN_READ   0x00020008<br />
!define TokenGroups  2<br />
<br />
!macro IsUserAdmin RESULT<br />
 !define Index &quot;Line${__LINE__}&quot;<br />
 StrCpy ${RESULT} 0<br />
<br />
 # Construct the SID for the Admin group - Should get S-1-5-32-544 for administrators (place it in $R4)<br />
  System::Call &quot;*(&amp;i1 0,&amp;i4 0,&amp;i1 5)i.r0&quot;<br />
  System::Call  &quot;advapi32::AllocateAndInitializeSid(i r0,i 2,i 32,i 544,i 0,i 0,i 0,i 0,i 0,i 0,*i .R4)i.r5&quot;<br />
  System::Free $0<br />
<br />
 # Get a psuedo-handle of the current process and place it on R0<br />
  System::Call 'kernel32::GetCurrentProcess()i.R0'<br />
<br />
 # Open the Token from the psuedo process and place the handle on R1<br />
  System::Call 'advapi32::OpenProcessToken(i R0,i ${TOKEN_READ},*i .R1)i.R9'<br />
<br />
 # Get info from the token and place it in $R2 (the size goes to $R3)<br />
  System::Call 'advapi32::GetTokenInformation(i R1,i ${TokenGroups},*i .R2,i 0,*i .R3)i.R9'<br />
  System::Alloc $R3<br />
   Pop $R2<br />
  System::Call 'advapi32::GetTokenInformation(i R1,i ${TokenGroups},i R2,i $R3,*i .R3)i.R9'<br />
<br />
 # Check how many TOKEN_GROUPS elements are in $R2 (place the number in $R5)<br />
  System::Call '*$R2(i.R5,i.R6)'<br />
<br />
 # Compare the SID structures<br />
  StrCpy $1 0<br />
	<br />
 ${Index}_Start:<br />
  StrCmp $1 $R5 ${Index}_Stop<br />
  System::Call 'advapi32::EqualSid(i R4,i R6)i.R9'<br />
  StrCmp $R9 &quot;&quot; ${Index}_Increment<br />
  StrCmp $R9 0 +1 +3<br />
  StrCpy ${RESULT} 0<br />
   Goto ${Index}_Increment<br />
  StrCpy ${RESULT} 1<br />
  System::Call 'advapi32::FreeSid(i R6)i.R8'<br />
   Goto ${Index}_Stop<br />
 ${Index}_Increment:<br />
  System::Call 'advapi32::GetLengthSid(i R6)i.R9'<br />
  System::Call 'advapi32::FreeSid(i R6)i.R8'<br />
  IntOp $R6 $R6 + $R9<br />
  IntOp $1 $1 + 1<br />
  Goto ${Index}_Start<br />
<br />
 ${Index}_Stop:<br />
 # Close the token handle<br />
  System::Call 'kernel32::CloseHandle(i R1)i.R9'<br />
<br />
 # cleanup<br />
  System::Call 'advapi32::FreeSid(i R4)i.r5'<br />
  System::Free $R2<br />
  System::Free 0<br />
<br />
 !undef Index<br />
!macroend<br />
It can be used as the previous macro:...<br />
!insertmacro IsUserAdmin $1<br />
 ; $1 = 1 true<br />
 ; $1 = 0 false<br />
...<br />
The above code should be compatible with NT as well.<br />
I didn't add any error checking though for this one ...<br />
CF</div></div><hr />


<div class="post"><div class="posttop"><div class="username">vadzen</div><div class="date">23rd October 2006, 12:33</div></div><div class="posttext">Hi CancerFace,<br />
<br />
I tried use this macro, but I have as result blank value.<br />
Would you be able to check this code and give your advise.<br />
Thanks.<br />
<br />
Macro file is:<br />
<br />
!macro IsUserAdmin RESULT<br />
 !define Index &quot;Line${__LINE__}&quot;<br />
   StrCpy ${RESULT} 0<br />
   System::Call '*(&amp;i1 0,&amp;i4 0,&amp;i1 5)i.r0'<br />
   System::Call 'advapi32::AllocateAndInitializeSid(i r0,i 2,i 32,i 544,i 0,i 0,i 0,i 0,i 0, \<br />
   i 0,*i .R0)i.r5'<br />
   System::Free $0<br />
   System::Call 'advapi32::CheckTokenMembership(i n,i R0,*i .R1)i.r5'<br />
   StrCmp $5 0 ${Index}_Error<br />
   StrCpy ${RESULT} $R1<br />
   Goto ${Index}_End<br />
 ${Index}_Error:<br />
   StrCpy ${RESULT} -1<br />
 ${Index}_End:<br />
   System::Call 'advapi32::FreeSid(i R0)i.r5'<br />
 !undef Index<br />
!macroend<br />
<br />
<br />
Script is:<br />
<br />
var tmp1<br />
!include folderpath\include\IsCurrentUserAdmin.nsh<br />
<br />
 !insertmacro WriteLog &quot;Check current user permissions&quot; &quot;$log_name.log&quot;<br />
 StrCpy $tmp1 &quot;-2&quot;<br />
 ClearErrors<br />
 DetailPrint &quot;current user permissions IS:  $tmp1&quot;<br />
 Sleep 2000<br />
 !insertmacro WriteLog &quot;current user permissions IS:  $tmp1&quot; &quot;$log_name.log&quot;<br />
 Sleep 2000<br />
  <br />
 !insertmacro IsUserAdmin $tmp1<br />
 Pop $tmp1<br />
;  ${If} $tmp1 = &quot;1&quot;<br />
;  Goto CurrentUserIsAdmin<br />
;  ${EndIf}<br />
  !insertmacro WriteLog &quot;current user permissions IS:  $tmp1&quot; &quot;$log_name.log&quot;<br />
  DetailPrint &quot;current user permissions IS:  $tmp1&quot;<br />
  Sleep 2000<br />
<br />
<br />
Result in log file is:<br />
<br />
23/10/2006 (Monday) 11:53:31<br />
Check current user permissions<br />
23/10/2006 (Monday) 11:53:33<br />
current user permissions IS:  -2<br />
23/10/2006 (Monday) 11:53:35<br />
current user permissions IS:</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">23rd October 2006, 12:40</div></div><div class="posttext">No need to use Pop $tmp1 after calling the macro...<br />
Could it be that your stack has -2 on the top and you are popping it into your variable?<br />
CF<br />
<br />
<br />
PS Looking at this again, you define $tmp1 as -2, then you pass it to the macro (which should set $tmp1 to 0, 1 or -1, and then you Pop the top of the stack to $tmp1 (not sure why you do that) ...<br />
<br />
Where are you defining $tmp1? Is your var $tmp1 statement inside a function/section? If yes then you should either use var /GLOBAL or define it beforeyour sections...<br />
<br />
Also I hope that you are running the above macro in Win2k/XP/2k3 and [u]not[/i] 9x/NT (check the rest of the thread)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">23rd October 2006, 15:12</div></div><div class="posttext">I also forgot to mention that I have added a wiki (http://nsis.sourceforge.net/Check_if_the_current_user_is_an_Administrator) page for these macros ...<br />
CF</div></div><hr />


<div class="post"><div class="posttop"><div class="username">vadzen</div><div class="date">24th October 2006, 10:33</div></div><div class="posttext">Thanks a lot!<br />
<br />
I remarked Pop $tmp1 after !insertmacro and I had correct value for $tmp1.<br />
<br />
Would you be able to help check my logic?<br />
<br />
 !insertmacro IsUserAdmin $tmp1<br />
; Pop $tmp1<br />
;  ${If} $tmp1 = &quot;1&quot;<br />
;  Goto CurrentUserIsAdmin<br />
;  ${EndIf}<br />
  !insertmacro WriteLog &quot;current user permissions IS:  $tmp1&quot; &quot;$log_name.log&quot;<br />
  DetailPrint &quot;current user permissions IS:  $tmp1&quot;<br />
  <br />
 !if $tmp1 &lt; 0<br />
  !insertmacro WriteLog &quot;Can not check current user permissions&quot; &quot;$log_name.log&quot;<br />
  DetailPrint &quot;Can not check current user permissions.&quot;<br />
  Sleep 1000<br />
!else <br />
 !if  $tmp1 &gt; 0<br />
  !insertmacro WriteLog &quot;Current user has Administrator permissions&quot; &quot;$log_name.log&quot;<br />
  DetailPrint &quot;Current user has Administrator permissions.&quot;<br />
  Sleep 1000<br />
 !else<br />
  !insertmacro WriteLog &quot;Current user has NOT Administrator permissions&quot; &quot;$log_name.log&quot;<br />
  DetailPrint &quot;Current user has NOT Administrator permissions.&quot;<br />
  Sleep 1000<br />
 !endif<br />
!endif<br />
<br />
 !insertmacro WriteLog &quot;current user permissions IS:  $tmp1&quot; &quot;$log_name.log&quot;<br />
 Sleep 1000<br />
    Quit<br />
<br />
<br />
Log file is:<br />
<br />
24/10/2006 (Tuesday) 10:20:51<br />
current user permissions IS:  1<br />
24/10/2006 (Tuesday) 10:20:51<br />
Current user has NOT Administrator permissions<br />
24/10/2006 (Tuesday) 10:20:53<br />
current user permissions IS:  1<br />
<br />
<br />
P.S. I found yours macro in NSIS wiki - THANKS.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">vadzen</div><div class="date">24th October 2006, 19:13</div></div><div class="posttext">Sorry for question, I found logic solution:<br />
<br />
var tmp1<br />
!include LogicLib.nsh<br />
<br />
!insertmacro IsUserAdmin $tmp1<br />
<br />
${If} $tmp1 == 1<br />
  !insertmacro WriteLog &quot;Current user has Administrator permissions&quot; &quot;$log_name.log&quot;<br />
  SetDetailsPrint textonly<br />
  DetailPrint &quot;Current user has Administrator permissions.&quot;<br />
  Sleep 1000<br />
${Else}<br />
  ${If} $tmp1 == 0<br />
  !insertmacro WriteLog &quot;Current user has NOT Administrator permissions&quot; &quot;$log_name.log&quot;<br />
  SetDetailsPrint textonly<br />
  DetailPrint &quot;Current user has NOT Administrator permissions.&quot;<br />
  Sleep 1000<br />
  ${Else}<br />
   !insertmacro WriteLog &quot;Can not check current user permissions&quot; &quot;$log_name.log&quot;<br />
   Goto End_Failed<br />
  ${EndIf}<br />
${EndIf}<br />
<br />
Thanks a lot</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>