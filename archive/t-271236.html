<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Vista: Exec does not work as in XP, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Vista: Exec does not work as in XP NSIS Discussion" />
	
	<title> Vista: Exec does not work as in XP [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Vista: Exec does not work as in XP</div>
<hr />
<div class="pda"><a href="t-271236.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=271236">Vista: Exec does not work as in XP</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">16th May 2007, 12:01</div></div><div class="posttext">This is no Vista privilege / UAC problem (see other thread if you have your software run in &quot;wrong&quot; virtualisation/elevation mode).<br />
<br />
I have some mode where the installer copies itself to TMP and runs from there. This works in XP but not in Vista (tested with UAC on).<br />
<br />
The problem is that the temporary file's name does not end with &quot;.exe&quot;. So <br />
<br />
Exec '&quot;C:\temp\mytmpfile.tmp&quot; /OPTIONS'<br />
<br />
does not execute. You will get a warning saying &quot;.tmp&quot; is not associated.<br />
<br />
With XP this works without problems.<br />
<br />
I know the CreateProcess API and I guess NSIS' Exec just lets the application parameter empty and supplies the exec-string above as &quot;parameter&quot; which generally works fine.<br />
Furthermore I guess it would be ok to pass the executable file to the first parameter (application). Perhaps XP is here somewhat fuzzy to always assume the first parameter is an executable. So if I'm right the change in Vista seems to make it cleaner.<br />
<br />
I personally will check these two options for my installer:<br />
- get a temp name which ends in &quot;.exe&quot;<br />
- use own CreateProcess call using the tmp name as application parameter.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">16th May 2007, 13:10</div></div><div class="posttext">CreateProcess(&quot;c:\temp\mytmpfile.tmp&quot;, &quot;/OPTIONS&quot;, ...) does not work.<br />
<br />
This leads to some feature request in NSIS: Please add an option for setting the extension for GetTempFilename.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">16th May 2007, 13:25</div></div><div class="posttext">solution:<br />
<br />
<br />
; ################################################################<br />
; get temporary filename with a specific extension<br />
; Usage: !insertmacro GetTempFile &quot;exe&quot;<br />
;        Pop $0<br />
!macro GetTempFile EXTENSION<br />
  ; USE ON YOUR OWN RISK! Please report bugs here: http://stefan.bertels.org/<br />
  !define Index_GetTempFile 'GetTempFile_${__LINE__}'<br />
  Push $0 ; result (bla.tmp_0.EXTENSION)<br />
  Push $1 ; filename bla.tmp (GetTempFilename result)<br />
  Push $2 ; extension<br />
  Push $3 ; counter<br />
  <br />
  StrCpy $2 &quot;${EXTENSION}&quot;<br />
  StrCpy $3 0<br />
<br />
${Index_GetTempFile}-loop:<br />
  GetTempFilename $1<br />
  StrCpy $0 &quot;$1_$3.$2&quot;<br />
  IfFileExists $0 0 ${Index_GetTempFile}-finished<br />
  Delete $1<br />
  IntOp $3 $3 + 1<br />
  Goto ${Index_GetTempFile}-loop<br />
  <br />
${Index_GetTempFile}-finished:<br />
  Pop $3<br />
  Pop $2<br />
  Pop $1<br />
  Exch $0<br />
  !undef Index_GetTempFile<br />
!macroend</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">16th May 2007, 17:10</div></div><div class="posttext">Can't you convert that to a Function instead?<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">16th May 2007, 17:44</div></div><div class="posttext">I personally try to make helpers as macro. This makes including it very easy (for installers and uninstallers). I personnally do not like the combined approach (like FileFunc and LogicLib).<br />
<br />
But of course you're free to do this. ;-)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">17th May 2007, 12:08</div></div><div class="posttext">Do you even need an internal counter? GetTempFileName already has one.<br />
<br />
GetTempFileName $R0<br />
Rename $R0 $R0.ext<br />
StrCpy $R0 $R0.ext<br />
<br />
This works under any number of tries (the file name is unique.)<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">20th May 2007, 20:12</div></div><div class="posttext">I think the macro counter is correct because you cannot be sure that NEWFILE.ext is a new file, too.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">20th May 2007, 20:37</div></div><div class="posttext">I did 10000 tests and the file names were all unique (10000 ns*.tmp files were present in the temp folder).<br />
Not sure exactly how GetTempFileName works internally, so maybe kichik can shed some light on this.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">21st May 2007, 08:12</div></div><div class="posttext">Of course the file names will be unique, that's what GetTempFileName does.<br />
<br />
We do not have to know how GetTempFileName really works (you can find details in MSDN) but we should just rely on the fact that GetTempFileName creates a NEW file (not existing before). Microsoft may change the way the function works at random.<br />
<br />
If GetTempFileName would never try to create the same filename again we could use its internal counter. If it just checks for existence we could not remove a tmp file before getting what we want (filling up the tmp dir). Of course in practise this will work anyway. But then we just could use &quot;mypersonaltmp.exe&quot; or something like that (fixed string).<br />
<br />
Anyway we have to run a loop and check for existence of NEWFILE.ext because GetTempFileName will only guarantee that NEWFILE is a new file (without custom extension, e.g. &quot;exe&quot;).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">21st May 2007, 09:28</div></div><div class="posttext">This was the code I used:<br />
<br />
Loop:<br />
IntOp $R1 $R1 + 1<br />
GetTempFileName $R0<br />
Rename $R0 $R0.ext<br />
StrCpy $R0 $R0.ext<br />
DetailPrint $R0<br />
StrCmp $R1 10000 0 Loop<br />
<br />
It still created 10000 unique files with the .ext file extension.<br />
<br />
Either way, here is the code I made before I did the tests.<br />
<br />
!macro GetTempFileNameExt Ext Var<br />
Push `${Ext}`<br />
  Call GetTempFileNameExt<br />
Pop ${Var}<br />
!macroend<br />
<br />
Function GetTempFileNameExt<br />
Exch $R0<br />
Push $R1<br />
Push $R2<br />
<br />
  StrCpy $R2 0<br />
  GetTempFileName $R1<br />
  IntOp $R2 $R2 + 1<br />
  IfFileExists $R1$R2.$R0 -2<br />
<br />
  SetDetailsPrint none<br />
  Rename $R1 $R1$R2.$R0<br />
  SetDetailsPrint both<br />
  StrCpy $R0 $R1$R2.$R0<br />
<br />
Pop $R2<br />
Pop $R1<br />
Exch $R0<br />
FunctionEnd<br />
<br />
<br />
!insertmacro GetTempFileNameExt exe $R0<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">21st May 2007, 10:01</div></div><div class="posttext">Using your short code (gettempfilename, rename, strcpy) will cause problems if the file NEWFILE.ext already exists. You cannot be sure this is the fact without testing it yourself. This is what GetTempFileName is for...<br />
<br />
Your GetTempFileNameExt function/macro is more suitable but has the problem of not deleting files in the loop. And there is a theoretical chance of a race condition.<br />
<br />
My code had a bug, too: The file is not renamed so the filename is not &quot;locked&quot;. Here's the fixed code which should work perfectly:<br />
<br />
<br />
; ################################################################<br />
; get temporary filename with a specific extension<br />
; Usage: !insertmacro GetTempFile &quot;exe&quot;<br />
;        Pop $0<br />
!macro GetTempFile EXTENSION<br />
  ; USE ON YOUR OWN RISK! Please report bugs here: http://stefan.bertels.org/<br />
  !define Index_GetTempFile 'GetTempFile_${__LINE__}'<br />
  Push $0 ; result (bla.tmp_0.EXTENSION)<br />
  Push $1 ; filename bla.tmp (GetTempFilename result)<br />
  Push $2 ; extension<br />
  Push $3 ; counter<br />
  <br />
  StrCpy $2 &quot;${EXTENSION}&quot;<br />
  StrCpy $3 0<br />
<br />
${Index_GetTempFile}-loop:<br />
  GetTempFilename $1<br />
  StrCpy $0 &quot;$1_$3.$2&quot;<br />
  ClearErrors<br />
  Rename $1 $0<br />
  IfErrors 0 ${Index_GetTempFile}-finished<br />
  Delete $1<br />
  IntOp $3 $3 + 1<br />
  Goto ${Index_GetTempFile}-loop<br />
  <br />
${Index_GetTempFile}-finished:<br />
  Pop $3<br />
  Pop $2<br />
  Pop $1<br />
  Exch $0<br />
  !undef Index_GetTempFile<br />
!macroend</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">23rd May 2007, 15:23</div></div><div class="posttext">The following works perfectly fine for me.GetTempFileName $0<br />
CopyFiles $SYSDIR\cmd.exe $0<br />
Exec '&quot;$0&quot; /K echo hello'Seems like the real problem here is UAC. CreateProcess fails with error 740 (ERROR_ELEVATION_REQUIRED) when trying to execute a program that requires elevation from a non-elevated context. To pop-up the elevation dialog, you need to use ExecShell, but then .tmp isn't associated, as the error says (though I have no idea how it automatically got the idea to ExecShell it). Is your main installer running elevated or not?<br />
<br />
Another possible problem is an anti-virus. I have heard about recent versions that deny running applications from the temporary directory. It's possible some took it a step forward (or actually backward in a sane view) and denied only non-exe running from the temporary directory.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">25th May 2007, 09:55</div></div><div class="posttext">@Kichik: I tested this with Vista 32bit, UAC disabled. The CopyFiles command does not work. The TMP file has still zero size. I tried it with calc.exe instead - same problem. It works with XP SP2.<br />
<br />
I then tried my copyfile macro:<br />
<br />
<br />
; ################################################################<br />
; copy source file to target file (using FileWrite)<br />
!macro CopyFile SOURCEFILE TARGETFILE<br />
  ; USE ON YOUR OWN RISK! Please report bugs here: http://stefan.bertels.org/<br />
  Push &quot;${SOURCEFILE}&quot;<br />
  Push &quot;${TARGETFILE}&quot;<br />
  Push $R1<br />
  Exch<br />
  Pop $R1 ; $R1 contains TARGETFILE<br />
  Push $R0<br />
  Exch 2<br />
  Pop $R0 ; $R0 contains SOURCEFILE<br />
  ; stack order: TOP =&gt; old $R1 =&gt; old $R0<br />
  Push $R2 ; source hdl<br />
  Push $R3 ; target hdl<br />
  Push $R4 ; buffer address / tmp3<br />
  Push $R5 ; buffer len / tmp2<br />
  Push $R6 ; tmp1<br />
<br />
  IfFileExists $R1 0 +2<br />
  Delete $R1<br />
<br />
  FileOpen $R2 $R0 r<br />
  FileSeek $R2 0 END $R5<br />
  System::Alloc /NOUNLOAD $R5<br />
  Pop $R4<br />
  FileSeek $R2 0 SET<br />
  System::Call /NOUNLOAD 'kernel32::ReadFile(i R2, i R4, i R5, t.,)'<br />
  <br />
  FileOpen $R3 $R1 w<br />
  System::Call /NOUNLOAD 'kernel32::WriteFile(i R3, i R4, i R5, t.,)'<br />
  System::Free /NOUNLOAD $R4<br />
<br />
  System::Call /NOUNLOAD 'kernel32::GetFileTime(i, *l, *l, *l) i (R2, .R4, .R5, .R6)'<br />
  System::Call 'kernel32::SetFileTime(i, *l, *l, *l) i (R3, R4, R5, R6)'<br />
<br />
  FileClose $R2<br />
  FileClose $R3<br />
  <br />
  Pop $R5<br />
  Pop $R4<br />
  Pop $R3<br />
  Pop $R2<br />
  Pop $R1<br />
  Pop $R0<br />
!macroend<br />
<br />
<br />
This works with XP SP2 and Vista (UAC still disabled). So the file extension is no problem here. I will do UAC tests later (and post it here).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">25th May 2007, 12:14</div></div><div class="posttext">UAC test: Vista asked for Elevation (I did not use RequestExecutionLevel in nsi in this example). After that the cmd prompt is shown, too. So no problem here (did use my copyfile macro, did not try CopyFiles).<br />
<br />
I don't know why Vista had some problem. I definitely used Exec (not ExecShell or ExecWait) and the file extension definitely made a difference. I cannot reproduce this quickly now :-(<br />
<br />
The test machine has McAfee VirusScan Enterprise 8.5 (enabled), but it is not likely that this caused the problem.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">25th May 2007, 12:20</div></div><div class="posttext">So the original problem was with CopyFiles as well?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">25th May 2007, 12:22</div></div><div class="posttext">McAfee is one of those Anti-Viruses that had this option to annoy every existing installer.<br />
<br />
http://news.jrsoftware.org/read/article.php?id=65596&amp;group=jrsoftware.innosetup#65596</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">25th May 2007, 15:53</div></div><div class="posttext">@kichik: No, I didn't / don't use CopyFiles at all (discussed this quite some time ago in another thread...)<br />
<br />
McAfee has some of those options, I know. But I cannot see a rule which allows executing &quot;.exe&quot; files but denies to run &quot;.tmp&quot; named executables. Such a rule would be braindead (according Murphy's law this rule will exist...)<br />
<br />
I just checked the McAfee 8.5 on the test machine: the access control is/was fully deactivated.<br />
<br />
The question is: Why did Vista show the &quot;don't know how tmp files are to open&quot; error message when calling just:<br />
<br />
Exec '&quot;c:\temp\bla123.tmp&quot; /TMPMOVED'<br />
<br />
Very strange.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">25th May 2007, 17:48</div></div><div class="posttext">I have no idea how this can happen. CreateProcess shouldn't know anything about associations. That's for the shell only.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">28th May 2007, 11:13</div></div><div class="posttext">I agree. I personally will just use my GetTempFile macro (see above) to get a temp file with &quot;working&quot; extension.<br />
<br />
Here are all necessary details of my setup where I use this (if someone has similar problems or wants to do more debugging...)<br />
<br />
- RequestExecutionLevel user<br />
- The installer checks for its name or some cmd line parameter. If this matches some criteria the installer will copy itself to a TMP filename, call it via Exec (adding all original cmd line parameter plus some extra parameter &quot;/TMPMOVED&quot;), make the TMP filename delete on next reboot, and quit immediately.<br />
<br />
This way the original installer exe can be deleted or overwritten by the installation process (which now runs from TMP).<br />
<br />
In Vista with UAC the outer (and inner) installer will not run with admin privileges (elevation is done later). If the TMP filename ends with &quot;.tmp&quot; (because generated with GetTempFileName) this will cause a error message box of Vista which says that the file ending is not associated with some program. So I use a tmp filename ending in &quot;.exe&quot; and all works fine.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>