<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" (Yet another) Uninstall before Install question., media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  (Yet another) Uninstall before Install question. NSIS Discussion" />
	
	<title> (Yet another) Uninstall before Install question. [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  (Yet another) Uninstall before Install question.</div>
<hr />
<div class="pda"><a href="t-212468.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=212468">(Yet another) Uninstall before Install question.</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Arrby</div><div class="date">6th April 2005, 23:45</div></div><div class="posttext">NSIS Version 2.05:<br />
I have my installer doing the check for existing installation and doing uninstall first, essentially just as NSIS itself does (I stole the custom screen and functions right from makensis.nsi in the Examples folder).<br />
<br />
I have discovered the following problem (bug?).<br />
<br />
The code:<br />
<br />
  HideWindow<br />
  ClearErrors<br />
  ExecWait '$R1 _?=$INSTDIR'<br />
     ...<br />
     ...<br />
  BringToFront<br />
 <br />
does what one expects / wants  If and Only If the folder &quot;Program Files&quot; is included somewhere in the value of $INSTDIR, at the time the function is being executed. If $INSTDIR does NOT include &quot;Program Files&quot; in its value, the ExecWait Does Not Wait!.<br />
<br />
Note, it doesn't seem to matter what drive the installation was to, and $INSTDIR is the correct value of the &quot;previous&quot; installation, so the uninstall works correctly, it just doesn't wait, i.e the installer continues to run as if the ExecWait had been an Exec.<br />
<br />
Is there something I can add to the code to force it to wait when the &quot;previous&quot; installation was NOT to a folder underneath a &quot;Program Files&quot; folder?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">7th April 2005, 11:57</div></div><div class="posttext">I'm thinking it has something more to do with a space being there. Try ExecWait '$R1 &quot;_?=$INSTDIR&quot;'</div></div><hr />


<div class="post"><div class="posttop"><div class="username">glory_man</div><div class="date">7th April 2005, 12:05</div></div><div class="posttext">I tried it but nothing happened. ExecWait does not wait even if $INSTDIR include &quot;Program Files&quot;. But I'll try else.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">7th April 2005, 12:14</div></div><div class="posttext">Here's your problem...<br />
ExecWait '$R1 _?=$INSTDIR'<br />
Need quotes around $R1 incase it contains spaces.<br />
ExecWait '&quot;$R1&quot; &quot;_?=$INSTDIR&quot;'<br />
<br />
Edit: If you've got Program Files in there, e.g.<br />
C:\Program Files\myApp\file.exe<br />
it will treat &quot;C:\Program&quot; as the program to execute, and &quot;Files\myApp\file.exe&quot; as a paramater.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">glory_man</div><div class="date">7th April 2005, 13:13</div></div><div class="posttext">I modified basic.nsi from Examples-dir (see attachment). What's wrong? I don't understand.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">7th April 2005, 16:05</div></div><div class="posttext">Hmm you're right it doesn't wait whatever path it is. It doesn't even wait if I do not use the _?= param.<br />
I think the only solution at the moment, is to wait until some specific file is gone (so you know it's been uninstalled) before continuing with install...<br />
<br />
ExecWait '&quot;$R1&quot; &quot;_?=$INSTDIR&quot;'<br />
Sleep 1000<br />
IfFileExists &quot;$INSTDIR\some_file.ext&quot; -1<br />
<br />
Edit: Though if user cancels uninstall it will loop forever :cry:<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">7th April 2005, 16:08</div></div><div class="posttext">Ok, then you should get the Uninstall to create a temp file in un.onInit and delete it in un.onUninstSuccess, un.onUninstFailed, un.onUserAbort, and lastly un.onGUIEnd (if user does Ctrl+Alt+Del in some cases!)<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">glory_man</div><div class="date">7th April 2005, 17:37</div></div><div class="posttext">Using of ExecWait '&quot;$R1&quot; _?=$INSTDIR' solved this problem for me.<br />
<br />
ADD<br />
<br />
makensis.nsi must be edited.:)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th April 2005, 17:45</div></div><div class="posttext">makensis.nsi reads a string that is already quoted.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">glory_man</div><div class="date">7th April 2005, 18:05</div></div><div class="posttext">I understand that ExecWait don't wait if command without spaces and not in quotes. <br />
From documentation:<br />
<br />
Note, if the command could have spaces, you should put it in quotes to delimit it from parameters.<br />
...<br />
If you don't put it in quotes it will not work on Windows 9x with or without parameters.<br />
<br />
I use WinXP.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th April 2005, 18:09</div></div><div class="posttext">ExecWait may fail if the command isn't properly quoted. But it is properly quoted in makensis.nsi as $R1 contains the quotes.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">glory_man</div><div class="date">7th April 2005, 18:18</div></div><div class="posttext">I think if ExecWait failed than error flag must be set. In my example ExecWait exit without error flag seting.<br />
Is this normal?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th April 2005, 18:22</div></div><div class="posttext">The error flag is set if CreateProcess fails. If the process was not created and the error flag was not set, it's not normal. I'd guess the process was created but exited before you noticed. Which exact example are you referring to? You said the last one worked.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">glory_man</div><div class="date">8th April 2005, 14:08</div></div><div class="posttext">2 kichik<br />
Yes, if i use ExecWait '&quot;$R1&quot; _?=$INSTDIR' all works.<br />
I just try to say that command must be in quotes not only for Win98 or if the command has spaces. But even if WinXP and command has not spaces.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Arrby</div><div class="date">8th April 2005, 21:46</div></div><div class="posttext">Thanks everyone. THANK YOU glory_man!:up: <br />
Putting the &quot;&quot; around $R1 did the trick.<br />
<br />
I must admit to being completely mystified as to why, though.<br />
 Why does the uninst program (spawn nowait?)itself if $R1 in unquoted AND the $INSTDIR path does NOT contain any spaces, but either doesn't spawn itself or spawns itself WITH wait when $R1 is unquoted AND the $INSTDIR DOES contain at least one folder WITH spaces?<br />
<br />
Why does quoting R1, i.e. &quot;$R1&quot; cause the uninstall program<br />
to either not spawn itself or spawn WITH wait regardless of whether $INSTDIR contains a folder with spaces or not?<br />
<br />
Or why does it at least SEEM to work this way?:confused:</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">8th April 2005, 23:13</div></div><div class="posttext">Why you need quotes around the path:<br />
If you've got 'Program Files' in there, e.g.<br />
C:\Program Files\myApp\file.exe<br />
it will treat &quot;C:\Program&quot; as the program to execute, and &quot;Files\myApp\file.exe&quot; as a paramater (when it should be the whole lot).<br />
<br />
With the _?= switch, everything after it is passed into the $INSTDIR var. So, say if I were to do _?=C:\ /silent (what one might think are two seperate paramaters) would set $INSTDIR to &quot;C:\ /silent&quot;<br />
<br />
I'm not sure though why that should stop ExecWait from waiting. Perhaps the uninstaller trips on that error with the quotes around _?= and the value and ExecWait thinks it's aborted.<br />
I'm guessing if you use &quot;_?=C:\&quot; then $INSTDIR will be C:\&quot; which is a bad path already (can't have double quotes in paths)!<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Arrby</div><div class="date">9th April 2005, 19:47</div></div><div class="posttext">Curiouser and Curiouser:<br />
<br />
Take glory_man's test script.<br />
Test with all 4 of the following variations:<br />
<br />
1: ExecWait '$R1 _?=$INSTDIR'  ;taken from makensis.nsi<br />
2: ExecWait '$R1 &quot;_?=$INSTDIR&quot;'<br />
3: ExecWait '&quot;$R1&quot; &quot;_?=$INSTDIR&quot;'<br />
4: ExecWait '&quot;$R1&quot; _?=$INSTDIR'<br />
<br />
For your tests do the following:<br />
Initial install: choose a path with at least one<br />
folder in it that has embedded spaces, i.e I chose:<br />
<br />
E:\P F\ExecTest<br />
<br />
After the install, immediately run the installer again. Pay attention to the task bar as your running.<br />
After the UNINSTALL takes place, when you get to the directory page, modify the path to remove the spaces from ALL folders in the path. I.e. I changed it to:<br />
<br />
E:\PF\ExecTest<br />
<br />
Run the installer a third time, watch the task bar as you<br />
go thru the UNinstaller routine.<br />
<br />
Obviously options 3 or 4 are the options to use for desired behaviour.  I am real curious as to WHY we would EVER want the uninstaller to behave as it does for options 1 and 2.<br />
<br />
Why is the uninstaller EVER spawning itself with a NOWAIT,<br />
and should it?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">9th April 2005, 20:55</div></div><div class="posttext">Assuming $R1 doesn't already contain the quotes, the right method is:ExecWait '&quot;$R1&quot; _?=$INSTDIR'The others are wrong.<br />
<br />
The uninstaller spawns a copy of itself so it'll be able to delete itself.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Arrby</div><div class="date">9th April 2005, 21:58</div></div><div class="posttext">The last form you showed is the same one I chose, Thanks!<br />
<br />
One last word and I'll let this topic die.<br />
Based on the behaviour with Unquoted $R1 (when R1 itself is NOT a quoted string) when the paths do and dont contain embedded blanks (my last post makes the behaviour clear). Are you sure the current behaviour is NOT the OPPOSITE of what it should be? I.E. why does it WAIT when the unquoted $R1 var contains a non-quoted string with embedded blanks, but FAIL to WAIT when the unquoted $R1 var contains a non-quoted string WITHOUT embedded blanks. I am probably just completely confused, but it seems the second case should be the case in which the unistaller sees it is being executed from the SAME directory it is deleting (no embedded blanks in the path), and it should be the first case (embedded blanks) when it thinks its being run from a SEPERATE directory from the one it is deleting. Why does it need to spawn itself with NO_WAIT when it is running from a DIFFERENT path than it is deleting, but DOESNT need to spawn itself (or at least spawns itself with WAIT) when it is running from the SAME directory it is deleting.<br />
<br />
This is what has me so confused!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">9th April 2005, 22:08</div></div><div class="posttext">Got me confused too so I'll just write down all the facts. Using Exec, ExecWait or ExecShell with an unquoted path is never a good idea. It doesn't have to do with waiting or not waiting, just the success of running the process itself. Windows might simply fail creating the process or it might execute a different executable. When you execute an uninstaller without _?=, it copies itself to the temporary directory, runs the copy with _?=$EXEDIR and quits immediately. When you pass an uninstaller _?=path, it sets $INSTDIR and $OUTDIR to path and starts doing its job.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>