<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" .NET 2.0 install function, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  .NET 2.0 install function NSIS Discussion" />
	
	<title> .NET 2.0 install function [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  .NET 2.0 install function</div>
<hr />
<div class="pda"><a href="t-243765.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=243765">.NET 2.0 install function</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Gridley</div><div class="date">17th April 2006, 21:28</div></div><div class="posttext">I use the GetDotNET (http://nsis.sourceforge.net/Get_.NET_Version) code to detect which version of .NET framework is installed, but rather than<br />
<br />
I have a desire to convert   this page (http://nsis.sourceforge.net/Installing_the_Microsoft_.NET_Framework[/url) to a function instead of a section.  So far, I can't get it to work...could someone help?<br />
<br />
Thanks in advance!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">17th April 2006, 23:04</div></div><div class="posttext">Do you need to call it before the InstFiles page?<br />
What happens if you just change the Section and SectionEnd to Function and FunctionEnd?<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gridley</div><div class="date">18th April 2006, 01:35</div></div><div class="posttext">Originally posted by Afrow UK <br />
Do you need to call it before the InstFiles page?<br />
What happens if you just change the Section and SectionEnd to Function and FunctionEnd?<br />
<br />
-Stu  <br />
<br />
I'd like to call it immediately so that I don't need to worry about uninstalling the partial install, though I could work around that.  <br />
<br />
Essentially what I have done is pretty much just replace &quot;Section&quot; with &quot;Function&quot; - the GetDotNETVersion routines work great, the MB for whether to download .net or abort opens, then regardless of choice, the installer aborts.  <br />
<br />
Here's my code currently:<br />
<br />
DECLARATIONS (partial):<br />
<br />
; FetchDotNET VARs<br />
Var &quot;LANGUAGE_DLL_TITLE&quot;<br />
Var &quot;LANGUAGE_DLL_INFO&quot;<br />
Var &quot;URL_DOTNET&quot;<br />
Var &quot;OSLANGUAGE&quot;<br />
Var &quot;DOTNET_RETURN_CODE&quot;<br />
LangString DESC_REMAINING ${LANG_ENGLISH} &quot; (%d %s%s remaining)&quot;<br />
LangString DESC_PROGRESS ${LANG_ENGLISH} &quot;%d.%01dkB/s&quot; ;&quot;%dkB (%d%%) of %dkB @ %d.%01dkB/s&quot;<br />
LangString DESC_PLURAL ${LANG_ENGLISH} &quot;s&quot;<br />
LangString DESC_HOUR ${LANG_ENGLISH} &quot;hour&quot;<br />
LangString DESC_MINUTE ${LANG_ENGLISH} &quot;minute&quot;<br />
LangString DESC_SECOND ${LANG_ENGLISH} &quot;second&quot;<br />
LangString DESC_CONNECTING ${LANG_ENGLISH} &quot;Connecting...&quot;<br />
LangString DESC_DOWNLOADING ${LANG_ENGLISH} &quot;Downloading %s&quot;<br />
LangString DESC_SHORTDOTNET ${LANG_ENGLISH} &quot;Microsoft .Net Framework 2.0&quot;<br />
LangString DESC_LONGDOTNET ${LANG_ENGLISH} &quot;Microsoft .Net Framework 2.0&quot;<br />
LangString DESC_DOTNET_DECISION ${LANG_ENGLISH} &quot;$(DESC_SHORTDOTNET) is required.$\nIt is strongly \<br />
  advised that you install$\n$(DESC_SHORTDOTNET) before continuing.$\nIf you choose to continue, \<br />
  you will need to connect$\nto the internet before proceeding.$\nWould you like to continue with \<br />
  the installation?&quot;<br />
LangString SEC_DOTNET ${LANG_ENGLISH} &quot;$(DESC_SHORTDOTNET) &quot;<br />
LangString DESC_INSTALLING ${LANG_ENGLISH} &quot;Installing&quot;<br />
LangString DESC_DOWNLOADING1 ${LANG_ENGLISH} &quot;Downloading&quot;<br />
LangString DESC_DOWNLOADFAILED ${LANG_ENGLISH} &quot;Download Failed:&quot;<br />
LangString ERROR_DOTNET_DUPLICATE_INSTANCE ${LANG_ENGLISH} &quot;The $(DESC_SHORTDOTNET) Installer is \<br />
  already running.&quot;<br />
LangString ERROR_NOT_ADMINISTRATOR ${LANG_ENGLISH} &quot;$(DESC_000022)&quot;<br />
LangString ERROR_INVALID_PLATFORM ${LANG_ENGLISH} &quot;$(DESC_000023)&quot;<br />
LangString DESC_DOTNET_TIMEOUT ${LANG_ENGLISH} &quot;The installation of the $(DESC_SHORTDOTNET) \<br />
  has timed out.&quot;<br />
LangString ERROR_DOTNET_INVALID_PATH ${LANG_ENGLISH} &quot;The $(DESC_SHORTDOTNET) Installation$\n\<br />
  was not found in the following location:$\n&quot;<br />
LangString ERROR_DOTNET_FATAL ${LANG_ENGLISH} &quot;A fatal error occurred during the installation$\n\<br />
  of the $(DESC_SHORTDOTNET).&quot;<br />
LangString FAILED_DOTNET_INSTALL ${LANG_ENGLISH} &quot;The installation of $(PRODUCT_NAME) will$\n\<br />
  continue. However, it may not function properly$\nuntil $(DESC_SHORTDOTNET)$\nis installed.&quot;<br />
<br />
<br />
.oninit:<br />
<br />
Function .onInit<br />
  Call GetDotNETVersion<br />
  Pop $0<br />
  ${If} $0 == &quot;not found&quot;<br />
    ;MessageBox MB_ICONSTOP|MB_YESNO|MB_DEFBUTTON2 &quot;.NET framework is not installed. \<br />
Select Yes to download and install .NET 2.0 or NO to abort.&quot; IDYES +2<br />
    ;Abort<br />
    call FetchDotNET<br />
  ${EndIf}<br />
<br />
  StrCpy $0 $0 &quot;&quot; 1 # skip &quot;v&quot;<br />
<br />
  ${VersionCompare} $0 &quot;2.0&quot; $1<br />
  ${If} $1 == 2<br />
    ;MessageBox MB_ICONSTOP|MB_YESNO|MB_DEFBUTTON2 &quot;.NET framework v2.0 or newer is required. You have $0.  \<br />
Select Yes to download and install .NET 2.0 or NO to abort.&quot; IDYES +2<br />
    call FetchDotNET<br />
  ${EndIf}<br />
FunctionEnd<br />
<br />
<br />
Function GetDotNETVersion:<br />
<br />
Function GetDotNETVersion<br />
  Push $0<br />
  Push $1<br />
<br />
  System::Call &quot;mscoree::GetCORVersion(w .r0, i ${NSIS_MAX_STRLEN}, *i) i .r1&quot;<br />
  StrCmp $1 0 +2<br />
    StrCpy $0 &quot;not found&quot;<br />
<br />
  Pop $1<br />
  Exch $0<br />
FunctionEnd<br />
<br />
<br />
Function FetchDotNET Converted from zimsms &quot;Installing .NET&quot; wiki page:<br />
<br />
Function FetchDotNET<br />
; .NET Framework<br />
!define BASE_URL http://download.microsoft.com/download<br />
; English<br />
!define URL_DOTNET_1033 &quot;${BASE_URL}/a/a/c/aac39226-8825-44ce-90e3-bf8203e74006/dotnetfx.exe&quot;<br />
; German<br />
!define URL_DOTNET_1031 &quot;${BASE_URL}/4/f/3/4f3ac857-e063-45d0-9835-83894f20e808/dotnetfx.exe&quot;<br />
; Spanish<br />
!define URL_DOTNET_1034 &quot;${BASE_URL}/8/f/0/8f023ff4-2dc1-4f10-9618-333f5b9f8040/dotnetfx.exe&quot;<br />
; French<br />
!define URL_DOTNET_1036 &quot;${BASE_URL}/e/d/a/eda9d4ea-8ec9-4431-8efa-75391fb91421/dotnetfx.exe&quot;<br />
; Portuguese (Brazil)<br />
!define URL_DOTNET_1046 &quot;${BASE_URL}/8/c/f/8cf55d0c-235e-4062-933c-64ffdf7e7043/dotnetfx.exe&quot;<br />
; Chinese (Simplified)<br />
!define URL_DOTNET_2052 &quot;${BASE_URL}/7/b/9/7b90644d-1af0-42b9-b76d-a2770319a568/dotnetfx.exe&quot;<br />
; Japanese<br />
!define URL_DOTNET_1041 &quot;${BASE_URL}/5/6/7/567758a3-759e-473e-bf8f-52154438565a/dotnetfx.exe&quot;<br />
; ... If you need one not listed above you will have to visit the Microsoft Download site,<br />
; select the language you are after and scan the page source to obtain the link.<br />
<br />
    ; the following Goto and Label is for consistencey.<br />
    Goto lbl_DownloadRequired<br />
    lbl_DownloadRequired:<br />
    !insertmacro PRINT &quot;$(DESC_DOWNLOADING1) $(DESC_SHORTDOTNET)...&quot;<br />
    MessageBox MB_ICONEXCLAMATION|MB_YESNO|MB_DEFBUTTON2 &quot;$(DESC_DOTNET_DECISION)&quot; /SD IDYES IDYES +2<br />
    Abort<br />
    ; &quot;Downloading Microsoft .Net Framework&quot;<br />
    NSISdl::download /TRANSLATE &quot;$(DESC_DOWNLOADING)&quot; &quot;$(DESC_CONNECTING)&quot; &quot;$(DESC_SECOND)&quot; &quot;$(DESC_MINUTE)&quot; &quot;$(DESC_HOUR)&quot; &quot;$(DESC_PLURAL)&quot; \<br />
&quot;$(DESC_PROGRESS)&quot; &quot;$(DESC_REMAINING)&quot; /TIMEOUT=30000 &quot;$URL_DOTNET&quot; &quot;$TEMP\dotnetfx.exe&quot; <br />
    Pop $0<br />
    StrCmp &quot;$0&quot; &quot;success&quot; lbl_continue<br />
    !insertmacro PRINT &quot;$(DESC_DOWNLOADFAILED) $0&quot;<br />
    Abort<br />
<br />
    lbl_continue:<br />
      !insertmacro PRINT &quot;$(DESC_INSTALLING) $(DESC_SHORTDOTNET)...&quot;<br />
      Banner::show /NOUNLOAD &quot;$(DESC_INSTALLING) $(DESC_SHORTDOTNET)...&quot;<br />
      nsExec::ExecToStack '&quot;$TEMP\dotnetfx.exe&quot; /q /c:&quot;install.exe /noaspupgrade /q&quot;'<br />
      pop $DOTNET_RETURN_CODE<br />
      Banner::destroy<br />
      SetRebootFlag true<br />
      ; silence the compiler<br />
      Goto lbl_NoDownloadRequired<br />
      lbl_NoDownloadRequired:<br />
<br />
      ; obtain any error code and inform the user ($DOTNET_RETURN_CODE)<br />
      ; If nsExec is unable to execute the process,<br />
      ; it will return &quot;error&quot;<br />
      ; If the process timed out it will return &quot;timeout&quot;<br />
      ; else it will return the return code from the executed process.<br />
      StrCmp &quot;$DOTNET_RETURN_CODE&quot; &quot;&quot; lbl_NoError<br />
      StrCmp &quot;$DOTNET_RETURN_CODE&quot; &quot;0&quot; lbl_NoError<br />
      StrCmp &quot;$DOTNET_RETURN_CODE&quot; &quot;3010&quot; lbl_NoError<br />
      StrCmp &quot;$DOTNET_RETURN_CODE&quot; &quot;8192&quot; lbl_NoError<br />
      StrCmp &quot;$DOTNET_RETURN_CODE&quot; &quot;error&quot; lbl_Error<br />
      StrCmp &quot;$DOTNET_RETURN_CODE&quot; &quot;timeout&quot; lbl_TimeOut<br />
      ; It's a .Net Error<br />
      StrCmp &quot;$DOTNET_RETURN_CODE&quot; &quot;4101&quot; lbl_Error_DuplicateInstance<br />
      StrCmp &quot;$DOTNET_RETURN_CODE&quot; &quot;4097&quot; lbl_Error_NotAdministrator<br />
      StrCmp &quot;$DOTNET_RETURN_CODE&quot; &quot;1633&quot; lbl_Error_InvalidPlatform lbl_FatalError<br />
      ; all others are fatal<br />
<br />
    lbl_Error_DuplicateInstance:<br />
    !insertmacro PRINT &quot;$(ERROR_DOTNET_DUPLICATE_INSTANCE)&quot;<br />
    GoTo lbl_Done<br />
<br />
    lbl_Error_NotAdministrator:<br />
    !insertmacro PRINT &quot;$(ERROR_NOT_ADMINISTRATOR)&quot;<br />
    GoTo lbl_Done<br />
<br />
    lbl_Error_InvalidPlatform:<br />
    !insertmacro PRINT &quot;$(ERROR_INVALID_PLATFORM)&quot;<br />
    GoTo lbl_Done<br />
<br />
    lbl_TimeOut:<br />
    !insertmacro PRINT &quot;$(DESC_DOTNET_TIMEOUT)&quot;<br />
    GoTo lbl_Done<br />
<br />
    lbl_Error:<br />
    !insertmacro PRINT &quot;$(ERROR_DOTNET_INVALID_PATH)&quot;<br />
    GoTo lbl_Done<br />
<br />
    lbl_FatalError:<br />
    !insertmacro PRINT &quot;$(ERROR_DOTNET_FATAL)[$DOTNET_RETURN_CODE]&quot;<br />
    GoTo lbl_Done<br />
<br />
    lbl_Done:<br />
    !insertmacro PRINT &quot;$(FAILED_DOTNET_INSTALL)&quot;<br />
    lbl_NoError:<br />
<br />
FunctionEnd<br />
<br />
<br />
Now, I know I'm just missing something simple, or maybe NSISdl can't be called from a function?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">18th April 2006, 09:31</div></div><div class="posttext">There's a few Abort instructions in there.<br />
Abort closes the installer when called from .onInit.<br />
In an install Section it would have cancelled the installation process.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">18th April 2006, 11:12</div></div><div class="posttext">NSISdl may be in function, but not from .onInit. Requires INSTFILES page. Translate option is useless without page as well. InetLoad (http://nsis.sourceforge.net/InetLoad_plug-in) can do this, but please note - Translate parameters for /popup mode have other values, see readme and samples.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">18th April 2006, 12:29</div></div><div class="posttext">NSISdl will still work outside the InstFiles page, but obviously there will be no dialog.<br />
I would go with Takhir and use the InetLoad plugin.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gridley</div><div class="date">18th April 2006, 15:13</div></div><div class="posttext">Thanks guys.  I'll check InetLoad.  <br />
<br />
RE: abort- I did want it to abort install, just that it was reaching those lines when it shouldn't be - as if the NSISdl was being bypassed or causing an abort itself.  If InetLoad proves troublesome, I'll try moving the .net check to the first section...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Fretje</div><div class="date">18th April 2006, 16:31</div></div><div class="posttext">Question: Where do you initialize the &quot;URL_DOTNET&quot; variable which is used to download the file? And how do you adapt it to the language of the system?<br />
<br />
thanks!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gridley</div><div class="date">18th April 2006, 16:39</div></div><div class="posttext">I actually haven't gotten that working yet either, but the original method uses the MUI LANGDLL_DISPLAY macro to accomplish that - I would hope to do the same if I can get the english download to work!  For now, I've got some of that hard-coded, so that's not where the failure comes from - I should have shown that in the code above...<br />
<br />
See: Installing_the_Microsoft_.NET_Framework (http://nsis.sourceforge.net/Installing_the_Microsoft_.NET_Framework  )</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gridley</div><div class="date">24th April 2006, 14:45</div></div><div class="posttext">To close this thread, InetLoad is working great.  Thanks!</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>