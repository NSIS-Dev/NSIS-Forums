<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" some troubles, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  some troubles NSIS Discussion" />
	
	<title> some troubles [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  some troubles</div>
<hr />
<div class="pda"><a href="t-102578.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=102578">some troubles</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Wyz</div><div class="date">30th August 2002, 00:07</div></div><div class="posttext">Hi !<br />
There are some troubles I can't solve and it took me lots of headaches... :igor: <br />
I've created an installation package (w/ modern UI :D : I had to remove components page and it was one more headache !) for a software which put an icon in the systray.<br />
1. The install puts only links in the start menu of the logged user. I have put an uninstall shorcut available throught &quot;Add/Remove Software&quot; of Control Panel so it can be unsinstalled from ANY user session... If I uninstall from an other user session than those which was used to install it, the shortcuts are kept (but broken)... How to be sure to remove ALL shortcuts for all users (or just these of the user which was used to install) ?<br />
2. The software uses a .dll file. If the software runs when uninstall is started, uninstall close it (Findwindow + SendMessage 16) but I don't know why .dll isn't deleted and so the INSTDIR stays (if the software aren't running it works fine). How to be sure the .dll file will be deleted ? (Note that if is a .txt file which the software read, it's the same thing : the .txt isn't remove)<br />
A bonus question : What's the best way to close a software which have only an icon in the systray ?<br />
Regards</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">30th August 2002, 00:20</div></div><div class="posttext">1) Use SetShellVarContext all before you create the shortcuts to make sure they will be created for all of the users, and then they could be easily deleted for all users.<br />
2) Make sure the software closes all handles it has, and then you will be able to delete those files.<br />
3) Find the window that controls the system tray icon and send it a ${WM_CLOSE} (defined in ${NSISDIR}\Examples\WinMessages.NSH).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Wyz</div><div class="date">30th August 2002, 00:36</div></div><div class="posttext">Waow ! Very quick answer ! Thx.<br />
1. In fact I prefer the shortcuts to be installed only for current user, so what the solution ?<br />
2. All handles. I'm not sure it has a lot... And how to know which one it uses and how to close them ?<br />
3. Already done and it works (the only thing that does:)), so it seems to be the only solution... But I use SendMessage 16 0 0 (No need to include one more file)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">30th August 2002, 09:46</div></div><div class="posttext">1) Either let the user that installed uninstall, or save the location of the shortcuts somehow (the registry maybe), restore that location in the uninstaller and use it to delete them.<br />
2) Did you write the software? If not, it may be possible to use Sleep to make this work. Give it time to lose the locks on the files.<br />
3) Best solution AFAIK.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Wyz</div><div class="date">30th August 2002, 23:27</div></div><div class="posttext">1. Hum, regisry seems to be fine, as I still put a key so that the uninstall could be run from control panel<br />
2. I didn't write the sofware, I've translated into french and it's author is nowhere to be found. I still use Sleep and I don't know  why but w/ alpha 7 final (08/28/02) it works : the .dll file is deleted even if the software must be closed by NSIS (is was the cas w/ a prerelease I used) !<br />
3. Ok, thx. (how to find the classname of a software which is in the systray ?)<br />
CU and thx (How could you be so quick ? Do you have 2 heads or 4 arms ?)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Wyz</div><div class="date">30th August 2002, 23:55</div></div><div class="posttext">I have thought a bit and I think I have found a solution (it may not be the best but it is a soluton) :<br />
Why not write a function which browse for every start menu folders and then delete the same item in all (delete in default user and in folders of each profiles Window directory) ?<br />
Trouble is that I need to use Push and Pop and I can't figure out how to use them, maybe do you have an idea on how I could write this function ?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">31st August 2002, 09:16</div></div><div class="posttext">Personally, I think that creating the shortcuts in the &quot;all users&quot; start menu is the best solution, but if you insist... I remember I have seen such a function once in the forums. I couldn't find it, maybe you will have better luck.<br />
<br />
Push and Pop are stack functions. Stack works by the LIFO method. LIFO means First In Last Out. That means that if you Push two things and then Pop two things you will get them in the oppsite order.<br />
<br />
It is always useful to make a drawing out of a stack:<br />
<br />
After two pushes:<br />
<br />
  -------------<br />
  |  Second   |<br />
  -------------<br />
  |   First   |<br />
------------------<br />
<br />
<br />
One pop later:<br />
<br />
  -------------<br />
  |   First   |<br />
------------------<br />
<br />
<br />
I hope that helps :D</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Wyz</div><div class="date">2nd September 2002, 00:14</div></div><div class="posttext">That's still a bit confused..<br />
I don't understand why SetShellVar all works but if current is specified, NSIS doesn't remember which one was used...<br />
Drawing the state of the stack is an idea...<br />
I hoped you could help me in writing this scan code but if I can't found it in the forum then I will try...<br />
I will do a scan which put on the stack each Profiles folder it founds... Then reading from the stack, I will remove (hope I will succeed in doing that, not sure :( )<br />
CU</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Sunjammer</div><div class="date">2nd September 2002, 09:19</div></div><div class="posttext">A stack is a very simple idea. The stack starts empty. You push things onto it one at a time and the stack grows. This is like adding plates to a stack of plates. When you &quot;pop&quot; one it means you take the top plate from the stack (which was the last one you &quot;pushed&quot; onto the stack).<br />
<br />
  Push 'A'    -- stack now contains one item, 'A'<br />
  Push 'B'    -- stack now contains two items, 'A' on the bottom with 'B' stacked on top of it<br />
  Push 'C'    -- stack now contains three items, 'A' at the bottom, 'B' above 'A', and 'C' above 'B'.<br />
<br />
When you pop you remove the items in the reverse order that you pushed them so...<br />
<br />
  Pop $0      -- takes 'C' off the stack and places it into $0<br />
  Pop $1      -- takes 'B' off the stack<br />
  Pop $2      -- takes 'C' off the stack<br />
<br />
The stack is now empty again.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">2nd September 2002, 13:54</div></div><div class="posttext">I don't understand why SetShellVar all works but if current is specified, NSIS doesn't remember which one was used... <br />
<br />
Current user means the current user for good or bad. NSIS doesn't remember anything from the installer in the uninstaller, unless you make it (regisrty, files, or INI).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Wyz</div><div class="date">2nd September 2002, 22:30</div></div><div class="posttext">Ok, I have wrote 2 functions in order the uninstall remembers where items was installed (As I still use a part of the registry to make the uninstall available from control panel I knew where to put extra infos)...<br />
Uninstall is a little buggy but I can't figure out why. Here they are (I didn't sleep a lot last night :igor: )<br />
<br />
[edited by kichik, please attach large script next time]<br />
File attached below :down:</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Wyz</div><div class="date">2nd September 2002, 22:42</div></div><div class="posttext">Hum, I am very tired... I have to pass less time on NSIS coding :eek:<br />
I have downloaded latest version of makensis* from CVS, I will try if it works w/ them...<br />
Can you check the 2 functions and give me some feedbacks (improvements or other) ?<br />
CU</div></div><hr />


<div class="post"><div class="posttop"><div class="username">eccles</div><div class="date">2nd September 2002, 23:39</div></div><div class="posttext">I think I see the problem.  In the following line you should replace DeleteRegKey with DeleteRegValueDeleteRegKey HKLM \ <br />
&quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\PushPin&quot; \ <br />
&quot;StartMenuProgramsPath$1&quot; <br />
I don't think this should have compiled as it stood, as DeleteRegKey should only take two full parameters (plus the optional &quot;/ifempty&quot; flag).  I shall look into it.  If it did compile (as it seems) then the third parameter must have been ignored resulting in the whole key being deleted.<br />
<br />
Hope that solves it for you...<br />
<br />
[edit] Confirmed this to be a bug, which I've just fixed.  Once a new makensis.exe is uploaded, it should (correctly) refuse to compile your original function, until the first DeleteRegKey is changed to DeleteRegValue.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Sunjammer</div><div class="date">3rd September 2002, 08:59</div></div><div class="posttext">Nice catch eccles, a bug that potentially deletes an entire key is nasty indeed!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">3rd September 2002, 11:33</div></div><div class="posttext">Script attached here.<br />
<br />
Recompiled version check in the CVS.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Wyz</div><div class="date">3rd September 2002, 20:23</div></div><div class="posttext">It's for that it didn't work : the reg key were deleted when reading first entry and following couldn't be deleted (logical)...<br />
I took me hours and hours to write this 2 functions (I couldn't figure out how to create a scan scode w/ NSIS commands) and I didn't use the good command, I need also to buy eyes :eek:<br />
Thx to have pointed out this...<br />
Two more things :<br />
* This new makensis version require NLF v2 header, I got an error &quot;bad language file version&quot; (normal I think)<br />
* I can't figure out why justin &quot;Refresh uninstall panel&quot; function (that I found on the Sunjummer site) doesn't work - reproduced here (not large kichick) :<br />
Function un.RefreshUninstallPanel<br />
  Push $0<br />
  Push $1<br />
  StrCpy $1 &quot;&quot;<br />
  again:<br />
  FindWindow $0 &quot;#32770&quot; &quot;Propriétés de Ajout/Suppression de programmes&quot; ;French system (english one is &quot;Add/Remove properties&quot;)<br />
  StrCmp $0 0 done<br />
  SendMessage $0 ${WM_CLOSE} 0 0<br />
  StrCpy $1 1<br />
  goto again<br />
  done:<br />
  StrCmp $1 &quot;&quot; noopen<br />
  Exec '&quot;$WINDIR\control.exe&quot; appwiz.cpl'<br />
  noopen:<br />
  Pop $1<br />
  Pop $0<br />
FunctionEnd<br />
<br />
The window is closed but not opened again... What's the matter ? (I tried to run the command from Execute of the Star Menu and it works)<br />
Regards (After that I think I have finished...)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Wyz</div><div class="date">3rd September 2002, 23:30</div></div><div class="posttext">This post only to attach the good version of the 2 functions...<br />
I think there are great and they can be distributed.<br />
Feedback is welcome !</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">4th September 2002, 08:23</div></div><div class="posttext">* This new makensis version require NLF v2 header, I got an error &quot;bad language file version&quot; (normal I think)<br />
<br />
New NLFs are uploaded everyday. Currently only the Swedish NLFv2 is missing. Go to the CVS and get the latest NLF for your language.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>