<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" GetFileTime vs GetFileTimeLocal yields different results, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  GetFileTime vs GetFileTimeLocal yields different results NSIS Discussion" />
	
	<title> GetFileTime vs GetFileTimeLocal yields different results [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  GetFileTime vs GetFileTimeLocal yields different results</div>
<hr />
<div class="pda"><a href="t-337580.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=337580">GetFileTime vs GetFileTimeLocal yields different results</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">nughtin</div><div class="date">15th November 2011, 14:22</div></div><div class="posttext">If I do a GetFileTimeLocal on a file, install it, then do a GetFileTime on that same file it gives different results.  The timezones on the build computer and the computer i am installing on are the same.  Can anyone help?<br />
<br />
Code:<br />
  GetFileTime ${destfile} $R0 $R1 ; File it will be replacing<br />
  GetFileTimeLocal ${localfile} $R2 $R3 ; File to install<br />
  DetailPrint &quot;Existing File=${destfile}&quot;<br />
  DetailPrint &quot;Existing File=$R0.$R1&quot;<br />
  DetailPrint &quot;New File=${localfile}&quot;<br />
  DetailPrint &quot;New File=$R2.$R3&quot;<br />
  IntCmp $R0 $R2 0 &quot;installlibbydate.start_${INSTALLLIBBYDATE_UNIQUE}&quot; &quot;installlibbydate.done_${INSTALLLIBBYDATE_UNIQUE}&quot;<br />
  IntCmp $R1 $R3 &quot;installlibbydate.done_${INSTALLLIBBYDATE_UNIQUE}&quot; &quot;installlibbydate.start_${INSTALLLIBBYDATE_UNIQUE}&quot; &quot;installlibbydate.done_${INSTALLLIBBYDATE_UNIQUE}&quot;<br />
<br />
<br />
Results:<br />
Existing File=C:\Documents and Settings\XPMUser\Desktop\NSIS Testing\AspenAI.dll<br />
Existing File=30188312.338555648<br />
New File=C:\Development\Aspen2000\bin\AspenAI.dll<br />
New File=30188312.356245648</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">15th November 2011, 15:38</div></div><div class="posttext">From MSDN:<br />
Not all file systems can record creation and last access times and not all file systems record them in the same manner. For example, on FAT, create time has a resolution of 10 milliseconds, write time has a resolution of 2 seconds, and access time has a resolution of 1 day (really, the access date). Therefore, the GetFileTime function may not return the same file time information set using the SetFileTime function.<br />
<br />
I'm guessing this is the issue, so you should probably add a fuzz factor of about 4 seconds. Or you could try calling CompareFileTime() with the system plugin, but I'm not sure if it does any fuzzing...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">demiller9</div><div class="date">15th November 2011, 16:17</div></div><div class="posttext">The getfiletime/getfiletimelocal commands are ok, the problem starts in makensis: the compiler truncates file times to a 2 second resolution. I think this is so the 'ifnewer' attribute will succeed when extracting to FAT volumes.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">nughtin</div><div class="date">15th November 2011, 16:34</div></div><div class="posttext">Thanks.  Both posts are very helpful.  I'll try to figure out how to either truncate the file time to a 2 second resolution or add a fuzz factor of 4 seconds or so.  I've been having some difficulty finding documentation on doing this so if anyone knows how to do this your help would be appreciated.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">15th November 2011, 16:49</div></div><div class="posttext">It might be a bug if makensis fuzzes the time and the exehead does not</div></div><hr />


<div class="post"><div class="posttop"><div class="username">nughtin</div><div class="date">15th November 2011, 17:32</div></div><div class="posttext">Thanks for the help.  I think I got this working.  Let me know if you see anything wrong.<br />
<br />
<br />
!macro ConvertFileTimeToInt64 out high low<br />
  System::Int64Op ${high} * 4294967296<br />
  Pop ${out}<br />
  System::Int64Op ${out} + ${low}<br />
  Pop ${out}<br />
  System::Int64Op  ${out} / 10000000<br />
  Pop ${out}<br />
!macroend<br />
<br />
...<br />
<br />
  GetFileTime ${destfile} $R0 $R1 ; File it will be replacing<br />
  !insertmacro ConvertFileTimeToInt64 $R2 $R0 $R1<br />
  GetFileTimeLocal ${localfile} $R0 $R1 ; File to install<br />
  !insertmacro ConvertFileTimeToInt64 $R3 $R0 $R1<br />
  System::Int64Op $R3 - $R2<br />
  Pop $R4<br />
  DetailPrint &quot;Existing File=${destfile}&quot;<br />
  DetailPrint &quot;Existing File=$R0&quot;<br />
;  DetailPrint &quot;New File=${localfile}&quot;<br />
  DetailPrint &quot;New File.....=$R2&quot;<br />
  DetailPrint &quot;Difference...=$R3&quot;<br />
  IntCmp $R4 4 &quot;installlibbydate.skip_${INSTALLLIBBYDATE_UNIQUE}&quot; &quot;installlibbydate.skip_${INSTALLLIBBYDATE_UNIQUE}&quot; &quot;installlibbydate.start_${INSTALLLIBBYDATE_UNIQUE}&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">15th November 2011, 18:26</div></div><div class="posttext">Why are you not using &quot;SetOverwrite ifnewer&quot; and letting NSIS take care of it for you? (There is a bug here also but it will be fixed when we figure out what to do about it)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">nughtin</div><div class="date">15th November 2011, 18:45</div></div><div class="posttext">These are COM DLL's that need to be unregistered if it is determined that the file is newer.  We will only use this method for DLL's that our company writes.  We can't go based on the DLL version because it doesn't always change between builds.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>