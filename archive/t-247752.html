<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" a Problem for KeyBoardLayout, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  a Problem for KeyBoardLayout NSIS Discussion" />
	
	<title> a Problem for KeyBoardLayout [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  a Problem for KeyBoardLayout</div>
<hr />
<div class="pda"><a href="t-247752.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=247752">a Problem for KeyBoardLayout</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">huq.duote.com</div><div class="date">3rd June 2006, 14:55</div></div><div class="posttext">I want to Add a New KeyBoardLayout to Operating System<br />
<br />
But I cant' Acctive it!<br />
<br />
BY API:<br />
<br />
System::Call &quot;user32::LoadKeyboardLayout(t &quot;0000040a&quot;,l 0x00000001)&quot;<br />
<br />
<br />
please help me!<br />
<br />
how can i write This APi Fuction!<br />
<br />
Thanks</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">3rd June 2006, 14:59</div></div><div class="posttext">You'd also need to call:<br />
http://msdn.microsoft.com/library/default.asp?url=/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/unloadkeyboardlayout.asp<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">huq.duote.com</div><div class="date">3rd June 2006, 15:04</div></div><div class="posttext">sorry!<br />
i can't use API IN NSIS<br />
can you show me the example?<br />
thank you very much!<br />
you help me always!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">3rd June 2006, 22:17</div></div><div class="posttext">You've got the quotes wrong. You use double quotes for both the internal strings and the entire string itself. You're also using a 64-bit integer as the second parameter, instead of a 32-bit integer. Use:System::Call &quot;user32::LoadKeyboardLayout(t '0000040a',i 0x00000001)&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">huq.duote.com</div><div class="date">5th June 2006, 14:10</div></div><div class="posttext">why do I need to UnloadkeyboardLayout<br />
?<br />
i can load keyboardlayout,but i can't active it use ctrl+shift!<br />
Do i must Unloadkeyboardlayout another keyboardLayout?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">5th June 2006, 14:31</div></div><div class="posttext">It says you need to unload the currently loaded keyboard layout first, which I'd assume you can get with GetKeyboardLayout (http://msdn.microsoft.com/library/default.asp?url=/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/getkeyboardlayout.asp).<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">huq.duote.com</div><div class="date">5th June 2006, 15:09</div></div><div class="posttext">for example:<br />
If I Want to load a keyboardlayout!<br />
I must unload another keyboardlayout first?<br />
or unload current keyboardlayout?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">5th June 2006, 15:10</div></div><div class="posttext">Unload current of course.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">huq.duote.com</div><div class="date">6th June 2006, 03:10</div></div><div class="posttext">System::Call &quot;user32::GetKeyboardLayout(i 0x0) i .r0&quot;<br />
	messagebox mb_ok $0<br />
	<br />
System::Call &quot;user32::UnloadKeyboardLayout(i r0) i .r1&quot;<br />
    messagebox mb_ok $1<br />
<br />
I can Get a value use the first function,<br />
<br />
but I can't get a value use the second function.<br />
<br />
it return 0 to me!<br />
<br />
how can i write the second function to unload keyBoardLayout?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">6th June 2006, 09:13</div></div><div class="posttext">Try:System::Call &quot;user32::UnloadKeyboardLayout(i r0) i .r1 ?e&quot;<br />
Pop $2Now $2 contains the error code from that call. According to MSDN (http://msdn.microsoft.com/library/default.asp?url=/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/unloadkeyboardlayout.asp):If the function fails, the return value is zero. The function can fail for the following reasons:<br />
<br />
    * An invalid input locale identifier was passed.<br />
    * The input locale identifier was preloaded.<br />
    * The input locale identifier is in use.You can then get a list of error codes here (http://msdn.microsoft.com/library/default.asp?url=/library/en-us/debug/base/system_error_codes.asp)<br />
CF</div></div><hr />


<div class="post"><div class="posttop"><div class="username">huq.duote.com</div><div class="date">6th June 2006, 14:47</div></div><div class="posttext">sorry!<br />
I can't append a keyboardlayout use NSIS<br />
<br />
how can i do it ?<br />
<br />
i very need to append it !<br />
<br />
thanks for all people of reply to me!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">huq.duote.com</div><div class="date">6th June 2006, 14:54</div></div><div class="posttext">System::Call &quot;Imm32.lib::ImmInstallIM(t 'c:\windows\system\jcwb.IME',t '»ù´¡Îå±ÊÊäÈë·¨') i .r1 ?e&quot;<br />
<br />
look!  this API can append a ime!<br />
but i use this is wrong!<br />
why?<br />
please help me!<br />
SOS</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">6th June 2006, 17:30</div></div><div class="posttext">You won't have .lib on there for a start.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">6th June 2006, 17:35</div></div><div class="posttext">I can Get a value use the first function,<br />
<br />
but I can't get a value use the second function.<br />
<br />
it return 0 to me!<br />
<br />
how can i write the second function to unload keyBoardLayout?The code I posted calls the GetLastError function which provides extended error information:If the function fails, the return value is zero. The function can fail for the following reasons:<br />
<br />
* An invalid input locale identifier was passed.<br />
* The input locale identifier was preloaded.<br />
* The input locale identifier is in use.You are getting '0' because the function fails. If you call it using the '?e' switch and pop the value onto $2 then you will get more information about that error. My guess is that you are trying to unload something which is in use, but you will have to get the error value from $2 and find what the actual error is from here (http://msdn.microsoft.com/library/default.asp?url=/library/en-us/debug/base/system_error_codes.asp).<br />
<br />
sorry!<br />
I can't append a keyboardlayout use NSIS<br />
<br />
how can i do it ?<br />
<br />
i very need to append it !System::Call &quot;user32::GetKeyboardLayout(i 0x0) i .r0&quot;<br />
messagebox mb_ok $0<br />
<br />
System::Call &quot;user32::UnloadKeyboardLayout(i r0) i .r1&quot;<br />
messagebox mb_ok $1I am sorry but maybe I am missing something here. You call a function that tells you what the Keyboard layout is and then you call another function that unloads that keyboard layout. Then you ask why you can't append a keyboardlayout ...<br />
<br />
I am not sure what you are after :eek: <br />
<br />
CF</div></div><hr />


<div class="post"><div class="posttop"><div class="username">huq.duote.com</div><div class="date">7th June 2006, 03:48</div></div><div class="posttext">thanks<br />
<br />
I want to append a keyboardlayout!<br />
<br />
i use unloadkeyboardlayout append!<br />
but i can't change keyboardlayout use ctrl+shift!<br />
<br />
Afrow Uk tell me i need unload a keyboardlayout!<br />
<br />
so I use getKeyBoardLayout get a hwnd.<br />
then i use unloadkeyboardlayout to unload current keyboardlayout.<br />
<br />
but i can't change keyboardlayout use ctrl+shift yet!<br />
<br />
why????<br />
<br />
if after i append a keyboardlayout to language cote!<br />
 than change keyboardlayout use ctrl+shift!<br />
<br />
how can i do it!<br />
<br />
help me!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">7th June 2006, 06:36</div></div><div class="posttext">System::Call &quot;user32::GetKeyboardLayout(i 0x0) i .r0&quot;<br />
System::Call &quot;user32::UnloadKeyboardLayout(i r0) i .r1 ?e&quot;<br />
Pop $2The UnloadKeyboardLayout fails and gives you $1=0. If you run it as shown above, it will give you extended error information on $2. What is the value of $2? Look it up on the MSDN windows error codes page (http://msdn.microsoft.com/library/default.asp?url=/library/en-us/debug/base/system_error_codes.asp). Then you will have a clue as to why the call fails. My guess is that you have only a single keyboard layout and you are trying to unload it (so you may need to load a new one with LoadKeyboardLayout (http://msdn.microsoft.com/library/default.asp?url=/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/loadkeyboardlayout.asp)), or you have multiple layouts but you are trying to unload one that is in use. Check the value of $2 and then we can figure out what's going on.<br />
CF</div></div><hr />


<div class="post"><div class="posttop"><div class="username">huq.duote.com</div><div class="date">7th June 2006, 15:03</div></div><div class="posttext">the error number is 126.<br />
my guess is that i want to unload current keyboard layout,<br />
so i can't unload it.<br />
but how can i unload the another keyboard layout?<br />
i can see the keyboardlayout in language cote!<br />
but i cant use it!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">7th June 2006, 16:14</div></div><div class="posttext">Error 126 doesn't make much sense (module not found) so it must be something else.<br />
<br />
I tried the following on my computer and it works:!define KLF_REORDER	8<br />
!define KLF_ACTIVATE	1<br />
# Get the current layout (running thread)<br />
System::Call 'user32::GetKeyboardLayout(i 0)i.r1'<br />
DetailPrint &quot;Keyboard layout is $1&quot; ; I get 67699721 for US english<br />
<br />
# Load Greek layout<br />
System::Call 'user32::LoadKeyboardLayoutA(t &quot;00000408&quot;, i ${KLF_ACTIVATE})i.r2'<br />
<br />
# Load French Layout<br />
System::Call 'user32::LoadKeyboardLayoutA(t &quot;0000040c&quot;, i ${KLF_ACTIVATE})i.r3'<br />
<br />
# Activate the Greek layout<br />
System::Call 'user32::ActivateKeyboardLayout(i 0x0408, i ${KLF_REORDER})i.r4'<br />
<br />
# Check to see that it is loaded<br />
System::Call 'user32::GetKeyboardLayout(i 0)i.r1'<br />
DetailPrint &quot;Keyboard layout is now $1&quot; ; I get 67634184 for greek<br />
<br />
# Unload the greek keyboard<br />
System::Call 'user32::UnloadKeyboardLayout(i r1)i.r2'<br />
<br />
# Activate French Layout<br />
System::Call 'user32::ActivateKeyboardLayout(i 0x040c, i ${KLF_REORDER})i.r3'<br />
<br />
# Check to see that it is loaded<br />
System::Call 'user32::GetKeyboardLayout(i 0)i.r1'<br />
DetailPrint &quot;Keyboard layout is now $1&quot; ; I get 67896332 for French layout<br />
<br />
# Unload the French keyboard<br />
System::Call 'user32::UnloadKeyboardLayout(i r1)i.r2'<br />
<br />
I can load the French and Greek keyboard layouts that I tried and they do appear at the language bar. I can also use CTRL+SHIFT to change between keyboard layouts. Once I unload them they disappear from the language bar as well :)<br />
<br />
The idea is that you can load as many layouts as you want. Use ActivateKeyboardLayout to activate any of them and then use it in your application. If you call UnloadKeyboardLayout then the layout will be gone from the language bar (ie you will not be able to activate it using CTRL-SHIFT or any other combination)<br />
<br />
CF</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">7th June 2006, 22:30</div></div><div class="posttext">I kind of liked the idea of loading keyboard layouts and wrote a small macro that will do just that. All you have to do is pass a hex string with the keyboard layout ID to the macro and it will check to see if that layout is loaded, if not it will load it and then it will activate it :)<br />
!macro LoadLangLayout LangID<br />
!define Index &quot;Line${__LINE__}&quot;<br />
  StrCpy $8 &quot;${LangID}&quot; &quot;&quot; 2<br />
  StrCpy $8 &quot;0000$8&quot;<br />
  System::Alloc ${NSIS_MAX_STRLEN}<br />
  Pop $R0<br />
  System::Call 'user32::GetKeyboardLayoutList(i ${NSIS_MAX_STRLEN}, i R0)i.r0'<br />
  StrCpy $9 1<br />
<br />
  loop-${Index}:<br />
    System::Call '*$R0(i .r1)'<br />
      IntFmt $2 &quot;%08x&quot; $1<br />
      StrCpy $3 $2 &quot;&quot; -4<br />
      StrCpy $4 &quot;0x$3&quot;<br />
      IntOp $R0 $R0 + 4<br />
    StrCmp $4 ${LangID} macro_end_${Index}<br />
    StrCmp $9 $0 loop_end-${Index}<br />
    IntOp $9 $9 + 1<br />
    Goto loop-${Index}<br />
    <br />
  loop_end-${Index}:<br />
    System::Call 'user32::LoadKeyboardLayoutA(t r8, i 1)i.r0'<br />
<br />
  macro_end_${Index}:<br />
    System::Call 'user32::ActivateKeyboardLayout(i ${LangID}, i 8)i.r0'<br />
!undef Index<br />
!macroendTo use it call the macro from within your NSIS script:!insertmacro LoadLangLayout 0x0409<br />
For a list of language Identifiers (LangID) check this (http://msdn.microsoft.com/library/default.asp?url=/library/en-us/intl/nls_238z.asp) page<br />
<br />
CF</div></div><hr />


<div class="post"><div class="posttop"><div class="username">huq.duote.com</div><div class="date">8th June 2006, 04:35</div></div><div class="posttext">the first method can append a keyboardlayout to language bar.<br />
but can't use ctrl+shift to change between layouts.<br />
<br />
the second method can't use it!<br />
<br />
why?<br />
<br />
what version is your Operating System?<br />
I use windows XP professional!<br />
<br />
MY nsis version is 2.16!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">8th June 2006, 08:11</div></div><div class="posttext">Both methods do the same thing. Both methods work for me. They both load a new keyboard layout and activate it. I am able to cycle through multiple layouts using CTRL-SHIFT. I am also using XP Pro and both methods should work on NT/2000/XP/2k3 (tested it in 2k as well and it is working fine).<br />
<br />
You do reallize that the code provided here will add the languages to the current thread, but it will not 'make' the language bar appear, ie you need to have at least two layouts active before running this code, with the language bar visible so that you will see the new layouts. Also this code will not add a hotkey combination in order to cycle through the layouts, this is something that you should do prior to running the code.<br />
<br />
What language are you trying to load? Running the last macro I posted for 0x040a (if that's what you are trying to load) I get a Spanish layout loaded.<br />
<br />
CF</div></div><hr />


<div class="post"><div class="posttop"><div class="username">huq.duote.com</div><div class="date">9th June 2006, 02:47</div></div><div class="posttext">i have three layouts on my language bar!<br />
i use your same code, i can't append any keyboardlayouts to language bar!<br />
do you know a API can refresh layouts list?<br />
i think i run short of this API Function!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">9th June 2006, 10:24</div></div><div class="posttext">Could you please post the code that you are trying to run and is not working?<br />
CF</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>