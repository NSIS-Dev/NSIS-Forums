<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Read local certificate store, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Read local certificate store NSIS Discussion" />
	
	<title> Read local certificate store [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Read local certificate store</div>
<hr />
<div class="pda"><a href="t-309032.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=309032">Read local certificate store</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">cssguy</div><div class="date">29th July 2009, 12:58</div></div><div class="posttext">Hi Team,<br />
<br />
                I am new to NSIS world.. Please help me to solve this issue.<br />
<br />
Q: How can I read a local current certificate store of windows OS ?.I need to check how many personal certificates are there for the logged in user. I have seen some vbscript examples using capicom.dll to open and read certificate information. <br />
<br />
     Is there any way to use the same dll in NSIS ? please give some input to sort out this issue.<br />
<br />
--cssguY</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">30th July 2009, 00:28</div></div><div class="posttext">If you don't want to write a wrapper dll, executable or call capicom.dll via the System plugin then you could run your VBS using ExecShell (or directly via Exec with wscript.exe).<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">3rd August 2009, 09:44</div></div><div class="posttext">You can start off with this:<br />
http://nsis.sourceforge.net/Import_Root_Certificate</div></div><hr />


<div class="post"><div class="posttop"><div class="username">f0rt</div><div class="date">4th August 2009, 18:28</div></div><div class="posttext">The following sample code lists the certificates in a store.<br />
<br />
<br />
OutFile &quot;cert.exe&quot;<br />
<br />
!include &quot;LogicLib.nsh&quot;<br />
<br />
!define CERT_STORE_CERTIFICATE_CONTEXT  1<br />
!define CERT_NAME_SIMPLE_DISPLAY_TYPE   4<br />
<br />
Function display_certs<br />
  ; Save registers<br />
  Push $1<br />
  Push $2<br />
  Push $3<br />
  Push $4<br />
<br />
  ; Open system certificate store that holds certificates with associated private keys.<br />
  System::Call &quot;crypt32::CertOpenSystemStore(i 0, t 'MY') i.r1&quot; <br />
  ${If} $1 != 0<br />
     StrCpy $2 0<br />
     ; Loop through certificate store<br />
     ${Do}<br />
         System::Call &quot;crypt32::CertEnumCertificatesInStore(i r1, i r2) i.r2&quot;<br />
         ${If} $2 != 0<br />
            System::Call &quot;crypt32::CertGetNameString(i r2, \<br />
               i ${CERT_NAME_SIMPLE_DISPLAY_TYPE}, i 0, i 0, \<br />
               t .r4, i ${NSIS_MAX_STRLEN}) i.r3&quot;<br />
            ${If} $3 != 0<br />
               ; Report certificate name<br />
               MessageBox MB_OK &quot;Certificate: $4&quot;<br />
            ${EndIf} <br />
         ${Else}<br />
            ${ExitDo}<br />
         ${EndIf}<br />
     ${Loop}<br />
     System::Call &quot;crypt32::CertCloseStore(i r1, i 0)&quot;<br />
  ${EndIf}<br />
  <br />
  ; Restore registers<br />
  Pop $4<br />
  Pop $3<br />
  Pop $2<br />
  Pop $1<br />
FunctionEnd<br />
<br />
Function .onInit<br />
  InitPluginsDir<br />
  Call display_certs<br />
  Quit<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">idna</div><div class="date">18th January 2012, 15:27</div></div><div class="posttext">You can start off with this:<br />
http://nsis.sourceforge.net/Import_Root_Certificate<br />
Hi, I have a short question regarding the &quot;Import Root Certificate&quot; script, rather than the thread's topic: is the script supposed to work when installer is executed by a non-admin windows user? Because in my case the generated installer gives me the &quot;Unable to add certificate to certificate store&quot; error which in turn leads me to &quot;crypt32::CertAddCertificateContextToStore ...&quot;; is there some workaround?<br />
<br />
Thanks in advance.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">18th January 2012, 18:55</div></div><div class="posttext">One easy way to test this would be to run your installer as admin...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">idna</div><div class="date">18th January 2012, 21:06</div></div><div class="posttext">Hi; I forgot to mention that if I run the installer as administrator or admin-like user then there is no error in the certificate import section. But I have this constraint, the installer must work for non admin users as well.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">idna</div><div class="date">19th January 2012, 14:19</div></div><div class="posttext">Me again. I modified the code in the sense that I check the user account type: if it's admin then I open the Local Machine store otherwise the Current User store and it no longer fails. The drawback is that in the second scenario, the user is prompted to choose whether to install the certificate or not, but at least it works.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>