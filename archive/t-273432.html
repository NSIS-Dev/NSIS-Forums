<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" User variable problem - sometimes works and sometimes doesn't, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  User variable problem - sometimes works and sometimes doesn't NSIS Discussion" />
	
	<title> User variable problem - sometimes works and sometimes doesn't [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  User variable problem - sometimes works and sometimes doesn't</div>
<hr />
<div class="pda"><a href="t-273432.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=273432">User variable problem - sometimes works and sometimes doesn't</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">pospec</div><div class="date">26th June 2007, 08:53</div></div><div class="posttext">Hello NSISers!<br />
<br />
I'd like to discuss decent problem. I've put the &quot;registry&quot; part of my install script into separate file (e.g. registry.nsi). That file is !included in my &quot;main&quot; .nsi file. I use function ZapisRegistry to do all the reg's work.<br />
<br />
Main script:<br />
<br />
...<br />
Section Install<br />
  ...<br />
  Call ZapisRegistry<br />
  ...<br />
SectionEnd<br />
...<br />
<br />
Auxiliary script:<br />
<br />
!macro ZapisReg type root hive key value<br />
...<br />
!macroend<br />
...<br />
Var AktualniKlic<br />
Function ZapisRegistry<br />
  ...<br />
  StrCpy $AktualniKlic &quot;Software\Microsoft&quot;     ; i am not a M$ guy<br />
  MessageBox MB_OK $AktualniKlic   ; JUST TO BE SURE<br />
  ...<br />
  ; REGISTRY WORKAROUND<br />
FunctionEnd  <br />
...<br />
<br />
Now, everything works OK.<br />
<br />
But if I add ANOTHER ONE macro into my auxiliary script, the variable $AktualniKlic will be empty after the StrCpy instruction.<br />
<br />
What am I doing wrong? :( <br />
<br />
PS: &quot;Zapis&quot; means something like &quot;Write&quot; ;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pospec</div><div class="date">26th June 2007, 09:23</div></div><div class="posttext">The previously mentioned function &quot;ZapisRegistry&quot; looks like this:<br />
<br />
MessageBox MB_OK &quot;Registry start&quot;<br />
<br />
!insertmacro ZapisReg ...<br />
!insertmacro ZapisReg ...<br />
!insertmacro ZapisReg ...<br />
<br />
MessageBox MB_OK &quot;Phase 1 completed&quot;<br />
!insertmacro ZapisReg ...<br />
<br />
MessageBox MB_OK &quot;Phase 2 completed&quot;<br />
!insertmacro ZapisReg ...<br />
<br />
...<br />
 <br />
Problem is, that only the FIRST MessageBox instruction works. Any relation with that macros? :weird:</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">26th June 2007, 10:00</div></div><div class="posttext">What does the ZapisReg macro contain?<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pospec</div><div class="date">26th June 2007, 10:28</div></div><div class="posttext">Saying Hi! from Czech Republic to England Stu!<br />
<br />
!macro ZapisReg type root hive key value<br />
  ClearErrors<br />
  StrCmp ${type} 'str' 0 +2<br />
    WriteRegStr '${root}' '${hive}' '${key}' '${value}'<br />
  StrCmp ${type} 'dword' 0 +2<br />
    WriteRegDword '${root}' '${hive}' '${key}' '${value}'<br />
  IfErrors 0 +3 <br />
    MessageBox MB_ICONEXCLAMATION|MB_OK &quot;ERRRORRR!&quot;<br />
    ; Abort &quot;Chyba - neni pristup k registrum&quot;<br />
!macroend<br />
<br />
The second macro should contain something like:<br />
<br />
!macro CteniReg type variable root hive key silent<br />
  ClearErrors<br />
  StrCmp ${type} 'str' 0 +2<br />
    ReadRegStr ${variable} '${root}' '${hive}' '${key}'<br />
  StrCmp ${type} 'dword' 0 +2<br />
    ReadRegDWORD ${variable} '${root}' '${hive}' '${key}'<br />
  IfErrors 0 +3<br />
    IntCmp ${silent} 1 +2 0<br />
    MessageBox MB_ICONEXCLAMATION|MB_OK &quot;ERRRORRR!&quot;<br />
    ;Abort &quot;Chyba - neni pristup k registrum&quot;<br />
!macroend<br />
<br />
<br />
Do you think that this makes the bug?<br />
<br />
BTW: This is not the only mystical behavior of NSIS that I noticed today. E.g. I compiled script and after runnig it, the script executed some function ITSELF, then I added one debug MessageBox and everything behaves normally, even if I remove the MB and compile again... No conditional jumps involved. I am being little bit confused from NSIS today.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">darthvader</div><div class="date">26th June 2007, 10:36</div></div><div class="posttext">Hey! <br />
<br />
!macro ZapisReg type root hive key value<br />
  ClearErrors<br />
  StrCmp ${type} 'str' 0 +2<br />
    WriteRegStr '${root}' '${hive}' '${key}' '${value}'<br />
  StrCmp ${type} 'dword' 0 +2<br />
    WriteRegDword '${root}' '${hive}' '${key}' '${value}'<br />
  IfErrors 0 +3 <br />
    MessageBox MB_ICONEXCLAMATION|MB_OK &quot;ERRRORRR!&quot;<br />
    ; Abort &quot;Chyba - neni pristup k registrum&quot;<br />
!macroend<br />
<br />
<br />
IfErrors 0 +3 ;This statement is wrong <br />
<br />
it should be<br />
<br />
IfErrors 0 +2 ;This statement is right<br />
<br />
Since you are jumping to the wrong location this program would behave abnormally.<br />
<br />
I hope this helps</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pospec</div><div class="date">26th June 2007, 10:47</div></div><div class="posttext">I cannot jump to !macroend line?<br />
<br />
And can I jump to commented line?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">darthvader</div><div class="date">26th June 2007, 10:51</div></div><div class="posttext">I think you can jump to a !macroend. Have you tried it? <br />
No, you cant jump to a commented line<br />
<br />
+1 - this means goto the next instruction<br />
+2 - this means goto the next next instruction <br />
<br />
and so on.<br />
<br />
Just give it a try.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DrDan</div><div class="date">26th June 2007, 10:56</div></div><div class="posttext">Use goto labels instead of instruction numbers jumps - far less confusing.<br />
<br />
<br />
!macro ZapisReg type root hive key value<br />
ClearErrors<br />
StrCmp ${type} 'str' 0 +2<br />
WriteRegStr '${root}' '${hive}' '${key}' '${value}'<br />
StrCmp ${type} 'dword' 0 +2<br />
WriteRegDword '${root}' '${hive}' '${key}' '${value}'<br />
IfErrors 0 ZapisReg_End<br />
MessageBox MB_ICONEXCLAMATION|MB_OK &quot;ERRRORRR!&quot;<br />
; Abort &quot;Chyba - neni pristup k registrum&quot;<br />
ZapisReg_End:<br />
!macroend</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pospec</div><div class="date">26th June 2007, 11:09</div></div><div class="posttext">thank you all!<br />
<br />
but I think, that using labels in macros isn't good idea. what if the macro will be called more than 1 time?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DrDan</div><div class="date">26th June 2007, 16:20</div></div><div class="posttext">One way round this is to define a &quot;UniqueID&quot; as in here: http://nsis.sourceforge.net/Tutorial:_Using_labels_in_macro%27s<br />
<br />
The only flaw is if you use one macro inside another that both define this UniqueID. To get around that, I just prepend the name of the macro like this:<br />
<br />
!macro ZapisReg type root hive key value<br />
!define ZapisReg_UniqueID ${__LINE__}<br />
ClearErrors<br />
StrCmp ${type} 'str' 0 +2<br />
WriteRegStr '${root}' '${hive}' '${key}' '${value}'<br />
StrCmp ${type} 'dword' 0 +2<br />
WriteRegDword '${root}' '${hive}' '${key}' '${value}'<br />
IfErrors 0 ZapisReg_End_${ZapisReg_UniqueID}<br />
MessageBox MB_ICONEXCLAMATION|MB_OK &quot;ERRRORRR!&quot;<br />
; Abort &quot;Chyba - neni pristup k registrum&quot;<br />
ZapisReg_End_${ZapisReg_UniqueID}:<br />
!undef ZapisReg_UniqueID<br />
!macroend<br />
<br />
<br />
Not very nice, I know, but sometimes the only way to do it.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pospec</div><div class="date">26th June 2007, 18:24</div></div><div class="posttext">that seems nice, but I will do with the line-skip method<br />
<br />
but thank you DrDan, you seem like hardcore NSISer ;-)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">27th June 2007, 11:48</div></div><div class="posttext">No point using labels here. Things to remember with relative jumps...<br />
<br />
They jump over real instructions only, not compile time ones such as !define or !insertmacro.<br />
They do not take into account blank lines or comments (why should it?)<br />
<br />
This will not work as expected:<br />
!macro blah<br />
Sleep 1000<br />
Sleep 1000000<br />
!macroend<br />
<br />
Goto +2<br />
!insertmacro blah<br />
<br />
This will skip Sleep 1000 but not Sleep 1000000.<br />
<br />
Stu</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>