<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Macro problem..., media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Macro problem... NSIS Discussion" />
	
	<title> Macro problem... [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Macro problem...</div>
<hr />
<div class="pda"><a href="t-139880.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=139880">Macro problem...</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">23rd June 2003, 20:00</div></div><div class="posttext">Ok, I get this typical error message on compile...<br />
<br />
Error: label &quot;getpart1_loop:&quot; already declared in section/function<br />
Error in macro SPLIT_STRING on macroline 9<br />
Error in script &quot;C:\Program Files\NSIS\mappackager\mappackager.nsi&quot; on line 1250 -- aborting creation process<br />
<br />
<br />
And here is the macro...<br />
http://nsis.sourceforge.net/archive/nsisweb.php?page=330&amp;instances=0,11,122<br />
<br />
Can anyone see what is wrong with the macro, because I can only see one &quot;getpart1_loop&quot; label in the whole macro!<br />
<br />
Is this some sort of NSIS bug?<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pengyou</div><div class="date">23rd June 2003, 20:58</div></div><div class="posttext">Every time you use<br />
<br />
!insertmacro blah blah<br />
<br />
the NSIS compiler will replace the !insertmacro line with the contents of the macro (everything between !macro and !macroend).<br />
<br />
The first time you use that macro from the archive, the compiler will insert several labels (getpart1_loop, getpart2_top etc).<br />
<br />
If you use that macro again later in your script, the compiler will insert the same labels ... and then give you that error message because those labels have already been used in your script (they got used the first time you used the !insertmacro line for that macro).<br />
<br />
If you want to use labels in a macro, you need to ensure that every time you use the macro you create unique labels.<br />
<br />
The &quot;UpgradeDLL&quot; macro in Appendix B of the NSIS user manual shows one way to use labels inside a macro. The secret is to use a parameter to the macro to generate unique labels, such as &quot;upgrade_${PARAM}:&quot;<br />
<br />
Hope this helps.<br />
<br />
Brian</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">24th June 2003, 16:20</div></div><div class="posttext">Thanks, works ok now.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">25th June 2003, 18:29</div></div><div class="posttext">I just found another problem now with my macro...<br />
Doing Push $R1 (at front) and Pop $R1 (at end) does not work at all.<br />
After calling the macro, $R1 is not the same as it was before I called the macro.<br />
<br />
Is this a bug?<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pengyou</div><div class="date">25th June 2003, 18:56</div></div><div class="posttext">I think the problem with $R1 is more to do with how you are using the macro than with the macro itself.<br />
<br />
When I tried this:<br />
<br />
StrCpy $R1 &quot;Initialised&quot;<br />
MessageBox MB_OK &quot;&gt;$R1&lt; (before)&quot;<br />
!insertmacro SPLIT_STRING ${TEST} 1<br />
Pop ${RESULT}<br />
MessageBox MB_OK &quot;&gt;$R1&lt; (after}&quot;<br />
<br />
I found $R1 was left unchanged by the macro.<br />
<br />
Brian</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">25th June 2003, 23:00</div></div><div class="posttext">Strange.<br />
I was using $R1 before it.<br />
Before, $R1 was &quot;textures/e1u1\metal2_2.wal|gbrdday1.map&quot;<br />
After, $R1 became &quot;|&quot; (because | is the character to signify done)<br />
<br />
I changed to using $R2 instead of $R1, and that fixed it.<br />
I'm also using latest cvs, so this was a bit strange!<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pengyou</div><div class="date">25th June 2003, 23:58</div></div><div class="posttext">I think it might be safer to turn the macro into a function and pass the INPUT and PART on the stack. If you use the macro to process $R1 by using !insertmacro SPLIT_STRING $R1 2 then the first loop in the macro<br />
<br />
getpart1_loop_${PART}:<br />
 IntOp $R0 $R0 - 1<br />
 StrCpy $R1 ${INPUT} 1 $R0<br />
<br />
will get compiled as<br />
<br />
getpart1_loop_2:<br />
 IntOp $R0 $R0 - 1<br />
 StrCpy $R1 $R1 1 $R0<br />
<br />
which means that the rest of the macro will be working on incorrect data - in this case the macro will return an error.<br />
<br />
Brian</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pengyou</div><div class="date">26th June 2003, 12:45</div></div><div class="posttext">If the main reason for creating the SPLIT_STRING macro was to help when you run out of registers, it might be a lot easier to use an INI file to store the extra data. When you run out of registers, you could save some of them in the INI file, use those registers for different data then save that data in the INI file and restore those registers to their previous values. This process can be repeated as often as is necessary.<br />
<br />
An example might make this idea clearer.<br />
<br />
Here are some macros to save and restore data from an INI file:<br />
<br />
!macro SAVE_REGISTER REGISTER DATA_NAME<br />
  WriteINIStr &quot;$PLUGINSDIR\ioA.ini&quot; &quot;Installer Variables&quot; &quot;${DATA_NAME}&quot; &quot;${REGISTER}&quot;<br />
!macroend<br />
<br />
!macro LOAD_REGISTER DATA_NAME REGISTER<br />
  ReadINIStr ${REGISTER} &quot;$PLUGINSDIR\ioA.ini&quot; &quot;Installer Variables&quot; &quot;${DATA_NAME}&quot;<br />
!macroend <br />
<br />
There is no need to use a special INI file for this data; if you already have an INI file defining a custom page, you could use it instead of 'ioA.ini' in the above macros (InstallOptions will ignore the [Installer Variables] section in the INI file).<br />
<br />
Here is how these macros could be used:<br />
<br />
; Code using $0, $1 and $2 to handle passwords<br />
; Now we need to do some map work but have no unused registers<br />
; so we save some registers in the INI file<br />
<br />
!insertmacro SAVE_REGISTER $0 &quot;Email&quot;<br />
!insertmacro SAVE_REGISTER $1 &quot;Password&quot;<br />
!insertmacro SAVE_REGISTER $2 &quot;Result&quot;<br />
  <br />
; Now we can use $0, $1 and $2 for something completely different<br />
; When we are finished, we can save this new data in the INI file<br />
<br />
!insertmacro SAVE_REGISTER $0 &quot;Map folder&quot;<br />
!insertmacro SAVE_REGISTER $1 &quot;Map name&quot;<br />
!insertmacro SAVE_REGISTER $2 &quot;Texture ID&quot;<br />
<br />
; Now restore registers $0, $1 and $2 to their previous values<br />
<br />
!insertmacro LOAD_REGISTER &quot;Email&quot; $0<br />
!insertmacro LOAD_REGISTER &quot;Password&quot; $1<br />
!insertmacro LOAD_REGISTER &quot;Result&quot; $2<br />
<br />
Using an INI file to store variables can also help when you are testing/debugging as you can examine the INI file while the installer is running.<br />
<br />
I hope this idea makes sense.<br />
Brian</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">26th June 2003, 12:52</div></div><div class="posttext">Support for unlimited user variables ($USER) will be added very soon, so this problem will be solved anyway :)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>