<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Problem with Plugin built on MinGW, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Problem with Plugin built on MinGW NSIS Discussion" />
	
	<title> Problem with Plugin built on MinGW [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Problem with Plugin built on MinGW</div>
<hr />
<div class="pda"><a href="t-367799.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=367799">Problem with Plugin built on MinGW</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">parasoul</div><div class="date">1st August 2013, 06:22</div></div><div class="posttext">Hello!<br />
I'm having an issue when creating a plugin on MinGW compiler. Keep in mind this worked fine with Borland compiler, but I prefer MinGW beacuse Borland conflicts too much with what I need to do. I made a very simple plugin so we can easily identify the problem.<br />
<br />
The IDE I'm using is CodeBlocks by the way<br />
<br />
Basically the problem is that when I try and compile the NSIS script, NSIS does not recognize my plugin<br />
<br />
NSIS says : &quot;Invalid command: test::test&quot;<br />
<br />
NSIS Script (relevant portion):<br />
<br />
Section &quot;iniz&quot;<br />
test::test &quot;hi&quot;<br />
SectionEnd<br />
<br />
<br />
Plugin code :<br />
<br />
<br />
#include &lt;windows.h&gt;<br />
#include &lt;fcntl.h&gt;<br />
#include &lt;cstdio&gt;<br />
#include &lt;stdio.h&gt;<br />
#include &quot;nsis_ansi\pluginapi.h&quot;<br />
<br />
#define NSISFUNC(name) void __declspec(dllexport) name(HWND hWndParent, int string_size, char* variables, stack_t** stacktop, extra_parameters* extra)<br />
extra_parameters* ep;<br />
HANDLE g_hInstance;<br />
static unsigned int g_stringsize;<br />
static stack_t **g_stacktop;<br />
static char *g_variables;<br />
<br />
static int __stdcall popstring(char *str)<br />
{<br />
  stack_t *th;<br />
  if (!g_stacktop || !*g_stacktop) return 1;<br />
  th=(*g_stacktop);<br />
  lstrcpyA(str,th-&gt;text);<br />
  *g_stacktop = th-&gt;next;<br />
  GlobalFree((HGLOBAL)th);<br />
  return 0;<br />
}<br />
<br />
NSISFUNC(test)<br />
{<br />
	g_stacktop = stacktop;<br />
	popstring(variables);<br />
	MessageBox(0,0,variables,0);<br />
<br />
}<br />
<br />
BOOL WINAPI DllMain(HANDLE hInst,<br />
              ULONG ul_reason_for_call,<br />
              LPVOID lpReserved)<br />
{<br />
  g_hInstance = hInst;<br />
  return TRUE;<br />
}<br />
<br />
<br />
<br />
<br />
Generated DLL:<br />
http://www2.zippyshare.com/v/50606317/file.html<br />
I see the &quot;test&quot; export in the DLL, but I'm not exactly sure what NSIS does to identify the function in the library.<br />
<br />
Any help you people could offer would be so hugely appreciated!<br />
<br />
Thank you</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">1st August 2013, 16:44</div></div><div class="posttext">Use dependencywalker (http://www.dependencywalker.com/), you will see that your exported function has a decorated name. Changing void __declspec(dllexport) to extern &quot;C&quot; void __declspec(dllexport) might help, if not, check your compilers manual to figure out how to export functions without the decorations or use a .def file...<br />
<br />
Note: NSIS does not care if your plugin call is test::_test_foo_bar@8 or whatever but it looks really ugly.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">parasoul</div><div class="date">1st August 2013, 19:38</div></div><div class="posttext">Awesome Anders, adding extern &quot;C&quot; worked. Also if I put the entire name of the export, that worked also. But the former is much cleaner. Thanks very much!</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>