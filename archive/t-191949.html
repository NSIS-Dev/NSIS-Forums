<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" System::Call  is not working with Win98, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  System::Call  is not working with Win98 NSIS Discussion" />
	
	<title> System::Call  is not working with Win98 [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  System::Call  is not working with Win98</div>
<hr />
<div class="pda"><a href="t-191949.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=191949">System::Call  is not working with Win98</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Gurleen</div><div class="date">31st August 2004, 00:04</div></div><div class="posttext">I have a custom Dll, that I use with System::Call . It works fine with 2000 , 2003 and XP , but it does not work with win98. Is it a problem with  my Dll or with System:Call compatability with win98. <br />
<br />
Eg:<br />
<br />
System::Call 'InstLibrary::isValidProductKey(t r1)i .r2'<br />
IntCmp $2 1 validKey<br />
MessageBox MB_OK|MB_ICONSTOP &quot;Key Not valid!!!&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">KrYpT</div><div class="date">31st August 2004, 05:41</div></div><div class="posttext">System::Call should work on Win98, AFAIK. What exactly is going wrong? (I think you can pop an error message from the stack if System::Call fails.) Also maybe check your search path; I know the different operating systems use different search paths, and that may stop it from finding your DLL.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joel</div><div class="date">31st August 2004, 14:50</div></div><div class="posttext">What's r1? Maybe some attachment I can try it in my old Win98?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gurleen</div><div class="date">31st August 2004, 15:15</div></div><div class="posttext">I copy the dll to a temp directory. The I set the SetOutPath to that location so that system::call can  see my dll</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gurleen</div><div class="date">31st August 2004, 15:21</div></div><div class="posttext">r1 is a string . It's a product key . I use a function in the dll to check if it's a valid key . The problem is not with the function as I tried caling several other function in the dll and none gets called.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gurleen</div><div class="date">31st August 2004, 15:35</div></div><div class="posttext">The odd thing is that there is no error also . It skips the  iferrors statement and dies on IntCmp statement. The output from the  MessageBox MB_OK|MB_ICONSTOP &quot; Output: $2&quot;<br />
is &quot; Output: error&quot; . Hope this may shed some light on the problem.<br />
<br />
<br />
clearerrors<br />
; check if the product key is valid<br />
System::Call 'InstLibrary::isValidProductKey(t r1) i .r2'<br />
MessageBox MB_OK|MB_ICONSTOP &quot; Output: $2&quot;<br />
iferrors 0 moveNextInst<br />
MessageBox MB_OK|MB_ICONSTOP &quot;  Error in System Call:&quot;<br />
quit<br />
moveNextInst:   <br />
IntCmp $2 1 validKey<br />
MessageBox MB_OK|MB_ICONSTOP &quot;Key Not valid!!!&quot;<br />
Quit</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joel</div><div class="date">31st August 2004, 15:52</div></div><div class="posttext">Sorry... same :/<br />
<br />
From this view, I don't see problems with your last post code.... I'm still confised about r1, can you post how r1 become string?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">zimsms</div><div class="date">31st August 2004, 15:53</div></div><div class="posttext">Sounds like a &quot;no unicode support&quot; error. Try installing unicows.dll (The win9x unicode support library) onto your 95/98/ME, NT4 box, then try again.<br />
<br />
Those platforms listed above don't support unicode fully, and if your dll calls any unicode function, or was compiled with unicode support on a box that supports unicode, your dll may not function on these OSes.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gurleen</div><div class="date">31st August 2004, 16:19</div></div><div class="posttext">Now you cans ee where the value is coming from. It's a custom Page that asks for a username and a password. But that should have no effect on the outcome of the system:call<br />
<br />
******************************************************* <br />
Push ${TEMP1}<br />
InstallOptions::dialog $PLUGINSDIR\CustomDialog.ini<br />
Pop ${TEMP1}<br />
StrCmp ${TEMP1} &quot;success&quot; 0 continue<br />
; get the values of the Name and Product key<br />
ReadINIStr $0 &quot;$PLUGINSDIR\CustomDialog.ini&quot; &quot;Field 1&quot; &quot;State&quot;<br />
<br />
ReadINIStr $1 &quot;$PLUGINSDIR\CustomDialog.ini&quot; &quot;Field 3&quot; &quot;State&quot;<br />
  <br />
strcmp $debugMode &quot;Yes&quot; 0 +2<br />
MessageBox MB_OK|MB_ICONSTOP &quot; $\nName: $0 $\nKEY: $1&quot;<br />
clearerrors<br />
; check if the product key is valid<br />
System::Call 'InstLibrary::isValidProductKey(t r1) i .r2'<br />
MessageBox MB_OK|MB_ICONSTOP &quot; Output: $2&quot;<br />
iferrors 0 moveNextInst<br />
MessageBox MB_OK|MB_ICONSTOP &quot;  Error in System Call:&quot;<br />
quit<br />
moveNextInst:   <br />
IntCmp $2 1 validKey<br />
MessageBox MB_OK|MB_ICONSTOP &quot;Key Not valid!!!&quot;<br />
Quit<br />
validKey:<br />
Strcpy  $UserName $0<br />
StrCpy $Key $1<br />
*******************************************************</div></div><hr />


<div class="post"><div class="posttop"><div class="username">KrYpT</div><div class="date">31st August 2004, 16:56</div></div><div class="posttext">I have no idea why this would work on any OS, but is your dll function _stdcall or _cdecl?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gurleen</div><div class="date">31st August 2004, 17:10</div></div><div class="posttext">I use stdcall  for my functions . This is what I use.<br />
<br />
extern &quot;C&quot; int __stdcall isValidProductKeyNSIS( const char *productKey )</div></div><hr />


<div class="post"><div class="posttop"><div class="username">KrYpT</div><div class="date">31st August 2004, 17:20</div></div><div class="posttext">Is there any difference between isValidProductKey and isValidProductKeyNSIS? (and shouldn't that declaration have included a __declspec(dllexport)?)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joel</div><div class="date">31st August 2004, 18:51</div></div><div class="posttext">Try from this:<br />
<br />
System::Call 'InstLibrary::isValidProductKey(t r1) i .r2'<br />
<br />
To this:<br />
<br />
System::Call 'InstLibrary::isValidProductKey(t &quot;$1&quot;) i .r2'<br />
<br />
<br />
/edit: Forgot the &quot;'s</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gurleen</div><div class="date">31st August 2004, 19:24</div></div><div class="posttext">-Is there any difference between isValidProductKey and     isValidProductKeyNSIS? (and shouldn't that declaration have included a __declspec(dllexport)?)<br />
<br />
Well I use a .def file for exporting the functions, the function name was just a misspell in the previous post , sorry about that<br />
*****************************************************<br />
<br />
&quot;Lobo Lunar&quot;<br />
System::Call 'InstLibrary::isValidProductKey(t &quot;$1&quot;) i .r2'<br />
<br />
Well  what did you wanted me to do with the &quot;'s .Also the coe that I am using works fine with ME,2000, XP  So i think there is nothing wrong with the syntax. It's just that maybe my installer cannot locate the dll.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joel</div><div class="date">31st August 2004, 19:36</div></div><div class="posttext">Well what did you wanted me to do with the &quot;'s <br />
<br />
Nowhere :/<br />
<br />
Is just my personal not that I forgot to include the &quot;.<br />
If the path is the problem, then you should try use the InitpluginsDir</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gurleen</div><div class="date">31st August 2004, 19:46</div></div><div class="posttext">I do use the InitpluginsDir</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joel</div><div class="date">31st August 2004, 19:58</div></div><div class="posttext">Then... I rest my case.... :/</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">31st August 2004, 20:06</div></div><div class="posttext">If $2 is &quot;error&quot; after the call, System.dll couldn't find or load the DLL or the address of the requested function.<br />
<br />
I suggest you try loading the DLL using a call to kernel32::LoadLibrary with the ?e flag and see what you get.<br />
<br />
It's probably a missing import.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gurleen</div><div class="date">31st August 2004, 20:34</div></div><div class="posttext">Can you tell me the full command name. Also where is the manual for system dll ( like the info on return values etc)<br />
This looks like a  good lead.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">31st August 2004, 20:38</div></div><div class="posttext">Which command name? LoadLibrary? That's already the full name.<br />
<br />
The documentation is, as always, in Contrib\&lt;Plug-in name&gt;. In this case, Contrib\System\System.txt or System.html if you're using the latest CVS version.<br />
<br />
You should also take a look at:<br />
<br />
http://forums.winamp.com/showthread.php?s=&amp;threadid=180856&amp;highlight=system+documentation</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gurleen</div><div class="date">31st August 2004, 20:43</div></div><div class="posttext">So I need to load the dll first with kernel32::LoadLibrary <br />
and then call system::call</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">31st August 2004, 20:47</div></div><div class="posttext">No. You should use LoadLibrary and the ?e flag to see if you get any error. If you get an error, you know something went wrong with loading the DLL and you also have the error code.<br />
<br />
It's a test, not a solution.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gurleen</div><div class="date">31st August 2004, 21:03</div></div><div class="posttext">You mean something like this<br />
<br />
System::Call 'kernel32::LoadLibrary(t &quot;${INSTALLERDLL}\ApplianzInstallerLibrary.dll&quot; ) v ?e'<br />
and then pop the stack</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">31st August 2004, 21:07</div></div><div class="posttext">Yes. But I'd get the return value too, just to make sure you get all the details.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gurleen</div><div class="date">31st August 2004, 21:18</div></div><div class="posttext">What is the function prototype for Kernel::LoadDll<br />
Does it return a int or a pointer to an Int.<br />
<br />
System::Call 'kernel32::LoadLibrary(t &quot;${INSTALLERDLL}\ApplianzInstallerLibrary.dll&quot; ) i .r4 ? e'<br />
<br />
                           OR<br />
<br />
System::Call 'kernel32::LoadLibrary(t &quot;${INSTALLERDLL}\ApplianzInstallerLibrary.dll&quot; ) !i .r4 ?e'</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">31st August 2004, 21:23</div></div><div class="posttext">It returns HMODULE which you should treat as an integer.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gurleen</div><div class="date">31st August 2004, 21:33</div></div><div class="posttext">When I pop the variable I get the result 1157 . The return value is 0. <br />
<br />
System::Call 'kernel32::LoadLibrary(t &quot;${INSTALLERDLL}\ApplianzInstallerLibrary.dll&quot; ) i .r4 ? e'<br />
  POP $5<br />
MessageBox MB_OK|MB_ICONSTOP &quot;Library Loadinjg Message: $5 , return value : $4&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">31st August 2004, 21:43</div></div><div class="posttext">From WinError.h:<br />
<br />
#define ERROR_DLL_NOT_FOUND              1157L</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gurleen</div><div class="date">31st August 2004, 22:14</div></div><div class="posttext">So how do I get system:: to see my dll . I have tried putting it in system folder , system32 , windows . What can it be ?<br />
I am dining the temp dir as :<br />
<br />
!define INSTALLERDLL &quot;$TEMP\eInspect&quot;<br />
<br />
The I copy the dll with these commands<br />
<br />
SetOutPath ${INSTALLERDLL}<br />
File C:\ApplianzDevWorkingFolder\Client\ApplianzInstallerLibrary\Debug\ApplianzInstallerLibrary.dll<br />
<br />
SetOutPath ${INSTALLERDLL}<br />
 System::Call 'ApplianzInstallerLibrary::isValidProductKeyNSIS(t r1) i .r2'</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">31st August 2004, 22:22</div></div><div class="posttext">Hmm... Lets skip this method, seems not so reliable. Go to Start-&gt;Run and type:<br />
<br />
regsvr32 &quot;C:\ApplianzDevWorkingFolder\Client\ApplianzInstallerLibrary\Debug\ApplianzInstal<br />
lerLibrary.dll&quot;<br />
<br />
What does the error message say?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gurleen</div><div class="date">31st August 2004, 22:29</div></div><div class="posttext">Well I am attching the screenshot of what I got after running the command.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">31st August 2004, 22:33</div></div><div class="posttext">That looks like XP. Didn't you say your problem is on Windows 98?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gurleen</div><div class="date">31st August 2004, 22:38</div></div><div class="posttext">Sorry for that.  I did not realise I was  running the command on Xp . Well when I ran that on win98 it said &quot;Bdd Command&quot; . Does that mean that I am missing  some basic libraries on 98 .</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">31st August 2004, 22:41</div></div><div class="posttext">No, it probably means the path is not set right. Anyway, lets just skip the testing part and assume it is a missing import. Use Dependency Walker on the DLL (from Windows 98) and see what it's missing.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gurleen</div><div class="date">31st August 2004, 22:44</div></div><div class="posttext">Well I did run it. It gave the following error</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">31st August 2004, 22:47</div></div><div class="posttext">Taken from:<br />
<br />
http://support.microsoft.com/default.aspx?scid=kb;en-us;249873<br />
<br />
LoadLibrary(&quot;Dllname&quot;) failed. GetlastError returns 0x00000485<br />
<br />
From Winerror.h, 0x00000485 = 1157 (ERROR_DLL_NOT_FOUND), which means &quot;One of the library files needed to run this application cannot be found.&quot; For example, typing regsvr32 missing.dll returns this error message if the Missing.dll file is not found.So it really is a missing import. Use Dependecy Walker to find out which one it is.<br />
<br />
[edit] hmm... misread that... seems like it can't find the DLL. Assuming the DLL is really located in C:\, I'd still say it's a missing import.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">KrYpT</div><div class="date">31st August 2004, 22:48</div></div><div class="posttext">My two bits: Why are you tring to use the debug version of the DLL? Maybe switching to a release version would help.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gurleen</div><div class="date">31st August 2004, 22:53</div></div><div class="posttext">I ran the Depends and it says I am missing msi.dll</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">31st August 2004, 22:56</div></div><div class="posttext">Then you must require the user to install MSI (http://www.microsoft.com/downloads/details.aspx?FamilyID=cebbacd8-c094-4255-b702-de3bb768148f&amp;displaylang=en), or, the more reasonable solution, remove that dependency as it makes no sense. You're already using NSIS, why would you need MSI?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gurleen</div><div class="date">31st August 2004, 23:03</div></div><div class="posttext">Well in the end it required MSI.dll . But why would it require MSI.dll . I just created a dll using VS6.0 . <br />
But in the end it worked.. Thats what matters. Thanks a lot for helping me out. Now I can sleep tonight. Thanks to all of you who gave their input and special thanks to &quot;kichik&quot; for meking it work.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>