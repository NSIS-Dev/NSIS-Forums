<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" EnvVarUpdate corrupts PATH, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  EnvVarUpdate corrupts PATH NSIS Discussion" />
	
	<title> EnvVarUpdate corrupts PATH [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  EnvVarUpdate corrupts PATH</div>
<hr />
<div class="pda"><a href="t-302516.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=302516">EnvVarUpdate corrupts PATH</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">cromev</div><div class="date">28th January 2009, 08:43</div></div><div class="posttext">Hi everybody,<br />
<br />
<br />
in my installer script, I issue the following command:<br />
<br />
${EnvVarUpdate} $1 &quot;PATH&quot; &quot;A&quot; &quot;HKLM&quot; ${PATH_EXTENSION_STRING}<br />
<br />
In 1 out of 20 cases, this command corrupts the PATH such that is does not append the PATH_EXTENSION_STRING but replace it. The fatal consequence is that almost no software is able to run on the affected machine.<br />
<br />
I don't suss for the life of me what's going on, the fact that it only occurs every now and again points to the suspicion that some race condition or other side effect is behind this phenomenon.<br />
<br />
Anyone any clue?<br />
<br />
<br />
Cheers,<br />
Chris</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">28th January 2009, 12:45</div></div><div class="posttext">it only happens occasionally? quaint.<br />
<br />
Only thing I can think of is adding debuggery statements (messageboxes or so) at every step of the ${EnvVarUpdate} macro/Function and see where it fails.. and hopefully figure out why.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">smarmit</div><div class="date">5th February 2009, 18:41</div></div><div class="posttext">Hi. What I've discovered may or may not be the same reason your PATH gets corrupted. <br />
<br />
There is a limit to the length of the PATH variable. Normally on server types (e.g. 2003 server) that limit is 2048 characters. On XP without a hot fix or SP2, it's 1023. <br />
<br />
My QA department found that if their current PATH env var is approaching that limit, and you attempt to add anything over that limit using EnvVarUpdate, it will corrupt the PATH and remove a lot of what was there. This happens with both &quot;A&quot; for append and with &quot;P&quot; for prepend.<br />
<br />
I'm still pondering the right thing to do. Count the characters in the existing path, then determine what to do? Also looking at the EnvVarUpdate code to make the fix there (probably the right thing to do). <br />
<br />
If you tried appending or prepending more characters to the PATH via the usual Control Panel method, Windows won't allow you to do it. But given EnvVarUpdate does this via the registry directly, the checks are bypassed.<br />
<br />
So, not sure if this is what's happening to you, but beware of this anyway.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comperio</div><div class="date">6th February 2009, 05:46</div></div><div class="posttext">This is the first time I've heard about the path limitation under XP.  But then again, most places I've worked for require the latest service packs of Windows always be installed. If that's a problem, perhaps you should check for the existence of the SP or such before you try setting it over the limit. <br />
<br />
Another trick might be to figure out the short folder names (8.3 format) of the folder(s) used in the path and use that in the path variable. (The GetShortPathName (http://msdn.microsoft.com/en-us/library/aa364989(VS.85).aspx) API could be used with the system plugin to get that info.)<br />
<br />
Also make sure you use the  large strings (http://nsis.sourceforge.net/Special_Builds) version of NSIS to deal with strings longer than 1024 characters, or you may run into similar problems even on a &quot;patched&quot; version of windows.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">cromev</div><div class="date">26th February 2009, 13:31</div></div><div class="posttext">A few weeks ago I decided to NOT use EnvVarUpdate anymore and to use the setx tool instead.<br />
<br />
This has been working fine for a while, but yesterday the same thing occured again: the old content of PATH was replaced by my stuff. Again, it only occurs occasionally.<br />
<br />
So we basically have one and the same phenomenon caused by two different tools (!!!)<br />
<br />
I then issued the setx command from within a batch script (not using NSIS at all!) and did not experience any trouble.<br />
<br />
I then returned to NSIS using either EnvVarUpdate or setx, inserted LOADS of debug MessageBoxes, some of them right at the beginning of the installer, displaying the content of PATH to the installing user (ReadEnvStr $R0 PATH). They all tell me that PATH is empty but it is actually not because when I look up PATH in Windows it still holds the original string.<br />
<br />
My (tentative) conclusion from this is that there's a general problem with the handling of environment variables in NSIS. Can anyone confirm this?<br />
<br />
<br />
Ah and BTW, I also suspected a string length problem but that's not the case.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">cromev</div><div class="date">26th February 2009, 14:11</div></div><div class="posttext">Just a basic question -- is NSIS deemed capable of running on 64 bit versions of XP? I'm working on 64 bit machines all the time, might this be the cause for my problems?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">14th March 2009, 22:41</div></div><div class="posttext">NSIS strings are limited to 1024 characters. This has nothing to do with x64. You can use the special long string build that limits you to 8192.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">eigenguy</div><div class="date">25th June 2009, 02:40</div></div><div class="posttext">So I just had the same thing happen to me as this guy did. I'm running NSIS 2.45. This happened WITH the long strings (8192) build, so that is consistent in that it isn't the problem (besides which, the path is &lt;600 characters right now anyway)<br />
<br />
The one thing which is similar is that I'm running on a 64-bit system too (Vista). Several executions of the installer and corresponding uninstaller gave NO problems. Then, all of a sudden, the path was GONE with only the item I was adding there.<br />
<br />
Has there been ANY follow-up to this? Did cromev ever find a solution?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Deko Servidoni</div><div class="date">15th April 2010, 19:57</div></div><div class="posttext">My way:<br />
I verified the size of the PATH before and after update it<br />
If the size after was greater than the size before its ok, continue the process.<br />
Else its is corrupt so i abort the process.<br />
Anyone know if its right or will working?<br />
Thanks<br />
<br />
PS: if my english is too bad tell me, i am learning yet<br />
=]</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">15th April 2010, 20:20</div></div><div class="posttext">That works if the expanded variable is always larger than the variable. That doesn't necessarily have to be so, though. It would probably be better to search for the original string (like whatever is supposed to get appended after the expanded envvar) inside the new one.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Deko Servidoni</div><div class="date">15th April 2010, 20:47</div></div><div class="posttext">Ok<br />
i will try search for the original inside the new one<br />
thanks MSG</div></div><hr />


<div class="post"><div class="posttop"><div class="username">TeeWeTee</div><div class="date">1st March 2013, 09:17</div></div><div class="posttext">Don't want to wake old threads however I found one more reason why EnvVarUpdate could corrupt system variables (like PATH):<br />
<br />
I tried to add several entries at once:<br />
${EnvVarUpdate} $0 &quot;PATH&quot; &quot;A&quot; &quot;HKLM&quot; &quot;Entry1;Entry2;Entry3&quot;<br />
-&gt; If you call EnvVarUpdate n-times those three entries will be appended three times.<br />
<br />
After I changed it to:<br />
${EnvVarUpdate} $0 &quot;PATH&quot; &quot;A&quot; &quot;HKLM&quot; &quot;Entry1&quot;<br />
${EnvVarUpdate} $0 &quot;PATH&quot; &quot;A&quot; &quot;HKLM&quot; &quot;Entry2&quot;<br />
${EnvVarUpdate} $0 &quot;PATH&quot; &quot;A&quot; &quot;HKLM&quot; &quot;Entry3&quot;<br />
everything worked fine (actually I did it in a loop). When calling the code again EnvVarUpdate prints out:<br />
&quot;Target is already present in PATH. It will be removed and appended to PATH&quot;</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>