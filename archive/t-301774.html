<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" WinVer in NSIS Unicode 2.42, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  WinVer in NSIS Unicode 2.42 NSIS Discussion" />
	
	<title> WinVer in NSIS Unicode 2.42 [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  WinVer in NSIS Unicode 2.42</div>
<hr />
<div class="pda"><a href="t-301774.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=301774">WinVer in NSIS Unicode 2.42</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">xbarns</div><div class="date">6th January 2009, 20:22</div></div><div class="posttext">Hi all,<br />
<br />
i use this to check for a Windows 2003 Server in the .oninit Function.<br />
<br />
<br />
Function CheckIfValidOS<br />
<br />
    !Include WinVer.nsh<br />
    <br />
    ${If} ${IsWin2003}<br />
        MessageBox MB_OK YES<br />
    ${Else}<br />
        MessageBox MB_OK NO<br />
    ${Endif}<br />
    <br />
FunctionEnd  <br />
<br />
<br />
It works with NSIS Unicode 2.38-1 but not with NSIS Unicode 2.42<br />
<br />
It also works with the regular NSIS 2.42 (non Unicode)<br />
<br />
Regards<br />
Holger</div></div><hr />


<div class="post"><div class="posttop"><div class="username">xbarns</div><div class="date">6th January 2009, 21:12</div></div><div class="posttext">Ok i have looked into it some more, i am building the same script with NSIS 2.42 (Unicode and not)<br />
<br />
NSIS 2.42 will recognize XP, Windows 2003 Server and Windows 2008 Server <br />
<br />
NSIS 2.42 Unicode will only recognize XP but not 2003 or 2008<br />
<br />
Funny enough the WinVer of the 2.42 Unicode Version will recognize a W2K3 Server as Windows XP .....<br />
<br />
I have now replaced the 2.42 WinVer with the one from 2.38 and it works for my purposes.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jimpark</div><div class="date">6th January 2009, 21:14</div></div><div class="posttext">Hrm, I'm not sure why you are getting an error.  I just did a few sample tests myself and it works fine.  There has been quite a bit of changes in how include files are used from 2.38 to 2.42.  Could that be the problem?  Can you try writing a very simple NSI script that reproduces the problem?  And this may be a dumb question but &quot;how about completely uninstalling 2.38?&quot;  Are all the files gone?  Are you including the right WinVer.nsh and not a copy?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jimpark</div><div class="date">6th January 2009, 21:16</div></div><div class="posttext">That's a bit disconcerting.  But if you copy the WinVer.nsh from 2.38 it works?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">6th January 2009, 21:23</div></div><div class="posttext">It might work, but the current WinVer is pretty new, 2.38 would be the old one where as you said, 2003 = XP and 2008 = Vista SP1<br />
<br />
Unless you need to specify GetVersionExW in the unicode version, I could see no problems with the one from 2.42</div></div><hr />


<div class="post"><div class="posttop"><div class="username">xbarns</div><div class="date">6th January 2009, 21:26</div></div><div class="posttext">@jimpark<br />
<br />
this is the script i use<br />
<br />
Name WinVerTest<br />
OutFile WinVerTest.exe<br />
<br />
Section Test<br />
#<br />
SectionEnd<br />
<br />
Function .onInit<br />
    <br />
    !Include WinVer.nsh<br />
    <br />
    ${If} ${IsWin2003}<br />
            MessageBox MB_OK &quot;Win2003&quot;<br />
    ${Else}<br />
        MessageBox MB_OK &quot;NotWin2003&quot; <br />
    ${Endif}<br />
    <br />
FunctionEnd<br />
<br />
<br />
WinVer.nsh Version 2.38 IT WORKS<br />
WinVer.nsh Version 2.38 DOES NOT WORK<br />
<br />
I have also build on a machine that has never had any NSIS installed on it.<br />
<br />
@Anders <br />
At this moment i only need to recognize if the machine ist a 2003 Server and that works fine... the 2003 = XP happens with the 2.42 WinVer.nsh</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jimpark</div><div class="date">6th January 2009, 21:33</div></div><div class="posttext">Well, I just tested it on Win2003 R2 which requires the test<br />
<br />
<br />
${If} ${IsWin2003R2}<br />
<br />
<br />
And it worked.  Can you do the following to see what you get for the machines where you say it fails?<br />
<br />
<br />
${WinVerGetMajor} $1<br />
DetailPrint &quot;Major version = $1&quot;<br />
${WinVerGetMinor} $2<br />
DetailPrint &quot;Minor version = $2&quot;<br />
${WinVerGetBuild} $3<br />
DetailPrint &quot;Build number = $3&quot;<br />
<br />
<br />
See if that returns meaningful info.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">6th January 2009, 21:35</div></div><div class="posttext">sorry, I was talking about XP 64 = 2003 (they have the same version number)<br />
<br />
edit: ${IsWin2003R2} is special, it does not check the version number at all, you should only use it if you need to detect R2</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jimpark</div><div class="date">6th January 2009, 21:35</div></div><div class="posttext">Are you sure your server is not really Windows 2003 R2?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">xbarns</div><div class="date">6th January 2009, 21:38</div></div><div class="posttext">OK i get <br />
<br />
Major version = 5<br />
Minor version = 1<br />
Build number = 3790<br />
<br />
<br />
thats on a regular 2003 Server (not R2) i don't have an R2 to test with sadly.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jimpark</div><div class="date">6th January 2009, 21:40</div></div><div class="posttext">Actually, version 5.1 build 3790 is Windows 2003 R2. :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">xbarns</div><div class="date">6th January 2009, 21:52</div></div><div class="posttext">Are you sure? Doesn't it usually display a R2 on the Login Page ?<br />
<br />
${IsWin2003R2} does not work there either :(</div></div><hr />


<div class="post"><div class="posttop"><div class="username">xbarns</div><div class="date">6th January 2009, 22:00</div></div><div class="posttext">OK found an R2 Server in my VMWare collection<br />
<br />
Good News: ${IsWin2003R2} works<br />
Bad News: IT IS Version 5.1 build 3790 (same as my none R2 server) <br />
<br />
So you cannot distinguish a R2 from a non R2 using Version and Build number :(<br />
<br />
And yes the R2 has &quot;R2&quot; right on the logon screen while the other versions do not.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">6th January 2009, 22:41</div></div><div class="posttext">thats the point of ${IsWin2003R2}, because the version numbers are the same</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">7th January 2009, 04:04</div></div><div class="posttext">the system plugin in unicode 2.42 is broken<br />
<br />
<br />
StrCpy $0 &quot;FooBar&quot;<br />
System::Call '*(&amp;t20 &quot;$0&quot;)i.r1'<br />
System::Call '*$1(&amp;t4.r2)'<br />
MessageBox mb_ok $2<br />
System::Free $1<br />
<br />
should display &quot;FooB&quot; but only displays &quot;Fo&quot; (&amp;w is also broken) so I'm guessing you end up with wrong offsets in the OSVERSIONINFO struct, so it can't check the product type and so Win2003 is converted to XP (XPx64=5.2 workstation)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jimpark</div><div class="date">7th January 2009, 15:47</div></div><div class="posttext">You're right Anders.  This is a bug.  I've got a fix for it but I won't be releasing another build until I get a few more fixes in.  But thanks for finding this!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jimpark</div><div class="date">7th January 2009, 16:31</div></div><div class="posttext">Well, on second thought, the documentation for System does say that the special character '&amp;' should be used to describe BYTES of things.  So &amp;tN = N bytes of text. &amp;wN = N bytes of Unicode text.  &amp;gN = N bytes of GUID.  Should this be changed for the case of &amp;wN and &amp;tN so that it is a count of characters?  That's sort of what we assume all the time.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">7th January 2009, 18:18</div></div><div class="posttext">well, you already have &amp;i for bytes, if there is going to be any hope of using the same system calls for both versions, &amp;t and &amp;w must be sizeof(TCHAR) counts</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jimpark</div><div class="date">7th January 2009, 18:46</div></div><div class="posttext">Okay, I will have to change the documentation for the System plugin as well to reflect this change.  I think I've got some of the other issues hammered out as well.  So expect 2.42.1 soon.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jimpark</div><div class="date">8th January 2009, 14:27</div></div><div class="posttext">Now that 2.42.1 behaves the same as the ANSI version, and this still remains a problem, we need the main NSIS trunk to get this fixed.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">9th January 2009, 18:27</div></div><div class="posttext">Get what exactly fixed?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jimpark</div><div class="date">9th January 2009, 18:47</div></div><div class="posttext">I may have spoken too soon.  I found a bug in xbarns test script that he sent me so it may not be a bug in NSIS at all.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">9th January 2009, 19:17</div></div><div class="posttext">You can use Source\Tests\WinVer.nsi to test WinVer.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">9th January 2009, 19:18</div></div><div class="posttext">it seemed to detect 2003 fine in my tests, I just thought you were talking about the ansi docs, the bytes vs chars count bit</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jimpark</div><div class="date">9th January 2009, 19:30</div></div><div class="posttext">That's been fixed in 2.42.1.  And WinVer.nsi works fine for me as well.  So it's really up to xbars to see if it's not a bug in his script.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">xbarns</div><div class="date">9th January 2009, 20:47</div></div><div class="posttext">shame on me, as in another post<br />
<br />
*imagine sound of forehead hitting tabletop* <br />
<br />
You were completely right Jim, almost everything works except finding the difference between 2003 and 2003 R2 i have tested this on a 2003 Standard and a 2003 R2 X64 server these are the only two i have at hand right now. <br />
<br />
All else (i tested Vista and XP) works correctly after your correction(s) to my script.<br />
<br />
Thanks.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>