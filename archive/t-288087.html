<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Using System::Call to call SHGetKnownFolderPath, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Using System::Call to call SHGetKnownFolderPath NSIS Discussion" />
	
	<title> Using System::Call to call SHGetKnownFolderPath [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Using System::Call to call SHGetKnownFolderPath</div>
<hr />
<div class="pda"><a href="t-288087.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=288087">Using System::Call to call SHGetKnownFolderPath</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">wraithdu</div><div class="date">7th March 2008, 00:10</div></div><div class="posttext">I'm having trouble getting this to work.  Here's the MSDN for the function<br />
HRESULT SHGetKnownFolderPath(      <br />
    REFKNOWNFOLDERID rfid,<br />
    DWORD dwFlags,<br />
    HANDLE hToken,<br />
    PWSTR *ppszPath<br />
)<br />
<br />
And what I've got<br />
!define SHGetKnownFolderPath &quot;!insertmacro _SHGetKnownFolderPath&quot;<br />
<br />
!macro _SHGetKnownFolderPath nFolder dwFlags outVar<br />
	System::Call &quot;shell32::SHGetKnownFolderPath(g ${nFolder}, i ${dwFlags}, i, w .s)&quot;<br />
	Pop ${outVar}<br />
!macroend<br />
<br />
The problem is the FOLDERID for the function is a GUID, for example for the SendTo folder<br />
{8983036C-27C0-404B-8F08-102D10DCFD74}<br />
<br />
So the macro call would look like<br />
${SHGetKnownFolderPath} &quot;{8983036C-27C0-404B-8F08-102D10DCFD74}&quot; &quot;0x1000&quot; $0<br />
<br />
But I get nothing in the output.  Can someone help?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">demiller9</div><div class="date">7th March 2008, 03:39</div></div><div class="posttext">You aren't setting a value for the hToken parameter. You might try setting the third parameter to 0 (null) or -1 (if the guid is for a user specific folder and you want the current user).<br />
<br />
Don</div></div><hr />


<div class="post"><div class="posttop"><div class="username">wraithdu</div><div class="date">7th March 2008, 04:01</div></div><div class="posttext">Thanks for the idea, but it doesn't matter if the value for hToken is set of not.  It's supposed to be null anyway.  I did test it to make sure. But the SHGetFolderPath function, which I can get to work, also works without setting the hToken var.<br />
<br />
I'm sure the problem is to do with the rfid var and the proper way to pass the GUID to the function.<br />
<br />
PS - this is a Vista only function.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">demiller9</div><div class="date">7th March 2008, 04:11</div></div><div class="posttext">The output is a Unicode string. Are you running the Unicode build, or do you call a function to convert the string to single byte?<br />
<br />
The System dll has examples:!define CLSID_ActiveDesktop {75048700-EF1F-11D0-9888-006097DEACF9}<br />
!define IID_IActiveDesktop {F490EB00-1240-11D1-9888-006097DEACF9}<br />
# create IActiveDesktop interface<br />
System::Call &quot;ole32::CoCreateInstance( \<br />
	g '${CLSID_ActiveDesktop}', i 0, \<br />
	i ${CLSCTX_INPROC_SERVER}, \<br />
	g '${IID_IActiveDesktop}', *i .r0) i.r1&quot;Your usage of the guid looks similar.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">wraithdu</div><div class="date">7th March 2008, 04:14</div></div><div class="posttext">I'm running the ANSI version.<br />
<br />
I haven't converted the output yet.  Even though, I expected to see some kind of output.  It's completely blank.  Is that right?  Shouldn't I see something even if I haven't converted it yet?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">demiller9</div><div class="date">7th March 2008, 04:17</div></div><div class="posttext">A unicode string will look like it has zeros between its characters. Those would be interpreted as end of string. (I don't recall whether the first byte is the zero, which would make your return string appear completely empty).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">wraithdu</div><div class="date">7th March 2008, 04:25</div></div><div class="posttext">I believe the second byte is 00, so I should still get the first character.<br />
<br />
Crap, converting the string to ANSI would be a whole other problem.  I know how to do the DllCall's in AutoIt for this, but not the System::Call's in NSIS (I don't know how to create DLL structs in NSIS for the string buffers).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">demiller9</div><div class="date">7th March 2008, 04:50</div></div><div class="posttext">I'm not an expert with the System dll, so maybe they will speak up if you don't get it figured out by yourself. Here's a link to CodeGuru (http://www.codeguru.com/forum/showthread.php?t=231165)  on how to convert multibyte to ansi.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">7th March 2008, 08:34</div></div><div class="posttext">I don't have vista, so I could not test this code at all, but I would guess it would look something likeSystem::Call &quot;shell32::SHGetKnownFolderPath(g '{8983036C-27C0-404B-8F08-102D10DCFD74}', i 0x1000 ,i0, i.r1)i.r0&quot;<br />
${If} $0 == 0<br />
	System::Call /NoUnload 'kernel32::lstrlenW(i $1)i.r2'<br />
	IntOp $2 $2 * 2<br />
	System::Call /NoUnload '*$1(&amp;w$2 .r2)'<br />
	MessageBox mb_ok path=$2<br />
	System::Call 'ole32::CoTaskMemFree(i $1)'<br />
	${endif}</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">7th March 2008, 08:43</div></div><div class="posttext">but, why call the Vista function when you can just do:<br />
<br />
System::Call 'shell32::SHGetFolderPath(i $hwndparent,i 0x9,i0,i0,t.r0)i'<br />
MessageBox mb_ok $0<br />
<br />
and there is $SENDTO also ofcourse</div></div><hr />


<div class="post"><div class="posttop"><div class="username">wraithdu</div><div class="date">7th March 2008, 23:34</div></div><div class="posttext">Thanks for the try, but the function crashes if the output data type is an integer (i).  It does not crash if output is a unicode string (w), but the output is then just a ?.  The return value is still 0 however.<br />
<br />
And I realize I can use SHGetFolderPath (or $SENDTO), but SHGetKnownFolderPath has GUIDs with no CSIDL equivalent for the old function.  It is also extensible, ie a user can create a GUID for a folder and return it with this function.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">8th March 2008, 07:59</div></div><div class="posttext">ah yes, its PWSTR*, sorry, missed that, try adding a *</div></div><hr />


<div class="post"><div class="posttop"><div class="username">wraithdu</div><div class="date">8th March 2008, 19:49</div></div><div class="posttext">Eureka!  Thanks soooo much!  This was killing me...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">8th March 2008, 19:53</div></div><div class="posttext">It's:System::Call &quot;shell32::SHGetKnownFolderPath(g '{8983036C-27C0-404B-8F08-102D10DCFD74}', \<br />
  i 0x1000 , i0, *w.r1) i.r0&quot;If that doesn't work, it's because `g` is for GUID pointers and SHGetKnownFolderPath expects the GUID itself on the stack.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">wraithdu</div><div class="date">8th March 2008, 20:06</div></div><div class="posttext">Nope, I got it.  I had the * on the wrong side of the i ;)<br />
<br />
Working code<br />
System::Call &quot;shell32::SHGetKnownFolderPath(g '{8983036C-27C0-404B-8F08-102D10DCFD74}', i 0x1000 ,in, *i.r1)i.r0&quot;<br />
	${If} $0 == 0<br />
		System::Call /NoUnload 'kernel32::lstrlenW(i $1)i.r2'<br />
		IntOp $2 $2 * 2<br />
		System::Call /NoUnload '*$1(&amp;w$2 .r2)'<br />
		MessageBox mb_ok path=$2<br />
		System::Call 'ole32::CoTaskMemFree(i $1)'<br />
	${endif}</div></div><hr />


<div class="post"><div class="posttop"><div class="username">wraithdu</div><div class="date">8th March 2008, 20:11</div></div><div class="posttext">Originally posted by kichik <br />
`g` is for GUID pointers<br />
Can you explain that a little more?  I'm trying to get this to work in AutoIt3 as well, but it doesn't have a GUID data type.  Is there some way I can create that data type using others?  Are you saying that g is a pointer to a GUID string in a structure?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">8th March 2008, 20:36</div></div><div class="posttext">No, I'm saying for the System plug-in 'g' means pass a pointer to a GUID structure (LPGUID instead of GUID). I don't know how to do that in AutoIt3.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">wraithdu</div><div class="date">8th March 2008, 21:27</div></div><div class="posttext">Got it (finally) in AutoIt -<br />
#include &lt;WinAPI.au3&gt;<br />
<br />
$tagstruct = DllStructCreate($tagGUID)<br />
$tagptr = DllStructGetPtr($tagstruct)<br />
_WinAPI_GUIDFromStringEx(&quot;{8983036C-27C0-404B-8F08-102D10DCFD74}&quot;, $tagptr)<br />
So $tagptr has the pointer to the GUID structure.<br />
<br />
Now I gotta figure out how to read the buffer....</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>