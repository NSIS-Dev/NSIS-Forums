<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Striping down NSIS, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Striping down NSIS NSIS Discussion" />
	
	<title> Striping down NSIS [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Striping down NSIS</div>
<hr />
<div class="pda"><a href="t-132794.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=132794">Striping down NSIS</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">DragonSoull</div><div class="date">23rd April 2003, 02:30</div></div><div class="posttext">I'm writing a small app that uses nsis.<br />
It only requires a small list of features and since size is critical I would like to know how to strip nsis to the bare basics Iâ€™ve edit the config.h file but only managed to shave off 93KB on makensis. What else can i do to cut back?<br />
And by the way you say 7z compression is on the works in witch version of nsis will it be added?<br />
<br />
<br />
Function needed:<br />
Install files and dirs<br />
write/read registry (remember install folder)<br />
show license, dir picker &amp; progress<br />
external ui &amp; custom strings<br />
<br />
Using NSIS 2.00b4 (CVS) 22/04/2003</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Sunjammer</div><div class="date">23rd April 2003, 08:53</div></div><div class="posttext">Is the size of the generated installer the important thing or the size of makensis? If it's the size of the generated installer then it's the size of the executable header (bzip2 or zlib version) that you want to concentrate on reducing. KiCHiK or Joost will no doubt give you much much more information :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">23rd April 2003, 13:59</div></div><div class="posttext">The exe header is optimized for minial size, makensis is optimized for maximum speed therefore I don't have many tips for it but these two:<br />
<br />
 Compile using VC7, it always gives better results for the compiler.<br />
 Compile only one compression method and remove mentions to the second compression method from the source.<br />
<br />
If I think of any more I'll let you know.<br />
<br />
And by the way you say 7z compression is on the works in witch version of nsis will it be added?<br />
<br />
It is planned to be implemented in the final version of NSIS 2.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DragonSoull</div><div class="date">23rd April 2003, 16:29</div></div><div class="posttext">Already using VC7 and i want to make both  makensis and exehead smaller.<br />
<br />
By the way in config.h removing #define NSIS_SUPPORT_CODECALLBACKS gives compile errors (current cvs build) why? if it's optional shouldn't it compile with out it? (but i'm no expert programer (just fouling around)).<br />
<br />
but back to the topic can't i just take of unused dialogst or something else? there must be a way to srink it even more (with out using compression metods).<br />
and what about my 7z question?<br />
<br />
And thanks for the replies ;) it's good to be helped.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">23rd April 2003, 16:42</div></div><div class="posttext">Fixed that compile error in latest CVS version.<br />
<br />
Resources are removed according to config.h.<br />
<br />
I have answered your 7z question.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">23rd April 2003, 16:48</div></div><div class="posttext">Makensis.exe is the compiler that generates the installers. The overhead for the installer is only 34 KB. Or do you have to distribute the compiler?<br />
<br />
See kichik's post: 7zip compression will be available before NSIS 2 final. You can use the 7zip SFX for now (but that will add about 100 KB).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DragonSoull</div><div class="date">25th April 2003, 14:22</div></div><div class="posttext">kichik sorry, i didn't see it (probably toght it was you signature :confused:) and thanks for fixing the errors :).<br />
I hope the nsis 7z exehead will be the same size or smaller then the current ones 100KB is way overkill (unless you realy need top compression on big files but still).<br />
Joost Verburg, I need both the exehead and the makensis as small has possible.<br />
<br />
Thanks for the help, i'm realy greatfull ;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">25th April 2003, 15:12</div></div><div class="posttext">100 KB is definately not overkill if you have an installer of a few MB's. It can make it &gt; 25% smaller.<br />
<br />
The 7zip/LZMA compression won't make the NSIS exehead that large when it's integrated, it will be optimized. The SFX supports some other compression methods too.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">8th July 2003, 15:21</div></div><div class="posttext">You can also use UPX (http://upx.sourceforge.net/) to compress makensis. It will strip down a few more KB :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">n0On3</div><div class="date">11th July 2003, 04:07</div></div><div class="posttext">I always add this line:<br />
!packhdr &quot;C:\tmp.dat&quot; &quot;c:\upx.exe --best --crp-ms=999999 C:\tmp.dat&quot; <br />
in the .nsi file to pack the header of the installer while compiling. Remember to change the path to upx.exe or put it in c:<br />
<br />
It saves you 10kB or so.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">11th July 2003, 11:32</div></div><div class="posttext">That helps for the final result. But you can use UPX (without including it in your package) to compress makensis.exe too. It will compress makensis.exe pretty good. It compresses the current CVS version from 400kb to 150kb.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">n0On3</div><div class="date">11th July 2003, 15:57</div></div><div class="posttext">I packed makensis.exe and the compiled .nsi has the same size. :?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">12th July 2003, 13:02</div></div><div class="posttext">That's because you've packed the compiler, not the output. I am talking of ways to make makensis.exe smaller, not only the exehead.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">n0On3</div><div class="date">12th July 2003, 17:52</div></div><div class="posttext">But DragonSoull wanted to make the installer smaller. And (If I understood correctly) he wanted to strip things inside makensis.exe forseeing a smaller compile.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">12th July 2003, 17:57</div></div><div class="posttext">He wanted to strip everything possible in order to make everything smaller, including makensis.exe.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">n0On3</div><div class="date">12th July 2003, 23:08</div></div><div class="posttext">ok, I misunderstood.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gyrbo</div><div class="date">15th July 2003, 21:07</div></div><div class="posttext">If anyone want to use 7zip anyway, I have stripped the 7za.exe file to 133kb (from 480kb). It supports extracting of 7z files with LZMA or BCJ. If you want it: http://gyrbo.yi.org/dl/extract7.exe<br />
<br />
Some sample code if you want to use it in a project (thanks to whoever created the DeleteDetailViewItem function):<br />
<br />
######################################<br />
!define LVM_GETITEMCOUNT        0x1004<br />
!define LVM_DELETEITEM          0x1008<br />
######################################<br />
; This function delete one element from the details view<br />
; Push the index of the elemnet to delete before call<br />
Function DeleteDetailViewItem<br />
  exch $0<br />
  push $1<br />
  FindWindow $1 &quot;#32770&quot; &quot;&quot; $HWNDPARENT<br />
  GetDlgItem $1 $1 0x3F8 ; This is the Control ID of the details view<br />
  SendMessage $1 ${LVM_DELETEITEM} $0 0<br />
  pop $1<br />
  pop $0<br />
FunctionEnd<br />
<br />
Section &quot;MainGroup&quot; SEC01<br />
  AddSize 41065<br />
  ;DetailPrint &quot;Unpacking Install Files...&quot;<br />
  SetOutPath $PLUGINSDIR<br />
  Push 0<br />
  Call DeleteDetailViewItem<br />
  SetCompress Auto<br />
  SetOverwrite Off<br />
  ;Modified 7za.exe (www.7-zip.org)<br />
  File &quot;extract7.exe&quot;<br />
  Push 0<br />
  Call DeleteDetailViewItem<br />
  SetCompress Off<br />
  SetOverwrite On<br />
  ;7z'd files<br />
  File &quot;files.7z&quot;<br />
  Push 0<br />
  Call DeleteDetailViewItem<br />
  SetCompress Auto<br />
 ; DetailPrint &quot;&quot;<br />
<br />
  DetailPrint &quot;Creating Program Directory...&quot;<br />
  CreateDirectory &quot;$INSTDIR&quot;<br />
  DetailPrint &quot;&quot;<br />
<br />
  DetailPrint &quot;Installing Program Files...&quot;<br />
  ;Run extracter on files<br />
  nsExec::ExecToLog '&quot;$PLUGINSDIR\extract7.exe&quot; x &quot;$PLUGINSDIR\files.7z&quot; -y &quot;-o$INSTDIR&quot; * -r'<br />
  DetailPrint &quot;&quot;<br />
<br />
  ;Other code<br />
<br />
SectionEnd<br />
<br />
<br />
Place extract7.exe and your compressed files in files.7z in the same dir when you compile and there you go: 7zip compression in NSIS.<br />
<br />
Some results:<br />
Source: 40.1MB<br />
7-Zip File: 9.12MB<br />
NSIS with 7-Zip: 9.24MB<br />
NSIS with zlib: 14.2MB<br />
NSIS with BZip2: 13.4MB<br />
<br />
I think the results speak for themselfs.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DragonSoull</div><div class="date">31st December 2003, 09:08</div></div><div class="posttext">Well bumping this oldy up again :)<br />
<br />
got 2.0 RC1 and started to shave the fat again got into the falowing problems.<br />
<br />
<br />
removing #define NSIS_CONFIG_PLUGIN_SUPPORT gives<br />
<br />
d:\Home\Projects\saves\Source\makesaves\Source\script.cpp(785): error C3861: 'build_plugin_table': identifier not found, even with argument-dependent lookup<br />
<br />
i commented it out and build worked again (but probably broke something)<br />
<br />
removing #define NSIS_CONFIG_ENHANCEDUI_SUPPORT gives<br />
d:\Home\Projects\saves\Source\makesaves\Source\script.cpp(3734): error C2065: 'TOK_SETBKCOLOR' : undeclared identifier<br />
<br />
fixed by adding TOK_SETBKCOLOR to the token.h enum {}<br />
<br />
removing #define NSIS_CONFIG_COMPONENTPAGE gives<br />
<br />
makenssi error LNK2019: unresolved external symbol &quot;private: void __thiscall CEXEBuild::PreperInstTypes(void)&quot; (?PreperInstTypes@CEXEBuild@@AAEXXZ) referenced in function &quot;public: int __thiscall CEXEBuild::write_output(void)&quot; (?write_output@CEXEBuild@@QAEHXZ)<br />
<br />
fixed by commenting out PreperInstTypes calls in the write_output function.<br />
<br />
But now makensis crashes compiling my test script<br />
<br />
I'm also using custom resource.rc so i'm including all the relevent files in a 7z archive.<br />
<br />
Help please :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DragonSoull</div><div class="date">31st December 2003, 09:22</div></div><div class="posttext">Originally posted by n0On3 <br />
I always add this line:<br />
!packhdr &quot;C:\tmp.dat&quot; &quot;c:\upx.exe --best --crp-ms=999999 C:\tmp.dat&quot; <br />
in the .nsi file to pack the header of the installer while compiling. Remember to change the path to upx.exe or put it in c:<br />
<br />
It saves you 10kB or so. <br />
<br />
Interesting, but normally is the header compressed when the scrip is compiled or is it keepted in umcompressed format and if so could i upx them before inclusion in makensis?<br />
<br />
Now to upx makensis itself would be a bit uselless since this would prevent normal compression using standart methods and i don't think upx can beat 7z (it didn't beat zip when i tested a year back)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gyrbo</div><div class="date">31st December 2003, 10:10</div></div><div class="posttext">As far as I know, you can't compress the entire header using normal means (7z, bzip, ...) because it's executable. You always need some way to decompress it. This decompression routine is very small with upx, plus I think it's optimized for executables.<br />
<br />
Compressing makensis will only save space on your harddisk, because none of it gets included in the installer.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DragonSoull</div><div class="date">31st December 2003, 12:29</div></div><div class="posttext">Originally posted by Gyrbo <br />
As far as I know, you can't compress the entire header using normal means (7z, bzip, ...) because it's executable. You always need some way to decompress it. This decompression routine is very small with upx, plus I think it's optimized for executables.<br />
<br />
Compressing makensis will only save space on your harddisk, because none of it gets included in the installer. <br />
<br />
I see... so now all i need to find out is how (if it's possible that is) I compress the headers with upx before makensis is put together...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gyrbo</div><div class="date">31st December 2003, 15:39</div></div><div class="posttext">No need tp find out, I'm using the following in my scripts and it works perfect (d: is my biggest drive):<br />
!packhdr &quot;d:\header.dat&quot; &quot;d:\upx.exe -9 d:\header.dat&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">1st January 2004, 17:14</div></div><div class="posttext">Originally posted by DragonSoull <br />
I see... so now all i need to find out is how (if it's possible that is) I compress the headers with upx before makensis is put together... You can't, you'll have to use !packhdr as Gyrbo suggested. makensis needs to edit the resources of the exehead and can't do that when the exehead is compressed using UPX. If you really want you can edit the code and make makensis uncompress the exehead first and compress it back. The only problem is that you'll need UPX for that and that will surely overshadow any size savings you've gained by using a compressed exehead.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DragonSoull</div><div class="date">2nd January 2004, 15:48</div></div><div class="posttext">Well I could always offer upx has a optional downloadable component.<br />
<br />
kichik, what about the compile errors and crash I got? is somebody already on it?<br />
<br />
Also since now 7z is a reality i'm considering including just that compression method too simplify thing (and take some fat of too) but since my main hard drive is gone compiling is of the question :(</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">2nd January 2004, 15:51</div></div><div class="posttext">Oh sorry, missed that message. I'll look into it.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DragonSoull</div><div class="date">3rd January 2004, 19:23</div></div><div class="posttext">Thanks :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">4th January 2004, 17:26</div></div><div class="posttext">Well, I have fixed the compile errors but I can't get it to crash. Make sure you've recompiled exedata.cpp after the exeheads were compiled. Best method would probably be using Rebuild All. If that doesn't work I'll need some more details, starting with the message you get.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DragonSoull</div><div class="date">4th January 2004, 21:20</div></div><div class="posttext">Originally posted by kichik <br />
Well, I have fixed the compile errors but I can't get it to crash. Make sure you've recompiled exedata.cpp after the exeheads were compiled. Best method would probably be using Rebuild All. If that doesn't work I'll need some more details, starting with the message you get.  <br />
<br />
Like i said before my hard drive broke, so compiling is out of the question, when i recieve a replacementeand and re-setup windows (and everything else) i'll try again :(</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DragonSoull</div><div class="date">28th January 2004, 18:32</div></div><div class="posttext">Well it's me again :), just wanted to say that I'm still with out my computer but i've been writing the Functional Specification of my app with resulted in several changes on it's design (keeps getting more complex with every draft :\).<br />
<br />
Namely that i'll be trying to use CEXEBuild directly from inside my app (allowing to trim even more fat), I can coud on you guys for when ever I become confused ;).<br />
<br />
Also I been meaning to ask if the dev team has a problem with the name &quot;Saves (NSIS)&quot;. If you do I can remove it but it's there mostely to give you guys credit for most of the work :p</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">28th January 2004, 18:38</div></div><div class="posttext">Make sure that your product can't be misrepresented as being the original version, so you should call it &quot;based on NSIS&quot; or something like that.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DragonSoull</div><div class="date">29th January 2004, 01:42</div></div><div class="posttext">So can't use the (NSIS)... guess i'll  just change the name all together.<br />
<br />
Keeper &quot;Built on NSIS Technology&quot; sounds preaty good.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>