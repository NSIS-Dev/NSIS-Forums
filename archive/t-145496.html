<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Refreshing the program groups in the Start Menu, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Refreshing the program groups in the Start Menu NSIS Discussion" />
	
	<title> Refreshing the program groups in the Start Menu [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Refreshing the program groups in the Start Menu</div>
<hr />
<div class="pda"><a href="t-145496.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=145496">Refreshing the program groups in the Start Menu</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">dajvid</div><div class="date">12th August 2003, 04:53</div></div><div class="posttext">Hi,<br />
<br />
My installer needs to migrate an existing installation that created Start Menu shortcuts in the current user profile to recreating those Start Menu shortcuts in the all users profile. While I'm able to delete the shortcuts and program group in the current user profile and recreate them in the all users profile, Windows XP (this may also affect Windows 2000) does not refresh the Start Menu accordingly.<br />
<br />
Windows XP (I don't have a Windows 2000 box to test this on) combines the Start Menu of the current user and all users profiles into one list. After deleting all the shortcuts and the program group from the current user profile, I recreate the shortcuts in a program group of the exact same name in the all user profile. Windows XP gets confused and ends up displaying an empty program group in the Start Menu, even though the shortcuts exist in the all users profile. The only way I've found to get Windows XP to refresh this is to get a user to either logout/login or reboot.<br />
<br />
Is there any way to get NSIS to refresh the Start Menu without rebooting the computer?<br />
<br />
Many thanks,<br />
Dave.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">12th August 2003, 13:11</div></div><div class="posttext">A notification of some kind using SHChangeNotify should probably help XP refresh its data. Have a look at this page for an example usage:<br />
<br />
http://nsis.sourceforge.net/archive/viewpage.php?pageid=202<br />
<br />
If I had to take a guess I'd say SHCNE_DELETE would do the trick.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dajvid</div><div class="date">13th August 2003, 03:59</div></div><div class="posttext">Using the SHChangeNotify example above, I've tried substituting SHCNE_DELETE, SHCNE_RMDIR and even SHCNE_ALLEVENTS, without success.<br />
<br />
I'm fumbling a little in the dark because I do not quite understand the uFlags parameter. SHCNF_IDLIST refers to the Desktop folder, however I do not know whether this encompasses the virtual Desktop folder, that would cover all folders including both current and all users Start Menus, or whether it is the physical Desktop folder, located in the %PROFILE%\Desktop, which would not include the current and all users Start Menus. I am also uncertain how to use the other uFlags options.<br />
<br />
Ta,<br />
Dave.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">13th August 2003, 11:58</div></div><div class="posttext">Have you defined all of the values correctly? Why use SHCNF_IDLIST with the desktop when you can use SHCNF_PATH with a real path?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dajvid</div><div class="date">14th August 2003, 03:18</div></div><div class="posttext">My best guess for the correct parameters is to use SHCNE_RMDIR to reflect deleting the program group in the current user profile and to use SHCNF_PATH to specify the current user start menu, although I do not know how to pass the path to the system call.<br />
<br />
SHCNF_PATH<br />
dwItem1 and dwItem2 are the addresses of null-terminated strings of maximum length MAX_PATH that contain the full path names of the items affected by the change. <br />
<br />
I don't know how to specify the path and why I'd need to specify two strings. I'm not even sure whether SHCNF_PATH is 0x01 or 0x05.<br />
<br />
This is what I have right now, althought this won't work.<br />
<br />
<br />
!define SHCNE_RMDIR 0x010<br />
!define SHCNF_PATH 0x01<br />
<br />
Function RefreshStartMenu<br />
  ; Based on RefreshShellIcons <br />
  ; By jerome tremblay - april 2003<br />
  System::Call 'shell32.dll::SHChangeNotify(l, l, i, i) v \<br />
  (${SHCNE_RMDIR}, ${SHCNF_PATH}, 0, 0)'<br />
FunctionEnd<br />
<br />
Any code would be greatly appreciated.<br />
<br />
Ta,<br />
Dave.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">14th August 2003, 11:46</div></div><div class="posttext">This is taken from MSDN:<br />
<br />
A folder has been created. SHCNF_IDLIST or SHCNF_PATH must be specified in uFlags. dwItem1 contains the folder that was created. dwItem2 is not used and should be NULL.<br />
<br />
It means dwItem1 must contain a pointer to a string specifying the path. SHCNF_PATH must be 0x1 because this string is ASCII and not Wide. The code should look like this:<br />
<br />
System::Call 'shell32.dll::SHChangeNotify(i ${SHCNE_RMDIR}, i ${SHCNF_PATH}, t &quot;$SMPROGRAMS\my program&quot;, i 0)'<br />
<br />
BTW, there was an error in the script on the archive. Instead of i in the first two parms it used l which means System.dll should send int64.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dajvid</div><div class="date">15th August 2003, 03:53</div></div><div class="posttext">Thanks Kichik, it works an absolute treat! Here's the final code for any future readers:<br />
<br />
<br />
!define SHCNE_RMDIR 0x010<br />
!define SHCNF_PATH 0x01<br />
<br />
Function NotifyRmDir<br />
  ; Based on RefreshShellIcons By jerome tremblay - april 2003<br />
  System::Call 'shell32.dll::SHChangeNotify(i, i, t, i) v \<br />
  (${SHCNE_RMDIR}, ${SHCNF_PATH}, &quot;directory to notify&quot;, 0)'<br />
FunctionEnd<br />
<br />
<br />
Ta,<br />
Dave.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>