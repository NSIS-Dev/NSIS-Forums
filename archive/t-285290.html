<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Uninstalling files from Vista VirtualStore, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Uninstalling files from Vista VirtualStore NSIS Discussion" />
	
	<title> Uninstalling files from Vista VirtualStore [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Uninstalling files from Vista VirtualStore</div>
<hr />
<div class="pda"><a href="t-285290.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=285290">Uninstalling files from Vista VirtualStore</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">19th January 2008, 17:42</div></div><div class="posttext">I have an application that writes save files to its own directory. Assuming the user installs this application to $programfiles, this will cause Windows Vista UAC to put those files into $APPDATA\Local\VirtualStore\Program Files\NameOfApplication.<br />
<br />
At first I thought that calling 'delete $INSTDIR\save.file' as the user (not as admin) would make Windows delete the file from virtualstore. But since the following code does not work, apparently I was wrong in that assumption:<br />
!insertmacro UAC.CallFunctionAsUser un.DeleteSaves<br />
<br />
Function un.DeleteSaves<br />
  Delete /REBOOTOK &quot;$INSTDIR\record.save&quot;<br />
FunctionEnd<br />
<br />
My question now is, is there a way to tell windows to delete the VirtualStore version of a file, instead of the file that the path would normally point to? (Note that in my case record.save only exists in VirtualStore and it still doesn't get deleted.) Or could NSIS be made to have a variable $VIRTUALINSTDIR that points to the instdir inside virtualstore?<br />
<br />
I could of course get $INSTDIR and do a number of loops to cut out the xxx part from &quot;C:\Program Files\xxx&quot; and put it into &quot;$APPDATA\Local\VirtualStore\Program Files\xxx&quot;, but that seems like the long way around to me.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">19th January 2008, 18:25</div></div><div class="posttext">http://forums.microsoft.com/MSDN/ShowPost.aspx?PostID=1651420&amp;SiteID=1<br />
<br />
Doing things &quot;as the user&quot; with the UAC plugin does not help, if you use RequestExecutionLevel=anything,  VirtualStore/file&amp;folder redirection gets disabled AFAIK</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">19th January 2008, 18:55</div></div><div class="posttext">Paste from the channel, because Anders gave a rather interesting solution:<br />
<br />
&lt;Message&gt; I see. So I'm pretty much stuck with deleting the files manually?<br />
&lt;Anders&gt; fix your app?<br />
&lt;Message&gt; heh, it's not mine :)<br />
&lt;Anders&gt; if you make a little program/nsis app that does not have a manifest, you could exec it in the uninstaller, it would figure out the virtual store path and save it in HKCU, then read that back and delete the stuff (or that app could do the deletion)<br />
<br />
My own solution is the 'long way around', which didn't turn out so long after all:<br />
Function un.DeleteSaves<br />
  Delete /REBOOTOK &quot;$INSTDIR\record.save&quot;<br />
  StrCpy $2 $INSTDIR &quot;&quot; 3<br />
  Delete /REBOOTOK &quot;$LOCALAPPDATA\VirtualStore\$2\record.save&quot;<br />
  #And then a small loop to delete the empty subdir(s).<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">20th January 2008, 01:47</div></div><div class="posttext">Just note that $instdir might not start with c:\, could be a UNC path: \\server\share\programfiles</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>