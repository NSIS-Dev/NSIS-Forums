<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Binary read, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Binary read NSIS Discussion" />
	
	<title> Binary read [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Binary read</div>
<hr />
<div class="pda"><a href="t-204832.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=204832">Binary read</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">superruzafa</div><div class="date">13th January 2005, 20:35</div></div><div class="posttext">Hi,<br />
<br />
I must modify some parts of a 153 Mb binary file. The only function I've found that performs this is FileReadByte and FileWriteByte but are toooooooooo slow.<br />
<br />
Is there any way to read/write strings of non-character bytes using FileRead/FileWrite? Or I must making an external program who performs that?<br />
<br />
Thanks</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">13th January 2005, 20:44</div></div><div class="posttext">If you want to patch a binary file, why not use VPatch?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">superruzafa</div><div class="date">13th January 2005, 20:58</div></div><div class="posttext">Could you write the link?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">13th January 2005, 21:00</div></div><div class="posttext">It's in your Contrib folder.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">superruzafa</div><div class="date">13th January 2005, 21:13</div></div><div class="posttext">Sorry, I'm a total newbie and I don't know where that folder is. I'll search other posts ;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">13th January 2005, 21:15</div></div><div class="posttext">Where you installed NSIS, there's a folder named Contrib. Inside that folder, there's a folder named VPatch. Normally, that should be:<br />
<br />
C:\Program Files\NSIS\Contrib\VPatch</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">13th January 2005, 21:40</div></div><div class="posttext">Have a good look around your NSIS directory. It's always a good idea to know what's available to you :)<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">14th January 2005, 11:31</div></div><div class="posttext">I had to write my own binary read script for license page. It was empty installer with all files located in CVS folders including installer itself and license file, and like Joost wrote long ago we can use WM_SETTEXT for txt files. The only problem I found - System plug-in can not allocate variable size memory (&amp;t$1), but calloc() can ;) Sample script attached.<br />
Might be good to allow users to skip License file name for such situations in MUI page definition, 0 parameters may create warning only, in this script I had to use additional short &quot;dummy.txt&quot; file (not committed to our CVS, this may create problems with later installer rebuilds :( ).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">14th January 2005, 11:49</div></div><div class="posttext">The System.dll plug-in should have no problem allocating variable size memory blocks. The problem you've encountered is probably NSIS's string size limit (1024 by default). If you read using FileRead and then append using a call to lstrcat, it should be OK.<br />
<br />
BTW, it's not a good idea to allocate using calloc and free using System::Free. They use two different allocation methods. In the worst case, it can cause a crash. Usually, it should just create a memory leak.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">14th January 2005, 12:27</div></div><div class="posttext">Thanks, KichiK!<br />
Might be something was wrong in my syntax, this not worked with System::Call allocation, but looks OK now with Alloc and Free.<br />
BTW I used <br />
   System::Alloc '$1 .r0'<br />
syntax in the updated file, and this works fine, but System.htm uses <br />
System::Alloc 64<br />
Pop $0<br />
Is my variant correct?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">14th January 2005, 12:32</div></div><div class="posttext">Your variant is incorrect. Take a look at Contrib\System\Source\Buffers.c. Alloc is right on the top.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">14th January 2005, 12:52</div></div><div class="posttext">OK, I'll better use my favourite msvcrt calls ;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">superruzafa</div><div class="date">14th January 2005, 14:47</div></div><div class="posttext">I've found very interesting all you have talk.<br />
<br />
Where can I find more info about system calls and the parameters for that functions?<br />
<br />
BTW, I made an patch.exe file which does the patching logic and I call externally.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">14th January 2005, 14:49</div></div><div class="posttext">You can find information about the System plug-in in its readme. You can find the readme, the source code and some examples in &lt;nsis folder&gt;\Contrib\System.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">superruzafa</div><div class="date">14th January 2005, 16:07</div></div><div class="posttext">Take a look of that code. I have a binary file &quot;prueba.bin&quot; who is 1024 bytes and I try to copy into another file, but nothing happens.<br />
<br />
Need more code? (includes, defines) or simplily the params are wrong?<br />
<br />
<br />
System::Call 'msvcrt.dll::calloc(i 1024, i 1) i .r0' ; creates a 1024 size buffer<br />
<br />
System::Call 'msvcrt.dll::_open(t &quot;$INSTDIR\prueba.bin,  i 0x8000) i .r1' ; open first file<br />
System::Call 'msvcrt.dll::_open(t &quot;$INSTDIR\prueba2.bin, i 0x8101) i .r2' ; open second file<br />
System::Call 'msvcrt.dll::_read(i r1, i r0, 1024) i .r3' ;read the first file<br />
System::Call 'msvcrt.dll::_write(i r2, i r0, 1024) i .r3' ;and writes to the second<br />
<br />
System::Call 'msvcrt.dll::_close(i r1)' ; close file 1<br />
System::Call 'msvcrt.dll::_close(i r2)' ; close file 2</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">14th January 2005, 16:09</div></div><div class="posttext">You're missing closing quotes for the file names in both _open calls.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">superruzafa</div><div class="date">14th January 2005, 16:20</div></div><div class="posttext">Originally posted by kichik <br />
You're missing closing quotes for the file names in both _open calls.  <br />
<br />
:eek: Ups. Now file is created but nothing is readed nor writed. I'll continue investigating about that :cool:</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">14th January 2005, 16:22</div></div><div class="posttext">It might be because you're missing an `i` before 1024 in the _read and _write lines.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">superruzafa</div><div class="date">14th January 2005, 16:24</div></div><div class="posttext">I got it! :D <br />
<br />
It failed type for 1024. Well, hope this will serve for others.<br />
<br />
<br />
System::Call 'msvcrt.dll::_read(i r1, i r0, /* this -&gt; */ i 1024) i .r3'<br />
System::Call 'msvcrt.dll::_write(i r2, i r0, /* and this -&gt; */ i 1024) i .r3'</div></div><hr />


<div class="post"><div class="posttop"><div class="username">superruzafa</div><div class="date">14th January 2005, 16:26</div></div><div class="posttext">It seems we are writing at time, ;) <br />
<br />
Thanks for all, guys</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">15th January 2005, 10:56</div></div><div class="posttext">And <br />
System::Call 'msvcrt.dll::free(i ro)'<br />
at the end of code :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">superruzafa</div><div class="date">15th January 2005, 11:02</div></div><div class="posttext">I've used System::Alloc and System::Free for that.<br />
<br />
Is a good idea to allocate memory with those functions and then use the memory allocated with msvcrt.dll call functions?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">15th January 2005, 11:08</div></div><div class="posttext">This is not a problem I guess, both allocs should work with this code 100%. But System::Alloc + Pop take 2 lines of script :( - this is the only reason why I used direct msvcrt calls.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">superruzafa</div><div class="date">17th January 2005, 13:37</div></div><div class="posttext">What if msvcrt.dll isn't installed? Must I include in the installer? And then, extract and installing?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">17th January 2005, 13:46</div></div><div class="posttext">Don't worry about msvcrt.dll ;)<br />
Only msvcrtd.dll (debug version) may not present.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>