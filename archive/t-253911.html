<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Uninstall only installed files, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Uninstall only installed files NSIS Discussion" />
	
	<title> Uninstall only installed files [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Uninstall only installed files</div>
<hr />
<div class="pda"><a href="t-253911.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=253911">Uninstall only installed files</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Baafen</div><div class="date">23rd August 2006, 12:29</div></div><div class="posttext">Hello!<br />
Im new to NSIS but i have made som installers.<br />
But now im trying to make so only the installed files gets uninstalled. I found this (http://nsis.sourceforge.net/Uninstall_only_installed_files) <br />
But then my uninstallers uninstalls I stops then i trys to delete the folder. For example: then the uninstaller trys to uninstall INSTDIR\direxample the uninstallers stop and does nothing.<br />
whats wrong with the code? If I skip to install that section that dosent work an other one makes it stop :(<br />
<br />
Here is the code for one section that dont work:<br />
Section &quot;FGDs&quot; SEC02<br />
  ${AddItem} &quot;$INSTDIR\fgd&quot;<br />
  ${SetOutPath} &quot;$INSTDIR\fgd\counter-strike&quot;<br />
  ${File} &quot;C:\Documents and Settings\Jocke\Skrivbord\Baafens mapp\instaler\Mapping\instalfiler\FGD\fgd\counter-strike\&quot; &quot;cs_expert-tom793c.fgd&quot;<br />
  ${File} &quot;C:\Documents and Settings\Jocke\Skrivbord\Baafens mapp\instaler\Mapping\instalfiler\FGD\fgd\counter-strike\&quot; &quot;halflife-cs_expert.fgd&quot;<br />
  ${SetOutPath} &quot;$INSTDIR&quot;<br />
  ${File} &quot;C:\Documents and Settings\Jocke\Skrivbord\Baafens mapp\instaler\Mapping\instalfiler\&quot; &quot;Readme Baafen VHETOOLS Pack.txt&quot;<br />
SectionEnd<br />
<br />
<br />
and this is how the uninstall sections looks like:<br />
Section -closelogfile<br />
 FileClose $UninstLog<br />
 SetFileAttributes &quot;$INSTDIR\${UninstLog}&quot; READONLY|SYSTEM|HIDDEN<br />
SectionEnd<br />
 <br />
Section Uninstall<br />
 <br />
 ; Can't uninstall if uninstall log is missing!<br />
 IfFileExists &quot;$INSTDIR\${UninstLog}&quot; +3<br />
  MessageBox MB_OK|MB_ICONSTOP &quot;$(UninstLogMissing)&quot;<br />
   Abort<br />
 <br />
 Push $R0<br />
 Push $R1<br />
 Push $R2<br />
 SetFileAttributes &quot;$INSTDIR\${UninstLog}&quot; NORMAL<br />
 FileOpen $UninstLog &quot;$INSTDIR\${UninstLog}&quot; r<br />
 StrCpy $R1 0<br />
 <br />
 GetLineCount:<br />
  ClearErrors<br />
   FileRead $UninstLog $R0<br />
   IntOp $R1 $R1 + 1<br />
   IfErrors 0 GetLineCount<br />
 <br />
 LoopRead:<br />
  FileSeek $UninstLog 0 SET<br />
  StrCpy $R2 0<br />
  FindLine:<br />
   FileRead $UninstLog $R0<br />
   IntOp $R2 $R2 + 1<br />
   StrCmp $R1 $R2 0 FindLine<br />
 <br />
   StrCpy $R0 $R0 -2<br />
   IfFileExists &quot;$R0\*.*&quot; 0 +3<br />
    RMDir $R0  #is dir<br />
   Goto +3<br />
   IfFileExists $R0 0 +2<br />
    Delete $R0 #is file<br />
 <br />
  StrCmp $R1 0 LoopDone<br />
  IntOp $R1 $R1 - 1<br />
  Goto LoopRead<br />
 LoopDone:<br />
 FileClose $UninstLog<br />
 Delete &quot;$INSTDIR\${UninstLog}&quot;<br />
 Pop $R2<br />
 Pop $R1<br />
 Pop $R0<br />
 <br />
SectionEnd<br />
<br />
I have attached the script/code so you can take a look at the whole script and see if you can find anny wrong with it.<br />
<br />
EDIT: Now I have another problem to. I have 4 things that can be installed with the installer. But I cant uninstall if the first of them is installed. Its says that it cant find the uninstal log. Again see the attached code.<br />
<br />
EDIT Agian: Now I saw that then the uninstallers just stop The folder that it trys to remove is removed. Only 2 files is left and that is the uninstaller and the log that the uninstaller uses, How can I fix this?<br />
<br />
// Sorry for my bad english I hope you understand</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Baafen</div><div class="date">23rd August 2006, 15:55</div></div><div class="posttext">Sorry for dubble post but I cant edit anymore..<br />
Well I have only one thing left.<br />
The uninstaller dosent delete the uninstall.log thats why my uninstaller freeze.<br />
<br />
This part is that will delete the uninstall.log but i dont<br />
 FileClose $UninstLog<br />
 Delete &quot;$INSTDIR\${UninstLog}&quot;<br />
 Pop $R2<br />
 Pop $R1<br />
 Pop $R0</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comperio</div><div class="date">23rd August 2006, 16:47</div></div><div class="posttext">It's a bit odd, but here's a couple things you might look at:<br />
1.  $INSTDIR during uninstall is the directory in which the Uninstaller is located, which means that it's NOT necessarily what $INSTIDR was set to during the install.  So it could be that you are not even in the right directory (or at least not in the directory you think you are.)<br />
<br />
2.  The uninstaller by default copies itself to the TEMP folder and runs from there, which would also mean that $INSTDIR could be pointed to your temp directory and not where you intended. <br />
<br />
My recommendation would be that during install, you write $INSTDIR either to the registry or save it to a known file location.  Then, during uninstall read the value back to you know exactly where to look.  <br />
<br />
You can also specify $INSTDIR during uninstall by using the _? switch.  Refer to the section 3.2.2 of the help files for more info.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Baafen</div><div class="date">23rd August 2006, 16:58</div></div><div class="posttext">_?= sets $INSTDIR. It also stops the uninstaller from copying itself to the temporary directory and running from there. It can be used along with ExecWait to wait for the uninstaller to finish. It must be the last parameter used in the command line and must not contain any quotes, even if the path contains spaces.<br />
<br />
But the user who installs the files can choose were to install. So if I sett the $INSTDIR to C:Program/name and if the user installs the program at C:name. What will happen then?<br />
<br />
My recommendation would be that during install, you write $INSTDIR either to the registry or save it to a known file location. Then, during uninstall read the value back to you know exactly where to look. <br />
<br />
Like I said Im kind of new to NSIS so how can I make this <br />
work?<br />
<br />
I think I know what the problem is now. I think the prolem is that uninstall.log is  still in use. Then I try to delete it my computer says that uninstall.log is in use. <br />
<br />
So FileClose $UninstLog dosent do what i should do..<br />
I hope someone can answear how to solve this.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>