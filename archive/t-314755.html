<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Check app version before installing, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Check app version before installing NSIS Discussion" />
	
	<title> Check app version before installing [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Check app version before installing</div>
<hr />
<div class="pda"><a href="t-314755.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=314755">Check app version before installing</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Olibara</div><div class="date">20th November 2009, 16:11</div></div><div class="posttext">Hello<br />
<br />
I'm installing .NET cSharp application<br />
<br />
If necessary, I need to advice some user about version compatibility before installing. So I have to do some check before to replace an older version<br />
<br />
What will be the best way to do that ?<br />
<br />
Thanls for any help</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CG!</div><div class="date">20th November 2009, 21:09</div></div><div class="posttext">if there's a reg key containing the version number you can use the easie way or you check the version by extracting the version number from a file (exe, dll aso) which is located by reading it's path from the registry.<br />
<br />
Extract version number from file:<br />
!define StrReplace '!insertmacro &quot;_strReplaceConstructor&quot;'<br />
<br />
Var STR_REPLACE_VAR_0<br />
Var STR_REPLACE_VAR_1<br />
Var STR_REPLACE_VAR_2<br />
Var STR_REPLACE_VAR_3<br />
Var STR_REPLACE_VAR_4<br />
Var STR_REPLACE_VAR_5<br />
Var STR_REPLACE_VAR_6<br />
Var STR_REPLACE_VAR_7<br />
Var STR_REPLACE_VAR_8<br />
<br />
!macro _strReplaceConstructor OUT NEEDLE NEEDLE2 HAYSTACK<br />
	Push &quot;${HAYSTACK}&quot;<br />
	Push &quot;${NEEDLE}&quot;<br />
	Push &quot;${NEEDLE2}&quot;<br />
	Call StrReplace<br />
	Pop &quot;${OUT}&quot;<br />
!macroend<br />
<br />
Function StrReplace<br />
	Exch $STR_REPLACE_VAR_2<br />
	Exch 1<br />
	Exch $STR_REPLACE_VAR_1<br />
	Exch 2<br />
	Exch $STR_REPLACE_VAR_0<br />
	StrCpy $STR_REPLACE_VAR_3 -1<br />
	StrLen $STR_REPLACE_VAR_4 $STR_REPLACE_VAR_1<br />
	StrLen $STR_REPLACE_VAR_6 $STR_REPLACE_VAR_0<br />
	loop:<br />
		IntOp $STR_REPLACE_VAR_3 $STR_REPLACE_VAR_3 + 1<br />
		StrCpy $STR_REPLACE_VAR_5 $STR_REPLACE_VAR_0 $STR_REPLACE_VAR_4 $STR_REPLACE_VAR_3<br />
		StrCmp $STR_REPLACE_VAR_5 $STR_REPLACE_VAR_1 found<br />
		StrCmp $STR_REPLACE_VAR_3 $STR_REPLACE_VAR_6 done<br />
		Goto loop<br />
	found:<br />
		StrCpy $STR_REPLACE_VAR_5 $STR_REPLACE_VAR_0 $STR_REPLACE_VAR_3<br />
		IntOp $STR_REPLACE_VAR_8 $STR_REPLACE_VAR_3 + $STR_REPLACE_VAR_4<br />
		StrCpy $STR_REPLACE_VAR_7 $STR_REPLACE_VAR_0 &quot;&quot; $STR_REPLACE_VAR_8<br />
		StrCpy $STR_REPLACE_VAR_0 $STR_REPLACE_VAR_5$STR_REPLACE_VAR_2$STR_REPLACE_VAR_7<br />
		StrLen $STR_REPLACE_VAR_6 $STR_REPLACE_VAR_0<br />
		Goto loop<br />
	done:<br />
	Pop $STR_REPLACE_VAR_1<br />
	Pop $STR_REPLACE_VAR_1<br />
	Exch $STR_REPLACE_VAR_0<br />
FunctionEnd<br />
<br />
Function GetFileVersion<br />
	!define GetFileVersion `!insertmacro GetFileVersionCall`<br />
	!macro GetFileVersionCall _FILE _RESULT<br />
		Push `${_FILE}`<br />
		Call GetFileVersion<br />
		Pop ${_RESULT}<br />
	!macroend<br />
	Exch $0<br />
	Push $1<br />
	Push $2<br />
	Push $3<br />
	Push $4<br />
	Push $5<br />
	Push $6<br />
	ClearErrors<br />
	GetDllVersion '$0' $1 $2<br />
	IfErrors error<br />
	IntOp $3 $1 &gt;&gt; 16<br />
	IntOp $3 $3 &amp; 0x0000FFFF<br />
	IntOp $4 $1 &amp; 0x0000FFFF<br />
	IntOp $5 $2 &gt;&gt; 16<br />
	IntOp $5 $5 &amp; 0x0000FFFF<br />
	IntOp $6 $2 &amp; 0x0000FFFF<br />
	StrCpy $0 '$3.$4.$5.$6'<br />
	goto end<br />
	error:<br />
	SetErrors<br />
	StrCpy $0 ''<br />
	end:<br />
	Pop $6<br />
	Pop $5<br />
	Pop $4<br />
	Pop $3<br />
	Pop $2<br />
	Pop $1<br />
	Exch $0<br />
FunctionEnd<br />
<br />
Function .onInit<br />
	StrCpy $R1 &quot;0&quot;<br />
	ReadRegStr $R0 HKLM &quot;Software\DESiRED SOFTWARE&quot; &quot;installDir&quot;<br />
	StrCmp $R0 &quot;&quot; NO_SW 0<br />
	IfFileExists &quot;$R0\PROGRAM.EXE&quot; 0 NO_EXE<br />
	StrCpy $R1 &quot;1&quot;<br />
	${GetFileVersion} &quot;$R0\PROGRAM.EXE&quot; $R2<br />
	${StrReplace} '$R3' '.' '' '$R2'<br />
	${if} $R3 == &quot;&quot;<br />
		MessageBox MB_OK &quot;No version information found.&quot; IDOK Inst<br />
	${else}<br />
		${if} $R3 == &quot;0815&quot;<br />
			;MessageBox MB_OK &quot;Compatible version found.&quot; IDOK Inst<br />
			Goto Inst<br />
		${else}<br />
			${if} $R3 &lt;= &quot;0815&quot;<br />
				MessageBox MB_OK &quot;SOFTWARE $R2 found.$\r$\nVersion 08.15 recommended.&quot; IDOK Inst<br />
			${else}<br />
				${if} $R3 &gt;= &quot;0815&quot;<br />
					MessageBox MB_OK &quot;SOFTWARE version 08.15 expected but version $R2 found.&quot; IDOK Inst<br />
				${else}<br />
					MessageBox MB_OK &quot;Error extracting version number from file.&quot; IDOK Inst<br />
				${endif}<br />
			${endif}<br />
		${endif}<br />
	${endif}<br />
	NO_SW:<br />
		MessageBox MB_OK &quot;SOFTWARE installation not found.&quot; IDOK Inst<br />
		GoTo Inst<br />
	NO_EXE:<br />
		MessageBox MB_OK &quot;SOFTWARE installation found but FILE not found in given path.&quot; IDOK Inst<br />
		GoTo Inst<br />
	Inst:<br />
FunctionEnd<br />
i know, this code is quite a mess, but it works for me.<br />
All dots are removed from the version number before comparing.<br />
<br />
P.s.: Some of the $Rx vars are reused later so they may look unused in this example. But i only copied and pasted it. Sorry.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Olibara</div><div class="date">20th November 2009, 22:08</div></div><div class="posttext">Thank you CG!<br />
<br />
I will try that<br />
<br />
Another Idea :<br />
<br />
Do you know if there is a way to make a two step install<br />
1- Install some DLL or piece of software<br />
2- Run that dll to make some evaluation<br />
3- Continue the install dependind dll return code ?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CG!</div><div class="date">20th November 2009, 22:16</div></div><div class="posttext">i'm sure it's possible with NSiS but i dunno how or if it's easie.<br />
i would code my own executable that calls the DLL and sets an ErrorLevel on exit which can easiely be read by NSiS.<br />
in most cases i use VB6 or C++ (due to no limitations by the need of no Framework), wrap it up inside NSiS and call it with ExecWait. Afterwards NSiS just reads the ErrorLevel.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">21st November 2009, 06:31</div></div><div class="posttext">You can call dll functions with the system plugin.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Olibara</div><div class="date">21st November 2009, 13:30</div></div><div class="posttext">&lt;&lt;You can call dll functions with the system plugin&gt;&gt;<br />
<br />
Hello<br />
<br />
Thank for your reply<br />
<br />
Can you give more explaination ...<br />
Obviously the dll must already exist on the machine ?<br />
<br />
What will be the process to install the dll, call it during the install process and allow some decision depending of the dll return code (abort installation for example)<br />
<br />
Also can it be a .NET dll or must it be a native C dll</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">21st November 2009, 14:31</div></div><div class="posttext">If you only need it once, just unpack your dll to a temp directory using the File command ($PLUGINSDIR would be an obvious choice), run the dll, then delete the dll again. How to call a dll function is explained and demonstrated in the system plugin readme.<br />
<br />
If you want to register the dll, you could use regsvr32.exe for that, but there's also a standard macro described in the documentation (appendix B).<br />
<br />
As for registering a .net dll, google is your friend.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>