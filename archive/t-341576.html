<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Need install at user level, but elevate as needed, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Need install at user level, but elevate as needed NSIS Discussion" />
	
	<title> Need install at user level, but elevate as needed [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Need install at user level, but elevate as needed</div>
<hr />
<div class="pda"><a href="t-341576.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=341576">Need install at user level, but elevate as needed</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">cpp1977</div><div class="date">1st February 2012, 19:59</div></div><div class="posttext">For the install I'm building, I'm needing to read keys in the registry placed there by another one of our installs.  This must happen at a user level, because if the install is elevated to admin, those keys don't exist.  But then, I need to add files to Program Files (x86), and it's failing simply saying &quot;error opening file for writing:.... etc&quot;<br />
<br />
Most of what I need to do happens at user level, but for things like installing files I want it to up the level momentarily to get the files down.   We have a wix install that does something like this. Can NSIS do it?<br />
<br />
thank you.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Brummelchen</div><div class="date">1st February 2012, 20:37</div></div><div class="posttext">IMO you cant elevate in between.<br />
those keys don't exist<br />
provide some code please, admin level just elevate only rights, not the place!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">cpp1977</div><div class="date">1st February 2012, 23:19</div></div><div class="posttext">I'm home now and not in front of my work pc, but the kind of code I'm doing is like this:<br />
(I may mess up syntax as I'm pulling from memory, but the logic is the point here)<br />
<br />
<br />
; this next line has to be at &quot;user level&quot;<br />
ReadRegStr $0 HKLM &quot;\software\mycompany\otherstuff\filelocations&quot; &quot;installlocation&quot;<br />
<br />
SetOutDir $0<br />
; This next line must be as admin because $0 contains a folder located at c:\program files (x86)\etc\etc<br />
File myfile.exe</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">2nd February 2012, 06:56</div></div><div class="posttext">admin level just elevate only rights, not the place!<br />
No. The entire HKCU hive is user-specific. That's the whole point.<br />
<br />
cpp1977: You can use enumusersreg to enumerate all userhives in HKU.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Brummelchen</div><div class="date">2nd February 2012, 13:56</div></div><div class="posttext">The entire HKCU hive is user-specific<br />
thats right - but elevating does not mean changing user - user just gain this moment admin rights.<br />
ReadRegStr $0 HKLM<br />
HKLM is branch for system, not user (HKCU), and is for all user same!<br />
<br />
script needs to elevate for writing in programfiles.<br />
<br />
but as i see (x86) - user uses the wrong branch in its 64bit system.<br />
it need to set setregview to 32 or 64 to get the 32bit or 64bit registry tree<br />
so there is no wonder why i always catch no value<br />
<br />
see also<br />
http://forums.winamp.com/showthread.php?p=2841243&amp;posted=1#post2841243<br />
<br />
nsis is a formerly 32bit program so it access is not this branch<br />
HKLM &quot;\software\mycompany\otherstuff\filelocations&quot;<br />
<br />
it access is at HKLM &quot;\software\wow3264node\mycompany\otherstuff\filelocations&quot;<br />
thats the relocation for 32bit programs registry.<br />
<br />
read my linked answer!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">cpp1977</div><div class="date">2nd February 2012, 14:15</div></div><div class="posttext">Ok, so when I <br />
RequestExecutionLevel admin<br />
If I do SetRegView 32 before my read to HKLM, that works, but now I have a new problem<br />
I need to read a registry key from HKCU, but at admin level, this doesn't exist.<br />
This &quot;enumusersreg&quot; key doesn't exist in NSIS help.<br />
How do I run at admin level, but read the current user's registry?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">cpp1977</div><div class="date">2nd February 2012, 14:19</div></div><div class="posttext">Sorry if this posts twice, but the first time doesn't appear to take...<br />
<br />
After taking the above posts into consideration, I've gotten a little further, but now I need to read a key from HKCU, but the problem is, if I'm elevated to Admin, the keys I need don't exist.<br />
The enumusersreg doesn't exist in help, so I don't know how to use that.<br />
How can I be in admin level, but read keys from the specific current user?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Brummelchen</div><div class="date">2nd February 2012, 14:40</div></div><div class="posttext">the keys I need don't exist.<br />
then in fact they dont exist<br />
How can I be in admin level, but read keys from the specific current user? <br />
thats not possible without changing to specific user root in registry.<br />
<br />
or do you try to install from admin account (different logon) in a users place?<br />
<br />
I need to read a registry key from HKCU, but at admin level<br />
there is no difference!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">2nd February 2012, 16:03</div></div><div class="posttext">thats right - but elevating does not mean changing user - user just gain this moment admin rights.Actually, yes it does. If you elevate to an administrator user, you are running as that user. HKCU and APPDATA etc. no longer point to the original user's registry/files. For the registry if you need to write to HKCU for all user accounts, you can use EnumUsersReg (Google it).<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">cpp1977</div><div class="date">2nd February 2012, 16:09</div></div><div class="posttext">No, I don't need to write to all users's registry branches, I need to read data from the one that actually ran the install in the first place.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">2nd February 2012, 16:10</div></div><div class="posttext">You will need to use the UAC plug-in for this; read the registry before doing the elevation.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Brummelchen</div><div class="date">2nd February 2012, 17:25</div></div><div class="posttext">i will check that out soon Afrow - but strange combo anyway with user registry but program files.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Brummelchen</div><div class="date">2nd February 2012, 23:42</div></div><div class="posttext">HKLM &quot;\software\wow3264node\mycompany\otherstuff\filelocations&quot;<br />
typo - its: HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node<br />
<br />
-&gt; HKLM &quot;SOFTWARE\Wow6432Node\mycompany\otherstuff\filelocations&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">cpp1977</div><div class="date">3rd February 2012, 12:28</div></div><div class="posttext">This plug in is a bit confusing.  So it actually runs a 2nd copy?  How do I separate what I want done at user level and pass that into the inner admin copy to have the right data.  Initally I thought by running this addon I could just elivate the current install, but I'm guessing that just can't be done.  The samples don't quite cover what I need.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Yathosho</div><div class="date">3rd February 2012, 13:37</div></div><div class="posttext">once elevated with UAC, you can call a function using the UAC_AsUser_Call macro. everything in that function will be executed on user level.<br />
<br />
i've used this to create shortcuts for a user, not the admin executing the installer. the code in comments is the syntax for older uac versions.<br />
<br />
# GetFunctionAddress $0 CreateShortcuts_Startmenu<br />
# UAC::ExecCodeSegment $0<br />
!insertmacro UAC_AsUser_Call Function CreateShortcuts_Startmenu ${UAC_SYNCOUTDIR}<br />
Function CreateShortcuts_Startmenu<br />
  CreateShortCut &quot;$SMPROGRAMS\MyApp Directory\MyApp.lnk&quot; &quot;$INSTDIR\MyApp.exe&quot;<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">3rd February 2012, 14:22</div></div><div class="posttext">Using the UAC plugi this way is not ok IMHO, if you install to $programfiles you should create the shortcuts in the all users startmenu... (If a different user runs the uninstaller you will not be able to delete the shortcuts unless they are in the shared startmenu)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Yathosho</div><div class="date">3rd February 2012, 23:38</div></div><div class="posttext">interesting. just wondering what would be an &quot;ok&quot; scenario for UAC_AsUser_Call then?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">4th February 2012, 08:00</div></div><div class="posttext">The UAC plugin was designed for only one thing: Allowing the Run checkbox at the finish page to execute at userlevel instead of as admin.<br />
<br />
Installation should always either be done at userlevel for singleuser (HKCU) or at adminlevel for allusers (HKLM). That's how Windows is designed. Doing it differently is possible, but not proper and prone to problems.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">4th February 2012, 08:33</div></div><div class="posttext">interesting. just wondering what would be an &quot;ok&quot; scenario for UAC_AsUser_Call then?<br />
<br />
Because of different feature requests the AsUser macro was designed to be generic but that does not mean the things you can do with it are a good idea! Any time you break away from the per user or per machine install paradigm you are probably adding bugs (if there are several users on the same machine), the exception is the run checkbox since the install is complete and all you are doing is saving the user from having to start your app from the startmenu. (There can probably be other scenarios, just remember that when a different user starts your application the AsUser  action has not taken place)<br />
<br />
<br />
i've used this to create shortcuts for a user, not the admin executing the installer. the <br />
The correct action here for example is to use SetShellVarContext all and create the shortcuts for all users. In general, if you write to HKLM or $programfiles then you should call &quot;SetShellVarContext all&quot; in .onInit...</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>