<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" EnvVarUpdate.nsh and WM_WININICHANGE timeout, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  EnvVarUpdate.nsh and WM_WININICHANGE timeout NSIS Discussion" />
	
	<title> EnvVarUpdate.nsh and WM_WININICHANGE timeout [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  EnvVarUpdate.nsh and WM_WININICHANGE timeout</div>
<hr />
<div class="pda"><a href="t-299969.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=299969">EnvVarUpdate.nsh and WM_WININICHANGE timeout</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">ghennessey</div><div class="date">15th November 2008, 21:05</div></div><div class="posttext">The following line of code in EnvVarUpdate.nsh hangs up my installer until the timeout is hit:<br />
<br />
SendMessage ${HWND_BROADCAST} ${WM_WININICHANGE} 0 &quot;STR:Environment&quot; /TIMEOUT=5000<br />
<br />
If I comment this line out, everything seems to work fine, and there is no delay - I suspect this is for older operating systems.  I'm working on a Windows 2003 server (the installer is for server software).  I'm using NSIS 2.40.<br />
<br />
Can this line be safely removed, or is there some fix?<br />
<br />
I'm calling the function using:<br />
<br />
${EnvVarUpdate} $0 &quot;PATH&quot; &quot;A&quot; &quot;HKLM&quot; &quot;$INSTDIR\lib&quot;<br />
<br />
Thanks,<br />
<br />
Geoff.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">15th November 2008, 21:24</div></div><div class="posttext">If you remove it, changes will only take effect after reboot.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">ghennessey</div><div class="date">15th November 2008, 21:39</div></div><div class="posttext">Thanks for the quick reply.<br />
<br />
The changes seem to take without a reboot on Server 2003 - at least when I go to 'Control Panel - System' and look at the environment variables it's there after running the installer.<br />
<br />
WM_WININICHANGE seems to have been retired in newer Windows systems:<br />
<br />
http://msdn.microsoft.com/en-us/library/ms725499.aspx<br />
<br />
I tried sending a WM_SETTINGCHANGE instead and it didn't hang up, although I'm not sure how to verify if it's working, as the change takes regardless.  I'm not sure about my syntax either:<br />
<br />
SendMessage ${HWND_BROADCAST} ${WM_SETTINGCHANGE} 0 &quot;STR:Environment&quot; /TIMEOUT=5000<br />
<br />
Is there a way in NSIS to tell which operating system is in use, and filter the message appropriately?<br />
<br />
Thanks,<br />
<br />
Geoff.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">15th November 2008, 21:55</div></div><div class="posttext">The changes will appear in the control panel but if you open up a new command shell and test it you should see it won't take effect until you reboot or use the control panel to apply the change.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">ghennessey</div><div class="date">15th November 2008, 22:12</div></div><div class="posttext">Yes, you're right, the changes don't show up properly when I open a new command shell.<br />
<br />
WM_SETTINGCHANGE also doesn't solve the problem after all, in that it still hangs up.  It seemed to be working initially, but it's not anymore.  I must have made a mistake and not saved the included file.<br />
<br />
If I reduce the timeout to 250, the wait is much shorter, and the changes take - they show up in a new command prompt window.  Do you know what the timeout is waiting for?  <br />
<br />
Thanks,<br />
<br />
Geoff.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">15th November 2008, 22:15</div></div><div class="posttext">The timeout is waiting for one of the programs in your system which is not responding. It might be busy or it might have some sort of a bug preventing it from responding in time.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">ghennessey</div><div class="date">15th November 2008, 22:37</div></div><div class="posttext">That was it exactly - there was an unresponsive IEXPLORE.EXE running in the background.  After rebooting, no problem with the installer hanging up.<br />
<br />
Is a /TIMEOUT=0 valid?  Basically to say, I don't care if all the programs respond to the change, just send the message and move on?  I tried it and it seems to work - a new command prompt window reflects the change.<br />
<br />
Thanks,<br />
<br />
Geoff.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">15th November 2008, 23:06</div></div><div class="posttext">/TIMEOUT=0 is invalid and will act exactly as a normal SendMessage and this means completely synchronous. That means if you get a non responding program, there will be no timeout. If you don't mind for non responding programs, use a very small timeout, but not 0.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">ghennessey</div><div class="date">15th November 2008, 23:37</div></div><div class="posttext">Good to know!  Thanks for all your help today, it's been invaluable.<br />
<br />
Geoff.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>