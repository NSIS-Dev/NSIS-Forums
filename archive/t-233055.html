<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" How to write a good Device Driver installer?, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  How to write a good Device Driver installer? NSIS Discussion" />
	
	<title> How to write a good Device Driver installer? [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  How to write a good Device Driver installer?</div>
<hr />
<div class="pda"><a href="t-233055.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=233055">How to write a good Device Driver installer?</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">eran.liberty</div><div class="date">13th December 2005, 10:47</div></div><div class="posttext">I have 2 years old, C++ based, custom installer code for a SCSI CD drive emulation.<br />
I wish to port it to NSIS.<br />
<br />
The original code has references to functions like:<br />
SetupDiRegisterDeviceInfo, SetupDiSetDeviceRegistryProperty, SetupDiCallClassInstaller and more SetupDiXXX commands, all of which are nicely documented in the MSDN. I have seen no reference for them in the NSIS, Examples or this forum.<br />
(like to msdn info: http://msdn.microsoft.com/library/default.asp?url=/library/en-us/devio/base/device_interface_classes.asp)<br />
<br />
A bit of google'ing raised the possibility that the paradigm for device driver installation may have changed to functions like: DriverPackagePreinstall(), DriverPackageInstall(), DriverPackageUninstall() and DriverPackageGetPath(). Those have no reference in NSIS as well.<br />
(link to msdn info: http://www.microsoft.com/whdc/driver/install/DIFxtls.mspx)<br />
<br />
NSIS on its part suggest these two helpful links:<br />
link1: http://nsis.sourceforge.net/Driver_installation_and_update<br />
link2: http://nsis.sourceforge.net/Service_Control_Manager_plugin_(install_services_and_drivers_on_NT/2K/XP)<br />
<br />
Now here comes the question (at last):<br />
<br />
1. What is the right way to write a device driver installer these days? (regardless to NSIS support on the matter) <br />
<br />
2. What is NSIS support on the matter? (admit you did not see that one coming :) )<br />
<br />
10x, Liberty</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">13th December 2005, 16:11</div></div><div class="posttext">You can call external DLL functions with the System plugin which is bundled with NSIS.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">eran.liberty</div><div class="date">13th December 2005, 16:22</div></div><div class="posttext">Originally posted by Afrow UK <br />
You can call external DLL functions with the System plugin which is bundled with NSIS.<br />
-Stu  <br />
<br />
ofcourse I can... but for that I need a DLL plugin... hmmm...<br />
<br />
so I repharse my two questions....<br />
<br />
1. is there such a plugin that does all I need... saving me the time to write it myself?<br />
<br />
2. assuming I will write a plugin myself a.k.a &quot;the hard way, all the way&quot;. which installer technology is superior the SetupDiXXX or the DriverPackageXXX.?<br />
<br />
Liberty</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">13th December 2005, 18:12</div></div><div class="posttext">If it's not on the Wiki, it probably doesn't exist. It seems you'd have to write one yourself. If you do end up writing one, please upload it to the Wiki. It seems DriverPackage* was created after SetupDi* and its description at microsoft.com also states it's simpler. So I guess it's preferable. But I'd make sure it works on all target platforms first. It's very new, so it might work on 2000 and above only, or even XP and above.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">onad</div><div class="date">14th December 2005, 01:28</div></div><div class="posttext">You could do an exec of the &quot;.inf&quot; file belonging to the driver... in NSIS, maybenot fully taking the posibillity NSIS has to offer , but you are helped maybe.<br />
<br />
running an &quot;.inf&quot; is also not a easy task, some of my Delphi code I once used to install/uninstall device drivers. This Pseudo code you could convert to NSIS script<br />
<br />
Whatever way you will solve it, I expect it will not be easy  . Alternatively you could post a message with an offer to pay someone to do it for you.<br />
<br />
-----------------------------------------<br />
<br />
const<br />
  rsUSN = 'DefaultUninstall';<br />
  rsUSNntx86 = 'DefaultUninstall.ntx86'; //make sure these sections exist in your .inf file<br />
  rsShellRunDLL32 = 'rundll32.exe';<br />
<br />
<br />
...<br />
<br />
if IsWinNT then<br />
 UninstallSectionName:=rsUSNntx86<br />
else<br />
 UninstallSectionName:=rsUSN;<br />
<br />
...<br />
<br />
UnInstallLine:='advpack.dll,LaunchINFSection '+UninstallInfFileName+', '+UninstallSectionName;<br />
TargetPath:='';<br />
<br />
shellexecute(h, 'open',pchar(rsShellRunDLL32),pchar(UnInstallLine),pchar(TargetPath),SW_SHOWNORMAL);</div></div><hr />


<div class="post"><div class="posttop"><div class="username">onad</div><div class="date">14th December 2005, 01:36</div></div><div class="posttext">Oh, I forgot<br />
<br />
On 9x/ME following the DriverPackage* will not work.<br />
<br />
You can also just mimic the behaviour of the inf file alltougheter by writing to the registry, pathe etc yourself.<br />
<br />
For this you can take a snapshot with system snapshot tools for the registry, and then monitor the API calls when the driver gets installed with other tools. http://www.sysinternals.com/ has some monitoring tools for free. Also the Windowze tool may help.<br />
<br />
Good luck, you need that... and persistance!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">eran.liberty</div><div class="date">14th December 2005, 12:42</div></div><div class="posttext">Originally posted by kichik <br />
It seems DriverPackage* was created after SetupDi* and its description at microsoft.com also states it's simpler. So I guess it's preferable. But I'd make sure it works on all target platforms first. It's very new, so it might work on 2000 and above only, or even XP and above. <br />
<br />
did some more homework and in the &quot;Kernel-Mode Driver Framework&quot; (http://www.microsoft.com/whdc/driver/wdf/KMDF_pkg.mspx) the use of Co-Installer (SetupDi* functions) is explicitly specified.<br />
maybe DriverPackage* and SetupDi* are not eqvivalent in some way or maybe the KMDF is not up to date...<br />
I will look for some microsoft forum for this one.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>