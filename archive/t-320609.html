<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" [Plugin] WPatch : Optimized incremental patch system, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  [Plugin] WPatch : Optimized incremental patch system NSIS Discussion" />
	
	<title> [Plugin] WPatch : Optimized incremental patch system [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  [Plugin] WPatch : Optimized incremental patch system</div>
<hr />
<div class="pda"><a href="t-320609.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=320609">[Plugin] WPatch : Optimized incremental patch system</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Wizou</div><div class="date">8th July 2010, 00:53</div></div><div class="posttext">I just released WPatch for wide public release, after having been extensively tested in production environment.<br />
Web site: http://wiz0u.free.fr/prog/WPatch/<br />
<br />
Presentation<br />
<br />
WPatch is an optimized incremental patch system for NSIS (Nullsoft Install System).<br />
This patch system consists of 3 tools:<br />
<br />
      WGenPat: Compares 2 versions of the same file and creates a chunk of binary data describing the changes needed to transform the &quot;old&quot; version into the &quot;new&quot; one<br />
      WGenPatDir: Compares 2 directories (using WGenPat eventually) and creates a NSIS script that can patch the first directory to transform it into the second directory<br />
      WPatch: NSIS plugin that use this binary data to convert effectively an &quot;old&quot; version of the file into the &quot;new&quot; version of the file.<br />
<br />
Original Features (and improvements over the VPatch system included in NSIS)<br />
<br />
      In-place patching:<br />
     WPatch is will patch files &quot;in-place&quot; in one pass. It does not create a temporary copy of the files to patch, and modifies the original file directly. This means the final user don't need extra free disk space, only the final file size is required.<br />
      Fast and Precise mode:<br />
     When enabled, for each files to patch, instead of scanning the whole patch database for the file signature, it will locate immediately a specific patch information (by offset). File signature is still verified to prevent patching a wrong version of the file. This mode also allows to patch two identical source files into different target files.<br />
      Support for huge files:<br />
      By default, a MD5 hash of the whole file is calculated as the file signature to verify that the file is really in the patch database. This can lead to a significant slowdown for huge files. For those, you can choose to only use the first &amp; last 64K of the file as the signature. In this case, make sure that the beginning or end of the file contains data that are unique/specific for each patch (typically, I recommend placing a timestamp updated for each version of the huge file) <br />
<br />
WPatch has been widely tested and performance improved in a real production environment.<br />
<br />
Using the WPatch system is as simple as calling: (for example)<br />
WGenPatDir.exe --precise --exclude *.tmp;.svn dir1 dir2to establish the difference between dir1 and dir2 (your &quot;old&quot; and &quot;new&quot; version of your program's directory), and, in your NSIS installer script:<br />
Section<br />
	InitPluginsDir<br />
	;...<br />
	; $INSTDIR points to the directory dir1 that is going to be transformed into dir2<br />
SectionEnd<br />
!include WGenPatDir.nsh<br />
Section<br />
	IfErrors 0 +2<br />
		MessageBox MB_OK &quot;There has been some errors !&quot;<br />
	;...<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">8th July 2010, 05:49</div></div><div class="posttext">Great work, again! I'll try this out for our patching installer project, if we ever get around to making an update. :-)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">zeeh3</div><div class="date">8th July 2010, 11:33</div></div><div class="posttext">Cool plugin, thanks for sharing :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">820815</div><div class="date">15th July 2010, 10:17</div></div><div class="posttext">Support for huge files<br />
4GB limit? :(</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CrushBug</div><div class="date">15th July 2010, 20:47</div></div><div class="posttext">It said huge, not gianormous. =P</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Wizou</div><div class="date">16th July 2010, 02:49</div></div><div class="posttext">4GB limit? :(<br />
<br />
mmmh i'm not sure.. maybe it supports patching files that are up to 4 GB, you will have to test... (and tell me ^^)<br />
I'm lazy about reviewing my code for this limit.. however it has been tested perfectly with 1.85 GB files..<br />
<br />
Of course, we are talking about a *patching system* here, so this assumes the 4 GB file to be patched is already installed on the target system... (which can be difficult to achieve with NSIS in the first place)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">820815</div><div class="date">18th July 2010, 10:51</div></div><div class="posttext">I've tried before to ask, on 4.34GB file<br />
[ChunkedFile] Filesize of 0 gives 0 chunks.<br />
[ChunkedFile] Memory to be used by those chunks: 0 bytes...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Wizou</div><div class="date">18th July 2010, 11:26</div></div><div class="posttext">Oh, not over 4GB, that's for sure.. (I didn't use int64)<br />
But it might be possible the system supports files between 2GB &amp; 4GB (unsigned int32)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">brim4brim</div><div class="date">18th July 2010, 13:18</div></div><div class="posttext">Hi,<br />
<br />
This seems like the closest thing to what I'm looking to achieve.  We are looking at moving NSIS installer at the moment in the company I work for and for one of our projects, we need to compare two xml files for user settings and if a line is missing from one then add it to the other file.<br />
<br />
I'm not sure if its possible to do this with your plugin?  Essentially they should have the same tags as the core files but if the XML values in the files are different, I don't want to overwrite them, I just want to add any new tags I'm adding to the software in the new release.<br />
<br />
I hope that makes sense and that you can let me know if your plugin is suitable for this purpose.<br />
<br />
Thanks for your help.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">18th July 2010, 14:58</div></div><div class="posttext">I'm not sure if its possible to do this with your plugin?  Essentially they should have the same tags as the core files but if the XML values in the files are different, I don't want to overwrite them, I just want to add any new tags I'm adding to the software in the new release.<br />
No, this cannot be done with a binary differ, as they are designed to encompass all changes at once. What you want to do can be done entirely in native NSIS code, using FileRead, StrCpy and StrCmp (or LogicLib). Something like:<br />
<br />
FileRead file1_line<br />
FileRead file2_line<br />
(some macro here to trim strings down to only the tag - maybe look for = character, or whatever)<br />
if file1_tag != file2_tag<br />
  copy file1_tag to file2<br />
  (maybe add some default value to file2)<br />
endif<br />
loop.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">brim4brim</div><div class="date">18th July 2010, 17:17</div></div><div class="posttext">ah ok cool thank you for pointing me in right direction.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Wizou</div><div class="date">18th July 2010, 23:54</div></div><div class="posttext">You seem to be looking for a 3-way merge = Take the difference between 2 files and incorporate those differences into a 3rd file, even if it contains other changes.<br />
<br />
There are a few tools that can perform this... Typically diff3 from Unix...<br />
For Windows, you may use something like http://kdiff3.sourceforge.net/<br />
<br />
Or maybe, first establish a &quot;text diff&quot; file, and apply it to patch the 3rd file. For example, use http://gnuwin32.sourceforge.net/packages/patch.htm</div></div><hr />


<div class="post"><div class="posttop"><div class="username">brim4brim</div><div class="date">19th July 2010, 00:44</div></div><div class="posttext">Even better from its description, it is exactly what I'm looking for :D<br />
<br />
It is for 100% windows use, webservice running in IIS with web/desktop front end in C# and separate Windows Mobile application too.<br />
<br />
Thanks a million :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Wizou</div><div class="date">19th July 2010, 01:48</div></div><div class="posttext">Be careful, those 3-way merge have their limits, they cannot always work if they can't find where to insert the difference (if the files have changed too much around the lines to modify)..<br />
Maybe, another solution for you could be to merge the differences more manually, by manipulating directly the XML data in the target file, for example using the nsisXML plug-in (http://wiz0u.free.fr/prog/nsisXML).</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>