<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Custom Install Options Page based off directory contents..., media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Custom Install Options Page based off directory contents... NSIS Discussion" />
	
	<title> Custom Install Options Page based off directory contents... [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Custom Install Options Page based off directory contents...</div>
<hr />
<div class="pda"><a href="t-127603.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=127603">Custom Install Options Page based off directory contents...</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Dick4</div><div class="date">7th March 2003, 16:50</div></div><div class="posttext">I'm trying to create a custom Install Options page that has 2 fields, one being a label and one being a listbox.  The only thing is, I'd like the list box to be filled with contents of a directory.  I read the instructions (and searched, btw ;)) on how to add stuff to the ini file, but how would I get the directory contents through NSIS?<br />
<br />
Alternatively, I created a vbscript that creates the ini file completely (with directory contents loaded into it), but I don't know if/how I could execute this vbscript to create the ini file...and would NSIS even like that because the INI file wouldn't be packaged with it, but it would be referenced...<br />
<br />
Here is the INI file...the listItems line is the one I am creating at run time:<br />
<br />
[Settings]<br />
NumFields=2<br />
NextButtonText=Next<br />
<br />
[Field 1]<br />
Type=label<br />
Text=Choose the database to repair from the list:<br />
Left=0<br />
Right=-1<br />
Top=0<br />
Bottom=10<br />
<br />
[Field 2]<br />
Type=DropList<br />
ListItems=1775|1776|1777|<br />
Left=0<br />
Right=-100<br />
Top=10<br />
Bottom=100</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th March 2003, 17:22</div></div><div class="posttext">Use FindFirst, FindNext and FindClose.<br />
<br />
You can find an example here:<br />
http://nsis.sourceforge.net/archive/viewpage.php?pageid=58<br />
<br />
To write to INI files just use WriteINIStr.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Dick4</div><div class="date">7th March 2003, 18:06</div></div><div class="posttext">is there a quick tutorial somewhere on what Push and Pop do?  I tried to figure them out before (because I use the GetParent function) but never really got the hang of it..</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Sunjammer</div><div class="date">7th March 2003, 18:10</div></div><div class="posttext">Push and Pop &quot;push&quot; and &quot;pop&quot; values onto and off a stack of values. Imagine a stack of plates, you add a plate to the top of the stack by pushing it on, and you remove the top plate on the stack by &quot;pop&quot;ing it off. So, push and pop just give you somewhere to store values. If you push 5 then 4 then 8 when you do three pops you will get the values back in reverse order (think about the plates analogy and you'll see why) i.e. 8, 4 then 5.<br />
<br />
Example Code:-Push 5<br />
Push 4<br />
Push 8<br />
Pop $0<br />
Pop $1<br />
Pop $2<br />
You would now have the value 8 in the variable $0, the value 4 in the variable $1 and the value 5 in variable $2. You can push anything, e.g. Push &quot;My string&quot;<br />
Push $1<br />
Push $R3<br />
<br />
Note: There is only one stack for the entire time your installer runs, so if you Push 5 at the very start it will still be there at the end if you haven't Pop'd it off the stack. It doesn't matter if you enter a function or a section or whatever, you'll still be manipulating the same stack as any other place or time in the script.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Dick4</div><div class="date">7th March 2003, 18:16</div></div><div class="posttext">ok, to take the GetParent analogy...first I do<br />
<br />
	Push $INSTDIR<br />
	Call GetParent<br />
	Pop $0<br />
<br />
Push $INSTDIR puts the INSTDIR on the top of the stack, then, when in the GetParent function I say:<br />
<br />
Exch $0<br />
<br />
I'm really &quot;calling&quot; the top item on the stack, whatever that may be...effectively returning my install directory to $0.  But then the next 2 lines read:<br />
<br />
  Push $1<br />
  Push $2<br />
<br />
$1 and $2 are empty at this point, so what gets put on the stack?  Their empty variables?  which are filled later?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Sunjammer</div><div class="date">7th March 2003, 18:20</div></div><div class="posttext">In your example Exch $0 swaps the top item on the stack with whatever value $0 contained. The value that was on the stack top before is now stored in $0, and the value that was in $0 is now the top value on the stack.<br />
<br />
If $1 and $2 are empty before the Pushes then empty values will be pushed onto the top of the stack. Pushing *never* changes the value pushed so why would you expect $0 or $1 to be different at some later time?<br />
<br />
If instead you said StrCpy $0 &quot;My example string&quot;<br />
Push $0 Then you might be pushing something useful onto the stack rather than an empty value.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Sunjammer</div><div class="date">7th March 2003, 18:21</div></div><div class="posttext">Another note, the Exch $0 (a) gets you the value pushed onto the stack by GetParent and stores it in $0 (b) saves whatever value you had in $0 before calling Exch onto the top of the stack. If you didn't care about the value in $0 before calling Exch you could use Pop $0 instead of Exch $0.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Dick4</div><div class="date">7th March 2003, 18:26</div></div><div class="posttext">ok...I actually was just reading the documentation on &quot;Exch&quot;, but I understand your analogy better.  <br />
<br />
I took the &quot;Push $1&quot; and $2 lines from the GetParent, but I think I see how that is working.  Now relating that to my issue, I need to create a line in the INI file with a string of all the file names in that directory (preferably all the .mdb file names, but that can come later).  Using the function Kichik pointed to above, it appears I would have to fill a variable with a running list of my files.  In vb I would do this via fileStr = fileStr + &quot;|&quot; + newFile.  Then, in the end write the INI file using fileStr as my string to write.  Is this how I should be going about doing this?  And how would I do it in NSIS?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th March 2003, 18:30</div></div><div class="posttext">Push $1 and Push $2 are there so when a user calls this function it won't ruin his variables. Unless you are going to create a function out of this code you don't need it.<br />
<br />
Yes, you should create the line and then write it. To append text to an existing variable use:<br />
StrCpy $0 &quot;$0|more text...&quot;<br />
This will copy &quot;$0|more text...&quot; into $0 and therefore appending &quot;more text...&quot; to $0.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Sunjammer</div><div class="date">7th March 2003, 18:32</div></div><div class="posttext">Yup InstallOptions requires you to use | to separate the list items. You want something like (untested) :-<br />
FindFirst $0 $1 &quot;c:\path\to\my\files\*.mdb&quot;<br />
StrCpy $9 &quot;&quot;<br />
StrCmp $0 &quot;&quot; error<br />
again:<br />
StrCmp $1 &quot;&quot; done<br />
StrCmp $9 &quot;&quot; 0 append<br />
StrCpy $9 $1<br />
Goto readnext<br />
append:<br />
StrCpy $9 &quot;$9|$1&quot;<br />
readnext:<br />
FindNext $0 $1<br />
Goto again<br />
done:<br />
FindClose $0<br />
; now write to the ini file<br />
WriteIniStr &quot;filename.ini&quot; &quot;section_name&quot; &quot;ListItems&quot; $9<br />
goto finished<br />
error:<br />
; hmmm<br />
finished:</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Dick4</div><div class="date">7th March 2003, 18:58</div></div><div class="posttext">Ok, I have a better grasp of what's going on, but I can't figure this out.  I have either of 2 functions right now, neither work (one is yours, Sunjammer, the other is the one Kichik linked to).  <br />
<br />
<br />
Function GetFiles<br />
  Exch $1 ; Dir<br />
  Push $2<br />
  Push $3<br />
  FindFirst $2 $3 &quot;$1\*.*&quot;<br />
  StrCmp $3 &quot;&quot; exitloop<br />
  loop:<br />
  StrCmp $3 &quot;&quot; exitloop<br />
  StrCmp $3 &quot;.&quot; next<br />
  StrCmp $3 &quot;..&quot; next<br />
  IfFileExists &quot;$1\$3\*.*&quot; next<br />
  ; Append each file to the eventual listitem variable<br />
  StrCpy $4 &quot;$4|$1\$3&quot;<br />
  next: 	<br />
  FindNext $2 $3<br />
  Goto loop<br />
  exitloop:<br />
  FindClose $2<br />
  WriteINIStr &quot;ioA.ini&quot; &quot;[Field 2]&quot; &quot;ListItems&quot; $4<br />
  Pop $3<br />
  Pop $2<br />
  Pop $1<br />
FunctionEnd<br />
<br />
Function GetFiles2<br />
  FindFirst $0 $1 &quot;C:\Payroll\client\*.mdb&quot;<br />
  StrCpy $9 &quot;&quot;<br />
  StrCmp $0 &quot;&quot; error<br />
  again:<br />
  StrCmp $1 &quot;&quot; done<br />
  StrCmp $9 &quot;&quot; 0 append<br />
  StrCpy $9 $1<br />
  Goto readnext<br />
  append:<br />
  StrCpy $9 &quot;$9|$1&quot;<br />
  readnext:<br />
  FindNext $0 $1<br />
  Goto again<br />
  done:<br />
  FindClose $0<br />
  ; now write to the ini file<br />
  WriteINIStr &quot;ioA.ini&quot; &quot;[Field 2]&quot; &quot;ListItems&quot; $9<br />
  goto finished<br />
  error:<br />
  ; hmmm<br />
  finished:<br />
FunctionEnd<br />
<br />
With the GetFiles one, this is my section<br />
<br />
<br />
Section &quot;Add Files to Drop Down List&quot;<br />
  Push $INSTDIR<br />
  Call GetFiles<br />
Sectionend</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Dick4</div><div class="date">7th March 2003, 19:00</div></div><div class="posttext">by the way, I thank you guys so much for all your help so far...you've been amazing (as always :))</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th March 2003, 19:10</div></div><div class="posttext">I replace the WriteINIStr with DetailPrint $9 and both gave the right output. You probably didn't give the right path to the INI file. If it's in $PLUGINSDIR use the IO macro or just write $PLUGINSDIR\ioA.ini, if not append the right path.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Dick4</div><div class="date">7th March 2003, 19:17</div></div><div class="posttext">ok, well, Its just getting extracted to wherever they get extracted to by default.  I tried the DetailPrint and did also see that it was working right, but its still not getting into the ini file...<br />
<br />
checking it now...this is my extract statement, btw...if it matters.<br />
<br />
  ;Extract InstallOptions INI Files<br />
  !insertmacro MUI_INSTALLOPTIONS_EXTRACT &quot;ioA.ini&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th March 2003, 19:20</div></div><div class="posttext">If you are using this macro then it goes into $PLUGINSDIR. Use its friend MUI_INSTALLOPTIONS_WRITE :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Dick4</div><div class="date">7th March 2003, 19:21</div></div><div class="posttext">ok, I am...trying that now...I found the ini file with the installoptions.dll file in a subfolder in my temp dir.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th March 2003, 19:22</div></div><div class="posttext">Yep, that's where $PLUGINSDIR hides.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Dick4</div><div class="date">7th March 2003, 19:29</div></div><div class="posttext">that didn't seem to work, either.  The NSI file is available here if you want to see that<br />
<br />
http://webpages.charter.net/dick4/files/JetComp.nsi</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th March 2003, 19:35</div></div><div class="posttext">This line is wrong:<br />
!insertmacro MUI_INSTALLOPTIONS_WRITE &quot;$PLUGINSDIR\ioA.ini&quot; &quot;[Field 2]&quot; &quot;ListItems&quot; $9<br />
<br />
It's either the macro or $PLUGINSDIR, not both. The macro adds $PLUGINSDIR_by itself.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Sunjammer</div><div class="date">7th March 2003, 19:35</div></div><div class="posttext">Wow you mean to say that my cobbled together thoughts actually amounted to something usable? I'm amazed :P</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Dick4</div><div class="date">7th March 2003, 19:38</div></div><div class="posttext">I tried that, its still not doing it right...tried it both ways</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th March 2003, 19:42</div></div><div class="posttext">Ah, there is anoter mistake in that line. The section name isn't &quot;[Field 2]&quot;, it's &quot;Field 2&quot;. The brackets mark the line being a section opening line. So it should be:<br />
!insertmacro MUI_INSTALLOPTIONS_WRITE &quot;ioA.ini&quot; &quot;Field 2&quot; &quot;ListItems&quot; $9</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Dick4</div><div class="date">7th March 2003, 19:51</div></div><div class="posttext">You're right...but its still not working...crap!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th March 2003, 19:52</div></div><div class="posttext">Does it show $9 in the details window? Can you attach the latest script too please?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">7th March 2003, 19:56</div></div><div class="posttext">Also check what is written to the INI file in the plugins dir.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Dick4</div><div class="date">7th March 2003, 19:58</div></div><div class="posttext">http://webpages.charter.net/dick4/files/JetComp.nsi <br />
<br />
INI file, too...if needed: http://webpages.charter.net/dick4/files/ioA.ini <br />
<br />
I updated with the latest script and yes, it is showing correctly in the details<br />
<br />
*edit* the ListItems line in INI file in the plugins directory is just like the original...no change has been made to it.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th March 2003, 20:02</div></div><div class="posttext">Ah... You are calling the function after the page was shown. Call it before MUI_INSTALLOPTIONS_DISPLAY in the SetCustomA function.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Dick4</div><div class="date">7th March 2003, 20:10</div></div><div class="posttext">Ok, that did it...now my only problem is that this path can change...it should be a path read from the registry...but with my current code:<br />
<br />
Function SetCustomA<br />
  Call GetFiles2<br />
  !insertmacro MUI_HEADER_TEXT &quot;$(TEXT_IO_TITLE)&quot; &quot;$(TEXT_IO_SUBTITLE)&quot;<br />
  !insertmacro MUI_INSTALLOPTIONS_DISPLAY &quot;ioA.ini&quot;<br />
FunctionEnd<br />
<br />
I'm figuring it out before I get to that part of my code.  Is there any way to do what I want?  I want to figure that drop down list AFTER I've figured out my $INSTDIR (and actually, after that because i need to get the parent dir of the $INSTDIR)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th March 2003, 20:11</div></div><div class="posttext">Make this page show after the user has selected the installation directory. Then all you'll need to do is get the parent in this function and you're set.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Dick4</div><div class="date">7th March 2003, 20:44</div></div><div class="posttext">But I don't have a directory choosing page...do I need one to do this?  I've been trying to do it all in one section and it doesn't appear to be working...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th March 2003, 20:46</div></div><div class="posttext">As sections are called after those pages are shown you can't set settings for the custom page in them. If you don't have a directory selection page then $INSTDIR is set right of the begning of the installer you should have no trouble using it in SetCustomA. If you need to work on $INSTDIR before the page shows do it in .onInit.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Dick4</div><div class="date">7th March 2003, 21:29</div></div><div class="posttext">that worked, btw...thanks a ton!<br />
<br />
I thought .onInit happened before anything else...is it listed somewhere the order in which everything happens?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th March 2003, 21:36</div></div><div class="posttext">The exact order is not listed anywhere, but in every callback function docs it's mentioned when it's exectued, sections are executed in the instfiles page, and non-callback functions when called.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>