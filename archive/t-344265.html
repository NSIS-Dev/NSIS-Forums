<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Signing an uninstaller when script runs on a networked drive..., media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Signing an uninstaller when script runs on a networked drive... NSIS Discussion" />
	
	<title> Signing an uninstaller when script runs on a networked drive... [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Signing an uninstaller when script runs on a networked drive...</div>
<hr />
<div class="pda"><a href="t-344265.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=344265">Signing an uninstaller when script runs on a networked drive...</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">kinar</div><div class="date">20th April 2012, 22:54</div></div><div class="posttext">I'm using a slightly modified version of http://nsis.sourceforge.net/Signing_an_Uninstaller<br />
<br />
When I run my script on a local drive, it works fine...<br />
<br />
However, when we build the installer for our release builds, it runs on a networked location.  In this scenario, the following line fails<br />
<br />
!system '$\&quot;${NSISDIR}\makensis.exe$\&quot; /DWRITE_TEMP_UNINSTALLER_FOR_SIGNING .\${__FILE__}' = 0<br />
<br />
With the error:<br />
<br />
Can't open script &quot;.\my_script.nsi&quot;<br />
!system: returned 1, aborting<br />
Error in script &quot;\\networklocation\my_script.nsi&quot; on line 135 -- aborting creation process<br />
<br />
My only guess is that I need to fully path the script location but I can't for the life of me find any NSIS functions to know the path where my script is located (I'm sure one exists but my google-fu is weak)...<br />
<br />
ideas?<br />
<br />
-edit- just found this further up in the execution log which pretty much confirms my suspicions...but I don't know how to fix it:<br />
<br />
!system: &quot;&quot;C:\Program Files\NSIS\makensis.exe&quot; /DWRITE_TEMP_UNINSTALLER_FOR_SIGNING my_script.nsi&quot;<br />
'\\networklocation\'<br />
CMD.EXE was started with the above path as the current directory.<br />
UNC paths are not supported.  Defaulting to Windows directory.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">21st April 2012, 01:23</div></div><div class="posttext">I could not really reproduce this problem, maybe because I'm on XP or that I have the UNC reghack for cmd.exe. Or maybe you have something in your script or cmd.exe autorun that changes the working directory.<br />
<br />
Anyway, you know the filename the first time you call makensis, if the parent is a batch file you can get the full path there and pass it in as a define.<br />
<br />
You can try to pipe it in: !system 'type .\${__FILE__}|$\&quot;${NSISDIR}\makensis.exe$\&quot; /DWRITE_TEMP_UNINSTALLER_FOR_SIGNING -' = 0<br />
<br />
There is no easy way to get the full path in NSIS but you can do something like this:<br />
!tempfile temp<br />
!system 'for %A in (&quot;.\${__FILE__}&quot;) do echo %~fA &gt; &quot;${temp}&quot;' = 0<br />
!searchparse /file &quot;${temp}&quot; &quot;&quot; myfullpath<br />
!delfile &quot;${temp}&quot; <br />
!echo &quot;self=${myfullpath}&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kinar</div><div class="date">23rd April 2012, 19:47</div></div><div class="posttext">Anders, thanks for looking into this.  What is the UNC registry hack that you are using?  I'm guessing that is why you aren't seeing the issue.<br />
<br />
I'm not scripting the install (yet) from a batch file.  Instead I'm using HM NIS Edit 2.0.3 to compile the script.<br />
<br />
Right now I've reverted to using the script on the wiki to get it to work (none of my modifications) and having very little luck.<br />
<br />
So repo steps would be:<br />
<br />
1) create script with the following:<br />
!ifdef INNER<br />
  !echo &quot;Inner invocation&quot;                  ; just to see what's going on<br />
  OutFile &quot;$%TEMP%\tempinstaller.exe&quot;       ; not really important where this is<br />
  SetCompress off                           ; for speed<br />
!else<br />
  !echo &quot;Outer invocation&quot;<br />
<br />
  ; Call makensis again, defining INNER.  This writes an installer for us which, when<br />
  ; it is invoked, will just write the uninstaller to some location, and then exit.<br />
  ; Be sure to substitute the name of this script here.<br />
<br />
  !system &quot;$\&quot;${NSISDIR}\makensis$\&quot; /DINNER ${__FILE__}&quot; = 0<br />
<br />
  ; So now run that installer we just created as %TEMP%\tempinstaller.exe.  Since it<br />
  ; calls quit the return value isn't zero.<br />
<br />
  !system &quot;$%TEMP%\tempinstaller.exe&quot; = 2<br />
<br />
  ; That will have written an uninstaller binary for us.  Now we sign it with your<br />
  ; favourite code signing tool.<br />
<br />
  !system &quot;SIGNCODE &lt;signing options&gt; $%TEMP%\uninstaller.exe&quot; = 0<br />
<br />
  ; Good.  Now we can carry on writing the real installer.<br />
<br />
  OutFile &quot;my_real_installer.exe&quot;<br />
  SetCompressor /SOLID lzma<br />
!endif<br />
<br />
Function .onInit<br />
!ifdef INNER<br />
<br />
  ; If INNER is defined, then we aren't supposed to do anything except write out<br />
  ; the installer.  This is better than processing a command line option as it means<br />
  ; this entire code path is not present in the final (real) installer.<br />
<br />
  WriteUninstaller &quot;$%TEMP%\uninstaller.exe&quot;<br />
  Quit  ; just bail out quickly when running the &quot;inner&quot; installer<br />
!endif<br />
<br />
FunctionEnd<br />
<br />
<br />
Section &quot;Files&quot; ; or whatever<br />
<br />
<br />
  ; where you would normally put WriteUninstaller ${INSTDIR}\uninstaller.exe put instead:<br />
<br />
!ifndef INNER<br />
  SetOutPath ${INSTDIR}<br />
<br />
  ; this packages the signed uninstaller<br />
<br />
  File $%TEMP%\uninstaller.exe<br />
!endif<br />
<br />
SectionEnd<br />
<br />
!ifdef INNER<br />
Section &quot;Uninstall&quot;<br />
<br />
  ; your normal uninstaller section or sections (they're not needed in the &quot;outer&quot;<br />
  ; installer and will just cause warnings because there is no WriteInstaller command)<br />
<br />
SectionEnd<br />
!endif<br />
<br />
2) place this script on a networked location (I believe anything not on the local PC will work)<br />
<br />
3) try to compile the script and you should get the same error in my initial post.<br />
<br />
I tried your idea of writing the path to a temp file but it doesn't work with the same failure scenario (C:\Windows\&lt;script filename&gt; gets written to the temp file since the !system command redirects to windows directory).<br />
<br />
For now, I've found a workaround of mapping a drive to the network location (which seems to work fine but has the added overhead of either using a batch file to map the drive on the fly or a manual pre-build environment setup step)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>