<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Recursive File/Directory Operations, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Recursive File/Directory Operations NSIS Discussion" />
	
	<title> Recursive File/Directory Operations [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Recursive File/Directory Operations</div>
<hr />
<div class="pda"><a href="t-201394.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=201394">Recursive File/Directory Operations</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">RobGrant</div><div class="date">7th December 2004, 12:34</div></div><div class="posttext">Guys. I've been looking at this stuff for a while now, and getting all tangled up in knots, hope someone can help me through this one a bit :)<br />
<br />
I need to move the contents of a directory (within which there are directories and files, each of which can contain directories and/or files, etc). I need to not move it en masse, but one at a time, as I need to perform an extra operation on each file that I move.<br />
<br />
I need to retain the folder structure as well. Currently I have this, which a) doesn't work properly, and b) doesn't retain the folder structure:<br />
<br />
<br />
Push $1<br />
Push $8<br />
Push $9<br />
StrCpy $9 &quot;$INSTDIR\scripts-temp\&quot;<br />
  <br />
startSearch:<br />
  FindFirst $0 $1 &quot;$9\*&quot;<br />
  StrCpy $8 &quot;0&quot;<br />
  loop:<br />
    StrCmp $1 &quot;&quot; dirdone<br />
    IfFileExists &quot;$9\$1\*.*&quot; IsDir NotDir<br />
    IsDir:<br />
      StrCmp $1 &quot;.&quot; bleh<br />
      StrCmp $1 &quot;..&quot; bleh<br />
      Push &quot;$9$1\&quot;<br />
      IntOp $8 $8 + &quot;1&quot;<br />
      Goto bleh<br />
    NotDir:<br />
      !insertmacro WRITE_TO_MAIN_LOG &quot;Copying file $9$1 to $INSTDIR\scripts\&quot; &quot;**&quot;<br />
      <br />
      !insertmacro COPY_FILE $9$1 &quot;$INSTDIR\scripts\&quot;<br />
    bleh:<br />
    FindNext $0 $1<br />
    Goto loop<br />
  dirdone:<br />
    IntCmp $8 &quot;0&quot; done<br />
    IntOp $8 $8 - 1<br />
    Pop $9<br />
    Goto startSearch<br />
<br />
done:<br />
Pop $9<br />
Pop $8<br />
Pop $1<br />
<br />
<br />
For completeness, here is the COPY_FILE macro:<br />
<br />
<br />
!macro COPY_FILE OLD_FILEPATH NEW_FILEPATH<br />
  ClearErrors<br />
  Rename &quot;${OLD_FILEPATH}&quot; &quot;${NEW_FILEPATH}&quot;<br />
  IfErrors +4<br />
    !insertmacro WRITE_TO_MAIN_LOG &quot;Wrote file ${NEW_FILEPATH}&quot; &quot;**&quot;<br />
    !insertmacro WRITE_TO_FILELIST_LOG &quot;${NEW_FILEPATH}&quot;<br />
  Goto +2<br />
    !insertmacro WRITE_TO_MAIN_LOG &quot;Unable to copy file '${OLD_FILEPATH}' to '${NEW_FILEPATH}'&quot; &quot;EE&quot;<br />
!macroend<br />
<br />
<br />
Thanks guys, sorry to lumber you with a nasty one like this :)<br />
<br />
-rob-</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">7th December 2004, 13:49</div></div><div class="posttext">I have a function which I've been using over many installers in the past which you can use. You'll have to wait till I get home though because the function isn't on the Archive.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RobGrant</div><div class="date">7th December 2004, 13:56</div></div><div class="posttext">Brilliant :) Thanks.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RobGrant</div><div class="date">7th December 2004, 14:08</div></div><div class="posttext">I'm getting there, just a quick bugfix and it copies it properly, but again without recreating the directory structure:<br />
<br />
<br />
Push $1<br />
Push $8<br />
Push $9<br />
StrCpy $9 &quot;$INSTDIR\scripts-temp\&quot;<br />
  <br />
StrCpy $8 &quot;0&quot;<br />
startSearch:<br />
  FindFirst $0 $1 &quot;$9\*&quot;<br />
  loop:<br />
    StrCmp $1 &quot;&quot; dirdone<br />
    IfFileExists &quot;$9\$1\*.*&quot; IsDir NotDir<br />
    IsDir:<br />
      StrCmp $1 &quot;.&quot; bleh<br />
      StrCmp $1 &quot;..&quot; bleh<br />
      Push &quot;$9$1\&quot;<br />
      IntOp $8 $8 + 1<br />
      Goto bleh<br />
    NotDir:<br />
      !insertmacro COPY_FILE $9$1 &quot;$INSTDIR\scripts\$1&quot;<br />
    bleh:<br />
      FindNext $0 $1<br />
      Goto loop<br />
  dirdone:<br />
    IntCmp $8 &quot;0&quot; done<br />
    IntOp $8 $8 - 1<br />
    Pop $9<br />
    Goto startSearch<br />
<br />
done:<br />
Pop $9<br />
Pop $8<br />
Pop $1</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">7th December 2004, 17:28</div></div><div class="posttext">StrCpy $DirPath &quot;C:\blah&quot;<br />
StrCpy $Location &quot;D:\blah&quot;<br />
 Function GetFiles<br />
  Push $R1<br />
  Push $R2<br />
  Push $R3<br />
  Push $R4<br />
<br />
  StrCpy $R3 1<br />
<br />
  Push &quot;&quot;<br />
<br />
  nextDir:<br />
    Pop $R4<br />
    IntOp $R3 $R3 - 1<br />
    ClearErrors<br />
<br />
    FindFirst $R1 $R2 &quot;$DirPath$R4\*.*&quot;<br />
    checkLoop:<br />
       IfFileExists &quot;$DirPath$R4\$R2\*.*&quot; +3<br />
<br />
        ### Create directory<br />
        CreateDirectory &quot;$Location$R4&quot;<br />
<br />
       Goto checkDone<br />
       FindNext $R1 $R2<br />
       IfErrors 0 checkLoop<br />
    checkDone:<br />
    FindClose $R1<br />
<br />
    FindFirst $R1 $R2 &quot;$DirPath$R4\*.*&quot;<br />
<br />
    nextFile:<br />
      StrCmp $R2 &quot;.&quot; gotoNextFile<br />
      StrCmp $R2 &quot;..&quot; gotoNextFile<br />
<br />
      IfFileExists &quot;$DirPath$R4\$R2\*.*&quot; 0 notDir<br />
          IntOp $R3 $R3 + 1<br />
          Push &quot;$R4\$R2&quot;<br />
          Goto gotoNextFile<br />
<br />
      notDir:<br />
<br />
          ### Copy a file<br />
          CopyFiles &quot;$DirPath$R4\$R2&quot; &quot;$Location$R2&quot;<br />
<br />
  gotoNextFile:<br />
    FindNext $R1 $R2<br />
    IfErrors 0 nextFile<br />
<br />
    FindClose $R1<br />
<br />
    StrCmp $R3 0 0 nextDir<br />
<br />
  Pop $R4<br />
  Pop $R3<br />
  Pop $R2<br />
  Pop $R1<br />
 FunctionEnd<br />
<br />
You just need to adapt it now.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">8th December 2004, 08:52</div></div><div class="posttext">Function Locate v1.2<br />
http://nsis.sourceforge.net/archive/nsisweb.php?page=634&amp;instances=0 <br />
<br />
<br />
Function Locate<br />
;.....<br />
FunctionEnd<br />
<br />
Section<br />
	StrCpy $R0 &quot;C:\CM&quot;   ;Directory copy from<br />
	StrCpy $R1 &quot;C:\CM2&quot;  ;Directory copy into<br />
	StrLen $R2 $R1<br />
<br />
	!insertmacro Locate &quot;$R0&quot; &quot;/L=F&quot; &quot;CallBack&quot;<br />
<br />
	IfErrors 0 +2<br />
	MessageBox MB_OK 'error'<br />
SectionEnd<br />
<br />
Function CallBack<br />
	StrCpy $1 $R8 '' $R2<br />
	IfFileExists '$R1\$1\*.*' +2<br />
	CreateDirectory '$R1\$1'<br />
	CopyFiles /SILENT $R9 '$R1\$1'<br />
<br />
	;Your code ...<br />
	;$R9       &quot;path\name&quot; (source)<br />
	;$R8       &quot;path&quot;      (source)<br />
	;$R1\$1    &quot;path&quot;      (destination)<br />
	;$R7       &quot;name&quot;<br />
<br />
	Push $0<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RobGrant</div><div class="date">8th December 2004, 10:02</div></div><div class="posttext">Instructor, Afrow, cheers guys much appreciated.<br />
<br />
One question - in the Locate Callback, I want to be able to just copy the directories first, so I can log the file copying afterwards. If I comment out this line:<br />
<br />
<br />
CopyFiles /SILENT $R9 '$R1\$1'<br />
<br />
<br />
...then it doesn't make all of the directory structure, but it DOES make some of it!<br />
<br />
Any reason? CopyFiles docs don't seem to really say whether or not the function will create directories as well as files...<br />
<br />
Cheers<br />
<br />
-rob-</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">8th December 2004, 10:35</div></div><div class="posttext">Function Locate<br />
;.....<br />
FunctionEnd<br />
<br />
Section<br />
	StrCpy $R0 &quot;C:\CM&quot;   ;Directory copy from<br />
	StrCpy $R1 &quot;C:\CM2&quot;  ;Directory copy into<br />
	StrLen $R2 $R1<br />
<br />
	GetTempFileName $0<br />
	FileOpen $R3 $0 w<br />
	!insertmacro Locate &quot;$R0&quot; &quot;/L=F&quot; &quot;CallBack&quot;<br />
	FileClose $R4<br />
<br />
	IfErrors 0 +2<br />
	MessageBox MB_OK 'error'<br />
<br />
	Exec '&quot;notepad.exe&quot; &quot;$0&quot;'     ;view log<br />
SectionEnd<br />
<br />
Function CallBack<br />
	StrCpy $1 $R8 '' $R2<br />
	StrCmp $1 '' +2<br />
	StrCpy $1 '\$1'<br />
	IfFileExists '$R1\$1\*.*' +2<br />
	CreateDirectory '$R1$1'<br />
	CopyFiles /SILENT $R9 '$R1$1'<br />
<br />
	;Your code ...<br />
	;$R9       &quot;path\name&quot; (source)<br />
	;$R8       &quot;path&quot;      (source)<br />
	;$R1$1     &quot;path&quot;      (destination)<br />
	;$R7       &quot;name&quot;<br />
<br />
	IfFileExists '$R1$1\$R7' 0 +3<br />
	FileWrite $R3 &quot;-old:$R9  -new:$R1$1\$R7  -success$\r$\n&quot;<br />
	goto +2<br />
	FileWrite $R3 &quot;-old:$R9  -new:$R1$1\$R7  -failed$\r$\n&quot;<br />
<br />
	Push $0<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RobGrant</div><div class="date">8th December 2004, 11:43</div></div><div class="posttext">Is that FileClose $R4 meant to be $R3? I'm not being funny but this isn't working properly either way so it could well be right...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">8th December 2004, 13:13</div></div><div class="posttext">Yes it should be.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RobGrant</div><div class="date">8th December 2004, 14:12</div></div><div class="posttext">Instructor - I tried to get that to work but it was weird, the $0 variable seemed to be very temperamental.<br />
<br />
Not sure what the problem was, so I went back to the solution I posted.<br />
<br />
Thanks anyway both of you, much appreciated!<br />
<br />
-rob-<br />
<br />
P.S. if anyone has helpful comments for other people who need to do this feel free to post...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">9th December 2004, 08:07</div></div><div class="posttext">Sorry, I had little time for answer yesterday and I have done the pair of absurd mistakes.<br />
<br />
Copy files with log:<br />
<br />
Section<br />
	StrCpy $R0 &quot;C:\CM&quot;   ;Directory copy from<br />
	StrCpy $R1 &quot;C:\CM2&quot;  ;Directory copy into<br />
	StrLen $R2 $R0<br />
<br />
	GetTempFileName $0<br />
	FileOpen $R3 $0 w<br />
	!insertmacro Locate &quot;$R0&quot; &quot;/L=FDE&quot; &quot;CallBack&quot;<br />
	FileClose $R3<br />
<br />
	IfErrors 0 +2<br />
	MessageBox MB_OK 'error'<br />
<br />
	Exec '&quot;notepad.exe&quot; &quot;$0&quot;'     ;view log<br />
SectionEnd<br />
<br />
Function CallBack<br />
	StrCpy $1 $R8 '' $R2<br />
<br />
	StrCmp $R6 '' 0 +3<br />
	CreateDirectory '$R1$1\$R7'<br />
	goto end<br />
	CreateDirectory '$R1$1'<br />
	CopyFiles /SILENT $R9 '$R1$1'<br />
<br />
	IfFileExists '$R1$1\$R7' 0 +3<br />
	FileWrite $R3 &quot;-old:$R9  -new:$R1$1\$R7  -success$\r$\n&quot;<br />
	goto +2<br />
	FileWrite $R3 &quot;-old:$R9  -new:$R1$1\$R7  -failed$\r$\n&quot;<br />
<br />
	end:<br />
	Push $0<br />
FunctionEnd<br />
<br />
<br />
<br />
If you want recreate directory structure:<br />
<br />
Section<br />
	StrCpy $R0 &quot;C:\CM&quot;     ;Directory structure from<br />
	StrCpy $R1 &quot;C:\CM2&quot;    ;Directory structure into<br />
	StrLen $R2 $R0<br />
<br />
	!insertmacro Locate &quot;$R0&quot; &quot;/L=D&quot; &quot;CallBack&quot;<br />
<br />
	IfErrors 0 +2<br />
	MessageBox MB_OK 'error'<br />
SectionEnd<br />
<br />
Function CallBack<br />
	StrCpy $1 $R9 '' $R2<br />
	StrCmp $1 '' +2<br />
	CreateDirectory '$R1$1'<br />
<br />
	Push $0<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RobGrant</div><div class="date">9th December 2004, 10:53</div></div><div class="posttext">Instructor - thanks so much that was exactly what I needed. Here's the code just for reference purposes (the 2 logging macros aren't necessary) - it assumes that the original directory is $INSTDIR\&lt;var&gt;-temp and the new one is $INSTDIR\&lt;var&gt;, and that you want to delete the temp directory afterwards. Just Push the &lt;var&gt; having created the zip file and the 2 directories and go for it!<br />
<br />
<br />
Function unzipFiles<br />
  Exch $R9<br />
  CreateDirectory &quot;$INSTDIR\$R9&quot;<br />
  NsExec::Exec '&quot;unzip.exe&quot; -o $R9.zip'<br />
<br />
  StrCpy $R0 &quot;$INSTDIR\$R9-temp&quot;     ;Directory structure from<br />
  StrCpy $R1 &quot;$INSTDIR\$R9&quot;          ;Directory structure into<br />
  StrLen $R2 $R0<br />
  StrCpy $0 $FILE_LOG_TEMP_FILELIST<br />
  FileOpen $R3 $0 a<br />
  FileSeek $R3 &quot;0&quot; END<br />
  ClearErrors<br />
  !insertmacro Locate &quot;$R0&quot; &quot;/L=D&quot; &quot;CallBack-Directory&quot;<br />
<br />
  IfErrors 0 noscriptsdirerrors<br />
  !insertmacro WRITE_TO_MAIN_LOG &quot;Error writing directories within $R9\ directory&quot; &quot;EE&quot;<br />
  Goto writeScriptsFiles<br />
<br />
  noscriptsdirerrors:<br />
  !insertmacro WRITE_TO_MAIN_LOG &quot;Finished writing directories within $R9\ directory&quot; &quot;**&quot;<br />
<br />
  writeScriptsFiles:<br />
  ClearErrors<br />
  !insertmacro Locate &quot;$R0&quot; &quot;/L=FDE&quot; &quot;CallBack&quot;<br />
  FileClose $R3<br />
<br />
  IfErrors 0 uzEnd<br />
  !insertmacro WRITE_TO_MAIN_LOG &quot;Error writing files within $R9\ directory&quot; &quot;EE&quot;<br />
<br />
  uzEnd:<br />
  SetOutPath &quot;$INSTDIR&quot;<br />
  RMDir /r &quot;$INSTDIR\$R9-temp&quot;<br />
  Exch $R9<br />
FunctionEnd<br />
<br />
Function CallBack<br />
	StrCpy $1 $R8 '' $R2<br />
<br />
	StrCmp $R6 '' 0 +3<br />
	CreateDirectory '$R1$1\$R7'<br />
	goto end<br />
	CreateDirectory '$R1$1'<br />
	CopyFiles /SILENT $R9 '$R1$1'<br />
<br />
	IfFileExists '$R1$1\$R7' 0 c-errors<br />
	FileWrite $R3 &quot;$R1$1\$R7$\r$\n&quot;<br />
	!insertmacro WRITE_TO_MAIN_LOG &quot;Wrote file $R1$1\$R7&quot; &quot;**&quot;<br />
	goto end<br />
<br />
	c-errors:<br />
	!insertmacro WRITE_TO_MAIN_LOG &quot;Failed to write $R1$1\$R7&quot; &quot;EE&quot;<br />
<br />
	end:<br />
	Push $0<br />
FunctionEnd<br />
<br />
Function CallBack-Directory<br />
	StrCpy $1 $R9 '' $R2<br />
	StrCmp $1 '' +2<br />
<br />
	ClearErrors<br />
	CreateDirectory '$R1$1'<br />
	IfErrors c-dir-errors<br />
	FileWrite $R3 '$R1$1$\r$\n'<br />
	!insertmacro WRITE_TO_MAIN_LOG &quot;Created directory $R1$1\&quot; &quot;**&quot;<br />
	Goto end<br />
<br />
	c-dir-errors:<br />
	!insertmacro WRITE_TO_MAIN_LOG &quot;Failed to create directory $R1$1\&quot; &quot;EE&quot;<br />
<br />
        end:<br />
	Push $0<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RobGrant</div><div class="date">10th December 2004, 12:32</div></div><div class="posttext">While we're on the subject of Locate, I thought I'd have a go at listing all Windows users of a computer, by listing the names of the directories which are immediate children of the C:\Documents and Settings folder (it's a Win2k or above installer so that's fine, AFAIK).<br />
<br />
To do that I do this:<br />
<br />
<br />
Function <br />
...<br />
  Push &quot;$PROFILE&quot;<br />
  Call GetParent<br />
  Pop $R0<br />
  !insertmacro Locate &quot;$R0&quot; &quot;/L=D /G=0&quot; &quot;findusers&quot;<br />
...<br />
FunctionEnd<br />
<br />
Function &quot;findusers&quot;<br />
  MessageBox MB_OK &quot;$R7&quot;<br />
FunctionEnd<br />
<br />
<br />
Rather than giving me a nice sequence of messageboxes teling me user names, it crashes after the first one (Administrator in my case). Any ideas why?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">11th December 2004, 10:43</div></div><div class="posttext">Function &quot;findusers&quot;<br />
	MessageBox MB_OK &quot;$R7&quot;<br />
<br />
	Push $var     ; If $var=StopLocate Then exit from function<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">atsuk</div><div class="date">12th December 2004, 16:08</div></div><div class="posttext">Afrow UK's example seems to be quite good short and easy, but the problem is that it does not complitelly support wildcards. suppose i need to find *.txt instead of *.*<br />
in this case it only copyes files from $Location, but not from its subdirectories. And in case you only have $Location\subdir\file.txt it does not copy anything.<br />
<br />
does anybody have some ideas how to make it work with wildcards also?<br />
<br />
one thing should be different:<br />
original line:<br />
### Copy a file<br />
CopyFiles &quot;$DirPath$R4\$R2&quot; &quot;$Location$R2&quot;<br />
should be replaced with<br />
CopyFiles &quot;$DirPath$R4\$R2&quot; &quot;$Location$R4\$R2&quot;<br />
<br />
..but still very good script(y)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Yathosho</div><div class="date">12th December 2004, 16:30</div></div><div class="posttext">great, was just about to ask about such a function :)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>