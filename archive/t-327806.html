<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" problem with icons, CreateShortcut on 64-bit Windows and &quot;C:\Program Files (x86)&quot;, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  problem with icons, CreateShortcut on 64-bit Windows and &quot;C:\Program Files (x86)&quot; NSIS Discussion" />
	
	<title> problem with icons, CreateShortcut on 64-bit Windows and &quot;C:\Program Files (x86)&quot; [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  problem with icons, CreateShortcut on 64-bit Windows and &quot;C:\Program Files (x86)&quot;</div>
<hr />
<div class="pda"><a href="t-327806.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=327806">problem with icons, CreateShortcut on 64-bit Windows and &quot;C:\Program Files (x86)&quot;</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">o___O</div><div class="date">24th February 2011, 23:30</div></div><div class="posttext">I've creating an NSIS package and noticed that when a program is installed to the legacy 32-bit folder on 64-bit Windows 7 Ultimate SP1, that &quot;C:\Program Files (x86)&quot; is being translated either by NSIS or Windows to the environmental variable &quot;%ProgramFiles%&quot; which resolves to the 64-bit version of Program Files. Where I'm running into a problem is with CreateShortcut and the custom icon setting. Here's my code for starters:<br />
<br />
 CreateShortcut &quot;$SMPROGRAMS\${APP_NAME}\${APP_NAME}.lnk&quot; &quot;$INSTDIR\online.exe&quot; &quot;&quot; &quot;$INSTDIR\online.exe&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;Launches PSOBB&quot;<br />
 CreateShortcut &quot;$SMPROGRAMS\${APP_NAME}\Visit schtserv.com.lnk&quot; &quot;http://www.schtserv.com/&quot; &quot;&quot; &quot;$INSTDIR\online.exe&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;Visit the SCHTHACK website&quot;<br />
 CreateShortcut &quot;$SMPROGRAMS\${APP_NAME}\Register a game account.lnk&quot; &quot;http://www.schtserv.com/bbregister.php&quot; &quot;&quot; &quot;$INSTDIR\online.exe&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;You need an account to play PSOBB&quot;<br />
 CreateShortcut &quot;$SMPROGRAMS\${APP_NAME}\Community forums and support.lnk&quot; &quot;http://schtserv.com/forum/&quot; &quot;&quot; &quot;$INSTDIR\online.exe&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;Join the community&quot;<br />
 CreateShortcut &quot;$SMPROGRAMS\${APP_NAME}\Readme.txt.lnk&quot; &quot;$INSTDIR\readme.txt&quot; &quot;&quot; &quot;&quot; 0 &quot;&quot; &quot;&quot; &quot;o_o&quot;<br />
<br />
Now if I install the program anywhere inside &quot;C:\Program Files (x86)&quot; and inspect the shortcuts above (right-click-&gt;Properties), and choose &quot;Change Icon&quot; it will prompt an error that says &quot;Windows cannot find the file %ProgramFiles%\&lt;installfolder&gt;\online.exe.&quot; I did a test and found that if I placed a copy of online.exe in the 64-bit Program Files folder that the shortcut icon was found by Windows Explorer, and I did another test and found that the field was properly filled in if any folder other than C:\Program Files (x86) (such as C:\newtest) was used. What I think is NSIS has some type of code that is converting Program Files path by default to the environmental variable %ProgramFiles%. This might work on 32-bit Windows, but 64-bit Windows uses different folders for 32-bit and 64-bit and this causes the icon path at least for CreateShortcut to be resolved improperly in Windows Explorer (64-bit version).<br />
<br />
What I also found is that in some cases the icon on the shortcuts will default back to the missing shortcut icon and you have to reset the icon manually on the shortcut for it to work again, which is how I discovered this problem. It does this every time after a reboot on the first shortcut in the code, the other ones are a bit different (URLs/Internet shortcuts) that don't seem to reset as often (so far). I'm still trying to fix this problem but thought I'd report about my findings, it's obviously a bug that needs fixing somewhere.<br />
<br />
NSIS 2.46...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Zinthose</div><div class="date">24th February 2011, 23:48</div></div><div class="posttext">:eek: Removed public display of stupid...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">o___O</div><div class="date">24th February 2011, 23:55</div></div><div class="posttext">These are shortcuts being installed to the Start Menu Programs folder, ala internal NSIS Constant $SMPROGRAMS. I also found that it makes no difference what InstallDir is, the user can change directories to C:\Program Files (x86) during the installation, or manually select C:\Program Files (x86) and it will convert the shortcut icon path to %ProgramFiles%. As I said I believe NSIS detects &quot;C:\Program Files (x86)&quot; in $INSTDIR and converts it to %ProgramFiles%... unless it is some internal calls of Windows doing it (which NSIS executes), which is definitely possible.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">o___O</div><div class="date">25th February 2011, 00:10</div></div><div class="posttext">Edit, scratch part of what I said before.<br />
<br />
This was my InstallDir:<br />
<br />
InstallDir &quot;$PROGRAMFILES32\${APP_NAME}&quot;<br />
<br />
I changed it to<br />
<br />
InstallDir &quot;C:\PSOBB-installer\${APP_NAME}&quot;<br />
<br />
Rebuild...<br />
<br />
<br />
Actually, I'll just post my entire script for you to test with some test files. I think the behavior I described with %ProgramFiles% variable only occurs if $PROGRAMFILES is initially used in InstallDir, this doesn't happen after changing InstallDir like I did above, and then manually select &quot;C:\Program Files (x86)&quot; as the installation location.<br />
<br />
Here's my script &amp; test files to make it work if you wanna take a look and try it: http://strags.com/d2/nsis.zip</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Zinthose</div><div class="date">25th February 2011, 00:18</div></div><div class="posttext">Kodama, (http://en.wikipedia.org/wiki/Kodama_%28spirit%29)<br />
!define APP_NAME &quot;My App&quot;<br />
OutFile lnkTest.exe<br />
<br />
InstallDir &quot;$PROGRAMFILES\${APP_NAME}&quot;<br />
<br />
Section<br />
    SetOutPath $INSTDIR<br />
    File /oname=online.exe &quot;C:\WINDOWS\NOTEPAD.EXE&quot;<br />
    <br />
    CreateDirectory &quot;$SMPROGRAMS\${APP_NAME}&quot;<br />
    CreateShortcut &quot;$SMPROGRAMS\${APP_NAME}\${APP_NAME}.lnk&quot; &quot;$INSTDIR\online.exe&quot; &quot;&quot; &quot;$INSTDIR\online.exe&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;Launches PSOBB&quot;<br />
SectionEnd<br />
<br />
I ran this on my Windows XP x64 system and it works fine.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">o___O</div><div class="date">25th February 2011, 00:41</div></div><div class="posttext">Did you check the Change Icon function to determine if the path was set correctly? Didn't work on Win7Ult x64.. BUT the icon does show up properly, at least right after install. Problem I have run into, is that it might default back to the broken shortcut icon after awhile, which shows up on the next screen.<br />
<br />
http://strags.com/i/myapp.png<br />
http://strags.com/i/myapp.png<br />
<br />
http://strags.com/i/myapp2.png<br />
http://strags.com/i/myapp2.png</div></div><hr />


<div class="post"><div class="posttop"><div class="username">o___O</div><div class="date">25th February 2011, 00:47</div></div><div class="posttext">If I go and put a copy of online.exe (for your example) in C:\Program Files\My App, it will find it without changing the shortcut. It won't work ever without being manually updated if it's in C:\Program Files (x86) under these exact circumstances. I used the same code as you...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Zinthose</div><div class="date">25th February 2011, 01:04</div></div><div class="posttext">AH! not I see the problem... I'm going to perform some tests to see what can be done about this.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">o___O</div><div class="date">25th February 2011, 01:07</div></div><div class="posttext">Let me know what you find...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">25th February 2011, 09:28</div></div><div class="posttext">NSIS does not touch your strings, blame the windows shortcut API. At least for you main apps shortcut, try not setting the icon directly and just use &quot;&quot; as the icon path<br />
<br />
Edit: Another option would be to remove the SLDF_HAS_EXP_ICON_SZ flag and datablock after the shortcut has been created:<br />
<br />
CreateShortcut &quot;$temp\test.lnk&quot; &quot;c:\windows\system32\calc.exe&quot; &quot;&quot; &quot;c:\windows\explorer.exe&quot; 1<br />
<br />
System::Call 'OLE32::CoCreateInstance(g &quot;{00021401-0000-0000-c000-000000000046}&quot;,i 0,i 1,g &quot;{000214ee-0000-0000-c000-000000000046}&quot;,*i.r1)i'<br />
${If} $1 &lt;&gt; 0<br />
	System::Call '$1-&gt;0(g &quot;{0000010b-0000-0000-C000-000000000046}&quot;,*i.r2)'<br />
	${If} $2 &lt;&gt; 0<br />
		System::Call '$2-&gt;5(w &quot;$temp\test.lnk&quot;,i 2)i.r0'<br />
		${If} $0 = 0<br />
			System::Call '$1-&gt;0(g &quot;{45e2b4ae-b1c3-11d0-b92f-00a0c90312e1}&quot;,*i.r3)i.r0'<br />
			${If} $3 &lt;&gt; 0<br />
				System::Call '$3-&gt;5(i 0xA0000007)i.r0'<br />
				System::Call '$3-&gt;6(*i.r4)i.r0'<br />
				${If} $0 = 0 <br />
					IntOp $4 $4 &amp; 0xffffBFFF<br />
					System::Call '$3-&gt;7(ir4)i.r0'<br />
					${If} $0 = 0 <br />
						System::Call '$2-&gt;6(i0,i0)'<br />
					${EndIf}<br />
				${EndIf}<br />
				System::Call $3-&gt;2()<br />
			${EndIf}<br />
		${EndIf}<br />
		System::Call $2-&gt;2()<br />
	${EndIf}<br />
	System::Call $1-&gt;2()<br />
${EndIf}<br />
<br />
After I do this, (on XP) the change shortcut icon dialog displays c:\windows\explorer.exe and not %SystemRoot%\explorer.exe</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Zinthose</div><div class="date">25th February 2011, 16:17</div></div><div class="posttext">As usual... Awesome work Anders :up:<br />
I Wrapped your code up into a function/macro for easy implementation so I can add it to my own packages.  I have been packaging for 64bit XP for some time but never noticed the issue.  Worse yet no one has complained yet. :eek:<br />
/******************************************************************************<br />
    WORKAROUND - FixShortcut<br />
        This snippet was developed to address an issue with Windows <br />
        x64 incorectly redirecting the shortcuts icon from $PROGRAMFILES32 <br />
        to $PROGRAMFILES64.<br />
    <br />
    See Forum post: http://forums.winamp.com/newreply.php?do=postreply&amp;t=327806<br />
    <br />
    Example:<br />
        CreateShortcut &quot;$SMPROGRAMS\My App\My App.lnk&quot; &quot;$INSTDIR\My App.exe&quot; &quot;&quot; &quot;$INSTDIR\My App.exe&quot;<br />
        ${lnkX64IconFix} &quot;$SMPROGRAMS\My App\My App.lnk&quot;<br />
 <br />
    Original Code by Anders - http://forums.winamp.com/member.php?u=70852<br />
******************************************************************************/<br />
!ifndef ___lnkX64IconFix___<br />
    !verbose push<br />
    !verbose 0<br />
    <br />
    !include &quot;LogicLib.nsh&quot;<br />
    !include &quot;x64.nsh&quot;<br />
    <br />
    !define ___lnkX64IconFix___<br />
    !define lnkX64IconFix `!insertmacro _lnkX64IconFix`<br />
    !macro _lnkX64IconFix _lnkPath<br />
        !verbose push<br />
        !verbose 0<br />
        ${If} ${RunningX64}<br />
            DetailPrint &quot;WORKAROUND: 64bit OS Detected, Attempting to apply lnkX64IconFix&quot;<br />
            Push &quot;${_lnkPath}&quot;<br />
            Call lnkX64IconFix<br />
        ${EndIf}<br />
        !verbose pop<br />
    !macroend<br />
    <br />
    Function lnkX64IconFix ; _lnkPath<br />
        Exch $5<br />
        Push $0<br />
        Push $1<br />
        Push $2<br />
        Push $3<br />
        Push $4<br />
        System::Call 'OLE32::CoCreateInstance(g &quot;{00021401-0000-0000-c000-000000000046}&quot;,i 0,i 1,g &quot;{000214ee-0000-0000-c000-000000000046}&quot;,*i.r1)i'<br />
        ${If} $1 &lt;&gt; 0<br />
            System::Call '$1-&gt;0(g &quot;{0000010b-0000-0000-C000-000000000046}&quot;,*i.r2)'<br />
            ${If} $2 &lt;&gt; 0<br />
                System::Call '$2-&gt;5(w r5,i 2)i.r0'<br />
                ${If} $0 = 0<br />
                    System::Call '$1-&gt;0(g &quot;{45e2b4ae-b1c3-11d0-b92f-00a0c90312e1}&quot;,*i.r3)i.r0'<br />
                    ${If} $3 &lt;&gt; 0<br />
                        System::Call '$3-&gt;5(i 0xA0000007)i.r0'<br />
                        System::Call '$3-&gt;6(*i.r4)i.r0'<br />
                        ${If} $0 = 0 <br />
                            IntOp $4 $4 &amp; 0xffffBFFF<br />
                            System::Call '$3-&gt;7(ir4)i.r0'<br />
                            ${If} $0 = 0 <br />
                                System::Call '$2-&gt;6(i0,i0)'<br />
                                DetailPrint &quot;WORKAROUND: lnkX64IconFix Applied successfully&quot;<br />
                            ${EndIf}<br />
                        ${EndIf}<br />
                        System::Call $3-&gt;2()<br />
                    ${EndIf}<br />
                ${EndIf}<br />
                System::Call $2-&gt;2()<br />
            ${EndIf}<br />
            System::Call $1-&gt;2()<br />
        ${EndIf} <br />
        Pop $4<br />
        Pop $3<br />
        Pop $2<br />
        Pop $1<br />
        Pop $0<br />
    FunctionEnd<br />
    !verbose pop<br />
!endif</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Zinthose</div><div class="date">25th February 2011, 19:28</div></div><div class="posttext">FYI: Wiki Article Created (http://nsis.sourceforge.net/WORKAROUND:_Winx64_Shortcut_Icon_Bug)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">25th February 2011, 20:00</div></div><div class="posttext">That URL in the comment is broken. You should probably point to: http://forums.winamp.com/showthread.php?t=327806</div></div><hr />


<div class="post"><div class="posttop"><div class="username">o___O</div><div class="date">25th February 2011, 20:24</div></div><div class="posttext">NSIS does not touch your strings, blame the windows shortcut API. At least for you main apps shortcut, try not setting the icon directly and just use &quot;&quot; as the icon path<br />
<br />
Edit: Another option would be to remove the SLDF_HAS_EXP_ICON_SZ flag and datablock after the shortcut has been created:<br />
<br />
After I do this, (on XP) the change shortcut icon dialog displays c:\windows\explorer.exe and not %SystemRoot%\explorer.exe<br />
<br />
Neither of these are suitable alternatives, though. The shortcuts I want to specify the icon on are Internet links, the default icon is just ugly and doesn't go with the program. Secondly, NSIS must be involved in this process somehow, because if InstallDir is set to &quot;C:\${APP_NAME}&quot; by default rather than &quot;$PROGRAMFILES32\${APP_NAME}&quot; - one can manually select the &quot;C:\Program Files (x86)&quot; folder during installation and not have this problem (shortcut icon path is correct, icons never vanish). I think the problem has to do with how NSIS is resolving $PROGRAMFILES or handling these Constants and the environmental variables internally (might be specific to InstallDir directive or when or how these variables are used)... Give it another look.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">25th February 2011, 21:10</div></div><div class="posttext">http://nsis.sourceforge.net/CreateInternetShortcut_macro_%26_function<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Zinthose</div><div class="date">25th February 2011, 21:10</div></div><div class="posttext">Internet shortcuts are even easier to tweak as they are just ini files.<br />
<br />
URL=http://download.microsoft.com/download/8/8/8/888f34b7-4f54-4f06-8dac-fa29b19f33dd/msxml3.msi<br />
IDList=<br />
IconFile=C:\WINDOWS\system32\accwiz.exe<br />
HotKey=0<br />
IconIndex=5<br />
[{000214A0-0000-0000-C000-000000000046}]<br />
Prop3=19,2Do somthing like this..WriteINIStr &quot;$SMPROGRAMS\${APP_NAME}\My Web Site.url&quot; &quot;InternetShortcut&quot; &quot;IconFile&quot; &quot;$INSTDIR\online.exe&quot;<br />
WriteINIStr &quot;$SMPROGRAMS\${APP_NAME}\My Web Site.url&quot; &quot;InternetShortcut&quot; &quot;IconIndex&quot; 5...and it &quot;Should&quot; fix it.<br />
<br />
<br />
[I]EDIT: Or just read the Wiki article Stu Posted..  :D</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">25th February 2011, 22:32</div></div><div class="posttext">I think the problem has to do with how NSIS is resolving $PROGRAMFILES or handling these Constants and the environmental variables internally (might be specific to InstallDir directive or when or how these variables are used)... Give it another look.<br />
<br />
InstallDir does not do anything special, $PROGRAMFILES is resolved using a documented shell function and nsis itself does not use environment variables IIRC.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">o___O</div><div class="date">2nd March 2011, 10:12</div></div><div class="posttext">I found more information out about this issue. From the manual:<br />
<br />
4.8.1.21 InstallDir<br />
definstdir<br />
Sets the default installation directory. See the variables section for variables that can be used to make this string (especially $PROGRAMFILES). Note that the part of this string following the last \ will be used if the user selects 'browse', and may be appended back on to the string at install time (to disable this, end the directory with a \ (which will require the entire parameter to be enclosed with quotes). If this doesn't make any sense, play around with the browse button a bit.<br />
<br />
So the problem is with this behavior in NSIS when InstallDir doesn't end with a \. Disable this feature and the icons and shortcuts are fine.<br />
<br />
So..<br />
<br />
InstallDir &quot;$PROGRAMFILES32\SCHTHACK PSOBB&quot; has the problem.<br />
InstallDir &quot;$PROGRAMFILES32\SCHTHACK PSOBB\&quot; (disables behavior) doesn't have the problem.<br />
<br />
It seems to be something going wrong in this feature when it enumerates and appends &quot;SCHTHACK PSOBB&quot; to the directory selection. For example, a user will choose &quot;C:\Program Files (x86)&quot; as the directory rather than a sub directory, and NSIS will fill in the sub directory to match the last string of InstallDir after the last \, in this case &quot;SCHTHACK PSOBB,&quot; making it auto to C:\Program Files (x86)\SCHTHACK PSOBB\. For some reason this breaks CreateShortcut icon association and perhaps other functions in NSIS. What it looks like is Windows is looking in the 64-bit Program Files directory for the icon when this function is enabled, even though the program is really in the 32-bit Program Files folder, which I think is the result of this features functionality mixing up the 64-bit and 32-bit Program Files folders or how it resolves them.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">2nd March 2011, 13:11</div></div><div class="posttext">making it auto to C:\Program Files (x86)\SCHTHACK PSOBB\.<br />
<br />
Are you sure about this? $instdir will normally strip off the \ at the end.<br />
<br />
Try:<br />
strcpy $instdir &quot;c:\temp\&quot;<br />
MessageBox mb_ok $instdir</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Zinthose</div><div class="date">2nd March 2011, 14:59</div></div><div class="posttext">I'm going to have to confirm with Anders.<br />
<br />
I modified the test script and the issue remains.<br />
Can you provide a script that shows the working vs non?<br />
!define APP_NAME &quot;My App&quot;<br />
OutFile lnkTest.exe<br />
ShowInstDetails show<br />
<br />
InstallDir &quot;$PROGRAMFILES32\${APP_NAME}\&quot;<br />
<br />
Page directory<br />
Page instfiles<br />
<br />
Section<br />
    SetOutPath &quot;$INSTDIR\&quot;<br />
    File /oname=online.exe &quot;C:\WINDOWS\NOTEPAD.EXE&quot;<br />
    <br />
    CreateDirectory &quot;$SMPROGRAMS\${APP_NAME}&quot;<br />
    CreateShortcut &quot;$SMPROGRAMS\${APP_NAME}\${APP_NAME}.lnk&quot; &quot;$INSTDIR\online.exe&quot; &quot;&quot; &quot;$INSTDIR\online.exe&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;Launches PSOBB&quot;<br />
SectionEnd</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>