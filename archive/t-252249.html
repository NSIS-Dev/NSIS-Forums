<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Pluginsdir persists  -  system.dll, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Pluginsdir persists  -  system.dll NSIS Discussion" />
	
	<title> Pluginsdir persists  -  system.dll [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Pluginsdir persists  -  system.dll</div>
<hr />
<div class="pda"><a href="t-252249.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=252249">Pluginsdir persists  -  system.dll</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Mark Nascimento</div><div class="date">30th July 2006, 04:58</div></div><div class="posttext">Using an app of my own with installoptions, the temp folder ceated by NSIS ($temp\ns*) persists after closing the app, with the file system.dll (10Kb) inside. Soon, there are so many temp folders as the times the app was executed.<br />
How to unload this dll automatically as the app ends ?<br />
I'm not preserving any file and there is no &quot;system&quot; word in my script.<br />
I'm calling InstallOptions, tooltips, filefunc, winmessages, .onUserAbort and changeUI.<br />
:tinfoil:</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">30th July 2006, 09:44</div></div><div class="posttext">You probably have SetPluginsUnload in the script. Attach the script for a review.<br />
<br />
BTW, the remaining system.dll files are queued for deletion after reboot.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Mark Nascimento</div><div class="date">31st July 2006, 08:44</div></div><div class="posttext">Here goes the script.<br />
there are others, but this is the main.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Mark Nascimento</div><div class="date">31st July 2006, 08:55</div></div><div class="posttext">More:<br />
The others apps I use based on nsis doesn't leave files in temp dir.<br />
My &quot;startup monitor&quot; never advised me about deletion on reboot of nsis apps residues, although do it with most of other &quot;instalations&quot;.<br />
My app is not an installation.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">1st August 2006, 20:49</div></div><div class="posttext">Which of the scripts show this behavior? Does it happen with Clipboard.nsi?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Mark Nascimento</div><div class="date">4th August 2006, 09:35</div></div><div class="posttext">No. <br />
If I open a.nsi (TrocarProxy.exe) and cancel, or close (X) or do something,.. in all cases, the system.dll is not deleted.<br />
All the others, including old apps of oder versions, don't do it. I've canceled tooltips and made some changes, but is still the same.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">4th August 2006, 20:00</div></div><div class="posttext">It's a bug with the System plug-in. When a function with no arguments is called, it incorrectly calculates the number of arguments to push. Instead of pushing no arguments, it pushes one. When a stdcall function is called, like every Windows API function, it's its responsibility to clear the stack. When that extra argument is pushed and not cleared by the function, because it shouldn't, the stack gets corrupted. This causes CallProc, the function that actually calls the requested function in System.dll, to incorrectly restore the registers from the stack, including edi. In the installer code that calls the plug-in, edi is used to keep the handle to the loaded plug-in. Because of the corruption, the code calls FreeLibrary on the wrong handle and fails to unload System.dll. Because System.dll is still in use, it cannot be deleted and remains in the temporary folder.<br />
<br />
In your case, it's the CopyFromClipboard function that triggers this bug. It calls CloseClipboard which has no arguments. To avoid this bug, for now, you can use:System::Call &quot;user32::CloseClipboard()?c&quot;Notice the `?c` addition. It tells System to treat the function as a cdecl function, which means System will clear the stack for it. Because the function has no arguments, System will only clear the arguments it wrongly pushed.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Mark Nascimento</div><div class="date">4th August 2006, 21:29</div></div><div class="posttext">FINISHED !<br />
You really know about these things.<br />
THANK YOU !</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">6th August 2006, 17:29</div></div><div class="posttext">Fixed for 2.19.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>