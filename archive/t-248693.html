<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" SetShellVarContext all --&gt; $DOCUMENTS, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  SetShellVarContext all --&gt; $DOCUMENTS NSIS Discussion" />
	
	<title> SetShellVarContext all --&gt; $DOCUMENTS [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  SetShellVarContext all --&gt; $DOCUMENTS</div>
<hr />
<div class="pda"><a href="t-248693.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=248693">SetShellVarContext all --&gt; $DOCUMENTS</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">lievencardoen</div><div class="date">14th June 2006, 10:23</div></div><div class="posttext">SetShellVarContext all<br />
MessageBox MB_OK $DOCUMENTS <br />
<br />
This still shows the path to my local user documents and not to all users documents...<br />
<br />
Why? I'm working on Windows XP SP2, so this should work, as all users folder does exist...<br />
<br />
Lieven</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">14th June 2006, 11:52</div></div><div class="posttext">Strange, I am also getting the same ...<br />
CF</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">14th June 2006, 15:00</div></div><div class="posttext">works for me (XP SP2 MCE2k5)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">lievencardoen</div><div class="date">14th June 2006, 15:23</div></div><div class="posttext">Well, apparently it is not to be trusted...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JeronimoColon</div><div class="date">15th June 2006, 23:03</div></div><div class="posttext">Any word on this?  I'm experiencing the same problem.<br />
All the PCs I'm testing this on are Windows XP SP2.<br />
<br />
I created a sample install and all it does is:<br />
    SetShellVarContext all<br />
    DetailPrint &quot;All DOCUMENTS:     $DOCUMENTS&quot;<br />
<br />
    SetShellVarContext current<br />
    DetailPrint &quot;Current DOCUMENTS: $DOCUMENTS&quot;<br />
<br />
On some PC it behaves correctly but on others this is what I get:<br />
All DOCUMENTS:     C:\Documents and Settings\jcolon\My Documents<br />
Current DOCUMENTS: C:\Documents and Settings\jcolon\My Documents<br />
Completed<br />
<br />
I cant seem to figure out what's different between all these PCs.  I'll keep checking and post back if I find anything.<br />
<br />
jc3</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">15th June 2006, 23:49</div></div><div class="posttext">I have tried your example code, and it dosen't seem to work. I have tried it with $DESKTOP, $VIDEOS, $MUSIC, and $PICTURES, and these all work. Could be a bug that has not been fixed (or windows has changed the way the 'My Documents' folder is stored :().</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comperio</div><div class="date">16th June 2006, 00:33</div></div><div class="posttext">hmm... mine works fine.  I have XP pro SP2.<br />
<br />
Out of curiosity, on those machines that have the problem, <br />
what version of Windows XP is being used?  (Home, pro, media edition, 64-bit, etc.)  <br />
<br />
And when you're in windows Explorer, do you have a 'shared documents' folder?  If so, I presume that takes you to the 'all users' folder (ie C:\documents and settings\all users\documents)?<br />
<br />
[edit]<br />
I found this blog that talks about problems with the 'shared documents' folder:<br />
http://blogs.msdn.com/jmazner/archive/2005/01/29/363160.aspx<br />
<br />
And this article about how to disable the 'shared documents' folder by editing the registry:<br />
http://www.winguides.com/registry/display.php/1220/<br />
<br />
(Just thinking that if maybe the shared documents folder has been disabled, you can reverse to 're-enable' it.)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">16th June 2006, 00:51</div></div><div class="posttext">That just removes them from &quot;my computer&quot;. BTW I'm running as a restricted user and it still works</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">16th June 2006, 02:41</div></div><div class="posttext">I have XP Pro SP1 x86(haven't tried it yet) at home and the college computers are XP Pro SP2 x86.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">lievencardoen</div><div class="date">16th June 2006, 07:55</div></div><div class="posttext">I will look into it as soon as possible, but I still think it is a bug in nsis. Workarounds are an option, but not a solution.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JeronimoColon</div><div class="date">16th June 2006, 15:23</div></div><div class="posttext">What's strange is about half the PCs I've tried exhibit the problem (Mine is one of them), and the other half behave correctly.<br />
<br />
Also, as JasonFriday13 stated the $Documents variable seems to be the only one behaving oddly - even on my machine (which has the problem) the other variables behave correctly.  As someone else suggested it may be a problem with just $Documents.<br />
<br />
And also, Comperio asked about the exact version Windows I was testing with.  I work for a software firm and we are all Dell (Intel x86) with Windows XP Pro SP2.  I still have to look at the blog info you have provided and do more digging.<br />
<br />
Finally, I created both a standard User account and a standard Admin account when testing and it didn't make a differenct so I think we can rule out permissions.<br />
<br />
I'll keep looking...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">16th June 2006, 17:30</div></div><div class="posttext">Works fine for me as well. Windows XP Pro SP2.<br />
Just tried it on NSIS v2.15 and then installed v2.17 and it still works.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">16th June 2006, 18:47</div></div><div class="posttext">I am buffled. I am also using XP Pro SP2. Both calls get the value from HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders\Personal (using NSIS 2.17) ...<br />
CF</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">16th June 2006, 20:00</div></div><div class="posttext">I just tried it with NoSharedDocuments=1 and it does seem to disable the common folder since I get my local one</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JeronimoColon</div><div class="date">16th June 2006, 20:23</div></div><div class="posttext">Just an FYI, I have checked, none of the PC have the registry setting set (both work and non-working).<br />
<br />
jc3</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JeronimoColon</div><div class="date">16th June 2006, 22:04</div></div><div class="posttext">Okay, I had a theory I just tested.  The only thing I noticed that was different between the &quot;work&quot; PCs and the &quot;Non-Working&quot; PCs was the &quot;Non-Working&quot; PCs are part of a Windows Domain.  All the &quot;Working&quot; PCs were never added.<br />
<br />
Now what I don't know and I need to find out is if this is Windows policy related or default behavior.  I don't think we use Windows policies (or very little) but I'll find out if and which - if we are using them.<br />
<br />
For those of you who have chimed in can you report whether or not you are part of a Domain or not?<br />
<br />
I'll keep digging...<br />
<br />
Thanks.<br />
<br />
jc3</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">16th June 2006, 22:26</div></div><div class="posttext">The two XP SP2 (One is MCE2k5 and one is Pro) computers I tested on are not in a domain</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">16th June 2006, 22:55</div></div><div class="posttext">No domain here, just a workgroup.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">16th June 2006, 23:37</div></div><div class="posttext">I am not in a domain either but it is not working :(<br />
CF</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">17th June 2006, 15:00</div></div><div class="posttext">but do you have NoSharedDocuments=1 (in HKCU or HKLM)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">17th June 2006, 18:36</div></div><div class="posttext">Good point Anders!<br />
<br />
For me it is the HKLM value of NoSharedDocuments that makes the difference :)<br />
<br />
If it is set to 1 then I can only see the user's $DOCUMENTS regardless of the SetShellVarContext value<br />
<br />
CF</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JeronimoColon</div><div class="date">19th June 2006, 14:57</div></div><div class="posttext">Just to reiterate, we do not have NoSharedDocuments set at all.<br />
<br />
Could a Dev. chime in please?<br />
<br />
Thanks.<br />
<br />
jc3</div></div><hr />


<div class="post"><div class="posttop"><div class="username">onad</div><div class="date">20th June 2006, 10:27</div></div><div class="posttext">This might be of help:<br />
<br />
http://www.cs.wisc.edu/~rkennedy/my-documents<br />
<br />
If this part of NSIS is not working for you, the best would be to enter a defect in the defecttracker(bug) <br />
<br />
and then focus on what you want to achieve and not use the $DOCUMENTS var but make you own routine via the system module.<br />
<br />
After all it handy to use default values but not obliged, and if it does not work one better finds an alternative for himself thad does.<br />
<br />
I'm sad to say but creating installer and programming just IS a lot of work once in a while...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JeronimoColon</div><div class="date">20th June 2006, 16:06</div></div><div class="posttext">Thanks for the info link Onad.  I wasn't aware of the defecttracker so I will enter a bug.<br />
<br />
jc3</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JeronimoColon</div><div class="date">20th June 2006, 19:19</div></div><div class="posttext">Here's my Win32 API workaround for those who may be interested:<br />
<br />
Function GetSharedDocPath<br />
# Win32 API documentation:<br />
# Call: http://msdn.microsoft.com/library/default.asp?url=/library/en-us/shellcc/platform/shell/reference/functions/shgetspecialfolderpath.asp<br />
# Enum: http://msdn.microsoft.com/library/default.asp?url=/library/en-us/shellcc/platform/shell/reference/enums/csidl.asp<br />
<br />
    SetPluginUnload alwaysoff<br />
    StrCpy $1 &quot;&quot;<br />
    IntOp $2 0x002e + # CSIDL_COMMON_DOCUMENTS (0x002e)<br />
    <br />
    System::Call 'shell32::SHGetSpecialFolderPath(i $HWNDPARENT, t .r1, i r2, i r3) i .r4'<br />
    <br />
    SetPluginUnload manual<br />
    System::Free 0<br />
    <br />
    DetailPrint &quot;API Call Results: $1&quot;<br />
FunctionEnd<br />
<br />
new links<br />
<br />
The API reference is:<br />
http://msdn.microsoft.com/en-us/library/bb762204(VS.85).aspx<br />
<br />
The Enum is:<br />
http://msdn.microsoft.com/en-us/library/bb762494(VS.85).aspx</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">21st June 2006, 00:26</div></div><div class="posttext">I have made a wiki page here (http://nsis.sourceforge.net/Getting_the_%27My_Documents%27_folder_for_all_users) using JeronimoColon's NSIS example, just so people can use it for future reference.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">21st June 2006, 16:27</div></div><div class="posttext">Seems to be related to http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1008632&amp;group_id=22049&amp;atid=373085<br />
<br />
Nsis uses SHGetSpecialFolderLocation since SHGetSpecialFolderPath needs shell v4.7(IE4 desktop update)<br />
<br />
Maybe nsis should check and use SHGetSpecialFolderPath if it is available on the system</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">22nd June 2006, 22:48</div></div><div class="posttext">I have just tried SetShellVarContext all at home on my XP pro SP1 x86 machine, and it works just fine.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">27th June 2007, 14:41</div></div><div class="posttext">Seems like a bug in SHGetSpecialFolderPath that the workaround uses rather than a bug in SHGetSpecialFolderLocation which NSIS uses. If a policy in the domain or on the local computer disables the shared documents folder, it shouldn't be accessed. The fact that it still exists doesn't mean it's used.<br />
<br />
As for $DOCUMENTS getting the user's path, that's just how every variable works. If the folder for all users can't be found, the current user's folder is used. This way, there should never be an empty shell variable unless it really doesn't exist.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">27th June 2007, 15:40</div></div><div class="posttext">After some quick testing, it seems like only $DOCUMENTS is affected, $PICTURES and the other folders inside my documents still resolve to the all users path<br />
curr $DOCUMENTS: C:\Documents and Settings\Anders\Documents<br />
all  $DOCUMENTS: C:\Documents and Settings\Anders\Documents<br />
curr $PICTURES: C:\Documents and Settings\Anders\Documents\Pictures<br />
all  $PICTURES: C:\Documents and Settings\All Users\Documents\My Pictures<br />
curr $MUSIC: C:\Documents and Settings\Anders\Documents\Music<br />
all  $MUSIC: C:\Documents and Settings\All Users\Documents\My Music<br />
curr $VIDEOS: C:\Documents and Settings\Anders\Documents\Videos<br />
all  $VIDEOS: C:\Documents and Settings\All Users\Documents\My Videos<br />
curr $DESKTOP: C:\Documents and Settings\Anders\Desktop<br />
all  $DESKTOP: C:\Documents and Settings\All Users\Desktop<br />
curr $APPDATA: C:\Documents and Settings\Anders\Application Data<br />
all  $APPDATA: C:\Documents and Settings\All Users\Application Data<br />
curr $TEMPLATES: C:\Documents and Settings\Anders\Templates<br />
all  $TEMPLATES: C:\Documents and Settings\All Users\Templates<br />
curr $STARTMENU: C:\Documents and Settings\Anders\Start Menu<br />
all  $STARTMENU: C:\Documents and Settings\All Users\Start Menu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">nsnb</div><div class="date">8th March 2009, 16:11</div></div><div class="posttext">Originally posted by kichik <br />
Seems like a bug in SHGetSpecialFolderPath that the workaround uses rather than a bug in SHGetSpecialFolderLocation which NSIS uses. If a policy in the domain or on the local computer disables the shared documents folder, it shouldn't be accessed. The fact that it still exists doesn't mean it's used.<br />
<br />
As for $DOCUMENTS getting the user's path, that's just how every variable works. If the folder for all users can't be found, the current user's folder is used. This way, there should never be an empty shell variable unless it really doesn't exist. <br />
I know this is an old thread, but that's exactly why I am asking: Is the above still valid? <br />
<br />
What has been the verdict by the NSIS gurus?<br />
<br />
Is this a documented feature in Windows? or a bug in NSIS?<br />
<br />
If the latter, has it been fixed since then?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">8th March 2009, 21:18</div></div><div class="posttext">SHGetFolderPath as provided by shfolder.dll is used to get special folders unless the installer is running on Windows 95/98. For 95/98 shfolder.dll is only used for the Application Data and Documents folder (if the DLL exists). Oherwise, the old SHGetSpecialFolderLocation API is called. <br />
http://nsis.svn.sourceforge.net/viewvc/nsis/NSIS/trunk/Source/exehead/util.c?revision=5917&amp;view=markup<br />
<br />
I would assume that means its fixed, but to know for sure you would have to test since I can't remember</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>