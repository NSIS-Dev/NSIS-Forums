<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Check if directory is writable, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Check if directory is writable NSIS Discussion" />
	
	<title> Check if directory is writable [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Check if directory is writable</div>
<hr />
<div class="pda"><a href="t-289631.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=289631">Check if directory is writable</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">madjerry</div><div class="date">4th April 2008, 12:48</div></div><div class="posttext">Hi,<br />
<br />
I'm working on a installer that needs to install programs on non administrative accounts, and has to work on Vista with UAC on or off. So i made a script that does not require admin rights and by default it installs a program to C:\My Games, so far so good. The scrip works just fine until user decides to change installDir, if that happened and the installdir is a Directory that requires admin rights to write the files will not copy :( So i i had an idea to check if selected directory can be written this is the code for that <br />
<br />
!include &quot;FileFunc.nsh&quot;<br />
!insertmacro GetFileAttributes<br />
!insertmacro GetParent<br />
<br />
Function IsWritable<br />
  !define IsWritable `!insertmacro IsWritableCall`<br />
 <br />
  !macro IsWritableCall _PATH _RESULT<br />
    Push `${_PATH}`<br />
    Call IsWritable<br />
    Pop ${_RESULT}<br />
  !macroend<br />
 <br />
  Exch $R0<br />
  Push $R1<br />
<br />
loop:<br />
  StrLen $R1 $R0<br />
  StrCmp $R1 0 isbad<br />
  ${GetFileAttributes} $R0 &quot;DIRECTORY&quot; $R1<br />
  StrCmp $R1 0 parent<br />
  ${GetFileAttributes} $R0 &quot;READONLY&quot; $R1<br />
  StrCmp $R1 1 isbad<br />
  Goto isok<br />
 <br />
parent:<br />
  ${GetParent} $R0 $R0<br />
  Goto loop<br />
<br />
isbad:<br />
  StrCpy $R1 1<br />
  Goto exit<br />
<br />
isok:<br />
  StrCpy $R1 0<br />
  Goto exit<br />
 <br />
exit:<br />
  Exch<br />
  Pop $R0<br />
  Exch $R1<br />
 <br />
FunctionEnd<br />
<br />
Function .onVerifyInstDir<br />
 <br />
  Push $R1<br />
  ${IsWritable} $INSTDIR $R1<br />
  IntCmp $R1 0 pathgood<br />
  Pop $R1<br />
  Abort<br />
 <br />
pathgood:<br />
  Pop $R1<br />
 <br />
FunctionEnd<br />
<br />
I based IsWritable function on some code i found here, the problem is that this does not work as intended, for eg if i select ProgramFiles it will detect that i cant write there, but if i select any other dir inside ProgamFiles it will allow me to install there. So i had another idea to check if any parent dir of the InstalDir is read-only, that did not work as well because it allowed installation to C:\Windows. My next idea is to find first parent dir of the install dir and create a dir there, if dir is created i will allow installation in that dir and than delete that dir, if dir was not created i will not allow to install there. I know that it is not the best idea but I cant find any other solution to my problem. Does anyone know how to check if installdir can be written ? Or is there any other way to prevent user to select invalid installdir ?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mauvecloud</div><div class="date">4th April 2008, 13:05</div></div><div class="posttext">I wouldn't suggest relying on file attributes when dealing with the UAC. I think it's better to try to create the directory (and possibly a file in it, in case the directory already exists), and consider the directory invalid if the installer couldn't create the directory (and/or the file)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">madjerry</div><div class="date">4th April 2008, 14:46</div></div><div class="posttext">Creating a directory, did not work :(<br />
<br />
  CreateDirectory &quot;$R0\T_S&quot;<br />
  ${GetFileAttributes} &quot;$R0\T_S&quot; &quot;DIRECTORY&quot; $R1<br />
  StrCmp $R1 0 isbad<br />
  RMDir &quot;$R0\T_S&quot;<br />
<br />
$R0 contains the path to the firs existing parent of the installdir, CreateDirectory - i have read that this function sets an error if it fails, how can i check if the function failed ?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mauvecloud</div><div class="date">4th April 2008, 14:53</div></div><div class="posttext">Use IfErrors.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">madjerry</div><div class="date">4th April 2008, 15:00</div></div><div class="posttext">Hi, again i have spend quite some time trying to make this work. Does anyone know what can i use to create a installer that will properly work on vista ?  By properly i mean handling user directory with UAC, creating shortcuts etc. The current version of installation can be downloaded @ http://codeminion.com/downloads/StoneLoopsSetup.exe<br />
it works correctly- creates shortcuts in proper places, does not require admin password, but when user who is not admin changes installdir to one that requires admin rights the installer will not copy the files. Is there anyone out there who know how to handle this ?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mauvecloud</div><div class="date">4th April 2008, 15:21</div></div><div class="posttext">Try something more like this:<br />
CreateDirectory $INSTDIR<br />
IfErrors isbad<br />
RMDir $INSTDIR<br />
<br />
Alternatively, reject the installation directory as invalid if traversing the list of parents finds a match for $PROGRAMFILES, $WINDIR, etc., even if the user is operating in XP or as an admin with the UAC off.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">madjerry</div><div class="date">4th April 2008, 15:30</div></div><div class="posttext">Hey,<br />
<br />
mauvecloud, thx for your help, i finally got the script working, here is the code: i will improve it a bit to make it more better but hey it works!<br />
 <br />
RequestExecutionLevel user<br />
<br />
!include &quot;FileFunc.nsh&quot;<br />
!insertmacro GetFileAttributes<br />
!insertmacro GetParent<br />
<br />
Function IsWritable<br />
<br />
   SetShellVarContext current<br />
  !define IsWritable `!insertmacro IsWritableCall`<br />
 <br />
  !macro IsWritableCall _PATH _RESULT<br />
    Push `${_PATH}`<br />
    Call IsWritable<br />
    Pop ${_RESULT}<br />
  !macroend<br />
 <br />
  Exch $R0<br />
  Push $R1<br />
<br />
loop:<br />
  StrLen $R1 &quot;$R0&quot;<br />
  StrCmp $R1 0 isbad<br />
<br />
  IfFileExists &quot;$R0&quot; 0 parent<br />
  ${GetFileAttributes} &quot;$R0&quot; &quot;DIRECTORY&quot; $R1<br />
  StrCmp $R1 0 parent<br />
  ${GetFileAttributes} &quot;$R0&quot; &quot;READONLY&quot; $R1<br />
  StrCmp $R1 1 isbad<br />
  Goto testdir<br />
 <br />
parent:<br />
  ${GetParent} &quot;$R0&quot; &quot;$R0&quot;<br />
  Goto loop<br />
<br />
isbad:<br />
  StrCpy $R1 1<br />
  Goto exit<br />
<br />
testdir:<br />
    ClearErrors<br />
  CreateDirectory &quot;$R0\T_S&quot;<br />
  IfErrors isbad isok<br />
 <br />
isok:<br />
  RMDir &quot;$R0\T_S&quot;<br />
  StrCpy $R1 0<br />
  Goto exit<br />
<br />
exit:<br />
  Exch<br />
  Pop $R0<br />
  Exch $R1<br />
 <br />
FunctionEnd<br />
<br />
Function .onVerifyInstDir<br />
 <br />
  Push $R1<br />
  ${IsWritable} $INSTDIR $R1<br />
  IntCmp $R1 0 pathgood<br />
  Pop $R1<br />
  Abort<br />
 <br />
pathgood:<br />
  Pop $R1<br />
 <br />
FunctionEnd<br />
<br />
If you have any ideas no how to improve this let me know</div></div><hr />


<div class="post"><div class="posttop"><div class="username">madjerry</div><div class="date">4th April 2008, 16:20</div></div><div class="posttext">Hi again,<br />
<br />
I have improved this function and now it looks like this:<br />
<br />
Function .onVerifyInstDir<br />
 <br />
 Push $R0<br />
 Push $R1<br />
 Push $R2<br />
<br />
 StrCpy $R0 &quot;$INSTDIR&quot;<br />
 StrCpy $R2 &quot;some_unique_name&quot;<br />
<br />
loop:<br />
	StrLen $R1 &quot;$R0&quot;<br />
	StrCmp $R1 0 pathbad<br />
 	 IfFileExists &quot;$R0&quot; 0 parentLoop<br />
	${GetFileAttributes} &quot;$R0&quot; &quot;DIRECTORY&quot; $R1<br />
	StrCmp $R1 0 parentLoop<br />
	${GetFileAttributes} &quot;$R0&quot; &quot;READONLY&quot; $R1<br />
	StrCmp $R1 1 pathbad<br />
	ClearErrors<br />
	IfFileExists &quot;$R0\$R2&quot; pathgood 0<br />
  	CreateDirectory &quot;$R0\$R2&quot;<br />
  	IfErrors pathbad 0<br />
	RMDir &quot;$R0\$R2&quot;<br />
	Goto pathgood<br />
 <br />
 parentLoop:<br />
	${GetParent} &quot;$R0&quot; &quot;$R0&quot;<br />
	Goto loop<br />
 <br />
pathbad:<br />
	Abort<br />
<br />
pathgood:<br />
<br />
Pop $R2<br />
Pop $R1<br />
Pop $R0<br />
 <br />
FunctionEnd</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>