<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Question about VPatch, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Question about VPatch NSIS Discussion" />
	
	<title> Question about VPatch [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Question about VPatch</div>
<hr />
<div class="pda"><a href="t-196661.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=196661">Question about VPatch</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">bluenet</div><div class="date">17th October 2004, 07:37</div></div><div class="posttext">When I use VPatch to patch a file, it will modified file CreationTime to LastWriteTime. I want to save the CreationTime so I search MSDN for GetFileTime and SetFileTime but not work.<br />
<br />
My code:<br />
	FileOpen $1 &quot;$INSTDIR\newfile.txt&quot; r<br />
	System::Call '*(&amp;i2, &amp;i2) i .r0'<br />
  System::Call 'kernel32::GetFileTime(i, i, i, i) i (r1, r0,,) .r9'<br />
	vpatch::vpatchfile &quot;$PLUGINSDIR\patch.pat&quot; &quot;$INSTDIR\oldfile.txt&quot; &quot;$INSTDIR\newfile.txt&quot;<br />
  System::Call 'kernel32::SetFileTime(i, i, i, i) i (r1, r0,,) .r8'<br />
	System::Free $0<br />
	FileClose $1<br />
StrCmp $8 0 +2<br />
DetailPrint &quot;Success!&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">deguix</div><div class="date">17th October 2004, 16:59</div></div><div class="posttext">Try this one (as I didn't):<br />
<br />
FileOpen $9 &quot;$INSTDIR\newfile.txt&quot; r<br />
System::Call '*(i, i) i .r0'<br />
System::Call '*(i, i) i .r1'<br />
System::Call 'kernel32::GetFileTime(i, *l, *l, *l) i (r9, r0, r1,)'<br />
FileClose $9<br />
<br />
vpatch::vpatchfile &quot;$PLUGINSDIR\patch.pat&quot; &quot;$INSTDIR\oldfile.txt&quot; &quot;$INSTDIR\newfile.txt&quot;<br />
<br />
FileOpen $9 &quot;$INSTDIR\newfile.txt&quot; r<br />
System::Call 'kernel32::SetFileTime(i, *l, *l, *l) i (r9, r0, r1,) .r8'<br />
System::Free $0<br />
System::Free $1<br />
FileClose $9<br />
<br />
StrCmp $8 0 +2<br />
DetailPrint &quot;Success!&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bluenet</div><div class="date">18th October 2004, 03:29</div></div><div class="posttext">Tested, but not work :(</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comm@nder21</div><div class="date">18th October 2004, 16:19</div></div><div class="posttext">try this:<br />
FileOpen $9 &quot;$INSTDIR\newfile.txt&quot; r<br />
System::Call '*(i, i) i .r0'<br />
System::Call '*(i, i) i .r1'<br />
System::Call 'kernel32::GetFileTime(i, *l, *l, *l) i (r9, r0, r1,)'<br />
FileClose $9<br />
<br />
vpatch::vpatchfile &quot;$PLUGINSDIR\patch.pat&quot; &quot;$INSTDIR\oldfile.txt&quot; &quot;$INSTDIR\newfile.txt&quot;<br />
<br />
FileOpen $9 &quot;$INSTDIR\newfile.txt&quot; w<br />
System::Call 'kernel32::SetFileTime(i, *l, *l, *l) i (r9, r0, r1,) .r8'<br />
System::Free $0<br />
System::Free $1<br />
FileClose $9<br />
<br />
StrCmp $8 0 +2<br />
DetailPrint &quot;Success!&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bluenet</div><div class="date">19th October 2004, 04:25</div></div><div class="posttext">I modified VPatch source to save the FileTime, in vpatchdll.c header: <br />
#include &lt;Winbase.h&gt;<br />
FILETIME ftCreate, ftWrite;<br />
<br />
and change:<br />
<br />
result = DoPatch(hPatch, hSource, hDest);<br />
<br />
to:<br />
<br />
GetFileTime(hSource, &amp;ftCreate, NULL, &amp;ftWrite);<br />
result = DoPatch(hPatch, hSource, hDest);<br />
SetFileTime(hDest, &amp;ftCreate, NULL, &amp;ftWrite);<br />
<br />
Comm@nder21's code I am not test, because modified the source is easy, I thinks. And the FileOpen w flags will destroy the newfile. thanks.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">iceman_k</div><div class="date">20th October 2004, 19:30</div></div><div class="posttext">Modifying the source may be easy for now, but unless you submit it to Kichik for inclusion in CVS, either you are stuck with your modified version forever, with no updates or your modified version will be overwritten the next time you update NSIS.<br />
Using the scripted method is a better solution, imo.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bluenet</div><div class="date">21st October 2004, 05:08</div></div><div class="posttext">OK. The modified plugins in attach file.<br />
VPatch.dll is in &quot;NSIS\Plugins&quot;<br />
Readme.html is in &quot;NSIS\Contrib\VPatch&quot;<br />
vpatchdll.c is in &quot;NSIS\Contrib\VPatch\Source\Plugin&quot;<br />
<br />
The vpatchfile function not change, and a new function SmartPatch add to keep the file time while patch. :)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>