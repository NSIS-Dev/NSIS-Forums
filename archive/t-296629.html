<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Cancelling uninstaller on Vista causes a nonsensical error message, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Cancelling uninstaller on Vista causes a nonsensical error message NSIS Discussion" />
	
	<title> Cancelling uninstaller on Vista causes a nonsensical error message [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Cancelling uninstaller on Vista causes a nonsensical error message</div>
<hr />
<div class="pda"><a href="t-296629.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=296629">Cancelling uninstaller on Vista causes a nonsensical error message</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">matthiasb</div><div class="date">29th August 2008, 10:47</div></div><div class="posttext">Hi,<br />
<br />
This error message only shows up when aborting an NSIS uninstall from the Windows Vista (SP1, German) control panel. Even if I click &quot;Cancel&quot; on the first page. The uninstallers do fine and seem not to change the system in any way when they're cancelled.<br />
This error is also caused by NSIS example scripts and pops up a few seconds after the uninstaller closes.<br />
(Image in attachement)<br />
<br />
Entries in the regestry seem to be valid and not causing the error (keys do not change when cancelling uninstall)<br />
HKLM\Software\Microsoft\Windows\CurrentVersion\Uninstall<br />
DisplayIcon      REG_SZ<br />
DisplayName      REG_SZ<br />
DisplayVersion   REG_SZ<br />
InstallLocation  REG_SZ<br />
ModifyPath       REG_SZ<br />
Publisher        REG_SZ<br />
UninstallString  REG_SZ<br />
VersionMajor     REG_DWORD<br />
VersionMinor     REG_DWORD<br />
Since this is affecting every NSIS script on my system (even if their uninstall section is completely empty) and the &quot;Nullsoft Install System&quot; Installer itself there should be no need to post a script. <br />
<br />
I cannot exclude the possibility that this error only shows up on my system but in case you noticed this behaviour too please post here.<br />
<br />
(Picture in attachement is not moonlanguage)<br />
States: &quot;Program compatibility assistent&quot;<br />
&quot;The program might not be uninstalled correctely&quot;<br />
&quot;If this program wasn't uninstalled correctely, retry and use settings which are compatible with this Windows version&quot; (doesn't make much sense in German either)<br />
&quot;unknown program&quot;, &quot;unknown publisher&quot;<br />
- &quot;Uninstall with recommended settings&quot;<br />
- &quot;Program was uninstalled correctely&quot;<br />
<br />
Thanks in advance</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">29th August 2008, 18:51</div></div><div class="posttext">I think Vista will display that dialog if the uninstaller has a non 0 exit code. So, if this is bugging you that much, you can probably force the exit code in .onUserAbort with SetErrorLevel. This is mostly a stupid move from MS, a real installer SHOULD return non 0 when something did not complete, but I guess some crappy big name installer does not (can't deal with UAC or whatever the problem might be) so MS are helping some big guy out while screwing people doing the correct thing.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Case</div><div class="date">30th August 2008, 08:36</div></div><div class="posttext">You can read an explanation why the dialog is shown here (http://msdn.microsoft.com/en-us/library/bb756937.aspx). You can fix it by adding RequestExecutionLevel command in the NSIS script.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">matthiasb</div><div class="date">1st September 2008, 09:16</div></div><div class="posttext">@Anders: It's not bugging me that much, I just have to write known issues in the installer specifiaction so costumers know everything works as usual.<br />
I tried setting the error level to 0 but that doesn't solve the problem. Maybe there's really something wrong with my ModernUI script. (Although MessageBox shows up.)!define MUI_CUSTOMFUNCTION_UNABORT un.customabort<br />
;...<br />
function un.customabort<br />
MessageBox MB_OK &quot;un.customabort&quot;<br />
SetErrorLevel 0<br />
functionend<br />
@Case: The problem is that I've already set the &quot;RequestExecutionLevel&quot; to admin in my scripts.http://msdn.microsoft.com/en-us/library/bb756937.aspx<br />
[...] If it is an uninstaller, the detection looks for whether an entry was deleted from ARP.The manual is either misleading or actually states that I have to delete regestry keys regardless if I abort the uninstall or not.<br />
http://msdn.microsoft.com/en-us/library/bb756937.aspx<br />
The best option to exclude a program from PCA is to include, with the program, an application manifest with run level (either Administrator or as limited users) marking for UAC.And that's exactly the case. Reading the manifest with the mt.exe (Microsoft (R) Manifest Tool version 5.2.3790.2075) of the uninstall.exe shows<br />
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;<br />
&lt;assembly xmlns=&quot;urn:schemas-microsoft-com:asm.v1&quot; manifestVersion=&quot;1.0&quot;&gt;<br />
  &lt;assemblyIdentity version=&quot;1.0.0.0&quot; processorArchitecture=&quot;X86&quot; name=&quot;Nullsoft.NSIS.exehead&quot; type=&quot;win32&quot;&gt;<br />
  &lt;/assemblyIdentity&gt;<br />
  &lt;description&gt;Nullsoft Install System v2.39&lt;/description&gt;<br />
  &lt;dependency&gt;<br />
    &lt;dependentAssembly&gt;<br />
        &lt;assemblyIdentity type=&quot;win32&quot; name=&quot;Microsoft.Windows.Common-Controls&quot;<br />
          version=&quot;6.0.0.0&quot; processorArchitecture=&quot;X86&quot; publicKeyToken=&quot;6595b64144ccf1df&quot; language=&quot;*&quot;&gt;<br />
        &lt;/assemblyIdentity&gt;<br />
    &lt;/dependentAssembly&gt;<br />
  &lt;/dependency&gt;<br />
  &lt;trustInfo xmlns=&quot;urn:schemas-microsoft-com:asm.v3&quot;&gt;<br />
    &lt;security&gt;<br />
      &lt;requestedPrivileges&gt;<br />
        &lt;requestedExecutionLevel level=&quot;requireAdministrator&quot; uiAccess=&quot;false&quot;&gt;&lt;/requestedExecutionLevel&gt;<br />
      &lt;/requestedPrivileges&gt;<br />
    &lt;/security&gt;<br />
  &lt;/trustInfo&gt;<br />
&lt;/assembly&gt;I fail to see the problem.<br />
<br />
Thank you for your fast help.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">matthiasb</div><div class="date">3rd September 2008, 09:13</div></div><div class="posttext">Me again,<br />
i took a closer look at the uninstaller's error level (read: programming by permutation) and ended up trying this in the installer's &quot;.onInit&quot; for checking the error level.<br />
execwait &quot;$INSTDIR\uninstall.exe&quot; $0<br />
MessageBox MB_OK &quot;returned: $0&quot;<br />
First i thought i was accidentally using &quot;exec&quot; instead of &quot;execwait&quot; because the MessageBox pops up immediately (showing &quot;0&quot;) not waiting for the uninstaller to exit but then reading in the reference4.6.2 Uninstall Section<br />
[...] The first Delete instruction works (deleting the uninstaller), because the uninstaller is transparently copied to the system temporary directory for the uninstall.i thought: &quot;maybe Vista isn't expecting a 0 error level but a 1 (as it should be), which can't be returned since the first return states '0' due to the self copy mechanism&quot;.<br />
Sadly, i didn't find any uninstaller callback firing at the right moment to change the error level to a different value to see if my assumption is right.<br />
<br />
Can anyone confirm this behaviour or knows how NSIS uninstaller handles return values?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">3rd September 2008, 12:13</div></div><div class="posttext">There is no uninstaller callback that you can use, the uninstaller will parse the commandline for the special param before any &quot;user&quot; code runs. This is a design problem IMHO. I'm not sure if there is a way around this. MS gets around it by using MSI, maybe we can do something like that as well by using rundll32 or something. I'll try to come up with a concept that works</div></div><hr />


<div class="post"><div class="posttop"><div class="username">matthiasb</div><div class="date">3rd September 2008, 12:55</div></div><div class="posttext">I don't know if working on that is solving our problem.<br />
After some further testing (yes, permutation programming again) i set the &quot;UninstallString&quot; in the registry to my own setup.exe, which now returned hard-coded error levels. I tried 0, 1, 2, 1604, 1602 (MSI codes) and various other numbers i found somewhere. No success.<br />
<br />
Spying other installer's error level which don't cause PCA to show this error message (mostly MSI based), i just get &quot;0&quot; and &quot;1602&quot;.<br />
<br />
What bothers me is that PCA shouldn't even interfere since the manifest is existent (in both, installer and uninstaller) and requesting an execution level.<br />
<br />
Every clue we found seems to lead toward &quot;New Windows Vista Bug&quot;.<br />
<br />
As said in post #4: All i want to know is why it happens. Fixing that issue would be great but has less priority and is in no way urgent.<br />
<br />
Thanks again for the fast reply.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comperio</div><div class="date">4th September 2008, 04:39</div></div><div class="posttext">What I got from Case's link (http://msdn.microsoft.com/en-us/library/bb756937.aspx) (from a previous post) is that the dialog will appear during uninstall if the program's entry under add/remove program is not properly deleted:<br />
The logic used by PCA is to detect if a setup did not complete successfully. It monitors a program detected as setup by Windows Vista and Windows Server 2008 and checks whether the program registers an entry in Add or Remove Programs (ARP). If no entries are created in ARP, PCA concludes that the installer did not complete successfully. It will then wait for the install program to terminate before displaying the UI. If it is an uninstaller, the detection looks for whether an entry was deleted from ARP.<br />
So, if the user is canceling and nothing is being changed in the add/remove programs section of the registry, then it makes sense to me that you'd see the error.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">matthiasb</div><div class="date">4th September 2008, 07:00</div></div><div class="posttext">@Comperio<br />
I mentioned that in post #4. Still, since a manifest is present PCA shouldn't interfere at all. I was able to prevent the error message like the paragraph said if there wasn't this little nuisance:http://msdn.microsoft.com/en-us/library/bb756937.aspx<br />
[...], the detection looks for whether an entry* was deleted from ARP.* 'Entry' doesn't mean any value in the ARP regestry uninstall section, but the complete key, including every value set in the ARP subkey. The MSDN manual is misleading, the right way to put this would be:[...], the detection looks for whether THE entry was deleted from ARP.<br />
In other words: A regular uninstall.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comperio</div><div class="date">4th September 2008, 15:54</div></div><div class="posttext">You right, it is confusing... (I had to re-read it again just to make sure I understood.)<br />
<br />
So based on the information here, I'd say that either this is a bug in MS or it's just treating NSIS &quot;special&quot;.  (The article is a bit vague about the special algorithm that it uses--either that means it's top secret or that no one at MS really understands it either...)<br />
<br />
Sorry I couldn't be more help.  :(</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">5th September 2008, 05:52</div></div><div class="posttext">Maybe you could post on the MSDN forums and get a &quot;official&quot; response?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">matthiasb</div><div class="date">12th September 2008, 10:20</div></div><div class="posttext">Originally posted by Anders <br />
Maybe you could post on the MSDN forums and get a &quot;official&quot; response? <br />
Done: http://forums.microsoft.com/MSDN/ShowPost.aspx?PostID=3863624&amp;SiteID=1</div></div><hr />


<div class="post"><div class="posttop"><div class="username">blaaaaaaap</div><div class="date">19th March 2009, 23:28</div></div><div class="posttext">This appears to be a Windows Vista bug. The same thing happens on my machine when canceling Google app uninstalls (e.g. Chrome or Talk).<br />
<br />
InnoSetup users ran into the same problem and developers added a workaround (would have to browse CVS to see what this is exactly) in 5.2.3 (http://www.softpedia.com/get/Authoring-tools/Setup-creators/Inno-Setup.shtml):<br />
<br />
&quot;Added workaround for bug in Windows Vista (still present in SP1): With UAC turned off, launching an uninstaller from the Programs and Features Control Panel applet and answering No at the confirmation message box would cause a &quot;This program might not have uninstalled correctly&quot; dialog to be displayed, even though the uninstaller includes a proper &quot;Vista-aware&quot; manifest.&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">20th March 2009, 10:58</div></div><div class="posttext">blaaaaaaap, thanks for the info. <br />
<br />
Inno sets the Image Version in the PE header to 6.0 (compile.pas)<br />
<br />
I'll add a bug fix request...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comm@nder21</div><div class="date">22nd March 2009, 01:51</div></div><div class="posttext">just researched on the same issue :)<br />
<br />
here's my new wiki page:<br />
http://nsis.sourceforge.net/Vista_application_compatibility<br />
<br />
feel free to improve!</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>