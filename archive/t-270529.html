<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Vista + Auto launch app -  Part 2, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Vista + Auto launch app -  Part 2 NSIS Discussion" />
	
	<title> Vista + Auto launch app -  Part 2 [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Vista + Auto launch app -  Part 2</div>
<hr />
<div class="pda"><a href="t-270529.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=270529">Vista + Auto launch app -  Part 2</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">helix400</div><div class="date">2nd May 2007, 22:45</div></div><div class="posttext">This is a followup to see if anyone has found a clean solution to have an NSIS installer running as administrator launch an .exe as a non-admin user.<br />
<br />
The previous thread was here: Vista + Run App On Install (http://forums.winamp.com/showthread.php?postid=2081977)<br />
<br />
It also linked to a helpful MSDN forum, here: How to CreateProcess NOT as administrator  (http://forums.microsoft.com/MSDN/ShowPost.aspx?PostID=422705&amp;SiteID=1) <br />
<br />
Both threads seem to conclude that there wasn't a clean solution.  The best solution (but still really ugly), is to make a wrapper NSIS installer.  That wrapper first launches as a normal user and installs the main installer, then launches that main installer (which will request and install as administrator), and when the main installer is finished, the wrapper launches your application.<br />
<br />
Ya, I could do that, but it feels like such an ugly hack. I'd really like to avoid making two NSIS installers to make it act like one should.  Has anyone found any cleaner method?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">2nd May 2007, 23:49</div></div><div class="posttext">I created a plugin for this, it's still a work in progress but you can check it out: http://forums.winamp.com/showthread.php?s=&amp;threadid=265780</div></div><hr />


<div class="post"><div class="posttop"><div class="username">helix400</div><div class="date">4th May 2007, 00:27</div></div><div class="posttext">Anders,<br />
<br />
Thanks for the plugin.  I'm grateful that others are putting in the effort to give us a cleaner solution.  I've been playing with it, and looking over the demos.  <br />
<br />
However, I'm baffled on how to make it work in my situation.  I hate to ask for step by step help, but I just can't wrap my head around what's going on with the plugin, so I don't know where to begin.  <br />
<br />
Again, the scenario I'm seeing is this:<br />
1) An installer will almost certainly be run in Vista as Administrator.<br />
2) It will auto launch our app.<br />
3) I need the app auto launched so it's not administrator.<br />
<br />
What do I need to do with the plugin to accomplish steps 2 and 3?<br />
<br />
Edit: Nevermind for now.  I wasn't checking my end correctly.  I'm really optimistic now...hoepfully the rest of my tests will do well.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">helix400</div><div class="date">4th May 2007, 02:01</div></div><div class="posttext">Nevermind, I can't figure it out.<br />
<br />
All of the demos are set to RequestExecutionLevel user.<br />
<br />
But in my installer, I need admin access to write to the Program Files folder.  Then I need to launch the application as the normal user.  So I'm still stuck  :(</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">4th May 2007, 13:44</div></div><div class="posttext">You can also use VistaElevator (http://www.tweak-uac.com/programming/vista-elevator2/). Download the compiled executables and copy over VE32.dll. Then use the System plug-in to call it.StrCpy $R0 &quot;$INSTDIR\program.exe&quot; # program path<br />
StrCpy $R1 &quot;parmaters&quot;            # parameters<br />
StrCpy $R2 &quot;$INSTDIR&quot;             # working directory<br />
<br />
InitPluginsDir<br />
<br />
StrCpy $0 $PLUGINSDIR\ve32.dll<br />
StrCpy $1 ?RunNonElevated@@YAHPAUHWND__@@PB_W11@Z<br />
<br />
File /oname=$0 ve32.dll<br />
<br />
System::Call 'kernel32::LoadLibrary(tr0)i.s'<br />
System::Call 'kernel32::GetProcAddress(is,tr1)i.r1'<br />
System::Call '::$1(i $HWNDPARENT, wR0, wR1, wR2)'</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">4th May 2007, 14:48</div></div><div class="posttext">RequestExecutionLevel is set to user so the &quot;outer&quot; instance will run as the current user, this is the whole point of the plugin</div></div><hr />


<div class="post"><div class="posttop"><div class="username">helix400</div><div class="date">5th May 2007, 21:49</div></div><div class="posttext">Yay!<br />
<br />
I got it to work.  It seems I was just not understanding how it worked.  So here's what I can figure out so far.  If I'm wrong, please correct me.  :)<br />
<br />
1) Set RequestExecutionLevel to be user.  The UAC plugin will eventually make two processes, one as a user, and one it will elevate itself to admin.<br />
2) Just copy the .onInit function as found in most of the examples given in the plugin.  That I believe elevates the visible window as be administrator, as well as checking early if it can even get adminstrator rights before continuing.<br />
3) Anything you want done as user mode you do with the UAC plugin.  For example, if I do the previous steps, UAC::Exec launches an application with user privileges.<br />
4) Make sure the UAC plugin is unloaded before the application closes.<br />
<br />
One problem I did notice is that my Installer Window ended up going behind the topmost window.  For example, if I had an explorer window open, and I double clicked on my NSIS .exe, the Vista UAC dialog would come up of course, and then afterwards, the Intaller Window would appear *behind* the explorer window.  Is there anything I can do about that?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">6th May 2007, 15:32</div></div><div class="posttext">you can try calling SetForegroundWindow $HWNDPARENT  with the system plugin in .OnGuiInit, but generally, the OS tries to stop other apps stealing focus.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">helix400</div><div class="date">7th May 2007, 19:09</div></div><div class="posttext">Anders,<br />
<br />
I really appreciate your help.  This plugin will probably be good enough for us to use.  <br />
<br />
Though I am trying to figure how to get the window up front.  I'm going to start another thread on that.  It's weird, if I have, say, 5 windows open, the NSIS window doesn't go to the back of all 5, just behind the active window.  And my SetForegroundWindow doesn't seem to be working either.  Anyways, thanks again for the plugin.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Nihad</div><div class="date">9th May 2007, 21:00</div></div><div class="posttext">in function .onGUIInit add:<br />
<br />
<br />
<br />
System::Call &quot;*${stRECT} .r1&quot;<br />
System::Call &quot;User32::GetWindowRect(i, i) i ($HWNDPARENT, r1) .r2&quot;<br />
System::Call &quot;*$1${stRECT} (.r2, .r3, .r4, .r5)&quot;<br />
IntOp $6 $4 - $2 ; $2 now contains the width<br />
IntOp $7 $5 - $3 ; $3 now contains the height<br />
<br />
System::Call 'user32::GetSystemMetrics(i 0) i .r0'<br />
System::Call 'user32::GetSystemMetrics(i 1) i .r1'<br />
<br />
IntOp $2 $0 - $6<br />
IntOp $3 $1 - $7<br />
IntOp $4 $2 / 2<br />
IntOp $5 $3 / 2<br />
<br />
System::Call &quot;User32::SetWindowPos(i, i, i, i, i, i, i) b ($HWNDPARENT, -1, $4, $5, 0, 0, 0x201)&quot;<br />
<br />
<br />
I hope this helps you.<br />
<br />
Thanks,</div></div><hr />


<div class="post"><div class="posttop"><div class="username">helix400</div><div class="date">9th May 2007, 21:32</div></div><div class="posttext">Thanks!<br />
<br />
I haven't been able to test this.  I mainly needed it to work around something in the UAC plugin.  But Anders made a change in the plugin so I no longer have to worry about it.  <br />
<br />
But hopefully your code will come in handy for anyone else needing this.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">M-Force</div><div class="date">6th March 2008, 15:17</div></div><div class="posttext">Hi Kichik,<br />
<br />
You suggested earlier in this thread (05-04-2007 12:44 PM) a certain way how to launch an application in vista from the installer.<br />
<br />
You wrote &quot;You can also use VistaElevator. Download the compiled executables and copy over VE32.dll...&quot;<br />
<br />
I have tried this by including VE32.dll and calling the function RunNonElevated in order to start my application out of the installer.<br />
It works fine with a Vista administrator user account and the application starts with a â€œmediumâ€ integrity level (process explorer) as expected.<br />
But when i try to run the same installer with a Vista standard user account the application wonâ€™t be started at all.<br />
<br />
Do you or anybody else have any experience with this behavior and might also know what the problem is?<br />
<br />
<br />
Thank you very much for your help.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">6th March 2008, 16:13</div></div><div class="posttext">It probably uses the task scheduler or something hacky like that</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>