<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Appending InstallDir to browsed path ...sometimes, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Appending InstallDir to browsed path ...sometimes NSIS Discussion" />
	
	<title> Appending InstallDir to browsed path ...sometimes [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Appending InstallDir to browsed path ...sometimes</div>
<hr />
<div class="pda"><a href="t-221000.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=221000">Appending InstallDir to browsed path ...sometimes</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Kiaser Zohsay</div><div class="date">8th July 2005, 21:46</div></div><div class="posttext">I have taken a journey today, and I would like to share the story of that journey, so that it may enrich the lives of others for many years to come.<br />
<br />
OK, seriously.  I wrote a little block of code, but I think its really, really cool.  So here tis: ;--------------------------------<br />
; Verify the Install Dir<br />
Function .onVerifyInstDir<br />
  IfFileExists $INSTDIR\..\Appname.exe &quot;&quot; PathGood<br />
    GetFullPathName $INSTDIR $INSTDIR\..<br />
    FindWindow $R0 &quot;#32770&quot; &quot;&quot; $HWNDPARENT<br />
    GetDlgItem $R0 $R0 1019<br />
    SendMessage $R0 ${WM_SETTEXT} 0 &quot;STR:$INSTDIR&quot;<br />
  PathGood:<br />
FunctionEnd  Here's a little background.  Our app uses one install for both new installs and updates.  Most of the time, InstallDirRegKey works like a charm, so when the user installs an update, setup remembers where it was installed originally.<br />
<br />
We use InstallDir without quotes, so the default directory name gets appended from the browse dialog.  I personally like this, because it encourages my users to keep a consistent environment.  Occasionally, some users change the install directory to something they like better.<br />
<br />
Here's the kicker.  Many (actually most) of our users install our app on a network drive.  This means that more than one user can do installs, and that a user doing an update won't necessarily have the InstallDirRegKey value in their registry.<br />
<br />
When InstallDirRegKey is not found, and the user has to browse for the directory, and the directory name is not the default, then the default name gets appended to the existing path as a subdirectory.  The user then starts the app in the original location using the original shortcut, and they still see the previous version of the app, and my phone rings.  This is a problem.<br />
<br />
The code sample above is the solution.  I found it was easy to modify the $INSTDIR variable, but while the dialog is visible, $INSTDIR is not the primary source.  The primary source is the text in the edit box of the dialog.  So to really change the install dir in .onVerifyInstDir, you need to update the text box with WM_SETTEXT.<br />
<br />
Note that this will also prevent a user from browsing to a directory below a directory with Appname.exe in it.  The browse button will work, but the directory in the text box will still be the parent.  A more stringent method would be check $INSTDIR before modifying it to see if the end of the path is equal to the default directory name, which is left as an exercise.<br />
<br />
Enjoy!</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>