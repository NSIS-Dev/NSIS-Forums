<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Writing and reading from the same reg key, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Writing and reading from the same reg key NSIS Discussion" />
	
	<title> Writing and reading from the same reg key [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Writing and reading from the same reg key</div>
<hr />
<div class="pda"><a href="t-327300.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=327300">Writing and reading from the same reg key</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Salinn</div><div class="date">14th February 2011, 14:16</div></div><div class="posttext">Hello,<br />
<br />
I haven't found a thread that describes the same issue that I'm having, therefor I will try to detail my problem as much as I can.<br />
<br />
I've created an installer which will read a certain registry key and, after &quot;parsing&quot; it with StrCpy, it will write it in another registry key. When the installer ends (.onGUIEnd) that new created registry key will be deleted; so it will act as a temporary registry key.<br />
<br />
The problem that I've encounter is that the installer doesn't read the new written registry key.<br />
<br />
The following code will write the temporary registry key without any problem.<br />
<br />
Var $one<br />
<br />
Function test<br />
	ReadRegStr $one HKLM SOFTWARE\Program\Nice InstallPath<br />
	!define something $one\install_here<br />
	WriteRegStr HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\Stuff TMP&quot; &quot;TMPPath&quot; &quot;${something}&quot;<br />
FunctionEnd<br />
<br />
Now, if I want to get that key and make it the installation directory, it won't be able to read it.<br />
<br />
InstallDirRegKey HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\Stuff TMP&quot; &quot;TMPPath&quot;<br />
<br />
The above code-line will only work if the installer is reopened and the temporarily registry key is not deleted upon closing.<br />
<br />
My question is: How can I write and read the same registry key in the same installation process?<br />
<br />
Looking forward to your reply.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">14th February 2011, 15:35</div></div><div class="posttext">As far as I know, the InstallDirRegKey is read before the installer even starts. It's like an automatic &quot;ReadRegStr $INSTDIR Hive Path Key&quot; command in .onInit. What you'll need to do is do it manually, after the key is created. (But seriously, why on earth would you want to do that? Just StrCpy $INSTDIR &quot;${something}&quot; would suffice...)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Salinn</div><div class="date">14th February 2011, 16:17</div></div><div class="posttext">Hello,<br />
<br />
Thank you for the fast reply.<br />
<br />
At first I tried that but unfortunately, by the time I ended up in the Directory Page, the $INSTDIR was empty. I tried using global variables and even !define to get that key stored after ReadRegStr but every time the Function .... FunctionEnd passed that variable became &quot;unset&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">15th February 2011, 06:49</div></div><div class="posttext">I'm pretty sure there's absolutely no problem with reading a regstr you created in earlier. If your $INSTDIR is empty, there's a problem in your script. Use MessageBox etc to find the problem (specifically, check the location of the regstr you're telling it to read/write).<br />
<br />
Also: ALL variables in NSIS are global. There are no local variables.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jiake</div><div class="date">15th February 2011, 08:01</div></div><div class="posttext">!define is a compiling command, whether use it or not is the same.<br />
You need to find out the origin of your problem.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Salinn</div><div class="date">15th February 2011, 08:17</div></div><div class="posttext">Hello,<br />
<br />
Thank you for the replies.<br />
<br />
I've tried creating a simple example to show the issue I'm having. Testing it will have the same result.<br />
<br />
!include MUI2.nsh<br />
<br />
OutFile &quot;Test.exe&quot;<br />
<br />
!define MUI_PAGE_CUSTOMFUNCTION_SHOW test<br />
!insertmacro MUI_PAGE_WELCOME<br />
!define MUI_PAGE_CUSTOMFUNCTION_SHOW CustomShow<br />
!insertmacro MUI_PAGE_DIRECTORY<br />
InstallDirRegKey HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\Stuff TMP&quot; &quot;TMPPath&quot;<br />
<br />
Var path<br />
Var trim_path<br />
<br />
Function test<br />
	ReadRegStr $path HKLM SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Winamp DisplayIcon<br />
	StrCpy $trim_path $path 23<br />
;	MessageBox MB_OK $trim_path<br />
	WriteRegStr HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\Stuff TMP&quot; &quot;TMPPath&quot; &quot;$trim_path&quot;<br />
FunctionEnd<br />
<br />
Function CustomShow<br />
	MessageBox MB_OK $trim_path<br />
FunctionEnd<br />
<br />
Function .onGUIEnd<br />
	DeleteRegKey HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\Stuff TMP&quot;<br />
FunctionEnd<br />
<br />
Section .onInit<br />
SectionEnd<br />
<br />
<br />
When the installer is open, the key &quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Stuff TMP\TMPPath&quot; exists but, regardless where I put the InstallDirRegKey HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\Stuff TMP&quot; &quot;TMPPath&quot; line, it won't fill in the path.<br />
<br />
PS: The messagebox shows the path correctly the problem is setting the InstallDir with that variable.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">15th February 2011, 09:16</div></div><div class="posttext">Like I said, you'll need to ReadRegStr MANUALLY. Don't use InstallDirRegKey.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Salinn</div><div class="date">15th February 2011, 09:24</div></div><div class="posttext">Hello,<br />
<br />
Ok, I changed it to ReadRegStr when the Directory Page is shown but nothing seems to be changed.<br />
<br />
!include MUI2.nsh<br />
<br />
OutFile &quot;Test.exe&quot;<br />
<br />
!define MUI_PAGE_CUSTOMFUNCTION_SHOW test<br />
!insertmacro MUI_PAGE_WELCOME<br />
!define MUI_PAGE_CUSTOMFUNCTION_SHOW CustomShow<br />
!insertmacro MUI_PAGE_DIRECTORY<br />
;InstallDirRegKey HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\Stuff TMP&quot; &quot;TMPPath&quot;<br />
<br />
Var path<br />
Var trim_path<br />
<br />
Function test<br />
	ReadRegStr $path HKLM SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Winamp DisplayIcon<br />
	StrCpy $trim_path $path 23<br />
;	MessageBox MB_OK $trim_path<br />
	WriteRegStr HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\Stuff TMP&quot; &quot;TMPPath&quot; &quot;$trim_path&quot;<br />
FunctionEnd<br />
<br />
Function CustomShow<br />
	ReadRegStr $INSTDIR HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\Stuff TMP&quot; &quot;TMPPath&quot;<br />
	MessageBox MB_OK $INSTDIR<br />
FunctionEnd<br />
<br />
Function .onGUIEnd<br />
	DeleteRegKey HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\Stuff TMP&quot;<br />
FunctionEnd<br />
<br />
Section .onInit<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">15th February 2011, 10:50</div></div><div class="posttext">First of all, you DO have administrator access when you run this test installer, right? &gt;__&gt;<br />
<br />
Other tips:<br />
- Reading the written regstring is still entirely pointless. Just use the variable containing the path directly!<br />
- $trim_path is unneeded, just use StrCpy $path $path 23. Saves one variable.<br />
- Why trim the first 23 characters? If I installed winamp to c:\foobar, the trim result will be entirely different from when I installed to c:\Program Files (x86)\Multimedia\z0mglongpath\winamp...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Salinn</div><div class="date">15th February 2011, 11:17</div></div><div class="posttext">Hello,<br />
<br />
I will reply to your message in the same order:<br />
<br />
0. Yes, I'm running as Administrator.<br />
<br />
1. I've tried that as well (at the first time I've created the script) but it didn't worked so I guessed that I need to save it somewhere and read it back.<br />
<br />
2. Point taken.<br />
<br />
3. I've trimmed that because in the registry, under HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Winamp\DisplayIcon you will find something like &quot;C:\Program Files\Winamp\winamp.exe,0&quot;. I've trim it to get a folder of an already installed application.<br />
<br />
After getting that path I could easily modify it according to my needs adding somethig like &quot;$already_installed_application\plugins&quot; folder that can't be found in the registry or anywhere else.<br />
<br />
I tried now something, based on your idea and I finally managed to get it to work. It seems that I need to set the $INSTDIR before the CUSTOMFUNCTION_SHOW. I guess my previous testing was made using it in that function.<br />
<br />
Thank you for all your help and for bearing with me.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">15th February 2011, 11:33</div></div><div class="posttext">Why would you trim to 23 characters? That will only work when the path starts with C:\Program Files\Winamp in which case, what is the point of reading the path in the first place?<br />
<br />
This is what you want:!include FileFunc.nsh<br />
Function .onInit<br />
  ReadRegStr $R0 HKLM SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Winamp DisplayIcon<br />
  ${GetParent} $R0 $INSTDIR<br />
FunctionEndStu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Salinn</div><div class="date">15th February 2011, 12:26</div></div><div class="posttext">Hello,<br />
<br />
Thank you for the idea, Stu.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>