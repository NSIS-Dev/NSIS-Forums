<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" More text replacement woes..., media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  More text replacement woes... NSIS Discussion" />
	
	<title> More text replacement woes... [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  More text replacement woes...</div>
<hr />
<div class="pda"><a href="t-195615.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=195615">More text replacement woes...</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">moop</div><div class="date">5th October 2004, 02:32</div></div><div class="posttext">I have read the docs.  I have been searching these forums for hours.  I still need help.  I have installed and used the StrReplace and ReplaceInFile scripts from the Archive.  I'm not a programmer by day, so bear with me, please.  The closest solution to what I've found so far is HERE (http://forums.winamp.com/showthread.php?s=&amp;threadid=165838&amp;highlight=replace).  <br />
<br />
Basically, I want to do two things.  I'll wait before posting the second one because hopefully I can learn how to do it from the response I get to this one.<br />
<br />
----my text file----<br />
asdfasdf<br />
CDPath=F:<br />
asdfasdf<br />
----eof-------------<br />
<br />
Wherein F: can be anything, from blank, to a longer string.<br />
<br />
I have seen how to replace a full line, but not unless I match the string exactly.  How can I flush the junk after the equals sign and keep the rest intact?  I have used the ReplaceInFile !insertmacro, but that only works if my string matches exactly, and although I can &quot;cheat&quot; by inserting a $\r$\n, that still just moves the &quot;junk&quot; after the equals sign to another line I would still need to delete.<br />
<br />
I'm not a programmer by day, please forgive my noobishness... This isn't second nature to me yet, and I'm certain a NSIS whiz could do what I want in 5 minutes, which has taken me... longer than I care to admit.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">5th October 2004, 18:01</div></div><div class="posttext">I think this calls for another text manipulation function by Afrow!<br />
<br />
Please bare with me and I will have one written shortly.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">5th October 2004, 18:38</div></div><div class="posttext">Done:<br />
http://nsis.sourceforge.net/archive/nsisweb.php?page=626<br />
<br />
You want to do this:<br />
Push &quot;$INSTDIR\file.ext&quot;<br />
Push &quot;CDPath=&quot;<br />
Push &quot;CDPath=new value&quot;<br />
Call ReplaceLineStr<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">moop</div><div class="date">5th October 2004, 20:40</div></div><div class="posttext">Thanks a ton.  I had gone to the IRC chatroom yesterday where Anders gave me some useful code, but most of it was greek.  I still want to use it to learn though, but yours is immediately helpful.  Thanks very much, Afrow!  I hope I can help my community as much as you help NSIS.  :cool:</div></div><hr />


<div class="post"><div class="posttop"><div class="username">razor_x</div><div class="date">6th October 2004, 18:17</div></div><div class="posttext">sweet afrow..can this be made into a macro too?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">6th October 2004, 19:03</div></div><div class="posttext">...<br />
<br />
<br />
!macro ReplaceLineStr File StartStr LineStr<br />
Push &quot;${File}&quot;<br />
Push &quot;${StartStr}&quot;<br />
Push &quot;${LineStr}&quot;<br />
Call ReplaceLineStr<br />
!macroend<br />
<br />
!insertmacro ReplaceLineStr &quot;$INSTDIR\file.ext&quot; &quot;CDPath=&quot; &quot;CDPath=new value&quot;<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Kolya</div><div class="date">3rd March 2010, 20:26</div></div><div class="posttext">Sorry for bumping such an old thread...<br />
<br />
This function has been very helpful but it misses one important feature for me: If the searched string isn't found, I'd like to write the replacement string to a  new line, instead of just dropping it.<br />
<br />
I know how to add the new line at the bottom of the file, but I need help with writing that exception.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Kolya</div><div class="date">4th March 2010, 23:22</div></div><div class="posttext">Some help please? Or am I missing something obvious?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Kolya</div><div class="date">5th March 2010, 17:09</div></div><div class="posttext">Nevermind, I eventually used the script to delete any previously existing matching lines and then added my lines at the bottom.<br />
<br />
This worked for me because it doesn't matter where the new lines are.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Kolya</div><div class="date">24th March 2013, 19:54</div></div><div class="posttext">Eventually I did need a solution that adds the new line to the bottom if it isn't found in the file. It also echoes in the details how many times which line was replaced in which file or if it was added to he bottom. <br />
I'm sure this could be done more elegantly, but it was the first time I screwed with NSIS functions.<br />
<br />
Function ReplaceLineStr<br />
 Exch $R0 ; string to replace that whole line with<br />
 Exch<br />
 Exch $R1 ; string that line should start with<br />
 Exch<br />
 Exch 2<br />
 Exch $R2 ; file<br />
 Push $R3 ; file handle<br />
 Push $R4 ; temp file<br />
 Push $R5 ; temp file handle<br />
 Push $R6 ; global<br />
 Push $R7 ; input string length<br />
 Push $R8 ; line string length<br />
 Push $R9 ; global<br />
 <br />
 Var /GLOBAL T0 ; counter<br />
 StrCpy $T0 0		; reset<br />
 <br />
  StrLen $R7 $R1<br />
 <br />
  GetTempFileName $R4<br />
 <br />
  FileOpen $R5 $R4 w<br />
  FileOpen $R3 $R2 r<br />
 <br />
  ReadLoop:<br />
  ClearErrors<br />
		FileRead $R3 $R6<br />
			IfErrors Done<br />
		<br />
		StrLen $R8 $R6<br />
		StrCpy $R9 $R6 $R7 -$R8<br />
		StrCmp $R9 $R1 0 +4<br />
 <br />
		FileWrite $R5 &quot;$R0$\r$\n&quot;<br />
		IntOp $T0 $T0 + 1<br />
		Goto ReadLoop<br />
	 <br />
		FileWrite $R5 $R6<br />
		Goto ReadLoop<br />
 <br />
  Done:<br />
 <br />
  FileClose $R3<br />
  FileClose $R5<br />
  <br />
  SetDetailsPrint none<br />
   Delete $R2<br />
   Rename $R4 $R2<br />
  SetDetailsPrint both<br />
	<br />
	${If} $T0 != 0<br />
		DetailPrint &quot;$\&quot;$R1$\&quot; replaced $T0 times with $\&quot;$R0$\&quot; in $\&quot;$R2$\&quot;.&quot;<br />
	${Else}<br />
		FileOpen $T0 $R2 a<br />
		FileSeek $T0 0 END<br />
		FileWrite $T0 $R0<br />
		FileWriteByte $T0 &quot;13&quot;<br />
		FileWriteByte $T0 &quot;10&quot;<br />
		FileClose $T0<br />
		DetailPrint &quot;$\&quot;$R0$\&quot; not found in $\&quot;$R2$\&quot;, added to bottom of file.&quot;<br />
	${EndIf}<br />
<br />
	<br />
 Pop $R9<br />
 Pop $R8<br />
 Pop $R7<br />
 Pop $R6<br />
 Pop $R5<br />
 Pop $R4<br />
 Pop $R3<br />
 Pop $R2<br />
 Pop $R1<br />
 Pop $R0<br />
FunctionEnd</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>