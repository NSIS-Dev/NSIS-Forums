<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" uninstall does not remove $DATADIR (app data) from 64 bit windows systems, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  uninstall does not remove $DATADIR (app data) from 64 bit windows systems NSIS Discussion" />
	
	<title> uninstall does not remove $DATADIR (app data) from 64 bit windows systems [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  uninstall does not remove $DATADIR (app data) from 64 bit windows systems</div>
<hr />
<div class="pda"><a href="t-368666.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=368666">uninstall does not remove $DATADIR (app data) from 64 bit windows systems</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">anderci</div><div class="date">11th August 2013, 19:29</div></div><div class="posttext">I think I did a poor job of asking my question in another thread.<br />
 ( NSIS Develop, Deploy 32 bit applications to 64 bit Windows? )<br />
My NSIS script successfully installs my 32 bit apps on both 32 and 64 bit windows systems.<br />
They can run successfully on both.<br />
<br />
The problem is the uninstall process leaves the application data behind.<br />
<br />
x64 requires two 'install directories', one for the app and one for any data created by the app (including its .ini file) In addition to the $INSTDIR variable, I defined another: $DATADIR<br />
What am I missing?<br />
Here are parts of the script that almost works:<br />
<br />
  var DATADIR<br />
   :<br />
   :<br />
Function .onVerifyInstDir<br />
    ${If} ${RunningX64}					<br />
    ${Else}<br />
		StrCpy $DATADIR $INSTDIR<br />
    ${EndIf}					        <br />
FunctionEnd <br />
   :<br />
   :<br />
   :<br />
  !define MUI_WELCOMEPAGE  <br />
  !define MUI_LICENSEPAGE<br />
  !define MUI_DIRECTORYPAGE<br />
<br />
  !define MUI_ABORTWARNING<br />
  !define MUI_UNINSTALLER<br />
  !define MUI_UNCONFIRMPAGE<br />
  !define MUI_FINISHPAGE <br />
  <br />
Function .onInit<br />
  ${If} ${AtLeastWinVista}<br />
    ${If} ${RunningX64}					<br />
      StrCpy $INSTDIR &quot;$PROGRAMFILES32\Clark_Anderson\${MUI_FILE}&quot;<br />
      StrCpy $DATADIR &quot;C:\Users\Public\Clark_Anderson\${MUI_FILE}&quot;<br />
    ${Else}					            <br />
       StrCpy $INSTDIR &quot;C:\Users\Public\Clark_Anderson\${MUI_FILE}&quot;<br />
       StrCpy $DATADIR &quot;C:\Users\Public\Clark_Anderson\${MUI_FILE}&quot;   <br />
    ${EndIf}					       <br />
  ${Else}<br />
    StrCpy $INSTDIR &quot;$PROGRAMFILES\Clark_Anderson\${MUI_FILE}&quot;<br />
    StrCpy $DATADIR &quot;$PROGRAMFILES\Clark_Anderson\${MUI_FILE}&quot;    <br />
  ${EndIf}<br />
FunctionEnd  <br />
   :<br />
   :<br />
   :<br />
Section &quot;Sample Data Files (Optional: Recommended for starting)&quot;<br />
  SectionIn 2<br />
 SetOutPath &quot;$DATADIR\DataBases&quot;<br />
   :<br />
   :<br />
SectionEnd<br />
<br />
Section &quot;Uninstall&quot;<br />
   :<br />
   :<br />
   :<br />
   :<br />
;Delete Files <br />
  Delete &quot;$INSTDIR\*.*&quot;    					<br />
  Delete &quot;$DATADIR\Reports\Templates\*.*&quot;    <br />
  Delete &quot;$DATADIR\Reports\*.*&quot;    			<br />
  Delete &quot;$DATADIR\DataBases\*.*&quot;    		<br />
  Delete &quot;$DATADIR\ExpImport\*.*&quot;    		<br />
  Delete &quot;$DATADIR\*.*&quot;    					<br />
 <br />
;Remove the installation directory<br />
  RMDir /r &quot;$INSTDIR&quot;<br />
  RMDir /r &quot;$DATADIR\Reports\Templates\*.*&quot;    <br />
  RMDir /r &quot;$DATADIR\Reports\*.*&quot;    			<br />
  RMDir /r &quot;$DATADIR\DataBases\*.*&quot;    		<br />
  RMDir /r &quot;$DATADIR\ExpImport\*.*&quot;    		<br />
  RMDir /r &quot;$DATADIR&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">12th August 2013, 14:59</div></div><div class="posttext">Are you doing StrCpy $DATADIR &quot;C:\Users\Public\Clark_Anderson\${MUI_FILE}&quot; in the uninstaller?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">anderci</div><div class="date">12th August 2013, 16:51</div></div><div class="posttext">Thank you for responding.<br />
No I am depending only on the definition in:<br />
<br />
Function .onInit<br />
${If} ${AtLeastWinVista}<br />
${If} ${RunningX64}<br />
StrCpy $INSTDIR &quot;$PROGRAMFILES32\Clark_Anderson\${MUI_FILE}&quot;<br />
StrCpy $DATADIR &quot;C:\Users\Public\Clark_Anderson\${MUI_FILE}&quot;<br />
${Else}<br />
StrCpy $INSTDIR &quot;C:\Users\Public\Clark_Anderson\${MUI_FILE}&quot;<br />
StrCpy $DATADIR &quot;C:\Users\Public\Clark_Anderson\${MUI_FILE}&quot;<br />
${EndIf}<br />
${Else}<br />
StrCpy $INSTDIR &quot;$PROGRAMFILES\Clark_Anderson\${MUI_FILE}&quot;<br />
StrCpy $DATADIR &quot;$PROGRAMFILES\Clark_Anderson\${MUI_FILE}&quot;<br />
${EndIf}<br />
FunctionEnd<br />
<br />
followed by:<br />
<br />
Function .onVerifyInstDir<br />
${If} ${RunningX64}<br />
${Else}<br />
StrCpy $DATADIR $INSTDIR<br />
${EndIf}<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">anderci</div><div class="date">12th August 2013, 17:06</div></div><div class="posttext">I have tried out modifying the <br />
<br />
Function .onInit<br />
  :<br />
StrCpy $DATADIR &quot;C:\Users\Public\Clark_Anderson\${MUI_FILE}&quot;<br />
  to<br />
StrCpy $DATADIR &quot;$APPDATA\Clark_Anderson\${MUI_FILE}&quot;    <br />
<br />
but that seems to have sent the app data folders and files to:<br />
  C:\Users\Administrator\AppData\Roaming\Clark_Anderson\SurvyMgr<br />
<br />
I have not been able to 'see' those data folders and files after the install and cannot confirm if they were successfully uninstalled.<br />
<br />
<br />
Also, I tried changing ShowUninstDetails &quot;nevershow&quot; to &quot;show&quot; or show<br />
<br />
The details went by so fast I could not hope to read them.  Are there any ideas to allow me to examine uninstall details?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">12th August 2013, 18:13</div></div><div class="posttext">You have to restore $datadir in the uninstaller, variables are not saved for you but like I already said, it does not make sense that this is a x64 only thing...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">anderci</div><div class="date">12th August 2013, 18:42</div></div><div class="posttext">Thank you,<br />
<br />
Is it that NSIS built-in variables are saved for uninstall, but developer created variables are not?<br />
<br />
Are Push and/or Pop commands of any use with this?<br />
<br />
For all 32 bit windows installations, I can and do define the $DATADIR == $INSTDIR <br />
<br />
For 64 bit windows installations, the $INSTDIR for 32 bit applications MUST be in the C:\Program Files (x86)\... folder structure.  The data MUST be elsewhere.<br />
A Microsoft help line representative recommended the C:\Users\Public\... folder structure.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">12th August 2013, 19:32</div></div><div class="posttext">No variables are saved.<br />
<br />
You can put readonly data in $programfiles, data written to by users should go somewhere else but that is true for all NT systems, also on 32bit Windows...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">anderci</div><div class="date">12th August 2013, 20:10</div></div><div class="posttext">By 'No variables are saved.' do you mean 'developer created variables' as differentiated from those like $INSTDIR</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">13th August 2013, 01:23</div></div><div class="posttext">$exedir/path and $instdir are set in the uninstaller before .oninit but $instdir is just the same as the folder the uninstaller is in unless it was started with a special parameter.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">anderci</div><div class="date">13th August 2013, 01:48</div></div><div class="posttext">Thank you.<br />
<br />
I was about to say 'I wish I understood this better', but maybe the uninstaller knows about $INSTDIR merely because it is local to the uninstaller program.<br />
<br />
A little bit discouraging.  I guess, until a better idea comes, I will need to but the defining of $DATADIR in the uninstall section, also.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">anderci</div><div class="date">14th August 2013, 15:07</div></div><div class="posttext">An additional part of the solution from http://forums.winamp.com/showthread.php?t=220552<br />
One of my applications uses only one subdirectory of the $DATADIR and required the:<br />
SetOutPath &quot;$TEMP&quot;			in the Section &quot;Uninstall&quot; as well as the separate:<br />
<br />
    ${If} ${RunningX64}					<br />
		StrCpy $DATADIR &quot;C:\Users\Public\Clark_Anderson\${MUI_FILE}&quot;    <br />
    ${Else}<br />
		StrCpy $DATADIR $INSTDIR<br />
    ${EndIf}					        <br />
definition.<br />
<br />
Now the uninstall works completely for 32 bit and 64 bit Windows!<br />
Thank you.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">15th August 2013, 17:40</div></div><div class="posttext">That looks like you're setting $DATADIR to a path which is only valid for your build machine. Why?<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">anderci</div><div class="date">15th August 2013, 19:47</div></div><div class="posttext">Stu,<br />
<br />
If ${AtLeastWinVista}, Windows has established the C:\Users\Public\... folder structure.  This structure is available to anyone on the PC.<br />
<br />
'Some real help came from lengthy phone conversations with very patient Microsoft <br />
Windows 7 Customer Support agents.  They were not programmers, but I learned <br />
enough from them to figure the rest out.'<br />
<br />
Windows 7 x64 has a system variable/constant: PUBLIC=C:\Users\Public<br />
I have not tested, but I think Vista and Win7  have the same definition for PUBLIC.<br />
<br />
I have not, yet, found a similar $PUBLIC defined in NSIS.<br />
<br />
For Pre-Vista Windows I put everything in the ProgramFiles=C:\Program Files\... folder structure or D:\Program Files\... folder structure  or E:\Program Files\... folder structure <br />
<br />
I wrote a small VB6 function to identify which of the Windows variables (ProgramFiles(x86), PUBLIC, ProgramData) and set a variable (replacing App.Path) accordingly.<br />
<br />
Multiple instances of one of my freeware applications is sometimes used with a shared database located on the LAN.<br />
<br />
I hope this answers your question.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">16th August 2013, 23:04</div></div><div class="posttext">ReadEnvStr $DATADIR PUBLIC<br />
<br />
Never hard code such paths. Windows installed with other languages will not necessarily have that path.<br />
<br />
Edit: I have checked and the PUBLIC environment variable exists on Vista and above.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">anderci</div><div class="date">17th August 2013, 00:30</div></div><div class="posttext">Stu,<br />
Thank you.  I use the PUBLIC Environment Variable in my VB program.<br />
<br />
In the NSIS script, I replaced<br />
		StrCpy $DATADIR &quot;C:\Users\Public\Clark_Anderson\${MUI_FILE}&quot;    <br />
  with<br />
		ReadEnvStr $DATADIR PUBLIC\Clark_Anderson\${MUI_FILE}	<br />
I must be doing something wrong, because $DATADIR ended up blank.<br />
Must I do it:  		ReadEnvStr $DATADIR PUBLIC&quot;\Clark_Anderson\${MUI_FILE}&quot;	<br />
or:                            ReadEnvStr $DATADIR PUBLIC<br />
                                StrCpy $DATADIR $DATADIR&quot;\Clark_Anderson\${MUI_FILE}&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">17th August 2013, 11:21</div></div><div class="posttext">ReadEnvStr requires the environment variable name. If you have a path, use ExpandEnvStrings:<br />
<br />
ExpandEnvStrings $DATADIR `%PUBLIC%\Clark_Anderson\${MUI_FILE}`<br />
<br />
If in doubt, always check the manual.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">anderci</div><div class="date">17th August 2013, 12:53</div></div><div class="posttext">Stu<br />
<br />
Thank you very much.<br />
I found 4.9.2.7 ExpandEnvStrings</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>