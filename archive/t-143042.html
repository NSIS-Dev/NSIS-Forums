<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" NT4 CopyFiles - Return value not working., media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  NT4 CopyFiles - Return value not working. NSIS Discussion" />
	
	<title> NT4 CopyFiles - Return value not working. [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  NT4 CopyFiles - Return value not working.</div>
<hr />
<div class="pda"><a href="t-143042.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=143042">NT4 CopyFiles - Return value not working.</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">mgillespie</div><div class="date">21st July 2003, 18:17</div></div><div class="posttext">Have posted a bug on the SF tracker (not sure if anyone looks there, so posting here also).<br />
<br />
I have a project that uses the CopyFiles function.  I check the error value after copying to ensure the file was copied correctly.<br />
<br />
This works fine under Win2k, but fails under NT4 (SP6a), where it always reports a good copy, even if it can't find the source file.<br />
<br />
Sample Code to reproduce the problem:<br />
<br />
!include &quot;MUI.nsh&quot;<br />
!define MUI_PRODUCT &quot;Modern UI Test&quot;<br />
!define MUI_VERSION &quot;1.65&quot;<br />
OutFile &quot;Basic.exe&quot;<br />
<br />
!insertmacro MUI_PAGE_INSTFILES<br />
!insertmacro MUI_LANGUAGE &quot;English&quot;<br />
<br />
Section &quot;modern.exe&quot; SecCopyUI<br />
      ClearErrors<br />
      CopyFiles &quot;C:\1.txt&quot; &quot;D:\&quot;<br />
      IfErrors +1 +3<br />
      MessageBox MB_OK|MB_ICONSTOP|MB_TOPMOST &quot;Copy Failed&quot;<br />
      Goto +2<br />
      MessageBox MB_OK|MB_ICONSTOP|MB_TOPMOST &quot;Copy OK&quot;<br />
SectionEnd<br />
<br />
Complile this, and ensure that C:\1.txt does not exist.  On Win2k, it will flag a error on CopyFiles, NT4 will report it as OK.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mgillespie</div><div class="date">21st July 2003, 19:31</div></div><div class="posttext">Has anyone reproduced this problem?  Or is it me????</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mgillespie</div><div class="date">21st July 2003, 21:10</div></div><div class="posttext">the problems with return values from SHFileOperation under NT4 seem to be widely reported on Google, but nothing I can see on MSDN.<br />
<br />
Is there any reason SHFileOperation is used over the more usual CopyFile() functions from the FileStorage PlatformSDK?<br />
<br />
This seems to work correctly on NT4:<br />
<br />
case EW_COPYFILES: // CopyFile (added by NOP)<br />
      {<br />
        int res;<br />
        char *buf0=process_string_fromparm_tobuf(0x00);<br />
        char *buf1=process_string_fromparm_tobuf(0x11);<br />
        log_printf3(&quot;CopyFiles \&quot;%s\&quot;-&gt;\&quot;%s\&quot;&quot;,buf0,buf1);<br />
        buf0[mystrlen(buf0)+1]=0;<br />
        buf1[mystrlen(buf1)+1]=0;<br />
<br />
        wsprintf(buf2,&quot;%s%s&quot;,LANG_STR(LANG_COPYTO),buf1);<br />
		res = !CopyFile( buf0, buf1, TRUE );<br />
        if (res)<br />
        { // some of these changes were from Edgewise (wiked_edge@yahoo.com)<br />
          update_status_text_from_lang(LANG_COPYFAILED,&quot;&quot;);<br />
          g_flags.exec_error++;<br />
        }</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">21st July 2003, 21:30</div></div><div class="posttext">This was a bug and was actually fixed early today by Kichik.<br />
Please download the latest CVS.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">22nd July 2003, 08:28</div></div><div class="posttext">I wish that was true Afrow, but unfortunately I don't have access to Microsoft code yet :) As mgillespie said, it's a bug with SHFileOperation under NT 4 SP6.<br />
<br />
CopyFile is not used because, at least according to MSDN, it does not support wild cards. We might end up writing our own NSFileOperation because this function only brings problems. For now, you'll have to avoid this bug using either methods you've already presented above.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">22nd July 2003, 16:53</div></div><div class="posttext">LOL my mistake :)<br />
<br />
The best way would be to:<br />
<br />
CopyFiles &quot;sourcefile&quot; &quot;copiedfile&quot;<br />
IfFileExists &quot;copiedfile&quot; 0 +3<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mgillespie</div><div class="date">22nd July 2003, 20:48</div></div><div class="posttext">That would cover 1 aspect of the problem, but there are many other problems that could case a file copy to fail, but would not get trapped.<br />
<br />
I am using tweaked Installer source anyhow, so I may just change the EW_COPYFILES case to use CopyFile (until something happens in the mainstream code to fix this).<br />
<br />
It does seem this particular script function is troublesome, as it also causes compile problems on VS6 without the latest Platform SDK.  Writing a dedicated CopyFile with wildcards function would solve this also.<br />
<br />
If someone could supply a quick spec for a wildcard FileCopy, I can do some code for it (if required), and submit it.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">23rd July 2003, 13:02</div></div><div class="posttext">To supply wild card support you can copy the code from EW_DELETEFILE. If you're already on it, why not add RMDir support too and make it a complete replacement for EW_DELETEFILE, EW_RMDIR, EW_RENAME and EW_COPYFILES?</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>