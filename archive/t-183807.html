<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" upgrading protected vb6 dlls, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  upgrading protected vb6 dlls NSIS Discussion" />
	
	<title> upgrading protected vb6 dlls [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  upgrading protected vb6 dlls</div>
<hr />
<div class="pda"><a href="t-183807.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=183807">upgrading protected vb6 dlls</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">freeberm</div><div class="date">18th June 2004, 22:24</div></div><div class="posttext">I have an installation package that is attempting to upgrade the following DLLs:<br />
Oleaut32.dll<br />
stdole2.tlb<br />
msvcrt.dll<br />
<br />
Upon installation on a machine with older libraries, the reboot prompt occurrs (correctly).  However the libraries are not upgraded upon reboot.<br />
<br />
The first two are part of the vb6 runtime libraries.  The last is required for installation of the microsoft scripting runtime libraries (scrrun.dll).<br />
<br />
I searched for and read a post by a user having the exact same problem:<br />
http://forums.winamp.com/showthread.php?s=&amp;threadid=122953&amp;highlight=msvcrt.dll<br />
where the conclusion by Joost Verburg was that the library in question (msvcrt.dll) is a protected library.<br />
<br />
I am wondering if this is still thought to be the case or if there is a workaround that has been found (the original post is a couple of years old).  I would not think the vb runtime libraries are protected.  Can I verify what dlls are protected somewhere in the registry?<br />
<br />
I am using NSIS v2.0.  Here is a small snippet of code from the script:<br />
*************<br />
  !insertmacro UpgradeDLL ${VBFILESDIR}\Oleaut32.dll $SYSDIR\Oleaut32.dll $SYSDIR<br />
<br />
  !define UPGRADEDLL_NOREGISTER<br />
    !insertmacro UpgradeDLL ${VBFILESDIR}\Stdole2.tlb $SYSDIR\Stdole2.tlb $SYSDIR<br />
    !insertmacro UpgradeDLL ${VBFILESDIR}\msvcrt.dll $SYSDIR\msvcrt.dll $SYSDIR  ;required if installing scrrun<br />
 !undef UPGRADEDLL_NOREGISTER<br />
**************<br />
<br />
Does anyone know how to upgrade these files or what might be happening?  Is it possible another app/service is grabbing the dlls before the RunOnce registry key is fired (this occurrs after a logon)?  As you can tell from the code, only one file is registered but all three are set to be renamed and copied from temporary files on reboot.<br />
<br />
Thanks for the help.<br />
Sorry for the long post.<br />
<br />
Paul</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">18th June 2004, 22:30</div></div><div class="posttext">These OLE files are indeed protected by modern Windows versions. You can't update them, but there is also no need to update, they are linked the the operating system. Your application works fine with these files.<br />
<br />
If you want to prevent the installer from trying to update, check the windows version during installation using the GetWindowsVersion function (ME/2000/XP have this protection).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">freeberm</div><div class="date">18th June 2004, 22:37</div></div><div class="posttext">Thanks!  Yes the application works fine even though the upgrade does not occur.<br />
<br />
Just a quick note though... the code for installation of the VB6 runtime files came from the following section in the NSIS documentation:<br />
C.4 How to install the VB6 runtimes<br />
<br />
It should probably be updated to reflect the need to only install if the files do not exist (since upgrade is not allowed).<br />
<br />
Thanks again for the quick response!<br />
<br />
Paul</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">18th June 2004, 22:41</div></div><div class="posttext">Note that you still have to upgrade all files when running Windows 95/98/NT4.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">freeberm</div><div class="date">18th June 2004, 22:56</div></div><div class="posttext">Thanks again... I realized that after hitting send on the last post.  <br />
<br />
One other quick question.  Is there a way to determine which files are protected on the system? Is there a list in the registry somewhere? <br />
<br />
It would be nice to know for future reference since I am sure I will attempt this in the future with a different protected file.<br />
<br />
Thanks,<br />
Paul</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">18th June 2004, 23:26</div></div><div class="posttext">There is a hidden folder called dllcache in your system folder which contains the files.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">freeberm</div><div class="date">19th June 2004, 00:55</div></div><div class="posttext">Interestingly, I checked this cache and only found two of the three files I mentioned previously.  I could not find msvcrt.dll.  <br />
<br />
In searching on the net I seemed to find that the files that are protected do not necessarily exist in this directory.  If they do not exist here and they are protected, the user will be prompted to insert the windows installation disk to restore the protected file.<br />
<br />
I will keep looking for how to determine which files are protected, but as of yet I have not found a way to determine this for sure.<br />
<br />
Thanks for the help.<br />
Paul</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">19th June 2004, 23:11</div></div><div class="posttext">You can always try to remove the file on reboot. If it doesn't work the file is protected.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">freeberm</div><div class="date">21st June 2004, 19:18</div></div><div class="posttext">Unfortunately that will cause the same problem as simply attempting to upgrade the dll that is protected.  I would like to avoid forcing the user to reboot when it is unecessary.  In addition to being forced to reboot, the user may be required to insert their windows install disk to replace the changed dll with the protected version.<br />
<br />
I attached code I wrote to wrap around UpgradeDLL.<br />
<br />
Any comments would be appreciated (I'm still new to writing NSIS scripts).  It works well for what I would like to do, you just need to know which files might be protected prior to calling it.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">21st June 2004, 20:45</div></div><div class="posttext">That script doesn't work at all, remember that defines are processed on compile-time.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">freeberm</div><div class="date">21st June 2004, 20:54</div></div><div class="posttext">...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">freeberm</div><div class="date">21st June 2004, 21:03</div></div><div class="posttext">I guess it appeared to work since I haven't tested it on a non Windows File Protection enabled system.  Thanks for the response.  I will change the code.<br />
<br />
Paul</div></div><hr />


<div class="post"><div class="posttop"><div class="username">freeberm</div><div class="date">21st June 2004, 21:22</div></div><div class="posttext">here is a second attempt at that script.  This should work as it uses variables instead of defines.<br />
<br />
Thanks again for the help.<br />
<br />
Paul<br />
<br />
(I changed the script slightly so that it is no longer necessary to call CheckSFC prior to including the macro.)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">21st June 2004, 22:09</div></div><div class="posttext">That looks better. Why define 3 unique values? One is enough.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">freeberm</div><div class="date">21st June 2004, 22:15</div></div><div class="posttext">good point :)<br />
<br />
I have changed the script to reflect this.<br />
<br />
Thanks so much for your help.<br />
<br />
(I added a comment regarding when to use this file for anyone who happens to download it.)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>