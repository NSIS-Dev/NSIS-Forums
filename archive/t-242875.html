<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" How to detect Windows Installer version?, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  How to detect Windows Installer version? NSIS Discussion" />
	
	<title> How to detect Windows Installer version? [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  How to detect Windows Installer version?</div>
<hr />
<div class="pda"><a href="t-242875.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=242875">How to detect Windows Installer version?</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Kypec</div><div class="date">7th April 2006, 15:00</div></div><div class="posttext">Hi guys,<br />
<br />
is there some easy way to detect which version<br />
of M$ Windows Installer is present on user's system?<br />
What I want to achieve is this:<br />
I have created my NSIS installer which detects the version<br />
of .NET Framework (via DotNET.nsh) and runs dotnetfx.exe externally if needed.<br />
The problem is, however, that this package requires another M$ prerequisite to be there =&gt; WindowsInstaller-KB893803-v2-x86.exe<br />
How can one find out whether this MSI 3.1 is already installed on user's system?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">galil</div><div class="date">7th April 2006, 15:18</div></div><div class="posttext">Do a GetDLLVersion (as described in the manual or here: http://nsis.sourceforge.net/GetDllVersion_Command_Explained) on &quot;$SYSDIR\msi.dll&quot;<br />
You probably don't need to check release &amp; build parts though.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th April 2006, 15:19</div></div><div class="posttext">You can check the version of $SYSDIR\msi.dll using GetDLLVersion. It's hardly the official method, but I couldn't find anything about it in MSDN.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">iceman_k</div><div class="date">7th April 2006, 15:40</div></div><div class="posttext">Originally posted by kichik <br />
You can check the version of $SYSDIR\msi.dll using GetDLLVersion. It's hardly the official method, but I couldn't find anything about it in MSDN.  <br />
<br />
It's probably the closest thing to an official method that you are going to get. It's what the Windows Installer team says you should do.<br />
http://blogs.msdn.com/windows_installer_team/archive/2005/09/09/458528.aspx</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Kypec</div><div class="date">7th April 2006, 15:48</div></div><div class="posttext">Many thanks to all of you for quick replies.<br />
I'll try what you are suggesting.:)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">panccio</div><div class="date">17th April 2006, 14:24</div></div><div class="posttext">i thank to all too.. :D</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dhruba.bandopad</div><div class="date">10th July 2006, 13:05</div></div><div class="posttext">What happens if there is no Windows Installer installed at all? Will the script crash?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">19th July 2006, 14:47</div></div><div class="posttext">No, you'll just get no version from GetDLLVersion.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">drifa</div><div class="date">30th October 2007, 07:59</div></div><div class="posttext">go to start=&gt;run and type msiexec</div></div><hr />


<div class="post"><div class="posttop"><div class="username">meaningoflights</div><div class="date">6th July 2008, 03:48</div></div><div class="posttext">I know this thread is old but here's a working example:<br />
<br />
!macro CHECK_MSI_VERSION<br />
<br />
GetDllVersion &quot;$SYSDIR\msi.dll&quot;  $R0 $R1<br />
IntOp $R2 $R0 &gt;&gt; 16<br />
IntOp $R2 $R2 &amp; 0x0000FFFF ; $R2 now contains major version<br />
IntOp $R3 $R0 &amp; 0x0000FFFF ; $R3 now contains minor version<br />
IntOp $R4 $R1 &gt;&gt; 16<br />
IntOp $R4 $R4 &amp; 0x0000FFFF ; $R4 now contains release<br />
IntOp $R5 $R1 &amp; 0x0000FFFF ; $R5 now contains build<br />
StrCpy $0 &quot;$R2.$R3.$R4.$R5&quot; ; $0 now contains string like &quot;1.2.0.192&quot;<br />
<br />
MessageBox MB_ICONINFORMATION|MB_OK  &quot;The version is: $R2.$R3.$R4.$R5&quot;<br />
<br />
!macroend</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jweinraub</div><div class="date">3rd May 2010, 16:54</div></div><div class="posttext">How do you detect if you have an older version installed?<br />
For example, .net framework 2.0 requires at least version 3.1 (the above installed is 3.1.4000.2435).<br />
<br />
However I have 4.5.6001.22299 installed.<br />
<br />
Doesn't seem to work.<br />
<br />
GetDllVersion &quot;$SYSDIR\msi.dll&quot; $R0 $R1<br />
IntOp $R2 $R0 &gt;&gt; 16<br />
IntOp $R2 $R2 &amp; 0x0000FFFF ; $R2 now contains major version<br />
IntOp $R3 $R0 &amp; 0x0000FFFF ; $R3 now contains minor version<br />
IntOp $R4 $R1 &gt;&gt; 16<br />
IntOp $R4 $R4 &amp; 0x0000FFFF ; $R4 now contains release<br />
IntOp $R5 $R1 &amp; 0x0000FFFF ; $R5 now contains build<br />
StrCpy $0 &quot;$R2.$R3.$R4.$R5&quot; ; $0 now contains string like &quot;1.2.0.192&quot;<br />
<br />
MessageBox MB_ICONINFORMATION|MB_OK &quot;The version is: $R2.$R3.$R4.$R5&quot;<br />
${If} $0 &lt; &quot;3.1.4000.2435&quot;<br />
MessageBox MB_ICONINFORMATION|MB_OK &quot;Install 3.1&quot;<br />
${Else}<br />
MessageBox MB_ICONINFORMATION|MB_OK &quot;Go away!&quot;<br />
${EndIf}<br />
<br />
<br />
How can I use the individual numbers since I need it to have at least 3.1 to go on, so anything less has to have it install.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">3rd May 2010, 17:07</div></div><div class="posttext">For example, .net framework 2.0 requires at least version 3.1 (the above installed is 3.1.4000.2435).<br />
<br />
However I have 4.5.6001.22299 installed.<br />
<br />
Doesn't seem to work.<br />
<br />
${If} $0 &lt; &quot;3.1.4000.2435&quot;<br />
<br />
<br />
Use ${VersionCompare} out of WordFunc.nsh (ships with NSIS) for comparing version numbers.  Right now you're using a string comparison which can fail on version numbers.<br />
( You can also replace the first part of your code with ${GetFileVersion} out of FileFunc.nsh (ships with NSIS) )<br />
<br />
That said... even with the above deficiency, this particular case should work just fine and pop up the &quot;Go away!&quot; messagebox.  try sticking a 'MessageBox MB_OK &quot;[$0]&quot;' just in front of the ${If} so you can double-check that the value of $0 is what you're expecting it to be.<br />
( since you're reading from $SYSDIR, also keep in mind any filesystem redirection magic on 64bit platforms )</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jweinraub</div><div class="date">3rd May 2010, 17:46</div></div><div class="posttext">Is there a different installer needed if there is a 64-bit system in place?  <br />
<br />
Because I have both .net installers for 32-bit and 64-bit versions of Windows.  <br />
My software is installed on laptops that will not have internet access therefore it is critical all prerequisites are met from the installation media itself.<br />
<br />
What should I be aware of for 64-bit versions for the checker?<br />
<br />
<br />
${VersionCompare} $0 &quot;3.1.4000.2435&quot; $R0  <br />
  MessageBox MB_ICONINFORMATION|MB_OK $R0  ; if R0 is 2 then install msi 3.1 installer, else go on?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">3rd May 2010, 18:05</div></div><div class="posttext">Is there a different installer needed if there is a 64-bit system in place?<br />
No, you can have both 32bit and 64bit installers in the same package.<br />
<br />
What should I be aware of for 64-bit versions for the checker?<br />
Specifically, the Sytem32 folder.<br />
On x64 platforms, if a 32bit application reads from the system folder (i.e. $SYSDIR), it gets redirected to a different folder named SysWOW64 (Windows(32) On Windows64).  So if you need to target the 64bit version of the windows installer for that part, then you will have to disable filesystem redirection (Windows XP) or read from the SysNative folder (Vista, 7) instead.<br />
Have a search through the forums - this pops up a few times :)<br />
<br />
<br />
${VersionCompare} $0 &quot;3.1.4000.2435&quot; $R0  <br />
  MessageBox MB_ICONINFORMATION|MB_OK $R0  ; if R0 is 2 then install msi 3.1 installer, else go on?<br />
<br />
correct - but, again, check whether the value of $0 is what you're expecting it to be with a little messagebox first.. if you have further scripts inbetween $0 might be overwritten, or perhaps the file doesn't exist and the version returned would be 0.0.0.0, etc.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jweinraub</div><div class="date">3rd May 2010, 18:44</div></div><div class="posttext">No, you can have both 32bit and 64bit installers in the same package.<br />
<br />
No I meant the WindowsInstaller-KB893803-v2-x86.exe installer.  Is ther an x64 version as well.  <br />
<br />
Because I do this for x64 when it comes to .net.<br />
<br />
  ; Detect .net 2.0 here ;<br />
  System::Call `mscoree::GetCORVersion(w .R0, i ${NSIS_MAX_STRLEN}, *i) ?u`<br />
  StrCpy $R0 $R0 1 1<br />
<br />
  ; Compare if $R0 &lt; 2 using ${If}<br />
<br />
  ${If} $R0 &lt; 2<br />
     ; First detect if this is a 64 bit OS because you will want to install that instead ...<br />
     GetVersion::WindowsPlatformArchitecture<br />
     Pop $R1<br />
     ${AndIf} $R1 == 64<br />
        SetDetailsPrint textonly<br />
        DetailPrint &quot;Installing Microsoft .NET 2.0 x64.  This may take up to ten minutes, please be patient.&quot;<br />
        SetDetailsPrint none<br />
        ExecWait `&quot;$INSTDIR\Misc\NetFx64.exe&quot; /q:a /c:&quot;install.exe /noaspupgrade /qb&quot;` $R0<br />
        ;SetRebootFlag true<br />
     ${OrIf} $R1 == 32<br />
        SetDetailsPrint textonly<br />
        DetailPrint &quot;Installing Microsoft .NET 2.0...&quot;<br />
        SetDetailsPrint none<br />
        ExecWait `&quot;$INSTDIR\Misc\dotnetfx.exe&quot; /q:a /c:&quot;install.exe /noaspupgrade /qb&quot;` $R0<br />
        ;SetRebootFlag true<br />
  ${Else}<br />
     Goto go_on<br />
  ${EndIf}<br />
<br />
<br />
<br />
Specifically, the Sytem32 folder.<br />
On x64 platforms, if a 32bit application reads from the system folder (i.e. $SYSDIR), it gets redirected to a different folder named SysWOW64 (Windows(32) On Windows64).  So if you need to target the 64bit version of the windows installer for that part, then you will have to disable filesystem redirection (Windows XP) or read from the SysNative folder (Vista, 7) instead.<br />
<br />
<br />
I apologise but this part I am still unclear with.  I understand the different sys dirs (like program dirs), but isnt the global variable determine the correct path at runtime?  <br />
Essentially if the user doesnt have msi installer, or an older version than 3.1 I like for it to be installed.  Other wise if the version is equal to or newer than the minimum it should do nothing and go on.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jweinraub</div><div class="date">3rd May 2010, 18:45</div></div><div class="posttext">why do i get all that whitespace at line breaks?!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">3rd May 2010, 19:45</div></div><div class="posttext">There doesn't appear to be a 64-bit version of Windows Installer 3.1 - I assume 4.5 is for those platforms. The forum puts in those new lines. I did ask one of the administrators but they haven't done anything. Instead of using the GetVersion plug-in you can just !include x64.nsh and use ${If} ${RunningX64}.<br />
<br />
Edit: If you're thinking of SetShellVarContext then that is something else. File system redirection is part of the OS and as already mentioned specifying for example C:\Windows\System32 when querying the file system from a 32-bit application, it will be redirected to C:\Windows\SysWOW64.<br />
<br />
Edit #2: In other words MessageBox MB_OK $SYSDIR will print the expected value (System32) but if you write to it your file will be in SysWOW64 instead unless you do ${DisableX64FSRedirection} first.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jweinraub</div><div class="date">3rd May 2010, 20:03</div></div><div class="posttext">What does SetShellVarContext have to do with this?  I actually make use of it only so that it installs on desktop shortcuts for All Users rather than local user (i already assume its being installed by admin).<br />
<br />
So for intents and purposes, I can use the VersionCompare the way I am so I can just call the installer if necessary?<br />
<br />
I assume even if it 0.0.0.0, the 3.x.x.x is still greater so it'll still install if needed, correct?<br />
<br />
So what am I missing here by just doing it the way above?<br />
<br />
Can I just do this?<br />
<br />
; ... snip<br />
${VersionCompare} $0 &quot;3.1.4000.2435&quot; $R0<br />
  ${If} $R0 == 2<br />
     SetDetailsPrint textonly<br />
     DetailPrint &quot;Installing Microsoft Windows Installer 3.1...&quot;<br />
     SetDetailsPrint none<br />
     ExecWait `&quot;$INSTDIR\Misc\WindowsInstaller-KB893803-v2-x86.exe&quot; /quiet&quot;` $R0<br />
  ${EndIf}<br />
; ... snip</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">3rd May 2010, 20:26</div></div><div class="posttext">SetShellVarContext has nothing to do with it, hence why I said that. VersionCompare will read an empty string as 0 (so an empty $0 will not break the code).<br />
<br />
Stu</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>