<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Playing with COM, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Playing with COM NSIS Discussion" />
	
	<title> Playing with COM [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Playing with COM</div>
<hr />
<div class="pda"><a href="t-321811.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=321811">Playing with COM</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Zinthose</div><div class="date">19th August 2010, 20:12</div></div><div class="posttext">I'm attempting to recreate the example posted at: http://en.wikipedia.org/wiki/OLE_Automation#Examples<br />
<br />
My code is choking at GetIDsOfNames...  Can anyone add some insight?<br />
<br />
    /*<br />
    !define IID_StdOle      '{00020430-0000-0000-C000-000000000046}'<br />
    !define IID_IDispatch   '{00020400-0000-0000-C000-000000000046}'<br />
    !define IID_IUnknown    '{00000000-0000-0000-C000-000000000046}'<br />
    !define IID_NULL        '{00000000-0000-0000-0000-000000000000}'<br />
<br />
    !define CLSCTX_SERVER           0x015<br />
    !define LOCALE_SYSTEM_DEFAULT   0x800<br />
    */<br />
<br />
    DetailPrint CLSIDFromProgID<br />
    System::Call `Ole32::CLSIDFromProgID(w,&amp;g16)i (&quot;Excel.Application&quot;,.r0).r2`<br />
    DetailPrint &quot;ERR=$2&quot;<br />
    DetailPrint &quot;CLSID=$0&quot;<br />
    <br />
    <br />
    DetailPrint CoCreateInstance<br />
    System::Call `Ole32::CoCreateInstance(g r0,i 0,i ${CLSCTX_SERVER},g '${IID_IDispatch}',*i .r1) i .r2`<br />
    DetailPrint &quot;ERR=$2&quot;<br />
    <br />
    DetailPrint GetIDsOfNames<br />
    System::Call `$1-&gt;GetIDsOfNames(g ${IID_NULL},w &quot;Visible&quot;,i 1,i ${LOCALE_SYSTEM_DEFAULT},*i .r3)i .r2` ;&lt;-- Errors here... :'(<br />
    DetailPrint &quot;ERR=$2&quot; ; &lt;-- I'm getting error 0x80004002 (AKA  E_NOINTERFACE)<br />
    DetailPrint $$3=$3</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">19th August 2010, 20:24</div></div><div class="posttext">My code is choking at GetIDsOfNames...  Can anyone add some insight?<br />
<br />
<br />
    System::Call `$1-&gt;GetIDsOfNames(g ${IID_NULL},w &quot;Visible&quot;,i 1,i ${LOCALE_SYSTEM_DEFAULT},*i .r3)i .r2` ;&lt;-- Errors here... :'(<br />
    DetailPrint &quot;ERR=$2&quot; ; &lt;-- I'm getting error 0x80004002 (AKA  E_NOINTERFACE)<br />
<br />
<br />
GetIDsOfNames should be replaced by the numerical entry of that bit in the interface.  I don't recall where you can find that, though..</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">19th August 2010, 21:24</div></div><div class="posttext">It's the zero-based index of the method as it is listed physically in the interface. This includes methods from interfaces that the interface you are using implements. As IUnknown has 3 methods, your first interface method will typically be #3.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">19th August 2010, 21:32</div></div><div class="posttext">It's the zero-based index of the method as it is listed physically in the interface. This includes methods from interfaces that the interface you are using implements. As IUnknown has 3 methods, your first interface method will typically be #3.<br />
<br />
Right - as per the System plugin docs;<br />
To find out the index of a member in a COM interface, you need to search for the definition of this COM interface in the header files that come with Visual C/C++ or the Platform SDK. Remember the index is zero based.<br />
<br />
What I meant was.. I don't recall where the header files for this interface can be found online (many of us don't actually touch the SDK bits and pieces) - but then I remembered; WINE usually has 'm :)<br />
<br />
http://source.winehq.org/source/include/oleauto.h</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Zinthose</div><div class="date">19th August 2010, 21:40</div></div><div class="posttext">Aight... Using the VTable index to lookup the interfaces methods I have now updated with the following..    DetailPrint &quot;== CLSIDFromProgID ==&quot;<br />
    System::Call `Ole32::CLSIDFromProgID(w,&amp;g16)i (&quot;Excel.Application&quot;,.r0).r2`<br />
    DetailPrint &quot;  ERR=$2&quot;<br />
    DetailPrint &quot;  CLSID=$0&quot;<br />
    <br />
    DetailPrint &quot;== CoCreateInstance ==&quot;<br />
    System::Call `Ole32::CoCreateInstance(g r0,i 0,i ${CLSCTX_SERVER},g '${IID_IDispatch}',*i .r1) i .r2`<br />
    DetailPrint &quot;  ERR=$2&quot;<br />
    <br />
    DetailPrint &quot;== IUnknown::GetTypeInfoCount ==&quot;<br />
    System::Call `$1-&gt;3(*i .r3)i .r2`<br />
    DetailPrint &quot;  ERR=$2&quot;<br />
    DetailPrint &quot;  $$3=$3&quot;<br />
    <br />
    DetailPrint &quot;== IDispatch::GetTypeInfo ==&quot;<br />
    System::Call `$1-&gt;4(i 0,i ${LOCALE_SYSTEM_DEFAULT},*i .r3)i .r2`<br />
    DetailPrint &quot;  ERR=$2&quot;<br />
    DetailPrint &quot;  $$3=$3&quot;<br />
    <br />
    DetailPrint &quot;== IDispatch::GetIDsOfNames ==&quot;<br />
    ;System::Call `*(i 7,w &quot;Visible&quot;)i .s`<br />
    ;System::Call `$1-&gt;5(g ${IID_NULL},i s,i 1,i ${LOCALE_SYSTEM_DEFAULT},*i .r3)i .r2` ;&lt;-- Errors here... :'(<br />
    System::Call `$1-&gt;5(g ${IID_NULL},w &quot;Visible&quot;,i 1,i ${LOCALE_SYSTEM_DEFAULT},*i .r3)i .r2` ;&lt;-- Errors here... :'(<br />
    DetailPrint &quot;  ERR=$2&quot;<br />
    DetailPrint &quot;  $$3=$3&quot;I think the issue may be with the BSTR.  I tried creating it manually but I think I'm doint it wrong too..  :/<br />
<br />
UPDATE:  I'm convinced it is the BSTR..  Reading up on how to implement them now... http://msdn.microsoft.com/en-us/library/ms221069.aspx</div></div><hr />


<div class="post"><div class="posttop"><div class="username">gringoloco023</div><div class="date">19th August 2010, 21:48</div></div><div class="posttext">Is it index 6 ? See, http://www.clarionopensource.com/ClarionCOM/IDispatchInterface.htm<br />
<br />
I was recently fighting with something similar, ITypeLib :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Zinthose</div><div class="date">19th August 2010, 23:12</div></div><div class="posttext">Woot!  It was the BSTR!    DetailPrint &quot;== CLSIDFromProgID ==&quot;<br />
    System::Call `Ole32::CLSIDFromProgID(w,&amp;g16)i (&quot;Excel.Application&quot;,.r0).r2`<br />
    DetailPrint &quot;  ERR=$2&quot;<br />
    DetailPrint &quot;  CLSID=$0&quot;<br />
    <br />
    DetailPrint &quot;== CoCreateInstance ==&quot;<br />
    System::Call `Ole32::CoCreateInstance(g r0,i 0,i ${CLSCTX_SERVER},g '${IID_IDispatch}',*i .r1) i .r2`<br />
    DetailPrint &quot;  ERR=$2&quot;<br />
    <br />
    DetailPrint &quot;== IUnknown::GetTypeInfoCount ==&quot;<br />
    System::Call `$1-&gt;3(*i .r3)i .r2`<br />
    DetailPrint &quot;  ERR=$2&quot;<br />
    DetailPrint &quot;  $$3=$3&quot;<br />
    <br />
    DetailPrint &quot;== IDispatch::GetTypeInfo ==&quot;<br />
    System::Call `$1-&gt;4(i 0,i ${LOCALE_SYSTEM_DEFAULT},*g .r3)i .r2`<br />
    DetailPrint &quot;  ERR=$2&quot;<br />
    DetailPrint &quot;  $$3=$3&quot;<br />
    <br />
    DetailPrint &quot;== BSTR ==&quot;<br />
    System::Call `Oleaut32::SysAllocString(w &quot;Visible&quot;)i .s`<br />
    <br />
    DetailPrint &quot;== IDispatch::GetIDsOfNames ==&quot;<br />
    System::Call `$1-&gt;5(g ${IID_NULL},*i s,i 1,i ${LOCALE_SYSTEM_DEFAULT},*i .r3)i .r2` ;&lt;-- Errors here... :'(<br />
    DetailPrint &quot;  ERR=$2&quot;<br />
    DetailPrint &quot;  $$3=$3&quot;<br />
<br />
Now to work out the rest...   ;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Zinthose</div><div class="date">19th August 2010, 23:23</div></div><div class="posttext">Just a warning... if anyone is playing around with this.. check your TaskManager..  I just found 23 instances of Excel running..... :eek:<br />
<br />
Here is the updated code with the COM Release at the end.    DetailPrint &quot;== CLSIDFromProgID ==&quot;<br />
    System::Call `Ole32::CLSIDFromProgID(w,&amp;g16)i (&quot;Excel.Application&quot;,.r0).r2`<br />
    DetailPrint &quot;  ERR=$2&quot;<br />
    DetailPrint &quot;  CLSID=$0&quot;<br />
    <br />
    DetailPrint &quot;== CoCreateInstance ==&quot;<br />
    System::Call `Ole32::CoCreateInstance(g r0,i 0,i ${CLSCTX_SERVER},g '${IID_IDispatch}',*i .r1) i .r2`<br />
    DetailPrint &quot;  ERR=$2&quot;<br />
    <br />
    DetailPrint &quot;== IDispatch::GetTypeInfoCount ==&quot;<br />
    System::Call `$1-&gt;3(*i .r3)i .r2`<br />
    DetailPrint &quot;  ERR=$2&quot;<br />
    DetailPrint &quot;  $$3=$3&quot;<br />
    <br />
    DetailPrint &quot;== IDispatch::GetTypeInfo ==&quot;<br />
    System::Call `$1-&gt;4(i 0,i ${LOCALE_SYSTEM_DEFAULT},*g .r3)i .r2`<br />
    DetailPrint &quot;  ERR=$2&quot;<br />
    DetailPrint &quot;  $$3=$3&quot;<br />
    <br />
    DetailPrint &quot;== Oleaut32::SysAllocString ==&quot;<br />
    System::Call `Oleaut32::SysAllocString(w &quot;Visible&quot;)i .r4`<br />
    DetailPrint &quot;  RC=$4&quot;<br />
    <br />
    DetailPrint &quot;== IDispatch::GetIDsOfNames ==&quot;<br />
    System::Call `$1-&gt;5(g ${IID_NULL},*i r4,i 1,i ${LOCALE_SYSTEM_DEFAULT},*i .r3)i .r2` ;&lt;-- Errors here... :'(<br />
    DetailPrint &quot;  ERR=$2&quot;<br />
    DetailPrint &quot;  $$3=$3&quot;<br />
    <br />
    DetailPrint &quot;== Oleaut32::SysFreeString ==&quot;<br />
    System::Call `Oleaut32::SysFreeString(*i r4)`<br />
    <br />
    DetailPrint &quot;== IUnknown::Release ==&quot;<br />
    System::Call `$1-&gt;2()i .r2`<br />
    DetailPrint &quot;  RefCount=$2&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">19th August 2010, 23:58</div></div><div class="posttext">heehee<br />
<br />
good job :)<br />
<br />
one thing you might want to do, just for readability, is defining the interface bits.. e.g.<br />
<br />
!define GetIDsOfNames 5<br />
<br />
or even<br />
<br />
!define IDispatch-&gt;GetIDsOfNames 5<br />
<br />
Then later on you can just use..<br />
${IDispatch-&gt;GetIDsOfNames} (g ${IID_NULL, etc.<br />
..bit cleaner to read :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Zinthose</div><div class="date">20th August 2010, 00:56</div></div><div class="posttext">Good idea!!<br />
<br />
Here is what I thew together.. needs more optimizations but it's a good start..    ## Simplyfy the Evil that is COM<br />
    ## Example:<br />
    ##      ${IDispatch::GetTypeInfo} $1 `(i 0,i ${LOCALE_SYSTEM_DEFAULT},*g .r3)i .r2`<br />
        !macro _COM_Function _vTableID _ObjectPointer _Parameters<br />
            System::Call `${_ObjectPointer}-&gt;${_vTableID}${_Parameters}`<br />
        !macroend<br />
        !define IUnknown::Release           `!insertmacro _COM_Function 2 `<br />
        !define IDispatch::GetTypeInfoCount `!insertmacro _COM_Function 3 `<br />
        !define IDispatch::GetTypeInfo      `!insertmacro _COM_Function 4 `<br />
        !define IDispatch::GetIDsOfNames    `!insertmacro _COM_Function 5 `<br />
        !define IDispatch::Invoke           `!insertmacro _COM_Function 6 `</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">20th August 2010, 18:27</div></div><div class="posttext">I have been using some helper macros that are very similar to this (See http://nsis.pastebin.com/BqQFTRv3 ) but I also declare the parameter types in my &quot;_COM_Function&quot; macro so you don't have to specify them when you invoke the method (Can also be used to set default parameter values IIRC) I also use -&gt; and not ::. It might be a good idea to come up with a standard and include it in some header (There is no way we can define all COM interfaces, but some of the shell interfaces would be a good start)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>