<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Shortcuts on Vista, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Shortcuts on Vista NSIS Discussion" />
	
	<title> Shortcuts on Vista [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Shortcuts on Vista</div>
<hr />
<div class="pda"><a href="t-265780.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=265780">Shortcuts on Vista</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">alex5</div><div class="date">14th February 2007, 13:22</div></div><div class="posttext">What is the proper way to create shortcuts on Windows Vista ?<br />
If I set 'RequestExecutionLevel admin', install is running as administrator and shortcuts are created for administrator not the currently logged in user. <br />
If RequestExecutionLevel is set to user, then shortcuts are properly created, but you can't write to Program Files, write unistall registry key...<br />
<br />
How can I create shortcuts for current user (SetShellVarContext is set to current) ?<br />
<br />
Thanks<br />
<br />
Alex<br />
<br />
**********************************************************<br />
[edit] 08/05/07 - DrO<br />
Please refer to http://nsis.sourceforge.net/UAC_plug-in for information and plugin regarding this thread</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">14th February 2007, 15:31</div></div><div class="posttext">I could reproduce this with &quot;Standart User&quot; account :( UAC not only elevates execution level, but changes user as well... Even desktop links created for UAC requested admin account.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">1st March 2007, 22:35</div></div><div class="posttext">I think this is a serious problem which should be handled by NSIS. Of course we could build wrapped installers where some are running as user and some as admin. But this will be some very basic problem with Vista in general.<br />
<br />
Problems:<br />
1. Registry: HKCU<br />
2. User profile directory (shortcuts and more)<br />
3. &quot;Run ... now&quot; on finish page (this is a small issue in XP too if the installer is run as admin there). This might be a problem for other (custom) ShellExec's, too.<br />
<br />
Can NSIS change its execution level at runtime? Does anybody know what Vista does here?<br />
<br />
I think the best solution would be to run as admin in general when RequestExecutionLevel admin is set but to make special handling for HKCU / shortcuts.<br />
<br />
Could NSIS detect what user was active before elevating?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">1st March 2007, 22:51</div></div><div class="posttext">No NSIS could not detect this, vista elevates before the actual process is started</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">2nd March 2007, 00:54</div></div><div class="posttext">I'm developing a plugin that hopefully will help to deal with these Vista problems, its still &quot;in Beta&quot; so don't blame me if it doesnt work or blows up in your face (or all over your HD)<br />
<br />
Checkout UAC_RealWorldExample (Known issue: Does not print to instfiles page log or any kind of success feedback when elevated)<br />
<br />
<br />
http://stashbox.org/13537/UAC%20v0.0.5b.zip<br />
<br />
IMHO The shortcut problem is not really a problem, when using RequestExecutionLevel admin it is a &quot;All users&quot; install, if you want to use RequestExecutionLevel user, you should write the uninstall entry in HKCU and install your files in $LOCALAPPDATA</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">2nd March 2007, 09:35</div></div><div class="posttext">I agree: short cut is no real problem, I think I will just disable the possibility to install them for &quot;current user&quot;. I know of current user installs but this is not an option for most of my installers here.<br />
<br />
I use HKCU to store some settings for the user who installs the application. E.g. the license text can be stored as &quot;seen&quot; for the use who read it during install. Other users will get it on first application start. And I store language settings and more for the installing user.<br />
<br />
Thanks for the new plugin, is there some short documentation how the functions work (other than the examples)?<br />
<br />
As far as I can see this works like:<br />
<br />
- start in user mode<br />
- elevate to admin mode (with error/retry handling)<br />
<br />
Can I un-elevate (back to user mode)?<br />
If yes, I guess re-elevating (elevating for the 2nd time) would require additional password entry.<br />
<br />
It seems the current process is changed at run-time. What does change on elevation? Username? access rights? &quot;current user&quot; profile (NSIS vars?)<br />
<br />
What about my Exec problem? Currently I would like to run the installer as admin (could be done by requestlevel user and elevating in .oninit) but make the run caused by the finish page checkbox (&quot;run now ...&quot;) to run the app as original user.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">2nd March 2007, 13:21</div></div><div class="posttext">The SAFER plug-in (http://nsis.sourceforge.net/SAFER_plug-in) should solve the Exec problem. But if the user is switched and not elevated, you won't get the original user.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">2nd March 2007, 16:51</div></div><div class="posttext">There are no docs at this time, the exported functions have a little bit of text if you look in uac.cpp<br />
<br />
You cant un-elevate once you have elevated (Well you could call UAC::Exec on yourself but that would be the same as a &quot;current user&quot; install)<br />
<br />
<br />
This plugin should solve the Exec problem, use Process Explorer (Sysinternals/MS), turn on the User and Intergrity level columns and run the realworld example as a normal user elevating with a different admin account<br />
<br />
<br />
What changes after elevation depends on whether UAC is on or off.<br />
<br />
UAC on and the user is an admin (Split token):<br />
  Nothing really changes<br />
  UAC::IsAdmin returns 1 after elevation and 0 before<br />
  UAC::SupportsUAC returns 1<br />
  UAC::GetElevationType returns 3 before successfull elevation with RunElevated and 2 after<br />
<br />
UAC off and the user is an admin:<br />
  Nothing really changes<br />
  UAC::IsAdmin returns 1<br />
  UAC::SupportsUAC returns 0<br />
  UAC::GetElevationType returns 1<br />
<br />
User not member of admin group:<br />
  Everything changes (Username/Profile/HKCU part of registry)<br />
  UAC::IsAdmin returns 0 before elevation and 1 after<br />
  UAC::SupportsUAC return depends on whether UAC is on/off<br />
  UAC::GetElevationType again depends on UAC on/off<br />
  (NOTE: Vista seems totally broken in this configuration (IF UAC IS OFF), try right clicking on a .exe and choose &quot;Run as administrator&quot;, nothing happens, in this case the plugin uses its own custom RunAs dialog)<br />
<br />
<br />
on pre vista systems UAC::GetElevationType always returns 0<br />
<br />
the UAC plugin can allow you to run in &quot;current user&quot; mode, if $0 == 1223 after UAC::RunElevated the user clicked cancel in the UAC/RunAs dialog (This is all up to the creator of the installer)<br />
<br />
The SAFER plugin doesnt work very well on Vista, MS broke the SAFER api on this OS (It still works but the process will still run @ High integrity level)<br />
<br />
Note: This is all from memory, i might have missed something</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">2nd March 2007, 17:13</div></div><div class="posttext">Thanks a lot, Anders.<br />
<br />
Some questions:<br />
Can you explain Exec a bit more? How does this work? Does this run the process with the original user (calling the installer)? How does UAC::Exec behave on Non-UAC-systems?<br />
<br />
Does this help with RunAs (WinXP) or is RunAs with XP always independent from the original user (I guess this is the case, so maybe the &quot;run now&quot; on the finish page is bad for XP when RunAs (possibly) is used).<br />
<br />
I'm trying to understand this (before testing/verifying).<br />
<br />
You wrote: &quot;in this case the plugin uses its own custom RunAs dialog&quot;<br />
What do you mean with this? How is the &quot;run as dialog&quot; correlated to NSIS here?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">2nd March 2007, 17:33</div></div><div class="posttext">Run process explorer, you can see two instances(processes) of your setup, one running as the user that started the setup and one running at high integrity level (and possibly as another user if the original user was not a member of the admin group) When you use UAC::Exec/ExecWait/ShellExec/ShellExecWait the 2nd elevated process will send a message to the original process telling it to start a process (uses WM_COPYDATA)<br />
<br />
Running as admin on pre vista or admin with UAC off on vista will only use one process and UAC::Exec just calls CreateProcess without any trickery<br />
<br />
EDIT: on win2000/xp it somewhat emulates the vista elevation, UAC::Exec will start a process as the original user<br />
I guess you could use the SAFER plugin on xp so the process spawned at the finish page does not run as admin even if the real user is admin<br />
<br />
<br />
UAC::RunElevated just does ShellExecute on itself using the runas verb (The documented way to get the uac dialog on vista) this also works on Win2k/XP except you get the old school runas ofcourse. If a non-admin user on vista with UAC off is detected, using runas with ShellExecute will not work at all so UAC::RunElevated uses its own dialog that emulates the pre vista runas instead</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">2nd March 2007, 18:08</div></div><div class="posttext">Thanks Anders, I will try your plugin.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">4th March 2007, 16:46</div></div><div class="posttext">New version: http://stashbox.org/13698/UAC%20v0.0.5c.zip<br />
<br />
IsAdmin can now handle a restricted token on &lt;NT6, no other changes</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">25th March 2007, 04:50</div></div><div class="posttext">New version: http://stashbox.org/15549/UAC%20v0.0.5d.zip<br />
<br />
Fixed a bug in IsAdmin, please update</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">31st March 2007, 12:49</div></div><div class="posttext">@Anders: You call UAC::Unload in .oninstfailed/.oninstsuccess. <br />
Is this necessary?<br />
<br />
I use Quit in many places in my scripts (to abort the installer immediately) and this will not run those callbacks, so UAC::Unload will not run. Is it safe to Quit without &quot;UAC::Unload&quot;?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">31st March 2007, 13:29</div></div><div class="posttext">Additional question: Does UAC::Unload harm if UAC plugin wasn't used/loaded before?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">31st March 2007, 15:21</div></div><div class="posttext">It will not crash if you dont call unload, but it will probably leave uac.dll in $pluginsdir so you will leave stuff behind in the users $temp dir. The only thing UAC::Unload does is to call FreeLibrary on itself so you should probably call it if possible. If you call Quit before you call any UAC function you dont need to unload (IsAdmin,SupportsUAC and GetElevationType is safe to use without unload, RunElevated and ExecCodeSegment is not)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">1st April 2007, 16:25</div></div><div class="posttext">I could not try it myself (yet), what about error level return values? I use &quot;set error level&quot; within my script and the outer process should return those error level value, too (if set).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">2nd April 2007, 11:09</div></div><div class="posttext">Ah, found it:<br />
<br />
RunElevate returns<br />
&quot;r2 is the ExitCode of the elevated fork process (The NSIS errlvl is also set to the ExitCode)&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">2nd April 2007, 12:36</div></div><div class="posttext">The plugin seems to work. Thanks, Anders!<br />
<br />
UAC::GetElevationType and UAC::SupportsUAC return &quot;0&quot; for XP. But RunElevated supports RunAs dialog (nice feature). It would be nice to have functions UAC::GetRunAsType and UAC::SupportsRunAs so one can show some message to the user before the RunAs dialog is shown. Seems that at least SupportsRunAs is already implemented (but not exported to NSIS).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">2nd April 2007, 16:38</div></div><div class="posttext">UAC::GetElevationType and UAC::SupportsUAC return 0 on XP and below because those are Vista specific.<br />
<br />
I think RunAs is supported on all NT systems (And it is not needed on 9x) atleast it works on w2k and up. I don't have a NT4 box to test on so im not sure. What would UAC::GetRunAsType do, tell you what kind of runas dialog you would get (Does it really matter)?<br />
<br />
I like the idea of the messagebox before elevation (Even tho users will get used to the elevation on Vista), I could probably create something like UAC::SupportsRunAs</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">2nd April 2007, 17:03</div></div><div class="posttext">GetRunAsType could return &quot;1&quot; if this is the inner process. I currently check myself for &quot;/UAC:&quot; in CMDLINE. I have to do this because the MessageBox I show will appear twice if I show it always before RunElevated.<br />
<br />
I don't really know whether GetElevationType will really return the state of &quot;inner&quot; or &quot;outer&quot; process (imagine outer user IS admin, even with UAC -- could be caused by automatic install scripts). So maybe GetRunAsType could be something like &quot;IsInnerProcess&quot;...<br />
<br />
I simulate SupportsRunAs for now by checking the OS major version against &quot;5&quot;. AFAIK NT4 does not have something like RunAs (at least &quot;runas.exe&quot; is only available with 2k/XP).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">2nd April 2007, 20:30</div></div><div class="posttext">You dont really need to know if you are the inner process or not, if IsAdmin returns 1 you are either already admin or the elevation has been performed</div></div><hr />


<div class="post"><div class="posttop"><div class="username">onad</div><div class="date">3rd April 2007, 10:03</div></div><div class="posttext">NT4 users should install and use the SU command from the NT Resource Kit.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">3rd April 2007, 11:30</div></div><div class="posttext">@Anders: I need to know. It is helpful anyway to know this, but if I don't detect this (inner process yes/no), I will show the warning message twice if the user logs in as non-admin in RunAs dialog (try for yourself; it took me some minutes to detect what was going on there).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">3rd April 2007, 15:32</div></div><div class="posttext">ah ok, just look for &quot;/UAC&quot; then utill I can get a new version out</div></div><hr />


<div class="post"><div class="posttop"><div class="username">FrozenFire</div><div class="date">3rd May 2007, 19:20</div></div><div class="posttext">Downloaded your pluggin today to try to fix some exec problems i've been having in vista. I ended up making an function to install files in restricted areas and calling it to run in ellivated mode, but it didn't work, instead producing an error when the installer tried to write to the secured area.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">3rd May 2007, 21:04</div></div><div class="posttext">Post code here for help.<br />
<br />
UAC plugin works fine for me. One important thing to know is that the whole installer will run elevated (or not), so you cannot have a single function run elevated and the rest unelevated (you would have to do this manually).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MarcOfChaos</div><div class="date">4th May 2007, 13:37</div></div><div class="posttext">Hello, <br />
<br />
I am trying to make an installer which runs with &quot;RequestExecutionLevel user&quot;. <br />
<br />
During the installation process the user can select whether he just wants to execute or install the software. If he wants to install the software I use UAC::RunElevated to restart the installer with all necessary tokens. This works fine if the current user is an admin. <br />
When I try it with an ordinary user the RunAs Dialog is dispalyed but the second program is not executed. <br />
<br />
RunElevated returns a value of 6 which is (to my knowledge) the error code for a missing handle. <br />
<br />
Any ideas what is happening there?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">4th May 2007, 14:51</div></div><div class="posttext">Could you post some example script with this problem?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MarcOfChaos</div><div class="date">7th May 2007, 08:25</div></div><div class="posttext">Hello Anders, <br />
<br />
Thank you for your reply. <br />
Unfortunately a code snippet will not be of much help. <br />
I only call UAC::RunElevated when logged in as a domain user in Win Vista. <br />
<br />
But the thing gets even stranger: I tested the installer from my desktop. When I copy the same installer to some other folder (e.g. \programms) UAC::RunElevated runs perfectly (RunAs Dialog is being displayed and the installer is restarted with the correct privileges). Btw: It also does not work when I run it under \users. <br />
Maybe it is some kind of special virtualization with Vista. <br />
Any ideas what is causing this?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">7th May 2007, 15:19</div></div><div class="posttext">I have no idea whats going on, and I don't have a domain setup to test with (I don't even have a Vista install to test on ATM)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MarcOfChaos</div><div class="date">7th May 2007, 16:07</div></div><div class="posttext">FYI:<br />
I did some further research (trial and error...). <br />
The error has nothing to do with whether the user is in a domain or not. <br />
It just seems that CreateProcessWithLogonW does not work when the installer is in a user related folder (e.g. Desktop, Documents, etc.). If I copy the installer to some other place (e.g. Programms, Public, etc.) the installer works just fine. <br />
I added some messageboxes to the uac.dll but CreateProcessWithLogonW did not give me any errors.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">helix400</div><div class="date">7th May 2007, 19:37</div></div><div class="posttext">Originally posted by MarcOfChaos <br />
But the thing gets even stranger: I tested the installer from my desktop. When I copy the same installer to some other folder (e.g. \programms) UAC::RunElevated runs perfectly (RunAs Dialog is being displayed and the installer is restarted with the correct privileges). Btw: It also does not work when I run it under \users. <br />
Maybe it is some kind of special virtualization with Vista. <br />
Any ideas what is causing this?  <br />
<br />
I just tested it on my Vista machine.<br />
<br />
I ran my installer on a limited Vista user account.  If I ran it from a non-user folder, I got the Run As dialog.  I put in the Administrator name and password, which Windows accepted.  But my NSIS/UAC plugin code reported that admin access is required. <br />
<br />
When I moved it to the users desktop folder, I received the error 6 as you mentioned.  :(</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">7th May 2007, 21:21</div></div><div class="posttext">Please describe your exact setup (Vista SKU, UAC on or off, type of user, exact directory it fails in)<br />
<br />
Try this debug build: http://stashbox.org/19884/UAC.dll and watch the (unhelpful?) debug output with DebugView ( http://www.microsoft.com/technet/sysinternals/utilities/debugview.mspx )<br />
<br />
Are you sure the problem is with CreateProcessWithLogonW? you could comment out #define FEAT_CUSTOMRUNASDLG in uac.h to disable that code, but in my experience, Vista does nothing if you call ShellExecute(0,&quot;runas&quot;) if the current user is not in the admin group and UAC is off (thats why I had to call CreateProcessWithLogonW in the first place)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">helix400</div><div class="date">7th May 2007, 22:41</div></div><div class="posttext">Anders,<br />
<br />
Your reply seemed to be directed at MarcOfChaos, but with your blessings, I'd like to help do what I can on this problem as well.  I would really like to get this plugin working.  Prior to receiving said blessings, I'm going to help anyways.  :)<br />
<br />
Attached is a .zip file containng two log files generated from DebugView.  <br />
<br />
Setup:<br />
Vista SKU - Vista Home Premium<br />
UAC is on<br />
User -  A Standard User (I named my standard user account &quot;Peon&quot;)<br />
<br />
standarduser_regularfolder.LOG is an example of me trying to run your UAC_AdminOnly sample from my C:\download\nsis\ folder.  I put in my info into a Run As dialog, it said it needed admin access, so I tried again, it said it needed admin access, so I clicked cancel, and received the NSIS script message that it's aborting.<br />
<br />
standarduser_userfolder.LOG is an example of me trying to run your UAC_AdminOnly sample from my C:\Users\Peon folder.  I put in my admin info into the Run As dialog.  I then got 2 message boxes (if you want the message box info, let me know...it was something about line 53 and line 60 i think), then the NSIS script gave the error: &quot;Unable to elevate , error 6&quot;<br />
<br />
One last thing.  I went into the log files and changed my actual password to simply &quot;password&quot;.  I don't want you seeing my real password  :P</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">7th May 2007, 23:14</div></div><div class="posttext">Hm, when UAC is on, you are not supposed to get my runas dialog, but the normal vista elevation dialog. My detection for this must be messed up. Would be great if you could drop by the nsis irc channel so I could create some test builds for you<br />
<br />
or try http://stashbox.org/19898/UAC.dll</div></div><hr />


<div class="post"><div class="posttop"><div class="username">helix400</div><div class="date">8th May 2007, 00:14</div></div><div class="posttext">Anders,<br />
<br />
I'd be happy to test that out and jump int the IRC channels to help you out (I really appreciate the time you're putting into this).<br />
<br />
But for now, I have to go.  I've got tickets to the Utah Jazz vs. Golden State Warriors Game 1.  :)  <br />
<br />
(Also, I just double checked to verify UAC was on.  When I ran a normal NSIS installer on my standard user account, I did get a UAC dialog asking for an administrators password.  <br />
<br />
When I ran a NSIS installer with your UAC plugin under the same user account, I did get the Run As dialog.)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MarcOfChaos</div><div class="date">8th May 2007, 08:06</div></div><div class="posttext">Hello, <br />
<br />
Sorry for my late reply. I am currently a little busy (who is not? ;))<br />
Find attached the logfiles and error messages of the 2 debug builds.<br />
<br />
I tested on Win Vista Ultimate with activated UAC. <br />
Just like helix400 I changed the passwords and usernames.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">8th May 2007, 15:10</div></div><div class="posttext">Hi Anders, I have three improvement suggestions:<br />
<br />
1. The built-in RunAs-dialog for Vista is english only. This dialog should be &quot;multi-language&quot; (e.g. by loading text strings from some ini file in $PLUGINSDIR).<br />
<br />
2. Currently we do not a RunAs-dialog which allows all users etc. We always want the user to login using an admin account. So the dialog might be changed: other texts, maybe a combo box where (local?) admin usernames are pre-filled etc. The &quot;current user&quot; setting (radio selection) seems quite useless here.<br />
<br />
3. The XP/2000-RunAs-dialog is not optimal for installers because it has worse defaults. A good own dialog (see points 1 and 2) for Vista could be used for XP/2000, too. The dialog should mention the need for elevation (so we do not need a messagebox with explaining texts before). <br />
We just need some text explaining why this dialog appeared and what the user is expected to do, a possibility to enter a username (Administrator account should be preselected) and a password input field.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">8th May 2007, 15:16</div></div><div class="posttext">Just an idea: I don't know whether the system RunAs-dialog in Windows 2000/XP supports other authentication methods than password. Think of a fingerprint reader...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">8th May 2007, 15:49</div></div><div class="posttext">thanks everyone for testing, I will need to find a new way to detect if i need my runas dialog<br />
<br />
Please report the output of this console app: http://stashbox.org/19958/TokenElevation.exe (Based on code from http://blogs.msdn.com/cjacks/archive/2006/10/09/How-to-Determine-if-a-User-is-a-Member-of-the-Administrators-Group-with-UAC-Enabled-on-Windows-Vista.aspx )</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MarcOfChaos</div><div class="date">8th May 2007, 16:12</div></div><div class="posttext">Hi, <br />
<br />
Did some further research: <br />
TokenElevationTypeDefault only means that the user does not have a split token. This should be true for 'nearly' every user that is not an administrator. <br />
I also found a clue on how to determine whether UAC is enabled. <br />
One could try to check in the registry whether the policy is enabled or not. <br />
HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\EnableLUA <br />
Possible values: Enabled (1), Disabled(0)<br />
<br />
Hope this helps...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MarcOfChaos</div><div class="date">8th May 2007, 16:25</div></div><div class="posttext">Hi, <br />
<br />
find attached the screenshots of the TokenElevation.exe.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">helix400</div><div class="date">8th May 2007, 18:21</div></div><div class="posttext">I tested TokenElevation as well.  I got different result when I ran the app from a regular folder with a standard user account.  Screenshots are attached below.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">helix400</div><div class="date">8th May 2007, 20:35</div></div><div class="posttext">Just an update for those following the thread.  I worked with Anders more today.  He got a version working where the UAC dialog pops up when it should (when UAC is turned on), and the Run As dialog pops up when it should (when UAC is turned off).  In all situations, the test apps worked.  There's still the issue of the installer window popping up behind active windows...he'll work on that later.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">8th May 2007, 23:24</div></div><div class="posttext">Ok, I created a wiki page @ http://nsis.sourceforge.net/UAC_plug-in , only done limited testing, but I hope its fixed, please report back</div></div><hr />


<div class="post"><div class="posttop"><div class="username">fishsauce</div><div class="date">9th May 2007, 06:10</div></div><div class="posttext">Sorry, but I got kind of lost as to how this plug-in helps to create shortcuts in the user's own start menu instead of the all users one.  Can anyone give me a bit of guidance?  Thanks.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">helix400</div><div class="date">9th May 2007, 07:42</div></div><div class="posttext">It's more of an overall UAC thing, which has a nice side effect of solving the Vista user shortcuts problem.<br />
<br />
The way this plugin works is the following:<br />
<br />
1) First, the NSIS script needs to say it wants user privileges, not admin privileges.<br />
2) The NSIS installer launches, and quickly calls its .onInit code (no form has shown by this point yet).  That code makes a new process and attempts to elevate it to admin mode.  Anders calls the first process the outer process, and this second process the inner process.<br />
3) If needed, a UAC or Run As dialog is shown.  After that, the inner process should be elevated to admin access.  Then this admin/inner process can display.  This is the main installer app that users will see.  At this time, two processes are running.  One as a user, another as an admin.<br />
4) Now that you have an admin process, you can continue to let your script do its thing.  If you ever need to do something at a user level, you do it through the UAC plugin.  For example, UAC::Exec can execute something with user privileges and not admin privileges.  <br />
<br />
With all this in place, you can do some system calls to create a shortcut as a user.  Personally, I think the UAC plugin should have some extra features added on, such as UAC::CreateUserShortcut or something like that.  But then, Anders has been working really hard on just getting the bugs worked out of the current plugin...I'm just happy he's providing a fairly clean solution compared to the really ugly alternatives out there in the Vista world.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">fishsauce</div><div class="date">10th May 2007, 06:18</div></div><div class="posttext">I see... thanks for the nice, detailed overview.  Now to figure out how to actually make those shortcuts using UAC::Exec...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">10th May 2007, 09:32</div></div><div class="posttext">You should not use UAC::Exec for that, use ExecCodeSegment<br />
<br />
UAC_RealWorldExample.nsi does:<br />
<br />
Function CreateShortcuts<br />
CreateShortcut &quot;$Desktop\${APPNAME}.lnk&quot; &quot;$Windir\Notepad.exe&quot;<br />
FunctionEnd<br />
<br />
Section &quot;Desktop Shortcut&quot;<br />
GetFunctionAddress $0 CreateShortcuts<br />
UAC::ExecCodeSegment $0<br />
SectionEnd<br />
<br />
the CreateShortcuts function will execute as the original user (You get no feedback in the install log, hopefully I will implement some kind of DetailPrint that &quot;works the other way&quot;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">fishsauce</div><div class="date">11th May 2007, 08:06</div></div><div class="posttext">So... just to make sure I'm understanding this correctly... basically we encapsulate the stuff we want to do as the original user in a function, then use UAC::ExecCodeSegment on the function address to execute the stuff?<br />
<br />
Sounds pretty simple... thanks a lot!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">11th May 2007, 16:28</div></div><div class="posttext">yes, the only problem is that you get no output in the install log since its actually executing in a hidden installer</div></div><hr />


<div class="post"><div class="posttop"><div class="username">helix400</div><div class="date">11th May 2007, 22:10</div></div><div class="posttext">With Anders permission, I've added more documentation to the plug-in page at: http://nsis.sourceforge.net/UAC_plug-in<br />
<br />
Some of it was based off comments mentioned in this thread.  So if you find yourself saying &quot;Hey, I said that!&quot;, it's because you did.  :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">12th May 2007, 13:37</div></div><div class="posttext">@Anders: I hope you consider my RunAs dialog ideas. Here's another feature request (which is quite obvious):<br />
<br />
Allow communication from outer to inner installer. It would be nice if the ExecCodeSegment could return values. Either by allowing ExecCodeSegment the other way, too (outer calls inner =&gt; return values by a callback). Or by exchanging values internally using some UAC stack (UAC::Push, UAC::Pop, callable by both instances). Or something else.<br />
<br />
The outer installer runs with user privileges, so it is a bit difficult to exchange information using some workaround (registry location). They both use different TMP (pluginsdir). Perhaps there is a possibility via windows API. I think about something like PeekMessage / PostThreadMessage (but those might interfere the GUI event handling...)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">12th May 2007, 16:31</div></div><div class="posttext">Yeah, I have already thought about adding stack support. The problem is, you can't send a message the other way without reducing the security of the admin instance<br />
<br />
As for changes to the run-as dialog, those are way down on the list, you are only supposed to see that dialog if you are non admin with uac off. And I'm not sure if using my dialog is smart on 2k/xp, I don't know how much it changes if the machine has a custom GINA and stuff like that. Maybe I could implement some sort of show function callback and you could do whatever you want to my dialog<br />
<br />
This thing was really just to support starting a process on the finish page, not sure how smart it is to add to much support for other stuff. Duplicating every NSIS api call to provide proper feedback is just too much work. The outer instance never gets past .onInit so there are no DetailPrints i can just &quot;steal&quot; from the listview either and there is no way to hook into the nsis calls as far as i know</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">12th May 2007, 17:28</div></div><div class="posttext">Please make your RunAs dialog at least customizable (language strings). Is this an privileges problem? I guess the RunAs dialog is an outer process thing.<br />
<br />
Regarding security issue (passing values from outer to inner): I think about two ways:<br />
<br />
a) the inner process has admin privileges. We could use this to let the inner process read those values out of the process context / environment /... of the outer one. <br />
<br />
Very simple solution: create a temp file and pass the file to the inner process as CMD. So both processes could use this file. Problem: The privileges of the inner process could be insufficient. The file could be encrypted by EFS and the admin user would not have the key. So file is not good...<br />
<br />
b) is the inner process technically a child process of the outer one? Perhaps there is something in windows which allows limiting the communication to father-child.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">12th May 2007, 17:40</div></div><div class="posttext">http://support.microsoft.com/kb/95900/en<br />
<br />
Perhaps Memory Mapped Files could help:<br />
http://msdn2.microsoft.com/en-us/library/ms810613.aspx<br />
<br />
I know you started UAC only for the Finish-Exec problem. And the current solution is quite nice. The &quot;Passing parameters back&quot; is not as important (for me). Anyway the plugin is great, thanks for your effort.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">12th May 2007, 17:59</div></div><div class="posttext">The biggest problem is not how to pass data back, its what to pass. Even if I added UAC::DetailPrint that works the other way, what strings would you pass back?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">helix400</div><div class="date">12th May 2007, 18:05</div></div><div class="posttext">Originally posted by Anders <br />
Yeah, I have already thought about adding stack support. The problem is, you can't send a message the other way without reducing the security of the admin instance <br />
<br />
I stumbled on a new Vista API function that allows an admin process to register a type of message so that user-level process could send it messages of that type.  Unfortunately, I can't remember the name of it now (my work computer probably has it in the browser history).  <br />
<br />
Also, in XP and 2000, can a user-level process send messages to an admin-level process?  I was under the impression they could.<br />
<br />
I don't know if this is any help for you, just chiming in with a thought.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">12th May 2007, 18:16</div></div><div class="posttext">I don't need UAC::DetailPrint. What I want is doing some processing for current user (not just Exec on finish):<br />
Reading HKCU and writing HKCU, reading files from the user's profile/writing files (SetShellVarContext).<br />
<br />
Doing actions (write) is possible using your UAC::ExecuteCodeSegment. But I cannot read values. I want to read a value (outer process), process it in the main installer (inner process), show it in the GUI, allow user options etc. and then do the action using UAC::ExecuteCodeSegment.<br />
<br />
Reading those values using the inner process is no option because the files / keys could have privilege problems (or EFS encryption). So the original (outer) user account has to be used here.<br />
<br />
At first I just want to pass some bool (yes/no), but in general it would be nice to at least allow int numbers and when possible strings.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">12th May 2007, 20:18</div></div><div class="posttext">* Check wiki for new version with basic language support. (See readme.txt and UAC_RealWorldExample.nsi)<br />
<br />
Yes, on &lt; Vista you can send messages to any window. I know I can use ChangeWindowMessageFilter to allow messages from the outer instance, but that would add possible security issues.<br />
<br />
You can read the HKCU part of the registry from the inner instance unless the permissions on that key has done something to block admins (You would probably never see this in practice) You can probably do something with the access control plugin to make sure the inner instance can read from the outer instance's $pluginsdir.<br />
<br />
I'm not sure if I want to add support for any kind of message passing from outer to inner, but you are free to fork the code ofcourse. The UAC plugin is all about support for all users type installers so why would you read user specific values?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RichZ</div><div class="date">23rd May 2007, 12:03</div></div><div class="posttext">Anders,<br />
<br />
I've been playing around with your plug-in and my installer now works perfectly under a limited Vista account.<br />
<br />
I did however notice a problem with the uninstaller; When I start the uninstaller the Vista elevation dialog pops up as expected, when I enter the correct info and click OK my uninstaller UI however doesn't pop up.<br />
When I check the task manager I do see 2 uninstaller processes running, 1 as a normal user and 1 as an administrator.<br />
<br />
After some investigation I noticed that this problem only occurs when my uninstaller uses the Modern UI. When I do not use the modern UI the uninstaller works as expected. Do you have any idea what's going on?<br />
If you need any more info from me please let me know.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">23rd May 2007, 13:29</div></div><div class="posttext">I noticed a similar issue with Vista (which seems to be a Vista bug) and solved the problem by calling<br />
<br />
ShowWindow $HWNDPARENT &quot;${SW_SHOW}&quot;<br />
<br />
in the show callback function of the first visible GUI page (welcome page).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RichZ</div><div class="date">23rd May 2007, 15:11</div></div><div class="posttext">Originally posted by stb <br />
I noticed a similar issue with Vista (which seems to be a Vista bug) and solved the problem by calling<br />
<br />
ShowWindow $HWNDPARENT &quot;${SW_SHOW}&quot;<br />
<br />
in the show callback function of the first visible GUI page (welcome page). <br />
<br />
Thanks, I have added a custom callback function to the uninstaller as you described and this fixed it. For me the problem only occurs for the uninstaller and not for the installer which to me seems kind of strange (what's the difference between installing and uninstalling for the OS?).<br />
If anybody is interested I have added the following code to my script:<br />
<br />
<br />
!define MUI_CUSTOMFUNCTION_UNGUIINIT un.GUIInit<br />
<br />
Function un.GUIInit<br />
  ShowWindow $HWNDPARENT &quot;${SW_SHOW}&quot;<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">23rd May 2007, 15:19</div></div><div class="posttext">I noticed this in the installer with UAC disabled in Vista when self-executing the installer (copy in TEMP). This inner process (outer is finished because it doesn't wait) did not show any GUI Window (style was invisible). With XP SP2 this window was always visible.<br />
<br />
Thanks for the hint to GUIINIT, I think that location is better.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RichZ</div><div class="date">23rd May 2007, 16:33</div></div><div class="posttext">Originally posted by stb <br />
I noticed this in the installer with UAC disabled in Vista when self-executing the installer (copy in TEMP). This inner process (outer is finished because it doesn't wait) did not show any GUI Window (style was invisible). With XP SP2 this window was always visible.<br />
<br />
Thanks for the hint to GUIINIT, I think that location is better. <br />
<br />
I cannot reproduce what you describe above, what do you mean by &quot;self-executing the installer (copy in TEMP)&quot;?<br />
<br />
Also for Anders I noticed another glitch.<br />
On one of my test machines (actually a VMware machine) I have an administrator account without a password (I know this is unsafe ;)). With UAC disabled I get a nice run as dialog, I am however not able to use my administrator account because of the blank password.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">23rd May 2007, 17:06</div></div><div class="posttext">First off, I am able to reproduce the invisible uninstaller window on XP Pro SP2. Will try to look into this at some point. For now, use the showwindow hack<br />
<br />
Edit: I think i fixed it, please try with the latest version on the wiki<br />
<br />
<br />
RichZ: Could you take a screenshot of the dialog? Do you get a error message?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RichZ</div><div class="date">23rd May 2007, 19:02</div></div><div class="posttext">Originally posted by Anders <br />
First off, I am able to reproduce the invisible uninstaller window on XP Pro SP2. Will try to look into this at some point. For now, use the showwindow hack<br />
<br />
Edit: I think i fixed it, please try with the latest version on the wiki<br />
<br />
<br />
RichZ: Could you take a screenshot of the dialog? Do you get a error message? <br />
<br />
I have attached a screenshot, it states that a possible reason can be because of a blank password, but I have not enforced such a policy.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">23rd May 2007, 19:10</div></div><div class="posttext">I wanted a screenshot of the runas dialog and not the error but it doesnt really matter.<br />
<br />
There is nothing i can do about this, CreateProcessWithLogonW fails with blank passwords by default. You can set limitblankpassworduse=0 in HKLM\SYSTEM\CurrentControlSet\Control\Lsa to override this</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RichZ</div><div class="date">23rd May 2007, 19:14</div></div><div class="posttext">Originally posted by Anders <br />
I wanted a screenshot of the runas dialog and not the error but it doesnt really matter.<br />
<br />
There is nothing i can do about this, CreateProcessWithLogonW fails with blank passwords by default. You can set limitblankpassworduse=0 in HKLM\SYSTEM\CurrentControlSet\Control\Lsa to override this  <br />
<br />
Alright, thanks for the solution, not a big problem because a blank administrator password is not what you want anyway ;) <br />
<br />
I will test your solution for the invisible dialog later on.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">23rd May 2007, 19:20</div></div><div class="posttext">If you turn UAC on, will it elevate even if the admin password is blank?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RichZ</div><div class="date">23rd May 2007, 19:21</div></div><div class="posttext">Anders, I have checked the latest build (v0.0.6b) and the problem with the invisible dialogs is indeed fixed, thanks for the quick response. :up:</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RichZ</div><div class="date">23rd May 2007, 19:22</div></div><div class="posttext">Originally posted by Anders <br />
If you turn UAC on, will it elevate even if the admin password is blank?  <br />
<br />
Yes with UAC on there is no problem, it will elevate with an empty admin password.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">helix400</div><div class="date">23rd May 2007, 20:29</div></div><div class="posttext">Oh good, the UAC plugin is still improving.  :)<br />
<br />
Just to let you know Anders, we've deployed an installer containing it to several hundreds people so far.  There haven't been any issues found by anyone yet.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">introspect</div><div class="date">17th July 2007, 19:53</div></div><div class="posttext">I am sure I am just being stupid here but I can't get the uac plugin source to compile (found here:  http://nsis.sourceforge.net/UAC_plug-in)<br />
<br />
TokenOrigin is not defined.  Where is TokenOrigin defined?  <br />
<br />
Anyways TokenOrigin is being used in the UAC.h header file in this enum definition:<br />
enum _TOKEN_INFORMATION_CLASS___VISTA {<br />
	TokenElevationType = (TokenOrigin+1),<br />
	TokenLinkedToken,<br />
	TokenElevation,<br />
	TokenHasRestrictions,<br />
	TokenAccessInformation,<br />
	TokenVirtualizationAllowed,<br />
	TokenVirtualizationEnabled,<br />
	TokenIntegrityLevel,<br />
	TokenUIAccess,<br />
	TokenMandatoryPolicy,<br />
	TokenLogonSid,<br />
};<br />
<br />
Thanks in advance for any help you can provide, and my apologies if this is the wrong place to post this.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">17th July 2007, 21:36</div></div><div class="posttext">in WinNT.h (You need a somewhat recent Platform sdk, mine is from 2003)<br />
<br />
_TOKEN_INFORMATION_CLASS___VISTA is my fake enum since I don't have the latest Platform SDK installed</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RobertStrong</div><div class="date">3rd October 2007, 01:08</div></div><div class="posttext">Anders, would you consider adding a method that created a process using CreateProcessWithTokenW using the desktop's token? This would allow an uninstaller to create a process that isn't elevated. I can provide the code to accomplish this and it seems that this would be a good plugin to add this to vs. creating a plugin that just did this.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">3rd October 2007, 02:16</div></div><div class="posttext">Yeah, I would consider it (Depending on how you get this token, remember, the user could use a shell that is not explorer.exe etc.)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RobertStrong</div><div class="date">3rd October 2007, 05:42</div></div><div class="posttext">Something like this?<br />
<br />
extern &quot;C&quot;<br />
void __declspec(dllexport) LaunchWithTopMostWinToken(HWND hWndParent, int string_size, <br />
                                                     char *variables, stack_t **stacktop,<br />
                                                     extra_parameters *extra)<br />
{<br />
  EXDLL_INIT();<br />
  {<br />
    char szCmdLine[MAX_PATH];<br />
<br />
    if (popstring(szCmdLine) == 0)<br />
    {<br />
      if (!pCreateProcessWithTokenW)<br />
      {<br />
        // CreateProcessWithTokenW is not present on WinXP or earlier<br />
        *(FARPROC *)&amp;pCreateProcessWithTokenW =<br />
            GetProcAddress(GetModuleHandle(&quot;advapi32.dll&quot;),<br />
                           &quot;CreateProcessWithTokenW&quot;);<br />
        if (!pCreateProcessWithTokenW)<br />
        {<br />
          pushstring(OUT_ERR);<br />
          return;<br />
        }<br />
      }<br />
      // use the token from the topmost window (highest in the z-order) to drop the privilege<br />
      HWND hwndTopMostWin = GetWindow(hWndParent, GW_HWNDFIRST);<br />
<br />
      DWORD dwProcessId;<br />
      GetWindowThreadProcessId(hwndTopMostWin, &amp;dwProcessId);<br />
<br />
      HANDLE hProcessTopMostWin = OpenProcess(MAXIMUM_ALLOWED, FALSE, dwProcessId);<br />
      if (!hProcessTopMostWin)<br />
      {<br />
        pushstring(OUT_ERR);<br />
        return;<br />
      }<br />
<br />
      HANDLE hTokenTopMostWin;<br />
      BOOL ok = OpenProcessToken(hProcessTopMostWin, MAXIMUM_ALLOWED, &amp;hTokenTopMostWin);<br />
      CloseHandle(hProcessTopMostWin);<br />
      if (!ok) <br />
      {<br />
        pushstring(OUT_ERR);<br />
        return;<br />
      }<br />
<br />
      HANDLE hNewToken;<br />
      ok = DuplicateTokenEx(hTokenTopMostWin,<br />
                            MAXIMUM_ALLOWED,<br />
                            NULL,<br />
                            SecurityDelegation,<br />
                            TokenPrimary,<br />
                            &amp;hNewToken);<br />
      CloseHandle(hTokenTopMostWin);<br />
      if (!ok)<br />
      {<br />
        pushstring(OUT_ERR);<br />
        return;<br />
      }<br />
<br />
      STARTUPINFOW si = {sizeof(si), 0};<br />
      PROCESS_INFORMATION pi = {0};<br />
<br />
      WCHAR wszCmdLine[MAX_PATH * 2];<br />
      MultiByteToWideChar(CP_ACP, 0, szCmdLine, lstrlen(szCmdLine) + 1,<br />
                          wszCmdLine, sizeof(wszCmdLine) / sizeof(wszCmdLine[0]));<br />
<br />
      if (wszCmdLine)<br />
      {<br />
        ok = pCreateProcessWithTokenW(hNewToken,<br />
                                      0,    // profile is already loaded<br />
                                      NULL,<br />
                                      wszCmdLine,<br />
                                      0,    // No special process creation flags<br />
                                      NULL, // inherit my environment<br />
                                      NULL, // use my current directory<br />
                                      &amp;si,<br />
                                      &amp;pi);<br />
      }<br />
      CloseHandle(hNewToken);<br />
      if (ok)<br />
      {<br />
        pushstring(OUT_SUCCESS);<br />
        CloseHandle(pi.hProcess);<br />
        CloseHandle(pi.hThread);<br />
        return;<br />
      }<br />
<br />
    }<br />
    pushstring(OUT_ERR);<br />
  }<br />
}</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RobertStrong</div><div class="date">3rd October 2007, 06:09</div></div><div class="posttext">Forgot pCreateProcessWithTokenW<br />
<br />
BOOL (WINAPI *pCreateProcessWithTokenW)(HANDLE,<br />
                                        DWORD,<br />
                                        LPCWSTR,<br />
                                        LPWSTR,<br />
                                        DWORD,<br />
                                        LPVOID,<br />
                                        LPCWSTR,<br />
                                        LPSTARTUPINFOW,<br />
                                        LPPROCESS_INFORMATION);</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">3rd October 2007, 12:25</div></div><div class="posttext">I'm sorry, but that is horrible, you just use some random window token. Can you get the token for GetDesktopWindow() or is that restricted somehow?<br />
<br />
What about Win2000/XP ?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RobertStrong</div><div class="date">3rd October 2007, 13:48</div></div><div class="posttext">GetDesktopWindow didn't work and I didn't spend any time trying to figure out what was up with this. I'll look into what's going on.<br />
<br />
Regarding Win2K/XP the comment:<br />
// CreateProcessWithTokenW is not present on WinXP or earlier<br />
so it returns an error allowing fallback to Exec, ExecShell, etc.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">3rd October 2007, 14:25</div></div><div class="posttext">You can't fall back to Exec/ExecShell, you have the same problem on 2k/XP if you use runas</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RobertStrong</div><div class="date">3rd October 2007, 15:02</div></div><div class="posttext">I understand a solution for the runas on systems without UAC or UAC is turned off would be a wonderful thing but that is highly unlikely from what I have read of other people's struggles with this (e.g. using task scheduler... I mean damn!). ;)<br />
<br />
On the other hand being able to launch an app at the end of uninstall (e.g. option to open a web page) which is typically not elevated through runas (e.g. ARP or Programs and Features) though on Vista with UAC turned on is elevated would be a good thing. If a 100% solution were possible I'd certainly go for it but without that I am willing to settle for good vs. perfect since perfect isn't an option from what I have read on this scenario.<br />
<br />
I'll probably just provide the option when the progman window is available to avoid using a random window and throw together a simple plugin to provide this when the target is Vista with UAC turned on.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">3rd October 2007, 16:41</div></div><div class="posttext">ExecShell should open a http:// style URL without elevation no?<br />
<br />
There is another problem, ARP is disabled untill all subprocesses finish, I created a hacky workaround for that @http://nsis.sourceforge.net/Escape_ARP_Job_With_New_Process (Not tested on vista)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">RobertStrong</div><div class="date">3rd October 2007, 17:47</div></div><div class="posttext">No, it regretfully inherits from the process that calls ShellExecute.<br />
<br />
Thanks for the pointer on the workaround using JOB_OBJECT_LIMIT_BREAKAWAY_OK. That has been an annoyance for a long time.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">M-Force</div><div class="date">18th October 2007, 17:57</div></div><div class="posttext">Hi,<br />
<br />
i have a problem with the UAC-plugin on vista.<br />
<br />
After i clicked the button on my web page to download my installer, vista is poping up first a &quot;File Download - Security Warning&quot; with information about Name, Type and From. I think this i normal behavior.<br />
<br />
After i confirm with clicking the &quot;Run&quot; button another security warning is poping up. This &quot;Internet Explorer - Security warning&quot; is asking if the software of a certain Name and Publisher is allowed to run. I think this is normal as well.<br />
After i confirm &quot;Run&quot; i get a third security popup &quot;Open File - Security Warning&quot; which is asking if i want to run a file which is described with Name, Publisher, Type and where from. This file has the same name as my Installer except the installer name got a number  suffix like Installer[2].exe and moreover it is stored under &quot;c:\user\&lt;account&gt;\AppData\Microsoft\Wind...&quot;. Thats all what i can read from that path.<br />
After i confirm the third installer and click on &quot;Run&quot; finally my installer window is coming up.<br />
<br />
I dont think the third security warning should come up. It would only confuse the user.<br />
Can you confirm such behavior? Is that normal?<br />
<br />
Thank you for your help.<br />
<br />
M.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">18th October 2007, 20:04</div></div><div class="posttext">This is probably not related to the UAC plugin<br />
<br />
See http://forums.winamp.com/showthread.php?s=&amp;threadid=278784</div></div><hr />


<div class="post"><div class="posttop"><div class="username">M-Force</div><div class="date">18th October 2007, 21:02</div></div><div class="posttext">Hi Anders,<br />
<br />
before I included the UAC plugin in my script i only got the popup windows &quot;File Download - Security Warning&quot; for allowing to download and the &quot;User Account Control&quot; for running the installer. The disadvatage was that the installer window was not in focus after I confirmed the &quot;User Account Control&quot; window.<br />
<br />
So by using the UAC-plugin my installer window is now in focus when it got started, but i have all the security warnings inbetween. ( &quot;Internet Explorer - Security warning&quot; and &quot;Open File - Security Warning&quot;). Havent had these security warnings without the UAC.<br />
<br />
Therefore i was assuming the UAC raises such warnings.<br />
<br />
M.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">18th October 2007, 23:54</div></div><div class="posttext">The UAC plugin will start the SAME exe one more time, so you might get another IE warning dialog, I don't know. Make sure you are have &quot;RequestExecutionLevel user&quot; in your script. If you can post a minimal sample script with this problem I might be able to look into it and see if I can come up with a fix</div></div><hr />


<div class="post"><div class="posttop"><div class="username">M-Force</div><div class="date">19th October 2007, 19:08</div></div><div class="posttext">Hi Anders,<br />
<br />
I attached a simple script which is utilizing the UAC plug-in.<br />
I signed the created installer before tested it.<br />
<br />
The described problem with the multiple security warnings is not happening on Vista when you execute the installer direct from the hard drive.<br />
<br />
It only happens on Vista when you run the installer out of a web page what means it gets downloaded and executed by IE7 and JavaScript without saving it to the hard drive.<br />
<br />
I hope this will help you to figure out the problem.<br />
<br />
<br />
Thank you very much for your help<br />
<br />
M.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">19th October 2007, 20:20</div></div><div class="posttext">It still gets executed from the hard drive, just in the temporary internet files folder. I guess thats why you get the &quot;c:\user\&lt;account&gt;\AppData\Microsoft\Wind...&quot; path in the dialog, and the name installer[2].exe would indicate that this is the 2nd time you &quot;ran it from a website&quot;. I'm not sure how any of this is related to UAC, other than the fact that you might get one extra warning from IE. It might be possible to check if $exedir is the temporary internet files folder and to copy your installer to $temp and then execute that.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">M-Force</div><div class="date">22nd October 2007, 21:23</div></div><div class="posttext">Hi Anders,<br />
<br />
I really think that the UAC-plugin makes it different in matter of security warnings.<br />
<br />
For example if I run my simple test installer out of a web page without UAC-plugin i get the warnings:<br />
- &quot;File Download - Security Warning&quot; download/run permission<br />
- &quot;User Account Control&quot; elevate process<br />
<br />
With UAC-plugin and basically the same test installer i get:<br />
- &quot;File Download - Security Warning&quot; download/run permission<br />
- &quot;Internet Explorer - Security warning&quot; run inst. as user<br />
- &quot;Open File - Security Warning&quot; run installer as admin<br />
- &quot;User Account Control&quot; elevate process<br />
<br />
There must be a way that you can use the UAC-plugin with only the 2 security warnings as stated above. <br />
Otherwise it could easily scare users away with so many warnings.<br />
<br />
M.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">22nd October 2007, 22:19</div></div><div class="posttext">nope, I don't think there is anything I can do. If you copy your installer out of temporary internet files and into $temp AND remove the &quot;mark of the internet&quot; (NTFS stream) you might be able to get rid of two warnings (you must do this before calling the uac plugin in .OnInit). Signing your installer might also help. This is a IE only issue that I don't really care about to be honest (you could also wrap your real installer inside a smaller one that just extracts the real thing to $pluginsdir/$temp and executes it)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">unroar</div><div class="date">7th November 2007, 04:40</div></div><div class="posttext">When using the plugin the UAC dialog comes up minimized.  This is bad because the user might miss it, even though it is flashing in the task bar.  Once I click on the UAC icon I get the normal modal dialog with the desktop darkened.<br />
<br />
Is this normal or am I doing something wrong?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">7th November 2007, 12:14</div></div><div class="posttext">unroar: which version of the UAC plugin are you using?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">unroar</div><div class="date">8th November 2007, 00:12</div></div><div class="posttext">The comment in uac.cpp say it's version v0.0.6c - 20071014. I got the download from the wiki link.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">8th November 2007, 13:05</div></div><div class="posttext">When you say minimized, are you sure its not just BEHIND other open windows? If you drop by the NSIS IRC channel I might be able to provide you with some test builds</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">9th November 2007, 19:27</div></div><div class="posttext">Latest version on the wiki should now fix the behind and/or minimized bugs (Hopefully) It also contains some other fixes, everyone should test the new build (It will probably be the last, the UAC plugin really needs a fresh start, I'm not sure when I'm up for doing that, if ever, you can still report bugs ofcourse and I will try to fix 'em)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">selectoe</div><div class="date">25th March 2008, 02:22</div></div><div class="posttext">hi i am a complete novice and need to use this plugin. where do i start? i have downloaded the zip file and extracted it, thats as far as i can get haha.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">25th March 2008, 03:35</div></div><div class="posttext">I guess you are better off not using it at all then if thats as far as you got on your own. You are probably better off using:<br />
<br />
RequestExecutionLevel admin<br />
SetShellVarContext all <br />
and don't use the run checkbox on the finish page<br />
If you need be admin on other NT versions aswell, you can use the UserInfo plugin that ships with NSIS to check in one of the init functions</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jcollake</div><div class="date">27th March 2009, 20:48</div></div><div class="posttext">Nice work on the UAC plug-in Anders ;). I have been using it for several months, allowing me to perform a post-install launch without propagating the high privileges of the installer to the child process.<br />
<br />
Unfortunately, I have encountered a problem with the UNICODE build (built here /w VS2008). I am using it in conjunction with the UNICODE build of NSIS. I do not know which is at fault, but I suspect first the UAC plug-in.<br />
<br />
I am getting a general failure in Windows x64 (unable to elevate). It appears to work in x32, though I have did have one user report of a failure to elevate for the x32 build -- leaving me unconfident.<br />
<br />
I intend to so some debugging soon, but I figured I would ask here to see if anyone else has seen this, or if anyone is using this combination successfully for installations in Windows Vista+ x64.<br />
<br />
Thanks!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jcollake</div><div class="date">28th March 2009, 21:56</div></div><div class="posttext">Nevermind all.. My build of the UAC plug-in was bad. VS2008 had pulled in the CRT due to buffer security checks being enabled, and I had accidentally linked to the DLL version of it. This therefore caused a UAC.DLL load error on systems where the CRT DLLs weren't installed. Duh! Problem solved. I should have looked closer before posting here.<br />
<br />
After removing the CRT dependency, all was well. My unicode build of the UAC plug-in ended up being 19KB, only 2KB larger than the official multi-byte distribution of it.<br />
<br />
I can say now that the UAC plug-in definitely works great with the unicode build of NSIS ;).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">29th March 2009, 00:05</div></div><div class="posttext">when the next official release comes out (who know when that will be) it will ship with both versions so you don't have to recompile if you are not changing the source</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jcollake</div><div class="date">29th March 2009, 14:36</div></div><div class="posttext">Originally posted by Anders <br />
when the next official release comes out (who know when that will be) it will ship with both versions so you don't have to recompile if you are not changing the source  <br />
<br />
Thanks Anders, I'm sure that will be helpful to many people -- and probably reduce the number of support requests you are bothered with, lol ;).<br />
<br />
I attached a unicode build of Ander's UAC plugin to this post, in case it is helpful to anyone in the interim. This is version 0.0.11c.<br />
<br />
I really appreciate your work on this plugin. Without it, I would have had to quit using NSIS.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Paul_B</div><div class="date">20th July 2009, 17:46</div></div><div class="posttext">Anders<br />
<br />
Congratulations on the work you have done on the UAC plugin.<br />
<br />
One strange problem I have encountered is as follows:<br />
Windows 7 RC 1<br />
A non-admin user<br />
The install elevates and installs successfully using an admin user as the inner process. If I uninstall via Start Programs it elevates and works correctly. The paths are correctly identified via UAC as the outer user. However if I uninstall via the Control Panel (same nsi code and uninstall.exe) it elevates, but the install fails as the paths for the Data directory, the desktop icon and start menus are the inner (elevated admin) process and not the (outer) user.<br />
<br />
If I run on XP both uninstall routes (Start menu and Control panel) elevate and work successfuly for a non-admin user.<br />
<br />
I have worked on the problem for some time, but no luck.<br />
Any help would be much appreciated.<br />
<br />
It may well be a Windows 7 problem - I am about to submit as a problem to Microsoft. Any thoughts?<br />
<br />
Paul</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">20th July 2009, 18:14</div></div><div class="posttext">Vista and 7 will force the elevation for you IIRC (I'm sure this only happens when you put the uninstall info in HKLM)<br />
<br />
You should stop creating stuff as the user and do a pure all users install (HKLM &amp; SetShellVarContext all) if you don't want to deal with problems like this (Using the UAC plugin to launch a program during install is fine, anything else means your installer is broken and you will have issues like this)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Paul_B</div><div class="date">21st July 2009, 09:16</div></div><div class="posttext">Anders, you seem to be saying that NSIS + UAC plugin is broken if you try a user install. Do you really mean this, as it seem to me that the inconsistent behaviour on Windows 7 (uninstall.exe works via the start menu shortcuts, but fails through the Control Panel)is more likley a Windows bug? It's as though the windows 'executation context' of uninstall.exe, when launched via the Control Panel is different from that when done via the start menu. (I don't have a Vista system handy, so have not yet tried this on Vista.)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">21st July 2009, 11:31</div></div><div class="posttext">Well, it depends on what you mean by user install (In a real single user install, you would not call into the UAC plugin to perform operations since you are already running as the correct user and you will only write to HKCU and the users profile, not in HKLM or $programfiles)<br />
<br />
I would not call this problem a windows bug even tho starting from a shortcut is not the same as starting from the control panel, since, if the uninstall info is in HKLM, you did a &quot;all users&quot; install and you will require admin rights to uninstall so windows just &quot;helps you along&quot;<br />
<br />
So, if you run into this problem, it probably means you did a &quot;mixed install&quot; and this has never been correct (I know the UAC plugin really helps you do this, but it was not the original intent of the plugin, its only &quot;supported&quot; function is to run programs during install, not to create files or do any special action at all during uninstall)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Paul_B</div><div class="date">21st July 2009, 17:23</div></div><div class="posttext">Anders - thanks for such quick replies.<br />
I take your point about the mixed install, which is not a good idea and I think I am guilty of doing this inadvertently. Also, the subtlety that the uninstall.exe was created with the correct paths (during the elevated install) had escaped me. <br />
Thanks again, Paul</div></div><hr />


<div class="post"><div class="posttop"><div class="username">june1212</div><div class="date">7th October 2009, 17:24</div></div><div class="posttext">Hi, I am using the UAC plug-in, it works well for me. Just I have a requirement to suppress UAC if it is on, in order to let the installation process pure automatically, without any user interfere. Is it possiable through this UAC plug-in? If not, what should I do?<br />
<br />
Thanks</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">7th October 2009, 17:41</div></div><div class="posttext">june1212, please don't post the same question twice, it causes fragmentation of the answers.<br />
<br />
--&gt; Answered in http://forums.winamp.com/showthread.php?s=&amp;threadid=313496</div></div><hr />


<div class="post"><div class="posttop"><div class="username">klopfdreh</div><div class="date">10th May 2011, 07:31</div></div><div class="posttext">Hello over there,<br />
<br />
I've a question regarding the UAC plugin and creating a Mutex to find out if the installation program is already running. <br />
<br />
As far as I noticed the program is going to be run twice - in normal mode and in admin mode, if you confirm it. So if I create a mutex in onInit, it will be executed twice and then fail.<br />
<br />
How do I prevent this?<br />
<br />
Thank you for your great plugin!<br />
<br />
The topic I posted my question first is: <br />
<br />
Thread: CreateMutex Help Topic - Post #32 (http://forums.winamp.com/showthread.php?p=2770852#post2770852)<br />
Post: Post #32 - Single Post View (http://forums.winamp.com/showthread.php?p=2770852#post2770852)<br />
<br />
Edit: Ok - I've a solution for my problem! Because we are going to check if there is an update required first before we execute the uac dialog I had to wrap it into those checks. And I create the mutex only if we have admin rights and the application can be installed. (see attachment)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">trumpetinc</div><div class="date">7th November 2011, 19:54</div></div><div class="posttext">I'm going nuts with the lack of documentation, and I can't find source code anywhere.  Would it be possible to get a zip with the source uploaded to the wiki?  http://nsis.sourceforge.net/UAC_plug-in<br />
<br />
I'd be more than happy to add some documentation if I can get the source.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">ivansobaka</div><div class="date">5th December 2011, 21:22</div></div><div class="posttext">I have a question about using UAC plug-in.<br />
<br />
I try to run setup from the non admin user and get &quot;Run as&quot; dialog box.<br />
Then I fill 'user' field and 'password' field leave empty.<br />
Then I get error something like &quot;empty passwords are not allowed&quot;.<br />
<br />
What could I do?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">6th December 2011, 00:54</div></div><div class="posttext">I have a question about using UAC plug-in.<br />
<br />
I try to run setup from the non admin user and get &quot;Run as&quot; dialog box.<br />
Then I fill 'user' field and 'password' field leave empty.<br />
Then I get error something like &quot;empty passwords are not allowed&quot;.<br />
<br />
What could I do?<br />
<br />
This is a windows policy, probably Limit local account use of blank passwords to console logon only: http://technet.microsoft.com/en-us/library/cc737553%28WS.10%29.aspx</div></div><hr />


<div class="post"><div class="posttop"><div class="username">klopfdreh</div><div class="date">22nd December 2011, 13:49</div></div><div class="posttext">Hello everyone,<br />
<br />
thanks a lot for the great plugin! But I have troubles with UAC_AsUser_ExecShell / ExecShell - I want to execute an application as user but with administrative rights, because the launched application is storing some information in %APPDATA%. <br />
<br />
- If I use ExecShell the information are stored in the administrators %APPDATA%<br />
<br />
- If I user UAC_AsUser_ExecShell the information are stored in the users %APPDATA% BUT the application is not running in admin mode, so I can't changes files within my launched application.<br />
<br />
Is there a way to run the application in admin mode but using the users scope variables?<br />
<br />
Thank you very much!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">22nd December 2011, 16:16</div></div><div class="posttext">I want to execute an application as user but with administrative rights, because the launched application is storing some information in %APPDATA%.<br />
This is not possible. Either it's running as admin, or it's running as user. It can never be both at the same time. <br />
<br />
However, there is an easy solution to your problem: Use the UAC plugin to call a function as user (and make sure to use SYNCREGISTERS), and in that function copy the value of $APPDATA to a register:<br />
<br />
Function SyncAppdata<br />
setshellvarcontext current<br />
StrCpy $0 $APPDATA<br />
FunctionEnd<br />
 <br />
This way, you'll have the user's appdata path stored in $0, in the inner (admin) instance of your installer. Then, you can simply supply that user-appdata path as a commandline parameter to your application.<br />
<br />
<br />
Edit: Here's two macros I created to do something similar, namely synching the contents of a variable, and synching the flags of sections, from outer to inner:  http://pastebin.com/eM9MDUYL  (Note that you shouldn't sync the $APPDATA variable using that syncvariable macro, because then the admin's $appdata will point to the wrong path. But you can modify it to suit your needs.)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">klopfdreh</div><div class="date">23rd December 2011, 08:38</div></div><div class="posttext">Thanks a lot - Im going to evaluate that solution, soon.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>