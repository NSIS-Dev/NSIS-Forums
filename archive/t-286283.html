<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" ExecToLog and MUI_INSTALLOPTIONS_READ, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  ExecToLog and MUI_INSTALLOPTIONS_READ NSIS Discussion" />
	
	<title> ExecToLog and MUI_INSTALLOPTIONS_READ [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  ExecToLog and MUI_INSTALLOPTIONS_READ</div>
<hr />
<div class="pda"><a href="t-286283.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=286283">ExecToLog and MUI_INSTALLOPTIONS_READ</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Leanid</div><div class="date">4th February 2008, 18:56</div></div><div class="posttext">I have problem with using these two directives together.<br />
<br />
for example code like this:<br />
Var MY_DB_VALUE <br />
<br />
!insertmacro MUI_INSTALLOPTIONS_READ $MY_DB_VALUE &quot;cleandir.ini&quot; &quot;Field 10&quot; &quot;State&quot;<br />
MessageBox MB_OK &quot;DBRUN1: $MY_DB_VALUE&quot;<br />
<br />
ReadEnvStr $R0 COMSPEC<br />
nsExec::ExecToLog '&quot;$R0&quot; /C &quot;$INSTDIR\dbpromo\dbauto\dbauto.exe&quot;'<br />
<br />
!insertmacro MUI_INSTALLOPTIONS_READ $MY_DB_VALUE &quot;cleandir.ini&quot; &quot;Field 10&quot; &quot;State&quot;<br />
MessageBox MB_OK &quot;DBRUN2: $MY_DB_VALUE&quot;<br />
<br />
<br />
When I execute first block works and I get message:<br />
DBRUN1: 1<br />
Then ExecToLog executed, but after ExecToLog all calls to MUI_INSTALLOPTIONS_READ macro do not return values, so I always got message:<br />
DBRUN2:<br />
<br />
If I comment out ExecToLog second call to MUI_INSTALLOPTIONS_READ starting to work and I get message DBRUN2: 1<br />
<br />
what am I missing? Should I do some POP, PUSH around ExecToLog or something?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">4th February 2008, 19:30</div></div><div class="posttext">Any chance your application clears the temporary folder?<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Leanid</div><div class="date">4th February 2008, 20:47</div></div><div class="posttext">I found problem. That was very deep and only appeared in Silent mode installation.<br />
<br />
In short I dynamically generate .ini file by calling WriteIni function in Custom dialog. But Custom dialog does not get called in silent mode, so I detect silent mode and call WriteIni in .onInit. <br />
<br />
Problem here that I missed call to:<br />
!insertmacro MUI_INSTALLOPTIONS_EXTRACT &quot;my.ini&quot;<br />
in my SilentInstall function.<br />
<br />
Now the weird part. If I don't have this call in my silent mode WriteInit function in silent mode create my.ini in root C:\. And it works. But as soon as I call ExecToLog in creates temporary directory to put nsExec.dll. From that moment MUI_INSTALLOPTIONS_READ stops reading from C:\my.ini but trying to find it in Temp/nscxxx/my.ini<br />
<br />
I think MUI_INSTALLOPTIONS_READ first look if temporary ditrectory has been created if not it looks for ini file in ROOT, but if in the middle some other function created temporary directory MUI_INSTALLOPTIONS_READ starting to look there and failing to find .ini file.<br />
<br />
Calling !insertmacro MUI_INSTALLOPTIONS_EXTRACT &quot;my.ini&quot; guaranteed creating of temporary directory and it all works fine.<br />
<br />
there is part of my .nsi file:<br />
<br />
Var MY_DB_VALUE <br />
<br />
!insertmacro MUI_PAGE_COMPONENTS<br />
!insertmacro MUI_PAGE_DIRECTORY<br />
Page custom CleanDirPage<br />
!insertmacro MUI_PAGE_INSTFILES<br />
<br />
Function .onInit<br />
<br />
  call SilentInstall<br />
FunctionEnd<br />
<br />
Function SilentInstall<br />
;run only for silent mode<br />
<br />
IfSilent 0 end<br />
;if I uncoment next line it all starting to work<br />
;!insertmacro MUI_INSTALLOPTIONS_EXTRACT &quot;my.ini&quot;<br />
call WriteIni<br />
end:<br />
FunctionEnd<br />
<br />
Section &quot;Test ExecToLog&quot;<br />
  <br />
  SetOutPath $INSTDIR\dev<br />
  File  TestExecToLog.nsi<br />
<br />
   !insertmacro MUI_INSTALLOPTIONS_READ $MY_DB_VALUE &quot;my.ini&quot; &quot;Field 1&quot; &quot;State&quot;<br />
   MessageBox MB_OK &quot;DBRUN1: $MY_DB_VALUE&quot;<br />
<br />
   ReadEnvStr $R0 COMSPEC<br />
   nsExec::ExecToLog '&quot;$R0&quot; /C &quot;dir&quot;'<br />
<br />
   !insertmacro MUI_INSTALLOPTIONS_READ $MY_DB_VALUE &quot;my.ini&quot; &quot;Field 1&quot; &quot;State&quot;<br />
   MessageBox MB_OK &quot;DBRUN2: $MY_DB_VALUE&quot;<br />
SectionEnd<br />
<br />
Function CleanDirPage<br />
  !insertmacro MUI_INSTALLOPTIONS_EXTRACT &quot;my.ini&quot;<br />
  call WriteIni<br />
<br />
  !insertmacro MUI_HEADER_TEXT &quot;Installation of $MY_INST_TYPE environment configuration&quot; &quot;Select installation and deployment options&quot;<br />
  !insertmacro MUI_INSTALLOPTIONS_DISPLAY &quot;my.ini&quot;<br />
<br />
FunctionEnd<br />
<br />
function WriteIni<br />
!insertmacro MUI_INSTALLOPTIONS_WRITE   'my.ini' 'Settings' 'NumFields' '1'<br />
!insertmacro MUI_INSTALLOPTIONS_WRITE   'my.ini' 'Field 1' 'Type' 'Checkbox'<br />
!insertmacro MUI_INSTALLOPTIONS_WRITE   'my.ini' 'Field 1' 'Left' '10'<br />
!insertmacro MUI_INSTALLOPTIONS_WRITE   'my.ini' 'Field 1' 'Top' '125'<br />
!insertmacro MUI_INSTALLOPTIONS_WRITE   'my.ini' 'Field 1' 'Right' '-40'<br />
!insertmacro MUI_INSTALLOPTIONS_WRITE   'my.ini' 'Field 1' 'Bottom' '135'<br />
!insertmacro MUI_INSTALLOPTIONS_WRITE   'my.ini' 'Field 1' 'Text' 'Run DB promotion'<br />
!insertmacro MUI_INSTALLOPTIONS_WRITE   'my.ini' 'Field 1' 'State' 1<br />
FunctionEnd</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>