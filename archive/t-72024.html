<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Hkey_current_user, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Hkey_current_user NSIS Discussion" />
	
	<title> Hkey_current_user [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Hkey_current_user</div>
<hr />
<div class="pda"><a href="t-72024.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=72024">Hkey_current_user</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">IGx89</div><div class="date">15th January 2002, 16:00</div></div><div class="posttext">In my app, I store registry values in HKEY_CURRENT_USER. When I uninstall my app, how do I make sure to delete all those values? If the user uninstalls under a different username than he ran the app, then some registry values would be left behind. Putting values in HKEY_CURRENT_USER is common enough, so NSIS must have some easy way to delete them :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">F. Heidenreich</div><div class="date">15th January 2002, 23:29</div></div><div class="posttext">I think HKCU is intended to be for the current user and as far as I know the current user do not have any access to the registry tree of the others (maybe by HKU but I don't know how).<br />
To give all users the opportunity to uninstall your app properly you could write your registry settings to HKLM like NSIS does it.<br />
<br />
~ Florian</div></div><hr />


<div class="post"><div class="posttop"><div class="username">IGx89</div><div class="date">16th January 2002, 00:32</div></div><div class="posttext">Using HKCU makes things easier for me :)<br />
<br />
Here's how I fixed it:<br />
<br />
I just put the following in my app's (WulframPoller) Uninstall section:<br />
<br />
  IntOp $0 0 + 0<br />
EnumStart:<br />
  EnumRegKey $R1 HKEY_USERS &quot;&quot; $0<br />
  IntOp $0 $0 + 1<br />
  StrCmp $R1 &quot;.DEFAULT&quot; EnumStart<br />
  StrCmp $R1 &quot;&quot; EnumEnd<br />
  DeleteRegValue HKU &quot;$R1\Software\Microsoft\Windows\CurrentVersion\Run&quot; &quot;WulframPoller&quot;<br />
  DeleteRegKey HKU &quot;$R1\Software\Wulfram Poller&quot;<br />
  Goto EnumStart<br />
EnumEnd:<br />
<br />
Probably could be done in a more efficient way, but it gets the job done :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">16th January 2002, 14:26</div></div><div class="posttext">I don't know of any way to delete for every CU there is... What I have done in my app was to create an uninsatller for every user.<br />
<br />
This code is located in my user installer. It causes two uninsallers to display in the Add/Remove control panel, one of the program it self, and one for the user's settings.<br />
<br />
WriteRegStr HKCU &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\BlazeRunSettings&quot; &quot;DisplayName&quot; &quot;BlazeRun Current User Settings&quot;<br />
WriteRegStr HKCU &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\BlazeRunSettings&quot; &quot;DisplayIcon&quot; &quot;$1\BlazeRun.exe&quot;<br />
WriteRegStr HKCU &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\BlazeRunSettings&quot; &quot;UninstallString&quot; '&quot;$1\UserUninstall.exe&quot;'<br />
<br />
KiCHiK</div></div><hr />


<div class="post"><div class="posttop"><div class="username">IGx89</div><div class="date">16th January 2002, 15:33</div></div><div class="posttext">The way I did *should* delete for every user, if I'm understanding the Registry correctly :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">16th January 2002, 17:51</div></div><div class="posttext">I must say your way is much better than mine!<br />
Good work. :up:<br />
<br />
Live and learn ;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">0mar</div><div class="date">6th February 2002, 03:38</div></div><div class="posttext">Thanks for the info. IGx89 - this is a very useful registry tip/scriptlet. :D<br />
<br />
I never would have guessed this would work since when I fire up my registry editor I only see data for the current user in HKEY_USERS...<br />
<br />
Just to clarify though: even though I can't see the data (via regedit) for the other profiles, I can still delete it? And it'll work in 9x and NT? (I'll test it out when I can, but external affirmation is soooo comforting ;))</div></div><hr />


<div class="post"><div class="posttop"><div class="username">IGx89</div><div class="date">6th February 2002, 16:36</div></div><div class="posttext">HKEY_CURRENT_USER (HKCU) is only the info for the current user. HKEY_USERS has a list of username keys, under which is the contents of HKCU. Basically, HKCU is a quick, no-hassle shortcut to the current user's info under HKEY_USERS. Hope I'm clear enough :)<br />
<br />
As for working under W9x/NT, it's worked fine for me under W98. I tested NT4, and it seemed to work fine, though I didn't test it too much. It *should* work just fine, since it seems to use HKCU and HKU the same way as W98.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">0mar</div><div class="date">6th February 2002, 16:44</div></div><div class="posttext">Thanks for the info. - I thought HKCU was kind of a shortcut/minor of info. for the current user that's stored elsewhere in the registry. I think a fair bit of the registry keys are linked/mirrored in that fashion.<br />
<br />
Glad to hear it works on 98 and NT4 - I can't wait to wrap up upgrading to 1.95 myself and begin testing my installer. :)<br />
<br />
Ahh, the soothing tedium of repetitive installation testing... ;)<br />
<br />
Thanks again IGx89. :D</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">15th March 2003, 10:51</div></div><div class="posttext">I am not sure about Windows 9x but on NT HKEY_USERS only holds the logged on users and the default user.<br />
<br />
HKEY_USERS - Registry entries subordinate to this key define the default user configuration for new users on the local computer and the user configuration for the current user.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">IGx89</div><div class="date">15th March 2003, 13:45</div></div><div class="posttext">It took you that long to reply? :eek:<br />
;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">15th March 2003, 13:47</div></div><div class="posttext">Someone refered to this post, from another post and when I read it again I saw that it's wrong. Better late than never :D</div></div><hr />


<div class="post"><div class="posttop"><div class="username">0mar</div><div class="date">15th March 2003, 16:05</div></div><div class="posttext">It certainly makes sense from a 'security' point of view that other user's registry entries are unavailable under HKEY_USERS in NT. ;)<br />
<br />
I don't have 9x anymore, but I think I tested it on there and managed to delete keys from other profiles.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Mikesch</div><div class="date">29th November 2005, 14:32</div></div><div class="posttext">Originally posted by IGx89 <br />
Using HKCU makes things easier for me :)<br />
<br />
Here's how I fixed it:<br />
<br />
I just put the following in my app's (WulframPoller) Uninstall section:<br />
<br />
  IntOp $0 0 + 0<br />
EnumStart:<br />
  EnumRegKey $R1 HKEY_USERS &quot;&quot; $0<br />
  IntOp $0 $0 + 1<br />
  StrCmp $R1 &quot;.DEFAULT&quot; EnumStart<br />
  StrCmp $R1 &quot;&quot; EnumEnd<br />
  DeleteRegValue HKU &quot;$R1\Software\Microsoft\Windows\CurrentVersion\Run&quot; &quot;WulframPoller&quot;<br />
  DeleteRegKey HKU &quot;$R1\Software\Wulfram Poller&quot;<br />
  Goto EnumStart<br />
EnumEnd:<br />
<br />
Probably could be done in a more efficient way, but it gets the job done :)  <br />
<br />
Nice idea.<br />
But on my systems (2000/XP) I see only the &quot;.DEFAULT&quot; key and the key (SID?) for the current user on the hive &quot;HKEY_USERS&quot;. No matter if I logged on as admin or user.<br />
So for this reason the enumeration stops after deleting the keys for the current user.<br />
<br />
Any idea about what's wrong with my system?<br />
<br />
BTW: Writing application settings to the &quot;.DEFAULT&quot; key to prepare the system for new users has no effect.<br />
If I add a new user he never gets this setting.<br />
<br />
I am completely helpless<br />
:rolleyes:</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">29th November 2005, 18:56</div></div><div class="posttext">Nothing is wrong on your computer, that's how it works. You can use EnumUsersReg (http://nsis.sourceforge.net/EnumUsersReg) to load the users' hives manually.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Mikesch</div><div class="date">30th November 2005, 14:10</div></div><div class="posttext">Originally posted by kichik <br />
Nothing is wrong on your computer, that's how it works. You can use EnumUsersReg (http://nsis.sourceforge.net/EnumUsersReg) to load the users' hives manually.  <br />
<br />
Many thanks to you, kickik. :up: <br />
<br />
That's what I was looking for. :D <br />
<br />
Allow me still two further questions:<br />
<br />
Is there an easy way to call this functions in uninstall section without copying them and adding the un. prefix to the function name?<br />
<br />
The hive &quot;HKU\.DEFAULT&quot; does not work as I had expected.<br />
If I add a new user to my system he does not get the settings I wrote to &quot;HKU\.DEFAULT&quot; at installation time.<br />
Any suggestion how to ad this for new users?<br />
<br />
Mikesch</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Fretje</div><div class="date">30th November 2005, 15:27</div></div><div class="posttext">Has anybody thought about the fact that, if the user who is running the uninstaller doesn't have administrative rights, the installer won't be able to delete the registry values of the other users?<br />
<br />
Greetings,<br />
<br />
Fretje</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Mikesch</div><div class="date">1st December 2005, 08:55</div></div><div class="posttext">Originally posted by Fretje <br />
Has anybody thought about the fact that, if the user who is running the uninstaller doesn't have administrative rights, the installer won't be able to delete the registry values of the other users?<br />
<br />
Greetings,<br />
<br />
Fretje  <br />
<br />
Yes, I thought about this fact.<br />
<br />
I need the above behaviour for the case of installing my application as an administrator for all users.<br />
If a normal user installs my application he does this only for itself and does not affects any other user settings.<br />
<br />
In this moment I work on my uninstaller section to prevent uninstalling by the user if the application was installed by an administrator.<br />
<br />
Mikesch</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">2nd December 2005, 12:10</div></div><div class="posttext">You can put the functions in a macro and insert once for the installer and once for the uninstaller.!macro func un<br />
Function ${un}blah<br />
FunctionEnd<br />
!macroend<br />
!insertmacro blah &quot;&quot;<br />
!insertmacro blah &quot;un.&quot;I don't know why HKU\.DEFAULT doesn't work.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">stb</div><div class="date">3rd December 2005, 09:43</div></div><div class="posttext">IIRC: HKEY_CURRENT_USER can be roaming in Windows networks using a domain controller. Therefore I think it's a bad idea to delete those data for all/other users. HKEY_CURRENT_USER should only contain user settings. Because you cannot know how many network computers (0 or more) have your software installed I would let that data alone. Giving some option to uninstall user settings for the current user may be ok. Or you may give each user the possibility to remove that data by some small uninstall_userdata.exe/regclean.exe separately (an admin could push this to something logon.bat if he wants to clear the whole network).</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>