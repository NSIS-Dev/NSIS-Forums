<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" EnumRegValue search question on unknown subfolders, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  EnumRegValue search question on unknown subfolders NSIS Discussion" />
	
	<title> EnumRegValue search question on unknown subfolders [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  EnumRegValue search question on unknown subfolders</div>
<hr />
<div class="pda"><a href="t-212590.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=212590">EnumRegValue search question on unknown subfolders</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">bd2005</div><div class="date">8th April 2005, 08:20</div></div><div class="posttext">Ok.<br />
<br />
I'm able to search EnumRegValue with known full path.<br />
<br />
However, I need to search from &quot;...Windows\CurrentVersions\&quot; to find the &quot;DisplayName&quot; of the Uninstall Program I'm looking for.<br />
<br />
This particular Program is .msi installation package and upon installation creates product numbering of which I won't know on many machine of what this product numbering is.<br />
<br />
So, my thoughts is to search the registry from one starting point and drill downward to find the &quot;DisplayName&quot; to compare, upon match, then extract the full &quot;copy key name&quot; of the path and then get the UninstallString value.<br />
<br />
Is there nsis expert willing to help me with two code items.<br />
1.) Loop search through subfolders drill down for string match compare on &quot;DisplayName&quot; value starting from &quot;...Windows\CurrentVersions\&quot; or &quot;...Windows\CurrentVersions<br />
\Installer\UserData\&quot;<br />
2.) Then how to get &quot;copy key name&quot; value to extract full path to the folder.<br />
<br />
Once this full path is known, then I can ReadRegStr for the UninstallString value within this folder full path to execute the uninstall process.<br />
<br />
Thanks,<br />
BD</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">8th April 2005, 09:22</div></div><div class="posttext">I wanted to write such function, but I confronted with difficulties: root_key cannot pass it value to function without editing function (and other not comfortable ways). I put feature request to change all root_key at runtime.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bd2005</div><div class="date">8th April 2005, 10:12</div></div><div class="posttext">I may have figured it out, shall I email you zip file of the code ?  You can simply enter &quot;program name&quot; to search for within &quot;...\Windows\CurrentVersion\Installer\UserData\&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">8th April 2005, 18:20</div></div><div class="posttext">I start to write Function &quot;RegSearch&quot;. But it'll search in HKLM and HKCU only (using SHCTX - NSIS 2.06).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bd2005</div><div class="date">8th April 2005, 20:56</div></div><div class="posttext">Here's my nsis script to search HKLM Installed\UserData section, works great when used as &quot;standalone&quot;.<br />
<br />
However, when I copied the Section SEC01 code into Section Uninstall and copied related Functions located above Section Uninstall (not using DetailPrint) ... I get error Call FirstCheck from Section Uninstall.<br />
<br />
Any Ideas to workaround this?<br />
<br />
Can I look at your &quot;RegSearch&quot;?<br />
<br />
How do I create &quot;my function&quot; list?<br />
<br />
Thks.<br />
<br />
;-----------------------------------------------------<br />
; standalone search program in HKLM Installed\UserData<br />
;-----------------------------------------------------<br />
OutFile &quot;SearchProgram.exe&quot;<br />
ShowInstDetails show<br />
<br />
Section SEC01<br />
<br />
  ; Set your 1st ProgramName Here<br />
  StrCpy $7 &quot;enter desired program here&quot;<br />
  StrCpy $0 0<br />
  StrCpy $8 0<br />
  Call FirstCheck<br />
  DetailPrint $9<br />
  DetailPrint $4<br />
  <br />
  ; Set your 2nd ProgramName Here<br />
  StrCpy $7 &quot;enter desired program here&quot;<br />
  StrCpy $0 0<br />
  StrCpy $8 0<br />
  Call FirstCheck<br />
  DetailPrint $9<br />
  DetailPrint $4<br />
  <br />
SectionEnd<br />
<br />
Function FirstCheck<br />
  EnumRegKey $1 HKLM Software\Microsoft\Windows\CurrentVersion\Installer\UserData $0<br />
  IntOp $0 $0 + 1<br />
  StrCmp $1 &quot;&quot; done TrySecondCheckAgain<br />
TrySecondCheckAgain:<br />
  StrCpy $8 0<br />
  Call SecondCheck<br />
done:<br />
FunctionEnd<br />
<br />
Function SecondCheck<br />
  EnumRegKey $2 HKLM Software\Microsoft\Windows\CurrentVersion\Installer\UserData\$1\Products $8<br />
  IntOp $8 $8 + 1<br />
  StrCmp $2 &quot;&quot; TryFirstCheckAgain TryThirdCheckAgain<br />
TryThirdCheckAgain:<br />
  Call ThirdCheck<br />
TryFirstCheckAgain:<br />
  StrCpy $8 0<br />
  call FirstCheck<br />
FunctionEnd<br />
<br />
Function ThirdCheck<br />
  ReadRegStr $3 HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Installer\UserData\$1\Products\$2\InstallProperties&quot; DisplayName<br />
  ReadRegStr $5 HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Installer\UserData\$1\Products\$2\InstallProperties&quot; UninstallString<br />
  StrCmp $3 $7 ShowDetailInfo<br />
  Call SecondCheck<br />
  Call FirstCheck<br />
  goto SkipDetailPrint<br />
ShowDetailInfo:<br />
  ;DetailPrint $3<br />
  ;DetailPrint $5<br />
  StrCpy $9 $3<br />
  StrCpy $4 $5<br />
SkipDetailPrint:<br />
FunctionEnd<br />
;-----------------------------------------------------</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bd2005</div><div class="date">9th April 2005, 00:54</div></div><div class="posttext">Got it.<br />
Add &quot;un.&quot; to the function names will allow this set of modules to be executed from &quot;Section Uninstall&quot;.<br />
<br />
Thks.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">9th April 2005, 14:02</div></div><div class="posttext">I complite function if you interesting:<br />
<br />
Function &quot;RegSearch (http://nsis.sourceforge.net/archive/nsisweb.php?page=962&amp;instances=0,11,770)&quot; v1.0</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bd2005</div><div class="date">9th April 2005, 15:38</div></div><div class="posttext">Wow!<br />
Nice Function!<br />
<br />
I'm trying it out now.<br />
<br />
When compiling, I get error at this line in example1 section, what am I doing wrong?  do I need outfile?<br />
<br />
${RegSearch} &quot;HKEY_LOCAL_MACHINE\SOFTWARE\CLASSES&quot; &quot;/F=V /N=Content Type&quot; &quot;Example1&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">9th April 2005, 16:16</div></div><div class="posttext">First put function in script and then call it.<br />
Function RegSearch<br />
	;...<br />
FunctionEnd<br />
<br />
Section<br />
	${RegSearch} ...<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bd2005</div><div class="date">9th April 2005, 18:44</div></div><div class="posttext">Ok got it.<br />
<br />
Very Nice Script.  You know your stuff.<br />
<br />
Does this script automatically &quot;drill down&quot; into subfolder path like ... start path - &quot;software\microsoft\currentfolder&quot;<br />
<br />
and searches all other subfolder paths within it ?<br />
<br />
See my Function in this post, this will search all relavent paths three three layers down from starting path.<br />
<br />
Granted it's crappy compaired to yours, I don't know enough nsis to ensure reliability.  I would not be surprised if my function fails, but I've got to have reliable means of uninstalling two additional programs if the customer does NOT purchase evaluation primary software.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">9th April 2005, 19:24</div></div><div class="posttext">... searches all other subfolder paths within it ? Yes.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bd2005</div><div class="date">9th April 2005, 19:37</div></div><div class="posttext">Ok ... then perhaps I'm not &quot;seeing&quot; the match found in the Display Screen, using /F=VSK /N=searchvaluename.  When I'm using my function with the path and searchvaluename, it shows in my display (but it's probably buggy for distribution with installation software package), seeing how professional your function is, I would like to incorporate your function into my nsis.<br />
<br />
I'm looking at R9-R1 values either in DisplayPrint or MessageBox in Section module, shows empty, even though, the &quot;Display Name&quot; key value exists in the Registry matching the &quot;/N=searchvaluename&quot; I'm looking for. Once the match is found, then I can retrieve the &quot;uninstallstring&quot;, plug this into uninstall section, proceed onward uninstalling the software.  The path is different for each machine as one of the .msi software I'm installing (in addition to my primary software) is always installed in CLSID, thus the actual path is different which makes searching necessary for &quot;display name&quot; in &quot;...\currentversion\...\installedversions\...&quot; etc.<br />
<br />
What am I overlooking ?<br />
<br />
Thks.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">10th April 2005, 05:23</div></div><div class="posttext">Name &quot;Output&quot;<br />
OutFile &quot;Output.exe&quot;<br />
<br />
Function RegSearch<br />
	;...<br />
Function<br />
<br />
Section<br />
	${RegSearch} &quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall&quot; \<br />
           &quot;/F=V /N=DisplayName&quot; &quot;RegSearchCallback&quot;<br />
<br />
	IfErrors 0 +2<br />
	MessageBox MB_OK &quot;Error&quot;<br />
SectionEnd<br />
<br />
Function RegSearchCallback<br />
	ReadRegStr $1 HKLM $R9 'UninstallString'<br />
	IfErrors end<br />
	SetDetailsPrint both<br />
	DetailPrint 'DisplayName:&quot;$R6&quot;'<br />
	DetailPrint 'UninstallString:&quot;$1&quot;'<br />
	DetailPrint ''<br />
	SetDetailsPrint textonly<br />
<br />
	end:<br />
	Push $0<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">bd2005</div><div class="date">10th April 2005, 06:12</div></div><div class="posttext">Thanks so much.  I really appreciate your assistance on this.  Here's your code I'm running on my machine, looking for &quot;Adobe Acrobat 5.0&quot; to get UninstallString.<br />
<br />
I get &quot;Error&quot; popup messagebox from your code, for some reason or another, it doesn't like my registry?  If it works on your machine, technically it should work for all machine with the same HKLM path?  correct?<br />
<br />
<br />
;RegSearch by Instructor<br />
Outfile &quot;RegSearch.exe&quot;<br />
<br />
Function RegSearch<br />
	!define RegSearch `!insertmacro RegSearchCall`<br />
<br />
	!macro RegSearchCall _PATH _OPTIONS _FUNC<br />
		Push $0<br />
		Push `${_PATH}`<br />
		Push `${_OPTIONS}`<br />
		GetFunctionAddress $0 `${_FUNC}`<br />
		Push `$0`<br />
		Call RegSearch<br />
		Pop $0<br />
	!macroend<br />
<br />
	Exch $2<br />
	Exch<br />
	Exch $1<br />
	Exch<br />
	Exch 2<br />
	Exch $0<br />
	Exch 2<br />
	Push $3<br />
	Push $4<br />
	Push $5<br />
	Push $6<br />
	Push $7<br />
	Push $8<br />
	Push $R5<br />
	Push $R6<br />
	Push $R7<br />
	Push $R8<br />
	Push $R9<br />
	ClearErrors<br />
<br />
	StrCpy $3 ''<br />
	StrCpy $4 ''<br />
	StrCpy $5 ''<br />
	StrCpy $6 ''<br />
	StrCpy $7 0<br />
<br />
	StrCpy $R9 $0 1 -1<br />
	StrCmp $R9 '\' 0 +3<br />
	StrCpy $0 $0 -1<br />
	goto -3<br />
	StrCpy $R8 0<br />
	StrCpy $R9 $0 1 $R8<br />
	StrCmp $R9 '' +4<br />
	StrCmp $R9 '\' +3<br />
	IntOp $R8 $R8 + 1<br />
	goto -4<br />
	StrCpy $R9 $0 $R8<br />
	IntOp $R8 $R8 + 1<br />
	StrCpy $0 $0 '' $R8<br />
<br />
	StrCmp $R9 'HKLM' +2<br />
	StrCmp $R9 'HKEY_LOCAL_MACHINE' 0 +3<br />
	SetShellVarContext all<br />
	goto ifkeyexists<br />
	StrCmp $R9 'HKCU' +2<br />
	StrCmp $R9 'HKEY_CURRENT_USER' 0 error<br />
	SetShellVarContext current<br />
<br />
	ifkeyexists:<br />
	ReadRegStr $R9 SHCTX $0 ''<br />
	IfErrors error<br />
<br />
	option:<br />
	StrCpy $R9 $1 1<br />
	StrCpy $1 $1 '' 1<br />
	StrCmp $R9 ' ' -2<br />
	StrCmp $R9 '' default<br />
	StrCmp $R9 '/' 0 -4<br />
	StrCpy $R7 -1<br />
	IntOp $R7 $R7 + 1<br />
	StrCpy $R9 $1 1 $R7<br />
	StrCmp $R9 '' +2<br />
	StrCmp $R9 '/' 0 -3<br />
	StrCpy $R8 $1 $R7<br />
	StrCpy $R8 $R8 '' 2<br />
	StrCpy $R9 $R8 '' -1<br />
	StrCmp $R9 ' ' 0 +3<br />
	StrCpy $R8 $R8 -1<br />
	goto -3<br />
	StrCpy $R9 $1 2<br />
	StrCpy $1 $1 '' $R7<br />
<br />
	StrCmp $R9 'F=' 0 mask<br />
	StrCpy $3 $R8<br />
	StrCmp $3 '' +6<br />
	StrCmp $3 'VSK' +5<br />
	StrCmp $3 'VS' +4<br />
	StrCmp $3 'V' +3<br />
	StrCmp $3 'K' +2<br />
	StrCmp $3 'D' 0 error<br />
	goto option<br />
<br />
	mask:<br />
	StrCmp $R9 'N=' 0 gotosubdir<br />
	StrCpy $4 $R8<br />
	goto option<br />
<br />
	gotosubdir:<br />
	StrCmp $R9 'G=' 0 banner<br />
	StrCpy $5 $R8<br />
	StrCmp $5 '' +3<br />
	StrCmp $5 '1' +2<br />
	StrCmp $5 '0' 0 error<br />
	goto option<br />
<br />
	banner:<br />
	StrCmp $R9 'B=' 0 error<br />
	StrCpy $6 $R8<br />
	StrCmp $6 '' +3<br />
	StrCmp $6 '1' +2<br />
	StrCmp $6 '0' 0 error<br />
	goto option<br />
<br />
	default:<br />
	StrCmp $3 '' 0 +2<br />
	StrCpy $3 'VSK'<br />
	StrCmp $5 '' 0 +2<br />
	StrCpy $5 '1'<br />
	StrCmp $6 '' 0 +2<br />
	StrCpy $6 '0'<br />
<br />
	StrCpy $7 1<br />
	Push $0<br />
	SetDetailsPrint textonly<br />
<br />
	popkey:<br />
	StrCmp $7 '0' end<br />
	IntOp $7 $7 - 1<br />
	Pop $R9<br />
<br />
	StrCpy $R5 ''<br />
	StrCpy $R6 ''<br />
	StrCpy $R7 ''<br />
	StrCpy $R8 ''<br />
	StrCmp $6 '0' +3<br />
	GetLabelAddress $1 readdefault<br />
	goto call<br />
	DetailPrint 'Search in: $R9'<br />
<br />
	readdefault:<br />
	StrCmp $3 'V' enumvalue<br />
	StrCmp $3 'K' enumkey<br />
	ReadRegStr $R6 SHCTX $R9 ''<br />
	StrCpy $R5 STR<br />
	IfErrors 0 +5<br />
	ReadRegDWORD $R6 SHCTX $R9 ''<br />
	StrCpy $R5 DWORD<br />
	IfErrors 0 +2<br />
	StrCpy $R5 BIN<br />
	StrCmp $3 'D' 0 +3<br />
	GetLabelAddress $1 enumkey<br />
	goto +2<br />
	GetLabelAddress $1 enumvalue<br />
	StrCmp $R6 '' $1<br />
	StrCmp $4 '' call<br />
	StrCmp $4 $R6 call $1<br />
<br />
	enumvalue:<br />
	StrCpy $0 0<br />
	nextvalue:<br />
	EnumRegValue $R7 SHCTX $R9 $0<br />
	StrCmp $R7 '' enumkey<br />
	IntOp $0 $0 + 1<br />
	StrCmp $4 '' +3<br />
	StrCmp $4 $R7 +2<br />
	StrCmp $3 'V' nextvalue<br />
<br />
	ReadRegStr $R6 SHCTX $R9 $R7<br />
	StrCpy $R5 STR<br />
	IfErrors 0 +5<br />
	ReadRegDWORD $R6 SHCTX $R9 $R7<br />
	StrCpy $R5 DWORD<br />
	IfErrors 0 +2<br />
	StrCpy $R5 BIN<br />
	StrCmp $3 'V' +3<br />
	StrCmp $4 '' +2<br />
	StrCmp $4 $R6 0 nextvalue<br />
	GetLabelAddress $1 nextvalue<br />
	goto call<br />
<br />
	enumkey:<br />
	StrCmp $5 '0' end<br />
	StrCpy $R5 KEY<br />
	StrCpy $R6 ''<br />
	StrCpy $R7 ''<br />
	StrCpy $0 0<br />
	nextkey:<br />
	EnumRegKey $R8 SHCTX $R9 $0<br />
	StrCmp $R8 '' popkey<br />
	IntOp $0 $0 + 1<br />
	IntOp $7 $7 + 1<br />
	StrCmp $R9 '' 0 +3<br />
	Push $R8<br />
	goto +2<br />
	Push '$R9\$R8'<br />
	StrCmp $3 'VSK' +2<br />
	StrCmp $3 'K' 0 nextkey<br />
	StrCmp $4 '' +2<br />
	StrCmp $R8 $4 0 nextkey<br />
	GetLabelAddress $1 nextkey<br />
	goto call<br />
<br />
	call:<br />
	Push $0<br />
	Push $1<br />
	Push $2<br />
	Push $3<br />
	Push $4<br />
	Push $5<br />
	Push $6<br />
	Push $7<br />
	Push $R5<br />
	Push $R9<br />
	Call $2<br />
	Pop $8<br />
	Pop $R9<br />
	Pop $R5<br />
	Pop $7<br />
	Pop $6<br />
	Pop $5<br />
	Pop $4<br />
	Pop $3<br />
	Pop $2<br />
	Pop $1<br />
	Pop $0<br />
	IfErrors error<br />
<br />
	StrCmp $8 'StopRegSearch' clearstack<br />
	StrCpy $R6 ''<br />
	StrCpy $R7 ''<br />
	StrCpy $R8 ''<br />
	goto $1<br />
<br />
	error:<br />
	SetErrors<br />
<br />
	clearstack:<br />
	StrCmp $7 0 end<br />
	IntOp $7 $7 - 1<br />
	Pop $R9<br />
	goto clearstack<br />
<br />
	end:<br />
	SetShellVarContext current<br />
	SetDetailsPrint both<br />
	Pop $R9<br />
	Pop $R8<br />
	Pop $R7<br />
	Pop $R6<br />
	Pop $R5<br />
	Pop $8<br />
	Pop $7<br />
	Pop $6<br />
	Pop $5<br />
	Pop $4<br />
	Pop $3<br />
	Pop $2<br />
	Pop $1<br />
	Pop $0<br />
FunctionEnd<br />
<br />
Section<br />
       ;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall<br />
       ;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Installer\UserData<br />
	${RegSearch} &quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall&quot; &quot;/F=V /N=Adobe Acrobat 5.0&quot; &quot;RegSearchCallback&quot;<br />
<br />
	IfErrors 0 +2<br />
	MessageBox MB_OK &quot;Error&quot;<br />
SectionEnd<br />
<br />
Function RegSearchCallback<br />
	ReadRegStr $1 HKLM $R9 'UninstallString'<br />
	IfErrors end<br />
	SetDetailsPrint both<br />
	DetailPrint 'DisplayName:&quot;$R6&quot;'<br />
	DetailPrint 'UninstallString:&quot;$1&quot;'<br />
	DetailPrint ''<br />
	SetDetailsPrint textonly<br />
<br />
	end:<br />
	Push $0<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">10th April 2005, 07:40</div></div><div class="posttext">hm... I run script in Windows XP and get the same error message.<br />
<br />
ReadRegStr $0 HKLM &quot;SOFTWARE\Microsoft&quot; &quot;&quot;<br />
IfErrors 0 +2<br />
MessageBox MB_OK &quot;Error&quot;<br />
In WinMe return no errors (empty or not).<br />
In WinXP return error (only if empty).<br />
Interesting if I manually delete default string &quot;SOFTWARE\Microsoft&quot; in WinXP - no errors.<br />
I'll post bug report about it.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">10th April 2005, 09:52</div></div><div class="posttext">You can try changed version &quot;RegSearch (http://nsis.sourceforge.net/archive/nsisweb.php?page=962&amp;instances=0,11,770)&quot; v1.0d</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>