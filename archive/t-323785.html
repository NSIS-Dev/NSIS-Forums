<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" System::Call crashing installer, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  System::Call crashing installer NSIS Discussion" />
	
	<title> System::Call crashing installer [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  System::Call crashing installer</div>
<hr />
<div class="pda"><a href="t-323785.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=323785">System::Call crashing installer</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">BillK</div><div class="date">5th November 2010, 00:34</div></div><div class="posttext">I'm not sure what I'm doing wrong here but it crashes the setup exe.  I'm writing a new installer to do away with our ancient InstallShield scripts to install one of our products.  I need to make a call to one of our dlls to check the device manager if certain hardware is installed.  I'm calling W2kIsDeviceIdInstalledA in voysetupc6.dll and passing it two ansi strings &quot;PCI&quot; and &quot;VEN_104C&amp;DEV_8025&amp;SUBSYS_702A14DB&quot; it returns a 0 or 1 depending if it finds the driver or not.<br />
<br />
First here's how it works in the InstallShield script:<br />
   prototype VoySetupC6.W2kIsDeviceIdInstalledA( string, string );<br />
   string szQVI5MegHWId;<br />
   szQVI5MegHWId   = &quot;VEN_104C&amp;DEV_8025&amp;SUBSYS_702A14DB&quot;;<br />
   if ( W2kIsDeviceIdInstalledA(&quot;PCI&quot;, szQVI5MegHWId) &gt; 0 ) then<br />
<br />
<br />
Here's how I have coded it in the NSIS script which crashes the installer:<br />
  !define VoySetupDll &quot;voysetupc6.dll&quot;<br />
  !define PCI &quot;PCI&quot;<br />
  !define szQVI5MegHWId &quot;VEN_104C&amp;DEV_8025&amp;SUBSYS_702A14DB&quot;<br />
<br />
   InitPluginsDir<br />
   ReserveFile &quot;${VoySetupDll}&quot;<br />
   File &quot;/ONAME=$PLUGINSDIR\voysetupc6.dll&quot; &quot;${VoySetupDll}&quot;<br />
   System::Call 'VoySetupc6::W2kIsDeviceIdInstalledA(${PCI}, ${szQVI5MegHWId}) i.r0'<br />
   StrCmp $0 1 0 notfound<br />
     MessageBox MB_OK|MB_ICONEXCLAMATION &quot;Found&quot; /SD IDOK<br />
   notfound:<br />
      MessageBox MB_OK|MB_ICONEXCLAMATION &quot;Not found&quot; /SD IDOK<br />
<br />
Any help would be appreciated I've wasted most of the day trying to get this to work.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">5th November 2010, 03:50</div></div><div class="posttext">you're forgetting to specify the data types in your System call, I think?<br />
<br />
i.e.<br />
System::Call 'VoySetupc6::W2kIsDeviceIdInstalledA(${PCI}, ${szQVI5MegHWId}) i.r0'expands to...<br />
System::Call 'VoySetupc6::W2kIsDeviceIdInstalledA(&quot;PCI&quot;, &quot;VEN_104C&amp;DEV_8025&amp;SUBSYS_702A14DB&quot;) i.r0'System doesn't know what datatype &quot;PCI&quot; is without you explicitly specifying it.  Presuming the DLL needs ANSI strings, the type should be &quot;m&quot;:<br />
System::Call 'VoySetupc6::W2kIsDeviceIdInstalledA(m &quot;PCI&quot;, m &quot;VEN_104C&amp;DEV_8025&amp;SUBSYS_702A14DB&quot;) i.r0'<br />
( type &quot;t&quot; for 'text' is unicode-context-sensitive; within the Unicode build of NSIS, it passes unicode strings )<br />
<br />
So try again with the datatypes specified.. with any luck, that will have been it.  Otherwise, double-check the function's prototype, and post again with whatever the new error might be if you're sure you're calling it correctly.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">BillK</div><div class="date">5th November 2010, 16:52</div></div><div class="posttext">Unforunately that didn't work with m or t.   It's crashing with a code 5  STATUS_ACCESS_VIOLATION.   Maybe I'm not calling it correctly.  Here's the header of the method:<br />
<br />
BOOL WINAPI W2kIsDeviceIdInstalledA (LPCASTR pszPnpEnum, LPCASTR pszDeviceId)<br />
<br />
It takes two strings and returns true or false.  Since it works fine in InstallShield I have to be doing something wrong in NSIS.<br />
<br />
Thanks for the help!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">BillK</div><div class="date">5th November 2010, 18:55</div></div><div class="posttext">Also if anybody has a solution that I can use that doesn't involve this dll that would be great too.  I just need to look at the devices installed to see which drivers are installed based off the vendor ID.  In the above code I'm looking to see that a Texas Instruments firewire driver is present.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">BillK</div><div class="date">8th November 2010, 15:16</div></div><div class="posttext">No ideas?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">8th November 2010, 16:29</div></div><div class="posttext">not I.. the call looks like it should be correct - but the System plugin can be a bit of a beast.. which doesn't help when trying to eliminate that DLL.. looks like the SetupDi* functions ( http://msdn.microsoft.com/en-us/library/ff551072%28v=VS.85%29.aspx ) are what you'd be looking at.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>