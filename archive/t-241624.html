<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Help needed to compile helper!, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Help needed to compile helper! NSIS Discussion" />
	
	<title> Help needed to compile helper! [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Help needed to compile helper!</div>
<hr />
<div class="pda"><a href="t-241624.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=241624">Help needed to compile helper!</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">23rd March 2006, 21:40</div></div><div class="posttext">well, based on Instructor's functions and code posted on other topics I'm trying to compile a script that takes a given directory and builds a proper list ready to !include in install section. This could be a helper to parse the entire directory structure in the installation script. The code that I'm figuring is this:<br />
OutFile test.exe<br />
Name &quot;NSIS Script Helper&quot;<br />
<br />
!include &quot;FileFunc.nsh&quot;<br />
<br />
!insertmacro Locate<br />
<br />
!define DirName 'D:\New_Installation'<br />
!define FileList '$EXEDIR\Files.lst'<br />
<br />
var TargetDir<br />
<br />
Section<br />
        FileOpen $R1 ${FileList} w<br />
	${Locate} &quot;${DirName}&quot; &quot;/L=F /M=*.*&quot; &quot;LocateCallBack&quot;<br />
	FileClose $R1<br />
        IfErrors 0 +2<br />
        MessageBox MB_OK &quot;Error&quot; IDOK +2<br />
        Exec '&quot;notepad.exe&quot; &quot;${FileList}&quot;'<br />
SectionEnd<br />
<br />
Function LocateCallBack<br />
	StrLen $R2 '${DirName}'<br />
	StrCpy $TargetDir $R8 '' $R2<br />
        StrCmp $TargetDir '' +1 +3<br />
        FileWrite $R1 'SetOutPath &quot;$$INSTDIR&quot;$\r$\n'<br />
        goto +2<br />
        FileWrite $R1 'CreateDirectory &quot;$$INSTDIR$TargetDir&quot;$\r$\nSetOutPath &quot;$$INSTDIR$TargetDir&quot;$\r$\n'<br />
        FileWrite $R1 'File &quot;$R8\$R7&quot;$\r$\n'<br />
	Push $0<br />
FunctionEnd<br />
The resulting list where I really stuck is this:<br />
SetOutPath &quot;$INSTDIR&quot;<br />
File &quot;D:\New_Installation\root.dll&quot;<br />
SetOutPath &quot;$INSTDIR&quot;<br />
File &quot;D:\New_Installation\rootexec.exe&quot;<br />
CreateDirectory &quot;$INSTDIR\subdir&quot;<br />
SetOutPath &quot;$INSTDIR\subdir&quot;<br />
File &quot;D:\New_Installation\subdir\other_recourse.dll&quot;<br />
CreateDirectory &quot;$INSTDIR\subdir&quot;<br />
SetOutPath &quot;$INSTDIR\subdir&quot;<br />
File &quot;D:\New_Installation\subdir\recourse.dll&quot;<br />
CreateDirectory &quot;$INSTDIR\subdir\Folder&quot;<br />
SetOutPath &quot;$INSTDIR\subdir\Folder&quot;<br />
File &quot;D:\New_Installation\subdir\Folder\somedll.dll&quot;<br />
CreateDirectory &quot;$INSTDIR\subdir\Folder&quot;<br />
SetOutPath &quot;$INSTDIR\subdir\Folder&quot;<br />
File &quot;D:\New_Installation\subdir\Folder\some_other.dll&quot;<br />
CreateDirectory &quot;$INSTDIR\documents&quot;<br />
SetOutPath &quot;$INSTDIR\documents&quot;<br />
File &quot;D:\New_Installation\documents\help.pdf&quot;<br />
CreateDirectory &quot;$INSTDIR\documents&quot;<br />
SetOutPath &quot;$INSTDIR\documents&quot;<br />
File &quot;D:\New_Installation\documents\more_help.html&quot;<br />
I can't handle how I should write the code to eliminate the repeated lines 'SetOutPath...' and 'CreateDirectory...' so the resulting list will be like this:<br />
SetOutPath &quot;$INSTDIR&quot;<br />
File &quot;D:\New_Installation\root.dll&quot;<br />
File &quot;D:\New_Installation\rootexec.exe&quot;<br />
<br />
CreateDirectory &quot;$INSTDIR\subdir&quot;<br />
SetOutPath &quot;$INSTDIR\subdir&quot;<br />
File &quot;D:\New_Installation\subdir\other_recourse.dll&quot;<br />
File &quot;D:\New_Installation\subdir\recourse.dll&quot;<br />
<br />
CreateDirectory &quot;$INSTDIR\subdir\Folder&quot;<br />
SetOutPath &quot;$INSTDIR\subdir\Folder&quot;<br />
File &quot;D:\New_Installation\subdir\Folder\somedll.dll&quot;<br />
File &quot;D:\New_Installation\subdir\Folder\some_other.dll&quot;<br />
<br />
CreateDirectory &quot;$INSTDIR\documents&quot;<br />
SetOutPath &quot;$INSTDIR\documents&quot;<br />
File &quot;D:\New_Installation\documents\help.pdf&quot;<br />
File &quot;D:\New_Installation\documents\more_help.html&quot;<br />
Help please!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">23rd March 2006, 22:23</div></div><div class="posttext">I'm not sure why CreateDirectory is being used in the first place. With the above code you'll find that all the files will get dumped in $INSTDIR (because SetOutPath sets the output directory, and it's being set to $INSTDIR to begin with and it's never being changed thereafter).<br />
<br />
You could try the RecFind script header at:<br />
http://nsis.sourceforge.net/RecFind:_Recursive_FindFirst%2C_FindNext%2C_FindClose<br />
<br />
Your code would then look like this:<br />
<br />
OutFile GenerateFileList.exe<br />
Name &quot;GenerateFileList&quot;<br />
<br />
!include RecFind.nsh<br />
<br />
!define DirName 'D:\New_Installation'<br />
!define FileList '$EXEDIR\Files.lst'<br />
<br />
Section<br />
  FileOpen $R2 ${FileList} w<br />
<br />
  ${RecFindOpen} &quot;${DirName}&quot; $R0 $R1<br />
   FileWrite $R2 'SetOutPath &quot;$\r$\n${DirName}$R0$\r$\n&quot;'<br />
  ${RecFindFirst}<br />
   FileWrite $R2 'File &quot;${DirName}$R0\$R1$\r$\n&quot;'<br />
  ${RecFindNext}<br />
  ${RecFindClose}<br />
<br />
  FileClose $R2<br />
  Quit<br />
SectionEnd<br />
<br />
<br />
Although the code is much simpler you have less options here. I actually implemented a file extension filter into ${RecFindFirst} but for some reason I never uploaded the changes and now I've lost them altogether. I'll probably sort this out sometime.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">23rd March 2006, 22:42</div></div><div class="posttext">oops sorry!<br />
I missed a line in my code! now it's fixed and writes the proper SetOutPath for every created directory. Yet, the problem is still there! how can I eliminate the repeated lines?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">23rd March 2006, 23:08</div></div><div class="posttext">@ -Stu<br />
This is the list I got with your function.<br />
SetOutPath &quot;<br />
D:\New_Installation<br />
&quot;File &quot;D:\New_Installation\root.dll<br />
&quot;File &quot;D:\New_Installation\rootexec.exe<br />
&quot;SetOutPath &quot;<br />
D:\New_Installation\subdir<br />
&quot;File &quot;D:\New_Installation\subdir\other_recourse.dll<br />
&quot;File &quot;D:\New_Installation\subdir\recourse.dll<br />
&quot;SetOutPath &quot;<br />
D:\New_Installation\subdir\Folder<br />
&quot;File &quot;D:\New_Installation\subdir\Folder\somedll.dll<br />
&quot;File &quot;D:\New_Installation\subdir\Folder\some_other.dll<br />
&quot;SetOutPath &quot;<br />
D:\New_Installation\documents<br />
&quot;File &quot;D:\New_Installation\documents\help.pdf<br />
&quot;File &quot;D:\New_Installation\documents\more_help.html<br />
&quot;<br />
Quite close to what I'm looking for!!!<br />
I should change the variables when writing to the file to point the InstallDir and subdirs and create them also. That's OK I guess, I'm going to make it later. Yet, there are some strange things with the quotes. How should I fix them?<br />
Thanks anyway!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">23rd March 2006, 23:42</div></div><div class="posttext">The quotes was the easiest thing!<br />
Based on Stu's code above here is the script:<br />
OutFile GenerateFileList.exe<br />
Name &quot;GenerateFileList&quot;<br />
<br />
!include RecFind.nsh<br />
<br />
!define DirName 'D:\New_Installation'<br />
!define FileList '$EXEDIR\Files.lst'<br />
<br />
Section<br />
  FileOpen $R2 ${FileList} w<br />
<br />
  ${RecFindOpen} &quot;${DirName}&quot; $R0 $R1<br />
   StrCmp '$R0' '' +1 +3<br />
   FileWrite $R2 'SetOutPath &quot;$$INSTDIR$R0&quot;$\r$\n'<br />
   Goto +2<br />
   FileWrite $R2 'CreateDirectory &quot;$$INSTDIR$R0&quot;$\r$\nSetOutPath &quot;$$INSTDIR$R0&quot;$\r$\n'<br />
  ${RecFindFirst}<br />
   FileWrite $R2 'File &quot;${DirName}$R0\$R1&quot;$\r$\n'<br />
  ${RecFindNext}<br />
  ${RecFindClose}<br />
<br />
  FileClose $R2<br />
  Quit<br />
SectionEnd<br />
And here is the resulting list:<br />
SetOutPath &quot;$INSTDIR&quot;<br />
File &quot;D:\New_Installation\root.dll&quot;<br />
File &quot;D:\New_Installation\rootexec.exe&quot;<br />
CreateDirectory &quot;$INSTDIR\subdir&quot;<br />
SetOutPath &quot;$INSTDIR\subdir&quot;<br />
File &quot;D:\New_Installation\subdir\other_recourse.dll&quot;<br />
File &quot;D:\New_Installation\subdir\recourse.dll&quot;<br />
CreateDirectory &quot;$INSTDIR\subdir\Folder&quot;<br />
SetOutPath &quot;$INSTDIR\subdir\Folder&quot;<br />
File &quot;D:\New_Installation\subdir\Folder\somedll.dll&quot;<br />
File &quot;D:\New_Installation\subdir\Folder\some_other.dll&quot;<br />
CreateDirectory &quot;$INSTDIR\documents&quot;<br />
SetOutPath &quot;$INSTDIR\documents&quot;<br />
File &quot;D:\New_Installation\documents\help.pdf&quot;<br />
File &quot;D:\New_Installation\documents\more_help.html&quot;<br />
Thanks Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">24th March 2006, 06:09</div></div><div class="posttext">You don't need CreateDirectory because SetOutPath create it.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">24th March 2006, 08:10</div></div><div class="posttext">Hi Instructor,<br />
need it or not, do you have any suggestions how to eliminate the repeated lines for the example (top of the page} based in your code?<br />
Thanks in advance</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">24th March 2006, 09:36</div></div><div class="posttext">No need for this at all in the RecFind script:<br />
   StrCmp '$R0' '' +1 +3<br />
   FileWrite $R2 'SetOutPath &quot;$$INSTDIR$R0&quot;$\r$\n'<br />
   Goto +2<br />
   FileWrite $R2 'CreateDirectory &quot;$$INSTDIR$R0&quot;$\r$\nSetOutPath &quot;$$INSTDIR$R0&quot;$\r$\n'<br />
<br />
Anything between ${RecFindOpen} and ${RecFindFirst} is executed only when moving into a new directory and not for each new file found. Also $R0 (the directory path) will never be empty &quot;&quot; so it will always jump to the second FileWrite instruction anyway.<br />
<br />
Therefore you just need:<br />
<br />
FileWrite $R2 'SetOutPath &quot;$$INSTDIR$R0&quot;$\r$\n'<br />
<br />
SetOutPath creates the directories recursively as well! So no need for CreateDirectory.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">24th March 2006, 10:03</div></div><div class="posttext">do you have any suggestions how to eliminate the repeated lines for the example (top of the page} based in your code?<br />
Name &quot;Output&quot;<br />
OutFile &quot;Output.exe&quot;<br />
<br />
!include &quot;FileFunc.nsh&quot;<br />
!insertmacro Locate<br />
<br />
!define DirName 'C:\TC'<br />
!define FileList '$EXEDIR\Files.lst'<br />
<br />
Section<br />
	StrCpy $R0 ''<br />
	StrLen $R1 '${DirName}'<br />
	FileOpen $R3 '${FileList}' w<br />
	FileWrite $R3 'SetOutPath &quot;$$INSTDIR&quot;$\r$\n'<br />
	${Locate} &quot;${DirName}&quot; &quot;/L=F /M=*.*&quot; &quot;LocateCallBack&quot;<br />
	FileClose $R3<br />
<br />
	IfErrors 0 +2<br />
	MessageBox MB_OK &quot;Error&quot; IDOK +2<br />
	Exec '&quot;notepad.exe&quot; &quot;${FileList}&quot;'<br />
SectionEnd<br />
<br />
Function LocateCallBack<br />
	StrCpy $1 $R8 '' $R1<br />
	StrCmp $R0 $1 +4<br />
	StrCpy $R0 $1<br />
	FileWrite $R3 'SetOutPath &quot;$$INSTDIR$R0&quot;$\r$\n'<br />
	goto +2<br />
	FileWrite $R3 'File &quot;$R9&quot;$\r$\n'<br />
<br />
	Push $0<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">24th March 2006, 10:42</div></div><div class="posttext">@ Stu:<br />
Yes, you're always turning on the light! I used SetOutPath $INSTDIR in my install section also, that's why appeared two times up there!<br />
@ Instructor:<br />
I'll check that later, yet, I'm sure it works.<br />
<br />
Thanks, I'm learning from you people, and I like it!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">24th March 2006, 12:29</div></div><div class="posttext">OK, no need for CreateDirectory while SetOutPath creates the directories recursively as mentionend above. I use it just to have the list in tact.<br />
@ Instructor: The code in your last post getting closer. There are not repeated lines, though, it takes only the first file found into every subdir.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">24th March 2006, 12:59</div></div><div class="posttext">@ Instructor: The code in your last post getting closer. There are not repeated lines, though, it takes only the first file found into every subdir.Oops :)<br />
Name &quot;Output&quot;<br />
OutFile &quot;Output.exe&quot;<br />
<br />
!include &quot;FileFunc.nsh&quot;<br />
!insertmacro Locate<br />
<br />
!define DirName 'C:\TC'<br />
!define FileList '$EXEDIR\Files.lst'<br />
<br />
Section<br />
	StrCpy $R0 ''<br />
	StrLen $R1 '${DirName}'<br />
	FileOpen $R3 '${FileList}' w<br />
	FileWrite $R3 'SetOutPath &quot;$$INSTDIR&quot;$\r$\n'<br />
	${Locate} &quot;${DirName}&quot; &quot;/L=F /M=*.*&quot; &quot;LocateCallBack&quot;<br />
	FileClose $R3<br />
<br />
	IfErrors 0 +2<br />
	MessageBox MB_OK &quot;Error&quot; IDOK +2<br />
	Exec '&quot;notepad.exe&quot; &quot;${FileList}&quot;'<br />
SectionEnd<br />
<br />
Function LocateCallBack<br />
	StrCpy $1 $R8 '' $R1<br />
	StrCmp $R0 $1 +3<br />
	StrCpy $R0 $1<br />
	FileWrite $R3 'SetOutPath &quot;$$INSTDIR$R0&quot;$\r$\n'<br />
	FileWrite $R3 'File &quot;$R9&quot;$\r$\n'<br />
<br />
	Push $0<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">24th March 2006, 14:19</div></div><div class="posttext">COOL! Both working perfect!<br />
Such things I could not manage by my self yet.<br />
Keep going. Scratching NSIS's shell. With these two tools, let's see If I can figure a simple helper gui which offers options to select a given dir and all subdirs, select only files into the root of the given dir, or select individual files from different locations and build a list ready to !include. Besides the scratching, I guess would be usefull if one could save some typing while building an installation.<br />
I'll come back later.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>