<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Extending the x64.nsh, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Extending the x64.nsh NSIS Discussion" />
	
	<title> Extending the x64.nsh [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Extending the x64.nsh</div>
<hr />
<div class="pda"><a href="t-322019.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=322019">Extending the x64.nsh</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Zinthose</div><div class="date">27th August 2010, 21:20</div></div><div class="posttext">I'm starting to dig heavily in creating my own header/includes and I identified a shortcoming in the x64.nsh include.<br />
<br />
I looked for an API to detect if the file redirection has been disabled but I was unable to locate anything that didn't feel like a hack.<br />
<br />
So, I added a new macro to the x64.nsh include named &quot;RestoreX64FSRedirection&quot;.  It uses the precompiler directives to track the redirection state.  It's not perfect as any calls outside of the x64.nsh that changes the redirection state will break it but it's better than nothing.  :D<br />
<br />
Why go through the trouble?  Headers!  A header library author never knows what the state of the systems is in prior to the include or macro / function execution.  I added this to allow my header code to support 64bit without inadvertently mucking up the developer's code. When he/she installs with redirection enabled they expect it to return to the way they left it after they run one of my macros or functions.  It's all about maintaining state.  :cool:<br />
<br />
x64.nsh v2 on PasteBin.com (http://nsis.pastebin.com/gBet9drP)<br />
<br />
What do you guys think?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">27th August 2010, 23:03</div></div><div class="posttext">well if you're going through that trouble, you might as well update it to use the proper Wow64DisableWow64FsRedirection and Wow64RevertWow64FsRedirection API calls ;)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">27th August 2010, 23:16</div></div><div class="posttext">You also have the (major) issue that the order that code fragments appear in a script isn't the order that they will be executed at run time. Therefore you really need to use a run time check for this. If you must, just add a define to make x64.nsh use its own state variable.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Zinthose</div><div class="date">27th August 2010, 23:27</div></div><div class="posttext">hmmm...... TO THE LAB!!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">27th August 2010, 23:28</div></div><div class="posttext">yep.. what's what we ended up doing.  We actually adjusted it a slight bit further to ignore the redirection bits with ${Unless} ${AtLeastWinVista}, and new $SYS32 and $SYS64 variables which are initialized (in .onInit).  On Vista+, $SYS64 simply contains the $WINDIR\SysNative folder (avoiding the need for the FS redirector calls), while on XP it's left to $SYSDIR with the FS redirection disable/revert calls taking care of files going to the correct one.  It also makes it easier for us to work with because we don't see a bunch of $SYSDIR references having to puzzle from context or comments as to whether the code should be dealing with the 32bit or the 64bit one.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>