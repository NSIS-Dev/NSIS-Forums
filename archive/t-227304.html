<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" debian package advice re System.dll, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  debian package advice re System.dll NSIS Discussion" />
	
	<title> debian package advice re System.dll [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  debian package advice re System.dll</div>
<hr />
<div class="pda"><a href="t-227304.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=227304">debian package advice re System.dll</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">30th September 2005, 09:50</div></div><div class="posttext">I've found that if I strip out the code related to System::Call from System.dll, then I can build the dll fine. This results in a fairly crippled System.dll that can't be used in the examples that rely on System.dll, because most of these use System::Call as well as the other functions.<br />
<br />
Do people think that the System.dll functions Alloc, Free, Copy, Store and Int64Op are worth shipping a crippled System.dll in debian?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">30th September 2005, 12:02</div></div><div class="posttext">System::Call is the heart of the plug-in. I think a better idea would be to use some program that converts the ASM code. GCC just wants a different syntax...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">30th September 2005, 20:14</div></div><div class="posttext">Do you know of any such program? Or some document comparing the two syntaxes?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">30th September 2005, 23:14</div></div><div class="posttext">I don't know such a program. The two syntaxes are Intel's and AT&amp;T's, as far as I remember. There's also a different in block identifier and type (__asm {mov eax, 1} vs. asm(&quot;mov %eax, 1&quot;)). I don't remember which names goes to which syntax.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">1st October 2005, 02:49</div></div><div class="posttext">Suppose I manage to translate the assembly to AT&amp;T syntax, how will this be managed? Will the Intel version change often enough for the AT&amp;T version to become out of sync?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">1st October 2005, 06:45</div></div><div class="posttext">OK, converted most of the assembly to gcc syntax. I'm getting 3 errors:build/release/System/Source/System.o:System.c:(.text+0x116f): undefined reference to `proc'<br />
build/release/System/Source/System.o:System.c:(.text+0xf43): undefined reference to `alloca_probe'<br />
build/release/System/Source/System.o:System.c:(.text+0x10b2): undefined reference to `__LOCAL_SIZE'The first is because I don't know how to refer to function parameters in gcc asm.<br />
<br />
The second is because I don't know how to refer to functions in gcc asm.<br />
<br />
The third seems to be because the code relies on MSVC's stack layout: http://msdn.microsoft.com/library/default.asp?url=/library/en-us/vccelng/htm/msmod_15.asp<br />
<br />
I think it might be easier to strip out all the assembly and write it in C. Any idea if this would be possible?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">1st October 2005, 11:36</div></div><div class="posttext">It seems impossible to strip it all out. How do you push a variable number of parameters to a function when the number is set at runtime? How do you create a __stdcall function that accepts a variable number of arguments?<br />
<br />
The Intel version will probably not change much, but it'd be better to have a script that automatically converts prior to compiling.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">11th October 2005, 06:03</div></div><div class="posttext">I wrote a script that gets most of the way to an AT&amp;T version, but the remaining 10% (needed for proper comilation) would require implmenting a proper assembly tokeniser. I think it would be much easier to just stick ifdefs around the place and add the AT&amp;T version too.<br />
<br />
Would this be acceptable? If so, I hope to get it done in time for inclusion in 2.11.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">11th October 2005, 12:33</div></div><div class="posttext">Were you able to get around __LOCAL_SIZE and alloca?<br />
<br />
An ifdef is acceptable. Of course, a conversion script is always preferable.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">11th October 2005, 15:58</div></div><div class="posttext">Nope, not yet able to port __LOCAL_SIZE and alloca. I'll keep digging though.<br />
<br />
Cool, I'll get working on the ifdefs.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">12th October 2005, 10:35</div></div><div class="posttext">In wine, alloca_probe just subtracts the value in eax from esp:<br />
<br />
http://cvs.winehq.org/cvsweb/wine/dlls/ntdll/rtl.c?rev=HEAD&amp;content-type=text/x-cvsweb-markup<br />
<br />
Also found a mention of gcc/__LOCAL_SIZE together:<br />
<br />
http://66.102.7.104/search?q=cache:GvAF-ein9HcJ:www.eelab.usyd.edu.au/tornado/docs/gnu2.96%2Bpentium/gcc.html+__LOCAL_SIZE+__GNUC__&amp;hl=en</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">12th October 2005, 12:17</div></div><div class="posttext">I don't know how WINE handles alloca, but it's more than just subtracting a value from ESP. All references to local variables should be offseted once the value of ESP changes.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">13th October 2005, 05:15</div></div><div class="posttext">OK.<br />
<br />
Another problem - gcc does not support the naked attribute on pe-i386. You can read a flamewar about that here:<br />
<br />
http://gcc.gnu.org/ml/gcc/2004-02/msg00939.html<br />
http://gcc.gnu.org/ml/gcc/2004-02/threads.html#00939<br />
<br />
More links:<br />
<br />
http://www.winehq.org/hypermail/wine-devel/2004/03/0408.html<br />
http://gcc.gnu.org/onlinedocs/gcc/Function-Attributes.html#Function%20Attributes<br />
http://www.cs.cornell.edu/courses/cs412/2001sp/resources/microsoft-calling-conventions.html<br />
<br />
Hmm, perhaps the cdecl function attribute is the appropriate one to use?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">13th October 2005, 12:50</div></div><div class="posttext">cdecl is not quite the same thing as naked. It does less than stdcall because it doesn't clean up the stack, but it still initializes the stack in the epilog and uninitializes it in the prolog. It also probably pushes registers and makes room for the local variables. At least you won't need __LOCAL_SIZE...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">14th October 2005, 04:56</div></div><div class="posttext">OK, I'll try that and see if it works.<br />
<br />
BTW, this might take a while, so feel free to release in the meantime.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">16th November 2005, 21:34</div></div><div class="posttext">Couple of things I found, that might be helpful:<br />
<br />
http://wiki.bfh.ch/index.php/Inline_Assembler_with_the_GCC<br />
http://www.niksula.cs.hut.fi/~mtiihone/intel2gas/</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">18th January 2006, 05:37</div></div><div class="posttext">Not sure if I'll be able to finish this any time soon. I've attached the current unfinished patch for anyone who wants to work on this.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">16th March 2008, 04:22</div></div><div class="posttext">A Debian user is working on converting the code to pure GCC assembly so that System::Call can be compiled on Linux and other non-Windows operating systems.<br />
<br />
http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=319999#40</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">28th October 2008, 01:15</div></div><div class="posttext">Hi all, I've received a patch for full System::Call support on Linux. It changes how System.dll is compiled on Windows and therefore needs testing on Windows too. Please test gcc-system-call-2.patch from here:<br />
<br />
http://sf.net/support/tracker.php?aid=2193442<br />
<br />
Those of you who build NSIS on Windows using the scons build scripts, I'd be grateful if you could test it. Please also test any installers you can create with it too. The example nsi files from NSIS work fine with it, but it might break some other installer and I don't want any regressions.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">7th November 2008, 02:59</div></div><div class="posttext">BUMP!<br />
<br />
Someone, anyone, please test the latest version of the patch (gcc-system-call-3.patch).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th November 2008, 22:59</div></div><div class="posttext">Builds fine and the example seems to work fine.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pabs</div><div class="date">8th November 2008, 00:49</div></div><div class="posttext">Cool, thanks for testing.<br />
<br />
Did you want to review the patch before I commit it?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">8th November 2008, 12:02</div></div><div class="posttext">I want to give it a very good look before it's committed.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">29th November 2008, 22:35</div></div><div class="posttext">Committed and will be included in the next version - 2.42.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>