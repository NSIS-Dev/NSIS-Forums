<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Deleting Folders After Reboot?, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Deleting Folders After Reboot? NSIS Discussion" />
	
	<title> Deleting Folders After Reboot? [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Deleting Folders After Reboot?</div>
<hr />
<div class="pda"><a href="t-128974.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=128974">Deleting Folders After Reboot?</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">petersa</div><div class="date">19th March 2003, 01:01</div></div><div class="posttext">Hi guys — long time, no see.<br />
<br />
I have a project that I'm working on, that requires me to delete a folder that I have placed in the TEMP folder. I need to delete it on reboot, because while NSIS may think it's no longer in use, it may still be in use until then (it contains a website).<br />
<br />
I remember a topic similar to this a long time ago, found here (http://forums.winamp.com/showthread.php?threadid=69604), but it never really got anywhere.<br />
<br />
So I've been trying to figure out how to add an entry to the WININIT.INI file, and I have come up with this script:<br />
<br />
OutFile Pricelessware.exe<br />
<br />
; these are purely cosmetic<br />
Caption Pricelessware<br />
SubCaption 2 ' '<br />
InstProgressFlags Smooth<br />
WindowIcon Off<br />
AutoCloseWindow True<br />
ShowInstDetails NeverShow<br />
<br />
Function .onInit<br />
<br />
  ; find a filename that is guaranteed not to exist<br />
    GetTempFileName $0<br />
<br />
  ; since this file is automatically created by<br />
  ; NSIS, delete it and recreate it as a folder<br />
    Delete $0<br />
    SetOutPath $0<br />
<br />
FunctionEnd<br />
<br />
Function AdjustStatusMessage<br />
<br />
  ; adjust the status message (doesn't work from .onInit)<br />
    DetailPrint 'Extracting website...'<br />
    SetDetailsPrint None<br />
<br />
FunctionEnd<br />
<br />
Section<br />
<br />
    Call AdjustStatusMessage<br />
<br />
  ; copy the website to the previously created folder<br />
    File /R Website\*.*<br />
<br />
SectionEnd<br />
<br />
Function .onInstSuccess<br />
<br />
  ; launch the website's main page<br />
  ExecShell '' $0\INDEX.HTM<br />
<br />
  ; the rest of this function's code adds an entry to<br />
  ; WININIT.INI to remove the website folder on reboot<br />
<br />
  ; create a file with a unique name<br />
    GetTempFileName $1<br />
<br />
  ; add an entry for the website folder to WININIT.INI<br />
  ; as ‘[name of unique file]=[path to WININIT.INI]’<br />
  ; (required in case a NUL entry already exists - it would be overwritten<br />
    WriteINIStr $WINDIR\WinInit.ini Rename $1 $0<br />
<br />
  ; open WININIT.INI and this unique file for I/O<br />
    FileOpen $2 $WINDIR\WinInit.ini R<br />
    FileOpen $3 $1 W<br />
<br />
Copy:<br />
<br />
  ; read a line of WININIT.INI<br />
    FileRead $2 $4<br />
<br />
  ; if there aren't any other lines then we're done<br />
    IfErrors Done<br />
<br />
  ; check if this line is the one we wrote in before<br />
    StrCmp $4 $1=$0$\r$\n ChangeIt<br />
<br />
  ; if it isn't then mimic it to the unique file<br />
    FileWrite $3 $4<br />
    GoTo Copy<br />
<br />
ChangeIt:<br />
<br />
  ; if it is then change [name of unique file] to NUL<br />
    FileWrite $3 NUL=$0$\r$\n<br />
<br />
GoTo Copy<br />
<br />
Done:<br />
<br />
  ; finish I/O processing<br />
    FileClose $2<br />
    FileClose $3<br />
<br />
  ; replace the original WININIT.INI file with its proper copy<br />
    Delete $WINDIR\WinInit.ini<br />
    Rename $1 $WINDIR\WinInit.ini<br />
<br />
FunctionEnd<br />
<br />
Function .onInstFailed<br />
<br />
    RMDir /R $0<br />
<br />
FunctionEndAs you can see, the code is quite complex (or it seems to be for such a trivial task), so the question is this: does anyone know of a more efficient way of achieving what this script does? By the way, I'm using NSIS v1.98.<br />
<br />
And before anyone asks, I've split it up into functions (.onInit, AdjustStatusMessage, .onInitSuccess) to have the status bat at 0% before it copies files, and 100% afterwards.<br />
<br />
Thanks, guys.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">19th March 2003, 11:57</div></div><div class="posttext">Windows NT/2000/XP do not use Wininit.ini, so it won't work.<br />
<br />
RmDir /REBOOTOK is on the TODO list for the next beta version of NSIS 2.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">petersa</div><div class="date">19th March 2003, 12:22</div></div><div class="posttext">Originally posted by Joost Verburg<br />
Windows NT/2000/XP do not use Wininit.ini, so it won't work.Damn. Not happy! :(<br />
<br />
Does anyone know how to do that NT functionality using NSIS instructions? Because RMDir /RebootOK is not what I'm looking for — there can't be any chance of the folder being deleted, until reboot.<br />
<br />
By the way, would the code above definitely work for Win9x systems? :D<br />
<br />
Thanks,<br />
Alex</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">19th March 2003, 12:29</div></div><div class="posttext">/REBOOTOK tries to delete and if it's in use, it will be deleted on reboot. Delete /REBOOTOK works this way, support for RmDir /REBOOTOK will be added soon.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">petersa</div><div class="date">19th March 2003, 12:39</div></div><div class="posttext">The problem is, the files will appear to NSIS to not be in use, when in fact they are.<br />
<br />
What I'm trying to do is create a sort of self-extracting website. It extracts its HTML and pictures to a temporary folder and then launches INDEX.HTM, and then quits.<br />
<br />
Because Internet Explorer doesn't lock the files while it's using them (let alone its folder), NSIS would happily delete the files when it hits the Delete instruction, and then you click a link in the webpage and get a 404.<br />
<br />
So if anyone knows how to simulate an ‘uh-oh, the folder is locked, let's queue it for deletion on reboot’ scenario on NT systems, using NSIS instructions, then I'd be so grateful, that... yeah.<br />
<br />
Cheers,<br />
Alex</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">19th March 2003, 12:50</div></div><div class="posttext">Wininit.ini does not accept long file names, so that could be another problem.<br />
<br />
What are trying to do? Why not remove the files when the installer is being closed (use the pluginsdir)?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">petersa</div><div class="date">19th March 2003, 13:04</div></div><div class="posttext">Originally posted by Joost Verburg<br />
Wininit.ini does not accept long file names, so that could be another problem.Luckily enough, GetTempFileName only spits out short file names. So I don't need to worry about that.<br />
<br />
Originally posted by Joost Verburg<br />
What are trying to do? Why not remove the files when the installer is being closed (use the pluginsdir)?I'm trying to create an EXE that extracts a folder to the temporary directory, runs an item in this folder and then exits.<br />
<br />
I can't remove the folder when the installer is being closed because all of the folder's contents need to be available until Windows reboots, because the user may want to call upon one of the files within.<br />
<br />
Because I am not sure of what browser will be used, I can't wait for the browser to close and then delete the files. The only safe way of performing this task (as far as I can see) is having the files delete on the next reboot.<br />
<br />
Luckily, a friend of mine has given me an idea: placing an uninstaller in this temporary folder and getting the uninstaller to run on the next reboot. This should solve the problem.<br />
<br />
Alex</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">19th March 2003, 13:34</div></div><div class="posttext">Another possibility is to get the registered browser for HTML files from the registry and call it using ExecWait.<br />
<br />
NT stores the delete tasks somewhere in there registry, I'm sure you can find more information about that with Google.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">virtlink</div><div class="date">19th March 2003, 13:43</div></div><div class="posttext">Why not create another, silent, installer that deletes the folder and contents. You can make the installer be run at startup, and only once by creating a key at the registry key 'HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce'.<br />
Note: The key for Windows NT/2000/XP might be a little different.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">19th March 2003, 13:52</div></div><div class="posttext">If I remeber correctly, the key is the same for NT.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">petersa</div><div class="date">19th March 2003, 13:55</div></div><div class="posttext">Thanks, Joost and virtlink; both of those ideas sound great.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>