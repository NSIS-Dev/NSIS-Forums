<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Reboot crash?, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Reboot crash? NSIS Discussion" />
	
	<title> Reboot crash? [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Reboot crash?</div>
<hr />
<div class="pda"><a href="t-113748.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=113748">Reboot crash?</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">jbm</div><div class="date">11th November 2002, 22:03</div></div><div class="posttext">Hi Everyone,<br />
<br />
Has anyone run into problems with the Reboot command in NSIS 1.98?  I'm basically doing the following at the end of my Uninstall section for a product we'll be shipping soon:<br />
<br />
    IfRebootFlag lbl_reboot lbl_noboot<br />
        MessageBox MB_OK $0<br />
        Return<br />
    lbl_reboot:<br />
        MessageBox MB_YESNO $0 IDNO lbl_noboot<br />
        Reboot<br />
    lbl_noboot:<br />
<br />
Thanks for any input, or maybe comments on side effects of other things I may be doing that would cause problems with this.  I am using DLLs fairly extensively, but have not had any problems with them.<br />
<br />
Thanks,<br />
<br />
Jim</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jbm</div><div class="date">11th November 2002, 22:47</div></div><div class="posttext">More details:<br />
<br />
I used the NSIS template generator and made a minimal uninstaller which does a Reboot at the end and it works fine, so it's something about my customization.<br />
<br />
I compiled up a debug version of NSIS with VC7 and am debugging the exehead of my generated uninstaller.  I'm crashing in the EW_REBOOT switch of ExecuteEntry() at the indirected call to OpenProcessToken().<br />
<br />
I get an &quot;ESP not restored&quot; error.  The args look good.  More details coming if I find anything...<br />
<br />
Jim</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jbm</div><div class="date">11th November 2002, 23:38</div></div><div class="posttext">Okay, I appear to have fixed it with the following changes to exehead\exec.c, on or near line 928:<br />
<br />
<br />
          BOOL (*OPT)(HANDLE, DWORD,PHANDLE);<br />
          BOOL (*LPV)(LPCTSTR,LPCTSTR,PLUID);<br />
          BOOL (*ATP)(HANDLE,BOOL,PTOKEN_PRIVILEGES,DWORD,PTOKEN_PRIVILEGES,PDWORD);<br />
<br />
those declarations get WINAPI added to them:<br />
<br />
          BOOL (WINAPI *OPT)(HANDLE, DWORD,PHANDLE);<br />
          BOOL (WINAPI *LPV)(LPCTSTR,LPCTSTR,PLUID);<br />
          BOOL (WINAPI *ATP)(HANDLE,BOOL,PTOKEN_PRIVILEGES,DWORD,PTOKEN_PRIVILEGES,PDWORD);<br />
<br />
I don't know why this isn't causing a problem all the time, maybe in the way the stack gets cleaned up in this particular context.<br />
<br />
VC7 will open and convert the .dsw file included in the 1.98 source just fine and build it with no problems, it flags the problem with a runtime check in the debugger.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jbm</div><div class="date">12th November 2002, 00:05</div></div><div class="posttext">Okay, beat me with a wet noodle:<br />
<br />
http://sourceforge.net/tracker/index.php?func=detail&amp;aid=620014&amp;group_id=22049&amp;atid=373085</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">12th November 2002, 11:33</div></div><div class="posttext">Please check wheather the latest NSIS 2 development version gives the same problem.<br />
<br />
Another question:<br />
<br />
Can you try to compile the NSIS 2 using VC7 and check wheather the VC7 compiler can make the installer smaller?<br />
<br />
Thanks</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">12th November 2002, 18:04</div></div><div class="posttext">Does this happen with the pre-built NSIS or only with a version built by VC7?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">12th November 2002, 18:19</div></div><div class="posttext">Hmm... Beat me with a wet noodle? It is __stdcall... =/<br />
That's weird... I was sure it was __cdecl... It does work when I add WINAPI which is __stdcall.<br />
<br />
I have changed this in the CVS, god knows why it worked up until now even though the default calling convention is __cdecl.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jbm</div><div class="date">13th November 2002, 07:29</div></div><div class="posttext">I'm not on 2.0 yet, we're pulling our hair out trying to get our next Beta release out the door, but I will soon after that, in the next few weeks.<br />
<br />
The crash I was seeing was with the pre-built, released version of 1.98, and reproduced after I compiled and built it in VC6.  Originally, all I wanted was to turn logging on, but it got me comfortable with where things were, and so was able to track the problem down.<br />
<br />
It was working for me on '98 too, just not on '2K/XP, and I couldn't explain that.  But I guess I'm always surprised by what things are strict/lenient on all the flavors of Windows.  I pulled out VC7 because it has the easy interface to the remote/attached debugging, which helps with the way the uninstaller spawns itself.<br />
<br />
Thank you for all the work you've done on this installer, it's made our downloads leaner, and its transparency has made my life easier.  I'll be looking to do the MUI update in 2.0 soon, and getting the updated DLL interface (I've got a half-dozen).<br />
<br />
Jim - http://www.cerience.com</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">13th November 2002, 17:46</div></div><div class="posttext">It was working for me on '98 too, just not on '2K/XP, and I couldn't explain that.<br />
<br />
Windows 9x doesn't use those functions, that's why.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>