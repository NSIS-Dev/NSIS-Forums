<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" User account manipulation, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  User account manipulation NSIS Discussion" />
	
	<title> User account manipulation [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  User account manipulation</div>
<hr />
<div class="pda"><a href="t-273134.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=273134">User account manipulation</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">hamster.powered</div><div class="date">20th June 2007, 14:20</div></div><div class="posttext">Ok... so I have my installer doing most of what it needs to do.  But as part of the process I need to create and configure a new windows user account.<br />
<br />
I am able to create the account, but then I cannot configure it, because I cannot seem to find a way to make windows create the new user's profile folder and registry hive.  I know that this usually requires a human @ keyboard login to happen, but have found several places where people supposedly have programmatical ways to accomplish it.<br />
<br />
So far though, none seem to work.  Has anyone here managed to make this work?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">20th June 2007, 15:45</div></div><div class="posttext">CancerFace put up this very extensive page:<br />
http://nsis.sourceforge.net/User_Management_using_API_calls<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">hamster.powered</div><div class="date">20th June 2007, 16:55</div></div><div class="posttext">I had already found that page, and it does have lots of good stuff.  But my user creation is already working.  What's got me stumped is a way to prod windows into initializing all the user's local stuff (reg. hive, personal folders, desktop, etc.) once I've created it.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">20th June 2007, 21:12</div></div><div class="posttext">Have a look at this (http://isg.ee.ethz.ch/tools/realmen/det/skel.en.html) page. It explains a bit the process of getting a profile upon your first logon. Although the above page refers to a domain setup the same things apply to your local station.<br />
<br />
I would think, without having tested this, that once you create the account, you should be able to impersonate the user calling LogonUser (http://msdn2.microsoft.com/en-us/library/aa378184.aspx) and use the resulting token in order to manually generate/edit the profile of this user. I am not sure if LogonUser will in fact copy the profile of the new user to the right place though.<br />
<br />
What I have done in the past in a domain (and I do not see a reason why it should not work on a standalone PC) after creating the account, is to copy manually the default user profile to the new user's profile directory, apply ownership to the new user, then edit the user hive and change ownership + replace certain values in the registry to reflect the new username. All this with the build in windows tools (xcopy, cacls, subinacl, reg) and rather easy cmd scripts ... I am sure all this can be achieved with fancy API calls within an NSIS installer :)<br />
<br />
Hope this helps,<br />
CF</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jazzcat</div><div class="date">2nd October 2007, 18:10</div></div><div class="posttext">Is there anything over and above getting the machine name and calling the CreateUser macro?<br />
<br />
If creating the user does not work (i.e. the new user does not appear in the Manage Computer console after Refreshing the view after running the installer), how do I go about debugging it?<br />
<br />
Cheers,<br />
jc</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CancerFace</div><div class="date">2nd October 2007, 22:00</div></div><div class="posttext">The macros should work, unless you are calling them using an account with limited privileges. (I hope you are not trying this in 95/98/ME by the way)<br />
<br />
Try adding some error checking after every API call. For example if you call NetUserAdd (http://msdn.microsoft.com/library/default.asp?url=/library/en-us/netmgmt/netmgmt/netuseradd.asp) get the error code as well:...<br />
System::Call 'netapi32::NetUserAdd(w &quot;${SERVER_NAME}&quot;,i 1,i R0,*i.r0) i.r1 ?e'<br />
Pop $9<br />
...and check to see what it is, in case the call fails <br />
<br />
CF</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>