<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" NSIS Start Menu problem, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  NSIS Start Menu problem NSIS Discussion" />
	
	<title> NSIS Start Menu problem [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  NSIS Start Menu problem</div>
<hr />
<div class="pda"><a href="t-278719.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=278719">NSIS Start Menu problem</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">eoin</div><div class="date">11th October 2007, 17:02</div></div><div class="posttext">Hi, <br />
<br />
I'm writing an installer for an application that customers may want to install multiple times.<br />
<br />
I'm trying to check the install directory and start menu folder to ensure that the customer does not overwrite an existing installation (they can't anyway as the installer has overwrite is set to off - but I want a visible warning and the ability to change the install dir)<br />
<br />
I use the pre and leave functions with MUI to check the selected install dir and start menu folder. The former works fine - $INSTDIR gets the value of the selected install dir and the LEAVE function uses that in its test. However, but the start menu checks don't work as the path entered in the start menu dialog doesn't get written into the start menu variable (MUI_PAGE_STARTMENU page_id variable)<br />
<br />
The attached file is a stripped down version of the installer - it's just intended to show the problem. <br />
<br />
To test it:<br />
1. Create a folder call Batch in the same folder as the script. Put a few files in it. <br />
2. Compile the script<br />
3. Run the resulting setup - the app gets installed in the default install dir and start menu folder.<br />
4. Run the setup again. <br />
5. If you specify the default install dir you'll get a warning. <br />
6. Change the install dir - that works ok.<br />
7. Specify the default start menu folder - again you get a warning. <br />
8. Change the start menu folder. The changed value does not get picked up. <br />
9. Click on the back button and then on the Next button. This time the value of the start menu folder is correctly picked up by the installer. <br />
<br />
Am I doing something wrong?<br />
If not, is there a workaround?<br />
<br />
I tried an invisble custom installer page directly after the start menu page. This picked up the user-specified value of the start menu folder but I couldn't work out how to send the installer back to the start menu page (so user could reenter start menu folder value)<br />
<br />
I also tried the getDlgValue to get the control id the page element that contains the start menu folder string - but there doesn't seem to be a method for reading the actual value when you know the control id. <br />
<br />
Finally, had a look inside system.nsh in NSIS\Contrib\Modern UI. Can't see where the dialog value for the start menu folder is picked up. <br />
<br />
Thanks,<br />
Eoin</div></div><hr />


<div class="post"><div class="posttop"><div class="username">eoin</div><div class="date">12th October 2007, 15:25</div></div><div class="posttext">Got a workaround<br />
<br />
1. Got the RelGotoPage function from  http://nsis.sourceforge.net/Go_to_a_NSIS_page#Modern_UI<br />
<br />
2. After the start menu page, created another MUI_PAGE_DIRECTORY page - and gave it a custom PRE function. <br />
That PRE function looks like:<br />
<br />
Function CheckStartMenuFolder<br />
<br />
    MessageBox MB_OK &quot;Inventory type: $INVENTORY_TYPE&quot;<br />
<br />
    ReadRegStr $1 &quot;${STARTMENUPAGE_REGISTRY_ROOT}&quot; &quot;${STARTMENUPAGE_REGISTRY_KEY}&quot; &quot;${STARTMENUPAGE_REGISTRY_VALUENAME}&quot;<br />
    <br />
    MessageBox MB_OK &quot;Selected Start Menu: $STARTMENU_FOLDER&quot;<br />
    MessageBox MB_OK &quot;Existing Start Menu folder: $1&quot;<br />
    <br />
    ${if} $1 == $STARTMENU_FOLDER<br />
        MessageBox MB_OK &quot;There is already an asset gateway using this Start Menu folder.$\nChoose another location for this installation or uninstall the existing gateway.&quot;<br />
        ; Go back a page (to the start menu page)<br />
        StrCpy $R9 -1<br />
        Call RelGotoPage<br />
        Abort<br />
    ${Else}<br />
        ; Go forward a page (skip this page)<br />
        StrCpy $R9 1<br />
        Call RelGotoPage<br />
        Abort       <br />
    ${EndIf}    <br />
FunctionEnd<br />
<br />
The extra MUI_PAGE_DIRECTORY page never appears. You either go back to the start menu page or forward to the next page.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">eoin</div><div class="date">12th October 2007, 15:42</div></div><div class="posttext">Um, best not to use MUI_PAGE_DIRECTORY as the extra, invisible  page. It seems to clear the install folder value entered earlier in the real, visible MUI_PAGE_DIRECTORY. <br />
<br />
Switched to using MUI_PAGE_WELCOME instead. That works ok.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">12th October 2007, 16:11</div></div><div class="posttext">Just use Page Custom CustomDummy for an invisible page.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">eoin</div><div class="date">15th October 2007, 15:57</div></div><div class="posttext">Ok - works nicely. Thanks!</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>