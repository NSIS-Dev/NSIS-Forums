<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Is there a InstallDirRegKey analog for $APPDATA, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Is there a InstallDirRegKey analog for $APPDATA NSIS Discussion" />
	
	<title> Is there a InstallDirRegKey analog for $APPDATA [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Is there a InstallDirRegKey analog for $APPDATA</div>
<hr />
<div class="pda"><a href="t-333673.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=333673">Is there a InstallDirRegKey analog for $APPDATA</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Ron.Stordahl</div><div class="date">16th August 2011, 17:40</div></div><div class="posttext">I am updating an existing installer for Vista/Windows 7 which currently was designed for XP and below.  For the installation directory I use this code:<br />
<br />
InstallDir &quot;$PROGRAMFILES\${PRODUCT_NAME}&quot;<br />
InstallDirRegKey HKLM &quot;${PRODUCT_DIR_REGKEY}&quot; &quot;&quot;<br />
<br />
For the application data directory I use this:<br />
<br />
StrCpy $ApplicationDataPath $APPDATA\${PRODUCT_NAME}<br />
<br />
Is there an analog to InstallDirRegKey for the application data path?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">16th August 2011, 19:27</div></div><div class="posttext">No but you can make your own by using the registry functions in .oninit</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Ron.Stordahl</div><div class="date">16th August 2011, 21:14</div></div><div class="posttext">Do you know where in the registry the information read by InstallDirRegKey is located?  I have been unable to locate it. My installer is finding it, but where it is finding it I don't know. If it is any help I currently have these lines which might be a clue:<br />
<br />
!define PRODUCT_DIR_REGKEY &quot;Software\Microsoft\Windows\CurrentVersion\App Paths\BPQ32.exe&quot;<br />
.<br />
InstallDirRegKey HKLM &quot;${PRODUCT_DIR_REGKEY}&quot; &quot;&quot;<br />
.<br />
WriteRegStr HKLM &quot;${PRODUCT_DIR_REGKEY}&quot; &quot;&quot; &quot;$INSTDIR\BPQ32.exe&quot;<br />
<br />
I remove the entry in the uninstall:<br />
<br />
DeleteRegKey HKLM &quot;${PRODUCT_DIR_REGKEY}&quot;<br />
<br />
Incidentlaly in Vista/Windows 7 I will be installing for the current user, so is it safe to assume that for those HKLM should be HKCU?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">16th August 2011, 21:37</div></div><div class="posttext">Where? You are telling it where to look with InstallDirRegKey lol</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Ron.Stordahl</div><div class="date">16th August 2011, 22:02</div></div><div class="posttext">Yes you are right of course!  What is contained there in the registry is:<br />
<br />
default  REG_SZ  C:\Program Files\BPQ32\BPQ32.exe<br />
<br />
I see now that the command InstallDirRegKey will remove BPQ32.exe leaving just the path.  Apparently it was pointless to include \BPQ32.exe in the WriteRegStr to start with.<br />
<br />
Thanks again for your help, it has been very valuable for one just learning!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Ron.Stordahl</div><div class="date">22nd August 2011, 15:16</div></div><div class="posttext">This it would seem would be written in the registry at the HKLM root key, however what is actually happening is that for XP it is written at HKLM, but for Windows 7 it is written at HKCU.<br />
<br />
WriteRegStr HKLM &quot;${PRODUCT_DIR_REGKEY}&quot; &quot;&quot; &quot;$INSTDIR\BPQ32.exe&quot;  <br />
<br />
Any idea of why this is happening?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">22nd August 2011, 16:15</div></div><div class="posttext">Could be that win7 is &quot;fixing&quot; your installer because it's trying to write to HKLM without having admin access. Add &quot;requestexecutionlevel admin&quot; and use the userinfo plugin in .onInit to verify that you have admin (and throw an error and quit if you don't).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Ron.Stordahl</div><div class="date">22nd August 2011, 18:19</div></div><div class="posttext">I already had &quot;requestexecutionlevel admin&quot;.<br />
<br />
I added the following in .onInit:<br />
<br />
# call userInfo plugin to get user info.  The plugin puts the result in the stack<br />
    userInfo::getAccountType<br />
    # pop the result from the stack into $0<br />
    pop $0 <br />
    # compare the result with the string &quot;Admin&quot; to see if the user is admin.<br />
    # If match, jump 3 lines down.<br />
    strCmp $0 &quot;Admin&quot; +3 <br />
    # if there is not a match, print message and return<br />
    messageBox MB_OK &quot;not admin: $0&quot;<br />
    return <br />
    # otherwise, confirm and return<br />
    messageBox MB_OK &quot;is admin&quot;<br />
 <br />
<br />
When running the created installer it reports &quot;is admin&quot;.<br />
<br />
So there is more to it apparently.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Ron.Stordahl</div><div class="date">22nd August 2011, 19:15</div></div><div class="posttext">That was kind of ugly...here is the actual code I am using to do the test:<br />
<br />
  userInfo::getAccountType	Check to see if we have gained administrative priv.   <br />
  pop $0<br />
  ${If} $0 == &quot;Admin&quot;<br />
    messageBox MB_OK &quot;is admin&quot; <br />
  ${Else}<br />
    messageBox MB_OK &quot;not admin: $0&quot;<br />
  ${Endif}<br />
<br />
The resulting messagebox displays &quot;is admin&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">22nd August 2011, 20:04</div></div><div class="posttext">Use Process Monitor to see what happens to the reg write...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">22nd August 2011, 22:01</div></div><div class="posttext">here is the actual code I am using to do the test:<br />
<br />
  userInfo::getAccountType	Check to see if we have gained administrative priv.   <br />
  pop $0<br />
  ${If} $0 == &quot;Admin&quot;<br />
    messageBox MB_OK &quot;is admin&quot; <br />
  ${Else}<br />
    messageBox MB_OK &quot;not admin: $0&quot;<br />
  ${Endif}<br />
<br />
<br />
Note: The above code is correct, but only for testing purposes. However, you need to use this code in your final installer as well, because 'requestexecutionlevel' does nothing if UAC is disabled, or on older OS versions... For that, you need to actually call the abort (or quit) command if the user isn't admin.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Ron.Stordahl</div><div class="date">23rd August 2011, 20:20</div></div><div class="posttext">I am using the following code to install a DLL:<br />
<br />
!insertmacro InstallLib DLL SHARED REBOOT_PROTECTED &quot;..\BPQ32\Files\BPQ32.dll&quot; $SYSDIR\BPQ32.dll $SYSDIR<br />
<br />
Is it safe to say that the user who is running this installer will need Administrator Privileges to install that DLL?  If so, then I will use the 'code' to test if the user has such privileges and if not, I will issue a message to that effect and abort.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">23rd August 2011, 21:48</div></div><div class="posttext">I am using the following code to install a DLL:<br />
<br />
!insertmacro InstallLib DLL SHARED REBOOT_PROTECTED &quot;..\BPQ32\Files\BPQ32.dll&quot; $SYSDIR\BPQ32.dll $SYSDIR<br />
<br />
Is it safe to say that the user who is running this installer will need Administrator Privileges to install that DLL?<br />
Yes. $SYSDIR is a protected directory, so you need admin privileges to write there.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Ron.Stordahl</div><div class="date">24th August 2011, 15:10</div></div><div class="posttext">How far back does that go?  XP, W2K, or is this just Vista and later?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">24th August 2011, 15:15</div></div><div class="posttext">All NT operating systems (NT, 2000, XP, Vista, etc..) have a protected $SYSDIR folder. The same applies to $WINDIR and $PROGRAMFILES, among others. (This means that if your default install directory is in program files and you don't check for admin access, your installer is kind of defective.)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>