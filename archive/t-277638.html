<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" RegDLL crashes installer, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  RegDLL crashes installer NSIS Discussion" />
	
	<title> RegDLL crashes installer [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  RegDLL crashes installer</div>
<hr />
<div class="pda"><a href="t-277638.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=277638">RegDLL crashes installer</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">inDeep7</div><div class="date">20th September 2007, 17:17</div></div><div class="posttext">I have an installer that needs to register several existing dlls.  I have tested it on different versions of Windows and it always crashes on RegDLL.  I have tried registering one of the four dlls, and it doesn't matter which one I pick it still crashes.  If I use ExecWait Regsvr32 it works fine.<br />
<br />
<br />
!include &quot;MUI.nsh&quot;<br />
<br />
Name &quot;DLL Registration&quot;<br />
OutFile &quot;DLL_setup.exe&quot;<br />
InstallDir &quot;C:\MYAPP&quot;<br />
<br />
!define MUI_ABORTWARNING<br />
!insertmacro MUI_PAGE_WELCOME<br />
!insertmacro MUI_PAGE_DIRECTORY<br />
!insertmacro MUI_PAGE_INSTFILES<br />
!insertmacro MUI_PAGE_FINISH<br />
!insertmacro MUI_LANGUAGE &quot;English&quot;<br />
<br />
Section &quot;Register DLLs&quot; SecRegisterDLL<br />
<br />
  SetOutPath $INSTDIR<br />
<br />
;  ExecWait &quot;regsvr32 /s $INSTDIR\MYAPP-2.dll &quot;<br />
<br />
<br />
  RegDLL $INSTDIR\MYAPP-1.dll<br />
;  RegDLL $INSTDIR\MYAPP-2.dll<br />
;  RegDLL $INSTDIR\MYAPP-3.dll<br />
;  RegDLL $INSTDIR\MYAPP-4.dll<br />
 <br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">21st September 2007, 16:04</div></div><div class="posttext">Are you sure regsvr32 really succeeds? Try without the /S flag. Also try registering the same DLL with regsvr32 and RegDLL.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dienjd</div><div class="date">21st September 2007, 18:08</div></div><div class="posttext">I once had an installer crash when registering a DLL. It was happening because the DLL had a dependency that was missing. You can run http://www.dependencywalker.com/ to see what dependencies the DLL has, and then have your installer install those before registering your DLL. Hopefully, that's what's causing it.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">inDeep7</div><div class="date">24th September 2007, 21:32</div></div><div class="posttext">Sorry for the delay in replying.  <br />
<br />
The DLLs do indeed register fine when using regsvr32 with or without the &quot;/s&quot; parameter.  I tested it manually from a command prompt and also using ExecWait from inside an installer and in both cases the registration succeeds.<br />
<br />
If I switch my installer over to using RegDLL, it still consistently crashes the installer with &quot;Not Responding&quot; in Task Manager.  <br />
<br />
Dependency Walker indicates &quot;Error opening file&quot; MSJAVA.DLL.  This dll is probably related in some way to the COBOL run-time that my DLLs are dependent upon.  I was unaware of this particular dependency and it has not created any problem in the past.  The application works fine when I register my DLLs manually or in a batch file.<br />
<br />
At this point I am planning on using RegSvr32, but I am curious why my installer crashes as opposed to just returning an error code.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">25th September 2007, 20:24</div></div><div class="posttext">Does it actually crash or just hangs? In any case, I'll need the DLL files to figure out why they do that, unless you can provide debugging information like a crash dump or at least a stack trace.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">inDeep7</div><div class="date">25th September 2007, 20:54</div></div><div class="posttext">Crashing is probably not the correct term.  It hangs or gets locked up.  The only way to recover is to End Task in Windows Task Manager.<br />
<br />
I could send you the dlls, but they are completely dependent on the COBOL runtime, so you would have to have the installed first.<br />
<br />
How do I send you a crash dump or stack trace?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">25th September 2007, 22:49</div></div><div class="posttext">The DLL files themselves would be better than a crash dump or a stack trace. So if you can send those, it'd be best. I'll handle the COBOL runtime.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">inDeep7</div><div class="date">26th September 2007, 16:16</div></div><div class="posttext">Thanks kichik.  Attached is one of the DLLs that is causing the problem.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">26th September 2007, 19:49</div></div><div class="posttext">I got the runtime DLL files from Futijsu, but all I could get them to do is kill every process they were loaded from with a message saying I didn't set them up correctly. Do you know where I can get a non-MSM installer that's not Futisju? I get around 1kb/s from that website...<br />
<br />
Alternatively, that crash dump seems more and more compelling... To generate it, run windbg (http://www.microsoft.com/whdc/devtools/debugging/default.mspx), attach it to the frozen installer and write .dump /ma C:\crash.dump in its command line.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">inDeep7</div><div class="date">26th September 2007, 21:08</div></div><div class="posttext">I'm pretty sure you have to use Fujitsu's proprietary COBOL runtime to make it work.<br />
<br />
I ran windbg and created the crash dump as you recommended.  However, the file is very large 30mb+ unzipped, about 11mb zipped.  Couldn't attach it to this forum message.  You can download it here (http://luc.adventist.org/lucis/crash.zip).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">27th September 2007, 13:48</div></div><div class="posttext">The COBOL runtimes don't seem to like the GUI. When registered, it tries to activate the runtime COM object using CoGetClassObject but not before it locks a critical section. COM tries to load the requested class in the GUI thread which in turn tries to lock the same critical section and freezes. The COM objects shouldn't lock critical sections this way in single-threaded apartments as COM should handle that internally.<br />
<br />
I've created a little program that should be able to reproduce it. Put lucis-2.dll next to it and run it. It should also freeze in the same manner. If it doesn't, let me know. If it does, you should post that as part of a support request to Fujitsu, or some COBOL forum.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">inDeep7</div><div class="date">27th September 2007, 17:04</div></div><div class="posttext">Thanks for all your help kickik.  I did test using your cobol.exe and it did indeed lockup.  I have a limited understanding of COM so I don't understand why the locking is causing a problem, but will pursue it with Fujitsu.  <br />
<br />
I am curious why the problem does not manifest itself when using regsvr32 which is what I am using to work around the issue.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">27th September 2007, 17:13</div></div><div class="posttext">regsvr32 doesn't have two threads. NSIS creates one thread for the GUI and another thread for executing the sections. The second thread calls RegDLL, loads the DLL and calls DllRegisterServer. The DLL, in turn, enters the critical section and tries to get an interface to the runtime using CoGetClassObject. COM does all the magic of loading the other DLL and getting the interface behind the scenes. Part of that magic is loading the DLL in the GUI thread using some windows messages. When the DLL is loaded in the GUI thread, it tries to enter the same critical sections the other thread already has locked. That's when the deadlock appears.<br />
<br />
As COM handles all the synchronization for single-threaded apartment, the critical section usage only gets in the way and results in this deadlock.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>