<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" How to call NSIS function from plugin via ExecuteCodeSegment, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  How to call NSIS function from plugin via ExecuteCodeSegment NSIS Discussion" />
	
	<title> How to call NSIS function from plugin via ExecuteCodeSegment [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  How to call NSIS function from plugin via ExecuteCodeSegment</div>
<hr />
<div class="pda"><a href="t-331275.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=331275">How to call NSIS function from plugin via ExecuteCodeSegment</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">T.Slappy</div><div class="date">6th June 2011, 14:36</div></div><div class="posttext">Hi<br />
I would like to execute my NSIS function TryMe from plugin (.dll).<br />
This is my NSIS code:<br />
<br />
Function TryMe<br />
  MessageBox MB_OK &quot;TryMe&quot;<br />
FunctionEnd<br />
<br />
Function LicensePage<br />
  GetDlgItem $0 $HWNDPARENT 1<br />
  GetFunctionAddress $2 TryMe # $2 Contains correct values, I checked it<br />
  Dll::Dll /NOUNLOAD $2<br />
  Pop $1<br />
FunctionEnd<br />
<br />
And this is my C++ code:<br />
<br />
<br />
extern &quot;C&quot; __stdcall void Dll(HWND hWndParent, int string_size,<br />
                             char *variables, stack_t **stacktop, extra_parameters *extra)<br />
{<br />
	DLL_INIT();<br />
<br />
..... some other code like popping HWND etc...<br />
<br />
	if(popstring(tmp)) {<br />
		extra-&gt;exec_flags-&gt;exec_error = TRUE;<br />
		return;<br />
	}<br />
	int iFunc = myatoi(tmp.c_str()); // HERE I GET THE SAME NUMBER<br />
 // AS IN ABOVE NSIS CODE - address of function<br />
<br />
	extra-&gt;ExecuteCodeSegment(iFunc, 0); // here I want <br />
// to execute my NSIS function, but it does nothing<br />
<br />
<br />
<br />
I checked everything severaltimes, iFunc is filled with correct value but nothing happens in extra-&gt;ExecuteCodeSegment.<br />
<br />
What I am doing wrong?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">6th June 2011, 14:39</div></div><div class="posttext">Needs to be iFunc - 1. I forget why.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">T.Slappy</div><div class="date">6th June 2011, 14:52</div></div><div class="posttext">Needs to be iFunc - 1. I forget why.<br />
<br />
Stu<br />
<br />
These hidden features are killing me!!!!!<br />
<br />
Big thanks, now it works fine!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">T.Slappy</div><div class="date">8th June 2011, 07:25</div></div><div class="posttext">I need that code for my new plugin ThreadTimer.<br />
<br />
ThreadTimer plug-in allows you to create simple Timer which runs in a separate thread. It is available since Start until Stop, it ticks in desired interval and calls NSIS function. It can be created for a whole life-cycle of installer because it is NOT tied with any installer page or nsDialogs page. <br />
<br />
See more on it's wiki page: http://nsis.sourceforge.net/ThreadTimer_plug-in<br />
<br />
Thanks to user bluenet whose Delay plugin gave me some ideas: showthread.php?postid=2350657 (http://forums.shoutcast.com/showthread.php?postid=2350657)<br />
<br />
Use this topic for questions/comments to this plugin. :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">8th June 2011, 07:29</div></div><div class="posttext">It's probably better to start a new thread about this plugin. The topic itself has nothing to do with timer plugins, so people aren't likely to find it easily.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">8th June 2011, 10:49</div></div><div class="posttext">Your DLL depends on MSVCRT90 which means the installer will crash on systems without it (e.g. machines without .NET 3.5).<br />
<br />
http://nsis.sourceforge.net/Building_plug-ins_without_Microsoft_Visual_C_Run-Time_%28MSVCRT%29_dependency<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">T.Slappy</div><div class="date">8th June 2011, 14:43</div></div><div class="posttext">Your DLL depends on MSVCRT90 which means the installer will crash on systems without it (e.g. machines without .NET 3.5).<br />
Stu<br />
<br />
Thanks for pointing that, I forgot to check it. I removed that dependency :)<br />
<br />
Also I updated this list with some of my ideas: http://nsis.sourceforge.net/Building_plug-ins_without_Microsoft_Visual_C_Run-Time_%28MSVCRT%29_dependency<br />
<br />
Hope it helps someone, I lost 2 hours with linker errors!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">8th June 2011, 20:09</div></div><div class="posttext">By the way in future when you upload files to the Wiki, don't put the version in the file name. You can put the version number as a comment and avoid multiple file names.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mrmls</div><div class="date">10th August 2011, 15:52</div></div><div class="posttext">I get  this error:<br />
Invalid command: ThreadTimer::Start<br />
<br />
I am using as from the example:<br />
ThreadTimer::Start /NOUNLOAD 2345 8 $2<br />
<br />
I have copied the dll to the NSIS/Plugins folder. <br />
What else have I missed? Other plugins are working fine. <br />
<br />
I am using Nsis 2.46 Special Build-Large strings (http://nsis.sourceforge.net/Special_Builds), does it make any difference?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">T.Slappy</div><div class="date">11th August 2011, 05:45</div></div><div class="posttext">@mrmls: Did the example work fine for you? Try to compile it and compare to your script.<br />
Plugin is not dependent on any NSIS version, so using Large strings build is fine.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mrmls</div><div class="date">11th August 2011, 15:04</div></div><div class="posttext">No, the example does not work, I copied and pasted it in a brand new install script (created by the wizard), but it does not compile. Returns the above message.<br />
When I comment out the line containing ThreadTimer commands, it compiles fine.<br />
<br />
I'm also on 64-bit OS (Windows 7), maybe this causes some issues.<br />
<br />
I will try to build the dll from provided source.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mrmls</div><div class="date">11th August 2011, 15:46</div></div><div class="posttext">Rebuilt the project on my computer, also on x64 configuration. Still the same error:<br />
Invalid command: ThreadTimer::Start<br />
<br />
I have ensured that I copy ThreadTimer.dll to right &quot;Plugins&quot; folder.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">demiller9</div><div class="date">11th August 2011, 17:02</div></div><div class="posttext">It looks to me like the plugin was compiled with the wrong options, the function names are 'decorated' and shouldn't be. Makensisw shows this when I put the release version dll into my plugins folder: - ThreadTimer::?Start@@YAXPAUHWND__@@HPADPAPAU_stack_t@@PAUextra_parameters@@@Z<br />
 - ThreadTimer::?Stop@@YAXPAUHWND__@@HPADPAPAU_stack_t@@PAUextra_parameters@@@Z<br />
 - dumpstate::debug<br />
 - metadl::download<br />
 - metadl::download_quiet<br />
 - nsMSCM::QueryStatus<br />
 - nsMSCM::Start<br />
 - nsMSCM::Stop<br />
 Only the first two lines are from the ThreadTimer dll, the others came from other plugins that were discovered. But you see the difference in the names.<br />
<br />
Don</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mrmls</div><div class="date">12th August 2011, 14:30</div></div><div class="posttext">Indeed, now I looked at that output too. <br />
Thanks a lot!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">T.Slappy</div><div class="date">5th October 2011, 07:05</div></div><div class="posttext">It looks to me like the plugin was compiled with the wrong options, the function names are 'decorated' and shouldn't be. Makensisw shows this when I put the release version dll into my plugins folder: - ThreadTimer::?Start@@YAXPAUHWND__@@HPADPAPAU_stack_t@@PAUextra_parameters@@@Z<br />
 - ThreadTimer::?Stop@@YAXPAUHWND__@@HPADPAPAU_stack_t@@PAUextra_parameters@@@Z<br />
 - dumpstate::debug<br />
 - metadl::download<br />
 - metadl::download_quiet<br />
 - nsMSCM::QueryStatus<br />
 - nsMSCM::Start<br />
 - nsMSCM::Stop<br />
 Only the first two lines are from the ThreadTimer dll, the others came from other plugins that were discovered. But you see the difference in the names.<br />
<br />
Don<br />
<br />
This is very interesting because I can see functions correctly - they are not decorated and NSIS recognize them correctly.<br />
When I analyse dll in DependencyWalker I can see functions correctly too - as C functions.<br />
Also I attached picture of .def file I made to have correct exports of these functions.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">5th October 2011, 10:50</div></div><div class="posttext">You are using a lot of CRT functions and for that reason you are still linking to it, even though you have disabled the manifest. As you have compiled with VC9 all machines will need .NET 3.5 or standalone MSCRT90 installed, which by no means will always be the case. The installer will crash.<br />
<br />
There is no need to use functions such as _beginthreadex and memset and you must not use the new operator. These are all functions/features that use or depend on the CRT. There are Win32 API alternatives such as CreateThread and LocalAlloc/GlobalAlloc (and you do not need to zero the memory if you use the right *Alloc options). Finally your exports are wrong. You are missing extern &quot;C&quot; from your function definitions. Also, if you decorate functions with __declspec(dllexport), you do not need a .def file. If you get your plug-in built without CRT it will be ~4KB rather than 55KB.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">T.Slappy</div><div class="date">10th October 2011, 13:21</div></div><div class="posttext">Thanks for all suggestions!<br />
I have removed all CRT calls and in Properties -&gt; Linker -&gt; Input I used &quot;Ignore All default libraries&quot; so plug-in is now only 4kB big, but I got a lot of linker errors which I solved by adding tlibc library from http://www.codeproject.com/KB/library/tlibc.aspx to solution.<br />
<br />
New version was uploaded  - 1.1 + sources on wiki, enjoy :)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>