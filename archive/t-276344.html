<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Function request, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Function request NSIS Discussion" />
	
	<title> Function request [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Function request</div>
<hr />
<div class="pda"><a href="t-276344.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=276344">Function request</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">23rd August 2007, 11:31</div></div><div class="posttext">I would like to request a function that is called when Abort is called in a section (or similar).<br />
<br />
Why? I'll answer that now. If the user minimizes the install, and it fails, you would never know about it. But with this function, you could restore the window to let the user know. I want to use it to unload my SpiderBanner plugin and show the original window, and show &quot;Install failed&quot; on the DetailPrint label.<br />
<br />
I don't have enough knowledge to implement this myself into NSIS, but if I figure it out before you guys, I will post a patch.<br />
<br />
Comments welcome.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">23rd August 2007, 15:36</div></div><div class="posttext">You could check if the window is minimized as the last instruction in your sections and then restore</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">23rd August 2007, 15:54</div></div><div class="posttext">!include LogicLib.nsh<br />
!include winmessages.nsh<br />
<br />
Section LastSection<br />
...<br />
System::Call 'user32::GetWindowLong(i $hwndparent,i -16)i.r0'<br />
IntOp $0 $0 &amp; 0x20000000<br />
${IfThen} $0 &gt; 0 ${|} ShowWindow $HWNDPARENT ${SW_RESTORE} ${|}<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">24th August 2007, 08:25</div></div><div class="posttext">True, but if the installer fails for some reason, execution stops at the current command (like using abort). So you code will not be executed, leaving the window minimized. Thats what I want my abort function for, so that your code is executed if it fails.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">24th August 2007, 08:34</div></div><div class="posttext">The leave function is still called. In there, you can use IfAbort.Function leave<br />
IfAbort 0 +2<br />
MessageBox MB_OK abort<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">24th August 2007, 09:08</div></div><div class="posttext">It appears my plugin hates being destroyed in a leave function, just as much as it hates being created in a pre or show function. <br />
<br />
My plugin deals with window placement of the installer window, and it looks like it gets stuck in a loop somewhere. My plugin  only works when called inside a section.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">24th August 2007, 09:10</div></div><div class="posttext">That's probably because you start it in a section, which is executed in a different thread than the leave function which is executed in the GUI thread.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">24th August 2007, 09:28</div></div><div class="posttext">I have made some small adjustments in my destroy function.<br />
<br />
I changed PostMessage into SendMessage to close the banner window, and I refreshed the global hwndparent with the hwnd passed with the destroy function. This seems to have fixed the problem with the leave function.<br />
<br />
I'm not going to change the show function in my plugin to work in the pre function, it should only be created in a section.<br />
<br />
Thanks guys, I used the code given by kichik, and now it works the way I want it to.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>