<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" DeleteRegKey Fails Because Not Iterating All Subkeys, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  DeleteRegKey Fails Because Not Iterating All Subkeys NSIS Discussion" />
	
	<title> DeleteRegKey Fails Because Not Iterating All Subkeys [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  DeleteRegKey Fails Because Not Iterating All Subkeys</div>
<hr />
<div class="pda"><a href="t-312493.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=312493">DeleteRegKey Fails Because Not Iterating All Subkeys</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">JoeAcunzo</div><div class="date">16th September 2009, 15:20</div></div><div class="posttext">I call DeleteRegKey in an Uninstall section and it fails to remove the registry key.  Looking at the registry after the uninstall, only one of four subkeys has been deleted, which explains the failure.  Using sysinternals Process Monitor, I see that it iterates the subkeys, but stops on the first one.  Oddly, after it has deleted and closed the first subkey, it then tries to reopen that same subkey, which of course fails because it does not exist any longer.  It's almost as if it tries to process the same subkey a second time instead of moving on to the next subkey.<br />
<br />
A few more twists.  This exact same script code worked fine when compiled with a version of NSIS prior to 2.39 (not sure exactly which version), but now fails with the latest version 2.45.  Also, this is failing on Vista, but working on XP (again, used to work on both Vista and XP with a prior NSIS version).  Note that I do use &quot;RequestExecutionLevel admin&quot; in my script, so I don't believe it's a elevation level issue.  Lastly, I copied/pasted out the problem area of my script and created a test script.  That test script works fine.<br />
<br />
Here is a snippet of the code:<br />
<br />
<br />
; Must first remove the deny permission on Globals.<br />
AccessControl::GrantOnRegKey HKLM &quot;Software\SoftwareTime\ComputerTime\Globals&quot; &quot;(S-1-5-32-545)&quot; &quot;EnumerateSubKeys&quot;<br />
ClearErrors<br />
DeleteRegKey HKLM &quot;Software\SoftwareTime\ComputerTime&quot;<br />
${If} ${Errors}<br />
    MessageBox MB_OK &quot;Error removing registry key.&quot;<br />
${EndIf}</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">17th September 2009, 15:39</div></div><div class="posttext">Vista adds extra fun with virtual registries. Did you add a manifest using RequestExecutionLevel? If you did, make sure you have permission to delete those keys and make sure there isn't another copy of it somewhere else in the registry.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JoeAcunzo</div><div class="date">22nd September 2009, 20:48</div></div><div class="posttext">Yes, I did use RequestExecutionLevel, and keep in mind this same exact script worked with an earlier version of NSIS, but fails with version 2.45.<br />
<br />
Here's the important part -- I looked at the NSIS C source code and compared it to the Process Monitor output that shows events on the registry.  In exechead\exec.c\myDeleteRegKeyEx(), it does not recurse into itself for each subkey according to the output log of Process Monitor, very odd.  So it appears to be an issue at the level below my script in the runtime engine of NSIS itself.<br />
<br />
However, in a smaller test script, it *does* recurse properly into itself on each subkey.  I am totally baffled and looking for suggestions as what to try next.  Thanks!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">PoRtAbLe_StEaLtH</div><div class="date">19th October 2012, 13:14</div></div><div class="posttext">i know this is an old post.. but is the closest post that is relevant to my question.<br />
<br />
is there a recursive switch for AccessControl?<br />
SetACL has -rec<br />
<br />
i looked through AccessControl's documents but didn't see anything.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">19th October 2012, 20:35</div></div><div class="posttext">If it's not in the documentation, it's probably not in the plugin either. Of course you're more than welcome to modify the accesscontrol plugin, and submit a patch for the code to the bug tracker.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">PoRtAbLe_StEaLtH</div><div class="date">20th October 2012, 11:22</div></div><div class="posttext">thank you for answering.<br />
<br />
i wasn't sure if there was a trick or something to make it work recursively that wasn't documented.<br />
<br />
thanks again.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>