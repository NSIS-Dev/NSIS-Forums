<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Uninstall, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Uninstall NSIS Discussion" />
	
	<title> Uninstall [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Uninstall</div>
<hr />
<div class="pda"><a href="t-327120.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=327120">Uninstall</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">wili</div><div class="date">10th February 2011, 12:31</div></div><div class="posttext">Hello <br />
<br />
After the installation, it is possible that some folders are added in the Directory from the user where I installed my files. So i don't know all the files and folders which i've to delete with my uninstaller. Additionaly I unzipp some folder, so there ara a lot of files after the Installation.<br />
<br />
I'm using the Modern UI. At the moment my uninstaller looks like:<br />
RMDir /r $INSTDIR\Installation<br />
RMDir /r $INSTDIR\play<br />
RMDir /r $INSTDIR\myfolder<br />
<br />
I know it is a bit dangerous. I searched a while and only found the &quot;Uninstall only installed files&quot; unlist.nsi. But this function only create a list during the installation. And i'm looking for creating a list during uninstallation, while some files and order are added after my installation.<br />
<br />
Does it already exist a function which search every file and folder in the installed directory and delete each file?<br />
Maybe I missed a simple plug-in or something similar?<br />
<br />
Thanks and Regards,<br />
Wili</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">10th February 2011, 14:31</div></div><div class="posttext">Does it already exist a function which search every file and folder in the installed directory and delete each file?<br />
Think again please. &quot;Make a list of all files and folders, and then delete the items on that list&quot;, is EXACTLY the same as &quot;Delete all files and folders&quot;.<br />
<br />
If you don't know what you want to delete, Delete /r is the only possible solution. This probably means that you need to change your application, so that you DO know what you want to delete.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">wili</div><div class="date">10th February 2011, 15:20</div></div><div class="posttext">Hi <br />
<br />
Thanks for your answer.<br />
Does theire exist a function which generate a list of all files and folders during the Uninstall Section?<br />
<br />
Thanks and Regards,<br />
Marco</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">10th February 2011, 17:40</div></div><div class="posttext">What I would do is write a small program (it could be a silent NSIS executable) and run it at compile time using !system. It will simply write the NSIS File instructions to one file (which you !include in your install section(s)) and the NSIS Delete instructions to another file (which you !include in your uninstall section(s)). If you write the executable in NSIS, you can use Locate (look in the manual). Job done.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">wili</div><div class="date">11th February 2011, 10:27</div></div><div class="posttext">Thanks a lot for your hints.<br />
<br />
I'll change my uninstaller Ideas.<br />
Last Question, is it possible to figure when unistaller.exe is launched, on with path it was stored?<br />
<br />
The $EXEPATH, etc. shows the path where it is executed. <br />
But I'm looking to read out, where the uninstaller was store. Is theire a simple way?<br />
<br />
Thanks and regards,<br />
Marco</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">11th February 2011, 10:37</div></div><div class="posttext">In the uninstaller, $INSTDIR contains the directory of uninstall.exe. (Note: This is also why it's so dangerous to do RmDir /r $INSTDIR, because someone might have moved uninstall.exe to Program Files!)<br />
<br />
You can store the actual installation directory in an ini file or the registry, during installation. (You can also use that to check if uninstall.exe has been moved, before you start the uninstallation.)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">wili</div><div class="date">11th February 2011, 11:04</div></div><div class="posttext">Thanks a lot. <br />
So i'll check if the uninstaller.exe is still at the same folder (with filexists...).<br />
<br />
Regards,<br />
Marco</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">11th February 2011, 16:10</div></div><div class="posttext">What would you want to do with FileExists? o_O<br />
<br />
ReadRegStr $0 HKLM YourRegKey YourRegString<br />
${If} $0 != $INSTDIR<br />
MessageBox MB_OK &quot;Warning here&quot;<br />
${EndIf}</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Smurge</div><div class="date">1st May 2011, 16:36</div></div><div class="posttext">I have realised the danger of RMDir /r &quot;$INSTDIR&quot;, even if it is a really small possibility that a user move the Uninstall.exe to another directory...<br />
<br />
so I thought about a solution for my script and just replace the $INSTDIR with value from the registry. My questions: Why does this not work? (the installdir is untouched after uninstall is finished - nothing is deleted! but the key is there and is been showed &quot;MessageBox MB_OK &quot;echo - $0&quot;)<br />
and: is there another universal solution?<br />
<br />
example:<br />
<br />
Section -End<br />
WriteUninstaller &quot;$INSTDIR\Uninstall.exe&quot;<br />
WriteRegStr HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\myprogram&quot; &quot;UninstallString&quot; '&quot;$INSTDIR\Uninstall.exe&quot;'<br />
WriteRegStr HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\myprogram&quot; &quot;DisplayIcon&quot; '&quot;$INSTDIR\myprogram.exe&quot;'<br />
WriteRegStr HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\myprogram&quot; &quot;InstallPath&quot; 		'&quot;$INSTDIR&quot;'<br />
SectionEnd<br />
<br />
<br />
Section &quot;Uninstall&quot;<br />
.<br />
ReadRegStr $0 HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\myprogram&quot; &quot;InstallPath&quot;<br />
RMDir /r $0<br />
.<br />
SectionEnd<br />
<br />
bye</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st May 2011, 17:12</div></div><div class="posttext">If you checked the value of $0 you'd know. You've put quotes around the value in the registry. Also your script is just as bad as using $INSTDIR. If someone deletes that registry value, RMDIR will be given an empty string, i.e. the root and delete EVERYTHING. Please either avoid RMDir completely or do at least some validation on the path you are giving it.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Smurge</div><div class="date">1st May 2011, 18:02</div></div><div class="posttext">hi<br />
<br />
-but RMDir /r &quot;$INSTDIR&quot; have also quotes and it works,... the $0 includes the &quot;&quot; so i removed them in the script -&gt; RMDir /r $0<br />
<br />
The error flag will be set and $x will be set to an empty string (&quot;&quot;) if the string is not present.<br />
RMDir /r &quot;&quot; -&gt; doesn NOT delete ROOT or anything else. I tested it right now on the VM.  =)<br />
<br />
I think, the best way will be to check that the last dir is ...&quot;/MyProgram&quot; to make sure the User didnt use &quot;C:\&quot; or &quot;C:\Program Files&quot; as installation directory!? but how to do it?<br />
<br />
btw. That some one deletes the Reg entry is very unlikely, IMHO<br />
<br />
--------------<br />
I have testet your Example: http://nsis.sourceforge.net/Uninstall_only_installed_files<br />
But it does not work. I guess it is because of * or *.*<br />
This is what i use in my script:<br />
<br />
		Section &quot;Main Files&quot; test32<br />
		<br />
			 SectionIn RO<br />
			 SetOutPath $INSTDIR<br />
			 File /r &quot;${BIN}\*&quot;<br />
<br />
	<br />
		${If} ${RunningX64}<br />
					 File /r &quot;${BIN64}\*.*&quot;<br />
		${EndIf}<br />
		<br />
	<br />
		${If} ${IsWin2000}<br />
					 File /r &quot;${BINWin2k}\*.*&quot;<br />
		${EndIf}<br />
		SectionEnd<br />
<br />
<br />
when i try to use your script, the compiller breaks with:<br />
-&gt;$UninstLog<br />
Usage: File [/nonfatal] [/a] ([/r] [/x filespec [...]] filespec [...] |<br />
   /oname=outfile one_file_only)<br />
Error in macro File on macroline 3<br />
Error in script &quot;stdin&quot; on line 270 -- aborting creation process<br />
I implement it exactly as you described. <br />
The line of error: <br />
${File} /r &quot;${BIN}\*&quot;<br />
<br />
bye</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">1st May 2011, 19:35</div></div><div class="posttext">btw. That some one deletes the Reg entry is very unlikely, IMHO<br />
The regentry not existing is actually far more likely than a user moving uninstall.exe. And the consequences if it happens are far far worse. So summing up, your method is extremely dangerous.  (Example: User installs to D:\Software\YourApp, then formats C: and reinstalls windows, then runs your uninstaller. As you can see, this could happen very easily.) <br />
<br />
<br />
Here's what I do:<br />
  ;Check validity of the $INSTDIR variable<br />
  ${If} $ALLUSERS == 1<br />
    ReadRegStr $2 HKLM &quot;Software\${REGKEY_GROUP}\${REGKEY_NAME}&quot; &quot;InstallDir&quot;<br />
  ${Else}<br />
    ReadRegStr $2 HKCU &quot;Software\${REGKEY_GROUP}\${REGKEY_NAME}&quot; &quot;InstallDir&quot;<br />
  ${EndIf}<br />
  ${If} $2 != $INSTDIR<br />
    ;Something is wrong! Fall back to checking for filenames.<br />
    ${IfNot} ${FileExists} &quot;$INSTDIR\MyApp.exe&quot;<br />
    ${OrIfNot} ${FileExists} &quot;$INSTDIR\MyOtherFile.dat&quot;<br />
    ${OrIfNot} ${FileExists} &quot;$INSTDIR\Etcetera.etc&quot;<br />
      MessageBox MB_YESNO|MB_ICONEXCLAMATION &quot;WARNING: Setup could not verify that this uninstaller is being run from its proper \<br />
                 directory. If you have moved Uninstall.exe to a directory other than the actual installation folder, it is \<br />
                 impossible to guarantee that the uninstallation will be executed properly. If you proceed, it is theoretically \<br />
                 possible that setup will delete files that should not be deleted. Are you sure you wish to continue with \<br />
                 the uninstallation?&quot; IDYES +2<br />
      quit ;quit installer.<br />
    ${EndIf}<br />
  ${EndIf}<br />
<br />
This is still not waterproof safe. But it's pretty safe as long as the filenames in my software (MyApp.exe and the others) are very specific and unlikely to be used in other software.<br />
<br />
And together with the above code, I NEVER use RmDir /r, no matter how badly I want to. I only delete the files I know I should delete. Nothing else. It's just a matter of courtesy to your users that you don't take frivolous risks with their computers. Even if it means leaving some files behind after uninstall, there's just no excuse to risk destroying someone's OS.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Smurge</div><div class="date">1st May 2011, 21:23</div></div><div class="posttext">This doesn't cover the case when the user installed the app in C:\ ... :D<br />
hmm, so ideally the installer should delete 1 file at the time, and delete directory's only if the dir is empty?<br />
<br />
Thanks for the example. I will use it in my script. But what i don't understand is the &quot;$ALLUSERS == 1&quot; thing.<br />
I didn't find this Variable in the manual. Is this automatically detected when &quot;SetShellVarContext all&quot; is set previously? or do i need a &quot;!include ...&quot; to use this?<br />
<br />
bye</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st May 2011, 21:31</div></div><div class="posttext">-but RMDir /r &quot;$INSTDIR&quot; have also quotes and it works,... the $0 includes the &quot;&quot; so i removed them in the script -&gt; RMDir /r $0<br />
That is the same as doing RMDir /r '&quot;some_path&quot;'. RMDir does not accept quotes around its path.RMDir /r &quot;&quot; -&gt; doesn NOT delete ROOT or anything else. I tested it right now on the VM.  =)Looks like code was added quite a while ago to prevent this. My bad.I think, the best way will be to check that the last dir is ...&quot;/MyProgram&quot; to make sure the User didnt use &quot;C:\&quot; or &quot;C:\Program Files&quot; as installation directory!? but how to do it?Use StrCpy $0 $path &quot;&quot; -X to get the last X characters of the path.when i try to use your script, the compiller breaks with:<br />
<br />
I implement it exactly as you described. <br />
The line of error: <br />
${File} /r &quot;${BIN}\*&quot;You cannot use the recursive switch as the macro requires you to explicitly tell it each file name/path. If you need to use these macros but with recursion then you need to write a program that generates the NSIS script (i.e. the individual ${File} instructions for each file).<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st May 2011, 21:32</div></div><div class="posttext">Ignore that $ALLUSERS bit. Uninstall registry is always under HKLM.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Smurge</div><div class="date">1st May 2011, 21:47</div></div><div class="posttext">That is the same as doing RMDir /r '&quot;some_path&quot;'. RMDir does not accept quotes around its path.<br />
<br />
I just assumed that the Path have to be in &quot;&quot;. I dint know that it needed ' to function properly. All examples i read, had &quot;&quot; with RMDir! so what is the problem with it?<br />
<br />
The manual don't show any necessary format:<br />
http://nsis.sourceforge.net/Docs/Chapter4.html#4.9.1.8<br />
<br />
--------<br />
If you need to use these macros but with recursion then you need to write a program that generates the NSIS script (i.e. the individual ${File} instructions for each file).<br />
<br />
This is too complex for me. I don't have any professional programming skills.<br />
<br />
Cant i just use the ${File} ..\* for the app and any sub directory? will this delete/uninstall those sub dirs as well?<br />
<br />
------<br />
<br />
by ignore you mean to skip the IF? like this:<br />
<br />
    ReadRegStr $2 HKLM &quot;Software\${REGKEY_GROUP}\${REGKEY_NAME}&quot; &quot;InstallDir&quot;<br />
   ${If} $2 != $INSTDIR<br />
    ;Something is wrong! Fall back to checking for filenames.<br />
    ${IfNot} ${FileExists} &quot;$INSTDIR\MyApp.exe&quot;<br />
    ${OrIfNot} ${FileExists} &quot;$INSTDIR\MyOtherFile.dat&quot;<br />
    ${OrIfNot} ${FileExists} &quot;$INSTDIR\Etcetera.etc&quot;<br />
      MessageBox MB_YESNO|MB_ICONEXCLAMATION &quot;WARNING: Setup could not verify that this uninstaller is being run from its proper \<br />
                 directory. If you have moved Uninstall.exe to a directory other than the actual installation folder, it is \<br />
                 impossible to guarantee that the uninstallation will be executed properly. If you proceed, it is theoretically \<br />
                 possible that setup will delete files that should not be deleted. Are you sure you wish to continue with \<br />
                 the uninstallation?&quot; IDYES +2<br />
      quit ;quit installer.<br />
    ${EndIf}<br />
  ${EndIf}</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st May 2011, 22:10</div></div><div class="posttext">Cant i just use the ${File} ..\* for the app and any sub directory? will this delete/uninstall those sub dirs as well?No you can't I'm afraid. If you really want to only uninstall installed files you will have to explicitly include File instructions for each file as a bare minimum. That script will generate a text file listing the files and folders to later delete during uninstall, saving you from having to write those Delete instructions yourself. In my opinion though, it is better to explicitly write the Delete instructions in the uninstaller too, rather than rely on an external text file. If the text file goes missing then you get problems, yet again.by ignore you mean to skip the IF? like this:That is correct.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st May 2011, 22:13</div></div><div class="posttext">Also remember the uninstall code needs to delete in reverse order to the order that the files were extracted/created. E.g.Section Install<br />
  SetOutPath 1<br />
  File a<br />
  SetOutPath 1\2<br />
  File b<br />
  SetOutPath 1\2\3<br />
  File c<br />
SectionEnd<br />
Section Uninstall<br />
  Delete 1\2\3\c<br />
  RMDir 1\2\3<br />
  Delete 1\2\b<br />
  RMDir 1\2<br />
  Delete 1\a<br />
  RMDir 1<br />
SectionEndStu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">2nd May 2011, 06:43</div></div><div class="posttext">This doesn't cover the case when the user installed the app in C:\ ... :D<br />
Actually I disallow root-directory installations, as well as installs to $PROGRAMFILES, $WINDIR etc, on my DIRECTORY page. But you're very right, I should add a check for these directories in the uninstaller as well, in case some joker moves uninstall.exe to one of those directories. :-)<br />
<br />
hmm, so ideally the installer should delete 1 file at the time, and delete directory's only if the dir is empty?<br />
Yeah, that's the only safe way to do it.<br />
<br />
I just assumed that the Path have to be in &quot;&quot;. I dint know that it needed ' to function properly. All examples i read, had &quot;&quot; with RMDir! so what is the problem with it?<br />
The *parameter* of RmDir should be without quotes. The *command call* to RmDir may have quotes, because those quotes are for the compiler. If you do this: RmDir &quot;$INSTDIR\something&quot;, then the compiler removes those quotes for you. But if you do RmDir $0, and $0 contains quotes itself, then the compiler cannot prevent the quote characters from ending up in the RmDir parameter. That's why you need to strip quote characters after reading a path string from registry (if there's a chance that the string contains quotes).<br />
<br />
Uninstall registry is always under HKLM.<br />
Single-user installations' ARP info is stored in HKCU, actually.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">2nd May 2011, 10:00</div></div><div class="posttext">Single-user installations' ARP info is stored in HKCU, actually.That's interesting. There isn't even an Uninstall key under HKCU but if I create one and add an entry to does work. I wonder why that isn't used more often.<br />
<br />
Edit: And for all this time I've been avoiding add/remove programs and using an Uninstall short-cut only lol. Thanks :)<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Smurge</div><div class="date">2nd May 2011, 11:36</div></div><div class="posttext">so back to my question: what do i need to use the &quot;$ALLUSERS == 1&quot;<br />
Your example is working in my installer, when i move the deinstaller to another location the MassageBox pops out. <br />
There is only a tiny flaw... the compiler shows a warning:<br />
1 warning:<br />
  unknown variable/constant &quot;ALLUSERS&quot; detected, ignoring (macro:_==:1)<br />
-------<br />
btw. the '&quot;$INSTDIR\myprogram.exe&quot;' only happened because i copy-pasted this line from another script. I removed the quotes from all WriteRegStr and now its working perfectly! <br />
<br />
thanks</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">2nd May 2011, 11:38</div></div><div class="posttext">MSG was just giving you an idea to use that variable to indicate an all users / current user install. Doesn't mean you need to use it.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Smurge</div><div class="date">2nd May 2011, 13:55</div></div><div class="posttext">I have modified the example a little bit. This is what i use:<br />
<br />
Section -End<br />
.<br />
WriteUninstaller &quot;$INSTDIR\Uninstall.exe&quot;<br />
WriteRegStr HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\myprogram&quot; &quot;InstallPath&quot; '$INSTDIR'<br />
.<br />
SectionEnd<br />
<br />
<br />
Section &quot;Uninstall&quot;<br />
.<br />
; # Check validity of the $INSTDIR variable. Compares the uninstall.exe location with the RegKey value.<br />
ReadRegStr $2 HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\myprogram&quot; &quot;InstallPath&quot;<br />
IfErrors 0 +2<br />
ReadRegStr $2 HKCU &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\myprogram&quot; &quot;InstallPath&quot;<br />
${If} $2 != $INSTDIR<br />
	; # Something is wrong! Fall back to checking for filenames.<br />
		${IfNot} ${FileExists} &quot;$INSTDIR\MyProgram.exe&quot;<br />
		MessageBox MB_OKCANCEL|MB_ICONEXCLAMATION &quot;WARNING: Setup could not verify that this uninstaller is being run from its proper \<br />
							 directory. If you have moved Uninstall.exe to a directory other than the actual installation folder, it is \<br />
							 impossible to guarantee that the uninstallation will be executed properly. If you proceed, it is theoretically \<br />
							 possible that setup will delete files that should not be deleted. Are you sure you wish to continue with \<br />
							 the uninstallation?$\r$\r-OK to continue and uninstall the application from:$\r$\n   '$2' $\r$\n-CANCEL to end&quot; IDOK +2<br />
		quit ; # quit installer.<br />
	${EndIf}<br />
${EndIf}<br />
.<br />
RMDir /r $2<br />
.<br />
SectionEnd  <br />
<br />
<br />
I think, together with the Path saved in the RegKey and the user feedback, it is a good compromise.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">2nd May 2011, 14:47</div></div><div class="posttext">I would add a ClearErrors above ReadRegStr just in case you later add code which may set the error flag. Also, should that not be an OR (you are implying an AND by using two If statements. I.e. it should be If $2 != $INSTDIR OR !FileExists $INSTDIR\MyProgram.exe). With your code, if someone moves the uninstall executable to another folder with a MyProgram.exe in it (unlikely I know), then the uninstall will continue.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">2nd May 2011, 18:48</div></div><div class="posttext">Stu: That depends on what you decide is more important. If my regentry is there and the value matches $instdir, then I don't check which files are there. This is in order to support rollback in case of installation failure (the regkey is created first thing during installation). But yeah, Or might be the better option generally speaking.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Smurge</div><div class="date">3rd May 2011, 18:47</div></div><div class="posttext">Thanks for the tip, i extended the script with the ClearErrors, changed it to an OR case and added a check for the RegKey existence in &quot;un.onInit&quot;. But i dont get the result i expected.<br />
<br />
1. Question: Why is ${Usedinstpath} defined, even if it is &quot;jumped&quot; by a GOTO? (in the un.onInit part)<br />
2. Question: Why does the Uninstaller not delete the directory that is defined in $2 and ${Usedinstpath}? (the App Directory remains untouched after successful uninstallation)<br />
<br />
<br />
Function un.onInit<br />
	; # Check existence of the RegKey. If not there (in case of an error or windows reinstallation) then try to to use the current Installer location as path<br />
	ClearErrors<br />
		ReadRegStr $1 HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\Hybrid&quot; &quot;InstallPath&quot;<br />
	IfErrors 0 +2<br />
		ReadRegStr $1 HKCU &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\Hybrid&quot; &quot;InstallPath&quot;<br />
	IfErrors &quot;&quot; goout<br />
	; # Ask to use path or else abort<br />
	!ifndef $1<br />
	MessageBox MB_YESNO|MB_ICONQUESTION &quot;Cant determine the install path from registry. Shall the installer use the current location of the installer?$\r$\n Installer path? -&gt; '$INSTDIR'&quot; IDYES definepath<br />
		quit<br />
		definepath:<br />
		!define Usedinstpath &quot;$INSTDIR&quot;<br />
	!endif<br />
goout:<br />
<br />
;INFO<br />
MessageBox MB_OK &quot;1-s1-$1$\r$\ninstdir-$INSTDIR$\r$\nuserinstpath-${Usedinstpath}&quot; <br />
<br />
FunctionEnd<br />
<br />
<br />
Section &quot;Uninstall&quot;<br />
<br />
	SetShellVarContext all<br />
	 ; # Check validity of the $INSTDIR variable. Compares the uninstall.exe location with the RegKey value.<br />
	ClearErrors<br />
	ReadRegStr $2 HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\Hybrid&quot; &quot;InstallPath&quot;<br />
		IfErrors 0 +2<br />
	ReadRegStr $2 HKCU &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\Hybrid&quot; &quot;InstallPath&quot;<br />
	;INFO<br />
	MessageBox MB_OK &quot;2-s2-$2$\r$\ninstdir-$INSTDIR$\r$\nuserinstpath-${Usedinstpath}&quot; <br />
<br />
	${If} $2 != $INSTDIR <br />
		GOTO cantfinddirwarning<br />
	${EndIf}<br />
	${IfNot} ${FileExists} &quot;$INSTDIR\Hybrid.exe&quot;<br />
		GOTO cantfinddirwarning<br />
	${EndIf}<br />
	GOTO startuninstall<br />
<br />
	cantfinddirwarning:<br />
	; # Something is wrong! Fall back to checking for filenames.<br />
	MessageBox MB_OKCANCEL|MB_ICONEXCLAMATION &quot;WARNING: Setup could not verify that this uninstaller is being run from its proper \<br />
		 directory. If you have moved Uninstall.exe to a directory other than the actual installation folder, it is \<br />
		 impossible to guarantee that the uninstallation will be executed properly. If you proceed, it is theoretically \<br />
		 possible that setup will delete files that should not be deleted. Are you sure you wish to continue with \<br />
		 the uninstallation?$\r$\r-OK to continue and uninstall the application from:$\r$\n   '$2${Usedinstpath}' $\r$\n-CANCEL to end&quot; IDOK +2<br />
	quit ; # quit installer.<br />
<br />
<br />
	startuninstall:<br />
	!ifdef $2<br />
		RMDir /r $2<br />
	!endif<br />
	!ifdef ${Usedinstpath}<br />
		RMDir /r ${Usedinstpath}<br />
	!endif<br />
<br />
thx</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">3rd May 2011, 19:23</div></div><div class="posttext">1. Question: Why is ${Usedinstpath} defined, even if it is &quot;jumped&quot; by a GOTO? (in the un.onInit part)<br />
Because !defines are executed at compiletime, whereas gotos are runtime commands. You'll need to learn the difference between compiletime and runtime. Google may have some explanations.<br />
<br />
2. Question: Why does the Uninstaller not delete the directory that is defined in $2 and ${Usedinstpath}?<br />
Because &quot;$2&quot; is not a define, so &quot;!ifdef $2&quot; is always false and the compiler completely skips the RmDir command. You need to use ${If} $2 != &quot;&quot;  . Once again, you're confusing compiletime with runtime.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>