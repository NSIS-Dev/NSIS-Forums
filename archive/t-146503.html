<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Userinfo working once, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Userinfo working once NSIS Discussion" />
	
	<title> Userinfo working once [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Userinfo working once</div>
<hr />
<div class="pda"><a href="t-146503.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=146503">Userinfo working once</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Jorrit</div><div class="date">21st August 2003, 10:16</div></div><div class="posttext">I use UserInfo to check for admin rights. This works allrightthe first time, but when my application is uninstalled and after that again installed the userinfo returns an empty string instead of the admin string I would expect. My install ends, but when I restart it the admin rights are detected okay and everything works like a charm. Anyone else have this problem? Is there a solution to this problem?<br />
<br />
Jorrit</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">21st August 2003, 11:12</div></div><div class="posttext">Can you attach the script?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Jorrit</div><div class="date">21st August 2003, 12:14</div></div><div class="posttext">These should be the relevant parts of the script:<br />
<br />
&lt;knip&gt;<br />
!macro ADMIN_CHECK<br />
	<br />
	; Bij windows 9x werkt deze routine niet, dus checken<br />
  !insertmacro WINVERSION<br />
	StrCpy $6 $R0<br />
	StrCmp $6 &quot;Windows 98&quot; Win9x 0<br />
	StrCmp $6 &quot;Windows ME&quot; Win9x +3<br />
  Win9x:<br />
	StrCpy $6 &quot;Win9x&quot;<br />
	Goto NoCheck<br />
<br />
	UserInfo::GetAccountType<br />
  Pop $R0<br />
  StrCmp $R0 &quot;Admin&quot; +3 0<br />
  MessageBox MB_OK|MB_ICONSTOP|MB_TOPMOST &quot;U moet beheerder zijn van het systeem om deze installatie uit te kunnen voeren. U bent: $R0&quot;<br />
  Abort<br />
	NoCheck:<br />
!macroend<br />
<br />
!macro WINVERSION<br />
	WinVer::GetWindowsVersion<br />
  Pop $R0 ; De Windows versie<br />
  Pop $R1 ; Eventueel het service pack<br />
!macroend<br />
<br />
Function .onInit<br />
  !insertmacro ADMIN_CHECK<br />
	!insertmacro CHECK_MSDE<br />
	!insertmacro AFTERREBOOT<br />
FunctionEnd<br />
&lt;knip&gt;<br />
<br />
Jorrit</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">21st August 2003, 13:48</div></div><div class="posttext">So you start the installer in a normal way (using explorer or something else) and you get a message that says &quot;U bent: &quot; (empty)?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Jorrit</div><div class="date">21st August 2003, 13:54</div></div><div class="posttext">Yes, exactly.<br />
And if I try again it sometimes works or I have to try again. It would take a few tries and then there is no problem. <br />
But... it never happens on the initial install, or has never happened so far....<br />
Jorrit</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">21st August 2003, 14:34</div></div><div class="posttext">What is your OS? Can you try to reproduce it with another installer? Are you sure it always works on the initial install, or is it just random?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Jorrit</div><div class="date">21st August 2003, 15:36</div></div><div class="posttext">Hmm,<br />
this happened on a NT4 and a win2k machine, but I can't reproduce anymore. It's gone. I've had this happen at least ten times this morning, but it doesn't happen anymore. I've changed some things, but nothing that should influence any of this... So I hope it's gone</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Jorrit</div><div class="date">21st August 2003, 15:43</div></div><div class="posttext">Too soon.... it's not back, it just happens less....<br />
NT4 machine. What I see is that the DLL Winver has been put in my install dir.... Is this the default behaviour?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">deguix</div><div class="date">21st August 2003, 15:54</div></div><div class="posttext">1)StrCmp $6 &quot;Windows 98&quot; Win9x 0 <br />
StrCmp $6 &quot;Windows ME&quot; Win9x +3 <br />
Win9x: <br />
StrCpy $6 &quot;Win9x&quot; <br />
Goto NoCheck<br />
<br />
UserInfo::GetAccountType <br />
Pop $R0 <br />
StrCmp $R0 &quot;Admin&quot; +3 0 <br />
MessageBox MB_OK|MB_ICONSTOP|MB_TOPMOST &quot;U moet beheerder zijn van het systeem om deze installatie uit te kunnen voeren. U bent: $R0&quot; <br />
Abort <br />
NoCheck:Replace the code above by this:<br />
<br />
StrCmp $6 &quot;Windows 98&quot; +2 0 <br />
StrCmp $6 &quot;Windows ME&quot; 0 DetectAdmin <br />
StrCpy $6 &quot;Win9x&quot; <br />
Goto AdminCheckEnd<br />
<br />
DetectAdmin:<br />
UserInfo::GetAccountType <br />
Pop $R0<br />
<br />
StrCmp $R0 &quot;Admin&quot; AdminCheckEnd <br />
  MessageBox MB_OK|MB_ICONSTOP|MB_TOPMOST &quot;U moet beheerder zijn van het systeem om deze installatie uit te kunnen voeren. U bent: $R0&quot; <br />
  Abort <br />
AdminCheckEnd:2)Function .onInit <br />
!insertmacro ADMIN_CHECK <br />
!insertmacro CHECK_MSDE <br />
!insertmacro AFTERREBOOT <br />
FunctionEndYou are detecting the admin without checking the Windows version. Try put before &quot;!insertmacro ADMIN_CHECK&quot; this below:<br />
<br />
!insertmacro WINVERSION<br />
<br />
3)What I see is that the DLL Winver has been put in my install dir.... Is this the default behaviour?Plugins have to be in the plugins subdirectory of your NSIS folder.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Jorrit</div><div class="date">21st August 2003, 16:15</div></div><div class="posttext">I found that the behaviour is seen when I use reboot and start again via HKCU....Runonce.<br />
When it all happens to fast it does not detect my admin rights. After that it takes one, two or more tries to detect I'm admin. So I get the feeling it's too soon to detect admin rights.<br />
<br />
The plugin is in my own plugindir, but it seems to get copied at installtime into a directory I'm installing into, allthough the actual copying of files and thus installing happens in a msi and not in this nsis part of my installer. From this part of the installer I just do some checks and execute some programs.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">21st August 2003, 16:15</div></div><div class="posttext">Did you call WinVer using the WinVer::command syntax? Get the same UserInfo problem with other installer scripts?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">21st August 2003, 18:37</div></div><div class="posttext">Shouldn't you also be checking for Windows 95 as well as 98?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Jorrit</div><div class="date">22nd August 2003, 08:25</div></div><div class="posttext">I call the winver in the standard way, it's just added via <br />
!addplugindir. The problem with userinfo is not in every installer, but I have to say I saw some other problems in other installers when started via the runonce registry key. Maybe it's best to build in some sleep? or is there a way to verify that the computer has finished starting up, finsished starting up services?<br />
<br />
Win 95 is not supported by parts of my app, so not testing for it means nobody should be able to install it, which is no problem.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">28th August 2003, 13:35</div></div><div class="posttext">You can simply put the entry in the HKLM RunOnce key where you're sure that the user executing the installer will be admin. This will require to check ahead ahead with the program that adds the RunOnce key. You can also simply check ahead and not add the RunOnce entry if the user doesn't have admin rights.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>