<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" NSIS-made autorun (user mode) needs to call NSIS-made setup (admin mode), media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  NSIS-made autorun (user mode) needs to call NSIS-made setup (admin mode) NSIS Discussion" />
	
	<title> NSIS-made autorun (user mode) needs to call NSIS-made setup (admin mode) [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  NSIS-made autorun (user mode) needs to call NSIS-made setup (admin mode)</div>
<hr />
<div class="pda"><a href="t-274962.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=274962">NSIS-made autorun (user mode) needs to call NSIS-made setup (admin mode)</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Gato Muerto</div><div class="date">26th July 2007, 20:54</div></div><div class="posttext">Pretty much it is the subject, in a nutshell.  I have taken a script my company has been using for making nifty autorun programs for CDROMs that allow users to install program, view readme, and exit the autorun.  I've made some changes for additional options and all was well with our world until Vista came around.<br />
<br />
As is, the autoruns wanted Admin rights, so I included &quot;RequestExecutionLevel User&quot; for the autorun and &quot;RequestExecutionLevel Admin&quot; for the setup.  The relevant code for the autorun is as follows:<br />
  Call CheckInstallStatus ; We are paranoid... The user may have (un)installed it behind our backs...<br />
  StrCmp $InsStat &quot;1&quot; +1 +5 ; Check Installation Status<br />
  SetOutPath &quot;$INSTDIR&quot;<br />
  Exec &quot;$INSTDIR\${PROGEXE}&quot; ; Run installed program<br />
  SetOutPath &quot;$EXEDIR&quot;<br />
  Goto +5<br />
  FindWindow $R0 &quot;#32770&quot; &quot;&quot; $HWNDPARENT<br />
  GetDlgItem $R0 $R0 1201 # 1201 is field 2<br />
  SendMessage $R0 ${WM_SETTEXT} 0 &quot;STR:Please wait while the program installs...&quot;<br />
  ExecWait &quot;$EXEDIR\setup.exe&quot; ; Run installer<br />
  Call InstallRunButton ; Run script that controls button messages.<br />
  Abort ; Return to the page<br />
<br />
I believe the issue is that the user-access autorun is not liking to be told to run an admin-access setup.  What do I need to do to get this to work properly?  I've seen a mention of &quot;UAC::ShellExecWait&quot;, but have not been able to track down specifics if this is a plugin or how to use it.<br />
<br />
Thanks for the help here.  Great community.  :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gato Muerto</div><div class="date">26th July 2007, 20:57</div></div><div class="posttext">Ergh.  Found something through the wiki.  Going to work on the UAC plug-in (http://nsis.sourceforge.net/UAC_plug-in)  to see if this can solve my issue, but if someone else has another workaround, or can confirm my suspicions, I would appreciate it.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">26th July 2007, 22:50</div></div><div class="posttext">Exec (CreateProcess internally) can not elevate, it will just return with a ELEVATION_REQUIRED error. ExecShell(ShellExecute internally) on the other hand should work. NSIS does not have a wait version of shellexec so if you really have to wait you can use the UAC plugin, try<br />
UAC::ShellExecWait &quot;&quot; SW_SHOWNORMAL '&quot;$EXEDIR\setup.exe&quot;'</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gato Muerto</div><div class="date">26th July 2007, 22:58</div></div><div class="posttext">From what I have read with the UAC plugin, it will run both the admin and user levels simultaneously, correct?  That doesn't quite solve the problem, since I am trying to avoid forcing the prompt for Admin upon insertion of the CD into the computer.<br />
<br />
I guess the ExecShell should be sufficient, although I would prefer the wait statement...<br />
<br />
Vista does things right (finally) with the UAC, but just wish it wouldn't get in the way so often.  :P</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">26th July 2007, 23:00</div></div><div class="posttext">no, the UAC plugin works in two modes, if you have not called UAC::RunElevated (or user failed to elevate and you ignore this error) all other UAC:: calls should perform without elevation (with the current user profile and privileges)<br />
<br />
Or atleast, thats how its supposed to work</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gato Muerto</div><div class="date">26th July 2007, 23:05</div></div><div class="posttext">I meant that the autorun program would have to prompt for the admin access upon init of the autorun program, which would be when the CD is inserted into the computer.  <br />
<br />
Or do you mean to put the UAC in the main setup NSIS program?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">26th July 2007, 23:08</div></div><div class="posttext">What I mean is, the autorun program will run without admin access, the setup will run as admin, but you would not use the UAC stuff to handle elevation (unless you want to), you would only use the UAC plugin because it should be able to give you a working shellexecwait (I just tested on my own machine, and I can't actually get it to work) If you join the #nsis irc channel I might be able to give you some progress report on fixing this</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">26th July 2007, 23:13</div></div><div class="posttext">Nevermind, I just forgot the two last parameters ;)<br />
<br />
try:<br />
 UAC::ShellExecWait &quot;&quot; SW_SHOWNORMAL '&quot;$EXEDIR\setup.exe&quot;' &quot;&quot; &quot;&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Gato Muerto</div><div class="date">27th July 2007, 19:53</div></div><div class="posttext">Again, thanks for the help.  The UAC plugin wiki doesn't appear to have info on this, as most of the examples instruct on how to downgrade the user access rather than the vice-versa.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">27th July 2007, 20:29</div></div><div class="posttext">Yeah, it is sort of undocumented, but the UAC plugin is hard enough to explain as it is, I'm not sure if I want to create more confusion with the fact that most of the exported functions should work even if you don't call UAC::RunElevated first</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>