<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Bug in BgImage, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Bug in BgImage NSIS Discussion" />
	
	<title> Bug in BgImage [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Bug in BgImage</div>
<hr />
<div class="pda"><a href="t-156004.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=156004">Bug in BgImage</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Wasteland</div><div class="date">12th November 2003, 18:54</div></div><div class="posttext">I'm using BgImage, and was getting a crash, it seems the problem goes as follows:<br />
BgImage::SetBg() is getting called *before* _DllMainCRTStartup ever gets called, and therefore is using a CriticalSection that was never initialized (using the debug build it simply crashes outright, the release one just sometimes crashes).  Setting up a lazy init in ECS seems to have fixed the problem:<br />
<br />
<br />
bool CriticalSectionInited=false;<br />
CRITICAL_SECTION CriticalSection;<br />
<br />
void ECS() {<br />
	if (!CriticalSectionInited) {<br />
		InitializeCriticalSection(&amp;CriticalSection);<br />
		CriticalSectionInited = true;<br />
	}<br />
	EnterCriticalSection(&amp;CriticalSection);<br />
}<br />
<br />
.<br />
.<br />
.<br />
<br />
BOOL WINAPI _DllMainCRTStartup(HINSTANCE hInst, ULONG ul_reason_for_call, LPVOID lpReserved) {<br />
  g_hInstance=hInst;<br />
  switch (ul_reason_for_call) {<br />
    case DLL_PROCESS_ATTACH:<br />
	  if (!CriticalSectionInited) {<br />
		InitializeCriticalSection(&amp;CriticalSection);<br />
		CriticalSectionInited = true;<br />
	  }<br />
      break;<br />
<br />
<br />
I admit I know *nothing* about DLLs, so there might be something else going wrong here, it seems odd to me that you'd get a function called before getting an ATTACH message, but this seems to have fixed my problem.  Thanks for the great plugin!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">12th November 2003, 19:00</div></div><div class="posttext">That's impossible.<br />
<br />
Something else must be happening. Mind attaching the script and some more details about the tested OS?<br />
<br />
Also, have you recompiled BgImage (before adding the patch)?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Wasteland</div><div class="date">12th November 2003, 19:19</div></div><div class="posttext">I am getting this behaviour in the Example.nsi that comes with BgImage (in the nsis.zip of recent CVS code).  I simply built the debug version of BgImage.dll, copied it to my plugins/ folder, compiled the example, and it crashes immediately upon startup.<br />
<br />
I'm running Windows XP (latest patches), and the crash that I seem to have fixed only exhibited itself on some laptops (the crash was happening in the Destroy code, I believe, so I built the debug version to find out where, but since the debug just died instantly I was unable to track it down.  Now after this change, it's working fine).<br />
<br />
If you are not getting this behaviour with the debug build let me know and I will try it on different computers to help track it down.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">12th November 2003, 19:26</div></div><div class="posttext">Ah... That's because the debug build is not configured right. It doesn't even call _DllMainCRTStartup in the debug version :)<br />
<br />
I'll update that, thanks.<br />
<br />
For now, just #define _DllMainCRTStartup as DllMain if _DEBUG is defined and it should work.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Wasteland</div><div class="date">12th November 2003, 19:34</div></div><div class="posttext">Ugh... well that means there's still a crashbug sitting in there somewhere... I'll let you know if I can get it to happen again...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">18th November 2003, 14:22</div></div><div class="posttext">Problem &quot;solved&quot;, it was because SetBg was called from a section. Documentation updated to state it shouldn't be done.<br />
<br />
Thanks Wasteland</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>