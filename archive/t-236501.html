<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Problems on Japanese Windows XP, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Problems on Japanese Windows XP NSIS Discussion" />
	
	<title> Problems on Japanese Windows XP [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Problems on Japanese Windows XP</div>
<hr />
<div class="pda"><a href="t-236501.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=236501">Problems on Japanese Windows XP</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">richardv</div><div class="date">27th January 2006, 07:22</div></div><div class="posttext">Hi all,<br />
<br />
I'm currently working on an NSIS installer and have run into a couple of problems testing on Japanese WinXP. The installer fails on startup with a &quot;Error loading installer&quot; message whenever the path to the installer executable contains Japanese Kanji characters. I've traced this to the loadHeaders() function in fileform.c to where the code does this:<br />
<br />
  GetModuleFileName(g_hInstance, state_exe_directory, NSIS_MAX_STRLEN);<br />
<br />
  g_db_hFile = db_hFile = myOpenFile(state_exe_directory, GENERIC_READ, OPEN_EXISTING);<br />
  if (db_hFile == INVALID_HANDLE_VALUE)<br />
  {<br />
    return _LANG_CANTOPENSELF;<br />
  }<br />
<br />
which more or less just plain doesn't work if there are Unicode characters in the path. Why is this using the ASCII Win32 functions? Is this because NSIS is MBCS and doesn't use Unicode because of compatibility with Win9x? I altered the code to instead use the equivalent Unicode functions and it then works correctly (though I guess it may not work right on Win9x). However, this problem appears to be more widespread: the installer fails to create any start menu or desktop items because they all have Japanese characters in the path! Is this a known issue, and if so, are there any workarounds, or does NSIS need to be extended to work correctly with Unicode path and file names? I am potentially able to assist with the work involved in improving/fixing NSIS in this area.<br />
<br />
Also, if anyone has any good ideas on fixing this problem: http://nsis.sourceforge.net/It%27s_all_rubbish_when_I_use_a_non-ASCII_language then I'd be interested to know. The idea of calling SetThreadLocale() based on the selected language seems like a potentially good one, but I don't currently know enough NSIS internals to deduce whether it is workable or not.<br />
<br />
Thanks,<br />
Richard</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">27th January 2006, 15:15</div></div><div class="posttext">Originally posted by richardv <br />
Is this because NSIS is MBCS and doesn't use Unicode because of compatibility with Win9x?Yes, exactly.Originally posted by richardv <br />
I am potentially able to assist with the work involved in improving/fixing NSIS in this area.There's currently an on-going effort to add Unicode support to NSIS. I've forwarded your name to the guy in charge.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">richardv</div><div class="date">29th January 2006, 22:55</div></div><div class="posttext">OK<br />
<br />
Who are the people that have worked on Unicode support in the past? Are there any in-progress patches that I can look at or start working with? Is there any previous discussion on how this would best be implemented? I have some ideas but I'm not certain. For my purposes I don't think Win9x support is an issue, so I may use a patched version that relies on various Unicode APIs. I'm really only needing NSIS to support Unicode in the system paths like to the desktop and start menu etc... I'm not planning on extending suport to anywhere else at the moment, we'll see how things go.<br />
<br />
Thanks,<br />
Richard</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">29th January 2006, 23:19</div></div><div class="posttext">The best thing would be to have NSIS scripts and language files in some Unicode format (probably UTF-8 for some backwards compatibility with US-ASCII). During run-time, all strings in memory should then be Unicode.<br />
<br />
Whenever the installer would run on a Win9x system the Unicode data should be converted to ANSI before making an API call without Unicode support.<br />
<br />
You see this system in many applications that still need to be compatible with Win9x. It is however a lot of work to add this feature to NSIS, so contributions would be very welcome.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">31st January 2006, 17:59</div></div><div class="posttext">Richard, the guy in charge will fill you in on the details. As far as I know, there in-progress patches which are ready enough to work.<br />
<br />
Joost, it's a bit more complicated than that. There's a problem of backward compatibility with plug-ins and scripts. Using UTF-8 will practically kill every string handling script. However, using UTF-16 will kill plug-in backward compatibility.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">richardv</div><div class="date">31st January 2006, 20:01</div></div><div class="posttext">kichik,<br />
<br />
Great, if there are some reasonably complete patches around then it would be great to try/test them out. Who's in charge of the effort?<br />
<br />
If I had to choose I'd go with UTF-16 internally and require that plugins would have to be patched and recompiled. I think the translations should be able to be converted.<br />
<br />
I suppose it also depends how far you go with Unicode, ideally the scripts could include Unicode characters as well, UTF-8 would seem to be a good option for scripts and language files and could be converted to UTF-16 when read in and NSIS would be all UTF-16 internally like Windows is. Just a thought.<br />
<br />
Thanks,<br />
Richard</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">31st January 2006, 20:07</div></div><div class="posttext">Benski is working on Unicode support. There are no complete or even half-complete patches (missed a couple of words in the last message).<br />
<br />
The format of the script itself is irrelevant. That can be easily converted. It's the internal string format that matters most.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>