<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Components page and modern.bmp, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Components page and modern.bmp NSIS Discussion" />
	
	<title> Components page and modern.bmp [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Components page and modern.bmp</div>
<hr />
<div class="pda"><a href="t-275187.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=275187">Components page and modern.bmp</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">luthar</div><div class="date">31st July 2007, 17:36</div></div><div class="posttext">Hello,<br />
<br />
I was wondering when each icon (for checkbox, see modern.bmp) are used.<br />
<br />
I know that if you put a section to RO (with SectionIn). It will used the last icon in the modern.bmp. <br />
<br />
Yet when using ButtonEvent plugin and changing the EnableWindow (to disable it), the icon of other section (not ROed in their section) does not change to a *disabled* state.<br />
<br />
Is this normal?<br />
<br />
Here is the problem:<br />
http://img123.imageshack.us/my.php?image=testya6.jpg</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">31st July 2007, 17:57</div></div><div class="posttext">Please attach the code that you are using to change the section flag.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">luthar</div><div class="date">31st July 2007, 18:13</div></div><div class="posttext">;-------------------------------------<br />
; Component page, shows all sections<br />
  !define MUI_PAGE_CUSTOMFUNCTION_Show Component_Show<br />
<br />
#needed to reinitialize variable!<br />
  !define MUI_PAGE_CUSTOMFUNCTION_Pre Component_Leave<br />
<br />
  !define MUI_PAGE_CUSTOMFUNCTION_Leave Component_Leave<br />
  !insertmacro MUI_PAGE_COMPONENTS<br />
<br />
var SectionSECDotNetFlags<br />
var SectionSECMatlabFlags<br />
<br />
Function Component_Leave<br />
<br />
  # Unload the plugin.<br />
  # If we don't do this, the DLL file remains<br />
  # locked and cannot be deleted.<br />
  ButtonEvent::Unload<br />
<br />
FunctionEnd<br />
<br />
Function Component_Show<br />
MessageBox MB_ICONINFORMATION|MB_OK &quot;SHOW&quot;<br />
<br />
	# Create event handler for our Components page button.<br />
  	GetFunctionAddress $R0 Component_Modification<br />
  	ButtonEvent::AddEventHandler /NOUNLOAD 1200 $R0<br />
  	StrCpy $DefaultCheckBox &quot;1&quot;<br />
<br />
	# Set Text<br />
  	FindWindow $R0 &quot;#32770&quot; &quot;&quot; $HWNDPARENT<br />
  	GetDlgItem $R1 $R0 1200<br />
<br />
  	SendMessage $R1 ${WM_SETTEXT} 0 'STR:$(COMPONENT_OVERRIDE_DEFAULT)'<br />
  	SendMessage $R1 ${BM_SETCHECK} $DefaultCheckBox 0 <br />
<br />
	Call UpdateSectionBox<br />
<br />
FunctionEnd<br />
<br />
Function Component_Modification<br />
<br />
MessageBox MB_ICONINFORMATION|MB_OK &quot;Modification...&quot; <br />
<br />
<br />
	# Swap Values of Checkbox<br />
	${If} $DefaultCheckBox == 1 <br />
  		Strcpy $DefaultCheckBox &quot;0&quot;<br />
	${Else} <br />
		StrCpy $DefaultCheckBox &quot;1&quot;	<br />
	${EndIf}<br />
<br />
	# Has user checked the check box ?<br />
	FindWindow $R0 &quot;#32770&quot; &quot;&quot; $HWNDPARENT<br />
	GetDlgItem $R1 $R0 1200<br />
  <br />
	SendMessage $R1 ${BM_SETCHECK} $DefaultCheckBox 0 <br />
<br />
<br />
	Call UpdateSectionBox<br />
	<br />
	<br />
<br />
FunctionEnd<br />
<br />
<br />
Function UpdateSectionBox<br />
var /GLOBAL SectionTempDotNet<br />
var /GLOBAL SectionTempMatlab<br />
<br />
	FindWindow $R0 &quot;#32770&quot; &quot;&quot; $HWNDPARENT<br />
<br />
	SectionGetFlags ${SECDotNet} $SectionTempDotNet<br />
	SectionGetFlags ${SECMatlab} $SectionTempMatlab<br />
<br />
	SectionSetFlags ${SECDotNet} $SectionSECDotNetFlags<br />
	SectionSetFlags ${SECMatlab} $SectionSECMatlabFlags<br />
<br />
	${If} $DefaultCheckBox == 1		<br />
		GetDlgItem $R1 $R0 1032		#1032 = TreeBox<br />
		EnableWindow $R1 0<br />
	${else}<br />
<br />
		GetDlgItem $R1 $R0 1032		#1032 = TreeBox<br />
		EnableWindow $R1 1<br />
	${EndIf}<br />
<br />
MessageBox MB_ICONINFORMATION|MB_OK &quot;Temp Flags (.Net\Matlab) = $SectionTempDotNet $SectionTempMatlab \n Real Flags (.Net\Matlab) = $SectionSECDotNetFlags $SectionSECMatlabFlags\n&quot; <br />
					<br />
<br />
<br />
	StrCpy $SectionSECDotNetFlags $SectionTempDotNet<br />
	StrCpy $SectionSECMatlabFlags $SectionTempMatlab<br />
<br />
<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">luthar</div><div class="date">31st July 2007, 18:30</div></div><div class="posttext">Forgot a piece of it... In the UpdateSectionBox<br />
<br />
${If} $DefaultCheckBox == 1	<br />
                IntOp $R4 ${SECTION_OFF} - ${SF_BOLD}<br />
		SectionSetFlags ${SECDotNet} $R4<br />
		SectionSetFlags ${SECMatlab} $R4	<br />
		GetDlgItem $R1 $R0 1032		#1032 = TreeBox<br />
		EnableWindow $R1 0<br />
	${else}<br />
<br />
		GetDlgItem $R1 $R0 1032		#1032 = TreeBox<br />
		EnableWindow $R1 1<br />
	${EndIf}<br />
}</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st August 2007, 13:33</div></div><div class="posttext">Not quite sure what the problem is.<br />
If I put this in the page leave function then call Abort, all works fine:<br />
<br />
SectionGetFlags 0 $R0<br />
IntOp $R0 $R0 | ${SF_SELECTED}<br />
IntOp $R0 $R0 | ${SF_RO}<br />
SectionSetFlags 0 $R0<br />
<br />
To unset these flags, first check that they are set using the &amp; operator and then use the ^ operator to unset them.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">luthar</div><div class="date">1st August 2007, 14:14</div></div><div class="posttext">After much testing here are my conclusions:<br />
===============<br />
- The modifications in the PRE functions works fine.<br />
- The modifications in the Show function work fine.<br />
<br />
When using the ButtonEvent handler, I can modify the Flags (the setup program understands the flag modification) but no trigger to update the GUI (remove check) is called.<br />
<br />
Is this a bug?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st August 2007, 14:46</div></div><div class="posttext">I wasn't quite sure what you wanted the check box to do, but see this script I made.<br />
<br />
The trick is to modify the components on page leave.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">luthar</div><div class="date">1st August 2007, 15:17</div></div><div class="posttext">It is exactly what I did after your reply. Works great..<br />
<br />
Seems the Leave function calls an update of the GUI when we do abort.<br />
<br />
I don't know if having a function to update the current GUI might become handy for futur installer development.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st August 2007, 15:42</div></div><div class="posttext">That would be handy indeed. Something that does exactly what we have used but without the use of a temporary boolean variable and the SendMessage.<br />
<br />
Perhaps an addition to the ButtonEvent plug-in. I shall try this out.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st August 2007, 16:59</div></div><div class="posttext">I have uploaded a new version.<br />
<br />
1. Use /NOTIFY instead of passing the function address.<br />
2. In your page leave function use ButtonEvent::WhichButtonId /NOUNLOAD followed by Pop $Var which you then check the value of. $Var will equal 1200 or 0 otherwise.<br />
<br />
ButtonEvent::WhichButtonId will also work in functions tied to buttons, in case one wants to use the same function for more than one button.<br />
<br />
Finally, I have added ButtonEvent::UnsetEventHandler to free an event handler slot (although this isn't necessary unless you need &gt;8 buttons.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">luthar</div><div class="date">1st August 2007, 18:58</div></div><div class="posttext">I think the DLL in the .Zip at (http://nsis.sourceforge.net/File:ButtonEvent.zip) is not the correct version.<br />
<br />
I tried your example NSI and even when putting a MessageBox command in the leave, it never gets triggered.<br />
<br />
File Info of DLL:<br />
=================<br />
Size: 4,096 bytes<br />
Date of Modification: August 1, 2007, 4:14:22 PM<br />
=================</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st August 2007, 19:32</div></div><div class="posttext">Sorry you were right. I fixed that exact issue about 30 minutes later but didn't copy the new DLL or source code into the Zip.<br />
<br />
Uploaded again.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">luthar</div><div class="date">1st August 2007, 20:08</div></div><div class="posttext">Works now... <br />
<br />
Found a bug tought:<br />
=========================<br />
Take your Examples\ButtonEvent\ButtonEventNotify.nsi script.<br />
<br />
Compile and Run <br />
-&gt; Click Next<br />
-&gt; Click I Agree<br />
-&gt; Click on your &quot;I like cheese&quot; button (it works).<br />
-&gt; click on Back<br />
-&gt; click on I Agree<br />
-&gt; Click on your &quot;I like cheese&quot; button (it doesn't work!).<br />
<br />
I had this problem and thw workaround is to create a Pre function and unload the plugin. Funny part is if I try to unset the handler for ID 1200, it crashes...<br />
<br />
<br />
Function Component_Pre<br />
	ButtonEvent::Unload<br />
	#ButtonEvent::UnsetEventHandler 1200<br />
	Strcpy $DefaultCheckBox &quot;0&quot;<br />
	Call DefaultCheckBox_Modification<br />
FunctionEnd<br />
<br />
<br />
Also, it would be good to put in a readme to not do the following:<br />
<br />
Function Component_Leave<br />
var /GLOBAL CheckBoxChanged<br />
<br />
	# If CheckboxDefault Event<br />
	ButtonEvent::WhichButtonId /NOUNLOAD<br />
	Pop $CheckBoxChanged<br />
<br />
<br />
	${If} $CheckBoxChanged == 1200<br />
		Call DefaultCheckBox_Modification<br />
		Abort<br />
	${Else}<br />
<br />
                # Unloading the ButtonEvent plugin here<br />
                # makes the installer crash!<br />
                ButtonEvent::Unload<br />
 <br />
	${EndIf}<br />
<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st August 2007, 20:26</div></div><div class="posttext">In the readme for ::Unload<br />
This must be called once in the .onGUIEnd function.<br />
<br />
It will crash anywhere else because the plug-in effectively takes control of the dialogs so if you unload the plug-in while the dialogs are visible it is going to crash.<br />
<br />
I shall look into the other problem now.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st August 2007, 21:17</div></div><div class="posttext">This works but it is not finalised. I shall post here when it is complete (have some questions for kichik).<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">3rd August 2007, 18:24</div></div><div class="posttext">I have now uploaded the new version.<br />
http://nsis.sourceforge.net/File:ButtonEvent.zip<br />
<br />
Stu</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>