<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Installation question, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Installation question NSIS Discussion" />
	
	<title> Installation question [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Installation question</div>
<hr />
<div class="pda"><a href="t-218895.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=218895">Installation question</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">new NSIS user</div><div class="date">14th June 2005, 20:29</div></div><div class="posttext">Hello,<br />
I'm writing a scriptpackage for Counter-Strike Source.<br />
I want to have a good installer, and i found the very good progtam NSIS. I've finished nearly everything, only one problem left: I want the installer to find the right directory. Problem? THe directory contains a various username, I don't know how to finish it.<br />
HKLM &quot;SOFTWARE\Valve\Steam&quot; &quot;InstallPath&quot;  &lt;&lt;the registry key which contains the steam directory.<br />
But the script has to be installed <br />
steam\steamapps\&lt;&lt;ACCOUNTNAME&gt;&gt;\counter-strike source\cstrike<br />
<br />
can anyone help me plz?<br />
A complete solution would be very nice!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">15th June 2005, 01:23</div></div><div class="posttext">ReadINIStr $INSTDIR HKCU &quot;Software\Valve\Steam&quot; &quot;ModInstallPath&quot;<br />
StrCmp $INSTDIR &quot;&quot; noInstDirFound<br />
 Push $INSTDIR<br />
  Call GetParent<br />
 Pop $INSTDIR<br />
 StrCpy $INSTDIR &quot;$INSTDIR\counter-strike source\cstrike&quot;<br />
Goto instDirFound<br />
noInstDirFound:<br />
 ReadINIStr $INSTDIR HKCU &quot;Software\Valve\Steam&quot; &quot;SourceModInstallPath&quot;<br />
 Push $INSTDIR<br />
  Call GetParent<br />
 Pop $INSTDIR<br />
 StrCpy $INSTDIR &quot;$INSTDIR\&lt;&lt;ACCOUNTNAME&gt;&gt;\counter-strike source\cstrike&quot;<br />
instDirFound:<br />
<br />
This first uses ModInstallPath (which will exist if user has Half-Life 1 installed) or SourceModInstallPath for Half-Life 2.<br />
ModInstallPath will contain the Steam account name whereas SourceModInstallPath will not.<br />
<br />
Edit: You need GetParent which you can find in NSIS docs or on the archive (http://nsis.sf.net/archive).<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">new NSIS user</div><div class="date">15th June 2005, 19:41</div></div><div class="posttext">thank you for youre nice help, but i still got a problem: <br />
getparent is this one, isn't it?<br />
<br />
<br />
 Function GetParent<br />
 <br />
   Exch $R0<br />
   Push $R1<br />
   Push $R2<br />
   Push $R3<br />
   <br />
   StrCpy $R1 0<br />
   StrLen $R2 $R0<br />
   <br />
   loop:<br />
     IntOp $R1 $R1 + 1<br />
     IntCmp $R1 $R2 get 0 get<br />
     StrCpy $R3 $R0 1 -$R1<br />
     StrCmp $R3 &quot;\&quot; get<br />
     Goto loop<br />
   <br />
   get:<br />
     StrCpy $R0 $R0 -$R1<br />
     <br />
     Pop $R3<br />
     Pop $R2<br />
     Pop $R1<br />
     Exch $R0<br />
     <br />
 FunctionEnd<br />
i couldn't find a DL-link, neither in the archive nor with google. THis code was in the NSIS manual<br />
<br />
Youre code has to be in a function, otherwise there is an error.<br />
How shell I use it?<br />
making a function disables the error, but if I use the installer, the directory field is empty.<br />
How to set InstDir or InstDirRegKey ???<br />
thank  you 4 everything!!!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">16th June 2005, 19:38</div></div><div class="posttext">Place my code in Function .onInit<br />
<br />
Function .onInit<br />
...<br />
FunctionEnd<br />
<br />
I did mention NSIS manual (NSIS docs)<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">new NSIS user</div><div class="date">17th June 2005, 23:29</div></div><div class="posttext">hey wo it works thanx!!!!!!!!!!!!!!!<br />
<br />
just one question left:<br />
isn't there a possibility the program detects the accountname automatically???<br />
<br />
its good like that, but i would prefer if the user didn't have to enter his accountname<br />
but - i coul leave it like this, it just would be the PERFECT solution :)<br />
<br />
but a big thx 2 u afrow you know how the program works !!!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">18th June 2005, 01:02</div></div><div class="posttext">Here you go:<br />
Function .onInit<br />
 Call GetSteamAccountName<br />
 Pop $R0<br />
 Pop $INSTDIR<br />
  StrCmp $R0 &quot;&quot; 0 +4<br />
   MessageBox MB_OKCANCEL|MB_ICONEXCLAMATION &quot;Steam does not appear to be installed!$\r$\n$\r$\nContinue anyway?&quot; IDOK +2<br />
   Abort<br />
    StrCpy $INSTDIR &quot;C:\Valve\Steam\SteamApps\[ACCOUNT_NAME]&quot;<br />
 StrCpy $INSTDIR &quot;$INSTDIR\counter-strike source\cstrike&quot;<br />
FunctionEnd<br />
<br />
Function GetSteamAccountName<br />
Push $R0<br />
Push $R1<br />
Push $R2<br />
Push $R3<br />
<br />
 ReadRegStr $R0 HKCU &quot;Software\Valve\Steam&quot; &quot;SteamExe&quot;<br />
 StrCmp $R0 &quot;&quot; error<br />
 StrCpy $R1 0<br />
  IntOp $R1 $R1 - 1<br />
  StrCpy $R2 $R0 1 $R1<br />
  StrCmp $R2 &quot;&quot; noAccount<br />
  StrCmp $R2 &quot;/&quot; 0 -3<br />
 StrCpy $R0 $R0 $R1<br />
<br />
 StrCpy $R1 0<br />
  IntOp $R1 $R1 + 1<br />
  StrCpy $R2 $R0 1 -$R1<br />
  StrCmp $R2 &quot;&quot; +8<br />
  StrCmp $R2 &quot;/&quot; 0 -3<br />
 StrCpy $R2 $R0 -$R1<br />
 IntOp $R1 $R1 - 1<br />
 StrCpy $R3 $R0 &quot;&quot; -$R1<br />
 StrCpy $R0 &quot;$R2\$R3&quot;<br />
 IntOp $R1 $R1 + 1<br />
 Goto -9<br />
<br />
 FindFirst $R1 $R2 &quot;$R0\steamapps\*.*&quot;<br />
 loopFile:<br />
  StrCmp $R2 &quot;SourceMods&quot; nextFile<br />
  StrCmp $R2 &quot;.&quot;          nextFile<br />
  StrCmp $R2 &quot;..&quot;         nextFile<br />
<br />
  IfFileExists &quot;$R0\steamapps\$R2\*.*&quot; done<br />
<br />
 nextFile:<br />
  ClearErrors<br />
  FindNext $R1 $R2<br />
  IfErrors 0 loopFile<br />
 FindClose $R1<br />
<br />
 noAccount:<br />
  StrCpy $R2 &quot;[ACCOUNT_NAME]&quot;<br />
<br />
 done:<br />
  StrCpy $R1 &quot;$R0\steamapps\$R2&quot;<br />
  StrCpy $R0 $R2<br />
  Goto +3<br />
<br />
 noSteam:<br />
  StrCpy $R1 &quot;&quot;<br />
  StrCpy $R0 &quot;&quot;<br />
<br />
Pop $R3<br />
Pop $R2<br />
Exch $R1<br />
Exch<br />
Exch $R0<br />
FunctionEnd<br />
<br />
<br />
If no account name is found, &quot;[ACCOUNT_NAME]&quot; is used instead (can't use &lt; or &gt; in paths).<br />
<br />
Notice that I've got Function .onInit in the new script, so you need to replace the whole of the old .onInit function (including all the code I posted before) with this new code.<br />
I added a message box if Steam is not installed.<br />
<br />
The function gets the Steam path from the registry (and has to remove steam.exe from end and convert all / to \) and then it searches the SteamApps folder for any folder other than one called &quot;SourceMods&quot; which will be the account name.<br />
<br />
I'll put the script on the archive for others to use.<br />
<br />
Usage:<br />
Call GetSteamAccountName<br />
Pop $R0<br />
Pop $R1<br />
<br />
Where $R1 is e.g. &quot;d:\games\valve\steam\steamapps\afrow uk&quot; and $R0 is &quot;afrow uk&quot;<br />
Both $R0 or $R1 will be &quot;&quot; if Steam is not installed.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">new NSIS user</div><div class="date">18th June 2005, 15:20</div></div><div class="posttext">wow afrow 4 president!!!!!!!<br />
fantastic!!!<br />
<br />
first i got an error, after the installer seemed to be compiled<br />
Processed 1 file, writing output:<br />
Adding plug-ins initializing function... Done!<br />
Error: could not resolve label &quot;error&quot; in function &quot;GetSteamAccountName&quot;<br />
Error - aborting creation process<br />
<br />
<br />
it only worked after i changed this one:<br />
StrCmp $R0 &quot;&quot; error<br />
to this one:<br />
;StrCmp $R0 &quot;&quot; error<br />
im not sure if your error-message and so work now, I have got 2 PCs, but both with steam installed...<br />
<br />
This seems to be the last small bug, the rest is pretty PERFECT!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">new NSIS user</div><div class="date">18th June 2005, 15:23</div></div><div class="posttext">sry 4 2 posts, I'm not a registered user so I can't edit anything ...<br />
I just wanted to say, that, if i change this:<br />
 StrCmp $R0 &quot;&quot; error<br />
for example to this<br />
 StrCmp $R0 &quot;&quot; rror<br />
the error-message at the end of the compiler was the same, just the error changed to rror<br />
<br />
I hope i could help you a little (after you helped me so much!)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">18th June 2005, 16:38</div></div><div class="posttext">Sorry,<br />
StrCmp $R0 &quot;&quot; error<br />
should be<br />
StrCmp $R0 &quot;&quot; noSteam<br />
<br />
-Stu</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>