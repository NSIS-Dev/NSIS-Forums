<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" ${If} ${UserIsAdmin}, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  ${If} ${UserIsAdmin} NSIS Discussion" />
	
	<title> ${If} ${UserIsAdmin} [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  ${If} ${UserIsAdmin}</div>
<hr />
<div class="pda"><a href="t-308950.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=308950">${If} ${UserIsAdmin}</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Zinthose</div><div class="date">27th July 2009, 16:18</div></div><div class="posttext">I patched together a macro for use with the LogicLib library to easily check if the security context has Administrative rights.<br />
<br />
Feedback is practically non existent on the wiki as most of the activity appears to be here in the forums.<br />
<br />
It has been quite handy in my projects...  Enjoy. :)<br />
<br />
; -----------------------<br />
;       UserIsAdmin<br />
; -----------------------<br />
;<br />
;   Example:<br />
;       ${If} ${UserIsAdmin}<br />
;           DetailPrint &quot;Current user security context has local administrative rights.&quot;<br />
;       ${Else}<br />
;           DetailPrint &quot;Current user security context dose NOT have local administrative rights.&quot;<br />
;       ${EndIf}<br />
;<br />
    !macro _UserIsAdmin _a _b _t _f<br />
        System::Store 'p0 p1 p2 p3'<br />
        System::Call '*(&amp;i1 0,&amp;i4 0,&amp;i1 5)i.r0'<br />
        System::Call 'advapi32::AllocateAndInitializeSid(i r0,i 2,i 32,i 544,i 0,i 0,i 0,i 0,i 0,i 0,*i .r1)i.r2'<br />
        System::Free $0<br />
        System::Call 'advapi32::CheckTokenMembership(i n,i r1,*i .r2)i.r3'<br />
        System::Call 'advapi32::FreeSid(i r1)i.r2'<br />
        <br />
        StrCmp $3 0 0 +4<br />
        ## User is an Admin<br />
            System::Store 'r0 r1 r2 r3'<br />
            Goto `${_f}`<br />
            <br />
        ## User is not an Admin<br />
            System::Store 'r0 r1 r2 r3'<br />
            Goto `${_t}`<br />
<br />
    !macroend</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">27th July 2009, 16:43</div></div><div class="posttext">I think your +4 jump is one too many. Also, where is your define for UserIsAdmin.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Zinthose</div><div class="date">27th July 2009, 23:27</div></div><div class="posttext">Ah, good eye..   =)<br />
<br />
Here is the corrected macro.<br />
<br />
; ----------------------------<br />
;       LogicLib_Ext.nsh<br />
; ----------------------------<br />
;<br />
; Library to extend the 'LogicLib' library's existing functions.<br />
;<br />
 <br />
 <br />
!ifndef ___LOGICLIB_EXT__NSH___<br />
!define ___LOGICLIB_EXT__NSH___<br />
 <br />
!include 'LogicLib.nsh'<br />
 <br />
; -----------------------<br />
;       UserIsAdmin<br />
; -----------------------<br />
;<br />
;   Example:<br />
;       ${If} ${UserIsAdmin}<br />
;           DetailPrint &quot;Current user security context has local administrative rights.&quot;<br />
;       ${Else}<br />
;           DetailPrint &quot;Current user security context dose NOT have local administrative rights.&quot;<br />
;       ${EndIf}<br />
;<br />
    !macro _UserIsAdmin _a _b _t _f<br />
        System::Store 'p0 p1 p2 p3'<br />
        System::Call '*(&amp;i1 0,&amp;i4 0,&amp;i1 5)i.r0'<br />
        System::Call 'advapi32::AllocateAndInitializeSid(i r0,i 2,i 32,i 544,i 0,i 0,i 0,i 0,i 0,i 0,*i .r1)i.r2'<br />
        System::Free $0<br />
        System::Call 'advapi32::CheckTokenMembership(i n,i r1,*i .r2)i.r3'<br />
        System::Call 'advapi32::FreeSid(i r1)i.r2'<br />
 <br />
        StrCmp $3 0 0 +3<br />
        ## User is an Admin<br />
            System::Store 'r0 r1 r2 r3'<br />
            Goto `${_f}`<br />
 <br />
        ## User is not an Admin<br />
            System::Store 'r0 r1 r2 r3'<br />
            Goto `${_t}`<br />
 <br />
    !macroend<br />
    !define UserIsAdmin `&quot;&quot; UserIsAdmin &quot;&quot;`<br />
 <br />
!endif <br />
<br />
FYI: The Latest version can always be found at: NSIS WIKI - UserIsAdmin (http://nsis.sourceforge.net/LogicLib_-_UserIsAdmin)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">27th July 2009, 23:50</div></div><div class="posttext">you could probably optimize this a bit, you could build the SID in a system struct without calling AllocateAndInitializeSid and FreeSid, and if you store the result from CheckTokenMembership on the stack, you could probably just have one system::store to restore and pop into the logiclib temp var, and if you did both there would only be need for one register and no need to call store at all</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">28th July 2009, 12:36</div></div><div class="posttext">As usual, I can't help myself, so here is my take on it:<br />
<br />
!macro _UserIsAdminNT5 _a _b _t _f<br />
Push $1<br />
!insertmacro _LOGICLIB_TEMP<br />
System::Call '*(&amp;i1 1,&amp;i1 2,&amp;i5,&amp;i1 5,&amp;i4 32,&amp;i4 544)i.r1' ;S-1-5-32-544<br />
System::Call 'advapi32::CheckTokenMembership(i n,i r1,*i.s)i.s'<br />
System::Free $1<br />
Pop $1<br />
Pop $_LOGICLIB_TEMP<br />
IntCmpU $1 0 0 +2 +2<br />
StrCpy $_LOGICLIB_TEMP 0<br />
Pop $1<br />
!insertmacro _!= $_LOGICLIB_TEMP 0 `${_t}` `${_f}`<br />
!macroend<br />
!define UserIsAdminNT5 `&quot;&quot; UserIsAdminNT5 &quot;&quot;` <br />
<br />
Section<br />
${If} ${UserIsAdminNT5}<br />
	DetailPrint &quot;admin&quot;<br />
${Else}<br />
	DetailPrint &quot;not admin&quot;<br />
${EndIf}<br />
SectionEnd<br />
<br />
<br />
I named it NT5 because CheckTokenMembership was added to windows 2000, if you need to support every OS, use the userinfo plugin</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Zinthose</div><div class="date">28th July 2009, 20:03</div></div><div class="posttext">Wow awesome Anders!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">ryanpager</div><div class="date">29th July 2009, 17:13</div></div><div class="posttext">Anders FTW!</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>