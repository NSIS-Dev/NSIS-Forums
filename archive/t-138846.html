<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Inconsistency/bug? with 'SetShellVarContext all ', media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Inconsistency/bug? with 'SetShellVarContext all ' NSIS Discussion" />
	
	<title> Inconsistency/bug? with 'SetShellVarContext all ' [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Inconsistency/bug? with 'SetShellVarContext all '</div>
<hr />
<div class="pda"><a href="t-138846.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=138846">Inconsistency/bug? with 'SetShellVarContext all '</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Lilla</div><div class="date">13th June 2003, 03:06</div></div><div class="posttext">Observation, with latest CVS, just downloaded<br />
<br />
under Win98SE, the code below adds<br />
desktop shortcuts to c:\Windows\All Users\Desktop<br />
 *but adds*<br />
startmenu shortcuts to c:\Windows\StartMenu<br />
<br />
Is this inconsistency a bug?<br />
<br />
 <br />
  SetShellVarContext all<br />
<br />
  ;Create startmenu shortcuts<br />
  CreateDirectory &quot;$SMPROGRAMS\${MUI_PRODUCT}&quot;<br />
  CreateShortCut &quot;$SMPROGRAMS\${MUI_PRODUCT}\Uninstall.lnk&quot; &quot;$INSTDIR\Uninstall.exe&quot;<br />
<br />
  CreateShortcut &quot;$SMPROGRAMS\${MUI_PRODUCT}\cleanNdefrag.lnk&quot; &quot;$INSTDIR\Gui4Cli.exe&quot; '-instance cleanNdefrag &quot;$INSTDIR\cleanNdefrag\cleanNdefrag.gui&quot;'<br />
<br />
  ;Create desktop shortcuts<br />
  CreateShortcut &quot;$DESKTOP\cleanNdefrag.lnk&quot; &quot;$INSTDIR\Gui4Cli.exe&quot; '-instance cleanNdefrag &quot;$INSTDIR\cleanNdefrag\cleanNdefrag.gui&quot;'</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">13th June 2003, 10:28</div></div><div class="posttext">Isn't C:\Windows\StartMenu the start menu directory for all users? What do you get with SetShellVarContext current?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">virtlink</div><div class="date">13th June 2003, 11:49</div></div><div class="posttext">At my computer (Win XP), the Start Menu is in the 'All users'-directory.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Lilla</div><div class="date">13th June 2003, 18:42</div></div><div class="posttext">To read a summary of the NSIS problem jump to the end of this post.<br />
<br />
It looks like Office XP created the c:\WINDOWS\All Users\... folders that appear on this Win98SE system, as explained below.<br />
<br />
This Win98SE system is a recent clean install on a freshly formatted drive. It includes IE6, Office XP, DUN 1.4, Jet4SP6, and a number of other updates. I am the only user of this system so it is a good model system. This system has (and has always had the same) one user/profile defined.<br />
<br />
This system has the folders shown below...<br />
<br />
It is important to note that Office XP has placed two files in the C:\WINDOWS\All Users\...\Data folder (namely Data.dat and Data.bak) and *all* other 'All Users' folders are totally empty. This is with 'Show All Files' setting.<br />
<br />
---<br />
<br />
The All Users folders... <br />
<br />
C:\WINDOWS<br />
C:\WINDOWS\All Users<br />
C:\WINDOWS\All Users\Application Data\Microsoft<br />
C:\WINDOWS\All Users\Application Data\Microsoft\HTML Help<br />
C:\WINDOWS\All Users\Application Data\Microsoft\Office<br />
C:\WINDOWS\All Users\Application Data\Microsoft\Office\Data<br />
C:\WINDOWS\All Users\Desktop<br />
C:\WINDOWS\All Users\DRM<br />
C:\WINDOWS\All Users\Start Menu<br />
C:\WINDOWS\All Users\Start Menu\Programs<br />
C:\WINDOWS\All Users\Start Menu\Programs\Startup<br />
<br />
----<br />
<br />
The normal folders...<br />
<br />
C:\WINDOWS\Application Data\ ... lots of entries below here<br />
C:\WINDOWS\Desktop\<br />
C:\WINDOWS\Start Menu<br />
C:\WINDOWS\Start Menu\Programs\ ... lots of entries below here<br />
C:\WINDOWS\Start Menu\Programs\Startup<br />
<br />
---------------<br />
<br />
NSIS documentation says... <br />
<br />
SetShellVarContext<br />
current|all<br />
<br />
Sets the context of $SMPROGRAMS and other shell folders. If set to 'current' (the default), the current user's shell folders are used. If set to 'all', the 'all users' shell folder is used. The all users folder may not be supported on all OSes. If the all users folder is not found, the current user folder will be used. Please take into consideration that a &quot;normal user&quot; has no rights to write in the all users area. Only admins have full access rights to the all users area. You can check this by using the UserInfo Plugin. See Contrib\UserInfo\UserInfo.nsi for an example.<br />
<br />
---<br />
<br />
To summarize the problem with the latest NSIS CVS:<br />
<br />
Currently, when 'all' is set on a Win98SE system with Office XP installed, NSIS adds shortcuts inconsistently<br />
- NSIS adds desktop shortcuts to the 'All Users' folder <br />
(c:\WINDOWS\All Users\Desktop) <br />
- NSIS adds start menu shortcuts to the 'Current User' (C:\WINDOWS\Start Menu)<br />
- Futher, the uninstall does not remove the desktop shortcuts that it placed in the 'All Users' folder.<br />
<br />
Thus, the new information that NSIS needs to take into consideration is that a Win9x system with Office XP installed will have an 'All Users' folder, but you should *not* use it (at least that is how it appears to me). <br />
<br />
I hope this additional information is helpful,<br />
Lilla</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">15th June 2003, 17:48</div></div><div class="posttext">I don't know what Microsoft XP thinks it's doing but &quot;C:\WINDOWS\Start Menu&quot; can't a certain user's start menu folder, there is no user name there... SetShellVarContext works fine on my Windows 98 and Windows XP.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Lilla</div><div class="date">15th June 2003, 19:30</div></div><div class="posttext">Kichik, I believe the problem I am reporting will be seen on any Win9x machine that has Office XP install (I haven't tested Office 2000, so I cannot say if same is true there, but it might be.)<br />
<br />
To workaround this, I have added this test to my code:<br />
<br />
  Call GetWindowsVersion<br />
  Pop $7 ; at this point $7 is &quot;NT 4.0&quot; or whatnot<br />
  !define WIN_VER $7 ; create a global variable<br />
  ; MessageBox MB_OK &quot;GetWindowsVersion ${WIN_VER}&quot;<br />
<br />
  StrCmp ${WIN_VER} &quot;95&quot; CurrentUser<br />
  StrCmp ${WIN_VER} &quot;98&quot; CurrentUser<br />
  StrCmp ${WIN_VER} &quot;98 SE&quot; CurrentUser<br />
    SetShellVarContext all<br />
  CurrentUser:  ; current is the default<br />
<br />
Lilla</div></div><hr />


<div class="post"><div class="posttop"><div class="username">deguix</div><div class="date">15th June 2003, 19:55</div></div><div class="posttext">Occur EXATLY that he/she say with my computer too (I have Office XP and Win 98 SE).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">15th June 2003, 19:56</div></div><div class="posttext">BTW, as for the uninstaller, SetShellVarContext isn't remember from the installer, you have to set it again.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">deguix</div><div class="date">15th June 2003, 20:09</div></div><div class="posttext">Is not a NSIS bug, because lack a reg string that say the All Users Start Menu, so NSIS will use the current one (but if you use the $SMSTARTUP or $DESKTOP, see that will be used the All Users folder).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Lilla</div><div class="date">16th June 2003, 20:48</div></div><div class="posttext">kichik, that's for that extra information. <br />
I will add it to my uninstall.<br />
<br />
I think it would be great if there were an Example for AddRemovePrograms.<br />
<br />
Lilla</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joost Verburg</div><div class="date">16th June 2003, 21:23</div></div><div class="posttext">Check Appendix C.3 of the Users Manual for an Add/Remove Programs example &amp; info.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Lilla</div><div class="date">17th June 2003, 03:15</div></div><div class="posttext">My Add/Remove example is working fine now.<br />
<br />
Appendix C is good. Still, I think that a basic functional example would be helpful to many people. Just a thought.<br />
<br />
Your examples have helped me immensely, they make it easy to get started. Thank you for doing them!<br />
<br />
Lilla</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>