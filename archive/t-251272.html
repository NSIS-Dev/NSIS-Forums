<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" CustomLicense plug-in, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  CustomLicense plug-in NSIS Discussion" />
	
	<title> CustomLicense plug-in [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  CustomLicense plug-in</div>
<hr />
<div class="pda"><a href="t-251272.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=251272">CustomLicense plug-in</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">17th July 2006, 00:06</div></div><div class="posttext">Introducing my new plugin. It loads a text file into a static buffer, then can set that text into a text or label control that has a HWND. I have already made a wiki page, the link is below.<br />
<br />
http://nsis.sourceforge.net/CustomLicense_plug-in</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">23rd July 2006, 23:43</div></div><div class="posttext">Found out last week I have 3 weeks holiday, not 2 :D. So now I have released a new version. This loads the contents of the file into a dynamically created<br />
buffer. Max file size 305 666 bytes (298KB). See the wiki page above.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joel</div><div class="date">24th July 2006, 01:55</div></div><div class="posttext">Why not use EM_STREAMIN and void that malloc and free stuff</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">24th July 2006, 23:06</div></div><div class="posttext">I will take a look at it. I used the first method I found which was malloc and free, because that what the system plugin uses.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">SuperPat</div><div class="date">25th July 2006, 01:16</div></div><div class="posttext">Very Good.<br />
<br />
I use an other technique:<br />
I use the file open/write/close function to append the ini file with a large text.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Joel</div><div class="date">25th July 2006, 01:54</div></div><div class="posttext">Well... I saw your source code. Is nice and clean, but I found some things that you might want to check:<br />
<br />
FileHandle = CreateFile(FileName, GENERIC_READ, 0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);<br />
if (!FileHandle) ...<br />
<br />
According to msdn, when CreateFile fails, it returns INVALID_HANDLE_VALUE and as I remember is not zero.<br />
<br />
TempVar == &quot;/UNLOAD&quot;<br />
<br />
I don't think that's possible, you loose data and always will be true :), maybe lstrcmp.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">25th July 2006, 03:45</div></div><div class="posttext">Yeah, I will change it to say:<br />
if (!FileHandle || FileHandle == INVALID_HANDLE_VALUE)<br />
<br />
Don't know about the 'Temp == &quot;/UNLOAD&quot;' expression, but it seems to work just fine in my tests.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">1st August 2006, 23:26</div></div><div class="posttext">I have modified the plugin again, and now it has just one function called 'LoadFile'. Usage:<br />
<br />
CustomLicense::LoadFile &quot;C:\path\filetoload.txt&quot; &quot;hwndofcontrol&quot;<br />
<br />
The first parameter is obvious, the second is the hwnd of the control to load the text into. Example:<br />
Function Pre<br />
  installoptions::init &quot;$PLUGINSDIR\inipage.ini&quot;<br />
  Pop $0<br />
  ; See the installoptions readme for info on how <br />
  ; to get the field number.<br />
  ; Put the code between here...<br />
  ;FindWindow $0 &quot;#32770&quot; &quot;&quot; $HWNDPARENT<br />
  GetDlgItem $0 $0 1201<br />
  CustomLicense::LoadFile &quot;$PLUGINSDIR\license.txt&quot; &quot;$0&quot;<br />
  Pop $0<br />
  StrCmp $0 0 0 next<br />
    MessageBox MB_OK &quot;Error with CustomLicense plug-in.&quot;<br />
next:<br />
  ; ...and here in the show function if you want to <br />
  ; use this plugin with standard nsis pages.<br />
  installoptions::show<br />
FunctionEnd<br />
The actual plugin will probably be out on Monday next week.<br />
<br />
@Joel: I had a go at the EM_STREAMIN, but I had no idea on how it is supposed to work. I kept getting errors when I ran the test installer, and it is because it can't understand '-&gt;'. I first tried '.', but it gave me an error and told me to use '-&gt;'. It crashed at (example): struct-&gt;structmember = FileName. So I stayed with my current configuration.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st August 2006, 23:57</div></div><div class="posttext">Shouldn't:<br />
installoptions::init<br />
Be:<br />
InstallOptions:InitDialog<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">6th August 2006, 22:36</div></div><div class="posttext">True. I just have used installoptions passively with MUI and ISUI. Updated version is out. Go to the wiki page above to download.<br />
<br />
 fixed typo</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">7th August 2006, 06:54</div></div><div class="posttext">Your dll still depends on msvcrt.dll. You can easy change malloc-free to kernel.dll GloballAlloc-GlobalFree (Requires Windows 95 or later).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">7th August 2006, 23:59</div></div><div class="posttext">I suppose that is an innocent change to make. I will change it tonight. New version out tomorrow.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">9th August 2006, 00:14</div></div><div class="posttext">Well, I shouldn't get ahead of myself. I now have a small problem. There are now four weird characters at the end of the string after the text has been set in the control. If I take one byte off the number of bytes to read, it gets rid of the weird characters and chops off one byte off the string (a fullstop in my case). <br />
<br />
One workaround is to put an extra character at the end of the license file (eg a fullstop), but I don't want to have to tell users to do this before using my plugin. Any ideas?<br />
<br />
 I could manually add a terminating NULL character to the string. Would that work?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">9th August 2006, 00:26</div></div><div class="posttext">Yep, always make sure you put one on yourself: \0<br />
I missed this in early versions of my array plugin and it caused a few issues.<br />
<br />
Edit: Or make sure that you allocate an extra byte to allow for the null character on the end.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">9th August 2006, 00:39</div></div><div class="posttext">OK, will do. New version due out on Monday (really).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Takhir</div><div class="date">9th August 2006, 06:34</div></div><div class="posttext">The only comment in the script sample I wrote long ago is about terminating zero :) http://nsis.sourceforge.net/External_License_file</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">13th August 2006, 22:59</div></div><div class="posttext">Surprisingly, that example is almost exactly the same as the internals of my plugin :blah:. <br />
<br />
There is a new version out today. In the last version, I forgot to free the allocated memory, which is now fixed. Now uses GlobalAlloc and GlobalFree for memory allocation. <br />
<br />
My initial test to see how big a file I can load went very well. I managed to load a 483KB file with no errors on the first go :D. Please tell me how big a file you have managed to load with this plugin without a crash (this is a good way to test my plugin).<br />
<br />
When I was going to add the terminating zero, I relised I was not allocating enough memory for the whole file. I was always truncating the terminating zero, thus getting weird characters and some crashes from large files. Now I am allocating enough memory for the file and the terminating zero.<br />
<br />
Go to wiki to download (probably the last version for a while).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kfank</div><div class="date">1st March 2008, 08:12</div></div><div class="posttext">It appears that if the file path argument is &gt;= 64 characters then the function does not work.  Initial debugging of DLL seemed to show that the file argument was in fact getting passed in and parsed (the correct file was opened and read) but perhaps return from DLL is failing?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kfank</div><div class="date">3rd March 2008, 01:45</div></div><div class="posttext">Well, it's quite obvious that the stack variables are only allocated 64 bytes in the DLL.  This length is too short if the file passed in is in the $PLUGINSDIR.  I will post a DLL with larger buffer unless JasonFriday13 wants to.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">3rd March 2008, 10:39</div></div><div class="posttext">You are given the buffer length as one of the NSIS plug-in function arguments which you can use to allocate memory with LocalAlloc or GlobalAlloc.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">paolo.salvan</div><div class="date">15th January 2010, 10:06</div></div><div class="posttext">Hi all,<br />
<br />
...I've tried the last plug-in version and I've found the described bug (buffer overflow) still not solved (and I'm having random problems under Vista/7);<br />
<br />
I think that in CustomLicense.c the line:<br />
unsigned int LoadFileContents(char FileName[64], unsigned int hwnd)<br />
                                           ^^^^<br />
...should be changed to:<br />
unsigned int LoadFileContents(char FileName[256], unsigned int hwnd)<br />
                                           ^^^^^<br />
<br />
...but I've no build environment to compile the fix and public the fixed plugin, can someone fix it?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kfank</div><div class="date">26th January 2010, 00:03</div></div><div class="posttext">I have followed Afrow's advice to take the buffer size from the arguments and have built both Ansi and Unicode versions.  I've uploaded the build to:<br />
<br />
http://nsis.sourceforge.net/CustomLicense_plug-in</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DavidHall</div><div class="date">18th April 2011, 15:54</div></div><div class="posttext">Hi,<br />
<br />
I have a requirement to set the license text from a string - all my installer's configuration is dynamically configured at runtime from a Json file, including the license text.<br />
<br />
I have a couple of questions around Modern UI and the CustomLicense plugin.<br />
<br />
Firstly, is there any way to assign a variable to the license text, with or without CustomLicense?<br />
<br />
Secondly, if something like CustomLicense is needed, I could always write the license text to a temp file and then pass that to the plug-in but it would feel nicer to just pass the string. Would this be an appropriate patch for CustomLicense? Perhaps adding a new external function LoadText(...) Or should it be a new plug-in?<br />
<br />
In general, what is the correct procedure for extensions to plug-ins for NSIS? Would I be able to code a patch and then submit it for approval, or would the change need to be developed by an already trusted developer?<br />
<br />
Thanks,<br />
David Hall</div></div><hr />


<div class="post"><div class="posttop"><div class="username">T.Slappy</div><div class="date">19th April 2011, 06:06</div></div><div class="posttext">Firstly, is there any way to assign a variable to the license text, with or without CustomLicense?<br />
<br />
Actually I do not know what you mean...<br />
Do you want to set the text inside the RichEdit control on page License?<br />
You can do it in usual way [for .txt and .rtf files]:<br />
!insertmacro MUI_PAGE_LICENSE &quot;..\..\readme.txt&quot;<br />
-or-<br />
You can use WM_SETTEXT to send message to this control, this should work for pure text, not RTF.<br />
<br />
Secondly....... Perhaps adding a new external function LoadText(...) <br />
LoadText for what? Loading .txt files?<br />
Just create your file and load it with CustomeLicense (my example with nsDialogs):<br />
Var /Global RichEditLicense<br />
nsDialogs::CreateControl /NOUNLOAD RichEdit20A  ${WS_VISIBLE}|${WS_CHILD}|${WS_TABSTOP}|${WS_VSCROLL}|${ES_MULTILINE}|${ES_WANTRETURN}|${ES_READONLY} ${__NSD_Text_EXSTYLE} 0 13u 100% 115u ''<br />
Pop $RichEditLicense<br />
<br />
File /oname=$PLUGINSDIR\\License.rtf &quot;License.rtf&quot;<br />
CustomLicense::LoadFile $PLUGINSDIR\\License.rtf $RichEditLicense<br />
<br />
I did not tried this with standard License page but I suppose it should work (get HWND or RichEdit with GetDlgItem, do not forget to erase text in it)<br />
<br />
In general, what is the correct procedure for extensions to plug-ins for NSIS?<br />
Simply download existing plugin, improve it and put new version on wiki (+ sources).<br />
If you want to make large changes then rename this plugin to some cool name ant put it on wiki too (create new page for it).<br />
<br />
PS:<br />
There is bug in NSIS forums (php syntax) which hides backward slash &quot;\&quot; when this slash is not enclosed in quotation marks &quot;&quot; like here: <br />
Invisible backslash: \<br />
Visible backslash: &quot;\&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">19th April 2011, 10:04</div></div><div class="posttext">Loading the license text from a variable will not work because NSIS is limited to 1024 (or 8192: http://nsis.sf.net/Special_Builds) characters.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Marsianin</div><div class="date">25th January 2012, 07:55</div></div><div class="posttext">Used CustomLicense on ANSI NSIS with no issues.<br />
Now moved to Unicode one and there it loads RTF incorrectly.<br />
<br />
This code:<br />
nsDialogs::CreateControl /NOUNLOAD &quot;RichEdit20A&quot;<br />
  ${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS}|${WS_TABSTOP}|${ES_READONLY}|<br />
  ${WS_VSCROLL}|${ES_MULTILINE}|${ES_WANTRETURN} ${WS_EX_STATICEDGE} 0 0 100% 100% &quot;RichEdit&quot;<br />
Pop $dialog_text<br />
CustomLicense::LoadFile &quot;$PLUGINSDIR\$(MNHISTORY)&quot; $dialog_text<br />
nsDialogs::Show<br />
<br />
in ANSI version loads RTF into RichEdit perfectly but in Unicode version it loads just ???????? ????????? ???? ????????????<br />
But no problems loading TXT instead of the RTF into the same control.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">25th January 2012, 14:40</div></div><div class="posttext">I wrote this plug-in a couple of months back to replace CustomLicense in my projects:<br />
http://nsis.sourceforge.net/NsRichEdit_plug-in<br />
<br />
Edit: And why I decided to write a CustomLicense replacement:<br />
http://forums.winamp.com/showthread.php?t=333267<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Marsianin</div><div class="date">26th January 2012, 00:10</div></div><div class="posttext">Thanks! Yours works perfectly.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>