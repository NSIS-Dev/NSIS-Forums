<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" UAC plugin CallFunctionAsUser GetTempPath returns empty?, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  UAC plugin CallFunctionAsUser GetTempPath returns empty? NSIS Discussion" />
	
	<title> UAC plugin CallFunctionAsUser GetTempPath returns empty? [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  UAC plugin CallFunctionAsUser GetTempPath returns empty?</div>
<hr />
<div class="pda"><a href="t-304599.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=304599">UAC plugin CallFunctionAsUser GetTempPath returns empty?</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">BuilderBob</div><div class="date">25th March 2009, 16:00</div></div><div class="posttext">I want to make an installer with UAC plugin where I can detect some original user folders using the user level process, and then copying files to Program Files using the elevated admin user process.<br />
<br />
I began by finding the TEMP folder, calling GetTempPath using System plugin, but calling it in the user level process returns emtpy string or &quot;0&quot; (&quot;0&quot; if I run it in a virtual XP from a non-admin user, and when the elevation dialog pops I enter an admin user credentials).<br />
<br />
Can anybody tell me why it happens or how should I do it? Here's my complete script:<br />
<br />
SetCompressor lzma<br />
<br />
OutFile .\TempDir.exe<br />
<br />
Name &quot;TempDir&quot;<br />
VIProductVersion &quot;1.0.0.0&quot;<br />
VIAddVersionKey &quot;FileVersion&quot; &quot;1.0.0.0&quot;<br />
VIAddVersionKey &quot;FileDescription&quot; &quot;TempDir&quot;<br />
VIAddVersionKey &quot;ProductName&quot; &quot;TempDir&quot;<br />
VIAddVersionKey &quot;CompanyName&quot; &quot;Temp dir Inc.&quot;<br />
VIAddVersionKey &quot;LegalCopyright&quot; &quot;lalala (c) 2009&quot;<br />
RequestExecutionLevel user<br />
<br />
SilentInstall silent<br />
<br />
!include UAC.nsh<br />
!include LogicLib.nsh<br />
<br />
Function .OnInit<br />
    ${UAC.I.Elevate.AdminOnly}<br />
FunctionEnd<br />
<br />
Function .OnInstFailed<br />
	${UAC.Unload}<br />
FunctionEnd<br />
<br />
Function .OnInstSuccess<br />
	${UAC.Unload}<br />
FunctionEnd<br />
<br />
!define GetTemp &quot;!insertmacro GetTemp&quot;<br />
!macro GetTemp Answer<br />
	Call GetTemp<br />
	Pop ${Answer}<br />
!macroend<br />
!define UserGetTemp &quot;!insertmacro UserGetTemp&quot;<br />
!macro UserGetTemp Answer<br />
	${UAC.CallFunctionAsUser} GetTemp<br />
	Pop ${Answer}<br />
!macroend<br />
Function GetTemp<br />
	Push $R1<br />
	<br />
	Push $R0<br />
	System::Call &quot;*(&amp;t${NSIS_MAX_STRLEN}) i .R0&quot;<br />
	System::Call &quot;kernel32.dll::GetTempPathA(i ${NSIS_MAX_STRLEN}, i R0)&quot;<br />
	System::Call &quot;*$R0(&amp;t${NSIS_MAX_STRLEN} .R1)&quot;<br />
	System::Free $R0<br />
	Pop $R0<br />
	<br />
	Push $R2<br />
	StrCpy $R2 $R1 &quot;&quot; -1<br />
	${If} $R2 == &quot;\&quot;<br />
	${OrIf} $R2 == &quot;/&quot;<br />
	    StrCpy $R1 $R1 -1<br />
	${EndIf}<br />
	Pop $R2<br />
	<br />
	Exch $R1<br />
FunctionEnd<br />
<br />
Section<br />
	${UserGetTemp} $0<br />
	${GetTemp} $1<br />
	MessageBox MB_OK &quot;$$TEMP: $TEMP$\nUser Temp: $0$\nTemp: $1&quot;<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">25th March 2009, 16:07</div></div><div class="posttext">you can't read the &quot;user&quot; stack in the admin process<br />
<br />
you can use UAC::GetShellFolderPath (I can't remember if there is a CSIDL_TEMP)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>