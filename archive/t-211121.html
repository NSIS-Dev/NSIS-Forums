<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" System::Call Locking up, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  System::Call Locking up NSIS Discussion" />
	
	<title> System::Call Locking up [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  System::Call Locking up</div>
<hr />
<div class="pda"><a href="t-211121.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=211121">System::Call Locking up</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">turtlehand</div><div class="date">22nd March 2005, 22:15</div></div><div class="posttext">This simple script locks up at the first DetailPrint 'Return: &quot;$2&quot;'. This occurs on my W2K machine at work, it works fine on my W2K and XP Pro machines at home.<br />
<br />
The System::Call works, the correct path is displayed in the Title Bar of the window, but the window becomes unresponsive. No error message. If I comment out System::Call the script works, though it doesn't do anything.<br />
<br />
Script:<br />
<br />
SetPluginUnload  alwaysoff<br />
<br />
OutFile 'C:\Downloads\NSIS\Plugin.exe'<br />
Section main<br />
  InitPluginsDir<br />
<br />
  SetOutPath &quot;$PLUGINSDIR&quot;<br />
  File 'C:\Program Files\Palm\CondMgr.dll'                  ; copy dll there<br />
  StrCpy $1 ${NSIS_MAX_STRLEN}          ; assign memory to $0<br />
<br />
  System::Call 'CondMgr::CmGetCorePath(t, *i) i(.r0, r1r1).r2'<br />
<br />
  DetailPrint 'Return: &quot;$2&quot;'<br />
  DetailPrint 'Path: &quot;$0&quot;'<br />
<br />
; last plugin call must not have /NOUNLOAD so NSIS will be able to delete<br />
; the temporary DLL<br />
<br />
  SetPluginUnload manual<br />
; do nothing (but let the installer unload the System dll)<br />
  System::Free 0<br />
SectionEnd<br />
<br />
Any help appreciated.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">22nd March 2005, 22:45</div></div><div class="posttext">Wouldn't you have to register the dll first with RegDLL?<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">turtlehand</div><div class="date">23rd March 2005, 13:59</div></div><div class="posttext">No, this isn't a COM dll.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">23rd March 2005, 17:48</div></div><div class="posttext">Well, I'm not sure how dll calls work in general, but how would the System plugin know where CondMgr is?<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">turtlehand</div><div class="date">23rd March 2005, 17:51</div></div><div class="posttext">SetOutPath &quot;$PLUGINSDIR&quot;<br />
<br />
The system call succeeds, the correct path is displayed in the title bar of the installer window. The install hangs after that point though.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">24th March 2005, 15:25</div></div><div class="posttext">Try the u option to unload the DLL after it's called. For example: System::Call 'CondMgr::CmGetCorePath(t, *i) i(.r0, r1r1).r2?u'</div></div><hr />


<div class="post"><div class="posttop"><div class="username">turtlehand</div><div class="date">24th March 2005, 16:19</div></div><div class="posttext">Thanks for the response, but no joy :igor:. Tried the ?u with the same result.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">24th March 2005, 16:25</div></div><div class="posttext">According to this (http://www.palmos.com/dev/support/docs/conduits/win/CRef_CnMgr.html#997119) page, CmGetCorePath expects a pointer to a buffer in the first parameter. You give it just a buffer. Try using *t instead of just t.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">turtlehand</div><div class="date">24th March 2005, 17:39</div></div><div class="posttext">Thanks for the suggestion. I've now tried both t which returns an empty string and *t which returns the correct path. In either case the install locks up after making the System::Call and tries DetailPrint. The t appears to be correct per the NSIS Help: t - text, string (LPCSTR, pointer to first character).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">25th March 2005, 11:27</div></div><div class="posttext">t is not enough because the function expects a pointer to a pointer to the first char, not a pointer to the first char.<br />
<br />
If it still hangs, it's time to get the debugger into action and find exactly where it hangs.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">turtlehand</div><div class="date">25th March 2005, 14:07</div></div><div class="posttext">I'm using HM NIS Edit, all I have found is the NSIS Help suggesting DetailPrint and MessageBox, DumpState and writing to a log file. Is there something better than these?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">25th March 2005, 14:15</div></div><div class="posttext">I am not talking about a NSIS debugger. The script is fine, there is no need to debug it. It most probably hangs on the System::Free call. You need a debugger such as windbg to see what really happens deeper than the script.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">turtlehand</div><div class="date">25th March 2005, 16:17</div></div><div class="posttext">Then I need debug symbols for System plugin and CondMgr. Do debug symbols exist for the System plugin?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">25th March 2005, 16:30</div></div><div class="posttext">You'll have to compile the System plug-in yourself to get the symbols. The source code is available in Contrib\System\Source. If you don't have VC, you can compile it using the free Visual C++ Toolkit 2003 (http://msdn.microsoft.com/visualc/vctoolkit2003/):cl /nologo /O1 /W3 /DSYSTEM_EXPORTS /c Buffers.c /FoBuffers.obj<br />
cl /nologo /O1 /W3 /DSYSTEM_EXPORTS /c Plugin.c /FoPlugin.obj<br />
cl /nologo /O1 /W3 /DSYSTEM_EXPORTS /c System.c /FoSystem.obj<br />
link /nologo /opt:nowin98 /entry:_DllMainCRTStartup /dll /out:System.dll kernel32.lib user32.lib ole32.lib Buffers.obj Plugin.obj System.objIf you're getting errors about CLSIDFromString and another function, add:#include &lt;objbase.h&gt;to the top of System.c.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>