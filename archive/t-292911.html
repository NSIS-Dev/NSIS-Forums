<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" macro for patch Files, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  macro for patch Files NSIS Discussion" />
	
	<title> macro for patch Files [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  macro for patch Files</div>
<hr />
<div class="pda"><a href="t-292911.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=292911">macro for patch Files</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">ssam</div><div class="date">9th June 2008, 08:27</div></div><div class="posttext">my macros:<br />
<br />
!macro patchFileProd1 filename <br />
    Var /global fp_$filename<br />
    Var /global fp_patched_$filename<br />
    Var /global template_$filename<br />
    Var /global patched_$filename<br />
    /* Datei einlesen und schreiben*/<br />
    ClearErrors<br />
    FileOpen $fp_$filename '${copiedfiles_Path}\Templates\bin\$filename' r<br />
    IfErrors done_$filename<br />
    ClearErrors<br />
    SetOutPath '$INSTDIR\bin'<br />
    FileOpen $fp_patched_$filename '$filename' w<br />
    IfErrors not_patched_$filename<br />
    ClearErrors<br />
    loop_$filename:<br />
    FileRead $fp_$filename $template_$filename<br />
    IfErrors eof_$filename<br />
!macroend<br />
<br />
!macro patchFileProd2 filename <br />
    FileWrite $fp_patched_$filename $patched_$filename<br />
    iferrors 0 +2<br />
    DetailPrint '!!!!!!!! Konnte nicht in $filename schreiben!!!!!!!!!'<br />
    Goto loop_$filename<br />
<br />
    eof_$filename:<br />
    FileClose $fp_patched_$filename<br />
    FileClose $fp_$filename<br />
    Goto +4<br />
<br />
    not_patched_$filename:<br />
    DetailPrint '!!!!!!!! Konnte $filename nicht anlegen!!!!!!!!'<br />
    Goto +2<br />
<br />
    done_$filename:<br />
    DetailPrint '!!!!!!!! Konnte template_$filename nicht Ã¶ffnen(lesen)!!!!!!!!'<br />
!macroend<br />
<br />
<br />
here the use of the macros<br />
<br />
StrCpy $1 'diagcld_register.cmd'<br />
  <br />
  !insertmacro patchFile1 $1<br />
  ${StrRep} $patched_$filename &quot;$template_$filename&quot; &quot;$DB&quot; &quot;new_DB&quot;<br />
  !insertmacro patchFile2 $1<br />
  <br />
<br />
<br />
invalid characters in variable name &quot;fp$filename&quot;, use only characters [a-z][A-Z][0-9] and '_'<br />
Error in macro patchFileProd1 on macroline 1<br />
<br />
What is wrong?<br />
<br />
fp_$filename --&gt; Error<br />
fp$filename  --&gt; Error</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pospec</div><div class="date">9th June 2008, 09:20</div></div><div class="posttext">Macro parameters should be reffered by ${parameter}, $parameter is wrong.<br />
<br />
Is it intention to declare variables in macro?<br />
<br />
It is interesting that second macro contains Goto which points to first macro.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">ssam</div><div class="date">9th June 2008, 11:20</div></div><div class="posttext">yea i want to devide it, but now i have a better solution, thanks for help</div></div><hr />


<div class="post"><div class="posttop"><div class="username">ssam</div><div class="date">9th June 2008, 13:23</div></div><div class="posttext">ok other question same Problem<br />
<br />
my script:<br />
<br />
StrCpy $1 'diagcld_register.cmd'<br />
  !insertmacro patchFileProd '${copiedfiles_Path}\Templates\bin' '$INSTDIR\bin' $1 '0' '0' '0' '0' '0' '0' '0' '1'<br />
    <br />
<br />
<br />
my macro:<br />
<br />
!macro patchFileProd templatePath zielpfad filename v1 v2 v3 v4 v5 v6 v7 v8<br />
    Var /global fp<br />
    Var /global fp_patched<br />
    #Var /global template<br />
    Var /global patched<br />
    /* Datei einlesen und schreiben */<br />
    ClearErrors<br />
    FileOpen $fp '${templatePath}\${filename}' r #<br />
    #Messagebox MB_OK &quot;temp lesen&quot;<br />
    IfErrors done_${filename}<br />
    ClearErrors<br />
    SetOutPath '${zielpfad}'<br />
    FileOpen $fp_patched '${filename}' w<br />
    IfErrors not_patched_${filename}<br />
    ClearErrors<br />
    loop_${filename}:<br />
    FileRead $fp $patched<br />
    IfErrors eof_${filename}<br />
<br />
    StrCmp ${v1} '1' 0 +2<br />
    Messagebox MB_OK &quot;${v1}&quot;<br />
    #${StrRep} $patched &quot;$patched&quot; &quot;%DBListenerport%&quot; &quot;$ProduktivDB_Listenerport&quot;<br />
    StrCmp ${v2} '1' 0 +2<br />
    Messagebox MB_OK &quot;${v2}&quot;<br />
    #${StrRep} $patched &quot;$patched&quot; &quot;%Hostname%&quot; &quot;$ProduktivDB_Hostname&quot;<br />
    StrCmp ${v3} '1' 0 +2<br />
    Messagebox MB_OK &quot;${v3}&quot;<br />
    #${StrRep} $patched &quot;$patched&quot; &quot;%Server%&quot; &quot;$Servername&quot;<br />
    StrCmp ${v4} '1' 0 +2<br />
    Messagebox MB_OK &quot;${v4}&quot;<br />
    #${StrRep} $patched &quot;$patched&quot; &quot;%DBSID%&quot; &quot;$ProduktivDB_DBSID&quot;<br />
    StrCmp ${v5} '1' 0 +2<br />
    Messagebox MB_OK &quot;${v5}&quot;<br />
    #${StrRep} $patched &quot;$patched&quot; &quot;%User%&quot; &quot;$ProduktivDB_Mainuser&quot;<br />
    StrCmp ${v6} '1' 0 +2<br />
    Messagebox MB_OK &quot;${v6}&quot;<br />
    #${StrRep} $patched &quot;$patched&quot; &quot;%TNSname%&quot; &quot;$ProduktivDB_TNSname&quot;<br />
    StrCmp ${v7} '1' 0 +2<br />
    Messagebox MB_OK &quot;${v7}&quot;<br />
    #${StrRep} $patched &quot;$patched&quot; &quot;%Passwort%&quot; &quot;$ProduktivDB_MainuserPasswort&quot;<br />
    StrCmp ${v8} '1' 0 +2<br />
    ${StrRep} $patched &quot;$patched&quot; &quot;%Pfad%&quot; &quot;$INSTDIR&quot;<br />
Messagebox MB_OK &quot;${v8}&quot;<br />
    FileWrite $fp_patched $patched<br />
    IfErrors 0 +2<br />
    DetailPrint '!!!!!!!! Konnte nicht in ${zielpfad}\${filename} schreiben!!!!!!!!!'<br />
    Goto loop_${filename}<br />
<br />
    eof_${filename}:<br />
    FileClose $fp_patched<br />
    FileClose $fp<br />
    Goto +4<br />
<br />
    not_patched_${filename}:<br />
    DetailPrint '!!!!!!!! Konnte ${filename} nicht anlegen!!!!!!!!'<br />
    Goto +2<br />
<br />
    done_${filename}:<br />
    DetailPrint '!!!!!!!! Konnte ${templatePath}\${filename} nicht Ã¶ffnen(lesen)!!!!!!!!'<br />
!macroend<br />
<br />
<br />
why i have always<br />
<br />
v1 = 1<br />
v2 = 1<br />
v3 = 1<br />
v4 = 1<br />
.<br />
.<br />
.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">ssam</div><div class="date">10th June 2008, 12:07</div></div><div class="posttext">ok, i have a Problem and i cant solve it.<br />
<br />
i have to patch some Files. And i want to write a macro.<br />
<br />
my Problem is, if i use a Variable or a Label and use the macro more then one times, he says the variable or label is already declared. Then i used relative jumps, but then he writes &quot;succsess123167succsess128167succsess183167succsess133167&quot;<br />
at the end of the File or in some tets he wrote only the first line and then only &quot;succsess&quot;.<br />
<br />
the original code is this:<br />
<br />
!macro patchFileTest templatePath zielpfad filename <br />
<br />
    ClearErrors<br />
    FileOpen $R0 '${templatePath}\${filename}' r #<br />
    IfErrors done_test_${filename}<br />
    ClearErrors<br />
    SetOutPath '${zielpfad}'<br />
    FileOpen $R1 '${filename}' w<br />
    IfErrors not_patched_test_${filename}<br />
    ClearErrors<br />
    loop_test_${filename}:<br />
    FileRead $R0 $R3<br />
    IfErrors eof_test_${filename}<br />
<br />
    #StrCmp ${v1} '1' 0 +2<br />
    ${StrRep} $R3 &quot;$R3&quot; &quot;%DBListenerport%&quot; &quot;$TestDB_Listenerport&quot;<br />
    #StrCmp ${v2} '1' 0 +2<br />
    ${StrRep} $R3 &quot;$R3&quot; &quot;%Hostname%&quot; &quot;$TestDB_Hostname&quot;<br />
    #StrCmp ${v3} '1' 0 +2<br />
    ${StrRep} $R3 &quot;$R3&quot; &quot;%Server%&quot; &quot;$Servername&quot;<br />
    #StrCmp ${v4} '1' 0 +2<br />
    ${StrRep} $R3 &quot;$R3&quot; &quot;%DBSID%&quot; &quot;$TestDB_DBSID&quot;<br />
    #StrCmp ${v5} '1' 0 +2<br />
    ${StrRep} $R3 &quot;$R3&quot; &quot;%User%&quot; &quot;$TestDB_Mainuser&quot;<br />
    #StrCmp ${v6} '1' 0 +2<br />
    ${StrRep} $R3 &quot;$R3&quot; &quot;%TNSname%&quot; &quot;$TestDB_TNSname&quot;<br />
    #StrCmp ${v7} '1' 0 +2<br />
    ${StrRep} $R3 &quot;$R3&quot; &quot;%Passwort%&quot; &quot;$TestDB_MainuserPasswort&quot;<br />
    #StrCmp ${v8} '1' 0 +2<br />
    ${StrRep} $R3 &quot;$R3&quot; &quot;%Pfad%&quot; &quot;$INSTDIR${TestDB}&quot;<br />
<br />
    FileWrite $R1 $R3<br />
    IfErrors +2 0<br />
    Goto loop_test_${filename}<br />
    DetailPrint '!!!!!!!! Konnte nicht in ${zielpfad}\${filename} schreiben!!!!!!!!!'<br />
    <br />
<br />
    eof_test_${filename}:<br />
    FileClose $R1<br />
    FileClose $R0<br />
    Goto +4<br />
<br />
    not_patched_test_${filename}:<br />
    DetailPrint '!!!!!!!! Konnte ${filename} nicht anlegen!!!!!!!!'<br />
    Goto +2<br />
<br />
    done_test_${filename}:<br />
    DetailPrint '!!!!!!!! Konnte ${templatePath}\${filename} nicht Ã¶ffnen(lesen)!!!!!!!!'<br />
!macroend<br />
<br />
<br />
my last test was this:<br />
<br />
!include StrFunc.nsh <br />
     ${StrRep}<br />
     <br />
 /* ProduktivDB */<br />
!macro patchFileProd param1 param2 param3   <br />
       !define templatePath ${param1}<br />
       !define zielpfad ${param2}<br />
       !define filename ${param3}<br />
       Messagebox MB_OK &quot;${param1}&quot;<br />
    Messagebox MB_OK &quot;${param2}&quot;<br />
    Messagebox MB_OK &quot;${param3}&quot;<br />
    Messagebox MB_OK &quot;${templatePath}&quot;<br />
    Messagebox MB_OK &quot;${zielpfad}&quot;<br />
    Messagebox MB_OK &quot;${filename}&quot;<br />
       call patchFile<br />
       !undef templatePath<br />
       !undef zielpfad<br />
       !undef filename<br />
!macroend<br />
<br />
Function patchFile<br />
    /* Datei einlesen und schreiben */<br />
    Messagebox MB_OK &quot;${param1}&quot;<br />
    Messagebox MB_OK &quot;${param2}&quot;<br />
    Messagebox MB_OK &quot;${param3}&quot;<br />
    Messagebox MB_OK &quot;${templatePath}&quot;<br />
    Messagebox MB_OK &quot;${zielpfad}&quot;<br />
    Messagebox MB_OK &quot;${filename}&quot;<br />
    ClearErrors<br />
    FileOpen $R0 '${templatePath}\${filename}' r #<br />
    IfErrors done_${filename} #+25<br />
    ClearErrors<br />
    SetOutPath '${zielpfad}'<br />
    FileOpen $R1 '${filename}' w<br />
    IfErrors not_patched_${filename} #+19 <br />
    loop_${filename}:<br />
    ClearErrors<br />
    FileRead $R0 $R3<br />
    IfErrors eof_${filename} #+13<br />
<br />
    #StrCmp ${v1} '1' 0 +2<br />
    ${StrRep} $R3 &quot;$R3&quot; &quot;%DBListenerport%&quot; &quot;$ProduktivDB_Listenerport&quot;<br />
    #StrCmp ${v2} '1' 0 +2<br />
    ${StrRep} $R3 &quot;$R3&quot; &quot;%Hostname%&quot; &quot;$ProduktivDB_Hostname&quot;<br />
    #StrCmp ${v3} '1' 0 +2<br />
    ${StrRep} $R3 &quot;$R3&quot; &quot;%Server%&quot; &quot;$Servername&quot;<br />
    #StrCmp ${v4} '1' 0 +2<br />
    ${StrRep} $R3 &quot;$R3&quot; &quot;%DBSID%&quot; &quot;$ProduktivDB_DBSID&quot;<br />
    #StrCmp ${v5} '1' 0 +2<br />
    ${StrRep} $R3 &quot;$R3&quot; &quot;%User%&quot; &quot;$ProduktivDB_Mainuser&quot;<br />
    #StrCmp ${v6} '1' 0 +2<br />
    ${StrRep} $R3 &quot;$R3&quot; &quot;%TNSname%&quot; &quot;$ProduktivDB_TNSname&quot;<br />
    #StrCmp ${v7} '1' 0 +2<br />
    ${StrRep} $R3 &quot;$R3&quot; &quot;%Passwort%&quot; &quot;$ProduktivDB_MainuserPasswort&quot;<br />
    #StrCmp ${v8} '1' 0 +2<br />
    ${StrRep} $R3 &quot;$R3&quot; &quot;%Pfad%&quot; &quot;$INSTDIR&quot;<br />
<br />
    FileWrite $R1 $R3<br />
    IfErrors +2<br />
    Goto loop_${filename} #-15<br />
<br />
    #Messagebox MB_OK &quot;!!!!!!!! Konnte nicht in ${zielpfad}\${filename} schreiben!!!!!!!!!&quot;<br />
    DetailPrint '!!!!!!!! Konnte nicht in ${zielpfad}\${filename} schreiben!!!!!!!!!'<br />
<br />
    eof_${filename}:<br />
    FileClose $R1<br />
    FileClose $R0<br />
    Goto +4<br />
<br />
    not_patched_${filename}:<br />
    #Messagebox MB_OK &quot;!!!!!!!! Konnte ${filename} nicht anlegen!!!!!!!!&quot;<br />
    DetailPrint '!!!!!!!! Konnte ${filename} nicht anlegen!!!!!!!!'<br />
    Goto +2<br />
<br />
    done_${filename}:<br />
    #Messagebox MB_OK &quot;!!!!!!!! Konnte ${templatePath}\${filename} nicht Ã¶ffnen(lesen)!!!!!!!!&quot;<br />
    DetailPrint '!!!!!!!! Konnte ${templatePath}\${filename} nicht Ã¶ffnen(lesen)!!!!!!!!'<br />
FunctionEnd<br />
<br />
<br />
<br />
the Messageboxes are for test.<br />
<br />
Can anybody help me?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">demiller9</div><div class="date">10th June 2008, 20:38</div></div><div class="posttext">The relative jumps don't work because you are trying to jump over a macro, and the relative jump ends up jumping inside the macro instead of over it.<br />
<br />
Try using the LogicLib.nsh header. It will create jump labels that are unique even if the macro is used more than once.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">ssam</div><div class="date">13th June 2008, 08:42</div></div><div class="posttext">ok i changed it , i use the jumps in a Function and now it works perfectly. LogicLib.nsh is the next whati will test. Thanks for help demiller9.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>