<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Delete some exe and dll files during install process, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Delete some exe and dll files during install process NSIS Discussion" />
	
	<title> Delete some exe and dll files during install process [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Delete some exe and dll files during install process</div>
<hr />
<div class="pda"><a href="t-169617.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=169617">Delete some exe and dll files during install process</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">pgpatron</div><div class="date">16th February 2004, 17:40</div></div><div class="posttext">Hi all,<br />
<br />
I am using an exe file and a dll file during the install process and I want to delete them once their taks are finished.<br />
<br />
I copy them to $INSTDIR and I want to erase them after they have been used.<br />
<br />
In my &quot;Delete&quot; call I received an error and the files left in the $INSTDIR after install process is finished.<br />
<br />
more or less:<br />
<br />
SetOutPath &quot;$INSTDIR&quot;<br />
File /r &quot;${SRC}\*.*&quot; <br />
<br />
System::Call 'mydll::AFunctionOfMyFile.dll ...'<br />
Delete mydll.dll<br />
(ERROR Flag on)<br />
<br />
ExecWait myexe.exe<br />
Delete myexe.exe<br />
(ERROR Flag on)<br />
<br />
Does anyone knows why I can not erase them and/or how should I do it correctly?<br />
<br />
Thank you in advance,<br />
<br />
Pedro</div></div><hr />


<div class="post"><div class="posttop"><div class="username">VegetaSan</div><div class="date">16th February 2004, 18:34</div></div><div class="posttext">Try this <br />
<br />
SetOutPath &quot;$INSTDIR&quot;<br />
File /r &quot;${SRC}\*.*&quot; <br />
<br />
System::Call 'mydll::AFunctionOfMyFile.dll ...'<br />
Delete &quot;mydll.dll&quot;<br />
(ERROR Flag on)<br />
<br />
ExecWait &quot;$INSTDIR\myexe.exe&quot;<br />
Delete &quot;myexe.exe&quot;<br />
(ERROR Flag on)<br />
<br />
Please tell me if it works :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pgpatron</div><div class="date">16th February 2004, 18:45</div></div><div class="posttext">It does not work. Both files are blocked by the installer program... What can I do? :( :(</div></div><hr />


<div class="post"><div class="posttop"><div class="username">VegetaSan</div><div class="date">16th February 2004, 18:53</div></div><div class="posttext">What's the error??</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pgpatron</div><div class="date">16th February 2004, 19:06</div></div><div class="posttext">I have achieved to fix the problem with the exe file by calling the Delete inside the .onGUIend function inspite of doing it just after its Execwait call.<br />
<br />
But that does not work with the DLL System::Call. It is still blocked by the install process whe that function is called.<br />
<br />
Help please.<br />
<br />
I have bee following the C.5 Calling an external DLL using the System.dll plugin page of the NSIS manual<br />
<br />
Inside this page a comment of the example says:<br />
; last plugin call must not have /NOUNLOAD so NSIS will be able to delete<br />
; the temporary DLL<br />
<br />
That is what I want to do: Delete the DLL. But I do not understand the meaning of this comment. I have tried with the 'SetPluginUnload manual' and without it and with 'System::Free 0' and without it.<br />
<br />
Could you help me please?<br />
<br />
Thanks.<br />
<br />
Pedro</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pgpatron</div><div class="date">17th February 2004, 09:51</div></div><div class="posttext">I have found in the NSIS System Plugin(c) documentation the following option:<br />
 u - unload DLL after call (using FreeLibrary, so you'll be able to do something with it, delete for example)<br />
<br />
DELETE FOR EXAMPLE!!! Great!! That's what I want to do!<br />
<br />
But there is no example (I neither didn't find in forum) and the doc is not very clear for my understanding.<br />
<br />
<br />
Could somebody show me an example of how to do a System::Call to a DLL with this option?<br />
<br />
Thank you all,</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pgpatron</div><div class="date">17th February 2004, 09:58</div></div><div class="posttext">I have already fixed the problem. <br />
:D :D <br />
<br />
Maybe It could help somebody:<br />
<br />
StrCpy $9 &quot;$INSTDIR\${MYPROGRAM}&quot;<br />
System::Call 'mydll::myfunc(t) i (r9) r8 ? u'<br />
<br />
SetPluginUnload manual<br />
System::Free 0<br />
<br />
Delete mydll.dll<br />
<br />
It runs!!! :) :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">EnCey</div><div class="date">20th March 2008, 10:31</div></div><div class="posttext">I'm facing the same problem, but unfortunately the above solution doesn't work for me...<br />
Here's my code:<br />
<br />
  StrCpy ${errorText} &quot;&quot;<br />
  DetailPrint &quot;Executing ${function} ...&quot;<br />
  <br />
  ; load dll<br />
  System::Call &quot;kernel32::LoadLibrary(t '${dll}') i .r0 ? e&quot;<br />
  IntCmp $0 0 callWebCAError_${LN} callWebCAError_${LN} 0<br />
<br />
  ; get function address<br />
  System::Call &quot;kernel32::GetProcAddress(i r0, t '${function}') i .r1 ? e&quot;<br />
  IntCmp $1 0 callWebCAError_${LN} callWebCAError_${LN} 0<br />
<br />
  ; call function<br />
  System::Call &quot;::$1(${arg}) i .r2 ? e&quot;<br />
  IntCmp $2 0 callWebCAError_${LN} callWebCAError_${LN} 0<br />
  <br />
  goto callWebCASuccess_${LN}<br />
<br />
  callWebCAError_${LN}:<br />
    IntCmp $0 0 0 0 +2<br />
      DetailPrint &quot;Can't load library $\&quot;${dll}$\&quot;!&quot;<br />
    IntCmp $1 0 0 0 +2<br />
      DetailPrint &quot;Function $\&quot;${function}$\&quot; not found!&quot;<br />
    Pop $0<br />
    StrCmp $0 &quot;&quot; 0 +2<br />
      StrCpy $0 &quot;[NSIS] Unknown Error&quot;<br />
    StrCpy ${errorText} &quot;Error: ${function} failed (Error: $0)&quot;<br />
    DetailPrint ${errorText}<br />
    goto callWebCAFinish_${LN}<br />
    <br />
  callWebCASuccess_${LN}:<br />
    DetailPrint &quot;Successfully executed ${function}! (return value: $2)&quot;<br />
<br />
  callWebCAFinish_${LN}:<br />
    System::Call &quot;kernel32::FreeLibrary(i r0) b s ?e&quot;<br />
    ClearErrors<br />
<br />
<br />
<br />
I can't delete the dll, it's locked. <br />
SetPluginUnload manual<br />
System::Free 0<br />
before deletion doesn't work either.<br />
I'm extracting the dll before using it and try to delete it afterwards, both in install and uninstall sections</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">20th March 2008, 19:14</div></div><div class="posttext">Your FreeLibrary call is invalid as `b` is not a valid type. You should use `i` instead.<br />
<br />
And this entire piece of code can be replaced by a single System::Call line as it will load the library and find the proc for you.System::Call &quot;${dll}::${function}(i ${arg}) ?u&quot;Notice the added &quot;?u&quot; that causes System to call FreeLibrary immediately after the call.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">EnCey</div><div class="date">21st March 2008, 08:44</div></div><div class="posttext">Omg shame on me ^^ <br />
I was reading the code again and again and never noticed....<br />
<br />
I've tried to replace all the code with the single line of code after I've read the first post in this thread, but had some errors. I'll try later when I've more time.<br />
Thanks kichik!</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>