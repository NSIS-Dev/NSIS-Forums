<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Major help on script requested, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Major help on script requested NSIS Discussion" />
	
	<title> Major help on script requested [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Major help on script requested</div>
<hr />
<div class="pda"><a href="t-273072.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=273072">Major help on script requested</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">JayGunter</div><div class="date">19th June 2007, 08:21</div></div><div class="posttext">Hey guys (&amp; gals),<br />
<br />
Let me just say I am new to the whole NSIS scripting language, but I believe this is a pretty good script for a beginner. I wrote a driver for Windows 98 SE giving it FULL USB support (This means you can use any USB Mass Storage Device on Windows 98 SE with only one driver). <br />
<br />
To make the installation of the driver easier for the average user, I am compiling this release as an installer. Although, I am having some troubles. I was wondering if any brave soul wanted to look at it and tweak it or give me some tips. I have perfected the registry keys for uninstallation.<br />
<br />
Here are some problems I am experiencing:<br />
<br />
- After you accept the License Agreement and continue to the next page then click back you must click Accept again even if the button is filled in to re-enable the next button.<br />
<br />
- The uninstaller..it is TERRIBLE. :igor:  I know that is vague..but look at it yourself.<br />
<br />
Things I would like to add:<br />
<br />
- Operating System detection at the beginning (Where only Windows 98 SE can run setup)<br />
<br />
- If the install somehow fails take the user to a page saying it did not install properly.<br />
<br />
<br />
NOTE: If you are NOT using Windows 98 and would still like to help please put an &quot;;&quot; at the beginning of line 54 to disable merging with the driver database. What this will do, really, is just extract files to the installation directory.<br />
<br />
Due to size restriction on the forums I have uploaded my 180kb archive to and external hosting site. You can find it it at http://www.freewebs.com/customizefacebook/Build2.7z<br />
<br />
You must have 7Zip installed on your computer to open it. You can download 7Zip at http://www.7zip.org<br />
<br />
Thank you,<br />
<br />
Jay Gunter</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">19th June 2007, 10:09</div></div><div class="posttext">The uninstaller is terrible? Yes that is a bit vague lol. Do you mean it's functionality or look? Are you not using Modern UI?<br />
<br />
There are many functions out there to detect the operating system, one of which is the WinVer.nsh extension to LogicLib.nsh.<br />
<br />
If the install fails the Finish page will reflect this with Modern UI.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JayGunter</div><div class="date">19th June 2007, 17:48</div></div><div class="posttext">I am using the modern UI, but there are no images or text on the uninstaller.<br />
<br />
Here is my uninstall script.<br />
<br />
;--------------------------------<br />
;Uninstaller Section<br />
<br />
!insertmacro MUI_UNPAGE_WELCOME<br />
!insertmacro MUI_UNPAGE_INSTFILES<br />
!insertmacro MUI_UNPAGE_FINISH<br />
<br />
Section &quot;Uninstall&quot;<br />
<br />
  DELETE &quot;$INSTDIR\*.*&quot;<br />
  RMDir &quot;$INSTDIR&quot;<br />
<br />
  DeleteRegKey HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\USB Storage Driver&quot;<br />
<br />
SectionEnd<br />
<br />
Is there something I am missing to put images in the uninstaller like I did with the<br />
<br />
  !define MUI_WELCOMEFINISHPAGE_BITMAP &quot;modern-wizard.bmp&quot; <br />
  !define MUI_HEADERIMAGE<br />
  !define MUI_HEADERIMAGE_RIGHT<br />
  !define MUI_HEADERIMAGE_BITMAP &quot;modern-header.bmp&quot;<br />
<br />
functions for the installer?<br />
<br />
Jay</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JayGunter</div><div class="date">19th June 2007, 17:52</div></div><div class="posttext">I hate to double post but like I said earlier, you can check out my script at:<br />
<br />
http://www.freewebs.com/customizefacebook/Build2.7z</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">19th June 2007, 19:38</div></div><div class="posttext">Why didn't you notice the 11 warnings that makensisw was throwing at you (literally!)?<br />
<br />
Your page definitions need to go above the language insertions, whereas currently your uninstall page definitions are below.<br />
You also need to use MUI_HEADERIMAGE_UNBITMAP for the uninstaller (more info in the Modern UI manual).<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JayGunter</div><div class="date">19th June 2007, 20:11</div></div><div class="posttext">Yeah, I saw those but like I said before I am a beginner, and I don't know how to fix those warnings. So you suggest moving my page definitions above my language stuff it should work...<br />
<br />
Now what is my problem with the License Agreement where if you continue to the next page then go back you have to click the already filled bubble to re-enable the next button.<br />
<br />
And how do I setup the script for OS detection with the WinVer.nsh extension to LogicLib.nsh? Sorry I am a newbie guys. Bear with me..</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">19th June 2007, 21:10</div></div><div class="posttext">!include LogicLib.nsh<br />
!include WinVer.nsh<br />
<br />
...<br />
<br />
${If} ${AtleastWin98}<br />
  MessageBox MB_OK ja!<br />
${EndIf}<br />
<br />
Also, you can change this:<br />
InstallOptions::initDialog /NOUNLOAD &quot;$PLUGINSDIR\ioA.ini&quot;<br />
GetDlgItem $1 $HWNDPARENT 1<br />
EnableWindow $1 0<br />
InstallOptions::show<br />
To:<br />
ReadINIStr $0 &quot;$PLUGINSDIR\ioA.ini&quot; &quot;Field 4&quot; &quot;State&quot;<br />
StrCmp $0 1 +3<br />
  GetDlgItem $1 $HWNDPARENT 1<br />
  EnableWindow $1 0<br />
<br />
InstallOptions::display &quot;$PLUGINSDIR\ioA.ini&quot;<br />
Reason being the Next button is not part of the InstallOptions dialog.<br />
<br />
Also, regarding your uninstall code (which will not work because Delete *.* does not remove sub folders, only all files in a folder), see this page:<br />
http://nsis.sourceforge.net/Validating_%24INSTDIR_before_uninstall<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JayGunter</div><div class="date">20th June 2007, 05:04</div></div><div class="posttext">I changed to what you suggested but I receive an error &quot;Invalid command: InstallOptions::display&quot; I still ussed you suggestion but changed to &quot;InstallOptions::show &quot;$PLUGINSDIR\ioA.ini&quot;&quot; But now the page is skipped.<br />
<br />
I am using NSIS 2.28.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">20th June 2007, 12:25</div></div><div class="posttext">Sorry, should be InstallOptions::dialog.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JayGunter</div><div class="date">20th June 2007, 19:34</div></div><div class="posttext">That is great! Now I added the operating system detection but can NSIS determine Windows 98 from Windows 98 SE?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">20th June 2007, 19:53</div></div><div class="posttext">WinVer.nsh does not have support for that unfortunately. Maybe you could post a feature request on the NSIS SourceForge page.<br />
Otherwise;<br />
http://nsis.sourceforge.net/GetVersion_%28Windows%29_plug-in<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JayGunter</div><div class="date">20th June 2007, 20:07</div></div><div class="posttext">I know that Windows 98 has a registry key that its value is &quot;Windows 98 SE&quot; is there a way I can configure my script to launch if the registry key is present and if it is not display and error message.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">20th June 2007, 20:34</div></div><div class="posttext">ClearErrors<br />
ReadRegStr ...<br />
IfErrors ...<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JayGunter</div><div class="date">20th June 2007, 20:43</div></div><div class="posttext">Okay! I think I am almost done with all my questions. But here is my last one. On the validating the uninstall before uninstalling section..I am having trouble with what it would look like for my script.<br />
<br />
Here's what I have:<br />
<br />
Section &quot;Uninstall&quot;<br />
<br />
  StrCmp $INSTDIR &quot;&quot; 0 +3<br />
    MessageBox MB_OK|MB_ICONSTOP &quot;Error: The install path missing!&quot;<br />
    Abort<br />
<br />
  StrCpy $R0 $INSTDIR &quot;&quot; -6<br />
  StrCmp $R0 &quot;\USB Storage Driver&quot; +3<br />
    MessageBox MB_YESNO|MB_ICONQUESTION &quot;What brings up this box??&quot; IDYES +2<br />
    Abort<br />
 <br />
  IfFileExists &quot;$INSTDIR\*.*&quot; +4<br />
  IfFileExists &quot;$INSTDIR\CSETUP.exe&quot; +3<br />
    MessageBox MB_OK|MB_ICONSTOP &quot;Install path invalid!&quot;<br />
    Abort<br />
<br />
  DELETE &quot;$INSTDIR\*.*&quot;<br />
  RMDir &quot;$INSTDIR&quot;<br />
<br />
  DeleteRegKey HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\USB Storage Driver&quot;<br />
<br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">20th June 2007, 22:25</div></div><div class="posttext">As I already said, Delete &quot;$INSTDIR\*.*&quot; will not delete sub folders. Either you delete all files and subfolders individually from the highest level down, or you use RMDir /r &quot;$INSTDIR\*.*&quot;. This is NOT recommended in case the user has put his own files in there since the installation.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JayGunter</div><div class="date">20th June 2007, 23:36</div></div><div class="posttext">How does this look?<br />
<br />
Section &quot;Uninstall&quot;<br />
<br />
  StrCmp $INSTDIR &quot;&quot; 0 +3<br />
    MessageBox MB_OK|MB_ICONSTOP &quot;Install path missing!&quot;<br />
    Abort<br />
<br />
  StrCpy $R0 $INSTDIR &quot;&quot; -6<br />
  StrCmp $R0 &quot;\USB Storage Driver&quot; +3<br />
    MessageBox MB_YESNO|MB_ICONQUESTION &quot;...&quot; IDYES +2<br />
    Abort<br />
 <br />
  IfFileExists &quot;$INSTDIR\*.*&quot; +4<br />
  IfFileExists &quot;$INSTDIR\_nusb.inf&quot; +3<br />
    MessageBox MB_OK|MB_ICONSTOP &quot;Install path invalid!&quot;<br />
    Abort<br />
<br />
  DELETE &quot;$INSTDIR\_NUSB.INF&quot;<br />
  DELETE &quot;$INSTDIR\1394.IN&quot;<br />
  DELETE &quot;$INSTDIR\1394BUS.SYS&quot;<br />
  DELETE &quot;$INSTDIR\CSETUP.EXE&quot;<br />
  DELETE &quot;$INSTDIR\DISKTSD.VXD&quot;<br />
  DELETE &quot;$INSTDIR\HARDWARE.HLP&quot;<br />
  DELETE &quot;$INSTDIR\IOS.VXD&quot;<br />
  DELETE &quot;$INSTDIR\NODRIVER.INF&quot;<br />
  DELETE &quot;$INSTDIR\NTMAP.INF&quot;<br />
  DELETE &quot;$INSTDIR\NTMAP.SYS&quot;<br />
  DELETE &quot;$INSTDIR\NTMAPHLP.PDR&quot;<br />
  DELETE &quot;$INSTDIR\OHCI1394.SYS&quot;<br />
  DELETE &quot;$INSTDIR\QFECHECK.EXE&quot;<br />
  DELETE &quot;$INSTDIR\QFECHECK.HLP&quot;<br />
  DELETE &quot;$INSTDIR\SBP2PORT.SYS&quot;<br />
  DELETE &quot;$INSTDIR\USBAUTH.SYS&quot;<br />
  DELETE &quot;$INSTDIR\USBMPHLP.PDR&quot;<br />
  DELETE &quot;$INSTDIR\USBNTMAP.INF&quot;<br />
  DELETE &quot;$INSTDIR\USBNTMAP.SYS&quot;<br />
  DELETE &quot;$INSTDIR\USBSTOR.INF&quot;<br />
  DELETE &quot;$INSTDIR\USBSTOR.SYS&quot;<br />
  DELETE &quot;$INSTDIR\USBU2A.SYS&quot;<br />
  DELETE &quot;$INSTDIR\W95INF16.DLL&quot;<br />
  DELETE &quot;$INSTDIR\W95INF32.DLL&quot;<br />
  RMDir &quot;$INSTDIR&quot;<br />
<br />
  DeleteRegKey HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\USB Storage Driver&quot;<br />
<br />
SectionEnd<br />
<br />
And what does this function do?<br />
<br />
  StrCpy $R0 $INSTDIR &quot;&quot; -6<br />
  StrCmp $R0 &quot;\USB Storage Driver&quot; +3<br />
    MessageBox MB_YESNO|MB_ICONQUESTION &quot;...&quot; IDYES +2<br />
    Abort<br />
<br />
I want to know what causes the message box to display so I can change the message in the message box.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">21st June 2007, 10:09</div></div><div class="posttext">That code is much better :)<br />
The RMDir without the /r switch will ensure that the folder is only removed if it is empty and therefore any user files will remain.<br />
<br />
That one will take the last 6 characters from the end of the path and compare it to a value. Your message box should ask them whether they wish to continue uninstalling because the path to uninstall from does not have &quot;USB Storage Driver&quot; on the end (may want to word that differently).<br />
Also, as &quot;\USB Storage Driver&quot; is not the same as &quot;\MyApp&quot;, it's length is different. -6 should be -19.<br />
<br />
Stu</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>