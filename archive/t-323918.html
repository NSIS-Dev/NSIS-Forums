<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Uninstall progress bar doesn't show progress, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Uninstall progress bar doesn't show progress NSIS Discussion" />
	
	<title> Uninstall progress bar doesn't show progress [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Uninstall progress bar doesn't show progress</div>
<hr />
<div class="pda"><a href="t-323918.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=323918">Uninstall progress bar doesn't show progress</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">oryan_dunn</div><div class="date">9th November 2010, 18:37</div></div><div class="posttext">Basically, the uninstall sits at 0 until it's done, then jumps to 100%<br />
<br />
# Uninstaller sections<br />
Section /o -un.Main UNSEC0000<br />
    RmDir /r /REBOOTOK $INSTDIR<br />
    DeleteRegValue SHCTX &quot;${REGKEY}\Components&quot; Main<br />
SectionEnd<br />
<br />
Animaether suggested in this post (http://forums.winamp.com/showthread.php?t=323847&amp;p=2715208) that it's because of too few code statements in my uninstall section, which would line up with the code I've posted above.  So, assuming that the one line rmdir that I'm currently doing is what I want to do, how do I expand that so that the progress bar will work properly?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">9th November 2010, 19:46</div></div><div class="posttext">You should never use RmDir /r $INSTDIR. First of all, in the uninstaller $INSTDIR may not contain the value you expect (see the manual entry on $INSTDIR). Second, if a user installs to for example Program Files, you'll end up deleting the entire Program Files directory. Third, if a user puts some of his own files in $INSTDIR, he would not expect you to delete them without asking for confirmation first. He will, instead, expect the uninstaller to only delete what it installed (it's called an uninstaller, after all).<br />
<br />
What you should do instead, is delete only the files you KNOW you want to delete:<br />
<br />
Section /o -un.Main UNSEC0000<br />
    Delete /REBOOTOK &quot;$INSTDIR\YourFile1.ext&quot;<br />
    Delete /REBOOTOK &quot;$INSTDIR\YourFile2.ext&quot;<br />
    Delete /REBOOTOK &quot;$INSTDIR\YourFile3.ext&quot;<br />
    ...etc<br />
    RmDir /REBOOTOK $INSTDIR<br />
    DeleteRegValue SHCTX &quot;${REGKEY}\Components&quot; Main<br />
SectionEnd<br />
<br />
<br />
Incidentally, the above approach will also solve your 0%-&gt;100% problem, because the progress bar is updated after every command.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">oryan_dunn</div><div class="date">9th November 2010, 21:06</div></div><div class="posttext">Thanks for the quick reply.  That all makes sense.  Couple of thoughts<br />
1. The un.Main code was auto-generated by EclipseNSIS (I know not officially part of NSIS), so perhaps I'll need to report an issue to them.<br />
2. The code that I use to add files is &quot;File /r /path/to/files/*&quot;, so I don't explicitly package individual files.<br />
<br />
It seems like I need to do this http://nsis.sourceforge.net/Uninstall_only_installed_files<br />
And it seems like this should be the default behavior, but I'm an NSIS newbie, so I don't claim to know/understand the reasoning behind the design.<br />
<br />
The other issue that I've noticed is that if you install X directories down, then the uninstaller leaves X empty directories laying around.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">10th November 2010, 07:29</div></div><div class="posttext">It seems like I need to do this http://nsis.sourceforge.net/Uninstall_only_installed_files<br />
Yes, that would be a good way to solve this issue. (Though I've never used those macros myself - I always make every File and Delete command explicit.)<br />
<br />
<br />
The other issue that I've noticed is that if you install X directories down, then the uninstaller leaves X empty directories laying around.<br />
For this, you can simply remove each directory in sequence:<br />
<br />
RmDir &quot;$INSTDIR\subdir1\subdir2\subdir3&quot;<br />
RmDir &quot;$INSTDIR\subdir1\subdir2&quot;<br />
RmDir &quot;$INSTDIR\subdir1&quot;<br />
RmDir &quot;$INSTDIR&quot;<br />
<br />
<br />
By the way, I don't use /REBOOTOK when removing directories, because if the directory wont remove, it's probable that there are some user files left over that aren't going to be removed anyway. Although I suppose you could put two groups of RmDir commands, one with and one without /rebootok, and put them under an if rebootflag==1.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">oryan_dunn</div><div class="date">10th November 2010, 15:04</div></div><div class="posttext">For this, you can simply remove each directory in sequence:<br />
<br />
RmDir &quot;$INSTDIR\subdir1\subdir2\subdir3&quot;<br />
RmDir &quot;$INSTDIR\subdir1\subdir2&quot;<br />
RmDir &quot;$INSTDIR\subdir1&quot;<br />
RmDir &quot;$INSTDIR&quot;<br />
<br />
<br />
By the way, I don't use /REBOOTOK when removing directories, because if the directory wont remove, it's probable that there are some user files left over that aren't going to be removed anyway. Although I suppose you could put two groups of RmDir commands, one with and one without /rebootok, and put them under an if rebootflag==1.<br />
<br />
The /REBOOTOK bits were generated by the EclipseNSIS wizard, so perhaps another issue to report.<br />
<br />
As far as the empty directories, I may not know how far down, ie. when the user picks an install directory, they pick $ProgramFiles\A\B\C, so $INSTDIR equals that, but now I uninstall, and I end up with a directory A that contains an empty directory B.  I guess the installer could walk the tree calling RMDIR on each parent until it fails?  What's the best way to handle this?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">10th November 2010, 16:25</div></div><div class="posttext">if the user chooses to install into some new subfolder structure (A\B\C\) and you install files into the leaf node C, you should only uninstall your files and subfolders of C - you wouldn't touch A or B.<br />
<br />
If you install files into another subfolder, e.g. A\B\C\YourApp\*.*, you would uninstall the files and folders within YourApp, and the folder YourApp itself.  You wouldn't be touching A, B or C.<br />
<br />
If the user thus ends up with empty folders.. that's their problem.. if they chose to do this, they probably had a reason.  E.g. if your program is a networking program, they might be installing to new folders \networkstuff\YourApp\, to subsequently plan to install \networkstuff\OtherApp\.  If you remove \networkstuff\, even if empty, the user will probably be annoyed :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">10th November 2010, 20:35</div></div><div class="posttext">if the user chooses to install into some new subfolder structure (A\B\C\) and you install files into the leaf node C, you should only uninstall your files and subfolders of C - you wouldn't touch A or B.<br />
Technically you're right, but if it's, say, D:\Games\YourGameApp, and you're the only game in that dir, then I for one would be glad to see the Games dir disappear upon uninstall. Matter of preference, I guess. And it doesn't go against the &quot;only remove files you know you want to delete&quot; principle, because you're the one who created the Games dir in the first place.<br />
<br />
Anyway, there's some function somewhere that gets the parent of a directory, but I forgot what it was called. I've always used RmDir $INSTDIR\.. , that works in almost all cases but it doesn't win a beauty contest.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">10th November 2010, 20:45</div></div><div class="posttext">${GetParent} in FileFunc.nsh :)<br />
<br />
As for the rest.. matter of healthy debate.. both have their merits, I suppose.<br />
<br />
Push comes to shove, you can always ask the user what to do :D</div></div><hr />


<div class="post"><div class="posttop"><div class="username">oryan_dunn</div><div class="date">10th November 2010, 20:50</div></div><div class="posttext">So the reason for the delete empty dir was not that the user may pick some nested dir, it's that the default install dir is something like $ProgramFiles\companyname\programname, and we have several programs, that all would get installed in companyname, so if you uninstall the last program, no need for the companyname dir anymore.  Same goes for start menu folder structure.<br />
<br />
I guess I could look at the parent and if it is companyname, remove it, but that seems kinda fragile.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">10th November 2010, 21:33</div></div><div class="posttext">might seem fragile, but sounds like that's exactly what you should be doing in the scenario you describe :)<br />
<br />
It's not that difficult anyway.<br />
<br />
<br />
StrCpy $0 &quot;c:\program files\myCompany\myFolder&quot; /* installation path */<br />
${GetParent} $0 $R0 /* $R0 now contains &quot;c:\program files\myCompany&quot; (sans quotes) */<br />
${GetFileName} $R0 $R1 /* $R1 now contains &quot;myCompany&quot; (sans quotes) */<br />
${If} &quot;$R1&quot; == &quot;myCompany&quot;<br />
  ${DirState} &quot;$R0&quot; $R2 /* get empty/non-empty/non-existent */<br />
  ${If} $R2 == 0<br />
    RMDir &quot;$R0&quot;<br />
  ${EndIf}<br />
${EndIf}<br />
<br />
( GetFileName is really more akin to a 'get leaf', as it's not really specific to getting the filename part of a path )<br />
<br />
All of those are in FileFunc.nsh</div></div><hr />


<div class="post"><div class="posttop"><div class="username">oryan_dunn</div><div class="date">16th November 2010, 00:48</div></div><div class="posttext">So I've run into an issue with using Uninstall only installed files (http://nsis.sourceforge.net/Uninstall_only_installed_files) macros.  In my code, I use &quot;File /r ${FILE_LOCATION}&quot; where file location is a folder with all the files I need to install.  The File macro doesn't support recursively adding files.  Would there be an easy way to modify the File macro to handle recursion?<br />
<br />
I'd love to explicitly list the files, but the output of our build produces different files and different file names, so I have to use recursion.<br />
<br />
Edit:<br />
I think I'd need a function like GetContents for a directory, and would need to check if it's a file, call the file macro, if it's a directory, move into the directory, and repeat.  I didn't see anything in FileFunc.nsh that would be helpful.<br />
<br />
Edit 2:<br />
I got around the issue of nuking the install directory by always installing into a subdir, but that doesn't solve the progressbar and really is only a stop gap solution so that people don't install into $ProgramFiles and wonder what happened when then uninstalled my app.<br />
<br />
I  used to have <br />
InstallDir &quot;${COMPANY}\$(^Name)&quot;<br />
    SetOutPath $INSTDIR<br />
and<br />
RmDir /r /REBOOTOK $INSTDIR<br />
<br />
and now it's<br />
InstallDir &quot;${COMPANY}&quot;<br />
    SetOutPath $INSTDIR\$(^Name)<br />
and<br />
StrCpy $0 &quot;$INSTDIR\$(^Name)&quot; /* installation path */<br />
    ${GetParent} $0 $R0 /* $R0 now contains &quot;c:\program files\myCompany&quot; (sans quotes) */<br />
    ${GetFileName} $R0 $R1 /* $R1 now contains &quot;myCompany&quot; (sans quotes) */<br />
    RmDir /r /REBOOTOK $INSTDIR\$(^Name)<br />
    ${If} &quot;$R1&quot; == &quot;${COMPANY}&quot;<br />
        ${DirState} &quot;$R0&quot; $R2 /* get empty/non-empty/non-existent */<br />
        ${If} $R2 == 0<br />
            RMDir &quot;$R0&quot;<br />
        ${EndIf}<br />
    ${EndIf}</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">17th November 2010, 20:56</div></div><div class="posttext">Perhaps..<br />
http://nsis.sourceforge.net/Advanced_Uninstall_Log_NSIS_Header<br />
..is more appropriate for your situation?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">oryan_dunn</div><div class="date">18th November 2010, 15:27</div></div><div class="posttext">Wow, I'll give that a shot.  Looks like exactly what I'd want.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>