<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" I dont understand why my if statement is failing, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  I dont understand why my if statement is failing NSIS Discussion" />
	
	<title> I dont understand why my if statement is failing [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  I dont understand why my if statement is failing</div>
<hr />
<div class="pda"><a href="t-246821.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=246821">I dont understand why my if statement is failing</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">shaunb</div><div class="date">23rd May 2006, 12:19</div></div><div class="posttext">I just dont get it anymore, my text file written from the CF script merely produces 'failed' or 'success' but the if comparison must fail, because the messagebox never gets shown. I thought it might be an &quot;\r\n&quot; on the end of the string in the text file, but its not. <br />
<br />
I have no idea why its happening any more, and also looping around this custom page is making me combust.<br />
<br />
thanks<br />
<br />
<br />
Function exitGetCFPassPage<br />
  !insertmacro MUI_INSTALLOPTIONS_READ $CFPASS &quot;getCFPass.ini&quot; &quot;Field 2&quot; &quot;State&quot;<br />
  MessageBox MB_OK &quot;$$CFPASS == $CFPASS&quot;<br />
  # check its not empty at least<br />
  #${If} $CFPASS == &quot;&quot;<br />
  #  # empty password, prompt for a valid password again<br />
  #  MessageBox MB_ICONEXCLAMATION|MB_OK &quot;Please enter a valid ColdFusion admin password.&quot;<br />
  #  abort<br />
  #${endIf}<br />
  # we forget all the items are extracted here already due to this page coming after the instfiles page<br />
  # we can just perform a simple wget on the testlogin script, and read the contents of c:\adminapi.log<br />
  # to see if it produced true or false for a valid login, then we can validate in here until we get a<br />
  # valid password!<br />
  NSExec::exec &quot;$TEMP\${gossTemp}\wget\wget.exe http://localhost/icm/adminAPI/testlogin.cfm?password=$CFPASS&quot;<br />
  # this returns a file c:\adminapi.log with true or false in, which we can use<br />
  # read the file, decide what to do etc, what about exceptions if its not there?<br />
  FileOpen $4 &quot;c:\adminapi.log&quot; r<br />
  # we read until the end of line (including carriage return and new line) and save it to $1<br />
  FileRead $4 $1<br />
  # close the file<br />
  FileClose $4<br />
  # debug the result<br />
  MessageBox MB_OK $1<br />
  ${If} $1 == &quot;failed&quot;<br />
    MessageBox MB_OK &quot;failed login!&quot;<br />
    abort<br />
  ${endIf}<br />
  # then it carries on anyway, why? it should abort<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">23rd May 2006, 12:59</div></div><div class="posttext">some quick notes:<br />
-stop the execution before open adminapi.log<br />
-verify that this file exists, is accessible and readble<br />
-you said it returns true or false, though you're checking for failed!<br />
-when you pop up that message with $1, does $1 contains &quot;failed&quot;?<br />
-finally try the nsExec::ExecToLog and/or nsExec::ExecToStack</div></div><hr />


<div class="post"><div class="posttop"><div class="username">shaunb</div><div class="date">23rd May 2006, 13:05</div></div><div class="posttext">I believe its something to do with a carriage return, on the end of the text in the file I created with CF, and trying to read in NSIS.<br />
<br />
hah, it says failed because I've been playing with it to get it to check right, tried 0 or 1, etc, nothing works. <br />
<br />
by stopping the execution I dont get how you do that exactly.<br />
<br />
the file exists for sure, and is readable etc, <br />
<br />
yes, the messagebox just contains success/failed, true or false etc, theres no extra text after (except maybe a carriage return I can't see), so this is why I dont get why the if statement underneath would fail.<br />
<br />
I am trying to work out the carriage return character so basically i can include that in my if statement too.. like so (where &quot;#&quot; is the CR)<br />
<br />
  # we need to check on the carriage return too.. but how?<br />
  ${If} $1 == &quot;failed#&quot;<br />
    MessageBox MB_OK &quot;failed login!&quot;<br />
    abort<br />
  ${endIf}<br />
<br />
hope this helps, a little, I've been trying for a couple hours now to no avail. gah</div></div><hr />


<div class="post"><div class="posttop"><div class="username">shaunb</div><div class="date">23rd May 2006, 13:09</div></div><div class="posttext">its this for sure, when I open the file in a word processor and turn on 'show extra formatting' it shows the CR/LF symbol.<br />
<br />
also, theres 7 bytes in the text file &quot;success&quot; but the actual file size is 9 bytes.<br />
<br />
I could do a sort of 'substr' on the string to find 'success' in 'success\r\n' I guess, but its a bit of a bodge</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">23rd May 2006, 13:15</div></div><div class="posttext">Then try wordfunc/textfunc to grab the string.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">23rd May 2006, 13:27</div></div><div class="posttext">OK this will make the job:<br />
strcpy $1 $1 '-2'<br />
 ${If} $1 == &quot;failed&quot;<br />
MessageBox MB_OK &quot;failed login!&quot;<br />
abort<br />
${endIf}</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">23rd May 2006, 13:35</div></div><div class="posttext">Well, create a text file, name it read.txt, write in this file failed press enter (add a CR) and save it in $exedir.<br />
Now compile and execute the following script:<br />
<br />
outfile test.exe<br />
<br />
function .onInit<br />
FileOpen $4 $EXEDIR\read.txt r<br />
FileRead $4 $1<br />
FileClose $4<br />
messagebox mb_ok '$1 contains a CR'<br />
strcpy $1 $1 '-2'<br />
strcmp $1 'failed' +1 +3<br />
messagebox mb_ok '$1 without CR'<br />
abort<br />
messagebox mb_ok 'Error!'<br />
functionend<br />
<br />
section -<br />
sectionend</div></div><hr />


<div class="post"><div class="posttop"><div class="username">shaunb</div><div class="date">23rd May 2006, 13:35</div></div><div class="posttext">thats exactly what i'm trying now, chopping two bytes from the end! will let you know how it goes.<br />
<br />
edit: works fantastically. now.. what about changing the focus back from the next button, to the texbox and clearing the value of the wrong password?<br />
<br />
thanks, I owe you a lot, the help this community gives is great.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">23rd May 2006, 13:50</div></div><div class="posttext">thanks, I owe you a lot, the help this community gives is great.<br />
You welcome :-) we all owe to NSIS development team.<br />
<br />
<br />
what about changing the focus back from the next button, to the texbox and clearing the value of the wrong password?<br />
Abort on a custom page leave function means that you stay in the page because validation has failed.<br />
To clear the pwd field use SendMessage e.g.<br />
!include WinMessages.nsh ;up along with other includes<br />
 !insertmacro MUI_INSTALLOPTIONS_READ $0 &quot;getCFPass.ini&quot; &quot;Field 2&quot; &quot;HWND&quot;<br />
SendMessage $0 ${WM_SETTEXT} 1 &quot;STR:&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">shaunb</div><div class="date">23rd May 2006, 14:10</div></div><div class="posttext">that works great too, just need to set the focus now , I tried the obvious WM_SETFOCUS but meh. didnt work<br />
<br />
I'll work this one out though .. hehe</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">23rd May 2006, 17:58</div></div><div class="posttext">SendMessage $0 ${WM_SETFOCUS} 1 0</div></div><hr />


<div class="post"><div class="posttop"><div class="username">shaunb</div><div class="date">23rd May 2006, 19:36</div></div><div class="posttext">I was close! just missing the end bits, I'll try it tomorrow! thanks muchly</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">23rd May 2006, 19:50</div></div><div class="posttext">Use TrimNewLines function in the documentation under Useful Scripts. It's not always guaranteed that the file will use carriage returns followed by new line breaks and a -2 chop may remove more characters than you want it to.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">shaunb</div><div class="date">24th May 2006, 09:13</div></div><div class="posttext">Hmm, thats the only time i need to read from a text file thankfully.<br />
<br />
The setfocus code, it sets the focus back to the textbox as I can see the cursor re-appear in the textbox after a wrong password, however, when I try to type I realise the focus is still actually on the next button, odd, strange how it appears the textbox is in focus. I still have to click in the textbox to edit however.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">zeeh3</div><div class="date">24th May 2006, 19:01</div></div><div class="posttext">Originally posted by Red Wine <br />
SendMessage $0 ${WM_SETFOCUS} 1 0  <br />
<br />
Use instead: System::Call &quot;user32::SetFocus(i r0, i 0x0007, i,i)i&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">24th May 2006, 19:21</div></div><div class="posttext">Use instead: System::Call &quot;user32::SetFocus(i r0, i 0x0007, i,i)i&quot;<br />
Did you use that your self?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">24th May 2006, 19:27</div></div><div class="posttext">I'm not sure why you have those extra parameters zeeh3, unless I'm missing something.<br />
<br />
user32::SetFocus only takes one parameter and that is the window handle of the control to set keyboard focus on.<br />
<br />
http://msdn.microsoft.com/library/default.asp?url=/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/setfocus.asp<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">zeeh3</div><div class="date">24th May 2006, 19:41</div></div><div class="posttext">Oops... System::Call &quot;user32::SetFocus(i r0)i&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">shaunb</div><div class="date">24th May 2006, 20:12</div></div><div class="posttext">thanks guys, will give it a go tomorrow.<br />
<br />
edit: just checking, is &quot;r0&quot; supposed to be $R0  ? <br />
<br />
:)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Red Wine</div><div class="date">24th May 2006, 20:21</div></div><div class="posttext">r0 == $0</div></div><hr />


<div class="post"><div class="posttop"><div class="username">zeeh3</div><div class="date">24th May 2006, 20:21</div></div><div class="posttext">Originally posted by shaunb <br />
thanks guys, will give it a go tomorrow.<br />
<br />
edit: just checking, is &quot;r0&quot; supposed to be $R0  ? <br />
<br />
:)  <br />
<br />
No, read system plugin documentation:<br />
r0 through r9 = $0 through $9<br />
r10 through r19 (or R0 through R9) = $R0 through $R9, respectively.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">shaunb</div><div class="date">25th May 2006, 10:36</div></div><div class="posttext">Originally posted by zeeh3 <br />
Oops... System::Call &quot;user32::SetFocus(i r0)i&quot; <br />
<br />
works perfect, thanks very much<br />
<br />
I understand the registers better I think now, too.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>