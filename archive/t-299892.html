<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Onname Filenames not null-terminated.Windows FindNext FindFirst Fails with zero files, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Onname Filenames not null-terminated.Windows FindNext FindFirst Fails with zero files NSIS Discussion" />
	
	<title> Onname Filenames not null-terminated.Windows FindNext FindFirst Fails with zero files [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Onname Filenames not null-terminated.Windows FindNext FindFirst Fails with zero files</div>
<hr />
<div class="pda"><a href="t-299892.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=299892">Onname Filenames not null-terminated.Windows FindNext FindFirst Fails with zero files</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Andrew Wallo</div><div class="date">13th November 2008, 19:46</div></div><div class="posttext">Potential bug in the File \onname feature of NSIS.<br />
<br />
The following code was used to create 2000 dummy emails for stress testing an email program.  ( You would need to provide dummy email files to pass compile... )  I had four files, a clean pair and a dirty pair.  ( not really important, just FYI when you read the code. ) odds became clean, even numbers dirty, in the loop. <br />
<br />
The problem was that the program that was being used to call the email filter ( out of scope but C++ gnu compiled. )  used WINAPI's FindFirst, FindNext functions to trigger its activies when a file arrives in the folder.<br />
<br />
I was running XP Pro and came upon this nusiance.  There is a documented error with WINAPI FindFirst and FindNext such that it fails and returns a null set when the names in the directory are not null terminated properly.<br />
<br />
The trigger program was NOT finding these files when I dumped the files made by the following script into the spool.<br />
<br />
Renaming the files after they were created caused the trigger program to beable to grab the files.<br />
<br />
I altered the script to dump out the file without the /onname feature, and then renamed the file with Rename.<br />
<br />
The files were fully functional and worked with the other program without any problem.<br />
<br />
Therefour I humbly submit that the output of File /onname fails to add a \0 to the end of the string of the file names.... and it will cause problems when files created by it are scanned or listed or used by other c++ programs.<br />
<br />
<br />
Can someone please confirm this as a noted bug?<br />
<br />
Thanks,<br />
<br />
Andrew Wallo<br />
Avid NSIS developer.<br />
<br />
<br />
Function .onInit<br />
<br />
  Var /GLOBAL pathHandle<br />
<br />
  StrCpy $pathHandle &quot;C:\FakeEmailFolder\&quot;<br />
  CreateDirectory $pathHandle <br />
<br />
  Var /GLOBAL counter<br />
  Var /GLOBAL oddOrEven <br />
  StrCpy $counter &quot;21000&quot;<br />
  Var /GLOBAL dtafilename<br />
  Var /GLOBAL ctlfilename<br />
  <br />
  SetoutPath $pathHandle<br />
  ${while} $counter &lt; 22000<br />
<br />
   IntOp $oddOrEven $counter % 2<br />
   StrCpy $dtafilename &quot;0000$counter.dta&quot;<br />
   StrCpy $ctlfilename &quot;0000$counter.ctl&quot;<br />
<br />
   StrCmp $oddOrEven &quot;1&quot; 0 Doclean<br />
    ; USING FILE ONNAME creates filenames without nullterminated filenames.<br />
    ;File &quot;/oname= $dtafilename&quot; &quot;DirtyDTAFile.dta&quot;<br />
    ; HAD TO WRITE OUT AND RENAME TO CREATE WORKAROUND.<br />
    File &quot;DirtyDTAFile.dta&quot;<br />
    Rename &quot;DirtyDTAFile.dta&quot; $dtafilename<br />
    ;File &quot;/oname= $ctlfilename&quot; &quot;DirtyCTLFile.ctl&quot;<br />
    File &quot;DirtyCTLFile.ctl&quot;<br />
    Rename &quot;DirtyCTLFile.ctl&quot; $ctlfilename<br />
    Goto LoopAgain<br />
   Doclean:<br />
    ;File &quot;/oname= $dtafilename&quot; &quot;CleanDTAFile.dta&quot;<br />
    ;File &quot;/oname= $ctlfilename&quot; &quot;CleanCTLFile.ctl&quot;<br />
        File &quot;CleanDTAFile.dta&quot;<br />
    Rename &quot;CleanDTAFile.dta&quot; $dtafilename<br />
    ;File &quot;/oname= $ctlfilename&quot; &quot;DirtyCTLFile.ctl&quot;<br />
    File &quot;CleanCTLFile.ctl&quot;<br />
    Rename &quot;CleanCTLFile.ctl&quot; $ctlfilename<br />
    <br />
<br />
   LoopAgain:<br />
    IntOp $counter $counter + 1<br />
  ${endwhile} <br />
<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">14th November 2008, 08:10</div></div><div class="posttext">We simply call CreateFile in either case. I can't see how that would work without a NULL terminator. Can you point me to the description of this FindNext bug?<br />
<br />
And even though it's probably not your monitoring program, I'll just add that using FindFirstChangeNotification is a way better method than checking the directory structure in a busy loop.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>