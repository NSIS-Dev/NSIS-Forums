<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Problem with DumpLog and NSIS 2.38-1 Unicode, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Problem with DumpLog and NSIS 2.38-1 Unicode NSIS Discussion" />
	
	<title> Problem with DumpLog and NSIS 2.38-1 Unicode [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Problem with DumpLog and NSIS 2.38-1 Unicode</div>
<hr />
<div class="pda"><a href="t-300271.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=300271">Problem with DumpLog and NSIS 2.38-1 Unicode</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">xbarns</div><div class="date">24th November 2008, 11:14</div></div><div class="posttext">Hi all, <br />
<br />
i have a little problem, i am using the DumpLog function as described here http://nsis.sourceforge.net/Docs/AppendixD.html#D.4. Now i switched from 2.37-1 Unicode to 2.38-Unicode NSIS and suddenly that DumpLog now only produces a lot of ??? in the logfile instead of dumping the log (well i guess it is the log just not readable anymore). <br />
<br />
When i go back to 2.37-1 it works fine, the Problem is that 2.37-1 has other errors that prevent me from using it. (I get cut off strings when reading nsdialog text fields.)<br />
<br />
Any Ideas ?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">xbarns</div><div class="date">28th November 2008, 12:37</div></div><div class="posttext">*bump*<br />
<br />
Anyone? :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">28th November 2008, 14:58</div></div><div class="posttext">Try adding a message box with the data written to the file before it's written (before the FileWrite line). That would tell you if the problem is with the System plug-in or FileWrite. If it's with FileWrite, try opening the text file with a different editor. Notepad should probably work the best.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">xbarns</div><div class="date">28th November 2008, 18:01</div></div><div class="posttext">Well the Messagebox gives me a bunch of squares, so i guess its not the Filewrite but rather the System Plug-in. <br />
<br />
The system.dlls do look the same, but when i replaced the 2.38 with the 2.37 one it works.<br />
<br />
Can i just use the one from 2.37 or are there significant changes that i have to look out for?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">28th November 2008, 18:13</div></div><div class="posttext">There were no changes in the official version's System plug-in on that version, so I guess the change was made in the Unicode branch. You'll have to ask Jim Park.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jimpark</div><div class="date">6th January 2009, 18:34</div></div><div class="posttext">There are several problems with the DumpLog function that needs to be fixed.  For one, the LVM_GETITEMTEXT message ID used there is for getting the ANSI string.  You need a different message ID for getting the Unicode string.  And secondly, when you allocate memory for the string, you have to remember that you need sizeof(wchar_t) * NSIS_MAX_STRLEN.  And thirdly, when writing out a Unicode text file, you want to write out the BOM first.  Here's the modified DumpLog for Unicode NSIS:<br />
<br />
<br />
!define LVM_GETITEMCOUNT 0x1004<br />
!define LVM_GETITEMTEXT 0x1073<br />
<br />
Function DumpLog<br />
  Exch $5<br />
  Push $0<br />
  Push $1<br />
  Push $2<br />
  Push $3<br />
  Push $4<br />
  Push $6<br />
  Push $7<br />
<br />
  FindWindow $0 &quot;#32770&quot; &quot;&quot; $HWNDPARENT<br />
  GetDlgItem $0 $0 1016<br />
  StrCmp $0 0 error<br />
  FileOpen $5 $5 &quot;w&quot;<br />
  FileWriteWord $5 0xfeff ; Write the BOM<br />
  StrCmp $5 0 error<br />
    SendMessage $0 ${LVM_GETITEMCOUNT} 0 0 $6<br />
    IntOp $7 ${NSIS_MAX_STRLEN} * 2<br />
    System::Alloc $7<br />
    Pop $3<br />
    StrCpy $2 0<br />
    System::Call &quot;*(i, i, i, i, i, i, i, i, i) i \<br />
      (0, 0, 0, 0, 0, r3, ${NSIS_MAX_STRLEN}) .r1&quot;<br />
    loop: StrCmp $2 $6 done<br />
      System::Call &quot;User32::SendMessageW(i, i, i, i) i \<br />
        ($0, ${LVM_GETITEMTEXT}, $2, r1)&quot;<br />
      System::Call &quot;*$3(&amp;t${NSIS_MAX_STRLEN} .r4)&quot;<br />
      FileWriteUTF16LE $5 &quot;$4$\r$\n&quot;<br />
      IntOp $2 $2 + 1<br />
      Goto loop<br />
    done:<br />
      FileClose $5<br />
      System::Free $1<br />
      System::Free $3<br />
      Goto exit<br />
  error:<br />
    MessageBox MB_OK error<br />
  exit:<br />
    Pop $7<br />
    Pop $6<br />
    Pop $4<br />
    Pop $3<br />
    Pop $2<br />
    Pop $1<br />
    Pop $0<br />
    Exch $5<br />
FunctionEnd<br />
<br />
<br />
So the lesson is when using System calls, we have to be really careful about porting the ANSI NSI script to Unicode.  A lot of the math involved with memory, the message IDs being used etc. all need to be correct.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">xbarns</div><div class="date">6th January 2009, 20:03</div></div><div class="posttext">:up: :up: :up: :up: <br />
<br />
This one works, thanks a lot.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>