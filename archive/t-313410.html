<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Help with plugin development, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Help with plugin development NSIS Discussion" />
	
	<title> Help with plugin development [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Help with plugin development</div>
<hr />
<div class="pda"><a href="t-313410.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=313410">Help with plugin development</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">jweinraub</div><div class="date">5th October 2009, 15:13</div></div><div class="posttext">Hi,<br />
<br />
I am making a very simple dialog box in C since I needed certain features that I couldn't get with NSIS.<br />
<br />
The program works as a dll, but now I am trying to convert it into a plugin and having all sorts of problems.<br />
<br />
Essentially I have a function that calls the dialog box and based on whats returned gets a certain number which the dll function is calling.<br />
<br />
<br />
void __declspec(dllexport) SHOW(HWND hwndParent, int string_size, char *variables, stack_t **stacktop)<br />
{<br />
  g_stacktop=stacktop;<br />
  {<br />
	popstring(szBuf);<br />
	popstring(szError);<br />
	nVarError=getvarindex(szError);<br />
<br />
	wsprintf(szBuf, &quot;%d&quot;, RunDialogBox() );<br />
	setvar(nVarError, szBuf, string_size, variables);<br />
  }<br />
}<br />
<br />
<br />
This was the original before adding the dll (obviously the below wasnt commented out)<br />
<br />
<br />
//__declspec(dllexport)<br />
int RunDialogBox()  // DemoDialogBoxDll::RunDialogBox<br />
{<br />
	int result = FALSE;<br />
<br />
	result = DialogBoxParam(hModule, MAKEINTRESOURCE(IDD_DIALOG), NULL, DialogProc, (LPARAM)(NULL));	<br />
<br />
	return result;<br />
}<br />
<br />
<br />
<br />
Warning	1	warning C4133: 'function' : incompatible types - from 'char *' to 'LPWSTR'	c:\Documents and Settings\jweinraub\Desktop\DemoDialogBoxDll\DemoDialogBoxDll\DemoDialogBoxDll.c	73	DemoDialogBoxDll<br />
Warning	2	warning C4133: 'function' : incompatible types - from 'char [1024]' to 'LPCWSTR'	c:\Documents and Settings\jweinraub\Desktop\DemoDialogBoxDll\DemoDialogBoxDll\DemoDialogBoxDll.c	73	DemoDialogBoxDll<br />
Warning	3	warning C4133: 'function' : incompatible types - from 'char *' to 'LPWSTR'	c:\Documents and Settings\jweinraub\Desktop\DemoDialogBoxDll\DemoDialogBoxDll\DemoDialogBoxDll.c	83	DemoDialogBoxDll<br />
Warning	4	warning C4133: 'function' : incompatible types - from 'const char *' to 'LPCWSTR'	c:\Documents and Settings\jweinraub\Desktop\DemoDialogBoxDll\DemoDialogBoxDll\DemoDialogBoxDll.c	83	DemoDialogBoxDll<br />
Warning	5	warning C4133: 'function' : incompatible types - from 'char *' to 'LPCWSTR'	c:\Documents and Settings\jweinraub\Desktop\DemoDialogBoxDll\DemoDialogBoxDll\DemoDialogBoxDll.c	91	DemoDialogBoxDll<br />
<br />
......<br />
<br />
Warning	46	warning C4133: 'function' : incompatible types - from 'char [3]' to 'LPCWSTR'	c:\Documents and Settings\jweinraub\Desktop\DemoDialogBoxDll\DemoDialogBoxDll\DemoDialogBoxDll.c	164	DemoDialogBoxDll<br />
<br />
And help is greatly appreciated.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">5th October 2009, 16:02</div></div><div class="posttext">your project settings seem to be set for unicode, if you want to create a ansi plugin for the &quot;normal&quot; nsis, turn off unicode (no UNICODE defines). If you want to compile a unicode plugin for unicode nsis, change char to WCHAR in your code. If you want to compile for both, #include &lt;TCHAR.H&gt; and change char to TCHAR in your code</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jweinraub</div><div class="date">5th October 2009, 19:10</div></div><div class="posttext">Thank you.  I also found more errors happened because when I changed to Release, I forgot to change exe to dll!<br />
<br />
I also changed the code completely.<br />
<br />
<br />
#define _IBATWARNING_<br />
#include &quot;resource.h&quot;<br />
#include &quot;IBATWarning.h&quot;<br />
<br />
/* Defines */<br />
#define NSIS_MAX_STRLEN 1024<br />
<br />
/* NSIS stack structure */<br />
typedef struct _stack_t <br />
{<br />
	struct _stack_t *next;<br />
	char text[NSIS_MAX_STRLEN];<br />
} stack_t;<br />
<br />
stack_t **g_stacktop;<br />
<br />
<br />
HINSTANCE g_hInstance;<br />
HWND g_hwndParent;<br />
int g_stringsize;<br />
char *g_variables;<br />
<br />
<br />
char *getvar(int varnum);<br />
void setvar(int varnum, char *var);<br />
int runDialogBox();<br />
<br />
/* Global variables */<br />
char szBuf[NSIS_MAX_STRLEN]=&quot;&quot;;<br />
char szError[4]=&quot;&quot;;<br />
int nVarError;<br />
int res = 0;<br />
<br />
enum <br />
{<br />
	INST_0,         // $0<br />
	INST_1,         // $1<br />
	INST_2,         // $2<br />
	INST_3,         // $3<br />
	INST_4,         // $4<br />
	INST_5,         // $5<br />
	INST_6,         // $6<br />
	INST_7,         // $7<br />
	INST_8,         // $8<br />
	INST_9,         // $9<br />
	INST_R0,        // $R0<br />
	INST_R1,        // $R1<br />
	INST_R2,        // $R2<br />
	INST_R3,        // $R3<br />
	INST_R4,        // $R4<br />
	INST_R5,        // $R5<br />
	INST_R6,        // $R6<br />
	INST_R7,        // $R7<br />
	INST_R8,        // $R8<br />
	INST_R9,        // $R9<br />
	INST_CMDLINE,   // $CMDLINE<br />
	INST_INSTDIR,   // $INSTDIR<br />
	INST_OUTDIR,    // $OUTDIR<br />
	INST_EXEDIR,    // $EXEDIR<br />
	__INST_LAST<br />
};<br />
<br />
BOOL APIENTRY DllMain( HANDLE hModulePar, <br />
                       DWORD  ul_reason_for_call, <br />
                       LPVOID lpReserved<br />
					 )<br />
{<br />
switch (ul_reason_for_call)<br />
    {<br />
case DLL_PROCESS_ATTACH:<br />
	hModule = hModulePar;<br />
	break;<br />
<br />
case DLL_PROCESS_DETACH:	<br />
	break;<br />
    }<br />
<br />
return TRUE;<br />
}<br />
<br />
LRESULT CALLBACK DialogProc(HWND hDlg, UINT message, WPARAM wParam, LPARAM lParam)<br />
{<br />
	switch(message)<br />
	{<br />
	case WM_INITDIALOG:		<br />
		CheckDlgButton(hDlg, IDC_CHECK, FALSE);<br />
		EnableWindow(GetDlgItem(hDlg, IDOK), FALSE);<br />
		return TRUE;<br />
<br />
	case WM_COMMAND:<br />
		switch (LOWORD(wParam))<br />
		{<br />
		case IDC_CHECK:<br />
			if (IsDlgButtonChecked(hDlg, IDC_CHECK))<br />
			{<br />
				EnableWindow(GetDlgItem(hDlg, IDOK), TRUE);<br />
				EnableWindow(GetDlgItem(hDlg, IDCANCEL), FALSE);<br />
			}<br />
			else<br />
			{<br />
				EnableWindow(GetDlgItem(hDlg, IDOK), FALSE);<br />
				EnableWindow(GetDlgItem(hDlg, IDCANCEL), TRUE);<br />
			}<br />
			break;<br />
		case IDOK:<br />
			{			<br />
				EndDialog(hDlg, TRUE);<br />
				return FALSE;<br />
			}<br />
		case IDCANCEL:<br />
			{				<br />
				EndDialog(hDlg, FALSE);<br />
				return FALSE;<br />
			}<br />
		}<br />
	}<br />
	return FALSE;<br />
}<br />
// Sets user variable<br />
void setvar( int varnum, char * var ) <br />
{<br />
	if (var != NULL &amp;&amp; varnum &gt;= 0 &amp;&amp; varnum &lt; __INST_LAST) <br />
	{<br />
		lstrcpy (g_variables + varnum*g_stringsize, var);<br />
	}<br />
}<br />
<br />
// Gets user variable<br />
char *getvar(int varnum) <br />
{<br />
	if (varnum &lt; 0 || varnum &gt;= __INST_LAST) <br />
		return NULL;<br />
	return g_variables + varnum*g_stringsize;<br />
}<br />
<br />
<br />
void __declspec(dllexport) Show(HWND hwndParent, int string_size, char *variables, stack_t **stacktop)<br />
{<br />
	g_hwndParent=hwndParent;<br />
	g_stringsize=string_size;<br />
	g_variables=variables;<br />
    res = runDialogBox();<br />
	if ( res == 0 )<br />
		setvar(INST_0,&quot;abort&quot; );<br />
	else<br />
		setvar(INST_0,&quot;agree&quot; );<br />
}<br />
<br />
<br />
//__declspec(dllexport)<br />
int runDialogBox()  <br />
{<br />
	int result = FALSE;<br />
	result = DialogBoxParam(hModule, MAKEINTRESOURCE(IDD_DIALOG), NULL, DialogProc, (LPARAM)(NULL));	<br />
	<br />
	return result;<br />
}</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">5th October 2009, 19:33</div></div><div class="posttext">you can't use NSIS_MAX_STRLEN, you need to allocate memory at runtime with string_size size</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jweinraub</div><div class="date">5th October 2009, 19:38</div></div><div class="posttext">Anders,<br />
<br />
I am still very new at this, can you tell me how I exactly do that?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">5th October 2009, 19:51</div></div><div class="posttext">well, your current code is not using the stack or the szBuf global. But if you need to code that uses them, allocate and free the memory with GlobalAlloc/Free ( http://nsis.svn.sourceforge.net/viewvc/nsis/NSIS/trunk/Contrib/ExDLL/pluginapi.c?revision=5856&amp;view=markup has sample code for stack usage )</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jweinraub</div><div class="date">5th October 2009, 19:58</div></div><div class="posttext">If I use it as is, is it a memory leak?<br />
<br />
I pretty much did the dll project first, then I adapted it to nsis plugin by following some other sample code I found.<br />
<br />
Essentially, this just plops up a dialogue box with several options in it, and it just returns 0 or 1 based on the box outcome.<br />
<br />
So, $0 just gets the &quot;agree&quot; or &quot;abort&quot; and the nsis uses that and goes from there.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">5th October 2009, 20:11</div></div><div class="posttext">no, you can use it as is, setvar() does not have that problem (As long as the string is somewhat short like the ones you are using, if it is closer to 1024 or more, you probably need to use lstrcpyn in setvar and limit to string_size)<br />
<br />
You should probably remove the NSIS_MAX_STRLEN define so you don't use it by accident in the future</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jweinraub</div><div class="date">5th October 2009, 20:16</div></div><div class="posttext">Since I am more used to C++, I guess I should of done something like strSz = new strSz or somehting to allocate it to the pointer?  Should I do that now?<br />
<br />
How would you change that so it is better code?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jweinraub</div><div class="date">5th October 2009, 20:18</div></div><div class="posttext">do something like this....?<br />
<br />
<br />
#define _IBATWARNING_<br />
#include &quot;resource.h&quot;<br />
#include &quot;IBATWarning.h&quot;<br />
<br />
/* NSIS stack structure */<br />
typedef struct _stack_t <br />
{<br />
	struct _stack_t *next;<br />
	char text[256];<br />
} stack_t;<br />
<br />
stack_t **g_stacktop;<br />
<br />
<br />
HINSTANCE g_hInstance;<br />
HWND g_hwndParent;<br />
int g_stringsize;<br />
char *g_variables;<br />
<br />
<br />
char *getvar(int varnum);<br />
void setvar(int varnum, char *var);<br />
int runDialogBox();<br />
<br />
/* Global variables */<br />
char szBuf[256]=&quot;&quot;;<br />
char szError[4]=&quot;&quot;;<br />
int nVarError;<br />
int res = 0;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">5th October 2009, 21:04</div></div><div class="posttext">no, I already told you, you need to allocate memory with GlobalAlloc, you can't use fixed size arrays ( foo[...] ) <br />
<br />
<br />
void __declspec(dllexport) MyFunction(HWND h,int stringsize)<br />
{<br />
  char*mystringbuffer;<br />
  mystringbuffer=(char*)GlobalAlloc(GPTR,stringsize);<br />
  //call popstring() from sample code I linked to to get string from stack<br />
  //do something with mystringbuffer...<br />
  GlobalFree(mystringbuffer);<br />
}</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>