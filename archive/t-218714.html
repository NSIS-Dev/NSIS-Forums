<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Plugin for Unicode files conversion, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Plugin for Unicode files conversion NSIS Discussion" />
	
	<title> Plugin for Unicode files conversion [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Plugin for Unicode files conversion</div>
<hr />
<div class="pda"><a href="t-218714.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=218714">Plugin for Unicode files conversion</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">Instructor</div><div class="date">12th June 2005, 14:50</div></div><div class="posttext">Features:<br />
-Convert file from Unicode to ANSI<br />
-Convert file from ANSI to Unicode<br />
&amp;nbsp;&amp;nbsp;&amp;nbsp;Conversions supported:<br />
&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;UTF-8&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;-&gt; ANSI<br />
&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;UTF-16LE&quot; &lt;-&gt; ANSI<br />
&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;UTF-16BE&quot; &lt;-&gt; ANSI<br />
<br />
-Get file unicode type:<br />
&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;NONE&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;- None Unicode<br />
&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;UTF-8&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;- 8-bit  Variable Width (Web)<br />
&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;UTF-16LE|UCS-2LE&quot; - 16-bit Little Endian (Default for Windows)<br />
&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;UTF-16BE|UCS-2BE&quot; - 16-bit Big Endian (Default for Linux)<br />
&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;UTF-32LE|UCS-4LE&quot; - 32-bit Little Endian<br />
&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;UTF-32BE|UCS-4BE&quot; - 32-bit Big Endian<br />
<br />
&quot;unicode&quot; v1.0</div></div><hr />


<div class="post"><div class="posttop"><div class="username">tpr</div><div class="date">18th November 2008, 12:30</div></div><div class="posttext">Many thanks for this. I needed exactly this one.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">AxelMock</div><div class="date">26th February 2009, 15:04</div></div><div class="posttext">Hi,<br />
<br />
I used this plugin to convert an .inf file from Unicode to ANSI to search for some value in the .inf file using the standard (non-Unicode) NSIS version.<br />
<br />
Worked fine on the systems we tested here (German, English), but a customer reported that the application would stop (exception) on a chinese windows system (IDENTICAL .inf file). <br />
<br />
Testing showed that japanese systems were affected too.<br />
<br />
I started debugging, made a debug version of the DLL and a small test program. I ended debugging on the japanese and chinese system finding that the Call to kernel32::WideCharToMultiByte delivers the exception.<br />
According to Microsoft documentation of that function the call made in unicode.dll is correct (using CP_ACP and no user defined replacement).<br />
I limited the conversion to the starting file part woth NO language specific unicode character, and the function succeeds. IMHO must be some problem of the function with the ANSI codepage on these systems. <br />
<br />
Playing around with some option flags, I could avoid the exeception, but the conversion did NOT take place (0 chars converted).<br />
<br />
In my case a working function FileUnicode2UTF8 could have helped. I just could'n t figure out how to dimension the buffer as a UTF-8 char might take up multiple byte chars.<br />
<br />
IMHO:This Unicode conversion plugin will get more important when the Unicode version of NSIS will be more widely used.<br />
(Or does the NSIS Unicode branch supply its own conversion tools/keywords?)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">akopts</div><div class="date">27th February 2009, 16:21</div></div><div class="posttext">Is there a way to convert from UTF-16LE to UTF-8?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">AxelMock</div><div class="date">2nd March 2009, 16:20</div></div><div class="posttext">Originally posted by akopts <br />
Is there a way to convert from UTF-16LE to UTF-8?  <br />
See<br />
Comment in NSIS Unicode Thread (http://forums.winamp.com/showthread.php?postid=2491531#post2491531)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">AxelMock</div><div class="date">2nd March 2009, 17:24</div></div><div class="posttext">Originally posted by AxelMock <br />
See<br />
Comment in NSIS Unicode Thread (http://forums.winamp.com/showthread.php?postid=2491531#post2491531)  <br />
<br />
The updated version V1.1 is available.<br />
Wiki updated too.<br />
New function: FileUnicode2UTF8</div></div><hr />


<div class="post"><div class="posttop"><div class="username">gringoloco023</div><div class="date">29th July 2010, 22:38</div></div><div class="posttext">Bugs, the following line:<br />
unicode::FileUnicode2Ansi &quot;$EXEDIR\UTF-16LE.txt&quot; &quot;$EXEDIR\Temp.txt&quot; &quot;UTF-16LE&quot;<br />
<br />
unicode.dll v1.0 : adds a question-mark to the beginning of 'Temp.txt'<br />
unicode.dll v1.1 : just creates an empty 'Temp.txt' file, but returns 0<br />
<br />
Where 'UTF-16LE' is the file from the example script, but it seems to happen to all utf-16LE files !</div></div><hr />


<div class="post"><div class="posttop"><div class="username">koelzk</div><div class="date">1st September 2010, 16:42</div></div><div class="posttext">Hi,<br />
<br />
I am working on an installer for the NSIS Unicode build. I wanted to use FileUnicode2UTF8 to convert a text file from UCS-2 LE to UTF-8. The background is I want to write a user selected folder path into a configuration file that uses UTF-8 encoding.<br />
<br />
However, I just can't get the plug-in to convert the file, I always get error code 2. Is this a problem of NSIS Unicode or is my script file wrong (see attached file)?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">gringoloco023</div><div class="date">1st September 2010, 17:57</div></div><div class="posttext">As there where a few utf-16 functions missing in TextFunc.nsh, I updated it one day and included some extras for ${FileRecode}<br />
<br />
Aswell I made a couple of minor adjustments to your script:<br />
!include TextFuncUTF16.nsh<br />
Section &quot;&quot;<br />
	; Write Settings.ini:<br />
	FileOpen $0 &quot;$EXEDIR\Settings.ini&quot; w<br />
	StrCpy $R0 &quot;Folder=セちさ&quot; ; Sample unicode string with 3 Japanese characters<br />
	FileWriteWord $0 0xFEFF ; write the BOM<br />
	FileWriteUTF16LE $0 $R0<br />
	FileClose $0<br />
	; Convert file from Unicode to UTF-8<br />
	StrCpy $0 &quot;$EXEDIR\Settings.ini&quot;<br />
	StrCpy $1 &quot;$EXEDIR\Settings2.ini&quot;<br />
	StrCpy $2 &quot;ToUTF8&quot;<br />
	CopyFiles /SILENT $0 $1<br />
	${FileRecode} $1 $2<br />
	; Print some information<br />
	DetailPrint 'FileRecode to UTF8 &quot;$0&quot; &quot;$1&quot; $2'<br />
	DetailPrint &quot;$3&quot;<br />
	DetailPrint &quot;&quot;<br />
SectionEnd<br />
<br />
BTW: I remember I used to get the occasional crash whenever I done repetitive re-coding. Although I found out how to fix it I did not get around to it yet. If you're experiencing any problems with it I will put it higher on my priority list .</div></div><hr />


<div class="post"><div class="posttop"><div class="username">koelzk</div><div class="date">1st September 2010, 20:06</div></div><div class="posttext">Thanks for the quick reply :). Your script is a big help. However, as you said, there still seems to be a bug in the conversion.<br />
<br />
When I run the script, a few random characters are added to the end of the converted text file. The number of random characters differs from run to run (usually 3), sometimes no characters are added and the converted file is fine.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">gringoloco023</div><div class="date">1st September 2010, 21:08</div></div><div class="posttext">I never experienced random characters on the end of the file.<br />
<br />
Just to make sure, you are not talking about the BOM for utf-8 ( ï»¿ ) ?<br />
Which re-coding are you doing ? From utf-16LE to utf-8 ?<br />
<br />
Anyway, I will look into it these days... (shouldn't be that much work)<br />
<br />
Edit: Just to remind you, your Japanese characters take 6 bytes in utf-16, but 9 bytes in utf-8.<br />
utf-8:<br />
EF BB BF 46 6F 6C 64 65 72 3D E3 82 BB E3 81 A1 E3 81 95 = ï»¿Folder=ã‚»ã¡ã•   <br />
        <br />
utf-16LE:<br />
FF FE 46 00 6F 00 6C 00 64 00 65 00 72 00 3D 00 BB 30 61 30 55 30 = ÿþF.o.l.d.e.r.=.»0a0U0</div></div><hr />


<div class="post"><div class="posttop"><div class="username">koelzk</div><div class="date">2nd September 2010, 17:12</div></div><div class="posttext">No, I don't think it's a byte order mark, just a few random bytes (and the bom at the beginning of the Settings2.ini is correct.). Notepad++ also shows them as additional characters.<br />
<br />
I modified the script so the same string is written with line terminator three times into the Settings.ini, which seems to provoke this bug more often. See the attached script and output files (I compiled the script with NSIS Unicode 2.46 and launched the exe on Windows 7 and XP). I hope this help to track the error. Thanks for taking a look into this issue :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">gringoloco023</div><div class="date">3rd September 2010, 12:45</div></div><div class="posttext">Hmm... I see what you mean now.<br />
<br />
So long for my testing :(<br />
<br />
I first have to finish the project I'm working on these days, then by the weekend I will have time to look at this issue.<br />
<br />
thanx for reporting it</div></div><hr />


<div class="post"><div class="posttop"><div class="username">gringoloco023</div><div class="date">4th September 2010, 21:55</div></div><div class="posttext">I was not allocating any space to fit the terminating null-byte before ReadFile(), so the string ended in any kind of random characters.<br />
<br />
Not sure how I could have missed that before :confused:<br />
<br />
Anyway, give it ago (the script you send me is working fine for me)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">koelzk</div><div class="date">5th September 2010, 20:44</div></div><div class="posttext">Cool, thanks alot! Now the installer of my plotter app can write a user selected path into the settings file even when it's Chinese. You really helped me out :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Legace</div><div class="date">30th September 2010, 14:13</div></div><div class="posttext">Thanks a lot gringoloco023!</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>