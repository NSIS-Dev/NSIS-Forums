<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Need help with callbacks, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Need help with callbacks NSIS Discussion" />
	
	<title> Need help with callbacks [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Need help with callbacks</div>
<hr />
<div class="pda"><a href="t-292028.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=292028">Need help with callbacks</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">xplct0</div><div class="date">20th May 2008, 01:15</div></div><div class="posttext">I'm trying to make use of CopyFileEx.  Here's the MSDN ref: http://msdn.microsoft.com/en-us/library/aa363852.aspx<br />
<br />
I can't figure out why none of my callback's params are being properly filled out.  I'm also not sure if I'm setting this up correctly in the first place -- I'm slightly confused by the documentation.  The only parameter that seems to get filled out with anything cogent is: dwStreamNumber, which is set to 1, and according to MSDN, it's &quot;A handle to the current stream. The first time CopyProgressRoutine is called, the stream number is 1.&quot;  Great.  But every thing else seems to be NULL, even though the file does get copied over properly. (the file is &gt; 0 bytes)  If anyone can help that'd be great.  Thanks!<br />
<br />
Code<br />
<br />
    #(0) __in      LARGE_INTEGER TotalFileSize,<br />
    #(1) __in      LARGE_INTEGER TotalBytesTransferred,<br />
    #(2) __in      LARGE_INTEGER StreamSize,<br />
    #(3) __in      LARGE_INTEGER StreamBytesTransferred,<br />
    #(4) __in      DWORD dwStreamNumber,<br />
    #(5) __in      DWORD dwCallbackReason,<br />
    #(6) __in      HANDLE hSourceFile,<br />
    #(7) __in      HANDLE hDestinationFile,<br />
    #(8) __in_opt  LPVOID lpData<br />
    System::Get &quot;(i .r0, i .r1, i .r2, i .r3, i .r4, i .r5, i .r6, i .r7, i .r8) isR0&quot;<br />
    System::Call 'kernel32::CopyFileEx(t &quot;C:/from/test.txt&quot;, t &quot;c:/to/test.txt&quot;, k r0, i 0, i 0, i 1) i .r3'<br />
    <br />
    loop:<br />
        StrCmp $R0 &quot;callback1&quot; 0 done<br />
    Goto loop       <br />
    done:<br />
    <br />
    MessageBox MB_OK $0<br />
    MessageBox MB_OK $1<br />
    MessageBox MB_OK $2<br />
    MessageBox MB_OK $3<br />
    MessageBox MB_OK $4<br />
    MessageBox MB_OK $5<br />
    MessageBox MB_OK $6<br />
    MessageBox MB_OK $7<br />
    MessageBox MB_OK $8</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">20th May 2008, 02:42</div></div><div class="posttext">your stuff is all messed up, you need to use L for 64 bit numbers etc...<br />
<br />
this seems to work tho:<br />
<br />
SetPluginUnload alwaysoff<br />
System::Get &quot;(l.R0,l,l.R1,l,i.R2,i.R3,i,i,i)isr1&quot;<br />
pop $0<br />
System::Call 'kernel32::CopyFileEx(t &quot;$temp\Temp.exe&quot;, t &quot;$temp\dest.txt&quot;,k r0,i,i,i)i.r9'<br />
loop:<br />
	StrCmp $1 &quot;callback1&quot; 0 done<br />
	DetailPrint &quot;cb: totsize=$R0|strmsize=$R1|strmid=$R2|cbreason=$R3&quot;<br />
	Push 0 # return value of the callback<br />
	StrCpy $1 &quot;&quot; # clear $R0 in case there are no more callback calls<br />
	System::Call $0 # tell system to return from the callback<br />
	Goto loop<br />
done:<br />
SetPluginUnload manual<br />
DetailPrint CopyFileEx($0)ret=$9<br />
System::Free $0<br />
<br />
<br />
nsis already supports file copy, not sure why you are doing this</div></div><hr />


<div class="post"><div class="posttop"><div class="username">xplct0</div><div class="date">20th May 2008, 04:00</div></div><div class="posttext">AGGGHHH FINALLY!  I got it working!!  Thanks for the cb help, Anders.<br />
<br />
So everyone kept saying it wasn't possible to display billboards based on %copy complete, which is just silly if you have access to the win32.  I know this is sloppy, but I just got it working:<br />
<br />
<br />
!include 'MUI.nsh'<br />
!include 'Image.nsh'<br />
<br />
!define AppName `Sand`<br />
Name '${AppName}'<br />
OutFile 'Sandbox.exe'<br />
InstallDir '$PROGRAMFILES\${AppName}'<br />
<br />
!insertmacro MUI_PAGE_WELCOME<br />
!insertmacro MUI_PAGE_DIRECTORY<br />
!insertmacro MUI_PAGE_INSTFILES<br />
!insertmacro MUI_PAGE_FINISH<br />
!insertmacro MUI_LANGUAGE &quot;English&quot;<br />
<br />
#Dumpstate::debug<br />
# Fix the rukus vista has been causing with shortcut removals.<br />
RequestExecutionLevel admin<br />
<br />
Section 'CD_ONE'<br />
    <br />
    strcpy $9 'ladeda'<br />
    SetPluginUnload alwaysoff<br />
    System::Get &quot;(l,l.R1,l,l,i,i,i,i,i)isr1&quot;<br />
    pop $0<br />
    System::Call 'kernel32::CopyFileEx(t &quot;c:\from\test.txt&quot;, t &quot;c:\to\test.txt&quot;,k r0,i,i,i)i.r9'<br />
    <br />
    loop:<br />
        StrCmp $1 &quot;callback1&quot; 0 done<br />
    <br />
        IntCmp $R1 40000000 0 lessthan40mb morethan40mb<br />
        lessthan40mb:<br />
          strcmp $9 '0' doneCmp +1<br />
          !insertmacro DisplayImage 'c:\Bilboard0.bmp'<br />
          strcpy $9 '0'<br />
          Goto doneCmp<br />
          <br />
        morethan40mb:<br />
          strcmp $9 '1' doneCmp +1<br />
          !insertmacro DisplayImage 'c:\Bilboard1.bmp'<br />
          strcpy $9 '1'<br />
          Goto doneCmp<br />
        doneCmp:<br />
        <br />
        Push 0 # return value of the callback<br />
        StrCpy $1 &quot;&quot; # clear $R0 in case there are no more callback calls<br />
        System::Call $0 # tell system to return from the callback<br />
        <br />
        Goto loop<br />
    done:<br />
    SetPluginUnload manual<br />
    System::Free $0<br />
 <br />
SectionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">20th May 2008, 11:47</div></div><div class="posttext">That could be tidied up quite nicely using some LogicLib.<br />
<br />
Stu</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>