<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" MoveFileOnReboot, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  MoveFileOnReboot NSIS Discussion" />
	
	<title> MoveFileOnReboot [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  MoveFileOnReboot</div>
<hr />
<div class="pda"><a href="t-58579.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=58579">MoveFileOnReboot</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">alexis</div><div class="date">29th August 2001, 12:44</div></div><div class="posttext">Hi !<br />
<br />
  I modified the MoveFileOnReboot so that it works on win2k (comspec is cmd, not command), and for users who don't have admin privilege (cannot access HKLM/soft/windows/currentversion/runonce)...<br />
Here's the source code :<br />
<br />
BOOL MoveFileOnReboot(LPCTSTR pszExisting, LPCTSTR pszNew)<br />
{<br />
  BOOL fOk = 0;<br />
  fOk = MoveFileEx(pszExisting, pszNew, MOVEFILE_DELAY_UNTIL_REBOOT|MOVEFILE_REPLACE_EXISTING);<br />
  if (!fOk) <br />
  {<br />
	  char *buf = (char*)GlobalAlloc(GMEM_FIXED,2048);<br />
	  char *command = (char*)GlobalAlloc(GMEM_FIXED,2048);<br />
	  HKEY runOnceKey;<br />
	  LONG ret;<br />
	  <br />
	  ret = GetEnvironmentVariable(&quot;ComSpec&quot;, command, 2048);<br />
	  if(!ret) <br />
		  return fOk;<br />
	  <br />
	  if (ret=RegOpenKeyEx(<br />
		  HKEY_LOCAL_MACHINE,<br />
		  &quot;Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce&quot;,<br />
		  0,<br />
		  KEY_SET_VALUE,<br />
		  &amp;runOnceKey ) != ERROR_SUCCESS)<br />
		  <br />
	  {<br />
		  // couldn't open HKLM (no admin privilege). Let's try with HKCU --&gt; will need to log in again with the same ID<br />
		  if(ret=RegOpenKeyEx(<br />
			  HKEY_CURRENT_USER,<br />
			  &quot;Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce&quot;,<br />
			  0,<br />
			  KEY_SET_VALUE,<br />
			  &amp;runOnceKey ) != ERROR_SUCCESS)<br />
			  <br />
		  {<br />
			  GlobalFree(buf);<br />
			  GlobalFree(command);<br />
			  return fOk;<br />
		  }<br />
	  }<br />
	  <br />
	  if (pszNew)<br />
	  {<br />
		  lstrcpy(buf, command);<br />
		  lstrcat(buf, &quot; /q /c move /y \&quot;&quot;);<br />
		  lstrcat(buf, pszExisting);<br />
		  lstrcat(buf, &quot;\&quot; \&quot;&quot;);<br />
		  lstrcat(buf, pszNew);<br />
		  lstrcat(buf, &quot;\&quot;&quot;);<br />
	  }<br />
	  else {<br />
		  lstrcpy(buf, command);<br />
		  lstrcat(buf, &quot; /q /c del /f /q \&quot;&quot;);<br />
		  lstrcat(buf, pszExisting);<br />
		  lstrcat(buf, &quot;\&quot;&quot;);<br />
	  }<br />
	  <br />
	  if (RegSetValueEx(runOnceKey,pszExisting,0,<br />
		  REG_SZ, buf, lstrlen(buf) + 1 ) == ERROR_SUCCESS) <br />
		  fOk++;<br />
	  else <br />
	  {<br />
		  LPVOID lpMsgBuf;<br />
		  FormatMessage(FORMAT_MESSAGE_FROM_SYSTEM | FORMAT_MESSAGE_ALLOCATE_BUFFER | FORMAT_MESSAGE_IGNORE_INSERTS,<br />
			  NULL, GetLastError(), <br />
			  MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT), <br />
			  (LPTSTR) &amp;lpMsgBuf,<br />
			  0,<br />
			  NULL <br />
			  );<br />
		  MessageBox( g_hwnd, (LPCTSTR)lpMsgBuf, &quot;Error&quot;, MB_OK | MB_ICONINFORMATION );<br />
		  // Free the buffer.<br />
		  LocalFree( lpMsgBuf );<br />
	  }<br />
	  <br />
	  RegCloseKey(runOnceKey);<br />
	  GlobalFree(buf);<br />
	  GlobalFree(command);<br />
  }<br />
  return fOk;<br />
}<br />
<br />
I'm not a programmer, so please no flame :)<br />
<br />
Alexis</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DuaneJeffers</div><div class="date">30th August 2001, 00:44</div></div><div class="posttext">Good Job, I wouldn't have figured that out, AND YOU ARE NOT A PROGRAMMER!!!!!!!!!! Holy Crap.<br />
<br />
I Now Place upon you the title of Elite.<br />
<br />
-DJ</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>