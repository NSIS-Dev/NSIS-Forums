<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Problem with System::Call, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Problem with System::Call NSIS Discussion" />
	
	<title> Problem with System::Call [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Problem with System::Call</div>
<hr />
<div class="pda"><a href="t-258399.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=258399">Problem with System::Call</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">smoura</div><div class="date">27th October 2006, 14:36</div></div><div class="posttext">Hi all... <br />
<br />
I'm having a problem with System::Call that in some machines works ok but in other computer's it fails the call returning 'error'. Is there some kind of requisite for using this function?<br />
<br />
The code looks like this:<br />
<br />
<br />
Function wndSerial_ValidateCustom<br />
	<br />
	; Serial number reading<br />
	ReadINIStr $R1 &quot;$PLUGINSDIR\wndSerial.ini&quot; &quot;Field 2&quot; &quot;State&quot;<br />
	ReadINIStr $R2 &quot;$PLUGINSDIR\wndSerial.ini&quot; &quot;Field 3&quot; &quot;State&quot;<br />
	ReadINIStr $R3 &quot;$PLUGINSDIR\wndSerial.ini&quot; &quot;Field 4&quot; &quot;State&quot;<br />
	ReadINIStr $R4 &quot;$PLUGINSDIR\wndSerial.ini&quot; &quot;Field 5&quot; &quot;State&quot;<br />
<br />
	; Call the function to validate the serial number<br />
	SetPluginUnload alwaysoff<br />
	System::Call &quot;$PLUGINSDIR\ValidateSN::ValidateSN(t r11, t r12,t r13,t r14)i .r1&quot;<br />
	MessageBox MB_OK &quot;$1&quot;<br />
	IntCmp $1 1 serial_ok serial_wrong<br />
serial_wrong:<br />
	System::Free $1<br />
	MessageBox MB_OK|MB_ICONEXCLAMATION $(WNDSERIAL_INVALIDSN)<br />
	Abort<br />
serial_ok:<br />
	; Continue installation<br />
	System::Free $1<br />
	SetPluginUnload manual<br />
	<br />
FunctionEnd<br />
<br />
<br />
Now I've tested this on a cleaned machine installed with the first version of Windows XP and though I set a correct serial number there is no validation (the value in $1 is always 'error'), then I gradually updated it, when finally installed Service Pack 2 the serial validation occured correctly.<br />
<br />
Does the System::Call function need the Service Pack 2 installation (does it use some funcion that was only available through the SP2)? or am I missing something in my code.<br />
<br />
If there's the need to install SP2 could there be another way of calling an external DLL function?<br />
<br />
Thanks for your time, best regards,<br />
Samuel Moura</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">27th October 2006, 14:39</div></div><div class="posttext">System::Call doesn't need SP2, but your validation DLL might. Check out its dependencies using Dependency Walker (http://www.dependencywalker.com/). Ideally, you should compile your DLL with static linking, so it won't depend on anything like msvcr71.dll or any other DLLs.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">smoura</div><div class="date">27th October 2006, 14:45</div></div><div class="posttext">Originally posted by kichik <br />
System::Call doesn't need SP2, but your validation DLL might. Check out its dependencies using Dependency Walker (http://www.dependencywalker.com/). Ideally, you should compile your DLL with static linking, so it won't depend on anything like msvcr71.dll or any other DLLs.  <br />
<br />
Thanks for the fast reply! Dumb meee... but of course this is the problem!<br />
<br />
Thanks very much! :o</div></div><hr />


<div class="post"><div class="posttop"><div class="username">smoura</div><div class="date">27th October 2006, 16:27</div></div><div class="posttext">Hum... I've been cleaning my dll though I cant seem to put it to work in a computer without SP2! :confused: <br />
<br />
I've used the Dependency walker to check the dependencies and my dll only depends on Kernel32 + NTdll (consequently).<br />
<br />
The only functions I use beside the standard string functions are malloc, free and memset wich were already available before SP2.<br />
<br />
Any help would be kindly appreciated!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">27th October 2006, 16:29</div></div><div class="posttext">Are malloc, free and memset statically linked or dynamically linked to msvcr71.dll?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">smoura</div><div class="date">27th October 2006, 16:34</div></div><div class="posttext">Originally posted by kichik <br />
Are malloc, free and memset statically linked or dynamically linked to msvcr71.dll?  <br />
<br />
How can I check this?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">27th October 2006, 16:41</div></div><div class="posttext">Well, if you said you only see kernel32.dll in Dependency Walker, it's probably statically linked or else you'd have seen msvcr71.dll. Can you attach the DLL?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">smoura</div><div class="date">27th October 2006, 16:46</div></div><div class="posttext">Originally posted by kichik <br />
Well, if you said you only see kernel32.dll in Dependency Walker, it's probably statically linked or else you'd have seen msvcr71.dll. Can you attach the DLL? <br />
<br />
Sure here it goes. I just use the include directive on c++, I supose that it gets static linked through the corresponding .lib file.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">27th October 2006, 16:57</div></div><div class="posttext">I can't see any used import that shouldn't exist on all versions of Windows XP. However, there are many imports that aren't available in Windows 9x. Namely, all of the Unicode enabled functions like LCMapStringW and GetEnvironmentStringsW.<br />
<br />
Back to the point, run depends.exe on the file on Windows XP SP 0. It should paint imports it can't find in red.<br />
<br />
Also, which System.dll are you using? You didn't recompile NSIS, right?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">smoura</div><div class="date">27th October 2006, 17:01</div></div><div class="posttext">Originally posted by kichik <br />
I can't see any used import that shouldn't exist on all versions of Windows XP. However, there are many imports that aren't available in Windows 9x. Namely, all of the Unicode enabled functions like LCMapStringW and GetEnvironmentStringsW.<br />
<br />
Back to the point, run depends.exe on the file on Windows XP SP 0. It should paint imports it can't find in red.<br />
<br />
Also, which System.dll are you using? You didn't recompile NSIS, right? <br />
<br />
I'm going to try the depends.exe on the other PC.<br />
<br />
I'm using the one that comes with NSIS 2.21, installed it today, and no recompilation :D!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">smoura</div><div class="date">27th October 2006, 17:06</div></div><div class="posttext">:P meanwhile solved the problem<br />
<br />
it seems that in systems prior to SP2 there's a need to specify the output directory to the plugins directory before using the plugin!<br />
<br />
<br />
	SetOutPath &quot;$PLUGINSDIR&quot;<br />
	System::Call &quot;ValidateSN.dll::ValidateSN(t r11, t r12,t r13,t r14)i .r1&quot;<br />
<br />
<br />
Added the first line of this snippet and changed the second one! It now works!<br />
<br />
Thanks very much for your time! ;)</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>