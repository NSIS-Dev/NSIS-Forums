<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Safe way to close Windows Explorer? (Need to Safely Remove Hardware), media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Safe way to close Windows Explorer? (Need to Safely Remove Hardware) NSIS Discussion" />
	
	<title> Safe way to close Windows Explorer? (Need to Safely Remove Hardware) [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Safe way to close Windows Explorer? (Need to Safely Remove Hardware)</div>
<hr />
<div class="pda"><a href="t-317414.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=317414">Safe way to close Windows Explorer? (Need to Safely Remove Hardware)</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">thivnor</div><div class="date">1st March 2010, 21:47</div></div><div class="posttext">I have an application which runs from a USB drive. I guess it would be considered a Portable App.<br />
<br />
I want to  &quot;Safely Remove&quot; the USB drive when the application is closed. However, since the program is launched from Windows Explorer, the  &quot;Safely Remove&quot; action always fails, because Windows Explorer is open and looking at the folder from which the software was launched. <br />
<br />
A smart user could close Windows Explorer after launching my program. But my users aren't that smart. I want this happen automatically. <br />
<br />
My root objective is simply to &quot;Safely Remove&quot;the USB drive. It seem like I need to either close Windows Explorer, or get it to &quot;look&quot; at a different folder.<br />
<br />
I'm tried closing Windows Explorer, using things like KillProcDLL::KillProc and SendMessage ... ${WM_CLOSE}. Those actions are really drastic however, and either leave Windows Explorer is some half-dead state, or worse. At one point Windows was asking if I wanted to shut down! Ok I'm over my head here :) <br />
<br />
Is there a safe way to close Windows Explorer? <br />
<br />
Or to have it &quot;look elsewhere&quot; so I can eject the USB drive?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">1st March 2010, 21:56</div></div><div class="posttext">create a windows scripting host script (This can also be done with COM called by the system plugin, but that is more code than I want to type in this little box)<br />
<br />
JScript:<br />
<br />
var ShA=new ActiveXObject(&quot;Shell.Application&quot;);<br />
var sw=ShA.Windows();//list of explorer windows<br />
for(var i=0;i&lt;sw.Count; ++i) WScript.Echo(sw.Item(i).LocationURL); //sw.Item(i).HWND for handle, sw.Item(i).Refresh(), sw.Item(i).Quit() etc<br />
<br />
<br />
See http://msdn.microsoft.com/en-us/library/bb773974(VS.85).aspx for more</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">2nd March 2010, 06:22</div></div><div class="posttext">Safe removal shouldn't fail just because you have an explorer window open... I think your problem lies elsewhere.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Wizou</div><div class="date">2nd March 2010, 10:26</div></div><div class="posttext">take a look at the SHChangeNotify shell function, it has several &quot;removal&quot; options which Explorer handles by closing the adequate windows if any were open on the given drive</div></div><hr />


<div class="post"><div class="posttop"><div class="username">jpderuiter</div><div class="date">2nd March 2010, 15:47</div></div><div class="posttext">Well, I guess the safe removal isn't possible because your installer is still running from that USB drive...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Wizou</div><div class="date">2nd March 2010, 16:08</div></div><div class="posttext">@jpderuiter: good point!<br />
A workaround could be to extract &amp; run a small program in %TEMP% just before exiting the installer (make sure the working directory is also %TEMP%) and have it close Explorer windows (with SHChangeNotify) and remove the USB device.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">thivnor</div><div class="date">2nd March 2010, 17:15</div></div><div class="posttext">Sorry I should have provided a bit more detail. <br />
<br />
To eject the drive, I use a &quot;RemoveDrive.exe&quot; utility, from http://www.uwe-sieber.de/drivetools_e.html. This utility is pretty smart. It places a copy of itself in the temp folder and then runs the copy in temp. <br />
<br />
Also, I'm pretty confident the problem really is Windows Explorer. It seems odd that Windows Explorer would &quot;lock&quot; the drive ... just my &quot;looking&quot; at the drive. But that is what my testing has revealed.<br />
<br />
I'm going to look into SHChangeNotify and see how to use it &amp; if it works. I will have my .exe run from %TEMP%.<br />
<br />
<br />
THANK YOU for all the suggestions!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">{_trueparuex^}</div><div class="date">3rd March 2010, 10:11</div></div><div class="posttext">Originally posted by MSG <br />
Safe removal shouldn't fail just because you have an explorer window open... I think your problem lies elsewhere.  True in Windows XP and 2000, but in Vista and probably in Windows 7, open explorer windows on the drive will block the safe removal.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">thivnor</div><div class="date">3rd March 2010, 15:51</div></div><div class="posttext">Yeah ... the removable behavior has changed in Vista. I just re-tested this, to ensure I'm not crazy. I did my testing with my software closed ... I was just testing various USB ejection techniques and tools, with a single Windows Explorer window &quot;looking&quot; at the USB drive. So I'm very confident that this isn't related to a program still running on the USB drive. It is something new in Vista.<br />
<br />
I looked into SHChangeNotify  but don't have the skills to put together a solution. I code a lot of languages but C++ isn't one of them, and I'm really not up on the Windows API. That's why I use NSIS anytime I need something Windowsy to happen ;)<br />
<br />
I tested different USB ejection tools and found that EjectUSB com will close Windows Explorer. (&quot;EjectUSB â€“ Safe USB Ejection Tool&quot; from pendriveapps dot com). It is smart about only closing the affected Windows Explorer instances.<br />
<br />
It isn't as fast as the RemoveDrive tool which I had been using. (Part of &quot;Drive Tools for Windows&quot; from uwe-sieber dot de).  But it works, and it provides a return code so I can report success or failure to the user. <br />
<br />
I will probably end up embedding EjectUSB instead of RemoveDrive.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>