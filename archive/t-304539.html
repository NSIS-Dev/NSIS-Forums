<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" How to add to DEP opt-out list programmatically., media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  How to add to DEP opt-out list programmatically. NSIS Discussion" />
	
	<title> How to add to DEP opt-out list programmatically. [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  How to add to DEP opt-out list programmatically.</div>
<hr />
<div class="pda"><a href="t-304539.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=304539">How to add to DEP opt-out list programmatically.</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">touchring</div><div class="date">24th March 2009, 06:50</div></div><div class="posttext">Does anyone knows how to add to DEP exclusion list programmatically other than via the sysdm.cpl or control panel? <br />
<br />
Like many, I've been using asprotect and aspack for my program and recently i discovered that windows vista ultimate and windows 2008 server no longer exempt asprotect packed apps from DEP.  Asprotect packed apps crash when DEP is activated, which is almost every windows ultimate and windows 2008 server system since all programs have DEP activated by default, unlike XP.<br />
<br />
I've done some research and many articles point to adding a registry key like the following but it does not work (in that the application still crashes when run) although you can actually see the entry in the DEP list if you run sysdm.cpl.<br />
<br />
[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Layers]<br />
&quot;C:\\path\\myapplication.exe&quot;=&quot;EnableNXShowUI&quot;<br />
<br />
If i add it manually via the sysdm.cpl GUI, my application does not crash any more.  I've tried using processexplorer to see where else Windows would write to the registry but no clue.  The topics about editing boot.ini is no help either as it will entirely deactivate DEP, which is not what i want to do.<br />
<br />
Someone suggested broadcasting WM_SETTINGCHANGE, so i tried the following after adding the EXE path to AppCompatFlags but no luck also.<br />
<br />
SendMessage ${HWND_BROADCAST} ${WM_SETTINGCHANGE} 0 &quot;STR:Environment&quot; /TIMEOUT=0<br />
<br />
Hope any of you out there with some clues may help.  :|</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">24th March 2009, 11:10</div></div><div class="posttext">I don't know if WM_SETTINGSCHANGE can help, but I know that the STR:Environment part is wrong. You could try AppCompatFlags, but for most stuff like that, you should use the full registry &quot;path&quot;.<br />
<br />
But, I'm hoping that this is by design and that only the user can add items to the DEP list. You should contact the Asprotect people and get them to give you a version that works with DEP on (Remember, DEP has a mode where it does not use that list, but forces DEP on everything)<br />
<br />
Or maybe you could switch to UPX<br />
<br />
edit:<br />
try setting __COMPAT_LAYER=EnableNXShowUI as a environment variable in your installer before starting your program (not system wide, just for your installer, that should allow you to start it from the installer) See http://www.microsoft.com/windowsxp/using/setup/expert/layertip.mspx</div></div><hr />


<div class="post"><div class="posttop"><div class="username">touchring</div><div class="date">24th March 2009, 14:39</div></div><div class="posttext">You should contact the Asprotect people and get them to give you a version that works with DEP on (Remember, DEP has a mode where it does not use that list, but forces DEP on everything)<br />
 <br />
<br />
ASProtect support has practically stopped ever since starforce bought over the company.  Their latest version demo would not even work on my XP.<br />
<br />
edit:<br />
try setting __COMPAT_LAYER=EnableNXShowUI as a environment variable in your installer before starting your program (not system wide, just for your installer, that should allow you to start it from the installer) See http://www.microsoft.com/windowsxp/using/setup/expert/layertip.mspx [/B] <br />
<br />
Thanks for mentioning this option, but that won't work as the application is actually the application that NSIS installer is suppose to install.  :eek:</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">24th March 2009, 15:14</div></div><div class="posttext">I don't know why it does not work for you...it works fine for me when testing the XP stuff<br />
<br />
<br />
CopyFiles &quot;$sysdir\calc.exe&quot; $temp<br />
System::Call 'kernel32::GetLongPathName(t &quot;$temp\calc.exe&quot;, t .r1, i ${NSIS_MAX_STRLEN})i'<br />
WriteRegStr HKLM &quot;Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Layers&quot; $1 &quot;WIN95 DISABLETHEMES&quot;<br />
Exec '&quot;$temp\calc.exe&quot;'<br />
<br />
Note that I had to call GetLongPathName to get the correct path. You should make sure you are using the correct full path<br />
<br />
edit:<br />
and just doing<br />
<br />
CopyFiles &quot;$sysdir\calc.exe&quot; $temp<br />
System::Call 'Kernel32::SetEnvironmentVariableA(t, t) i(&quot;__COMPAT_LAYER&quot;, &quot;DISABLETHEMES&quot;).r0'<br />
Exec '&quot;$temp\calc.exe&quot;'<br />
<br />
also works, but thats a one time thing only when started from your installer</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DrO</div><div class="date">25th March 2009, 00:24</div></div><div class="posttext">not knowing further details of what's going on, etc but it's possible to disable a process from DEP as shown here (http://blogs.msdn.com/michael_howard/archive/2008/01/29/new-nx-apis-added-to-windows-vista-sp1-windows-xp-sp3-and-windows-server-2008.aspx) though that is mainly aimed at coders but it may be off some help (or more likely not but mentioning it whilst i remember).<br />
<br />
-daz</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">25th March 2009, 13:50</div></div><div class="posttext">ah, yes, I had forgotten about those API's (it also exists on XP SP2, but with a different name, and it's undocumented, IIRC google chrome uses it, check its source)<br />
<br />
But these API's have the same problem as setting the registry option, if DEP is always on, they have no effect.<br />
<br />
So why can you not switch to a different packer? UPX?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">DrO</div><div class="date">25th March 2009, 14:18</div></div><div class="posttext">wasn't sure if it'd work if it's been forced on. but yeah would make more sense to switch to a different packer (if that really is something that is needed to be done).<br />
<br />
-daz</div></div><hr />


<div class="post"><div class="posttop"><div class="username">touchring</div><div class="date">25th March 2009, 20:53</div></div><div class="posttext">Thanks for your suggestions, the registry method doesn't work, even when using full path.  There must be an additional step.<br />
<br />
Switching to a different packer will be the last resort as my whole registration system, which includes an online component, is built on asprotect.<br />
<br />
Someone gave me a link - blogs.msdn.com/gauravb/archive/2008/09/23/disable-dep-on-applications.aspx<br />
<br />
But i'm not sure how i can use it since asprotect runs before my application does.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>