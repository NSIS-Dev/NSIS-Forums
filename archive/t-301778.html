<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" macro within a macro, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  macro within a macro NSIS Discussion" />
	
	<title> macro within a macro [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  macro within a macro</div>
<hr />
<div class="pda"><a href="t-301778.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=301778">macro within a macro</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">mstone42</div><div class="date">6th January 2009, 21:46</div></div><div class="posttext">I've seen (and am using) the code to define a single function and use it for both installer and uninstaller.  <br />
<br />
I've run into a problem where I'm using a third-party macro within my function and the builder is complaining that I need to have &quot;un.&quot; before uninstall functions and not in front of install functions.  How do I get around this without writing two functions?<br />
<br />
<br />
!macro myfunc un<br />
Function ${un}myfunc<br />
  Call ${un}someotherfunc  ; this works<br />
  ${ThirdPartyMacro} $arg1 $arg2 ; this fails<br />
  DetailPrint &quot;something: $arg1&quot;<br />
FunctionEnd<br />
!macroend<br />
 <br />
!insertmacro myfunc &quot;&quot;<br />
!insertmacro myfunc &quot;un.&quot;<br />
<br />
<br />
I've tried ${un}${ThirdPartyMacro}, ${${un}ThirdPartyMacro} and ${un.ThirdPartyMacro}, and none of them work.  The weird thing is that &quot;un.ThirdPartyMacro&quot; is actually defined in the third party nsh file.<br />
<br />
Thanks!<br />
Mitch</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">6th January 2009, 22:40</div></div><div class="posttext">it would you know, help if you said the name of the macro, but, the nsh probably has so way to define the uninstall macro</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mstone42</div><div class="date">7th January 2009, 18:01</div></div><div class="posttext">In one case it's a function from the StrFunc.nsh.  Using ${StrRep} in the install function, and ${UnStrRep} in the separate uninstall function works, but that's the only difference in an otherwise lengthy function, which I would like to maintain only one copy of.<br />
<br />
In the second case, I turned the code from here: http://nsis.sourceforge.net/REG_MULTI_SZ_Reader, into a nsh file, and defined 2 macros, ReadRegMulti &amp; un.ReadRegMulti.  I'm certainly willing to entertain the notion that I didn't set it up correctly, given my lack of understanding of the NSIS scripting language, so any help in configuring it correctly would be swell!<br />
<br />
<br />
; with respect to KiCHiK<br />
<br />
!ifndef ReadRegMulti<br />
!define ReadRegMulti &quot;!insertmacro ReadRegMulti&quot;<br />
<br />
!define HKEY_CLASSES_ROOT        0x80000000<br />
!define HKEY_CURRENT_USER        0x80000001<br />
!define HKEY_LOCAL_MACHINE       0x80000002<br />
!define HKEY_USERS               0x80000003<br />
!define HKEY_PERFORMANCE_DATA    0x80000004<br />
!define HKEY_PERFORMANCE_TEXT    0x80000050<br />
!define HKEY_PERFORMANCE_NLSTEXT 0x80000060<br />
!define HKEY_CURRENT_CONFIG      0x80000005<br />
!define HKEY_DYN_DATA            0x80000006<br />
 <br />
!define KEY_QUERY_VALUE          0x0001<br />
!define KEY_ENUMERATE_SUB_KEYS   0x0008<br />
 <br />
!define REG_NONE                 0<br />
!define REG_SZ                   1<br />
!define REG_EXPAND_SZ            2<br />
!define REG_BINARY               3<br />
!define REG_DWORD                4<br />
!define REG_DWORD_LITTLE_ENDIAN  4<br />
!define REG_DWORD_BIG_ENDIAN     5<br />
!define REG_LINK                 6<br />
!define REG_MULTI_SZ             7<br />
 <br />
!define RegOpenKeyEx     &quot;Advapi32::RegOpenKeyExA(i, t, i, i, *i) i&quot;<br />
!define RegQueryValueEx  &quot;Advapi32::RegQueryValueExA(i, t, i, *i, i, *i) i&quot;<br />
!define RegCloseKey      &quot;Advapi32::RegCloseKeyA(i) i&quot;<br />
<br />
<br />
!macro ReadRegMulti ResultVar HKEY KeyName Key<br />
  Push `${HKEY}`<br />
  Push `${KeyName}`<br />
  Push `${Key}`<br />
  Call ReadRegMulti<br />
  Pop `${ResultVar}`<br />
!macroend<br />
<br />
!macro un.ReadRegMulti ResultVar HKEY KeyName Key<br />
  Push `${HKEY}`<br />
  Push `${KeyName}`<br />
  Push `${Key}`<br />
  Call ReadRegMulti<br />
  Pop `${ResultVar}`<br />
!macroend<br />
<br />
<br />
Function ReadRegMulti<br />
<br />
  ;Get input from user<br />
  Pop $R3    # &quot;Strings&quot;<br />
  Pop $R2    # &quot;Software\Joe Software&quot;<br />
  Pop $R1    # ${HKEY_CURRENT_USER}<br />
<br />
  StrCpy $0 &quot;&quot;<br />
  StrCpy $1 &quot;&quot;<br />
  StrCpy $2 &quot;&quot;<br />
  StrCpy $3 &quot;&quot;<br />
  StrCpy $9 &quot;&quot;<br />
    <br />
    SetPluginUnload alwaysoff<br />
    System::Call &quot;${RegOpenKeyEx}($R1, '$R2', 0, ${KEY_QUERY_VALUE}|${KEY_ENUMERATE_SUB_KEYS}, .r0) .r3&quot;<br />
   <br />
    StrCmp $3 0 goon<br />
      StrCpy $9 &quot;Can't open registry key! ($3)&quot;<br />
      Goto done<br />
  goon:<br />
   <br />
    System::Call &quot;${RegQueryValueEx}(r0, '$R3', 0, .r1, 0, .r2) .r3&quot;<br />
   <br />
    StrCmp $3 0 read<br />
      StrCpy $9 &quot;Can't query registry value size! ($3)&quot;<br />
      Goto done<br />
   <br />
  read:<br />
   <br />
    StrCmp $1 ${REG_MULTI_SZ} multisz<br />
      StrCpy $9 &quot;Registry value no REG_MULTI_SZ! ($3)&quot;<br />
      Goto done<br />
   <br />
  multisz:<br />
   <br />
    StrCmp $2 0 0 multiszalloc<br />
      StrCpy $9 &quot;Registry value empty! ($3)&quot;<br />
      Goto done<br />
   <br />
  multiszalloc:<br />
   <br />
    System::Alloc $2<br />
    Pop $1<br />
   <br />
    StrCmp $1 0 0 multiszget<br />
      StrCpy $9 &quot;Can't allocate enough memory! ($3)&quot;<br />
      Goto done<br />
   <br />
  multiszget:<br />
   <br />
    System::Call &quot;${RegQueryValueEx}(r0, '$R3', 0, n, r1, r2) .r3&quot;<br />
   <br />
    StrCmp $3 0 multiszprocess<br />
      StrCpy $9 &quot;Can't query registry value data! ($3)&quot;<br />
      Goto done<br />
   <br />
  multiszprocess:<br />
   <br />
    StrCpy $4 $1<br />
   <br />
    IntOp $6 $4 + $2<br />
    IntOp $6 $6 - 1<br />
   <br />
    #loop:<br />
   <br />
      System::Call &quot;*$4(&amp;t${NSIS_MAX_STRLEN} .r3)&quot;<br />
      #DetailPrint $3<br />
      Push $3<br />
      <br />
      #StrLen $5 $3<br />
      #IntOp $4 $4 + $5<br />
      #IntOp $4 $4 + 1<br />
      #IntCmp $4 $6 0 loop<br />
   <br />
  done:<br />
    DetailPrint $9<br />
   <br />
    System::Free $1<br />
   <br />
    StrCmp $0 0 noClose<br />
      System::Call &quot;${RegCloseKey}(r0)&quot;<br />
   <br />
  noClose:<br />
   <br />
  SetPluginUnload manual<br />
FunctionEnd<br />
<br />
!endif</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>