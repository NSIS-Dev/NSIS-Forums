<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Uninstall fails under Windows 7, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Uninstall fails under Windows 7 NSIS Discussion" />
	
	<title> Uninstall fails under Windows 7 [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Uninstall fails under Windows 7</div>
<hr />
<div class="pda"><a href="t-320457.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=320457">Uninstall fails under Windows 7</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">hürnen</div><div class="date">1st July 2010, 13:01</div></div><div class="posttext">Hi <br />
<br />
I created an installer which runs just fine. I installed the application as standard user under Windows 7 into the suggested installation directory C:\Users\testUser\AppData\Local\MyApp.<br />
Now I'd like to uninstall the application. The summary page shows the following:<br />
<br />
Delete file: C:\Users\testUser\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\MyApp\Uninstall MyApp.lnk<br />
Delete file: C:\Users\testUser\AppData\Local\MyApp\uninstall.exe<br />
Delete on reboot: C:\Users\testUser\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\MyApp<br />
Delete on reboot: C:\Users\testUser\AppData\Local\MyApp\<br />
Completed<br />
<br />
Basically, only the uninstall.exe and the short cut in the start menu referring to the uninstaller are removed. The whole application remains there - even after a reboot. <br />
However, all the files can be manually removed without any problem. <br />
<br />
Additional information:<br />
The execution level in the nsis-script is set to:<br />
!define MULTIUSER_EXECUTIONLEVEL Highest<br />
<br />
The same procedure works as expected under Windows Vista.<br />
<br />
Anybody knows what's going on here?<br />
<br />
Thanks<br />
Remo</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st July 2010, 13:28</div></div><div class="posttext">Where are your program files stored?<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">hürnen</div><div class="date">1st July 2010, 15:09</div></div><div class="posttext">I'm not sure whether I understand your question correctly, but the program files are stored under C:\Users\testUser\AppData\Local\MyApp, that's the default installation path NSIS suggests when the installer is executed as standard user.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st July 2010, 15:38</div></div><div class="posttext">Yes that's what I meant. How about doing some test on $INSTDIR. Try writing to it using FileOpen and see what happens. Either the path is wrong or you do not have write access.<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">hürnen</div><div class="date">1st July 2010, 16:12</div></div><div class="posttext">The installer does edit some files in $INSTDIR during installation, which works well. You mean I should try to edit files in the uninstaller? <br />
What's the execution level requested by the uninstaller? The same that I specified for the installer? Or can / should I also specify one for the uninstaller?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">1st July 2010, 20:33</div></div><div class="posttext">RequestExecutionLevel puts the manifest in both the installer and uninstaller. Yes, see if you can write to $INSTDIR in the uninstaller. Also check $INSTDIR is correct (i.e. MessageBox)<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">hürnen</div><div class="date">2nd July 2010, 07:30</div></div><div class="posttext">I added the following to section -un.post:<br />
<br />
FileOpen $0 $INSTDIR\file.dat w<br />
FileClose $0<br />
MessageBox MB_OK &quot;$INSTDIR\file.dat&quot;<br />
Delete $INSTDIR\file.dat<br />
<br />
As expected, the file is being written to C:\Users\testUser\AppData\Local\MyApp, the message box with C:\Users\testUser\AppData\Local\MyApp\file.dat is shown and the file is removed afterwards.<br />
<br />
I still have no clue why the other files cannot be removed by the uninstaller. According to the file properties (security tab), the current user has full rights on all of them.<br />
And again, the same installer/uninstaller runs perfectly well under Windows Vista.<br />
<br />
Thanks for further help<br />
Remo</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">2nd July 2010, 10:47</div></div><div class="posttext">Try a ClearErrors before a Delete instruction then check if the error flag is set afterwards. Also have you tried manually deleting the files?<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">hürnen</div><div class="date">2nd July 2010, 12:18</div></div><div class="posttext">Stu, as I mentioned in my first post, all the files can be deleted manually. But I tried your suggestion. The error flag is not set after trying to execute <br />
<br />
RmDir /REBOOTOK $INSTDIR<br />
<br />
Further ideas?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">2nd July 2010, 12:36</div></div><div class="posttext">Try with /r ?<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">hürnen</div><div class="date">2nd July 2010, 12:47</div></div><div class="posttext">Yep that's it! <br />
I created the NSIS script with an eclipse wizard. Strange that it didn't generate a /r. But also: why did it work with Vista?<br />
<br />
Anyway, thanks for your help!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">2nd July 2010, 13:59</div></div><div class="posttext">note: It is extremely dangerous to use RmDir /r. If your $INSTDIR happens to be, say, Program Files, you will do massive damage to the user's OS. You should not use RmDir /r. You should only delete the files you KNOW you want to delete.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">hürnen</div><div class="date">2nd July 2010, 15:10</div></div><div class="posttext">That's a good point. But you don't want to explicitly enumerate every single file in your installer/uninstaller, do you?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">2nd July 2010, 18:15</div></div><div class="posttext">No but you should really only delete exactly what you know you've installed and nothing else. I was only suggesting trying /r to fix your problem but as MSG says it is not a solution for uninstalling.<br />
<br />
You can do checks on $INSTDIR like this demonstrates (maybe a bit over the top though looking at it now):<br />
http://nsis.sourceforge.net/Validating_$INSTDIR_before_uninstall<br />
<br />
Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">2nd July 2010, 21:57</div></div><div class="posttext">That's a good point. But you don't want to explicitly enumerate every single file in your installer/uninstaller, do you?<br />
Actually I would say 'yes' to this. Even if there's hundreds of them, safety comes first in my opinion.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">3rd July 2010, 00:18</div></div><div class="posttext">That's a good point. But you don't want to explicitly enumerate every single file in your installer/uninstaller, do you?<br />
<br />
There -are- headers that help you with this...<br />
<br />
http://nsis.sourceforge.net/Uninstall_only_installed_files<br />
Uses custom file manipulation macros and records them as you go.<br />
( we use a similar but more flexible technique so that File /r and File with wildcards can still be used, which also keeps track of registry keys and such.. messy, though )<br />
<br />
http://nsis.sourceforge.net/Advanced_Uninstall_Log_NSIS_Header<br />
Uses file enumeration -before- installation and -after- installation, and records the difference.  This works with File /r and File with wildcards, but incurs either a small or a large hit depending on how long it takes to enumerate your target folder.<br />
( in our case, an add-on for a larger program which carries thousands of files and enumeration, if the OS didn't have anything cached yet, was simply too slow )<br />
<br />
I also started a new header for exactly this sort of thing, as well as handling backing up of existing files, etc.  But it's a right pain to write (it's been collecting dust as other priorities have taken over); although perhaps trying to do everything with defines to keep compiled code as clean as possible may be the wrong approach.  I still think a pre-file write and post-file write callback within NSIS would be great.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>