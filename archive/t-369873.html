<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" system plugin + GetPrivateProfileSectionNames crash, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  system plugin + GetPrivateProfileSectionNames crash NSIS Discussion" />
	
	<title> system plugin + GetPrivateProfileSectionNames crash [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  system plugin + GetPrivateProfileSectionNames crash</div>
<hr />
<div class="pda"><a href="t-369873.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=369873">system plugin + GetPrivateProfileSectionNames crash</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">shadowpoa</div><div class="date">28th August 2013, 21:34</div></div><div class="posttext">Hi Everyone,<br />
<br />
I'm using a sample script to read ini files, especially to read section names, to determine if a section exist before try to delete it.<br />
<br />
The problem is that the installer crashes randomically, I could check that the size of section is always right, but when the error shows, it is at below call:<br />
<br />
System::Call `kernel32::lstrlen(i $pNextSection)i.r5`<br />
<br />
$NOMESECTION is defined on another macro that calls this func, removing the callback gives the same error, so I choose put complete code here.<br />
<br />
I dont know much about pointers, but I think it is all ok with the calls.<br />
<br />
My function:<br />
<br />
<br />
!define GSN_BufferSize 1024<br />
<br />
VAR /GLOBAL lpszReturnBuffer<br />
VAR /GLOBAL fncAddr<br />
VAR /GLOBAL nSize<br />
VAR /GLOBAL pNextSection<br />
VAR /GLOBAL IniPath<br />
VAR /GLOBAL iniSecSize<br />
VAR /GLOBAL PTR_FNC<br />
<br />
!define GetSectionNames `!insertmacro GetSectionNamesCall`<br />
<br />
!macro GetSectionNamesCall _FILE _FUNC<br />
	StrCpy `$IniPath` `${_FILE}`<br />
	GetFunctionAddress $fncAddr `${_FUNC}`<br />
	Call GetSectionNames<br />
!macroend<br />
<br />
<br />
Function GetSectionNames<br />
<br />
        System::Call `*(&amp;t${GSN_BufferSize})i.r2`<br />
        StrCpy $PTR_FNC $2<br />
        StrCpy $lpszReturnBuffer $2<br />
<br />
        System::Call `kernel32::GetPrivateProfileSectionNames(i,i,t) ($lpszReturnBuffer, ${GSN_BufferSize}, '$IniPath')`<br />
        StrCpy $pNextSection $lpszReturnBuffer<br />
<br />
        ${Do}<br />
            System::Call `kernel32::lstrlen(i $pNextSection)i.r5`<br />
            StrCpy $iniSecSize $5<br />
<br />
            System::Call `*$pNextSection(&amp;m${GSN_BufferSize} .r9)`<br />
	    Call $fncAddr<br />
<br />
             ${If} $9 == 'StopGetSectionName'<br />
                   ${ExitDo}<br />
             ${Endif}<br />
<br />
	     IntOp $pNextSection $pNextSection + $iniSecSize<br />
             IntOp $pNextSection $pNextSection + 1<br />
<br />
            System::Call `kernel32::lstrlen(i $pNextSection)i.r5`<br />
            StrCpy $iniSecSize $5<br />
<br />
        ${LoopWhile} $iniSecSize != 0<br />
<br />
	System::Free $PTR_FNC<br />
<br />
FunctionEnd<br />
<br />
<br />
Function LISTASECTIONCALLBACK<br />
<br />
${If} $9 == $NOMESECTION<br />
        StrCpy $9 'StopGetSectionName'<br />
${Endif}<br />
<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">29th August 2013, 13:54</div></div><div class="posttext">If this is a unicode installer:<br />
<br />
System::Call `*$pNextSection(&amp;m${GSN_BufferSize} .r9)` should use t type. <br />
IntOp $pNextSection $pNextSection + 1 needs to be + 2</div></div><hr />


<div class="post"><div class="posttop"><div class="username">shadowpoa</div><div class="date">29th August 2013, 15:21</div></div><div class="posttext">Hi Anders, <br />
<br />
I´m not using Unicode here, its not clear on MSDN if I'll need to call the function with A or W when not specific for one system or another, focus here is only pt-br, and using default chars (32-127).<br />
<br />
Is there any problem with these conditions?<br />
<br />
Anyway, I'll do some tests based on your post... I'll come back with the results.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">shadowpoa</div><div class="date">29th August 2013, 17:17</div></div><div class="posttext">Changing   + 1 to + 2 on &quot;IntOp $pNextSection $pNextSection + 1&quot; cuts the first letter from the second section name and so on...<br />
<br />
Calling GetPrivateProfileSectionNames or GetPrivateProfileSectionNamesA I have same result.<br />
<br />
Calling GetPrivateProfileSectionNamesW gives a empty result on lstrlen call, but Unicode is not the focus , I'll just ignore this.<br />
<br />
Changing &quot;*$pNextSection(&amp;m&quot; to &quot;*$pNextSection(&amp;t&quot; gives the same result, and the crashes (randomically) continues.<br />
<br />
I Forgot to tell, at the point the function is called, the stack is empty.<br />
<br />
The only thing I can tell is that the crash happens upon calling the line<br />
&quot;System::Call `*$pNextSection(&amp;t${GSN_BufferSize} .r9)`&quot;<br />
the last error I´d get has on 3rd section of ini file (total sections is 14 for test file).<br />
<br />
Hope this helps, many thanks in advance.<br />
<br />
Edit:<br />
Forgot to ask... is there any newer version os system plugin? cant find references on wiki... mine is from 5/12/2009 that come with nsis last nsis version.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">29th August 2013, 17:20</div></div><div class="posttext">&quot;System::Call `*$pNextSection(&amp;t${GSN_BufferSize} .r9)`&quot; is probably not OK if GSN_BufferSize is above 1024.<br />
<br />
Try my version (http://nsis.sourceforge.net/IniGetSectionNames)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">shadowpoa</div><div class="date">29th August 2013, 18:54</div></div><div class="posttext">Anders,<br />
<br />
So far so good, everything ok.<br />
<br />
Can you explain what´s wrong with the other implementation?<br />
<br />
Í'll keep testing, but assume it is ok, tested a lot of times without crash.<br />
<br />
I dont understand some points on new code like the lines below.<br />
<br />
!ifdef IniGetSectionNames_StopEnum<br />
${If} $3 == &quot;$\n&quot;<br />
System::Call '*$0(&amp;i${NSIS_CHAR_SIZE} 0)'<br />
${EndIf}<br />
!endif<br />
Goto loop<br />
<br />
This line is just to not test strlen = 1 for the 'newline' char?<br />
I dont get how this pointer Works... <br />
<br />
Thanks again, you have saved me a lot of time, and I think this function is useful to others on fórum... how we can update the wiki with this?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">29th August 2013, 19:07</div></div><div class="posttext">The \n is not a valid section name so it is a good magic value, the system call just &quot;ends&quot; the string (In C this would be mystrptr[0] = '\0';) so lstrlen will return 0 and end the loop...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">shadowpoa</div><div class="date">29th August 2013, 19:55</div></div><div class="posttext">Anders,<br />
<br />
I have imagined that 'magic value', but dunno how to put it in code.<br />
<br />
Many thanks for the big Help and enlightment about your solution approach.<br />
<br />
Moderator can mark this as solved if needed.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>