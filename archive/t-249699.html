<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" nfUtils.nsh - a collection of macros and functions, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  nfUtils.nsh - a collection of macros and functions NSIS Discussion" />
	
	<title> nfUtils.nsh - a collection of macros and functions [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  nfUtils.nsh - a collection of macros and functions</div>
<hr />
<div class="pda"><a href="t-249699.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=249699">nfUtils.nsh - a collection of macros and functions</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">26th June 2006, 16:17</div></div><div class="posttext">Here is a collection of some useful macros and functions. The headerfile comes with an installer and its script, which also shows how to use some of nfUtils' macros.<br />
<br />
Maybe there are some english-speaking people, who could review the build-in help: follow the instructions in the installer's listbox.<br />
<br />
Currently included are:<br />
<br />
&quot;nfu.!AddFile&quot;<br />
&quot;nfu.!AddFunction&quot;<br />
&quot;nfu.!Append&quot;<br />
&quot;nfu.!AppendIf&quot;<br />
&quot;nfu.!Calculate&quot;<br />
&quot;nfu.!Compare&quot;<br />
&quot;nfu.!Exchange&quot;<br />
&quot;nfu.!FileVersion&quot;<br />
&quot;nfu.!FreeFile&quot;<br />
&quot;nfu.!FreeSymbol&quot;<br />
&quot;nfu.Function&quot;<br />
&quot;nfu.FunctionEnd&quot;<br />
&quot;nfu.!Help&quot;<br />
&quot;nfu.HideBackButton&quot;<br />
&quot;nfu.HideCancelButton&quot;<br />
&quot;nfu.!IncludeFileIf&quot;<br />
&quot;nfu.!IncludeTextIfExist&quot;<br />
&quot;nfu.!InstallDescription&quot;<br />
&quot;nfu.!InstallFunction&quot;<br />
&quot;nfu.!InstallMacro&quot;<br />
&quot;nfu.!MakeFile&quot;<br />
&quot;nfu.!MakeSymbol&quot;<br />
&quot;nfu.!Redefine&quot;<br />
&quot;nfu.!Replace&quot;<br />
&quot;nfu.SetInstallerName&quot;<br />
&quot;nfu.SetStdAttributes&quot;<br />
&quot;nfu.SetVersionInfo&quot;<br />
&quot;nfu.SkipPageOnSrcExtract&quot;<br />
&quot;nfu.SkipSectionOnSrcExtract&quot;<br />
&quot;nfu.!Undefine&quot;<br />
&quot;nfu.GetAppPath&quot;<br />
&quot;nfu.UnGetAppPath&quot;<br />
&quot;nfu.GetParameter&quot;<br />
&quot;nfu.UnGetParameter&quot;<br />
&quot;nfu.ProcessStdSwitches&quot;<br />
&quot;nfu.UnProcessStdSwitches&quot;<br />
&quot;nfu.myName&quot;<br />
&quot;nfu.myVersion&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JasonFriday13</div><div class="date">27th June 2006, 03:26</div></div><div class="posttext">I have just compiled the setup script using 2.15, and it runs the same as the one in the zip provided :up: . Good work.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">30th June 2006, 10:15</div></div><div class="posttext">At the very minimum, you should create a wiki page for this. I hope I'll have some time to look at it soon. I find the function macros especially interesting.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">30th June 2006, 11:52</div></div><div class="posttext">I was always missing an NSIS-installer attribute, which enables 'browsing' or 'extracting' the installer and its resources (by commandline-switch) without really running it, so nfUtils was mainly aimed to provide such a functionality with nfu.ProcessStdSwitches. Did you try to start nfUtils.exe with /? in the commandline ?<br />
<br />
All macros in nfUtils helped me building this function: so I was also missing a framework which helps me passing parameters to a function, getting them inside the function, etc. That's the way how nfu.!InstallFunction, nfu.Function and nfu.FunctionEnd were born.<br />
<br />
Dont know when I will have the time to make a wiki page. Never did it until now...<br />
<br />
What I am really missing in the wiki-system is an entry-page to browse the wiki. For example, http://nsis.sourceforge.net/home/ does not show up such an entry and it took me a lot of time to find this page  http://nsis.sourceforge.net/Category:Browse_NSIS_Repository_by_Topic what comes close to what I would expect as a 'homepage' for contributors. A hierarchical system like the sidebar of http://nsis.sourceforge.net/home/ would be better though...<br />
<br />
Stay tuned for version 1.1 with a bugfix: a compilation error will occur, when passing string constants containing single quotes to a function.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">30th June 2006, 15:56</div></div><div class="posttext">Here is nfUtils 1.1.0.0:<br />
<br />
fixed: string constants with single quotes (') caused compilation errors when passing them to a function. the problem persists for backward single quotes (`) and cannot be solved. escaping has no effect. workaround: when possible, copy such strings to a var and use the var for passing the parameter.<br />
<br />
added: added nfu.StdLicense to the descriptions.<br />
<br />
chngd: output of nfu.!Help usage info: <br />
${funcname} out:p1 in:p2 in:p3<br />
<br />
Minor changes to the installer, mainly more comments.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">11th July 2006, 13:47</div></div><div class="posttext">fixed: ${nfu.FunctionEnd} tried to generate &quot;Exch 0&quot;, e.g. for functions with one out- and no in-parameters.<br />
<br />
I have added a testsuite to the installer to proof the correctness of ${nfu.Function} and ${nfu.FunctionEnd}: the suite tests all 66 combinations, regarding the number of out- and in-parameters.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">19th July 2006, 20:13</div></div><div class="posttext">The front page contains a large image link to the developer center (http://nsis.sourceforge.net/Developer_Center) which serves as an entry page for all of the development related topics. Creating new pages (http://nsis.sourceforge.net/mediawiki/index.php?title=nfUtils&amp;action=edit) shouldn't be too difficult. You should really create a wiki page for it. Things tend to fade away in the forum.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">20th July 2006, 18:57</div></div><div class="posttext">... here: http://nsis.sourceforge.net/NfUtils_header_file<br />
<br />
Wow. My first wiki !<br />
<br />
Currently it is merely a copy of nfUtils' built-in descriptions, all on one page. I will add some examples next week.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Filus</div><div class="date">17th November 2006, 12:12</div></div><div class="posttext">I've had a problem with including several times your nsh file. I made some &quot;library&quot; headers for my products, and I use your utils in some of them. But it's working great when I include nfUtils.nsh in all files only once, otherwise some errors occured. The first was about invalid number of parameters for echo in line 42, so I changed ` to ' and it's passed. But then next error occured:<br />
<br />
Invalid command: !if${Condition}<br />
!include: error in script: &quot;C:\Program Files\NSIS\Include\nfUtils.nsh&quot; on line 566</div></div><hr />


<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">17th November 2006, 12:25</div></div><div class="posttext">Can you detect the line in _your_ source, which causes the error? I need to see NSIS' log with the lines preceding the error code, try playing with <br />
!verbose 4 <br />
or <br />
${nfu.!Redefine} NFU_VERBOSITY 3<br />
or <br />
${nfu.!Redefine} NFU_VERBOSITY 4<br />
to get more details.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">17th November 2006, 13:08</div></div><div class="posttext">Seems as if you are using ${nfu.!AppendIf} with an illegal condition:<br />
<br />
http://nsis.sourceforge.net/NfUtils_header_file#nfu..21AppendIf<br />
<br />
!ifCondition has to be a valid NSIS compile time command for conditional compilation like<br />
<br />
!ifdef<br />
!ifndef<br />
!ifmacrodef<br />
!ifmacrondef<br />
!if 1 &lt; 2<br />
etc.<br />
<br />
For the last example you would have to use<br />
<br />
${nfu.!AppendIf} &quot; 1 &lt; 2&quot; &quot;YourSymbol&quot; &quot;YourValue&quot;<br />
<br />
Notice the quotes enclosing the condition and the leading spacecharacter in the condition!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Filus</div><div class="date">17th November 2006, 15:00</div></div><div class="posttext">Originally posted by niteflyer <br />
Can you detect the line in _your_ source, which causes the error?<br />
Ok, no problem:<br />
In my general nsi file I have sequence of include commands:<br />
!include LogicLib.nsh<br />
!include &quot;${NSHDIR}\loading.nsh&quot;<br />
!include &quot;${NSHDIR}\about.nsh&quot;<br />
!include &quot;${NSHDIR}\services.nsh&quot;<br />
[...]<br />
I include your utils in loading (first time) and in about nsh files. loading.nsh has passed without problems, so compiler goes to about.nsh, and from then to another one nsh where I include nfuUtils directly. It looks:<br />
!ifndef COMMONS_FILES<br />
    !define COMMONS_FILES<br />
<br />
    !include LogicLib.nsh<br />
    !include FileFunc.nsh<br />
    !include WordFunc.nsh<br />
    !include nfUtils.nsh<br />
    [...]<br />
!endif<br />
<br />
And compiler stops on line where nfUtils are included and produces this log:<br />
!define: &quot;COMMONS_FILES&quot;=&quot;&quot;<br />
!include: &quot;C:\Program Files\NSIS\Include\LogicLib.nsh&quot;<br />
!include: closed: &quot;C:\Program Files\NSIS\Include\LogicLib.nsh&quot;<br />
!include: &quot;C:\Program Files\NSIS\Include\FileFunc.nsh&quot;<br />
!include: closed: &quot;C:\Program Files\NSIS\Include\FileFunc.nsh&quot;<br />
!include: &quot;C:\Program Files\NSIS\Include\WordFunc.nsh&quot;<br />
!include: closed: &quot;C:\Program Files\NSIS\Include\WordFunc.nsh&quot;<br />
!include: &quot;C:\Program Files\NSIS\Include\nfUtils.nsh&quot;<br />
Invalid command: !if${Condition}<br />
!include: error in script: &quot;C:\Program Files\NSIS\Include\nfUtils.nsh&quot; on line 566<br />
!include: error in script: &quot;..\src\nsis\files.nsh&quot; on line 28<br />
!include: error in script: &quot;..\nsh\about.nsh&quot; on line 14<br />
Seems as if you are using ${nfu.!AppendIf} with an illegal condition:<br />
Hmmm, but I'm not using this (directly in my code at least). I only use ${nfu.Function} and ${nfu.FunctionEnd} in this all &quot;error making&quot; script (including used nsh files).<br />
So, I've made temporary workaround (checking defining of NFUPREFIX before including nfUtils), but it'll be better if I don't have to use it.<br />
Well, also I'll check my code once again and try compile in another machine (and version of NSIS - I use 'long strings' build).</div></div><hr />


<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">17th November 2006, 15:33</div></div><div class="posttext">Hmmm, strange: you don't need to check for NFUPREFIX, because nfUtils.nsh already checks this symbol to prevent multiple inclusion (in Line 1) of itself. You should be able to see if this works by turning verbosity on (see previous post).<br />
<br />
The log says, that the error was caused by the instruction in line 28 of files.nsh - what's in there ?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Filus</div><div class="date">17th November 2006, 16:12</div></div><div class="posttext">Originally posted by niteflyer <br />
Hmmm, strange: you don't need to check for NFUPREFIX, because nfUtils.nsh already checks this symbol to prevent multiple inclusion <br />
Yes, I saw this. But, somehow, it works in workaround and not in nfUtils.nsh. :confused:<br />
I also added (for tests) one more checking define in nfUtils.nsh in this way:!ifndef NFUTILS_INCLUDED<br />
!define NFUTILS_INCLUDED<br />
<br />
[Original nfUtils content]<br />
<br />
!endifBut it nothing changes. So, yes, this is strange.<br />
<br />
The log says, that the error was caused by the instruction in line 28 of files.nsh - what's in there ? There is:        !include nfUtils.nsh Nothing more. This is the last line of sample code in my previous post.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">17th November 2006, 16:48</div></div><div class="posttext">Assuming that nfUtils would be included more than once: the first error you would get with nfUtils' line 30 (and not in line 566):<br />
<br />
!define NFUPREFIX &quot;nfu.&quot;<br />
<br />
you cannot define a symbol which is already defined... So there must be something else. What really surprises me, is that if you are checking outside of nfUtils for NFUPREFIX, you will not get the error - do you get another error, a flawless compilation or a flawless installer?<br />
<br />
You have to examine NSIS' compilerlog with full verbosity to see what went wrong.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">17th November 2006, 17:29</div></div><div class="posttext">I can reproduce similar strange effects when I include nfUtils.nsh twice in the sourcecode of its installer (error in the usage of !echo in line 42 of nfUtils.nsh). <br />
<br />
I can reproduce the behaviour of checking NFUPREFIX outside the header does work fine.<br />
<br />
Checking inside a small header file does _also_ work fine (xxx.nsh):<br />
<br />
!ifndef xxx<br />
!define xxx 222<br />
!endif<br />
<br />
(main.nsi):<br />
<br />
!include xxx.nsh<br />
!include xxx.nsh<br />
<br />
Dont know what I should think of that...<br />
<br />
Tested with NSIS 2.21 and 2.18.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Filus</div><div class="date">17th November 2006, 17:32</div></div><div class="posttext">Well, when I'm checking NFUPREFIX outside of nfUtils I get flawless compilation of flawless installer. All works great.<br />
And also strange is, that if I use your &quot;original&quot; nfUtils.nsh errors occured on line 42 (but as I wrote, I made some small fix for it) and says:!echo expects 1 parameters, got 3.<br />
Usage: !echo message<br />
!include: error in script: &quot;C:\Program Files\NSIS\Include\nfUtils.nsh&quot; on line 42It seems like some strange errors with defines. I'll make some test on weekend and/or begining of next week to reproduce these errors with another code and building enviroment.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">17th November 2006, 17:55</div></div><div class="posttext">Yes, I get the same error. But the point is that the compiler _must_ not compile line 42, but skip at line 1 to the end of the header. Everything can happen, no matter how many fixes and workarounds you find for making line 42 work...<br />
<br />
I would suspect an error with missing ENDIFs/MACROENDs in nfUtils' code, if I would not know that nfUtils is working.<br />
<br />
If I comment line 42 then I get the same error you have reported: Invalid command: !if${Condition}<br />
<br />
Is there a limit for codelines between !ifndef and !endif, Kichik?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Filus</div><div class="date">17th November 2006, 21:26</div></div><div class="posttext">Originally posted by niteflyer <br />
[B]But the point is that the compiler _must_ not compile line 42, but skip at line 1 to the end of the header. Everything can happen, no matter how many fixes and workarounds you find for making line 42 work...[B]<br />
Yes, I know this. I wrote about this line, because it is in another, internal, !ifndef-!endif block where compiler shouldn't enter. And also, it seems like the string in !echo is somehow splitted at ${NFUPREFIX} positions. So this is some clue for my hypothesis about &quot;something wrong&quot; with preprocessor commands in NSIS.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">18th November 2006, 13:34</div></div><div class="posttext">I will try to locate the problem with a reduced header on the weekend, and - if necessary - post this issue at the SourceForge Bug Tracker. It would not be the first time, that nfUtils reveals a bug in NSIS...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">davidnewcomb</div><div class="date">11th June 2010, 10:10</div></div><div class="posttext">This thread has not been touched for 4 years. Is it still active?<br />
Was the bug in NSIS addressed?<br />
Couldn't work out from the documentation whether nfu.Function supports nested functions?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">11th June 2010, 10:55</div></div><div class="posttext">The thread is still active.<br />
<br />
I wasn't able to fix the bug for the NSIS version, which was released at that time. I did not check if the bug still persists with the current version. If you read the last posts of the thread there is an assumption that there was/is something wrong with the implementation of NSIS' preprocessor commands. As far as I recall I did not submit a bugreport to the Bug Tracker, because I had no clue how to isolate the problem.<br />
<br />
What do you mean with nested functions? NSIS does not support nested function declarations. Nested functions calls are supported, and should also work with nfu.Function...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">davidnewcomb</div><div class="date">11th June 2010, 11:37</div></div><div class="posttext">By nested function I mean a function that is called from inside another function. A good example is &quot;Trim&quot;.<br />
<br />
Function TrimCall<br />
exch/pop<br />
do trim<br />
push/exch/pop/exch/pop<br />
EndFunction<br />
<br />
!macro Trim WHAT<br />
  Push ${WHAT}<br />
  Call TrimCall<br />
  Pop ${WHAT}<br />
!macroend<br />
<br />
Function DoSomethingUsefulCall<br />
push/pop/etc<br />
 ${Trim} $0<br />
push/pop/etc<br />
EndFunction<br />
<br />
!macro DoSomethingUseful P1 P2 RET<br />
push/pop/etc<br />
  Call DoSomethingUsefulCall<br />
push/pop/etc<br />
!macroend<br />
<br />
<br />
A bit rough but you get the idea. Is your stuff going to protect all my $0, that is, does it artificially create protected scope while inside each function. I'm interested in using this package but the examples are few and far between, and the ones I have found are only called from a Section and don't call out to any other nfu.Function.<br />
<br />
Our NSIS installer is over 4,500 lines long! and so we have to nest our functions. We use the system store call to provide artificial scope, but it is really ugly.<br />
<br />
<br />
Function WriteSomeInfoCall<br />
<br />
  # Place stack protection code here<br />
  System::Store /NOUNLOAD &quot;s&quot;<br />
  Pop $0<br />
  :<br />
  dostuff<br />
  :<br />
  Push $0<br />
  System::Store &quot;l&quot;<br />
EndFunction<br />
<br />
<br />
to provide artificial scope but it's really ugly.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">11th June 2010, 13:50</div></div><div class="posttext">My macros do not create an artificial scope: nfu.Function and nfu.FunctionEnd only provide the code for getting and returning parameter from/to the stack. Only the registers which you have specified for nfu.Function for getting the parameters are protected as they will be restored by nfu.FunctionEnd (besides returning values to the stack, see wiki). Other registers which you need inside your function have to be protected by _you_ (with push at the beginning and pop at the end), so you may still use global registers inside your function.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">11th June 2010, 16:24</div></div><div class="posttext">nfUtil.nsi (the installerscript of the headerpackage - will be extracted to the examplesdir of NSIS) shows a small example how to implement the function F1 which uses another function HelperForF1 in line 88-139. F1 is called in line 192 (simply with ${F1} $R1 $R2 $0 $1 $2 $3).<br />
<br />
Line 111-113 and 128-129 should be used as a skeleton for every of your functions: put your code in between these two parts. <br />
<br />
The macro in line 102 handles dependencies by issuing nfu.AddFunction for every function which is used by function F1.<br />
<br />
Line 132-133 generate the macros with the code for calling the functions HelperForF1 and F1, so that you may use the syntax in line 115 or line 192 to invoke a function.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">davidnewcomb</div><div class="date">11th June 2010, 17:35</div></div><div class="posttext">Thanks, I understand now - I think. I did read your wiki page but I didn't really understand it and there were no examples. I'll go and have a play.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">niteflyer</div><div class="date">14th June 2010, 10:02</div></div><div class="posttext">I know it is difficult to understand without examples. Never had the time to update the wiki with some of them. nfUtils.nsi should give you an idea how to use the macros. If you watch the compileroutput of NSIS you should understand how it works. <br />
<br />
It is simply some kind of interface which hig-level languages provide when you declare a function so the compiler knows which arguments have to be put and fetched from the stack when you call a function, when you enter/leave a function and when the calling environment continues with the results of a function.<br />
<br />
What has to happen inside the function body still remains low-level like assembler language so _you_ have to care about the contents of registers when you need to change them for intermediate results, because they are usually already used in the calling environment and may not be changed: use push and pop like in good old assembler...</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>