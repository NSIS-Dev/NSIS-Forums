<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Getting DLLs into Setup.EXE, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Getting DLLs into Setup.EXE NSIS Discussion" />
	
	<title> Getting DLLs into Setup.EXE [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Getting DLLs into Setup.EXE</div>
<hr />
<div class="pda"><a href="t-206784.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=206784">Getting DLLs into Setup.EXE</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">JimInNH</div><div class="date">3rd February 2005, 18:19</div></div><div class="posttext">When I test my installer from a CD or another folder, I am getting an error  &quot;The DLL failed to initialize....&quot;.<br />
<br />
There are 3 helper DLLs that are used by my plugin DLL.<br />
<br />
In the script I have lines for each of them like:<br />
<br />
....<br />
ReserveFile &quot;libmysql.dll&quot;<br />
....<br />
Function .onInit<br />
...<br />
    !insertmacro MUI_INSTALLOPTIONS_EXTRACT &quot;libmysql.dll&quot;<br />
...<br />
FunctionEnd<br />
<br />
I thought this would add the dll(s) to the compiled setup.exe program.  The goal is to have a single file for distribution.<br />
<br />
Do I need to have a File statement for them?  I could not find anything the covers this type of dll.  If they are already in the $EXEDIR the setup program runs fine.<br />
<br />
Thanks,<br />
Jim</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">3rd February 2005, 18:57</div></div><div class="posttext">SetOutPath $EXEDIR<br />
ReserveFile &quot;libmysql.dll&quot;<br />
<br />
No need for MUI_INSTALLOPTIONS_EXTRACT... That's not for what you want.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">3rd February 2005, 19:22</div></div><div class="posttext">MUI_INSTALLOPTIONS_EXTRACT extracts a file to the plug-ins directory. The plug-ins directory is also where your plug-in is extracted. The problem is the Windows loader doesn't know it has to search for the DLL in there. You need to use SetOutPath to set the current working directory. The loader knows to search there.SetOutPath $PLUGINSDIR<br />
File libmysql.dll<br />
MyPlugin::SomeFunc</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JimInNH</div><div class="date">3rd February 2005, 19:45</div></div><div class="posttext">Thank you both, I've tried to implement both your suggestions without success.  At one point instead of getting the original error I got a message that the installer was corrupt or virus infected - maybe that was progress?  All other combinations resulted in the DLL failed to initialize message.<br />
<br />
A stripped down version of my last test is:<br />
<br />
;--------------------------------<br />
;Reserve Files<br />
    ReserveFile &quot;InstallInfo.ini&quot;<br />
    ....<br />
    ReserveFile &quot;Progress.ini&quot;<br />
    !insertmacro MUI_RESERVEFILE_INSTALLOPTIONS<br />
;--------------------------------<br />
Section &quot;Dummy Section&quot; SecDummy<br />
<br />
    ; Tried this, didn't work<br />
    ;      SetOutPath $EXEDIR<br />
    ;      ReserveFile &quot;ivnvi.dll&quot;<br />
    ;      ReserveFile &quot;windblib.dll&quot;<br />
    ;      ReserveFile &quot;libmysql.dll&quot;<br />
<br />
    ; Tried this, didn't work, so tried to save what used to be OUTDIR and then restore that<br />
    ; still didn't work<br />
    StrCpy $R0 $OUTDIR<br />
    SetOutPath $PLUGINSDIR<br />
    File &quot;ivnvi.dll&quot;<br />
    File &quot;windblib.dll&quot;<br />
    File &quot;libmysql.dll&quot;<br />
    SetOutPath $R0<br />
<br />
    File /r &quot;Files\Autoip&quot;<br />
    File /r &quot;Files\${PROGNAME}&quot;<br />
<br />
    ;Create uninstaller<br />
    WriteUninstaller &quot;$INSTDIR\Uninstall.exe&quot;<br />
SectionEnd<br />
;====================================================================<br />
Function .onInit<br />
    SetPluginUnload alwaysoff<br />
    InitPluginsDir<br />
    ;Extract InstallOptions INI files<br />
    !insertmacro MUI_INSTALLOPTIONS_EXTRACT &quot;InstallInfo.ini&quot;<br />
    .....<br />
    ; Tried with and without this commented out.<br />
    ;  !insertmacro MUI_INSTALLOPTIONS_EXTRACT &quot;ivnvi.dll&quot;<br />
    ....<br />
    SetOutPath &quot;$SetupWorkDir&quot;<br />
    ....<br />
FunctionEnd<br />
<br />
Thanks for helping.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">3rd February 2005, 19:53</div></div><div class="posttext">Where is the plug-in called in the script? You must have SetOutPath $PLUGINSDIR above it, without any other SetOutPath in the middle.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JimInNH</div><div class="date">3rd February 2005, 20:12</div></div><div class="posttext">My plugin is called install6.dll.  It is located in the NSIS\Plugins folder.<br />
<br />
My plugin has a dependancy on three other DLLs which are not called directly from the NSIS script but which are needed by my plugin dll.<br />
<br />
I compile the script with those 3 dlls in the root of the script, and when the resultant.exe is run there everything works.<br />
<br />
When I move the resultant.exe to another folder I get the messages.<br />
<br />
I actually call my plugin in the leave function of a custom page which occurs immediately after the user selects the install folder.<br />
<br />
I tried moving the following into that function but still no change.<br />
<br />
        SetOutPath $PLUGINSDIR<br />
        File &quot;ivnvi.dll&quot;<br />
        File &quot;windblib.dll&quot;<br />
        File &quot;libmysql.dll&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">3rd February 2005, 20:17</div></div><div class="posttext">Do you have any more SetOutPath instructions between that piece of code and the plug-in call itself? Does the plug-in set the current working directory?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JimInNH</div><div class="date">3rd February 2005, 21:22</div></div><div class="posttext">I guess some background is needed.<br />
<br />
The main NSIS script packages up some files including several other NSIS<br />
output exe files that are located in a directory structure.<br />
<br />
In .onInit SetOutPath  becomes $SetupWorkDir which is $TEMP\setup<br />
<br />
The very first page is MUI_PAGE_INSTFILES.<br />
<br />
All the files get extracted to SetupWorkDir, the plugins go deep into<br />
Documents and settings.<br />
<br />
The user works his way thru the dialogs.  After selecting MUI_PAGE_INSTFILES<br />
a custom page is called having a Start button.<br />
<br />
The begins the main installation process which installs several packages.<br />
<br />
I have now tried two things in my custom leave function since the last post.<br />
<br />
1) Since the SetOutPath was already to my $SetupWorkDir I just let the<br />
files be extracted there.  That didn't work, so<br />
<br />
2) I SetOutPath to the plugins folder and then set it back to setup, as below.<br />
<br />
        SetOutPath $PLUGINSDIR<br />
        File &quot;ivnvi.dll&quot;<br />
        File &quot;windblib.dll&quot;<br />
        File &quot;libmysql.dll&quot;<br />
        SetOutPath $SetupWorkDir<br />
<br />
In summary,<br />
<br />
    - a custom plugin is in the NSIS\plugins folder<br />
    - 3 dependant dlls are in the root of my script folder<br />
    - the plugin is extracted to a system $TEMP folder<br />
    <br />
    - I can't get syntax correct to get the 3 dependant dlls where<br />
    NSIS expects them to be.<br />
    <br />
I think the dependant dlls need to land in the plugins folder so<br />
my custom plugin will find them.<br />
<br />
The script compiles without errors but when executed the DLL failed to<br />
initialize message is generated.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">3rd February 2005, 21:35</div></div><div class="posttext">Put SetOutPath $PLUGINSDIR right above the plug-in call. Don't use SetOutPath $SetupWorkDir before the plug-in call. This will tell the Windows loader where to look for the DLLs.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JimInNH</div><div class="date">4th February 2005, 00:28</div></div><div class="posttext">Thank you all for your help.<br />
<br />
I was able to get the dlls to appear in BOTH the $PLUGINSDIR and the $EXEDIR and it still failed.<br />
<br />
If however, the dll was in the EXEDIR before launch, it was successful.  <br />
<br />
Since we plan on distributing by sending one file by FTP, needing two files is not an option.  I will continue looking for a solution.  ............<br />
<br />
...................<br />
<br />
<br />
...................<br />
<br />
<br />
Hmmmmmm, sometimes writing helps.  It occurred that when the dll gets there by my copy commands its just too late.<br />
<br />
At the start of .onInit I added:<br />
<br />
SetOutPath $EXEDIR<br />
File &quot;ivnvi.dll&quot;<br />
<br />
Viola!  The file is extracted at the very start and all is happy.  So now I'm only 3 days past deadline:(<br />
<br />
But ;) for getting past this issue!<br />
<br />
Thanks Kichik and Afrow UK!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JimInNH</div><div class="date">4th February 2005, 01:31</div></div><div class="posttext">Well....<br />
There is one 'minor' problem and hopefully a solution.<br />
<br />
When the setup program is copied to a CD-ROM, the attempt to extract the file (dll) to the CD-ROM fails.<br />
<br />
I tried changing the SetOutPath to $PLUGINSDIR but that won't work in a regular empty disk folder, let alone a CD.<br />
<br />
I suppose one solution would be to leave the SetOutPath to $EXEDIR.  On distribution CD's include the dll file.  For Web downloads, the file will get extracte to a disk ok.<br />
<br />
Does anyone has a better suggestion?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">JimInNH</div><div class="date">4th February 2005, 03:58</div></div><div class="posttext">I have found something that works.  <br />
<br />
On CD distribution disks put the DLL on the CD with the setup program.  For ftp distribution, a file is not needed it will be extracted.<br />
<br />
Look to see if the file is in the EXEDIR, if it is not, copy it there<br />
<br />
In .onInit<br />
<br />
    FindFirst $0 $1 $EXEDIR\ivnvi.dll<br />
    StrCmp $1 &quot;ivnvi.dll&quot; nocopy +1<br />
        SetOutPath $EXEDIR<br />
        File &quot;ivnvi.dll&quot;<br />
    nocopy:    <br />
<br />
    SetPluginUnload alwaysoff<br />
    InitPluginsDir<br />
<br />
--- Thanks for all the help, I hope this helps someone else.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">4th February 2005, 11:02</div></div><div class="posttext">Use IfFileExists<br />
<br />
-Stu</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>