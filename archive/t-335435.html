<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" ShellExecAsUser plugin, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  ShellExecAsUser plugin NSIS Discussion" />
	
	<title> ShellExecAsUser plugin [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  ShellExecAsUser plugin</div>
<hr />
<div class="pda"><a href="t-335435.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=335435">ShellExecAsUser plugin</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">installer32</div><div class="date">30th September 2011, 16:59</div></div><div class="posttext">I've created a new ShellExecAsUser plugin:<br />
http://nsis.sourceforge.net/ShellExecAsUser_plug-in<br />
It allows to execute the specified program in non-admin context, i.e. it is intended for installers that run with admin rights but need to execute something in non-admin context.<br />
It uses desktop COM interface to execute process, so that process is launched by explorer (http://brandonlive.com/2008/04/27/getting-the-shell-to-run-an-application-for-you-part-2-how/).<br />
Any comments are welcome.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">1st October 2011, 12:32</div></div><div class="posttext">Sound like something that can pretty useful :cool:<br />
<br />
Two questions:<br />
* What operating systems does it work with? Any &quot;fall back&quot; mode for WinXP and Win2k?<br />
* Can you please compile a Unicode version of that plug-in?<br />
<br />
(Sorry, did not have time to examine your code yet)<br />
<br />
Regards,<br />
MuldeR.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">installer32</div><div class="date">1st October 2011, 15:04</div></div><div class="posttext">* What operating systems does it work with? Any &quot;fall back&quot; mode for WinXP and Win2k?<br />
It should work starting from Win2k. On WinXP, Win2k (or if UAC is disabled) the plugin will do the launch using ShellExecute.<br />
<br />
* Can you please compile a Unicode version of that plug-in?<br />
Ok I'll do.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">1st October 2011, 15:25</div></div><div class="posttext">Thank you!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">1st October 2011, 17:13</div></div><div class="posttext">I have adopted your ExecShellAsUser method into my StdUtils plug-in:<br />
http://pastie.org/private/b9cymlmclyuo6b1f4kcmfg<br />
<br />
(ANSI and Unicode builds attached)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">1st October 2011, 18:07</div></div><div class="posttext">So, what, does this do what the UAC plugin was also designed to do, but without two installer instances?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">1st October 2011, 18:15</div></div><div class="posttext">So, what, does this do what the UAC plugin was also designed to do, but without two installer instances?<br />
<br />
Yup. It generates a non-elevated process right from the elevated installer instance.<br />
<br />
Seems to work for me on Windows 7 (x64). I don't have any other UAC-enabled test platforms.<br />
<br />
On Windows XP and earlier it simply falls back to the normal ShellExecute()...</div></div><hr />


<div class="post"><div class="posttop"><div class="username">installer32</div><div class="date">1st October 2011, 18:27</div></div><div class="posttext">I have adopted your ExecShellAsUser method into my StdUtils plug-in:<br />
Ok but note that I used another thread for desktop COM calls. Otherwise I (sometimes) got RPC_E_CANTCALLOUT_ININPUTSYNCCALL error, which is solved if you do it on another thread.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">1st October 2011, 18:30</div></div><div class="posttext">Ok but note that I used another thread for desktop COM calls. Otherwise I (sometimes) got RPC_E_CANTCALLOUT_ININPUTSYNCCALL error, which is solved if you do it on another thread.<br />
<br />
Thanks for the hint!<br />
<br />
(I already noticed that CoInitializeEx() fails, because, I think, COM already is initialized with other parameters for the calling thread. So I switched back to CoInitialize() again. But I will implement your suggestion now)<br />
<br />
 Done. New version is attached.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">MSG</div><div class="date">1st October 2011, 20:49</div></div><div class="posttext">Very cool! I use the UAC plugin for double install mode all-through, for which case I guess it is more convenient to have two instances. But this is a very cool alternative, and a lot simpler to use!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">2nd October 2011, 13:01</div></div><div class="posttext">Small update:<br />
http://nsis.sourceforge.net/StdUtils_plug-in#ExecShellAsUser</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">2nd October 2011, 18:13</div></div><div class="posttext">Sorry, here are some more fixes:</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">2nd October 2011, 20:46</div></div><div class="posttext">This COM hack is problematic and/or broken when:<br />
<br />
A) <br />
Explorer is not running<br />
<br />
B) <br />
Explorer is elevated (Rare, but some people do it)<br />
<br />
C)<br />
Desktop user is not the correct parent:<br />
User A is logged on, <br />
runs setup as non-admin user B with runas.exe, <br />
setup is elevated with user C; <br />
The correct user is B, not A.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">2nd October 2011, 21:40</div></div><div class="posttext">In case (A) it will fall back to the normal ShellExecute(). Not ideal, but well...<br />
<br />
I'm not sure what will happen in case (B) or how to reproduce this, but I guess in that case we will either fail to get the COM interface and thus fall back to the normal ShellExecute(), or we will simply create an elevated instance.<br />
<br />
Again not ideal, but if you run your Explorer in an elevated way, then problems are preprogrammed anyway :rolleyes:<br />
<br />
(And in case (C) it may depend on the situation/purpose whether user A or B is the &quot;correct&quot; one)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">installer32</div><div class="date">2nd October 2011, 21:42</div></div><div class="posttext">Anders<br />
You are right and I'll add your remarks to plugin description, though I think it's quite uncommon and as such these limitations are acceptable to many people.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">9th October 2011, 16:34</div></div><div class="posttext">I have updated my StdUtils plug-in to use the &quot;new&quot; plug-in API, i.e. get rid of explicit unload.<br />
<br />
Furthermore I added a version of ExecShell with wait capability as well as some more convenience functions.<br />
<br />
New version here:<br />
http://nsis.sourceforge.net/StdUtils_plug-in<br />
<br />
(BTW: Could some mod please delete the obsolete versions attached to my previous posts?)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">21st October 2012, 18:21</div></div><div class="posttext">In case somebody is interested, I just uploaded a new version of my StdUtils plug-in:<br />
http://nsis.sourceforge.net/StdUtils_plug-in</div></div><hr />


<div class="post"><div class="posttop"><div class="username">LoRd_MuldeR</div><div class="date">23rd October 2012, 01:20</div></div><div class="posttext">In case somebody is interested, I just uploaded a new version of my StdUtils plug-in:<br />
http://nsis.sourceforge.net/StdUtils_plug-in<br />
<br />
I've just uploaded yet another update, which fixes a potential crash related to CoUninitialize() and certain certain Shell Extensions. In my case it was Tortoise GIT. Put simply, CoUninitialize() might still crash, even if all COM interfaces were released properly before. Happens if there are outstanding messages. It turns out we must dispatch all pending messages explicitly before calling CoUninitialize().<br />
<br />
As this might be relevant for all NSIS plug-in's that deal with COM interfaces (and the Shell), you might want to have a look here:<br />
http://stackoverflow.com/questions/13018389/ishelldisptach-why-does-folderitemverbsrelease-couninitialize-crash</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>