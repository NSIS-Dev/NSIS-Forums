<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" ExecWait doesn't wait (on Windows 7), media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  ExecWait doesn't wait (on Windows 7) NSIS Discussion" />
	
	<title> ExecWait doesn't wait (on Windows 7) [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  ExecWait doesn't wait (on Windows 7)</div>
<hr />
<div class="pda"><a href="t-320311.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=320311">ExecWait doesn't wait (on Windows 7)</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">nsnb</div><div class="date">28th June 2010, 14:27</div></div><div class="posttext">I came across this problem while testing the uninstall part of an NSIS script:<br />
<br />
Despite not changing anything in the -un.post section that takes care of removing all Start Menu entries:<br />
  ;Delete empty start menu parent diretories<br />
  StrCpy $MUI_TEMP &quot;${D_STARTMENU}&quot;<br />
SMDELOOP:<br />
    ClearErrors<br />
    RMDir $MUI_TEMP<br />
    GetFullPathName $MUI_TEMP &quot;$MUI_TEMP\..&quot;<br />
    IfErrors SMDELDONE<br />
    StrCmp $MUI_TEMP $SMPROGRAMS SMDELDONE SMDELOOP<br />
SMDELDONE:<br />
<br />
The uninstaller no longer deletes the last (topmost) entry in the Start Menu. In my attempts to troubleshoot this I discovered that this is not always consistent: Sometimes it deletes and sometimes it doesn't.<br />
<br />
So, I decided to place a MessageBox line right after the 'RMDir $MUI_TEMP' line:<br />
    RMDir $MUI_TEMP<br />
MessageBox MB_OK|MB_ICONEXCLAMATION &quot;Removed $MUI_TEMP&quot;	; for debug only<br />
    GetFullPathName $MUI_TEMP &quot;$MUI_TEMP\..&quot;<br />
And I was surprised to see that this message box is displayed while an ExecWait from a previous un.Uninstall section was still in progress...<br />
ExecWait '&quot;$INSTDIR\vcredist_x86.exe&quot; /q:a /c:&quot;VCREDI~1.EXE /q:a /c:&quot;&quot;msiexec /x vcredist.msi /qb!&quot;&quot; &quot;'<br />
<br />
Obviously, something is happening here in parallel but how could this be?<br />
<br />
 Isn't ExecWait supposed to wait?<br />
 Isn't Section -un.post supposed to start after all Section &quot;un.Uninstall&quot;s?<br />
<br />
<br />
Most importantly: How would you suggest that I solve (or workaround) this problem?<br />
<br />
Thanks!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">28th June 2010, 14:55</div></div><div class="posttext">ExecWait ALWAYS waits, I have not seen a single case yet where it is actually broken (and it will probably never happen, it is just WaitForSingleObject on a process handle) If you think it does not wait, the command you are executing is probably wrong (Or it spawns subprocesses and has no option to wait on them)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">thek</div><div class="date">28th June 2010, 17:03</div></div><div class="posttext">Hello nsnb<br />
<br />
Anders is right with is assumption, vc_redist spawns his own process<br />
actually I don't understand what you try to achieve with your command<br />
with your command you decompress the contents of vc_redist, there you start again a vc_redist where you decompress the contents and start the MSI installer!!!<br />
<br />
so there are probably 3 childprocess spawend!<br />
I simply use '&quot;$TEMP\VS2008_SP1_vcredist_x86.exe&quot; /q'<br />
<br />
if a real feedback for the user is needed you should install the redistributable files manually<br />
decompress the content and add it file by file to your installer.<br />
<br />
<br />
Also I wouldn't uninstall the VC redist<br />
Because other programms installed after your application my depend on it!!<br />
so your uninstaller will probably break other apps!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">nsnb</div><div class="date">28th June 2010, 17:58</div></div><div class="posttext">Thank you Anders and thek for your answers.<br />
<br />
I don't understand what you try to achieve with your command... you should install the redistributable files manually decompress the content and add it file by file to your installer.<br />
It's a legal issue dictated by Microsoft's EULA.<br />
<br />
After experimenting with this a little more, I discovered that the MessageBox actually solves the problem... This is not practical of course for the real installer, so I wonder what types of workarounds can I come up with?<br />
<br />
Perhaps placing a delay of several hundreds milliseconds?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">nsnb</div><div class="date">28th June 2010, 18:38</div></div><div class="posttext">so I wonder what types of workarounds can I come up with? Perhaps placing a delay of several hundreds milliseconds?<br />
Answering myself: Sleep() is ugly (in any programming language...), so I took the asynchronous approach: Right after the RMDir $MUI_TEMP line I check for errors:<br />
RMDir $MUI_TEMP<br />
IfErrors L_SM_ERROR<br />
...<br />
...<br />
...<br />
L_SM_ERROR:<br />
MessageBox MB_OK|MB_ICONEXCLAMATION &quot;Error in RMDir $MUI_TEMP.&quot;<br />
It turns out that by mere checking for the error, it never occurs anymore... (the message box is never displayed and the entire Start Menu entry is removed cleanly just as it used to be).<br />
<br />
Suggests a timing problem?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CrushBug</div><div class="date">28th June 2010, 18:47</div></div><div class="posttext">We have unpacked the vcredist.msi and vcredist.cab files and ExecWait the following:<br />
<br />
vcredist.msi /passive /norestart<br />
<br />
That works for us.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">nsnb</div><div class="date">29th June 2010, 17:25</div></div><div class="posttext">We have unpacked the vcredist.msi and vcredist.cab files and ExecWait the following:<br />
<br />
vcredist.msi /passive /norestart<br />
<br />
That works for us.<br />
Of course it works but is it legit? i.e. according Microsoft's EULA distributing the files individually is not allowed.<br />
<br />
As I described above, testing for errors after RMDir $MUI_TEMP solves the (timing) problem, so I am able to deliver a working uninstaller using Microsoft's required method.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">CrushBug</div><div class="date">29th June 2010, 22:18</div></div><div class="posttext">Well, we got the instructions on how to extract the two files from within the redist from an MSDN blog article. We have shipped 2 retail products like this. I cannot see how this could violate a MS EULA. All we are doing is unpacking an archive we are NOT redistributing the actual VC runtime files themselves.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>