<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Installer won't read from HKCU ?, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Installer won't read from HKCU ? NSIS Discussion" />
	
	<title> Installer won't read from HKCU ? [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Installer won't read from HKCU ?</div>
<hr />
<div class="pda"><a href="t-232823.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=232823">Installer won't read from HKCU ?</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">John P.</div><div class="date">8th December 2005, 20:07</div></div><div class="posttext">Hi - I've run into a little problem.<br />
<br />
I have a few installers, that write a few things to the registry, both HKLM and HKCU.<br />
<br />
Since some of my 'clients' don't always uninstall using the uninstaller, but just remove the program, the registry entries remain. So I have made a 'cleaner' file that searches the 'client's' registry for my strings, and deletes them if he/she wants to. The client can use that cleaner file if he/she hasn't properly uninstalled using my uninstaller.<br />
<br />
However...<br />
<br />
Some time ago, a client e-mailed me, saying he couldn't reinstall my installer because there were some old registry strings still present. It turned out that somehow (I have no idea how), the HKLM string had been deleted, but the HKCU string was still there. <br />
<br />
So - I updated my 'cleaner' file so that it would look for the HKCU string as well(it didn't do that originally, because I didn't think it necessary). The cleaner file works in a way that if it detects the registry strings, a checkbox will appear on the install options page, and you can then check the checkbox and it will then remove the registry entries when you execute the cleaner file.<br />
<br />
But - he wrote back again, saying that the cleaner file still didn't show the checkbox for that installer.<br />
<br />
So I opened the script of the cleaner file, and looked through it. I then removed the HKLM search from it, leaving only the search for the HKCU strings.<br />
<br />
Compiled, but as my client had experienced, the checkbox now didn't turn up (it did turn up when searching for the HKLM string).<br />
<br />
What I find strange about that, is that on my computer, I am the only user, and I'm admin.<br />
<br />
So why won't the installer read from HKCU? Is this a known thing?<br />
<br />
I have checked and doublechecked the script, and the name of the string against the one directly from the registry, but I can't find anything wrong there.<br />
<br />
<br />
My 'cleaner' file has lots of Sections that are UnSelected if the registry strings aren't found. In other words, as mentioned, if the string is found, the checkbox for that application will appear, and you can then remove that application's registry entries by clicking 'Next'.<br />
<br />
Here's the code for the UnSelection part of the script (installer name is changed). I have only kep the HKCU part here:<br />
<br />
<br />
	<br />
ReadRegStr $0 HKCU &quot;Software\My_Installer.\Sections&quot; &quot;(Default)&quot;<br />
	StrCmp $0 &quot;&quot; +2<br />
	Goto next<br />
		!insertmacro UnselectSection ${Sec00}<br />
		SectionSetText ${Sec00} &quot;&quot;<br />
<br />
;some more strings are searched for here<br />
<br />
        next:<br />
<br />
It finds the HKLM part(that isn't shown here) just fine, but not the HKCU part.<br />
<br />
So again, my question is: Is there something wrong with my script anyway, or with the way I have written the name, or isn't it possible to read from HKCU at all?<br />
<br />
I am right in thinking that the +2 only jumps over Goto next, right?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Anders</div><div class="date">8th December 2005, 20:15</div></div><div class="posttext">to get the default value, use &quot;&quot; and not &quot;(Default)&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">John P.</div><div class="date">8th December 2005, 20:31</div></div><div class="posttext">*Oops* -Is it really that easy? <br />
OK, thanks - I'll try that! :)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">8th December 2005, 20:34</div></div><div class="posttext">Perhaps a note should be made about this in the documentation for ReadRegStr.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">John P.</div><div class="date">8th December 2005, 20:37</div></div><div class="posttext">Hmm...<br />
<br />
Changed the code to:<br />
<br />
<br />
	ReadRegStr $0 HKCU &quot;Software\My_Installer.\Sections&quot; &quot;&quot;<br />
	StrCmp $0 &quot;&quot; +2<br />
	Goto next<br />
		!insertmacro UnselectSection ${Sec00}<br />
		SectionSetText ${Sec00} &quot;&quot;<br />
<br />
        next:<br />
<br />
(in other words substituted &quot;(Default)&quot; with &quot;&quot;), and the checkbox still doesn't show up in the installer. It does show when using the same code, but for the HKLM string.<br />
<br />
The HKLM string looks like this:<br />
<br />
HKLM &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\My_Installer.&quot; &quot;UninstallString&quot;<br />
<br />
<br />
If I change &quot;Uninstallstring&quot; with &quot;&quot; there, it doesn't find that either. But as it is, with &quot;Uninstallstring&quot; at the end, it finds it, and displays the checkbox.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">John P.</div><div class="date">8th December 2005, 20:51</div></div><div class="posttext">Ah...<br />
<br />
For some reason, it works if I remove the 'Sections' thread part.<br />
<br />
In other words, if I tell it to look for:<br />
<br />
HKCU &quot;Software\My_Installer.&quot; &quot;&quot;<br />
<br />
it works.<br />
<br />
Any idea why it doesn't when I make it look &quot;through&quot; the Sections thread?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">John P.</div><div class="date">9th December 2005, 16:16</div></div><div class="posttext">-I still need some help here.<br />
<br />
It's as if it won't read the subkey. It will read/find the main key, but not the subkey.<br />
<br />
This is a test script I'm using while I test this (installer name changed):<br />
<br />
<br />
Name &quot;HKCU test&quot;<br />
OutFile &quot;HKCU test.exe&quot;<br />
<br />
Section &quot;&quot;<br />
	ReadRegStr $0 HKCU &quot;Software\My very nice installer.\Sections&quot; &quot;&quot;<br />
	StrCmp $0 &quot;&quot; +3<br />
	MessageBox MB_OK &quot;The string was found.&quot;<br />
	Goto End<br />
        MessageBox MB_OK &quot;The string was not found.&quot;<br />
        End:<br />
SectionEnd<br />
<br />
<br />
;Actual registry string as exported from the registry:<br />
<br />
;[HKEY_CURRENT_USER\Software\My very nice installer.\Sections]<br />
<br />
<br />
It will only display the &quot;The string was found.&quot; messagebox if I remove the \Sections part. But I need it to be included in the search. As it is (code above), it displays the &quot;The string was not found.&quot; messagebox.<br />
<br />
Is there any other way to write that subkey in there? I have tried to divide it into two, and having &quot;Sections&quot; after the name of the installer, but that didn't work either.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">9th December 2005, 18:40</div></div><div class="posttext">What is the value of $0?<br />
Are you checking if the key exists or the value?<br />
If you're checking for the key, use IfErrors (with ClearErrors before using ReadRegStr).<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">John P.</div><div class="date">9th December 2005, 19:29</div></div><div class="posttext">I was of the impression that the key would be put into the variable $0, and that I could then use the value to see if the string is there.<br />
<br />
I have done that many times with other registry strings(HKLM mainly), and it has worked well.<br />
<br />
If I for instance replace the registry string in the example above with another string (in HKLM), then the &quot;The string was found.&quot; messagebox pops up. Which I interpret as 'string found'.<br />
<br />
Since the example/testing script is so small, why would $0 be anything but the registry string? Nothing else is &quot;going on&quot; in the script. No other values/variables etc. I mean.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">9th December 2005, 20:07</div></div><div class="posttext">The only reason it could skip the code is if the value of $0 is &quot;&quot;, meaning that you have no value set in the default &quot;&quot; key name.<br />
<br />
If there is a value present, then the only thing that I can guess which may cause a problem is that you have a full stop on the end of one of the registry folder names. Perhaps removing that may fix the problem, unless that doesn't exist in your main script.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">John P.</div><div class="date">9th December 2005, 20:15</div></div><div class="posttext">Thanks for the help. I suddenly understand a bit more of how it all works now.<br />
<br />
It turned out that I am trying to read a registry key that has no value ( (value not set) ), so of course there's nothing returned. <br />
<br />
I think I can work it out from here.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>