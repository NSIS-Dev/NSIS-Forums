<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Issues while validating license key online via installer, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Issues while validating license key online via installer NSIS Discussion" />
	
	<title> Issues while validating license key online via installer [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Issues while validating license key online via installer</div>
<hr />
<div class="pda"><a href="t-297756.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=297756">Issues while validating license key online via installer</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">pankajch82</div><div class="date">23rd September 2008, 16:12</div></div><div class="posttext">HI , Have attached the script ...when i enter the correct key , it still shows Invalid key .<br />
<br />
URL :http://pnilyaoverseas.com/pankaj/test.php?test=aaaaa-aaaaa-aaaaa-aaaaa-aaaaa<br />
<br />
SO correct key :aaaaa-aaaaa-aaaaa-aaaaa-aaaaa<br />
<br />
Regards<br />
Pankaj</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pankajch82</div><div class="date">23rd September 2008, 16:30</div></div><div class="posttext">Sorry attached the wrong file , find the correct one.<br />
<br />
Thanks</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">23rd September 2008, 20:34</div></div><div class="posttext">You may wish to check your PHP code.  The file that gets downloaded reads 'INVALID', itself.<br />
<br />
P.S. you've got a typo.. slient -&gt; silent</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pankajch82</div><div class="date">24th September 2008, 10:36</div></div><div class="posttext">Attaching the php too .<br />
<br />
But when i try from browser it returns &quot;VALID&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Animaether</div><div class="date">24th September 2008, 13:50</div></div><div class="posttext">try adding the value that the PHP appears to get ($_GET['test']) to the output, or use one of the PHP debug print statements.. I don't have a PHP server up and running anywhere, but I'm guessing that it's not getting what you think it's getting from the POST command</div></div><hr />


<div class="post"><div class="posttop"><div class="username">dandaman32</div><div class="date">24th September 2008, 14:57</div></div><div class="posttext">Here's what you'd want to do:<br />
<br />
First of all, good thing you're taking measures to prevent SQL injection. However there's a much easier way to go about it:<br />
<br />
<br />
&lt;?php<br />
define('HOSTNAME', 'localhost');<br />
define('USERNAME', 'indiamm_test');<br />
define('PASSWORD', 'test');<br />
define('DATABASE_NAME', 'indiamm_pankaj');<br />
define('RESPONSE_KEY', '4PdUAoeGZ9Tq*1bpI]Le4P!{MsXUtqzR]p!T%++xf2&amp;wbb4ISe7jGoIAQAusMw,j');<br />
<br />
$db = mysql_connect(HOSTNAME, USERNAME, PASSWORD) OR die ('I cannot connect to MySQL.');<br />
if ( !mysql_select_db(DATABASE_NAME) )<br />
{<br />
  die('Unable to select database.');<br />
}<br />
<br />
$key = ( isset($_GET['key']) ) ? mysql_real_escape_string($_GET['key']) : '';<br />
if ( empty($key) )<br />
  die('INVALID');<br />
<br />
$result = mysql_query(&quot;SELECT status FROM key WHERE id = '$key';&quot;);<br />
if ( !$result )<br />
{<br />
  die('INVALID');<br />
}<br />
<br />
// check if records were returned<br />
if ( mysql_num_rows($result) &gt; 0 )<br />
{<br />
  // this hash will be unique among all installers.<br />
  $hash = md5($_GET['test'] . RESPONSE_KEY);<br />
  echo &lt;&lt;&lt;EOF<br />
[result]<br />
status=valid<br />
hash=$hash<br />
EOF;<br />
}<br />
else<br />
{<br />
  echo &lt;&lt;&lt;EOF<br />
[result]<br />
status=invalid<br />
hash=<br />
EOF;<br />
}<br />
@mysql_free_result($result);<br />
<br />
mysql_close($db);<br />
<br />
?&gt;<br />
<br />
I should warn you that simply fetching a URI is a highly un-trustworthy operation. It would be trivial for someone to fuss around with their hosts file and point the installer to a different license server through DNS spoofing. If you hardcode the IP address, that can still be changed by working with the host computer's routing tables. The only way to ensure a secure response is to use a primitive sort of digital signature to ensure that the response came from a trusted server.<br />
<br />
Warning: reverse-engineering of the installer can still crack this! I use a very similar scheme for some of my projects.<br />
<br />
The way you would do this is by echoing back a hash that was created from the key (ensuring that each response is unique) and also contains a (hashed) unique, global key shared among your license validation script and all your installers. A sample is shown above. Here's how you would go about validating this with NSIS:<br />
<br />
<br />
!define RESPONSE_KEY '4PdUAoeGZ9Tq*1bpI]Le4P!{MsXUtqzR]p!T%++xf2&amp;wbb4ISe7jGoIAQAusMw,j'<br />
<br />
Function ValidateLicense<br />
  Exch $0<br />
  Push $1<br />
  Push $2<br />
  Push $3<br />
  Push $4<br />
  GetTempFileName $1<br />
  nsisdl::download_quiet &quot;http://yoursite.com/checklicense.php?key=$0&quot; $1<br />
  ReadINIStr $2 $1 &quot;result&quot; &quot;status&quot;<br />
  StrCpy $4 &quot;invalid&quot;<br />
  StrCmp $2 &quot;valid&quot; &quot;&quot; done<br />
    ; remote server claims the key is valid<br />
    ; $2 = hash from server - untrusted<br />
    ReadINIStr $2 $1 &quot;result&quot; &quot;hash&quot;<br />
    ; $3 = the correct hash<br />
    DCryptDll::MD5Hash &quot;SS&quot; &quot;$0${RESPONSE_KEY}&quot; &quot;--End--&quot;<br />
    Pop $3<br />
    ; make sure DCryptDll didn't error out<br />
    StrCmp $3 &quot;OK&quot; &quot;&quot; done<br />
    Pop $3<br />
    StrCmp $2 $3 &quot;&quot; done<br />
      ; hash is valid<br />
      StrCpy $4 &quot;valid&quot;<br />
  done:<br />
  Delete $1<br />
  Pop $4<br />
  Pop $3<br />
  Pop $2<br />
  Pop $1<br />
  Exch $0<br />
FunctionEnd<br />
<br />
<br />
This is untested code as I'm currently on a Linux system and lack the resources to test, but I believe it should work. Hopefully this will give you an idea of how a server's response can be fully authenticated.<br />
<br />
--Dan</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>