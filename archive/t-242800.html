<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Using chngvrbl.dll to set $PLUGINSDIR, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Using chngvrbl.dll to set $PLUGINSDIR NSIS Discussion" />
	
	<title> Using chngvrbl.dll to set $PLUGINSDIR [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Using chngvrbl.dll to set $PLUGINSDIR</div>
<hr />
<div class="pda"><a href="t-242800.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=242800">Using chngvrbl.dll to set $PLUGINSDIR</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">6th April 2006, 16:52</div></div><div class="posttext">I am trying to use chngvrbl.dll to set the $PLUGINSDIR variable. The reason for this is my program runs on a USB keychain, and I don't want it to write any files to the hard drive, not even temporarily. I want them all on the USB drive.<br />
<br />
However, I am less than brilliant at NSIS, and I could use some help. The code seems to only work for chngvrbl.dll, the other DLLs I call are all still written to the c:..\temp dir. So this implies that $PLUGINSDIR is not actually being changed:<br />
<br />
ProfileFound: <br />
StrCpy $9 &quot;$EXEDIR&quot;<br />
SetOutPath $9<br />
File /oname=$9\chngvrbl.dll ${NSISDIR}\Plugins\chngvrbl.dll&quot;<br />
Push $9<br />
Push 25 <br />
CallInstDLL &quot;$9\chngvrbl.dll&quot; changeVariable<br />
<br />
LaunchProgram:<br />
ExecDos::exec /NOUNLOAD /ASYNC `&quot;$TORDIRECTORY\tor.exe&quot; -f &quot;$TORDIRECTORY\torrc&quot;`<br />
FindProcDLL::FindProc &quot;firefox.exe&quot;<br />
<br />
<br />
ExecDos and FindProcDLL are still being written to C:, solution? What am I doing wrong?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">6th April 2006, 18:05</div></div><div class="posttext">Well it would be better probably to use CallInstDll to call all the other plugins as well.<br />
You'll have to make a modified copy of Modern UI's Contrib\Modern UI\System.nsh and change it all in there as well. Modern UI also places ioSpecial.ini in there as well, so you could probably just replace $PLUGINSDIR with a different variable and remove any InitPluginsDir instructions. Sounds like a lot of work, but at the end of the day it's less installer overhead.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">6th April 2006, 18:24</div></div><div class="posttext">I think what I'm using is already modified for this specific purpose. I just can't seem to implement it correctly. Here is the thread:<br />
http://forums.winamp.com/showthread.php?s=&amp;threadid=179738&amp;highlight=%24pluginsdir<br />
<br />
Here is the file:<br />
http://nsis.sourceforge.net/wiki/Change_Variable_Plugin</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">6th April 2006, 18:58</div></div><div class="posttext">Try calling InitPluginsDir before StrCpy $9 &quot;$EXEDIR&quot;<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">6th April 2006, 19:30</div></div><div class="posttext">Still not working. It is like $PLUGINSDIR isn't getting changed at all. Only that CallIstDLL is writing chngvrbl.dll to $9. <br />
<br />
		InitPluginsDir<br />
<br />
		StrCpy $9 &quot;$EXEDIR&quot;<br />
		SetOutPath $9<br />
	        File /oname=$9\chngvrbl.dll &quot;${NSISDIR}\Plugins\chngvrbl.dll&quot;<br />
        	Push $9<br />
		Push 25 ; $PLUGINSDIR<br />
		CallInstDLL &quot;$9\chngvrbl.dll&quot; changeVariable<br />
		File /oname=$PLUGINSDIR\splash.jpg &quot;${NAME}.gif&quot;<br />
		newadvsplash::show /NOUNLOAD 16000 400 400 -1 /L $PLUGINSDIR\splash.jpg</div></div><hr />


<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">6th April 2006, 19:36</div></div><div class="posttext">InitPluginsDir has no effect.<br />
After having the message box popup, it still tells me it is in the c: temp:<br />
<br />
StrCpy $9 &quot;$EXEDIR&quot;<br />
SetOutPath $9<br />
File /oname=$9\chngvrbl.dll &quot;${NSISDIR}\Plugins\chngvrbl.dll&quot;<br />
Push $9<br />
Push 25 ; $PLUGINSDIR<br />
CallInstDLL &quot;$9\chngvrbl.dll&quot; changeVariable<br />
MessageBox MB_OK|MB_ICONINFORMATION `The Pluginsdir is now $PLUGINSDIR`</div></div><hr />


<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">6th April 2006, 19:48</div></div><div class="posttext">Infact, the Pluginsdir is C:\DOCUME~1\...\Temp\nsq8C1.tmp<br />
<br />
It seems that it is compiling as a solid file, instead of a directory. But wait, I checked the compiler and I am only using regular compression, not solid compression. So it should be decompressing into a file. So I checked the script, there is no set compression in there either. So... why is it writing a compressed directory as a file?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">galil</div><div class="date">6th April 2006, 20:00</div></div><div class="posttext">Um, do the <br />
InitPluginsDir<br />
right after you call the chngvrbl.dll to change the $PLUGINSDIR.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">6th April 2006, 20:14</div></div><div class="posttext">%TEMP%\nsq8C1.tmp is a directory. Directory names can half dots in as well :p<br />
<br />
galil is correct. If you place InitPluginsDir right after the plugin call, $PLUGINSDIR will be set to [my path]\ns####.tmp<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">6th April 2006, 20:32</div></div><div class="posttext">chgvrbl.dll is written to $EXEDIR, but splash and the rest of my files are still written to C:\%TEMP%<br />
<br />
And messagebox still says $PLUGINSDIR is %TEMP%<br />
<br />
	ProfileFound:<br />
		;=== Show the splash screen before processing the files<br />
<br />
		StrCpy $9 &quot;$EXEDIR&quot;<br />
		SetOutPath $9<br />
	        File /oname=$9\chngvrbl.dll &quot;${NSISDIR}\Plugins\chngvrbl.dll&quot;<br />
        	Push $9<br />
		Push 25 ; $PLUGINSDIR<br />
		CallInstDLL &quot;$9\chngvrbl.dll&quot; changeVariable<br />
		InitPluginsDir<br />
		MessageBox MB_OK|MB_ICONINFORMATION `The Pluginsdir is now $PLUGINSDIR`<br />
<br />
		File /oname=$PLUGINSDIR\splash.jpg &quot;${NAME}.gif&quot;<br />
		newadvsplash::show /NOUNLOAD 16000 400 400 -1 /L $PLUGINSDIR\splash.jpg</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">6th April 2006, 20:35</div></div><div class="posttext">I guess you've got the code in the wrong place. I'm guessing that Modern UI calls InitPluginsDir internally as well. If InitPluginsDir is called before your code snippet then no doubt it won't work. Where are you using your code? Move it to .onInit.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">6th April 2006, 20:59</div></div><div class="posttext">It has been moved to the beginning, right after the variables and before the main section. $PLUGINSDIR is still %TEMP%.<br />
<br />
...<br />
Var INIPATH<br />
Var ISFILELINE<br />
<br />
<br />
Function .onInit<br />
<br />
		 StrCpy $9 &quot;$EXEDIR&quot;<br />
		 SetOutPath $9<br />
	         File /oname=$9\chngvrbl.dll &quot;${NSISDIR}\Plugins\chngvrbl.dll&quot;<br />
        	 Push $9<br />
		 Push 25 ; $PLUGINSDIR<br />
		 InitPluginsDir<br />
		 CallInstDLL &quot;$9\chngvrbl.dll&quot; changeVariable<br />
		 MessageBox MB_OK|MB_ICONINFORMATION `The Pluginsdir is now $PLUGINSDIR`<br />
<br />
FunctionEnd<br />
<br />
Section &quot;Main&quot;<br />
	;=== Find the INI file, if there is one<br />
		IfFileExists &quot;$EXEDIR\${NAME}.ini&quot; &quot;&quot; CheckSubINI<br />
			StrCpy &quot;$INIPATH&quot; &quot;$EXEDIR\&quot;<br />
			Goto ReadINI<br />
....</div></div><hr />


<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">6th April 2006, 21:06</div></div><div class="posttext">InitPluginsDir was the problem. Don't need it!<br />
<br />
Function .onInit<br />
		StrCpy $9 &quot;$EXEDIR&quot;<br />
		SetOutPath $9<br />
	        File /oname=$9\chngvrbl.dll &quot;${NSISDIR}\Plugins\chngvrbl.dll&quot;<br />
        	Push $9<br />
		Push 25 ; $PLUGINSDIR<br />
		CallInstDLL &quot;$9\chngvrbl.dll&quot; changeVariable<br />
		MessageBox MB_OK|MB_ICONINFORMATION `The Pluginsdir is now $PLUGINSDIR`<br />
FunctionEnd<br />
<br />
It works! Thanks for the help. I just needed to make sure it was inside .onInit, and that InitPluginsDir was never called.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">6th April 2006, 21:34</div></div><div class="posttext">Well in the code you posted last you did have InitPluginsDir before the plugin call instead of after it. :p<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">7th April 2006, 11:08</div></div><div class="posttext">InitPluginsDir creates and sets $PLUGINSDIR. If you set it yourself, you don't need to call InitPluginsDir. However, variable number 25 is $TEMP and not $PLUGINSDIR, so you do need InitPluginsDir in order for $PLUGINSDIR to be created in your newly set $TEMP. $PLUGINSDIR is actually number 26, but it's a good thing that you set $TEMP and not $PLUGINSDIR. If you'd have set $PLUGINSDIR to $EXEDIR, $EXEDIR would have been deleted at the end of the installation. When you set $TEMP to $EXEDIR, InitPluginsDir will create a new folder inside $EXEDIR.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">12th April 2006, 02:55</div></div><div class="posttext">Now when I call a execdos plugin to run tor.exe, tor terminates instantly. If I remove the pluginsdir code<br />
change, everything is normal again. Seems like the $PLUGINSDIR change code must have something wrong. Any ideas? (nsi included)<br />
<br />
the tor.exe log:<br />
<br />
Apr 11 20:22:18.640 [notice] Tor v0.1.1.14-alpha. This is experimental software. Do not rely on it for strong anonymity.<br />
Apr 11 20:22:18.640 [notice] Initialized libevent version 1.1a+imweasel using method win32. Good.<br />
Apr 11 20:22:18.640 [warn] Error creating directory tor\data: No such file or directory<br />
Apr 11 20:22:18.640 [err] options_act_reversible(): Couldn't access/create private data directory &quot;tor\data&quot;<br />
Apr 11 20:22:18.640 [err] tor_init(): Reading config failed--see warnings above. For usage, try -h.<br />
<br />
<br />
Here is my code to call tor.exe:<br />
<br />
ExecDos::exec /NOUNLOAD /ASYNC `&quot;$EXEDIR\tor\tor.exe&quot; -f &quot;$EXEDIR\tor\torrc&quot;` &quot;&quot; &quot;$EXEDIR\execdos.log&quot; ; Launch Tor<br />
<br />
<br />
Here is my code for the pluginsdir change:<br />
<br />
Function .onInit<br />
StrCpy $9 &quot;$EXEDIR\temp&quot;<br />
SetOutPath $9<br />
File /oname=$9\chngvrbl.dll &quot;${NSISDIR}\Plugins\chngvrbl.dll&quot;<br />
Push $9<br />
Push 26 ; $PLUGINSDIR<br />
CallInstDLL &quot;$9\chngvrbl.dll&quot; changeVariable<br />
FunctionEnd</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">12th April 2006, 11:10</div></div><div class="posttext">Try putting SetOutPath '$EXEDIR\tor' before ExecDos::exec.<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">13th April 2006, 06:40</div></div><div class="posttext">Everything seemed to work out well. But occaisonally when I terminate the program, I get this error:<br />
<br />
&quot;The instruction at '0x0101130e' referenced memory at '0x0101130e'. The memory could not be 'read'.<br />
<br />
Click on OK to terminate the program<br />
Click on CANCEL to debug the program&quot;<br />
<br />
When I click cancel, nothing seems to happen. Ideas on how to debug or find out where it is coming from?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">13th April 2006, 10:23</div></div><div class="posttext">Why are you terminating the program or are you trying to close it safely?<br />
<br />
-Stu</div></div><hr />


<div class="post"><div class="posttop"><div class="username">torpark</div><div class="date">13th April 2006, 14:54</div></div><div class="posttext">I figured it out. The last plugin I executed used NOUNLOAD and I was forcing it to unload. Problem fixed by calling it again without nounload and async.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Brummelchen</div><div class="date">30th August 2008, 18:35</div></div><div class="posttext">That DLL is not working with NSIS 2.37<br />
;NSIS Modern User Interface version 1.70<br />
;Basic Example Script<br />
;Written by Joost Verburg<br />
<br />
;--------------------------------<br />
;Include Modern UI<br />
<br />
  !include &quot;MUI.nsh&quot;<br />
<br />
;--------------------------------<br />
;General<br />
<br />
  ;Name and file<br />
  Name &quot;Modern UI Test 1.70&quot;<br />
  OutFile &quot;Basic.exe&quot;<br />
<br />
  ;Default installation folder<br />
  InstallDir &quot;$EXEDIR&quot;<br />
  <br />
;--------------------------------<br />
;Interface Settings<br />
<br />
  !define MUI_ABORTWARNING<br />
<br />
;--------------------------------<br />
;Pages<br />
<br />
  !insertmacro MUI_PAGE_COMPONENTS<br />
  !insertmacro MUI_PAGE_DIRECTORY<br />
  !insertmacro MUI_PAGE_INSTFILES<br />
  <br />
  !insertmacro MUI_RESERVEFILE_INSTALLOPTIONS<br />
  <br />
;--------------------------------<br />
;Languages<br />
 <br />
  !insertmacro MUI_LANGUAGE &quot;English&quot;<br />
  <br />
Function .onInit<br />
<br />
  ; Use whatever you use to get the user defined temp parameter from $CMDLINE<br />
  ;Push &quot;/TEMP=&quot;<br />
  ;Call GetParam<br />
  ;Pop $0<br />
  StrCpy $0 &quot;c:\usertemp&quot;<br />
<br />
  ; If the user doesn't pass a parameter just let NSIS determine the $PLUGINSDIR<br />
  StrCmp $0 &quot;&quot; nousertemp usertemp<br />
     usertemp:<br />
         SetOutPath $0<br />
         File /oname=$0\chngvrbl_.dll &quot;${NSISDIR}\Plugins\chngvrbl.dll&quot;<br />
         Push $0<br />
         Push 25 ; $PLUGINSDIR<br />
         CallInstDLL &quot;$0\chngvrbl_.dll&quot; changeVariable<br />
         Delete &quot;$0\chngvrbl_.dll&quot;<br />
         Goto show<br />
     nousertemp:<br />
         InitPluginsDir<br />
     show:<br />
     MessageBox MB_OK|MB_ICONINFORMATION &quot;Pluginsdir: '$PLUGINSDIR'&quot;<br />
<br />
FunctionEnd<br />
<br />
;--------------------------------<br />
;Installer Sections<br />
<br />
Section &quot;Dummy Section&quot; SecDummy<br />
<br />
  SetOutPath &quot;$INSTDIR&quot;<br />
  <br />
  ;ADD YOUR OWN FILES HERE...<br />
  <br />
  ;Store installation folder<br />
  ;WriteRegStr HKCU &quot;Software\Modern UI Test&quot; &quot;&quot; $INSTDIR<br />
  <br />
  ;Create uninstaller<br />
  ;WriteUninstaller &quot;$INSTDIR\Uninstall.exe&quot;<br />
<br />
SectionEnd<br />
<br />
;--------------------------------<br />
;Descriptions<br />
<br />
  ;Language strings<br />
  LangString DESC_SecDummy ${LANG_ENGLISH} &quot;A test section.&quot;<br />
<br />
  ;Assign language strings to sections<br />
  !insertmacro MUI_FUNCTION_DESCRIPTION_BEGIN<br />
    !insertmacro MUI_DESCRIPTION_TEXT ${SecDummy} $(DESC_SecDummy)<br />
  !insertmacro MUI_FUNCTION_DESCRIPTION_END<br />
<br />
;--------------------------------<br />
<br />
Return-Value is empty :(</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Brummelchen</div><div class="date">31st August 2008, 03:30</div></div><div class="posttext">#edit after above<br />
i reinstalled nsis to get the original stubs and makensis.exe <br />
- i use the 8192 bytes version. the script above does not work,<br />
but mine do. why? at first - its not at the 8192 version, that <br />
works too - its the InitPluginsDir after that.<br />
first i had this:<br />
Function plugins_dir<br />
  StrCpy $0 &quot;$EXEDIR&quot;<br />
  StrCmp $0 &quot;&quot; nousertemp<br />
    SetOutPath $0<br />
    File /oname=$0\chngvrbl.dll &quot;${NSISDIR}\Plugins\chngvrbl.dll&quot;<br />
    Push $0<br />
    Push 25 ; $PLUGINSDIR<br />
    CallInstDLL &quot;$0\chngvrbl.dll&quot; changeVariable<br />
    Delete &quot;$0\chngvrbl.dll&quot;<br />
    StrCmp $PLUGINSDIR &quot;&quot; nousertemp<br />
    Return<br />
  nousertemp:<br />
    InitPluginsDir<br />
FunctionEnd<br />
<br />
now i have that<br />
Function plugins_dir<br />
  StrCpy $0 &quot;$EXEDIR&quot;<br />
  StrCmp $0 &quot;&quot; nousertemp<br />
    SetOutPath $0<br />
    File /oname=$0\chngvrbl.dll &quot;${NSISDIR}\Plugins\chngvrbl.dll&quot;<br />
    Push $0<br />
    Push 25 ; $PLUGINSDIR<br />
    CallInstDLL &quot;$0\chngvrbl.dll&quot; changeVariable<br />
    Delete &quot;$0\chngvrbl.dll&quot;<br />
  nousertemp:<br />
    InitPluginsDir<br />
FunctionEnd<br />
<br />
the content of pluginsdir is why ever emtpy after the change, <br />
but after InitPluginsDir it has the right pointer to the subdir.<br />
<br />
In contrast to written<br />
InitPluginsDir was the problem. Don't need it!<br />
its needed.<br />
<br />
Can someone explain it please?</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>