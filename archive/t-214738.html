<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" installing an older version of a system DLL?, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  installing an older version of a system DLL? NSIS Discussion" />
	
	<title> installing an older version of a system DLL? [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  installing an older version of a system DLL?</div>
<hr />
<div class="pda"><a href="t-214738.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=214738">installing an older version of a system DLL?</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">haigha</div><div class="date">2nd May 2005, 19:51</div></div><div class="posttext">I am trying to find a way to get NSIS to install an older version of a system DLL.  The reason is that DirectShow's latest debug DLLs do not match the versions of the DLLs in XP SP2.  I have found an article explaining how to manually disable WFP so that these DLLs can be replaced but I would rather have an installer do it.<br />
<br />
Deleting the file manually and having an NSIS installer uninstall it with doesn't work because of WFP.<br />
<br />
Here is the command I tried:<br />
<br />
!insertmacro InstallLib REGDLL NOTSHARED REBOOT_NOTPROTECTED debug\quartz.dll $SYSDIR\quartz.dll $SYSDIR<br />
<br />
but this doesn't work because the current version is newer.<br />
<br />
I found the information on the ability to call a system DLL in the Help file and found some information about disabling WFP here:<br />
<br />
http://www.bitsum.com/aboutwfp.asp<br />
<br />
Is there a way to use System::Call to call:<br />
<br />
SetSfcFileException(0, L&quot;c:\\windows\\system32\quartz.dll&quot;,-1);<br />
<br />
is SFC_OS.DLL?<br />
<br />
I noticed that the System:Call docs talk about strings as parameters but not wide strings.  It would obviously be better if the Windows system path used $SYSDIR instead of being hard coded.<br />
<br />
Or maybe there is a better technique than using SFC_OS?<br />
<br />
Thanks.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comperio</div><div class="date">3rd May 2005, 00:25</div></div><div class="posttext">You can start introducing stability problems in the target system if you start messing with system DLL's.  This is the whole reason behind Windows' system file protection in the first place.  <br />
<br />
But, even though you might not be able to replace the system DLL, you may be able to include the old DLL in the same folder as the software's EXE.<br />
<br />
Here's a link from Microsoft that offers a few such tricks.  (There's a section called &quot;private dlls&quot; that I found especially interesting...):<br />
<br />
http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dnsetup/html/dlldanger1.asp</div></div><hr />


<div class="post"><div class="posttop"><div class="username">haigha</div><div class="date">3rd May 2005, 01:24</div></div><div class="posttext">Thanks for the response.<br />
<br />
I understand the risks of replacing system DLLs.  The quartz.dll is not an essential component for Windows boot and there are advantages to having the debug DLL there.<br />
<br />
I don't think the private DLL approach will work in this case because quartz.dll is a COM DLL and, AFAIK, there can only be one registered version on the system.<br />
<br />
In any case, I'm interested in bypassing WFP.  This is not for a customer deliverable installer.  The reason is that I would rather have an installer that turns off WFP temporarily for this one file instead of disabling and enabling it entirely.  This will make it easier to install and uninstall the debug DLL.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comperio</div><div class="date">3rd May 2005, 03:51</div></div><div class="posttext">I did some more research on the subject.  Alas, it appears as if Microsoft has disabled WFP on XP service pack 2.<br />
<br />
But, I did find at least one article from a 3rd party site explaining how to hack the setting, but in involves manually editing the sfc_os.dll file with a hex editor:<br />
http://www.windowsnetworking.com/articles_tutorials/Tweaking-XP-Windows-File-Protection-SP2.html<br />
<br />
USE AT YOUR OWN RISK!   :eek:</div></div><hr />


<div class="post"><div class="posttop"><div class="username">haigha</div><div class="date">3rd May 2005, 04:23</div></div><div class="posttext">In my original post, I linked to a site that explains WFP and how the SFC_OS.DLL has to be hacked to disable it.  They even have a tool to do it:<br />
<br />
http://www.bitsum.com/index.asp#WfpAdmin<br />
<br />
But what I am asking is how to replace a system DLL with an older version in an NSIS installer.  That is why I am posting on this forum.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Comperio</div><div class="date">3rd May 2005, 14:11</div></div><div class="posttext">Very sorry--I missed that first link.<br />
Unfortunatley, making system calls is one thing that I still haven't played with much.  :( <br />
<br />
You have striked my interest however, so I may try to play with it some just to see if I can do it.  <br />
<br />
(Sorry I couldn't be more help...)</div></div><hr />


<div class="post"><div class="posttop"><div class="username">haigha</div><div class="date">3rd May 2005, 15:00</div></div><div class="posttext">I appreciate your efforts :)  It seems MS has gone to great lengths to stop us from doing disabling WFP but in this case it is necessary to install the debug DLL.<br />
<br />
One thing that is not clear to me is if the call to SetSfcFileException can be made successfully from an installer.<br />
<br />
A problem I forsee is that there doesn't seem to be a facility to pass a wide char string into NSIS's System:Call.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">3rd May 2005, 20:28</div></div><div class="posttext">System::Call accepts wide char strings. Simply use the w type. There is an example usage in the readme that retrieves the current wallpaper. It uses a wide char string:System::Call &quot;$0-&gt;4(w .r2, i ${NSIS_MAX_STRLEN}, i 0)&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">haigha</div><div class="date">3rd May 2005, 20:42</div></div><div class="posttext">Thanks Kichik.  The docs I saw for System::Call didn't mention the 'w' type.<br />
<br />
Can you show me how to translate the following into a NSIS code with a System:Call using the SYSDIR variable for the path to quartz.dll?  I find the syntax for this feature confusing and since I don't know if the call will work anyway it will be hard to debug.<br />
<br />
SetSfcFileException(0, &quot;c:\\windows\\system32\quartz.dll&quot;,-1);<br />
<br />
the system DLL is SFC_OS.DLL.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">3rd May 2005, 20:58</div></div><div class="posttext">Take a look at the updated System documentation. If you don't have it at Contrib\System\System.html becuase you're using an old version, you can view it at:<br />
<br />
http://cvs.sourceforge.net/viewcvs.py/*checkout*/nsis/NSIS/Contrib/System/System.html</div></div><hr />


<div class="post"><div class="posttop"><div class="username">haigha</div><div class="date">3rd May 2005, 21:35</div></div><div class="posttext">Thanks for the pointer.  I hadn't seen that document.  This is what I have in my installer:<br />
<br />
  System::Call 'SFC_OS::SetSfcFileException(i 0, w &quot;c:\windows\system32\quartz.dll&quot;, i -1)'<br />
<br />
  Delete $SYSDIR\quartz.dll<br />
<br />
  !insertmacro InstallLib REGDLL NOTSHARED REBOOT_NOTPROTECTED XPSP1\quartz.dll $SYSDIR\quartz.dll $SYSDIR<br />
<br />
I can see that the quartz.dll is getting replaced with the older one but before five seconds have elapsed WFP is putting the old one back.<br />
<br />
Can you see anything obviously wrong or think of another way of achieving this?<br />
<br />
I appreciate the help.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">haigha</div><div class="date">3rd May 2005, 21:37</div></div><div class="posttext">&quot;I can see that the quartz.dll is getting replaced with the older one but before five seconds have elapsed WFP is putting the old one back.&quot;<br />
<br />
By &quot;old one back&quot; I mean WFP is replacing the older DLL with the SP2 dll.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">3rd May 2005, 21:42</div></div><div class="posttext">Get SetSfcFileException's return value and check if it failed or not.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">haigha</div><div class="date">3rd May 2005, 22:33</div></div><div class="posttext">System::Call &quot;SFC_OS::SetSfcFileException(i 0, w '%SystemRoot%/system32/quartz.dll', i 600000000) .r0&quot;<br />
<br />
  MessageBox MB_OK|MB_ICONINFORMATION &quot;Return value from SFC_OS: $0&quot;<br />
<br />
I've tried a bunch of things including changing the path.  Whe message box returns $0 as the text 'Error'.<br />
<br />
Does this mean that it couldn't call SetSfcFileException at all?<br />
<br />
Is there anything I need to do before using System::Call with it?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">haigha</div><div class="date">3rd May 2005, 23:18</div></div><div class="posttext">1.  I noticed that the original article I pointed to had both SfcFileException and SetSfcFileException.  I believe the former is correct but it may have been taken out of SP2's sfc_os.dll... I can't find it with a hex editor :(<br />
<br />
2.  I have found the SfcIsFileProtected call and it works. (returns 1 if it is protected and 0 if you pass in an unprotected file).  This may be useful to others.  Unfortunately it doesn't solve the problem I'm facing.<br />
<br />
Problems:<br />
<br />
SfcFileException is still returning &quot;error&quot; in the code $1<br />
<br />
<br />
  System::Call &quot;SFC_OS::SfcIsFileProtected(i 0, w 'c:\windows\system32\quartz.dll') i.r2&quot;<br />
  MessageBox MB_OK|MB_ICONINFORMATION &quot;Return value from SFC_OS: $2&quot;<br />
<br />
  System::Call &quot;SFC_OS::SfcFileException(i 0, w 'c:\windows\system32\quartz.dll', i -1) i.r2&quot;<br />
  MessageBox MB_OK|MB_ICONINFORMATION &quot;Return value from SFC_OS: $2&quot;</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">5th May 2005, 17:26</div></div><div class="posttext">You don't search for exported functions using a hex editor. That's what Dependency Walker (http://www.dependencywalker.com/) for. If SfcFileException and SetSfcFileException don't show in the exported functions list of SFC_OS, that would be the problem. In a basic System::Call usage, like in your case, that's the only possible cause for &quot;error&quot; to be returned.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">haigha</div><div class="date">5th May 2005, 18:57</div></div><div class="posttext">Thanks for the tip :)  I have used Depends to see dependent DLLs of a program before but didn't realize it showed the exported functions from a DLL.<br />
<br />
As you wrote, SfcFileException is no longer available.  Probably viewed as a security hole by MS.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">s793016</div><div class="date">16th May 2005, 18:41</div></div><div class="posttext">Sorry, my English is very very poor.<br />
<br />
I found something may useful at here (http://www.frame4.com/cms/stories/guides_&amp;_papers/windows_file_protection:_how_to_disable_it_on_the_fly_200411254795.html).<br />
<br />
Maybe some program master want to transform that code into an pug-in dll or an uneful function?<br />
<br />
Thanks for that.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>