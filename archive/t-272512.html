<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" $APPDATA directory creation failure under Vista, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  $APPDATA directory creation failure under Vista NSIS Discussion" />
	
	<title> $APPDATA directory creation failure under Vista [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  $APPDATA directory creation failure under Vista</div>
<hr />
<div class="pda"><a href="t-272512.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=272512">$APPDATA directory creation failure under Vista</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">billsh</div><div class="date">8th June 2007, 21:55</div></div><div class="posttext">I'm trying to create a folder under $APPDATA\FOO for some data files (CreateDirectory &quot;$APPDATA\test&quot;).  This fails on Vista, yet I can open a non-admin cmd window and MD that folder with no problems.  I can see the correct paths in the Details window so I know I'm in the right place.  It will say something like:<br />
<br />
Create folder: c:\Users\Bill\AppData\Roaming\test<br />
<br />
yet that folder doesn't exist after install.<br />
<br />
Is there a way to get win32-type error codes info from this failure?  I know it sets the error flag, is there any info stored in registers or variables after that flag is set?  I haven't found anything like that in the samples/forum (although I could be just be ignorant and not seeing it).  Most just seem to jump to a section that prints an error, but I haven't found any examples that give me something like GetLastError() would.<br />
<br />
Cheers!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">9th June 2007, 09:28</div></div><div class="posttext">There's no way to get the last error. Are you sure it really creates the right directory and you're not just in an elevated account where you actually create something like C:\Users\Admin\AppData\Roamin\test?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">GenRabbit</div><div class="date">10th June 2007, 13:26</div></div><div class="posttext">I have had the same problem, It runs smoothly under WinXp and generates a file as expected in the $appdata$ folder. But on Vista its no no. Its not being created.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">GenRabbit</div><div class="date">10th June 2007, 13:33</div></div><div class="posttext">Btw here is my installer script. just remove the files to isntall to test it on Vista or something.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pengyou</div><div class="date">10th June 2007, 17:27</div></div><div class="posttext">Creating a folder using $APPDATA\test works OK for me on Vista, using a &quot;standard&quot; account and an installer with RequestExecutionLevel set to &quot;user&quot;.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">GenRabbit</div><div class="date">11th June 2007, 00:48</div></div><div class="posttext">And how do I set RequestExecutionLevel to &quot;user&quot;. I don't have Vista, A friend runs it somewhere far away from me.<br />
Did it work with my installer?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pengyou</div><div class="date">11th June 2007, 01:28</div></div><div class="posttext">And how do I set RequestExecutionLevel to &quot;user&quot;Add the command to your installer script.<br />
<br />
See the NSIS User Manual:<br />
http://nsis.sourceforge.net/Docs/Chapter4.html#4.8.1.32</div></div><hr />


<div class="post"><div class="posttop"><div class="username">billsh</div><div class="date">12th June 2007, 15:43</div></div><div class="posttext">I've tried a few things, but still can't seem to create that sucker.  I've searched the disk and it doesn't appear that its being virtualized.  <br />
<br />
Here is a snippet of code:<br />
<br />
RequestExecutionLevel user (tried admin too)<br />
...<br />
<br />
 SetOutPath &quot;$INSTDIR&quot;<br />
 File /r &quot;DiskImage\*&quot;<br />
 <br />
; Move test.inf over to app data folder<br />
<br />
ClearErrors<br />
CreateDirectory &quot;$APPDATA\test&quot;<br />
Rename &quot;$INSTDIR\test.inf&quot; &quot;$APPDATA\test\test.inf&quot;<br />
IfErrors 0 +2<br />
DetailPrint &quot;CreateDirectory Failed&quot;<br />
<br />
<br />
I don't get the failure notice on CreateDirectory, so NSIS thinks it created the folder.  The rename call seems to point to the right files (c:\program files\test\test.inf -&gt; c:\users\&lt;me&gt;\AppData\Roaming\test\test.inf).  But I can't find that file/directory on the disk anywhere after.<br />
<br />
If I try to run Filemon to capture it I get gobs of random NSIS files accesses under c:\users by the setup process, but setup doesn't give me any UI - and the process is still running and can't be killed.  So much for being clever!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pengyou</div><div class="date">12th June 2007, 17:58</div></div><div class="posttext">Here is the script for the test program I used on my Vista system.<br />
; Using $APPDATA on Vista<br />
<br />
  RequestExecutionLevel   user<br />
<br />
  OutFile &quot;demo.exe&quot;<br />
  ShowInstDetails show<br />
<br />
Section<br />
	CreateDirectory   &quot;$APPDATA\demo&quot;<br />
SectionEndI logged in as the user &quot;Test&quot; and ran the demo.exe program. The details window showed<br />
<br />
Create folder: C:\Users\Test\AppData\Roaming\demo<br />
Completed<br />
<br />
and when I checked the &quot;demo&quot; folder had been created. I deleted the &quot;demo&quot; folder, re-ran the test and the folder got recreated.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">billsh</div><div class="date">12th June 2007, 22:29</div></div><div class="posttext">Thanks!  I can run your script and it works great.  However if I change user to admin/none it fails.  Do you see the same behavior?  <br />
<br />
I'll need admin to put files in Program Files of course.<br />
<br />
Cheers!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">pengyou</div><div class="date">12th June 2007, 23:23</div></div><div class="posttext">I changed the &quot;RequestExecutionLevel   user&quot; line in my script to &quot;RequestExecutionLevel   admin&quot; and recompiled it.<br />
<br />
I ran the revised program while logged in as the &quot;Test&quot; user and Vista asked me for the administrator password. After I entered the password the program created the &quot;demo&quot; folder in the administrator's &quot;AppData\Roaming&quot; folder.  I deleted the &quot;demo&quot; folder, re-ran the test and the folder got recreated.<br />
<br />
I logged in as the administrator and ran the revised program. It created the &quot;demo&quot; folder in the administrator's &quot;AppData\Roaming&quot; folder. I deleted the &quot;demo&quot; folder, re-ran the test and the folder got recreated.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">GenRabbit</div><div class="date">13th June 2007, 12:31</div></div><div class="posttext">Can the &quot;RequestExecutionLevel user&quot; be put anywhere in the installer? like just below the !define and !include ?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">billsh</div><div class="date">13th June 2007, 17:33</div></div><div class="posttext">I believe I've sorted out the main problem (pilot error).  The admin user name is a '.' different that the 'user' name, so first.last vs firstlast.  Sorry, missed that period in 1440x900 mode.  Beer fine for me.  And the folder search won't turn it up cause a user doesn't have perms to the admin data. <br />
<br />
So my final behavior is:<br />
<br />
Logon Admin:<br />
REL:user- no pw prompt.  created in appdata\user<br />
REL:admin - prompt.  created in appdata\admin<br />
<br />
Logon Std:<br />
REL:user - no prompt. created in appdata\user<br />
REL:admin - prompt. created in appdata\admin<br />
<br />
However, it does bring up another interesting question.  If you need admin level for copying files to c:\program files, but your app is run in std mode. How will the app find it's data?  Its copied to appdata\admin at install time vs appdata\user and the user can't see the admin's tree even if they knew where it was.<br />
<br />
I can't seem to find a best practice doc on this, but it must be a common issue as everyone is now supposed to not put data in Program Files.<br />
<br />
GenRabbit - you can put it up top with all the initial includes, etc.  It yelled at me if I put it in a section.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">13th June 2007, 19:16</div></div><div class="posttext">The best practice is to create the data files for a specific user from the program itself. The installer should only install global data files.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">billsh</div><div class="date">18th June 2007, 19:47</div></div><div class="posttext">Thanks Kichik!  What do people do about uninstall?  We'll have the same location ambiguity issue, but the app obviously won't know its being uninstalled.<br />
<br />
Cheers!</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">18th June 2007, 20:44</div></div><div class="posttext">You just leave the application data behind. If you really want to remove it, you can use EnumUsersReg (http://nsis.sourceforge.net/EnumUsersReg), but that's rarely done.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">99999999</div><div class="date">18th June 2007, 21:50</div></div><div class="posttext">One thing you might do, is to run the application that you want to run in user mode, using the Vista task manager.   I have to do this for a similar purpose with my application, otherwise the second time you run the application on Vista, it cannot write to $APPDATA because the directories created the  first time, were created with Administrator purposes.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">GenRabbit</div><div class="date">12th July 2007, 12:00</div></div><div class="posttext">So what your saying is that if you want to make anything install in C:\programfiles it has to install in Admin modus, billish?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">kichik</div><div class="date">12th July 2007, 17:29</div></div><div class="posttext">Of course. That's not even new for Vista.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">GenRabbit</div><div class="date">14th July 2007, 09:48</div></div><div class="posttext">Oki, I wasen't aware of that. neither on Vista or WindowsXP. but then again I'm always logged in with admin rights.</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>