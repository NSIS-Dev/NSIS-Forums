<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content=" Problem using COM in System::Call DLL with NSIS CreateShortCut, media player, mp3 player, music player, ipod sync, multimedia player, player, winamp, audio player" />
	<meta name="description" content="[Archive]  Problem using COM in System::Call DLL with NSIS CreateShortCut NSIS Discussion" />
	
	<title> Problem using COM in System::Call DLL with NSIS CreateShortCut [Archive]  - Winamp Forums</title>
	<link rel="stylesheet" type="text/css" href="archive.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar">Winamp Forums &gt; Developer Center &gt; <a href="f-65.html">NSIS Discussion</a> &gt;  Problem using COM in System::Call DLL with NSIS CreateShortCut</div>
<hr />
<div class="pda"><a href="t-319433.html?login=1" rel="nofollow">Log in</a></div>
<p class="largefont">Try the Internet Archive: <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=319433">Problem using COM in System::Call DLL with NSIS CreateShortCut</a></p>
<hr />

<div class="post"><div class="posttop"><div class="username">njshaw2</div><div class="date">25th May 2010, 15:22</div></div><div class="posttext">Hi,<br />
<br />
In the last week, some update to Microsoft Windows has caused this problem; I'm not sure of any way around it.  Prior to last week, my installer worked fine, but now when it runs it fails to create any shortcuts with CreateShortCut.<br />
<br />
Here's what I'm doing:<br />
0) Set up installer sections, MUI, etc.<br />
1) Load my own DLL using System::Call to call a function that initialises COM using COINIT_MULTITHREADED.<br />
2) Do stuff with the response to the DLL call.<br />
3) Install my files.<br />
4) Create shortcuts.<br />
<br />
If I don't call the DLL at all, the shortcuts get created.<br />
<br />
If I initialise COM using COINIT_APARTMENTTHREADED, all the shotcuts also get created fine.<br />
<br />
BUT if I initialise COM using COINIT_MULTITHREADED, the shortcuts subsequently fail to be created.  The return code from my call to CoInitializeEx() is RPC_E_CHANGED_MODE, meaning that the installer has initialised COM in the COINIT_APARTMENTTHREADED mode, presumably only for the shortcut creation (nothing else seems to be affected in the installer).<br />
<br />
Any ideas why this is going on (and why it's only just started happening last week)?  And is there any way I can work around it in the installer?  I'd prefer not to have to change my entire codebase to use APARTMENTTHREADED if I can avoid it. :)<br />
<br />
Thanks,<br />
Nick.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">njshaw2</div><div class="date">25th May 2010, 16:04</div></div><div class="posttext">I've solved this myself (sorry for bothering y'all!).  To explain why it was doing it:<br />
<br />
The installer uses OleInitalize() for its plugins, and OleInitialize() calls CoInitializeEx() using COINIT_APARTMENTTHREADED, so my call to CoInitializeEx() with MULTITHREADED was returning RPC_E_CHANGED_MODE.  I was then happily using the existing COM instance from OleInitialize() and incorrectly then closing COM in my DLL with CoUninitialize() which killed off the installer's plugins' OleInitialize().<br />
<br />
I've fixed the above now.  Again, apologies for the bother! :D</div></div><hr />


<div class="post"><div class="posttop"><div class="username">Afrow UK</div><div class="date">25th May 2010, 17:59</div></div><div class="posttext">No it's fine - that's valuable information for others.<br />
<br />
Stu</div></div><hr />


<div id="copyright">2001-2013 <a href="http://creativecommons.org/publicdomain/mark/1.0/" target="_blank">Public Domain Mark 1.0</a></div>
</div>
</body>
</html>