<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Check for OS version not working"><title>Check for OS version not working - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Check for OS version not working</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=222062">Check for OS version not working</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">ritesh</span><br><span class="post-time small text-muted">21st July 2005 09:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Check for OS version not working</strong><br>&nbsp; Hello,<br><br>I think I am doing some major screwup. I want on .dll to be installed only if its Win98, Win2K or WinMP. I use the following script.<br><br></p><pre>
<code>
Section "System Files (98 Only)" SecWin98
<br>  File "..\lib\gdiplus.dll"
<br>&gt;SectionEnd
<br><br>Section"System Files (ME Only)" SecWinME
<br>  File "..\lib\gdiplus.dll"
<br>&gt;SectionEnd
<br><br>Section"System Files (ME Only)" SecWin2K
<br>  File "..\lib\gdiplus.dll"
<br>&gt;SectionEnd 
<br>&gt;
</code>
</pre>Still it installs gdiplus.dll on WinXP box too! I know I am doing something stupid :(<br>
      <br>
      BTW, I have 2 more questions:<br>
      <br>
      1.) Is there any way to specify to install gdiplus.dll if the OS is not WinXP and Win2003?<br>
      <br>
      2.) Is there anyway to stop installation after showing a message if the OS is Win95?<br>
      <br>
      Thanks.
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Yathosho</span><br>
      <span class="post-time small text-muted">21st July 2005 11:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">from the excerpt of your script i can't help you. seems like don't check for the windows version, but leave it to the user. there's a funtion to get the windows version in the <a href="http://nsis.sourceforge.net/wiki/Detect_Windows_Version" target="_blank">Wiki</a>.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ritesh</span><br>
      <span class="post-time small text-muted">21st July 2005 11:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks.<br>
      <br>
      Find attached the script file. Maybe you can help me now with my problem.<br>
      <br>
      Basically I want to copy gdiplus.dll if its NOT WinXP and Win2K3.<br>
      <br>
      Also would like to stop installation when its Win95.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">21st July 2005 12:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Use the function that Yathosho gave you a link to.<br>
      <br>
      -Stu</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ritesh</span><br>
      <span class="post-time small text-muted">25th July 2005 16:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi<br>
      <br>
      I used the plugin and the function but still couldnt get the script working. Its getting compiled but GdiPLus.dll is getting installed irespective of the underlying OS.<br>
      <br>
      I am attaching the script file. Can somebody tell me whats the problem.<br>
      <br>
      Ritesh</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ritesh</span><br>
      <span class="post-time small text-muted">26th July 2005 09:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hello,<br>
      <br>
      I worked on it a little more and now I am correctly able to decide the OS and if the OS needs to have Gdiplus.dll installed, I am defining a macro INCLUDE_GDI<br>
      <br>
      e.g.<br>
      <br>
      Function .onInit<br>
      <br>
      .................<br>
      <br>
      ItIsNotWindows2003:<br>
      !define INCLUDE_GDI<br>
      <br>
      Done:<br>
      <br>
      FunctionEnd<br>
      <br>
      Now in my section, Section "Executables" SEC01, I am having a line:<br>
      <br>
      !ifdef INCLUDE_GDI<br>
      File "..\lib\gdiplus.dll"<br>
      !endif<br>
      <br>
      Now irrespective of Windows, gdiplus is always installed. I think I am doing something wrong?<br>
      <br>
      Thx in advance.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Yathosho</span><br>
      <span class="post-time small text-muted">26th July 2005 09:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">!define is a compile time command, so this does not work. you could use something like this:<br></p>
      <pre>
<code>IsIsNotWindows95:<br>; check if its windows XP<br>Version::IsWindowsXP<br><br>; get the result<br>Pop $TempResult<br><br>; check result<br>StrCmp $TempResult "1" 0 ItIsNotWindowsXP<br><br>StrCpy $DontCopy "1"<br>Goto Go2<br><br>ItIsNotWindowsXP:<br>; check if its windows XP<br>Version::IsWindows2003<br>; get the result<br>Pop $TempResult<br><br>; check result<br>StrCmp $TempResult "1" 0 Go2<br>StrCpy $DontCopy "1"<br>Goto Go2</code>
</pre><br>
      later you can query the variable DontCopy<br>
      <pre>
<code>StrCmp $DontCopy "1" +2<br>File "..\lib\gdiplus.dll"</code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ritesh</span><br>
      <span class="post-time small text-muted">26th July 2005 12:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Still does not seem to work. I am attaching the .nsi file. Can you tell me whats wrong?<br>
      <br>
      I have checked it in WinXP and it copies GdiPlus.dll. Basically I dont want to copy in WinXP and Win2003.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">26th July 2005 13:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You really don't need to use the Version plugin. You can just as easily use the GetWindowsVersion function instead (in NSIS Documentation under Useful Scripts).<br>
      <br>
      Also, as you're only trying to skip one file, it's a waste of memory declaring a variable that will only be used once.<br>
      <br>
      Do:<br></p>
      <pre>
<code>Call GetWindowsVersion<br> Pop $R0<br>StrCmp $R0 XP +3<br>StrCmp $R0 2000 +2<br> File "..\lib\gdiplus.dll"<br></code>
</pre><br>
      <br>
      -Stu
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ritesh</span><br>
      <span class="post-time small text-muted">26th July 2005 14:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Added the above code in, Executables section and while compilation it throws me an error:<br>
      <br></p>
      <pre>
<code>
Processed 1 file, writing output:
<br>&gt;Adding plug-ins initializing function... Done!
<br>&gt;Error: resolving install function "GetWindowsVersion" in install section "Executables" (0)
<br>&gt;Note: uninstall functions must begin with "un.", and install functions must not
<br>Error- aborting creation process 
<br>&gt;
</code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">26th July 2005 16:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Have you put the GetWindowsVersion function in your script??<br>
      <br>
      -Stu</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ritesh</span><br>
      <span class="post-time small text-muted">26th July 2005 16:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Sorry, I didnt put it!<br>
      <br>
      Now I copy-paste the function from the NSIS help file and it gets compiled correctly. Sadly, gdiplus.dll is still getting copied in my WinXP machine.<br>
      <br>
      Find attached the latest nsi.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">26th July 2005 16:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Ok, change:<br>
      Call GetWindowsVersion<br>
      Pop $R0<br>
      To:<br>
      Call GetWindowsVersion<br>
      Pop $R0<br>
      MessageBox MB_OK $R0<br>
      And tell me what it says.<br>
      <br>
      Did you make sure that you deleted "gdiplus.dll" first?<br>
      <br>
      -Stu</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ritesh</span><br>
      <span class="post-time small text-muted">26th July 2005 16:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Yup, I made sure that gdiplus.dll was deleted.<br>
      <br>
      Funnily - the messaged box has BLANK string.<br>
      <br>
      Find attached the Screenshot!</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">26th July 2005 16:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Interesting. That would probably mean the registry entry that identifies your Windows installation is missing.<br>
      Try the GetVersion plugin (put DLL in your Plugins folder):<br>
      <a href="http://nsis.sourceforge.net/wiki/File:GetVersion.zip" target="_blank">http://nsis.sourceforge.net/wiki/File:GetVersion.zip</a><br>
      <br>
      Then you want to use:<br></p>
      <pre>
<code><br>GetVersion::WindowsName<br> Pop $R0<br>StrCmp $R0 "Windows XP" +3<br>StrCmp $R0 "Windows Server 2003" +2<br> File "..\lib\gdiplus.dll"<br></code>
</pre><br>
      The plugin gets the information from API call rather than the registry.<br>
      <br>
      -Stu
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ritesh</span><br>
      <span class="post-time small text-muted">26th July 2005 17:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">OK! That worked. Thanks for the help!<br>
      <br>
      Really, appreciated!</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>