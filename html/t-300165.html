<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Passing variables back from an outer process using UAC plugin"><title>Passing variables back from an outer process using UAC plugin - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Passing variables back from an outer process using UAC plugin</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=300165">Passing variables back from an outer process using UAC plugin</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">NB-Dexter</span><br><span class="post-time small text-muted">21st November 2008 13:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Passing variables back from an outer process using UAC plugin</strong><br>While you can send data in to a user level process using UAC::ExecCodeSegment, I have a need to get parameters back, for example I needed to know the acccount name of the user level account for some settings that are done from the inner, admin level process.<br><br>The solution I came up with is using a temporary .ini file that both processes can see. I couldn't use $TEMP because the inner and outer processes don't get the same folder. I couldn't use a registry key because I didn't know the user account for HKCU of the user process. I ended up using $APPDATA with SetShellVarContext set to "All". This gives a consistent path in both user and admin processes on XP and Vista.<br><br>Here's an example:<br><br>Function UserTest<br><br>MessageBox MB_OK "User Privs process$\n$\nReceived value from Admin process: R1 = $R1"<br><br>SetShellVarContext all<br>strcpy $R1 "From user"<br>WriteINIStr $APPDATA\temp.ini "RegVal" "R1" $R1<br><br>FunctionEnd<br><br>[Section code after UAC::RunElevated]<br>.<br>.<br>.<br>strcpy $R1 "From admin"<br>MessageBox MB_OK "Call UserTest with user rights. Sending R1 = $R1"<br><br>GetFunctionAddress $R0 UserTest<br>UAC::ExecCodeSegment $R0<br><br>; Get changed R1 value<br><br>SetShellVarContext all<br>ReadINIStr $R1 "$APPDATA\temp.ini" "RegVal" "R1"<br>MessageBox MB_OK "After call to UserTest with user rights. R1 = $R1"<br>.<br>.<br>.<br><br>Make sure you remove temp.ini when you're done with it. Probably be better to create a folder in APPDATA but, you get the idea.<br><br>I hope this is of help to someone. I've struggled with this off and on for awhile now.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">ianamason</span><br><span class="post-time small text-muted">2nd January 2009 21:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Indeed it has helped someone. What worries me with this<br>scheme, though, is the following quote from the manual<br>entry for SetShellVarContext:<br><br></p><blockquote>Please take into consideration that a "normal user" has no rights to write in the all users area. Only admins have full access rights to the all users area.</blockquote>Has this bitten you ever? Do you worry too?<br><br>Cheers, Ian.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">2nd January 2009 21:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">v0.0.11 of the plugin added UAC::GetShellFolderPath so you can get the path to the profile (and the other CSIDL paths) of the "normal" user</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">NB-Dexter</span><br><span class="post-time small text-muted">2nd January 2009 21:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><i>Originally posted by ianamason</i> <b><br><br>&lt;snip&gt;<br>.<br>.<br>.<br>Has this bitten you ever? Do you worry too?<br><br>Cheers, Ian.</b></blockquote>I tested this on XP and Vista and did not have any issues. My standard user account was able to write to the appdata folder with setshellcontext set to all. Did you try it?<br><br><blockquote><i>Originally posted by Anders</i> <b><br>v0.0.11 of the plugin added UAC::GetShellFolderPath...<br></b></blockquote>Sweet, I'll have to check that out.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">2nd January 2009 22:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">its not on the wiki yet, grab it from <a href="http://stashbox.org/tag/nsis" target="_blank">http://stashbox.org/tag/nsis</a> for now</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">NB-Dexter</span><br><span class="post-time small text-muted">2nd January 2009 22:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks, I noticed the wiki still had the old one and was just about to ask where I could find it. This will make my solution a little cleaner.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">ianamason</span><br><span class="post-time small text-muted">2nd January 2009 22:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">NB-Dexter: Yes I am testing on a vista business box, and it<br>works fine. But who know where it would bite?<br><br>Anders: Excellent, I'll futz with that asap.<br><br>Again, thanks to both of you.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">abarinoff</span><br><span class="post-time small text-muted">7th April 2010 09:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I've described the solution for original thread's problem in following post: <a href="http://abarinoff-dev.blogspot.com/2010/04/passing-parameters-and-retrieving.html" target="_blank">Passing parameters and retrieving results from inner/outer UAC processes in NSIS-based installer</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">7th April 2010 14:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Errr... Isn't that way out of date? The UAC plugin syncs registers both ways. Using a file to write/readback the result is definitely NOT the way to do it...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">7th April 2010 14:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">only the new version syncs both ways</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>