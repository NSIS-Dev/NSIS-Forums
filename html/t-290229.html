<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Integrity Level(IL) and Vista"><title>Integrity Level(IL) and Vista - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Integrity Level(IL) and Vista</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=290229">Integrity Level(IL) and Vista</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">AaronLS</span><br><span class="post-time small text-muted">14th April 2008 21:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Integrity Level(IL) and Vista</strong><br>During my install, I extract two exe's to the temp directory and run one asynchronously, and then execute the second with ExecWait. The job of the first Exe(an AutoIt exe) is to silently wait for a dialog to appear and click its Yes button. The second exe will sometimes prompt the user with this dialog, and I am automating the process of clicking the button.<br><br>All works fine on WinXP.<br><br>On Vista, the first exe fails to click the button. I have also tried right clicking the installer Exe and using "run as administrator", but the AutoIt exe still fails to do its job.<br><br>However, when the second exe pauses while it's model dialog box is up, waiting for user to click a button, if I right click the AutoIt Exe and click Run as Administrator, it works fine, which seems to indicate that if the AutoIt exe is run as administrator then it will succeed on Vista.<br><br>So what I don't understand is, when I run my installer as Administrator, why doesn't the Exec instruction also run the AutoIt exe as administrator?<br><br>Or it might have something to do with the Integrity Level:<br><a href="http://msdn2.microsoft.com/en-us/library/ms644950" target="_blank">http://msdn2.microsoft.com/en-us/library/ms644950</a>(VS.85).aspx<br><br>From reading about UIPI(<a href="http://en.wikipedia.org/wiki/User_Interface_Privilege_Isolation" target="_blank">http://en.wikipedia.org/wiki/User_In...lege_Isolation</a>) it sounds like this is a likely problem given the methods AutoIt uses. So the solution I would guess is to make sure the two execs, the AutoIt and then the second one that had a dialog, both run at the same Integrity Level. Which I believe is not necessarily the same as running as administrator, although maybe it is a side effect. I'm not sure how to set the integrity level though. The UAC plugin doesn't seem to make mention of this.<br><br>Any suggestions appreciated. I will experiment with UAC plugin in the meanwhile. Thanks.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">14th April 2008 21:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">If the button you want to click is in a dialog on the secure desktop, there is no way to click it<br><br>It might help to set uiAccess = true in the autoit exe's manifest, but for that to work, the exe needs to be signed<br><br>It helps if you can tell me what dialog you want to click yes in (UAC, unsigned driver, etc.)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">AaronLS</span><br><span class="post-time small text-muted">14th April 2008 21:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">If that is true, how does the AutoIt exe succeed in clicking the button when I right click it and select "run as adminstrator"?<br>I'm not understanding something here.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">AaronLS</span><br><span class="post-time small text-muted">14th April 2008 22:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><i>Originally posted by Anders</i><br><b>If the button you want to click is in a dialog on the secure desktop, there is no way to click it<br><br>It might help to set uiAccess = true in the autoit exe's manifest, but for that to work, the exe needs to be signed<br><br>It helps if you can tell me what dialog you want to click yes in (UAC, unsigned driver, etc.)</b></blockquote>Sorry, didn't see your last 2 sentences when I posted. The dialog is not part of any kind of UAC or WHQL certification kind of stuff. Just a simple yes/no dialog:<pre>
<code><br>    ; &gt;&gt;&gt;&gt; Window &lt;&lt;&lt;&lt;<br>; Title:        WARNING!<br>; Class:        #32770<br>; Position:     533, 394<br>; Size: 546, 119<br>; Style:        0x94C801C5<br>; ExStyle:      0x00010101<br>; Handle:       0x000F0E9E<br><br>; &gt;&gt;&gt;&gt; Control &lt;&lt;&lt;&lt;<br>; Class:        Static<br>; Instance:     2<br>; ClassnameNN:  Static2<br>; ID:   65535<br>; Text: A backup of data.mdb already exists in C:\Program Files\Data\Backup. Overwrite with new backup?<br>; Position:     62, 20<br>; Size: 473, 15<br>; ControlClick Coords:  172, 7<br>; Style:        0x50022080<br>; ExStyle:      0x00000004<br>; Handle:       0x00150E4A<br><br>; &gt;&gt;&gt;&gt; Control &lt;&lt;&lt;&lt;<br>; Class:        Button<br>; Instance:     1<br>; ClassnameNN:  Button1<br>; ID:   6<br>; Text: &amp;Yes<br>; Position:     192, 60<br>; Size: 75, 23<br>; ControlClick Coords:  41, 6<br>; Style:        0x50030000<br>; ExStyle:      0x00000004<br>; Handle:       0x00160E4C<br></code>
</pre><br>
      <br>
      That is the info for the relevant controls. The dialog is part of the second exe. It's not any kind of special dialog spawned by some window's component. So if my thinking was if I can get the AutoIt exe to run at the same or higher integrity level than the second exe, then the AutoIt should be able to send messages to the second exe.<br>
      <br>
      I think the reason it works standalone is because Run as Administrator also imparts one of the higher integrity levels. I kind of thought any processes spawned from the installer process would automatically Run as adminsitrator, since I ran the installer using "run as administrator".
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">AaronLS</span><br>
      <span class="post-time small text-muted">15th April 2008 21:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">As it turns out, the AutoIt exe's manifest has "asInvoker" setting which means it runs at the same level as the process that creates it. So it has no problems sending ControlClicks or messages to other threads spawned by the isntaller.<br>
      <br>
      The reason the AutoIt exe wasn't working from the installer on Vista, but did work when run standalone, was that the message box contained a path in it's text, which the AutoIt script used as a way to find the dialog. It just coincidentally happened that my test on Vista was also a test to a non-default install location, which meant that it couldn't find the dialog(this is why you only change one variable at a time in experiments ;). So the bug had nothing to do with Vista. The script I ran standalone had been edited in my efforts to find a solution, and worked when run as admin, as the result of not including that extra criteria, but did not work when not run as admin due to UIPI. So that completely mislead me, because then I assumed the one from the isntaller wasn't being run as admin, when it actually was just a buggy AutoIt script.<br>
      <br>
      I realized I screwed up big time by hard coding the dialog text into the AutoIt script. Bad Aaron, BAD!<br>
      <br>
      After I changed my AutoIt Exe to only match part of the dialog text(leaving off the directory path), and I recompiled it into my NSIS installer, all works well.<br>
      <br>
      I just wanted to post this so that no one with a similar issue finds it and is mislead by my previous posts.</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>