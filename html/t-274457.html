<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="nsExec is performing very slow" />

  <title>nsExec is performing very slow - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">nsExec is performing very slow</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=274457">nsExec is performing very slow</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">123mobile</span><br />
      <span class="post-time small text-muted">16th July 2007 15:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>nsExec is performing very slow</strong><br />
      I am using lot of already created exe files in my installer. I am prefering nsExec over exec as it allows me to redirect my output to the logfile. The problem is nsExec takes a long time to run and sometimes it is even not able to recover from minor errors, for which I have no Idea.<br />
      I would be very thankful if someone can shed light on this topic.<br />
      <br />
      Thanks in advance,<br />
      Prabhat Jain.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">123mobile</span><br />
      <span class="post-time small text-muted">16th July 2007 15:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Example script to prove my point</strong><br />
      For Example run this nsi file on your computer.<br />
      It is a simple example of what I am pointing out. When I run this it does not take me to the completion point immediately. but takes a long time.<br />
      <br />
      ;nsis script begin----------<br />
      <br />
      Name "nsExec Test"<br />
      <br />
      OutFile "nsExec Test.exe"<br />
      <br />
      ShowInstDetails show<br />
      <br />
      <br />
      Section "MakeNSIS commands help"<br />
      nsExec::ExecToLog "notepad"<br />
      ;nsExec::ExecToLog '"${NSISDIR}\makensis.exe" /CMDHELP'<br />
      Pop $0 # return value/error/timeout<br />
      DetailPrint ""<br />
      DetailPrint " Return value: $0"<br />
      DetailPrint ""<br />
      SectionEnd<br />
      <br />
      ;nsis script ends----------</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">16th July 2007 16:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">This is not a good example. Script execution will cease until you close notepad!<br />
      <br />
      nsExec's sole purpose is for console applications anyway.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">123mobile</span><br />
      <span class="post-time small text-muted">16th July 2007 16:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>It is not about notepad</strong><br />
      Notepad was just an example, my problem is whanever I am using nsExec it is not coming to the point of completion so that I can exit my installer properly, I have to kill the process from taskmanager. It is somehow not returning back.<br />
      Use rather this script, the same thing will<br />
      happen.<br />
      <br />
      ;NSI script begins--------------------------<br />
      Name "nsExec Test"<br />
      <br />
      OutFile "nsExec Test.exe"<br />
      <br />
      ShowInstDetails show<br />
      <br />
      <br />
      Section "MakeNSIS commands help"<br />
      nsExec::ExecToLog '"${NSISDIR}\makensis.exe" /CMDHELP'<br />
      Pop $0 # return value/error/timeout<br />
      DetailPrint ""<br />
      DetailPrint " Return value: $0"<br />
      DetailPrint ""<br />
      SectionEnd<br />
      <br />
      ;NSI script ends--------------------------</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">16th July 2007 18:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hmm that worked fine for me. Returned in under a second. Latest NSIS version, Win XP SP2.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">123mobile</span><br />
      <span class="post-time small text-muted">17th July 2007 08:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You are right it is working on Win XP SP2 correctly, I checked it on my laptop, but at my workplace we are using Windows Server 2003 sp2 and it is not working there. Did I found a Bug? I also have latest installation of NSIS(Installed it yesterday again).</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">17th July 2007 12:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Cannot be sure. Can you try out the <a href="http://nsis.sourceforge.net/ExecDos" target="_blank">ExecDos plugin</a>?<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">17th July 2007 17:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Anything special with your Windows 2003? You're not the first, but I could never reproduce any report.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">123mobile</span><br />
      <span class="post-time small text-muted">18th July 2007 16:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for the reply.<br />
      I have started using ExecDos::exec and it is working fine for now...<br />
      So no need for nsExec.<br />
      <br />
      Prabhat.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">18th July 2007 17:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Any chance you're going to donate information about this problem anyway?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Andrew Wallo</span><br />
      <span class="post-time small text-muted">19th July 2008 21:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>nsExec::ExecToLog stalling without response.</strong><br />
      Very confused, but the scenario seems to be along the lines of stack corruption. I can't be sure..... but I have a page that runs a nsExec::ExecToLog call and pops the result... and if I skip that segment.... the following page, ( the components page. ) actually progresses when I press the install button.....<br />
      <br />
      But if I execute the call.... ( though it doesn't fail immediately ) after it completes, and I move on.. from the custom page into the component page...<br />
      <br />
      ( I track the entry into the component page with a pre or show popup box) and I track the exit with a MessageBox in the leave.....<br />
      <br />
      Thing is.... when I press the Install button of the components, I never hit the leave function but I stall immediately. I put popups into each of my sections, and it never fires a section marker.....<br />
      <br />
      This was stable code till yesturday when I added the nsExec::ExecToLog calls to the custom page leave function..... very strange.<br />
      <br />
      The thing that makes me think its stack corruption is that it doesn't fail immediately, but fails later on an instrinsic page-move call... which are all stack critical.... it also seems to have corrupted the ability to go back....<br />
      <br />
      Not saying that it couldn't be something else... ( and if I find it.... I will come back and disreguard this guess... ) but kitchic was looking for a straw to yank on.... maybe this is something...<br />
      <br />
      _AWallo</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">20th July 2008 12:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You shouldn't be using ExecToLog unless you're running from a section anyway but that shouldn't cause any problems. Can you post a script that reproduces the problem?<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Andrew Wallo</span><br />
      <span class="post-time small text-muted">21st July 2008 15:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>No ExecToLog except in Section?</strong><br />
      The script is huge... and won't run independantly.. ( i.e. if I snip ) but I was playing with my sequence, and I swapped for Exec and used a different $var to pop into, and then I went back to ExecLog but didn't change back the variable and the amazing page problem just went away.<br />
      <br />
      . <font color="darkblue">!insertmacro BIMAGE "BannerFindingRulebase.bmp" ""<br />
      SendMessage $HWNDPARENT ${WM_SETTEXT} 0 "STR:Downloading Rulebase:"<br />
      <br />
      ; Ok we're leaving but if we're using an existing rulebase, we still should test the s2check test for the new authentication string..<br />
      <br />
      ; This flag was determined on the previous page. Its<br />
      ; defaulted in onInit and set on a custom page as it goes<br />
      ; through. Essentially, if we're getting a new set of rules<br />
      ; then we're going to do a lot of stuff on this screen<br />
      ; which ( executed safe, further down. )<br />
      ; but when the top branch fell through, it would hang<br />
      ; two pages away.<br />
      <br />
      <br />
      StrCmp $UseDetectedRulebase "1" 0 GetTheRulebaseNow<br />
      ; Ok, well do the s2check for concurrance....<br />
      <br />
      ; Poking around, messed with this.<br />
      ; USED to use $var 9 but for some reason went to 0 and<br />
      ; cleared it up.<br />
      ;nsExec::ExecWait 's2check.exe $LicenseID.snf "$Authentication"' $9<br />
      ;pop $9<br />
      <br />
      ; Then when we went back to this<br />
      ; it didn't have a problem.<br />
      <br />
      nsExec::ExecToLog '"$InstallDir\$FolderPrefix\snf2check.exe" $LicenseID.snf "$Authentication"'<br />
      <br />
      pop $0<br />
      <br />
      StrCpy $s2Check $0 ; Set this as a flag for the message for the next screen, or if we just pass through. ( 0 result is clean )<br />
      Return ; ignore displaying this screen.....<br />
      <br />
      ;Otherwise<br />
      <br />
      GetTheRulebaseNow:<br />
      ; Else download and report.<br />
      nsDialogs::Create /NOUNLOAD 1018<br />
      Pop $0 ; All my screens tend to pop $0 for the Nounload temp var...<br /></font><br />
      <br />
      Just so we're clear. The script portion that I'm editing was two pages away from the place in the code that froze.<br />
      <br />
      And the malfunction in the script occurred when you clicked on &lt;Back&gt; or &lt;install&gt;. Then it became unresponsive. Just because of something with<br />
      <br />
      nsExec:ExecToLog "blah blah blah"<br />
      pop $9<br />
      <br />
      Which when I moved the pop to $0 viola...... problem dissappeared.<br />
      <br />
      Now, None of my code depends on $vars 0-9 being stable. i.e. I only use them for temp vars. And YES I looked for something depending on $9 for something else.... but it was not to be.<br />
      <br />
      <b>So..... Now please elaborate why I can't use ExecToLog in my custom pages?</b></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">21st July 2008 15:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Because ExecToLog writes STDOUT to the install log window. Obviously you don't have an install log window when you are in a custom page!<br />
      <br />
      Use nsExec::Exec or nsExec::ExecToStack. However, as I said before, this shouldn't be causing a problem.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bbondy</span><br />
      <span class="post-time small text-muted">20th July 2012 00:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Reason why nsExec::Exec is slow</strong><br />
      Hi, I work for Mozilla and we recently had a bug report that Microsoft Security Essentials caused one of our files to act very slowly on updates and downloads while it scanned the file.<br />
      <br />
      I could reproduce consistently. We narrowed down the slowness to be from nsExec::Exec. Replacing with ExecWait fixed the problem, but of course it has command prompts popup now. I then searched to see if anyone else had this problem and found this thread.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bbondy</span><br />
      <span class="post-time small text-muted">20th July 2012 03:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>....</strong><br />
      Also I should add that you have to have a silent installer for this to happen. Also I know this is a really old topic but just in case someone else finds this thread :)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">demiller9</span><br />
      <span class="post-time small text-muted">20th July 2012 04:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hmm. I haven't seen that problem with my installers.<br />
      <br />
      Our main product installer uses NsExec:Exec 9 times. This installer is run silent via /S. There are 8 times I use that in an outer meta-installer (which is not run silently). Other installers we run during our product installation have 7 NsExec calls during TFTP install and 2 more in another component installer (these are run with /S, too). I also use that in other utilities that aren't a normal part of our product.<br />
      <br />
      Our product is run on a dedicated PC included with our system (HW &amp; SW). Until this month we've been using Windows 2000. We tested Windows 7 last year and are just now releasing new systems with that OS. A small number of installations have been done by our developers or other inhouse personnel on Windows XP. I've never seen or received reports of the installer hanging or the program that was Exec'ed not ending properly. We have about 15000 customers, most have had the software installed many times as we upgrade to new versions.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">20th July 2012 10:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have always used the ExecDos plug-in because of it's better output-to-stack support. Also I have had an issue with nsExec in the past on systems that have AntiExecutable or similar software installed - nsExec appears to create its own temporary process under a random name which is always blocked.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bbondy</span><br />
      <span class="post-time small text-muted">21st July 2012 04:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>The /S option</strong><br />
      The problem doesn't happen with the /S option. That's actually how we're fixing the problem, to have a UI and to use the /S option. MS Security Essentials Real time scan option seems to trigger some longer than normal scan when data is read or written from disk, when the installer is silent and there is a call to nsExec::Exec.<br />
      <br />
      You can only reproduce if you have both of the above conditions.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
