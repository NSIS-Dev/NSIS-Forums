<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Problem modifying a string in a .cfg file"><title>Problem modifying a string in a .cfg file - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Problem modifying a string in a .cfg file</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=262646">Problem modifying a string in a .cfg file</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">EndeavourCmdr</span><br><span class="post-time small text-muted">29th December 2006 03:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Problem modifying a string in a .cfg file</strong><br>I seem to have run into a problem during the creation of my installer. One of the steps I need performed, involves the manipulation of a string of text within a .cfg file. However, the config file is not devided into sections, it is all one big section, without a section header such as<br><br>[Main]<br><br>Instead, the config file flows sort of like:<br><br>HazeColor = 1.2 1.3 .56<br>LightLevel = 2.0 1.3 0.5<br>AtmAlt = 64e3<br><br>etc, etc.<br><br>I need to have the installer modify one of those lines, ex., HazeColor = 1.0 1.0 1.0<br><br>Without there being any Sections defined in brackets, how can I get the value in that string to be changed by the installer?<br><br>I've tried to research the forums on this, and I am currently also in the IRC channel in case anyone in there can give some insight, but so far, I havent been able to find a problem similar to mine, and I will admit, I am brand new at scripting, and have maybe a total of 10 hours in Visual C++, so Im most definitely not skilled in this kind of thing, and would need a pretty decent explaination. Any help is appreciated greatly.<br><br>Thanks,<br><br>EndeavourCmdr.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Red Wine</span><br><span class="post-time small text-muted">29th December 2006 04:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Re-format the file.cfg to a new structured file.cfg and you'll be able to modify any string.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">EndeavourCmdr</span><br><span class="post-time small text-muted">29th December 2006 04:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Unfortunately, thats not an option, beceause the program I am having installed is simply a modification to an existing program, of which I do not have any access or rights to, other then just being an addon developer for it. Thus, the config file structure has to remain the same, and it is not even feasible to have the structure changed. Every single config however does have the same line of text in it which is:<br><br>AtmHazeColor = valuehere<br><br>Is it possible to have the script just find that string without a section defined and replace the value?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Red Wine</span><br><span class="post-time small text-muted">29th December 2006 04:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hold on a second I'll be back</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Red Wine</span><br><span class="post-time small text-muted">29th December 2006 05:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><pre>
<code>!include TextFunc.nsh<br>!insertmacro TrimNewLines<br><br>!define STR_TO_FIND "HazeColor = 1.2 1.3 .56"<br>!define STR_TO_REPLACE "HazeColor = 1.0 1.0 1.0"<br><br><br>Section<br>#......<br>FileOpen $0 "path_to_file\file.cfg" r ; file to read<br>GetTempFileName '$R2'<br>FileOpen $R2 w ; file to write<br>ClearErrors<br><br>start:<br>FileRead $0 $1 ${NSIS_MAX_STRLEN}<br>IfErrors end<br>${TrimNewLines} '$1' '$1'<br>StrCmp '$1' '${STR_TO_FIND}' 0 next<br>StrCpy '$1' '${STR_TO_REPLACE}'<br>FileWrite $R2 '$\r$\n$\r$\n'<br>FileWrite $R2 '$1'<br><br>next:<br>FileWrite $R2 '$\r$\n$\r$\n'<br>FileWrite $R2 '$1'<br>goto start<br><br>end:<br>FileClose $0<br>FileClose $R2<br>Rename "path_to_file\file.cfg" "path_to_file\file.cfg.bak"<br>Rename $R2 "path_to_file\file.cfg"<br>#......<br>SectionEnd</code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">EndeavourCmdr</span><br>
      <span class="post-time small text-muted">29th December 2006 05:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well thanks! That is alot more complex then I expected. Are there any good tutorials out there on how do learn some of this stuff, other then the manual, which seems to be just a reference?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">EndeavourCmdr</span><br>
      <span class="post-time small text-muted">29th December 2006 05:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hmm, actually on a second look, that code wouldnt quite work, because everyone needs to have<br>
      <br>
      AtmHazeColor = 1.0 1.0 1.0<br>
      <br>
      after the install.<br>
      <br>
      Before the install, the values may be different on every users machine.<br>
      <br>
      So user 1 might have<br>
      <br>
      AtmHazeColor = 0.535 0.76 1.0<br>
      <br>
      User 2 might have<br>
      <br>
      AtmHazeColor = 0.7 0.85 1.0<br>
      <br>
      etc, etc.<br>
      <br>
      But in the end, they all need to read,<br>
      <br>
      AtmHazeColor = 1.0 1.0 1.0<br>
      <br>
      So, now I am once again where I started Lol.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br>
      <span class="post-time small text-muted">29th December 2006 05:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You may find everything in the forum, just point your search to the required keywords. Also browse to wiki <a href="http://nsis.sourceforge.net" target="_blank">http://nsis.sourceforge.net</a> there are about 1000 articles with functions and code examples, simply, everything is possible within NSIS :-)</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br>
      <span class="post-time small text-muted">29th December 2006 05:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>
      <pre>
<code><font color="red">!define STR_TO_FIND "HazeColor"<br><br>StrLen $2 ${STR_TO_FIND}</font><br>start:<br>FileRead $0 $1 ${NSIS_MAX_STRLEN}<br>IfErrors end<br>${TrimNewLines} '$1' '$1'<br><font color="red">StrCpy '$3' '$1' $2<br>StrCmp '$3' '${STR_TO_FIND}' 0 next</font><br>StrCpy '$1' '${STR_TO_REPLACE}'<br>FileWrite $R2 '$\r$\n$\r$\n'<br>FileWrite $R2 '$1'</code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">EndeavourCmdr</span><br>
      <span class="post-time small text-muted">29th December 2006 07:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I dont quite understand. The following is the contents of my script. Where did I mess up?<br>
      <br></p>
      <pre>
<code><br>Name "EndeavourCmdr's Environment Enhancement"<br>OutFile "EEEo2006.exe"<br>InstallDir $PROGRAMFILES<br><br>;--------------------------------<br><br>Page components<br>Page directory<br>Page instfiles<br><br>;--------------------------------<br><br>Section "EEE (required)"<br><br>  SectionIn RO<br><br>  SetOutPath $INSTDIR\Textures<br>  File "Horizon.dds"<br><br>  FileOpen $0 $INSTDIR\file.dat a<br>  !define STR_TO_FIND "AmtHazeColor"<br><br>StrLen $2 ${STR_TO_FIND}<br>start:<br>FileRead $0 $1 ${NSIS_MAX_STRLEN}<br>IfErrors end<br>${TrimNewLines} '$1' '$1'<br>StrCpy '$3' '$1' $2<br>StrCmp '$3' '${STR_TO_FIND}' 0 next<br>StrCpy '$1' '${STR_TO_REPLACE}'<br>FileWrite $R2 '$\r$\n$\r$\n'<br>FileWrite $R2 '$1'<br>  <br>  FileClose $0<br>  <br>SectionEnd<br></code>
</pre><br>
      <br>
      Sorry to be a bother, but this is very new and confusing, and I am a hand on learner, so I will get the hang of this all by having someone explain it a bit and then doing it myself, but it's something I want to learn.
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br>
      <span class="post-time small text-muted">29th December 2006 07:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Replace/add the lines in my upper post with the red lines in the followed post.<br>
      Don't forget on the top of your script the defines and the includes.<br>
      <br>
      Now you should have this:<br></p>
      <pre>
<code><br>!define STR_TO_FIND "HazeColor"<br>!define STR_TO_REPLACE "HazeColor = 1.0 1.0 1.0"<br><br><br>Section<br>#......<br>FileOpen $0 "path_to_file\file.cfg" r ; file to read<br>GetTempFileName '$R2'<br>FileOpen $R2 w ; file to write<br>ClearErrors<br><br>StrLen $2 ${STR_TO_FIND}<br><br>start:<br>FileRead $0 $1 ${NSIS_MAX_STRLEN}<br>IfErrors end<br>${TrimNewLines} '$1' '$1'<br>StrCpy '$3' '$1' $2<br>StrCmp '$3' '${STR_TO_FIND}' 0 next<br>StrCpy '$1' '${STR_TO_REPLACE}'<br>FileWrite $R2 '$\r$\n$\r$\n'<br>FileWrite $R2 '$1'<br><br>next:<br>FileWrite $R2 '$\r$\n$\r$\n'<br>FileWrite $R2 '$1'<br>goto start<br><br>end:<br>FileClose $0<br>FileClose $R2<br>Rename "path_to_file\file.cfg" "path_to_file\file.cfg.bak"<br>Rename $R2 "path_to_file\file.cfg"<br>#......<br>SectionEnd</code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br>
      <span class="post-time small text-muted">29th December 2006 08:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I'm so sorry...<br>
      I messed things a little :-)<br>
      here is the right one, please doenload and test.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">EndeavourCmdr</span><br>
      <span class="post-time small text-muted">29th December 2006 08:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Sigh...<br>
      <br>
      I'm trying hard to get this, but here is my script, which you gave me most of.<br>
      <br></p>
      <pre>
<code><br><br>Name "EndeavourCmdr's Environment Enhancement"<br>OutFile "EEEo2006.exe"<br>InstallDir $PROGRAMFILES<br><br>!include TextFunc.nsh<br>!insertmacro TrimNewLines<br><br>!define STR_TO_FIND "AtmHazeColor"<br>!define STR_TO_REPLACE "AtmHazeColor = 1.0 1.0 1.0"<br><br>;-----------------------------------------------------<br><br>Section<br>#......<br>SetOutPath $INSTDIR\Textures<br>File "Horizon.dds"<br><br>FileOpen $0 "$INSTDIR\config\earth.cfg" r ; file to read<br>GetTempFileName '$R2'<br>FileOpen $R2 w ; file to write<br>ClearErrors<br><br>StrLen $2 $(STR_TO_FIND)<br><br>start:<br>FileRead $0 $1 ${NSIS_MAX_STRLEN}<br>IfErrors end<br>${TrimNewLines} '$1' '$1'<br>StrCpy '$3' '$1' $2<br>StrCmp '$3' '${STR_TO_FIND}' 0 next<br>StrCpy '$1' '${STR_TO_REPLACE}'<br>FileWrite $R2 '$\r$\n$\r$\n'<br>FileWrite $R2 '$1'<br><br>next:<br>FileWrite $R2 '$\r$\n$\r$\n'<br>FileWrite $R2 '$1'<br>goto start<br><br>end:<br>FileClose $0<br>FileClose $R2<br>Rename "$INSTDIR\config\earth.cfg" "$INSTDIR\config\earth.cfg.bak"<br>Rename $R2 "$INSTDIR\config\earth.cfg"<br>#......<br>SectionEnd<br></code>
</pre><br>
      <br>
      <br>
      But after trying to compile that, I get this...<br>
      <br>
      <pre>
<code><br>MakeNSIS v2.22 - Copyright 1995-2006 Contributors<br>See the file COPYING for license details.<br>Credits can be found in the Users Manual.<br><br>Processing config: <br>Processing plugin dlls: "C:\Program Files\NSIS\Plugins\*.dll"<br> - AdvSplash::show<br> - Banner::destroy<br> - Banner::getWindow<br> - Banner::show<br> - BgImage::AddImage<br> - BgImage::AddText<br> - BgImage::Clear<br> - BgImage::Destroy<br> - BgImage::Redraw<br> - BgImage::SetBg<br> - BgImage::SetReturn<br> - BgImage::Sound<br> - Dialer::AttemptConnect<br> - Dialer::AutodialHangup<br> - Dialer::AutodialOnline<br> - Dialer::AutodialUnattended<br> - Dialer::GetConnectedState<br> - InstallOptions::dialog<br> - InstallOptions::initDialog<br> - InstallOptions::show<br> - LangDLL::LangDialog<br> - Math::Script<br> - NSISdl::download<br> - NSISdl::download_quiet<br> - Splash::show<br> - StartMenu::Init<br> - StartMenu::Select<br> - StartMenu::Show<br> - System::Alloc<br> - System::Call<br> - System::Copy<br> - System::Free<br> - System::Get<br> - System::Int64Op<br> - System::Store<br> - TypeLib::GetLibVersion<br> - TypeLib::Register<br> - TypeLib::UnRegister<br> - UserInfo::GetAccountType<br> - UserInfo::GetName<br> - VPatch::vpatchfile<br> - nsExec::Exec<br> - nsExec::ExecToLog<br> - nsExec::ExecToStack<br><br>!define: "MUI_INSERT_NSISCONF"=""<br><br>Changing directory to: "C:\Documents and Settings\Adm.EL-081FF12C7FDC\Desktop\Orbiter Environment Installer"<br><br>Processing script file: "C:\Documents and Settings\Adm.EL-081FF12C7FDC\Desktop\Orbiter Environment Installer\Copy of In Progress.nsi"<br>Name: "EndeavourCmdr's Environment Enhancement"<br>OutFile: "EEEo2006.exe"<br>InstallDir: "$PROGRAMFILES"<br>!include: "C:\Program Files\NSIS\Include\TextFunc.nsh"<br>!define: "TEXTFUNC_INCLUDED"=""<br>!include: closed: "C:\Program Files\NSIS\Include\TextFunc.nsh"<br>!insertmacro: TrimNewLines<br>!insertmacro: end of TrimNewLines<br>!define: "STR_TO_FIND"="AtmHazeColor"<br>!define: "STR_TO_REPLACE"="AtmHazeColor = 1.0 1.0 1.0"<br>Section: ""<br>SetOutPath: "$INSTDIR\Textures"<br>File: "Horizon.dds" [compress] 4890/65664 bytes<br>FileOpen: $INSTDIR\config\earth.cfg as r -&gt; $0<br>GetTempFileName -&gt; $R2<br>FileOpen expects 3 parameters, got 2.<br>Usage: FileOpen $(user_var: handle output) filename openmode<br>   openmode=r|w|a<br>Error in script "C:\Documents and Settings\Adm.EL-081FF12C7FDC\Desktop\Orbiter Environment Installer\Copy of In Progress.nsi" on line 21 -- aborting creation process<br></code>
</pre><br>
      <br>
      I cant understand what part is wrong there, but im assuming its the:<br>
      <br>
      FileOpen $R2 w ; file to write<br>
      <br>
      line, that is missing something?<br>
      <br>
      Thanks btw for all your help so far. It's actually making sence, but I dont understand all those variables yet.
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">EndeavourCmdr</span><br>
      <span class="post-time small text-muted">29th December 2006 08:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Excellent! The file you sent works perfectly. Im going to study it thouroughly and incorporate it into the rest with my new values. Thank you so much.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br>
      <span class="post-time small text-muted">29th December 2006 09:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You're welcome! and sorry for the mess...<br>
      This happens to me often when I try to write code straight in the reply window :-) A full screen editor is always required.</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>
