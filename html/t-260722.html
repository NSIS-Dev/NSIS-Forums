<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Vista + Run App On Install" />

  <title>Vista + Run App On Install - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Vista + Run App On Install</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=260722">Vista + Run App On Install</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Locke355</span><br />
      <span class="post-time small text-muted">30th November 2006 02:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Vista + Run App On Install</strong><br />
      On Vista, when the installer finishes and shows the 'Run Your Application' checkbox, the installed application is run as an administrator. This happens because Vista elevates the installer to require admin, and the launched process inherits the security status of the app which launched it.<br />
      <br />
      Is there any fix or planned fix for this problem?<br />
      <br />
      I am using version 2.22 of NSIS.<br />
      <br />
      Thanks.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">30th November 2006 18:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">A quick Google search found the following MSDN article.<br />
      <br />
      <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dncode/html/secure11152004.asp" target="_blank">http://msdn.microsoft.com/library/de...re11152004.asp</a><br />
      <br />
      Maybe it can be made into a plug-in. I won't include that as the default, because the installer might need to execute other programs that need administrator rights, but maybe it can be an option.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Locke355</span><br />
      <span class="post-time small text-muted">30th November 2006 20:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">In trying to find a solution for this problem (our patcher does the same thing as the NSIS installer), I came across DropMyRights. Using the safer libraries does not seem to work properly on Vista since it uses the current processes security token. Vista creates 2 separate security tokens (one admin, one standard user) on login, and if you are a standard user, running an installer prompts you for the admin account of a different user. So, the current process token is obviously not the one to use, and calling CreateProcessAsUser with a different token than the calling thread will usually fail with access denied.<br />
      <br />
      It seems MS' solution is structure installers into two parts:<br />
      - A launcher that runs as a normal user, launches the admin part, waits for it to complete, &amp; then launches the app<br />
      - An app or com object that the launcher calls to request admin access and performs the installation<br />
      <br />
      The other solution is to use the system task scheduler to create a task and schedule it immediately to run as a normal user. This seems kinda hokey.<br />
      <br />
      <br />
      <br />
      I would imagine that the majority of installers using the 'Run app' feature would be launching a standard user app, an would take care of any administrative needs in the install script prior to finishing.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">onad</span><br />
      <span class="post-time small text-muted">1st December 2006 11:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hmmm, "system task scheduler" is a service and not guaranteed to run on the Vista PC, would not follow that path really...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Locke355</span><br />
      <span class="post-time small text-muted">1st December 2006 17:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">ya. as i said, seems hokey :)<br />
      <br />
      I loaded up MS' sample code for the task scheduler, and it fails to work properly when you have a standard user elevate the process w/ a different admin account. The process is started on the admin's desktop, not the current users.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">onad</span><br />
      <span class="post-time small text-muted">4th December 2006 14:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What happens if you shellexecute a shortcut?<br />
      <br />
      Have not time to make a NSIS tryout for this situation myself (yet), but it might be worth a try.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">eyalzoref</span><br />
      <span class="post-time small text-muted">11th December 2006 10:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The question is: How do i make a Launcher setup that runs in a user mode? From what i understand, we need to use an embeded manifest in the launcher. one like this:<br />
      <br />
      &lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;<br />
      &lt;assembly xmlns="urn:schemas-microsoft-com:asm.v1" manifestVersion="1.0"&gt;<br />
      &lt;dependency&gt;<br />
      &lt;dependentAssembly&gt;<br />
      &lt;assemblyIdentity type="win32" name="Microsoft.VC80.CRT" version="8.0.50608.0" processorArchitecture="x86" publicKeyToken="1fc8b3b9a1e18e3b"&gt;&lt;/assemblyIdentity&gt;<br />
      &lt;/dependentAssembly&gt;<br />
      &lt;/dependency&gt;<br />
      &lt;dependency&gt;<br />
      &lt;dependentAssembly&gt;<br />
      &lt;assemblyIdentity type="win32" name="Microsoft.VC80.MFC" version="8.0.50608.0" processorArchitecture="x86" publicKeyToken="1fc8b3b9a1e18e3b"&gt;&lt;/assemblyIdentity&gt;<br />
      &lt;/dependentAssembly&gt;<br />
      &lt;/dependency&gt;<br />
      &lt;dependency&gt;<br />
      &lt;dependentAssembly&gt;<br />
      &lt;assemblyIdentity type="win32" name="Microsoft.Windows.Common-Controls" version="6.0.0.0" processorArchitecture="x86" publicKeyToken="6595b64144ccf1df" language="*"&gt;&lt;/assemblyIdentity&gt;<br />
      &lt;/dependentAssembly&gt;<br />
      &lt;/dependency&gt;<br />
      &lt;trustInfo xmlns="urn:schemas-microsoft-com:asm.v2"&gt;<br />
      &lt;security&gt;<br />
      &lt;requestedPrivileges&gt;<br />
      &lt;!-- The tag options --&gt;<br />
      &lt;!-- &lt;requestedExecutionLevel<br />
      level="asInvoker|highestAvailable|requireAdministrator"<br />
      uiAccess="true|false"/&gt; --&gt;<br />
      &lt;requestedExecutionLevel<br />
      level="asInvoker"<br />
      uiAccess="false"/&gt;<br />
      &lt;/requestedPrivileges&gt;<br />
      &lt;/security&gt;<br />
      &lt;/trustInfo&gt;<br />
      &lt;/assembly&gt;<br />
      <br />
      How can we do it? Or is there another option to run the launcher in user mode?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">obo</span><br />
      <span class="post-time small text-muted">11th December 2006 12:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Running a "normal" process from an elevated UAC process doesn't seem to be very straight-forward. Google for "WindowsVistaUACDevReqs.doc" and see the note on page 73, plus the sample code towards the end of the document.<br />
      <br />
      I guess it wouldn't take much to wrap that code up in a plug-in DLL, though it's a shame MS didn't think to include it without jumping through so many hoops!<br />
      <br />
      Si</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kjk7</span><br />
      <span class="post-time small text-muted">13th December 2006 06:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I got interested in this question because of an article on Vista<br />
      and UAC in the January 2007 issue of MSDN Magazine which sees this as a "typical problem" with installation programs:<br />
      <br />
      "It is very common to start an application at the end of installation.<br />
      Unfortunately, the application is often started under the wrong user<br />
      contextbecause the user provided elevated credentials to perform the<br />
      installation and the application is created with the elevated user<br />
      token." (from page 49)<br />
      <br />
      Their suggestion, which does not seem ideal, is the one mentioned above by<br />
      Locke355: a separate launcher .EXE that first runs the installer (which<br />
      is marked to request elevated privileges) and then runs the application.<br />
      <br />
      To instead try to do it from a single NSIS .EXE installer, the following<br />
      links look relevant to me, though I haven't actually tried any code yet:<br />
      <br />
      "Understanding and Working in Protected Mode Internet Explorer" at <a href="http://msdn2.microsoft.com/en-us/library/aa701102.aspx#dse_stlip" target="_blank">http://msdn2.microsoft.com/en-us/lib...aspx#dse_stlip</a><br />
      <br />
      and<br />
      <br />
      "Windows Vista for Developers â€“ Part 4 â€“ User Account Control" at<br />
      <a href="http://weblogs.asp.net/kennykerr/archive/2006/09/29/Windows-Vista-for-Developers-_1320_-Part-4-_1320_-User-Account-Control.aspx" target="_blank">http://weblogs.asp.net/kennykerr/arc...t-Control.aspx</a><br />
      <br />
      and<br />
      <br />
      "How to CreateProcess NOT as administrator" <a href="http://forums.microsoft.com/MSDN/ShowPost.aspx?PostID=422705&amp;SiteID=1" target="_blank">http://forums.microsoft.com/MSDN/Sho...22705&amp;SiteID=1</a><br />
      <br />
      The first two have relatively simple sample code showing how a medium<br />
      integrity Vista process (that is, a process with normal privilege<br />
      levels) can create a low integrity process (the level that protected<br />
      mode IE7 runs at). This is very close to the question at hand, which is<br />
      how to have a high integrity (elevated administrator) process create a<br />
      medium integrity process.<br />
      <br />
      The third link above is a thread (with links to other threads) with some<br />
      not-too-optimistic comments on various suggested methods of handling this.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Locke355</span><br />
      <span class="post-time small text-muted">13th December 2006 08:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">From what I understand, going from medium -&gt; low integrity is easy because your security token essentially remains the same. However, going from administrator -&gt; medium changes the security token. Further, when you are using OTS (over the shoulder) promotion to some other administrative account, the current user token is not even your own.<br />
      <br />
      AFAIK, any solution which requires CreateProcessAsUser will fail because, by default, administrator accounts on Vista do not have permission to run a process as another user.<br />
      <br />
      I have found 3 solutions to the problem. If anyone has found anything different, please reply. They are:<br />
      - Create a launcher app as listed above, or have the installer relaunch itself requiring administrative access on vista. The installer needs to tell the medium integ. process to run the app when finished.<br />
      - Create a COM control to do the install. However, the COM control needs to already be registered before elevating, so this can become a catch-22 situation.<br />
      - Create a service which launches the application. I am unsure if admins can lose their rights to start and stop a service, but this solution has the same catch-22 problem as the COM solution. Also, who wants to require a service starting and stopping just to run an app?<br />
      <br />
      <br />
      In my app, it was acceptable to remove the 'Run app on install' feature, at least until the problem is solved in NSIS or I implement solution #1.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Locke355</span><br />
      <span class="post-time small text-muted">13th December 2006 08:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by obo</i><br />
        <b>Running a "normal" process from an elevated UAC process doesn't seem to be very straight-forward. Google for "WindowsVistaUACDevReqs.doc" and see the note on page 73, plus the sample code towards the end of the document.<br />
        <br />
        I guess it wouldn't take much to wrap that code up in a plug-in DLL, though it's a shame MS didn't think to include it without jumping through so many hoops!<br />
        <br />
        Si</b>
      </blockquote>I believe the code at the bottom of the page is the task scheduler code? If so, see my comment above on the app starting on the wrong desktop.<br />
      <br />
      <br />
      <br />
      eyalzoref:<br />
      As far as I know, you can never prevent the user from being able to run your program as admin, outside of refusing to run if IsUserAnAdmin() returns true. Adding AsInvoker to the manifest is the proper way to mark an app for Vista. It will run as in medium integ from explorer, etc.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">onad</span><br />
      <span class="post-time small text-muted">13th December 2006 13:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">IDEA:<br />
      Suppose you create a temporary shortcut to your application with a HOTKEY assigned then send the keymessage from within the installer then delete the shortcut again, would dat not start the application as if the user clicked on it with these rights?<br />
      <br />
      (Just trying to be creative and come up with a solution, so plz no flamewar)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Locke355</span><br />
      <span class="post-time small text-muted">13th December 2006 17:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That is an interesting idea. I am not sure how you would detect if the shortcut hotkey already existed. I also do not know if a simulated key message will trigger a shortcut hotkey.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kjk7</span><br />
      <span class="post-time small text-muted">13th December 2006 18:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">&gt; From what I understand, going from medium -&gt; low integrity is easy<br />
      &gt; because your security token essentially remains the same. However, going<br />
      &gt; from administrator -&gt; medium changes the security token. Further, when<br />
      &gt; you are using OTS (over the shoulder) promotion to some other<br />
      &gt; administrative account, the current user token is not even your own<br />
      <br />
      I don't think there is any issue with whose security token is used.<br />
      Historically, when the Setup program running with administrative<br />
      privileges shells out to your application, your application runs under<br />
      the same userid and with the same privileges as the Setup program did.<br />
      With the code discussed below, a copy of the Setup program's security<br />
      token, with the only change being its integrity level, is used for the<br />
      child process.<br />
      <br />
      The attached code, adapted from <a href="http://weblogs.asp.net/kennykerr/archive/2006/09/29/Windows-Vista-for-Developers-_1320_-Part-4-_1320_-User-Account-Control.aspx," target="_blank">http://weblogs.asp.net/kennykerr/arc...-Control.aspx,</a><br />
      seems to work for me.<br />
      <br />
      It should be launched from a cmd.exe session with High integrity.<br />
      It then launches Notepad with Medium integrity.<br />
      <br />
      The attached screen shot shows the Administrative cmd.exe window, a<br />
      message box from the test program, and Notepad. It also shows output<br />
      from the current version of Sysinternals' Process Explorer, showing the<br />
      cmd.exe window with High integrity and Notepad with Medium integrity.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Locke355</span><br />
      <span class="post-time small text-muted">14th December 2006 20:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have not run your test code, but, I am curious: if you run the installer with OTS elevation (standard user has admin type in his password to run the app), and use your approach, the program which is run at the end of the install (in this case, notepad.exe) will run as the admin account, no? As a user, I would expect the installed application to run as the standard user, not the administrator.<br />
      <br />
      Also, when an admin initiates the installer, are the privilege flags identical in the launched app to any other app run w/ medium integrity from explorer? You can check this by right clicking on the process in proc explorer, and going to the security tab.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">trumpetinc</span><br />
      <span class="post-time small text-muted">2nd October 2007 21:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">This thread is fairly dated now, but I came across it while looking for a solution to installers for Vista, so I thought I'd point out the following plugin:<br />
      <br />
      <a href="http://nsis.sourceforge.net/UAC_plug-in" target="_blank">http://nsis.sourceforge.net/UAC_plug-in</a><br />
      <br />
      It allows your installer to run with elevated permissions, and still drop back to the regular user login for launching apps post-install.<br />
      <br />
      The strategy from kjk7 up above about running with a decreased integrity levels won't work in the general case because the user may be using Run As... to launch the installer (or may elevate into a different user entirely if the current user doesn't have admin rights to begin with).<br />
      <br />
      Definitely recommend the UAC plugin - it works like a champ.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
