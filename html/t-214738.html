<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="installing an older version of a system DLL?"><title>installing an older version of a system DLL? - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">installing an older version of a system DLL?</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=214738">installing an older version of a system DLL?</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">haigha</span><br><span class="post-time small text-muted">2nd May 2005 19:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>installing an older version of a system DLL?</strong><br>I am trying to find a way to get NSIS to install an older version of a system DLL. The reason is that DirectShow's latest debug DLLs do not match the versions of the DLLs in XP SP2. I have found an article explaining how to manually disable WFP so that these DLLs can be replaced but I would rather have an installer do it.<br><br>Deleting the file manually and having an NSIS installer uninstall it with doesn't work because of WFP.<br><br>Here is the command I tried:<br><br>!insertmacro InstallLib REGDLL NOTSHARED REBOOT_NOTPROTECTED debug\quartz.dll $SYSDIR\quartz.dll $SYSDIR<br><br>but this doesn't work because the current version is newer.<br><br>I found the information on the ability to call a system DLL in the Help file and found some information about disabling WFP here:<br><br><a href="http://www.bitsum.com/aboutwfp.asp" target="_blank">http://www.bitsum.com/aboutwfp.asp</a><br><br>Is there a way to use System::Call to call:<br><br>SetSfcFileException(0, L"c:\\windows\\system32\quartz.dll",-1);<br><br>is SFC_OS.DLL?<br><br>I noticed that the System:Call docs talk about strings as parameters but not wide strings. It would obviously be better if the Windows system path used $SYSDIR instead of being hard coded.<br><br>Or maybe there is a better technique than using SFC_OS?<br><br>Thanks.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Comperio</span><br><span class="post-time small text-muted">3rd May 2005 00:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You can start introducing stability problems in the target system if you start messing with system DLL's. This is the whole reason behind Windows' system file protection in the first place.<br><br>But, even though you might not be able to replace the system DLL, you may be able to include the old DLL in the same folder as the software's EXE.<br><br>Here's a link from Microsoft that offers a few such tricks. (There's a section called "private dlls" that I found especially interesting...):<br><br><a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dnsetup/html/dlldanger1.asp" target="_blank">http://msdn.microsoft.com/library/de...dlldanger1.asp</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">haigha</span><br><span class="post-time small text-muted">3rd May 2005 01:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks for the response.<br><br>I understand the risks of replacing system DLLs. The quartz.dll is not an essential component for Windows boot and there are advantages to having the debug DLL there.<br><br>I don't think the private DLL approach will work in this case because quartz.dll is a COM DLL and, AFAIK, there can only be one registered version on the system.<br><br>In any case, I'm interested in bypassing WFP. This is not for a customer deliverable installer. The reason is that I would rather have an installer that turns off WFP temporarily for this one file instead of disabling and enabling it entirely. This will make it easier to install and uninstall the debug DLL.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Comperio</span><br><span class="post-time small text-muted">3rd May 2005 03:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I did some more research on the subject. Alas, it appears as if Microsoft has disabled WFP on XP service pack 2.<br><br>But, I did find at least one article from a 3rd party site explaining how to hack the setting, but in involves manually editing the sfc_os.dll file with a hex editor:<br><a href="http://www.windowsnetworking.com/articles_tutorials/Tweaking-XP-Windows-File-Protection-SP2.html" target="_blank">http://www.windowsnetworking.com/art...ction-SP2.html</a><br><br>USE AT YOUR OWN RISK! :eek:</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">haigha</span><br><span class="post-time small text-muted">3rd May 2005 04:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">In my original post, I linked to a site that explains WFP and how the SFC_OS.DLL has to be hacked to disable it. They even have a tool to do it:<br><br><a href="http://www.bitsum.com/index.asp#WfpAdmin" target="_blank">http://www.bitsum.com/index.asp#WfpAdmin</a><br><br>But what I am asking is how to replace a system DLL with an older version in an NSIS installer. That is why I am posting on this forum.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Comperio</span><br><span class="post-time small text-muted">3rd May 2005 14:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Very sorry--I missed that first link.<br>Unfortunatley, making system calls is one thing that I still haven't played with much. :(<br><br>You have striked my interest however, so I may try to play with it some just to see if I can do it.<br><br>(Sorry I couldn't be more help...)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">haigha</span><br><span class="post-time small text-muted">3rd May 2005 15:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I appreciate your efforts :) It seems MS has gone to great lengths to stop us from doing disabling WFP but in this case it is necessary to install the debug DLL.<br><br>One thing that is not clear to me is if the call to SetSfcFileException can be made successfully from an installer.<br><br>A problem I forsee is that there doesn't seem to be a facility to pass a wide char string into NSIS's System:Call.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">3rd May 2005 20:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">System::Call accepts wide char strings. Simply use the w type. There is an example usage in the readme that retrieves the current wallpaper. It uses a wide char string:</p><pre>
<code>System::Call "$0-&gt;4(w .r2, i ${NSIS_MAX_STRLEN}, i 0)"</code>
</pre></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">haigha</span><br><span class="post-time small text-muted">3rd May 2005 20:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks Kichik. The docs I saw for System::Call didn't mention the 'w' type.<br><br>Can you show me how to translate the following into a NSIS code with a System:Call using the SYSDIR variable for the path to quartz.dll? I find the syntax for this feature confusing and since I don't know if the call will work anyway it will be hard to debug.<br><br>SetSfcFileException(0, "c:\\windows\\system32\quartz.dll",-1);<br><br>the system DLL is SFC_OS.DLL.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">3rd May 2005 20:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Take a look at the updated System documentation. If you don't have it at Contrib\System\System.html becuase you're using an old version, you can view it at:<br><br><a href="http://cvs.sourceforge.net/viewcvs.py/*checkout*/nsis/NSIS/Contrib/System/System.html" target="_blank">http://cvs.sourceforge.net/viewcvs.p...em/System.html</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">haigha</span><br><span class="post-time small text-muted">3rd May 2005 21:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks for the pointer. I hadn't seen that document. This is what I have in my installer:<br><br>System::Call 'SFC_OS::SetSfcFileException(i 0, w "c:\windows\system32\quartz.dll", i -1)'<br><br>Delete $SYSDIR\quartz.dll<br><br>!insertmacro InstallLib REGDLL NOTSHARED REBOOT_NOTPROTECTED XPSP1\quartz.dll $SYSDIR\quartz.dll $SYSDIR<br><br>I can see that the quartz.dll is getting replaced with the older one but before five seconds have elapsed WFP is putting the old one back.<br><br>Can you see anything obviously wrong or think of another way of achieving this?<br><br>I appreciate the help.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">haigha</span><br><span class="post-time small text-muted">3rd May 2005 21:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">"I can see that the quartz.dll is getting replaced with the older one but before five seconds have elapsed WFP is putting the old one back."<br><br>By "old one back" I mean WFP is replacing the older DLL with the SP2 dll.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">3rd May 2005 21:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Get SetSfcFileException's return value and check if it failed or not.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">haigha</span><br><span class="post-time small text-muted">3rd May 2005 22:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">System::Call "SFC_OS::SetSfcFileException(i 0, w '%SystemRoot%/system32/quartz.dll', i 600000000) .r0"<br><br>MessageBox MB_OK|MB_ICONINFORMATION "Return value from SFC_OS: $0"<br><br>I've tried a bunch of things including changing the path. Whe message box returns $0 as the text 'Error'.<br><br>Does this mean that it couldn't call SetSfcFileException at all?<br><br>Is there anything I need to do before using System::Call with it?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">haigha</span><br><span class="post-time small text-muted">3rd May 2005 23:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">1. I noticed that the original article I pointed to had both SfcFileException and SetSfcFileException. I believe the former is correct but it may have been taken out of SP2's sfc_os.dll... I can't find it with a hex editor :(<br><br>2. I have found the SfcIsFileProtected call and it works. (returns 1 if it is protected and 0 if you pass in an unprotected file). This may be useful to others. Unfortunately it doesn't solve the problem I'm facing.<br><br>Problems:<br><br>SfcFileException is still returning "error" in the code $1<br><br><br>System::Call "SFC_OS::SfcIsFileProtected(i 0, w 'c:\windows\system32\quartz.dll') i.r2"<br>MessageBox MB_OK|MB_ICONINFORMATION "Return value from SFC_OS: $2"<br><br>System::Call "SFC_OS::SfcFileException(i 0, w 'c:\windows\system32\quartz.dll', i -1) i.r2"<br>MessageBox MB_OK|MB_ICONINFORMATION "Return value from SFC_OS: $2"</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">5th May 2005 17:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You don't search for exported functions using a hex editor. That's what <a href="http://www.dependencywalker.com/" target="_blank">Dependency Walker</a> for. If SfcFileException and SetSfcFileException don't show in the exported functions list of SFC_OS, that would be the problem. In a basic System::Call usage, like in your case, that's the only possible cause for "error" to be returned.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">haigha</span><br><span class="post-time small text-muted">5th May 2005 18:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks for the tip :) I have used Depends to see dependent DLLs of a program before but didn't realize it showed the exported functions from a DLL.<br><br>As you wrote, SfcFileException is no longer available. Probably viewed as a security hole by MS.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">s793016</span><br><span class="post-time small text-muted">16th May 2005 18:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Sorry, my English is very very poor.<br><br>I found something may useful at <a href="http://www.frame4.com/cms/stories/guides_&amp;_papers/windows_file_protection:_how_to_disable_it_on_the_fly_200411254795.html" target="_blank">here</a>.<br><br>Maybe some program master want to transform that code into an pug-in dll or an uneful function?<br><br>Thanks for that.</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>