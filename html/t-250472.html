<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Set an event during uninstall" />

  <title>Set an event during uninstall - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Set an event during uninstall</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=250472">Set an event during uninstall</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jasonhi</span><br />
      <span class="post-time small text-muted">6th July 2006 01:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Set an event during uninstall</strong><br />
      I'm trying to use System::call to set an event while uinstalling which will cause my application to quit.<br />
      <br />
      I've seen references to ways of checking if a process is running, however for many users being told that something is running doesn't help them figure out how to remove the program. And killing the process seems fairly evil too. So I'd rather build a mechanism into my app to nicely exit.<br />
      <br />
      Here's a code snippet:<br />
      <br />
      System::Call "kernel32::OpenEventA(i 1048578, i 0, t 'myAppShutdownEvent') i .r0"<br />
      IntCmp $0 0 eventNotFound<br />
      System::Call "kernel32::SetEventA( i r0 ) i .r1"<br />
      goto processNotRunning<br />
      <br />
      eventNotFound:<br />
      ...<br />
      processNotRunning:<br />
      ...<br />
      <br />
      It seems like this should work, but I get a questionable value back in $0 from OpenEvent (usually a number between 100-200). Clearly that's not null, but its a pretty low number for a handle too. (My C++ test program that sets this event typically gets a handle value in the 4000 range (i.e. $ff4 most of the time today...).<br />
      <br />
      And SetEvent is definitely not setting the event with that return as the handle.<br />
      <br />
      I'm sure its something obvious I'm missing, but I can't figure it out, and haven't been able to find anything similar enough already asked or in the FAQs to get past this.<br />
      <br />
      Thanks!<br />
      ...Jason</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">6th July 2006 09:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">It might be an idea to replace 1048578 with the actual constants that you used with mod signs in between. I'm sure you've got the value right, but it's worth a try.<br />
      <br />
      -Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Mr Inches</span><br />
      <span class="post-time small text-muted">6th July 2006 14:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">By inspection, your permissions value looks OK, being a combination of SYNCHRONIZE (0x00100000L) and EVENT_MODIFY_STATE (0x0002). I suggest that you make these two values into NSIS !defines and use these in your code as this will greatly improve its readability.<br />
      <br />
      If OpenEvent fails it sets the system error value, which you can retrieve from the System plugin by using the '?e' option as part of the return value section of the call (if my memory serves - it is mentioned in the doco for the System plugin). This will give you some clues as to what is amiss.<br />
      <br />
      Common reasons for the OpenEvent failing (apart from the obvious such as Event does not exist) include inheritance issues i.e. trying to open an event that the parent process does not mark for its children to inherit, not opening the Event with sufficient permissions, and an invalid permissions value.<br />
      <br />
      You really need that information from GetLastError to determine what exactly is going on.<br />
      <br />
      BTW: What you are doing is defnitely possible - I have done it from completely within NSIS, using an Event to pass control from one instance of a NSIS program to another instance of the same program; all done with System plugin calls.<br />
      <br />
      Duncan</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jasonhi</span><br />
      <span class="post-time small text-muted">11th July 2006 00:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Duncan,<br />
      <br />
      It appears GetLastError is returning 126 (ERROR_MOD_NOT_FOUND). Since kernel32.dll clearly isn't missing, I'm not sure this helps any...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">19th July 2006 15:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The System plug-in itself usually raises ERROR_MOD_NOT_FOUND with some LoadLibrary calls. This is why you should use the "?e" modifier, instead of calling GetLastError with System.dll itself. Have you used the modifier or GetLastError directly?</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
