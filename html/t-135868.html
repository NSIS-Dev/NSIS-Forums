<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="RegDLL issue" />

  <title>RegDLL issue - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">RegDLL issue</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=135868">RegDLL issue</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">nsis_user</span><br />
      <span class="post-time small text-muted">19th May 2003 11:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>RegDLL issue</strong><br />
      Hi all,<br />
      <br />
      I need some clarification here regarding the workings of the function RegDLL. I'm using NSIS 1.98 btw.<br />
      <br />
      My software has 2 dlls, say A and B. A contains a COM object and requires registration whereas B is simply a dll containing a number of export functions. However, A depends on B.<br />
      <br />
      In the install script, I first unpack the files into the target dir (using file) after which I call RegDLL on A. At this point, I get an error msg saying that dll B cannot be found. I believe this is because dll B is not on the search path nor the current working dir.<br />
      <br />
      2 question:<br />
      <br />
      1) How can I change the working directory of the installer?<br />
      2) How does it load and call DllRegisterServer exactly? I'm asking this becuz I've actually written code in DLL A's DLLMain to set the working dir (using SetCurrentDir()) to where dll A is located. However, it appears that RegDLL does not even call DLLMain.<br />
      <br />
      Any help will be appreciated.<br />
      <br />
      Cheers</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">19th May 2003 13:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You can't change the working directory in NSIS 1.98. It's possible using SetOutPath in the latest beta version of NSIS 2.<br />
      <br />
      DllMain should be called because NSIS uses LoadLibrary and not LoadLibraryEx with the LOAD_LIBRARY_AS_DATAFILE flag. If dll A depends on dll B statically then Windows itself will look for the DLL before DllMain is called. If Windows can't find dll B it won't call DllMain. Is dll B statically or dynamically linked to dll A?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">19th May 2003 13:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Checked a little more and according to this quote from MSDN DllMain might be called before it loads dll B:<br />
      <br /></p>

      <blockquote>
        It is safe to call other functions in Kernel32.dll, because this DLL is guaranteed to be loaded in the process address space when the entry-point function is called. It is common for the entry-point function to create synchronization objects such as critical sections and mutexes, and use TLS. Do not call the registry functions, because they are located in Advapi32.dll. If you are dynamically linking with the C run-time library, do not call malloc; instead, call HeapAlloc.
      </blockquote>I guess it would later call DllMain with DETACH flag if it did call it before all of the DLLs loaded and later failed to load all of the DLLs. I have never seen this happen, but if Microsoft say... :)<br />
      <br />
      Just in case you were wondering, SetCurrentDirectory is in Kernel32.dll.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">nsis_user</span><br />
      <span class="post-time small text-muted">20th May 2003 02:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thats weird. Cuz I tried it with RegSvr32 (outside of the dll paths) and it works like a charm. However, RegDll still fails. :(</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">21st May 2003 13:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Maybe RegSvr32 changes the working directory.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">nsis_user</span><br />
      <span class="post-time small text-muted">22nd May 2003 03:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Nope, regsvr32 didn't but I did. I've placed code to change the current working dir in the DLLMain function.<br />
      <br />
      Apparently, regsvr32 calls DLLMain but RegDLL doesn't! Thats what puzzling me.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">22nd May 2003 17:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Is dll B statically or dynamically linked?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">nsis_user</span><br />
      <span class="post-time small text-muted">23rd May 2003 08:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">correct me if i'm wrong, but i've always thought that statically linked libraries gets compiled into the module hence you will not have to distribute them? i.e. in my case, it will be dynamically linked cuz I have to distribute dll B along with my dll A.<br />
      <br />
      Are u referring to load-time dynamic linking (i.e. linking with the import lib) vs run-time dynamic linking (i.e. using LoadLibrary)? FYI, i am using load-time dynamic linking.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">23rd May 2003 14:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Sorry, wrong terms, you're right. I did mean to ask if you're loading it at run-time or load-time.<br />
      <br />
      I'll have a deeper look at this, but in the mean time you can use b3 and SetOutPath to set the working directory.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">27th May 2003 15:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have tested this on Windows 98 and XP and nither regsvr32 nor RegDLL have called DllMain when the linked DLL could not be found. I have also checked regsvr32 and according to all of the sources I have found regsvr32 does only one action on top of what RegDLL does and this action has nothing to do with this case.<br />
      <br />
      What version of Windows are you using?<br />
      <br />
      BTW, to make sure that DllMain is not called I have used FatalAppExit in it.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">nsis_user</span><br />
      <span class="post-time small text-muted">28th May 2003 03:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I've tried it on both WinXP and Win95. BTW, I've just tried using regsvr32 again on my dll with the SetCurrentDirectory code taken out and it still works! (??) I'm guessing that regsvr32 internally switches the working directory to that of the dll.<br />
      <br />
      Anyhow, here's the exact step I've tried:<br />
      <br />
      In my dll (assume its called mydll.dll)'s DllMain, I've put in code to prompt a messagebox (duh!)<br />
      <br />
      Next I place the dll and the linked dll into a folder called c:\testing<br />
      <br />
      finally I run regsvr32 as follows (notice that the working dir is outside c:\testing):<br />
      <br />
      c:\regsvr32 .\testing\mydll.dll</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">28th May 2003 15:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">After moving DLL B to the same folder as DLL A RegSvr32 started working, yet RegDLL failed. I have absolutely <b>no</b> idea why this happens. I can't find anything about RegSvr32 doing more... I have also tried adding the one function that RegSvr32 uses and NSIS doesn't, which has nothing to do with LoadLibrary, and it still failed. I have even tried using SearchPath to see if RegSvr32 somehow changes the PATH enviornment variable or the current directory but SearchPath, which has the exact search pattern as LoadLibrary, failed to find the file.<br />
      <br />
      You would have to set the current directory using a simple plug-in or move to NSIS 2 and use SetOutPath. In any case, do not call RegSvr32 to do this because it doesn't exist on Windows 95.<br />
      <br />
      BTW, calling MessageBox from DllMain is not a good idea according to that MSDN quote I have pasted above.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">nsis_user</span><br />
      <span class="post-time small text-muted">28th May 2003 15:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        You would have to set the current directory using a simple plug-in or move to NSIS 2 and use SetOutPath. In any case, do not call RegSvr32 to do this because it doesn't exist on Windows 95.
      </blockquote>RegSvr32 does exist on windows 95 (I've tested it on win95 remember?), just that its not in the System32 folder :)<br />
      <br />

      <blockquote>
        BTW, calling MessageBox from DllMain is not a good idea according to that MSDN quote I have pasted above.
      </blockquote>Yep. I read. I was just doing that for testing purposes.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">29th May 2003 09:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I can't find anything official from Microsoft (why am I not surprised?) but according to Joost, some news posts I have found using Google and the fact that other installers don't use RegSvr32 and RegSvr32 being available for download on the Microsoft website RegSvr32 is not included in the first versions of Windows 95.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">nsis_user</span><br />
      <span class="post-time small text-muted">30th May 2003 06:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">ah... you might be right there.. I was testing in Win95 OSR2</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
