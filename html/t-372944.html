<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Check existing file associations"><title>Check existing file associations - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Check existing file associations</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=372944">Check existing file associations</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">empezar</span><br><span class="post-time small text-muted">10th October 2013 22:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Check existing file associations</strong><br>Is there a way to check if a certain filetype is already associated with a program?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">10th October 2013 22:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The documented way to do this is with the Assoc* API, but guess what, it sucks:</p><ol style="list-style-type: decimal"><li>It does not check "deep enough" (SystemFileAssociations etc), it only checks HKCR\.exe and its HKCR\ProgId mapping but for most people that is probably fine. But just because the API said no does not mean that doubleclicking the file will fail or open the openwith dialog. The filetype could have something under SystemFileAssociations or there could be a registered dynamic verb (IContextMenu).</li><li>stackoverflow.com/questions/18682679/using-assocquerystring-to-get-64-bit-application-command-from-32-bit-application</li></ol><br><blockquote>!include Win\COM.nsh<br>!include LogicLib.nsh<br>!define ASSOCF_NOFIXUPS 0x0100<br>!define ASSOCF_IGNOREBASECLASS 0x0200<br>!define ASSOCSTR_COMMAND 1<br>!define ASSOCKEY_SHELLEXECCLASS 1<br>!define AT_FILEEXTENSION 0<br>!define AL_EFFECTIVE 1<br><br>StrCpy $2 ".txt"<br><br>; Choose one of these 3 methods, IApplicationAssociationRegistration is Vista+ and AssocQuery* is IE5/Win98SE/2000+<br><br>!insertmacro ComHlpr_CreateInProcInstance ${CLSID_ApplicationAssociationRegistration} ${IID_IApplicationAssociationRegistration} r1 ""<br>${If} $1 &lt;&gt; 0<br>${IApplicationAssociationRegistration::QueryCurrentDefault} $1 '("$2",${AT_FILEEXTENSION},${AL_EFFECTIVE},0r3).r0'<br>DetailPrint "HRESULT=$0,ProgId WStr pointer=$3"<br>${If} $0 = 0<br>System::Call *$3(&amp;w1024.r0)<br>System::Call OLE32::CoTaskMemFree(ir3)<br>DetailPrint "SUCCESS: ProgId=$0"<br>${EndIf}<br>${IUnknown::Release} $1 ""<br>${EndIf}<br><br>System::Call 'SHLWAPI::AssocQueryString(i${ASSOCF_NOFIXUPS}|${ASSOCF_IGNOREBASECLASS},i${ASSOCSTR_COMMAND},t"$2",i0,t.r1,*i1024)i.r0'<br>DetailPrint "HRESULT=$0,Cmd=$1"<br><br>System::Call 'SHLWAPI::AssocQueryKey(i${ASSOCF_NOFIXUPS},i${ASSOCKEY_SHELLEXECCLASS},t"$2",i0,*i0r1)i.r0'<br>DetailPrint "HRESULT=$0"<br>${If} $0 = 0<br>System::Call 'ADVAPI32::RegCloseKey(i$1)'<br>DetailPrint "SUCCESS: $2 is registered"<br>${EndIf}</blockquote></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">empezar</span><br><span class="post-time small text-muted">10th October 2013 23:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I can't get that code to work. What is COM.nsh?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">11th October 2013 00:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by empezar</small><br>I can't get that code to work. What is COM.nsh?</blockquote>I believe that code should work on 2.46 but I only tested on 3.0, anyway, the AssocQueryString line is probably the method you want...</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">empezar</span><br><span class="post-time small text-muted">11th October 2013 10:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">That worked, though I don't know what to do with the result.<br><br>HRESULT is always 0 even if the file is not associated, because it's always associated with either a program or the "Open with"-program.<br><br>How do I tell if "rundll32" can be found within the $1 string? StrContains doesn't work because it seems to be looking to match a whole word, while "rundll" is just a part of the program path.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">11th October 2013 19:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by empezar</small><br>HRESULT is always 0 even if the file is not associated, because it's always associated with either a program or the "Open with"-program.</blockquote>And you used ASSOCF_IGNOREBASECLASS? Which extension are you checking and which OS is this?</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">empezar</span><br><span class="post-time small text-muted">11th October 2013 22:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Yes. I've tried the bottom two methods. Both of them fail to differentiate between associated and not associated file types. I've tested the file types "qwz" and "qwp", where "qwz" files open with ezQuake when double clicked. Using Windows 7 64-bit.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">12th October 2013 04:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You can try adding ASSOCF_INIT_IGNOREUNKNOWN (0x00000400) as well but openwith was never returned for me when I tested on Win7 (32bit).<br><br>The following code is a bad attempt at doing it manually, it is incomplete and half of this stuff is probably undocumented.<br></p><blockquote>!include LogicLib.nsh<br>Section<br>StrCpy $2 ".flac"<br>;BUGBUG: Should check HKLM\Software\Microsoft\Windows\CurrentVersion\Explorer\KindMap\.ext first?<br>ReadRegStr $0 HKCU "Software\Microsoft\Windows\CurrentVersion\Explorer\FileExts\$2\UserChoice" "ProgId"<br>Push $0<br>Call Assoc_RedirectProgId<br>Pop $0<br>Push $0<br>Call Assoc_QueryHasKey<br>Pop $1<br>${If} $1 = 0 ; ProgId did not exist?<br>${OrIf} $0 == "" ;UserChoice did not exist?<br>ReadRegStr $0 HKCR $2 ""<br>Push $0<br>Call Assoc_RedirectProgId<br>Pop $0<br>${EndIf}<br>Push $0<br>Call Assoc_QueryProgIdDefVerb<br>Pop $1<br>${IfThen} "$0$1" != "$1$0" ${|} Goto assoc_done ${|}<br>StrCpy $0 "SystemFileAssociations\$2"<br>Push $0<br>Call Assoc_QueryProgIdDefVerb<br>Pop $1<br>${IfThen} "$0$1" != "$1$0" ${|} Goto assoc_done ${|}<br><br>ReadRegStr $0 HKCR $2 "PerceivedType"<br>${If} $0 != ""<br>StrCpy $0 "SystemFileAssociations\$0"<br>Push $0<br>Call Assoc_QueryProgIdDefVerb<br>Pop $1<br>${IfThen} "$0$1" != "$1$0" ${|} Goto assoc_done ${|}<br>${EndIf}<br><br>ReadRegStr $0 HKCR "SystemFileAssociations\$2" "PerceivedType"<br>${If} $0 != ""<br>StrCpy $0 "SystemFileAssociations\$0"<br>Push $0<br>Call Assoc_QueryProgIdDefVerb<br>Pop $1<br>${IfThen} "$0$1" != "$1$0" ${|} Goto assoc_done ${|}<br>${EndIf}<br><br>;BUGBUG: If we still have not found anything we are supposed to look under %ProgId/UserChoice%\Clsid\ for a GUID and its ShellFolder data, what to do after that I did not investigate<br>;NOTE: Last resort is to look under HKCR\*, HKCR\AllFilesystemObjects and finally HKCR\Unknown but that is not a good idea for what we are trying to detect, skipping<br><br>assoc_done:<br>${If} "$0$1" != "$1$0"<br>DetailPrint $2:PID=$0,Verb=$1<br>${EndIF}<br>SectionEnd<br><br>Function Assoc_QueryHasKey<br>Exch $0<br>Push $1<br>ClearErrors<br>EnumRegKey $1 HKCR $0 0<br>IfErrors 0 yes<br>EnumRegValue $1 HKCR $0 0<br>StrCpy $1 ""<br>IfErrors done<br>yes:<br>StrCpy $0 "1$1" ; &lt;&gt; 0 for checking and store subkey if found<br>done:<br>Pop $1<br>Exch $0<br>FunctionEnd<br><br>Function Assoc_QueryHasNamedValue<br>Exch $0 ;name<br>Exch<br>Exch $1 ;key<br>Push $2<br>Push $3<br>StrCpy $3 0<br>loop:<br>ClearErrors<br>EnumRegValue $2 HKCR $1 $3<br>IfErrors done<br>IntOp $3 $3 + 1<br>StrCmp $0 $2 0 loop<br>StrCpy $2 1<br>done:<br>StrCpy $0 $2<br>Pop $3<br>Pop $2<br>Pop $1<br>Exch $0<br>FunctionEnd<br><br>Function Assoc_RedirectProgId<br>Exch $0<br>Push $1<br>ReadRegStr $1 HKCR "$0\CurVer" ""<br>StrCmp $1 "" +2<br>StrCpy $0 $1<br>Pop $1<br>Exch $0<br>FunctionEnd<br><br>Function Assoc_QueryProgIdDefVerb<br>Exch $0<br>Push $1 ; save reg<br>Push $2<br>Push $0<br>Push "NoStaticDefaultVerb"<br>Call Assoc_QueryHasNamedValue<br>Pop $1<br>${If} $1 &lt;&gt; 0<br>StrCpy $0 ""<br>${Else}<br>StrCpy $1 $0<br>ReadRegStr $0 HKCR "$1\Shell" "" ; BUGBUG: The default verb string can contain space/comma separated verb names, parsing required<br>${IfThen} $0 == "" ${|} StrCpy $0 "open" ${|}<br>Push "$1\Shell\$0"<br>Call Assoc_QueryHasKey<br>Pop $2<br>${If} $2 = 0<br>Push "$1\Shell"<br>Call Assoc_QueryHasKey<br>Pop $2<br>StrCpy $0 $2 "" 1<br>${If} $2 &lt;&gt; 0<br>${AndIf} $0 != ""<br>Push "$1\Shell\$0"<br>Call Assoc_QueryHasKey<br>Pop $2<br>${IfThen} $2 = 0 ${|} StrCpy $0 "" ${|}<br>${EndIf}<br>${EndIf}<br>${EndIf}<br>Pop $2 ;restore reg<br>Pop $1<br>Exch $0<br>FunctionEnd</blockquote></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">empezar</span><br><span class="post-time small text-muted">12th October 2013 11:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I've tried upgrading to NSIS 3.0 to no avail in this matter.<br><br>Tried both IApplicationAssociationRegistration and AssocQuery*.<br><br>Nothing works.<br><br>I'd rather not use undocumented "bad attempts" at solving this matter, and simply checking for a file association shouldn't require that much code?<br><br>How do I check for associations using the documented version? The Assoc* API you mentioned? I can only find information on how to SET and REMOVE associations using that thing.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">12th October 2013 17:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by empezar</small><br>How do I check for associations using the documented version? The Assoc* API you mentioned? I can only find information on how to SET and REMOVE associations using that thing.</blockquote>AssocQueryString and there is no API to Set/Remove, only query, not sure what you are looking at...</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">stass</span><br><span class="post-time small text-muted">14th October 2013 05:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">With what program associated specific files can be found as follows:<br></p><blockquote>OutFile "opens_by_default.exe"<br>; For example HTM files<br>Section<br>StrCpy $R1 htm<br>FileOpen $0 "$TEMP\opens_by_default.$R1" "w"<br>FileClose $0<br>System::Call "Shell32::FindExecutable(t '$TEMP\opens_by_default.$R1', i 0, t .r1)"<br>Delete "$TEMP\opens_by_default.$R1"<br>MessageBox MB_OK '$R1 files by default opens the program: : $1 '<br>SectionEnd</blockquote></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">14th October 2013 21:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">shell32!FindExecutableW on Win7(x86) uses AssocQueryString(ASSOCF_INIT_IGNOREUNKNOWN,ASSOCSTR_EXECUTABLE,file,...) and XP uses AssocQueryString(0,ASSOCSTR_EXECUTABLE,file,...)</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>