<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="replacing a str"><title>replacing a str - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">replacing a str</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=118073">replacing a str</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">michiel</span><br><span class="post-time small text-muted">16th December 2002 14:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>replacing a str</strong><br>&nbsp; I need a script or function that searches an string on each line of an file and replaces that string to another string. And the file is not an *.ini file<br><br>Can someone help me with this</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br><span class="post-time small text-muted">16th December 2002 14:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><a href="http://forums.winamp.com/showthread.php?s=&amp;threadid=109670" target="_blank">http://forums.winamp.com/showthread....hreadid=109670</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">michiel</span><br><span class="post-time small text-muted">16th December 2002 16:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>replacing $INSTDIR for ServerRoot</strong><br>&nbsp; replacing $INSTDIR for ServerRoot as an string that mutiple times must be done help!!!</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">rarefluid</span><br><span class="post-time small text-muted">16th December 2002 21:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I would do it that way :<br><br>-open the file (source)<br>-open another file (target)<br>-while you don't find the string, copy the characters to the new file<br>-if you encounter the string, write the string you want as a replacement to the target file, and start reading from the sourcefile after the end of the string you encountered...<br>-do that until you have reached the end of the sourcefile...<br><br>--&gt; It uses a lot of strcmp's and you should maybe come up with a good string searching or mathing routine...<br><br>KIM</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br><span class="post-time small text-muted">16th December 2002 21:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">A string search function has been included in the NSIS 2 documentation (Useful functions appendix).</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">rarefluid</span><br><span class="post-time small text-muted">16th December 2002 21:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I don't think it is very good for this purpose, but you could modify it...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">michiel</span><br><span class="post-time small text-muted">17th December 2002 09:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>????</strong><br>&nbsp;</p><blockquote><i>Originally posted by rarefluid</i><br><b>I would do it that way :<br><br>-open the file (source)<br>-open another file (target)<br>-while you don't find the string, copy the characters to the new file<br>-if you encounter the string, write the string you want as a replacement to the target file, and start reading from the sourcefile after the end of the string you encountered...<br>-do that until you have reached the end of the sourcefile...<br><br>--&gt; It uses a lot of strcmp's and you should maybe come up with a good string searching or mathing routine...<br><br>KIM</b></blockquote>Can you give me an example because i am just a beginner and i don't get the point with the third and the fourth thing what to do?</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">rarefluid</span><br><span class="post-time small text-muted">17th December 2002 17:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">So here it is. More like brute force... ;-)<br><br><font size="1"><font face="courier new"><br>;I didn't check if this compiles, and I guess it won't.<br>;But you'll get the idea...<br>;It is VERY unefficient, but I wanted to keep it easy.<br>;it saves no variables to the stack and so on...<br>Function read_file<br>FileOpen $R9 "sourcefilename" "r"<br>StrCpy $R8 0 ;position in sourcefile<br><br>FileOpen $R7 "targetfilename" "w"<br><br>Strcpy $R1 "stringtosearchfor"<br>StrLen $R0 $R1 ;get length of searchstring<br>StrCpy $R2 $R1 1 ;get first character of searchstring<br><br>Strcpy $R4 "replacementstring_xyz"<br><br>goto searchloop<br>writechar:<br>FileWrite $R7 $R6<br>searchloop:<br>Fileread $R9 $R6 1 ;read character from file<br>IntOp $R8 $R8 + 1 ;increase position counter<br>StrCmp $R6 "" "" fileend ;have we reached the end of the file?<br>StrCmp $R6 $R2 "" writechar ;compare character to first character from searchstring<br>;HERE, the first character of the string has been found!<br>IntOp $R8 $R8 - 1 ;decrease position<br>FileSeek $R9 -1 CUR ;seek back in file<br>FileRead $R9 $R5 $R0 ;Read string with length of search string from file<br>StrCmp $R5 $R1 found ;is the string there in the file?<br>;HERE, the string has NOT been found<br>Intop $R8 $R8 + 1 ;increase original position +1<br>FileSeek $R9 $R8 ;seek original position +1 in file<br>goto writechar ;and continue searching<br>;HERE, the string has been found!<br>found:<br>FileWrite $R7 $R4 ;write replacement string to file<br>IntOp $R8 $R8 + $R0 ;set file postition to<br>Intop $R8 $R8 + 1 ;1 character behind the string we've found<br>goto searchloop<br>;HERE, the end of the file has been reached<br>fileend:<br>FileClose $R7<br>FileClose $R9<br>FunctionEnd<br></font></font><br><br>So, after this you have a new file "targetfilename" which contains the strings "searchstring" replaced by "replacementstring_xyz".<br>Hope it helps you!<br><br>P.S. : If you have a file with CRLF (linebreaks), you may want to do this differently, but i guess it will still work...<br><br>KIM</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">michiel</span><br><span class="post-time small text-muted">20th December 2002 16:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">thanks It worked</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">dsvedchenko</span><br><span class="post-time small text-muted">9th January 2003 10:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">some rework and no register are modified<br><br></p><pre>
<code>
#Function Replace String in File
<br>#     Push "&lt;File with string to replace&gt;"
<br>#     Push "old string"
<br>#     Push "new string"
<br>#     Call ReplaceInFile
<br>#
<br>#It is VERY unefficient, but I wanted to keep it easy.
<br>#it saves no variables to the stack and so on...
<br>&gt;Function ReplaceInFile
<br>  Push $R4
<br>  Push $R1
<br>  Push $R3
<br>  Exch 5
<br>  Pop  $R3
<br>  Exch 3
<br>  Pop  $R1
<br>  Exch 1
<br>  Pop  $R4
<br>  Push $R0
<br>  Push $R2
<br>  Push $R5
<br>  Push $R6
<br>  Push $R7
<br>  Push $R8
<br>  Push $R9
<br>  FileOpen $R9 $R3 "r"
<br> StrCpy $R8 0 #position in sourcefile
<br>  GetTempFileName $R0
<br>  Push $R0
<br>  FileOpen $R7 $R0 "w"
<br> StrLen $R0 $R1 #get length of searchstring
<br> StrCpy $R2 $R1 1 #get first character of searchstring
<br><br>  goto searchloop
<br>  writechar:
<br>  FileWrite $R7 $R6
<br>  searchloop:
<br> Fileread $R9 $R6 1 #read character from file
<br> IntOp $R8 $R8 + 1 #increase position counter
<br> StrCmp $R6 "" fileend #have we reached the end of the file?
<br> StrCmp $R6 $R2 "" writechar #compare character to first character from searchstring
<br>  #HERE, the first character of the string has been found!
<br> IntOp $R8 $R8 - 1 #decrease position
<br> FileSeek $R9 -1 CUR #seek back in file
<br> FileRead $R9 $R5 $R0 #Read string with length of search string from file
<br><br> StrCmp $R5 $R1 found #is the string there in the file?
<br>  #HERE, the string has NOT been found
<br> Intop $R8 $R8 + 1 #increase original position +1
<br> FileSeek $R9 $R8 #seek original position +1 in file
<br> goto writechar #and continue searching
<br>  #HERE, the string has been found!
<br> found:
<br> FileWrite $R7 $R4 #write replacement string to file
<br> IntOp $R8 $R8 + $R0 #set file postition to
<br>  #BUG ###Intop $R8 $R8 + 1 #1 character behind the string we've found
<br>  goto searchloop
<br>  #HERE, the end of the file has been reached
<br> fileend:
<br>  FileClose $R7
<br>  FileClose $R9
<br>  Pop $R0
<br>  CopyFiles/FILESONLY $R0 $R3
<br>  Pop $R9
<br>  Pop $R8
<br>  Pop $R7
<br>  Pop $R6
<br>  Pop $R5
<br>  Pop $R2
<br>  Pop $R0
<br>  Pop $R4
<br>  Pop $R1
<br>  Pop $R3
<br>FunctionEnd 
<br>&gt;
</code>
</pre>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>