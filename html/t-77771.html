<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Upgrade_Macro Corrected" />

  <title>Upgrade_Macro Corrected - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Upgrade_Macro Corrected</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=77771">Upgrade_Macro Corrected</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Bugge T. Jensen</span><br />
      <span class="post-time small text-muted">28th February 2002 15:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Upgrade_Macro Corrected</strong><br />
      &nbsp; Hi<br />
      Found and corrected a bug in the Update_macro .<br />
      <br />
      Now it also works for changes in minor version numbers<br />
      <br />
      <br />
      Can someone please include that in the next release....</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mmullikin</span><br />
      <span class="post-time small text-muted">31st March 2002 17:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Here is one that combines yours with CodeSquid's and my fix that seems to do it all!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mmullikin</span><br />
      <span class="post-time small text-muted">2nd April 2002 01:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Damn, the attachment failed. Let's try it again.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">simham_uk</span><br />
      <span class="post-time small text-muted">29th June 2002 12:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have part modified the already modified UpgradeDLL Macro, to add a prompt (if defined) to ask the user "Do you want to overwrite this file" type of thing.<br />
      <br />
      I've also modifed it so that the push described in usage isn't required anymore.<br />
      <br />
      You can now run the macro like:<br />
      <br /></p>
      <pre>
!insertmacro UpgradeDLL "atl.dll" "$SYSDIR\\atl.dll" "PARANOID"
<br />&gt;!insertmacro UpgradeDLL "atl.dll" "$SYSDIR\\atl.dll" "EASYGOING" 
</pre>The first one prompts the user, the second one doesn't.<br />
      <br />
      Now, it still needs work, and the reason is that I haev replaced all the $0 with ${DLL_LOCATION} for usage changes above, so since I'm not really confident working the stack, I haven't changed any other vars or the push/pop's in the macro.<br />
      <br />
      Perhaps someone could have a look at the attachment, and make the necessary changes.<br />
      <br />
      BTW, if the changes I've made are utter rubbish, please let me know!
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">simham_uk</span><br />
      <span class="post-time small text-muted">29th June 2002 12:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Macros v Functions</strong><br />
      &nbsp; Just a quick query, but if this were a function would it create less bloat than being a macro.<br />
      <br />
      What I mean is, does the macro get inserted into the code (during compile) every time it is called? and does this happen with functions?<br />
      <br />
      The reason I ask, is I'm playing with an installer that will add some 25 DLL/OCX/EXE's that I may have to run through this, so I'm just thinking of trying to keep the size down.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br />
      <span class="post-time small text-muted">29th June 2002 13:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Yes a macro is inserted every time it is called. You can see this if you create a simple macro that has a label in it. If you !insertmacro the simple macro twice in a row in the same scope the compiler moans about a duplicate defined label.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">simham_uk</span><br />
      <span class="post-time small text-muted">29th June 2002 13:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>More mods</strong><br />
      &nbsp; I've made another modification to the macro to allow for a path to the file.<br />
      <br />
      The macro would now be called with:<br />
      <br /></p>
      <pre>
!insertmacro UpgradeDLL "D:\\DEV\\Poject\\" "atl.dll" "$SYSDIR\\\atl.dll" "PARANOID"
<br />&gt;!insertmacro UpgradeDLL "D:\\\DEV\\\Poject\\\" "atl.dll" "$SYSDIRatl.dll" "EASYGOING" 
<br />&gt;

</pre>And the changes to the "File/s" are:<br />
      <br />
      <pre>
<code>
File /oname=$5 "${DLL_FILE_PATH}${DLL_NAME}"
<br />&gt;; and 
<br />&gt;File /oname=${DLL_LOCATION} "${DLL_FILE_PATH}${DLL_NAME}" 
</code>
</pre>I hope I aint barking up the wroong tree here, but this will make the macro more flexible regarding the location of "File"<br />
      <br />
      Does this make sense?<br />
      <br />
      (modified script attached)
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">eccles</span><br />
      <span class="post-time small text-muted">29th June 2002 22:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Simon,<br />
      <br />
      The 'GetDLLVersionLocal' and 'File' commands in there stop the whole thing being a function, as the filenames to those commands need to be fixed at script compile time, which isn't possible with something like "File $1".<br />
      <br />
      As for $0 - you can safely just remove the "Exch $0" and "Pop $0" lines now that it is not used.<br />
      <br />
      Back to macro/function - everything other than the commands mentioned would be perfectly fine in a function. Maybe things can be changed so that those bits are in a function with a small macro to perform the File commands before passing on to the function.<br />
      <br />
      I could have a go at doing that if you like, but you'd have to test it ;)<br />
      <br />
      --<br />
      Dave.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">simham_uk</span><br />
      <span class="post-time small text-muted">29th June 2002 23:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks!<br />
      <br />
      Testing something like this is tricky. I test other software, and when messing with windows system files, it can get ugly...thankfully it wasn't me building the installers (IS...uggh), but we did kill a few systems!<br />
      <br />
      Anyhoo, I'm obviously trying to do this because I AM intending to use it, and test it of course, so I'll give it a go.<br />
      <br />
      What I'm essentially trying to do is build a macro that will handle all file installations, by checking versions, or file dates.<br />
      <br />
      I think ultimately this would be best handled in 2 separate macros, but I'm also thinking, if I can't get a version of the file, I'd like to fallback and check the date of the file.<br />
      <br />
      Now, its getting tricky again, and also because, if I'm replacing these system files, I want to back them up, so when I uninstall I can restore the system to its original state.<br />
      <br />
      I've built the backup stuff into the macro already - another define (BACKUP or NOT) - the files goto $INSTDIR\install_backup if they are replaced.<br />
      <br />
      So now I need a macro that will work for the uninstaller, which will firstly, check if the file that replaced the original during the install, is still the same file, and not something installed by another app since....if so, then dont restore.<br />
      <br />
      Then copy the files back over their replacements setting all the reg stuff and reboot flags.<br />
      <br />
      It's kinda like building a wrapper for installing and uninstalling files, safely, and ensuring you only install what you need...handy for online installs.<br />
      <br />
      BUT, when you think like that, it would be much more sensible to do to all the version/date checking first, write that info to an ini file, then check the versions of all the existing files (if any) from the INI, against another INI, containing all the info of the files your installing. This way, if the installer IS an online installer (or not), all the operations can be grouped: FileCheck, File Copy/download, UnReg(if needed), UnRegShared(if needed), backup, FileRename, Reg(if needed), RegShared(if needed), etc. and then in reverse for the uninstaller :-).<br />
      <br />
      Don't ya just love Saturday nights!! :-(<br />
      <br />
      I've attached what I have for now...if anyone has ideas for the above-mentioned, or the attached, please don't hold back!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">eccles</span><br />
      <span class="post-time small text-muted">30th June 2002 00:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Here's a function-ised version, as promised. It will certainly reduce the overhead per-dll, but there are a couple of question marks over it. (I haven't even attempted to compile it, for one!)<br />
      <br />
      Now there's just one File command, which is always performed and to a temporary name. Maybe this could be undesirable - extracting lots of DLLs which may turn out not to be needed, which are then deleted.<br />
      <br />
      The DLL version of the new file is now taken by using GetDLLVersion on the extracted temporary file. I don't know if not having a .DLL extension (or whatever) will upset GetDLLVersion. If so, I suppose the original GetDLLVersionLocal could be restored as part of the small macro stub.<br />
      <br />
      Anyway, see what you think. If you do start going towards the multi-stage route you describe, I'll certainly be interested in how you get on (although I don't have to deal with DLLs in my installers) (thankfully!).<br />
      <br />
      --<br />
      Dave.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">simham_uk</span><br />
      <span class="post-time small text-muted">30th June 2002 14:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Nice one Dave</strong><br />
      &nbsp; Thanks!<br />
      <br />
      I have tried to break it up into the groups as mentioned in the previous post, and so far it looks good (I think).<br />
      <br />
      I have NOT tested it yet, but have attached it here to see if you can spot anything stooopid before I go any further.<br />
      <br />
      It looks like this is building into a nice utility!!<br />
      <br />
      Please have a look and let me know what you think...suggestions are very welcome!<br />
      <br />
      Thanks again!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">eccles</span><br />
      <span class="post-time small text-muted">30th June 2002 15:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>You've been busy for a Sunday afternoon...</strong><br />
      &nbsp; Ok, initial thoughts (although I've not had time to study it yet).</p>

      <ul>
        <li>The !undefs are not required (which is why I removed them in the last post...)</li>

        <li>Your concatenation of the two parts of the version number into 1 are unsafe - for one, the result may end up being a number too big for NSIS to handle (the reason they're in two parts in the first place)</li>

        <li>Your use of the stack is a bit suspect. :D You should be Pushing variables <i>before</i> changing them, so that the Pops restore them to their original values. If keeping variables untouched is not really a problem for you then you could maybe take out all Push/Pop/Exch, at least for now. Nothing stopping that sort of thing being added when things have settled down.</li>

        <li>I'm not sure what part the GetTempFileName is playing now, since your changes. The Rename in dont_unreg could probably take the file directly from the extracted/downloaded copy in the $TEMP directory from CheckInstallMacro (or I'm just misunderstanding what the CopyFiles bit is all about...)</li>
      </ul><br />
      Anyway, I've already spent more time than I was planning to for now... :p<br />
      <br />
      Have fun!<br />
      <br />
      Dave.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">simham_uk</span><br />
      <span class="post-time small text-muted">30th June 2002 16:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks once again Dave!<br />
      <br />
      I have removed the !undef's as suggested, and hopefully tidied up the push/pops into the right order, as well as fix some typos and bits and pieces.<br />
      <br />
      Regarding the version numbers, I believe these are DWORD's and 32bit, so they have a maxlength (if I'm not mistaken?), which when concatenated and added into a INI file seems to be OK from past experience using this method.<br />
      <br />
      The GetTempFile could probably be done away with, but may be useful for extending...who knows. I think it should be OK as is.<br />
      <br />
      I've aslo made some further changes to allow definiton of the install_type, so that when calling the macro you can choose INSIDE, MEDIA, or DOWNLOAD to decide where you want to install from, and also a cleanup function.<br />
      <br />
      I've attached for anyone to see!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kingfishers</span><br />
      <span class="post-time small text-muted">11th August 2002 02:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">i'm a little new at this and i love this awesome tool. but i need a little help, please. you seem to have accomplished here just what i've been trying to figure out. i have downloaded the file you attached here. but i am not sure what to do with it.<br />
      <br />
      it looks like it needs busted into at least 2 files (.inc files). it also looks like some of the code then goes directly in my .nsi file.<br />
      <br />
      where do the .inc files need to be... in the NSIS directory or in the project directory for the .nsi file?<br />
      <br />
      which parts of the file go where?<br />
      <br />
      sorry if this is mundane. i just stumbled onto NSIS a few days ago and am trying to figure it all out on my own.<br />
      <br />
      thanks,<br />
      kingfishers</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">11th August 2002 11:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">.inc files, or .nsh files (the extension doesn't really matter) are supposed to be included into your script using !include. When you use !include the pre-processor will just copy the file into your file. This allows you to save space and to change just one file if you find a bug.<br />
      <br />
      To use the macro in your script (after you have included the .inc file) just use !insertmacro like exampled above.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br />
      <span class="post-time small text-muted">11th August 2002 12:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>What state is this in?</strong><br />
      &nbsp; Hi - what's the deal with this upgrade macro stuff, is it in a usable state? Basically if it's good and working I'd like to update the stuff on my archive site but it looks like a lot of ideas have been thrown around on this thread and I don't want to put a page up (or update existing material) if I'm not sure about (a) what this stuff is actually capable of now and (b) if it actually works.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kingfishers</span><br />
      <span class="post-time small text-muted">11th August 2002 13:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">i'm a little slow here. i'm not sure i get it yet.<br />
      <br />
      which directory do the .inc files go... i think they must go in the project directory with the .nsi file.<br />
      <br />
      any other advice on how to use this?<br />
      <br />
      like... there isn't a way to define this all once and call it generically by passing the parameter for the name of the dll to upgrade??<br />
      <br />
      <br />
      thanks,<br />
      kingfishers</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">11th August 2002 13:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">It doesn't matter where you put the file as long as you remember where you put it :D<br />
      It is best to put it in the project directory because then you don't need to give the full path to it, just the relative.<br />
      <br />
      When a file is included it will be processed by NSIS as well so every function/macro in it will be available in your script too. All you need to do is add !insertmacro if it is a macro or Call if it is a function. See the above examples.<br />
      <br />
      If you still don't understand try reading the documentation of NSIS first (makensis.htm). Focus on macros and !include in the documentation. If you still don't understand after the documentation you are more than welcome to ask again.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">simham_uk</span><br />
      <span class="post-time small text-muted">11th August 2002 16:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have some scripts that I can contribute Sunjammer...just got to take out my progrma specific stuff.<br />
      <br />
      They are a bit incomplete from what I can remember as I had to give the project a back seat for the moment, but'll dig them out, and post, or email to you.<br />
      <br />
      Simon</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Kypec</span><br />
      <span class="post-time small text-muted">25th September 2002 16:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Improved UpgradeDLL macro+functions</strong><br />
      &nbsp; Hi pals,<br />
      <br />
      After few days of work I put together this (see attachment).<br />
      It is in general a macro but with just minimal overhead<br />
      because the most of code is contained in a function.<br />
      Please have a look at it and test it as much as possible.<br />
      It should work with most of DLL and OCX files.<br />
      You will need an external plugin "x18sysinfoV0.1.dll" available<br />
      from Sunjammer's webpage. I'm using its GetFileVersion function<br />
      because it returns the most compact file version information<br />
      i.e. always (AFAIK) "MAJOR.MINOR.REVISION.BUILD" formatted number.<br />
      Any additional work like adding and removing shared DLL's must<br />
      be done separately after macro code finished.<br />
      Please note that my macro uses $R0 for temporary local file so<br />
      don't forget to save it's content if you need it ;)<br />
      <br />
      Feel free to respond or contribute to this :D</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Kypec</span><br />
      <span class="post-time small text-muted">26th September 2002 14:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Additional small improvements</strong><br />
      &nbsp; -added few lines there -&gt; now your $R0 is preserved inside the macro<br />
      -added two functions+comments from other sources (AddSharedDLL,<br />
      un.RemoveSharedDLL)<br />
      Hope you find it helpful!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Koen van de Sande</span><br />
      <span class="post-time small text-muted">29th September 2002 15:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">This is my personal version of the UpgradeDLL macro... I made it at the same time as Kypec. However, it does not need any additional plugins like his version.<br />
      Hope you like it.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">roele</span><br />
      <span class="post-time small text-muted">15th October 2002 12:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I'm a newbie in using NSIS and wrote a simple install script which installes a ActiveX Object... now i can't get the uninstall to work cause the .dll is in use while uninstalling !!!<br />
      <br />
      Any tips or suggestions ?!<br />
      <br />
      Here's my current script</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">roele</span><br />
      <span class="post-time small text-muted">15th October 2002 13:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Sorry... i found a way which seems to work ;)<br />
      <br />
      THX anyway.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>