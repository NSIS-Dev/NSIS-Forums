<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="trying to enable IIS with dism.exe within nsis install" />

  <title>trying to enable IIS with dism.exe within nsis install - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">trying to enable IIS with dism.exe within nsis install</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=329894">trying to enable IIS with dism.exe within nsis install</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">dtherrien</span><br />
      <span class="post-time small text-muted">21st April 2011 14:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>trying to enable IIS with dism.exe within nsis install</strong><br />
      Hi<br />
      I am using nsis to do an install on a Windows 7 system. I have lots of the install working, but I can't seem to get this last part working. I need to enable Windows Authentication in IIS.<br />
      <br />
      When I run this command outside of the installer, it works perfectly:<br />
      <font color="navy">C:\Windows\system32\dism.exe /online /norestart /logpath:"C:\bwm\log.etw.txt" /enable-feature /ignorecheck /featurename:"IIS-WebServerRole" /featurename:"IIS-WebServer" /featurename:"IIS-Security" /featurename:"IIS-BasicAuthentication" /featurename:"IIS-WindowsAuthentication" /featurename:"IIS-DigestAuthentication</font><br />
      <br />
      When I put this command into a file called iisconfig.cmd and use the following code within my .nsi file, it does not work.<br />
      <font color="navy">file iisconfig.cmd<br />
      ExecCmd::exec /TIMEOUT=40000 '"$INSTDIR\iisconfig.cmd"'<br />
      Pop $0<br />
      MessageBox MB_OK "Exit code $0"</font><br />
      <br />
      When I try to execute the command using ExecWait, it fails to se the proper IIS items:<br />
      <font color="navy">ExecWait 'cmd /c C:\Windows\system32\dism.exe /online /norestart /logpath:"C:\bwm\log.etw.txt" /enable-feature /ignorecheck /featurename:"IIS-WebServerRole" /featurename:"IIS-WebServer" /featurename:"IIS-Security" /featurename:"IIS-BasicAuthentication" /featurename:"IIS-WindowsAuthentication" /featurename:"IIS-DigestAuthentication"'</font><br />
      <br />
      I've read many comments about ExecWait not waiting, bit the solutions that were provided did not solve this problem.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">21st April 2011 15:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Have you disabled file system redirection?<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">dtherrien</span><br />
      <span class="post-time small text-muted">21st April 2011 16:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi Stu<br />
      <br />
      I looked into this since I'mnot sure what this means. This is my first time ever using install software on Windows.<br />
      <br />
      I changed all of my script references from C:\Windows to %windir% since that seemed to have something to do with filesystem redirection and my windows IT guy said that I should use %windir%<br />
      <br />
      That did not seem to help.<br />
      <br />
      Why would disabling filesystem redirection help ? How exactly do I do that ?<br />
      <br />
      Thanks Dave</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">21st April 2011 17:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Sorry, I meant the macro in x64.nsh: ${DisableX64FSRedirection}. Because NSIS is 32-bit, Windows will redirect it to C:\Windows\SysWOW64 which is probably not where your dism.exe is (assuming it <i>is</i> a 64-bit executable).<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">dtherrien</span><br />
      <span class="post-time small text-muted">21st April 2011 18:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi Stu - I think you nailed the problem - many thanks ! ! ! I tried running DISM manually in SysWOW64 and System32 and it only runs in System32. Now how exactly do I Disablex64FSredireciton ? I tried adding it to the top of my script as ${DisableX64FSRedirection} but it failed to compile.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">21st April 2011 19:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You put it in the section or function that you are calling your app from. It's a run-time call to the Wow64EnableWow64FsRedirection API. It only works for the current thread too so keep that in mind (e.g. sections run in a different thread to the callbacks such as .onInit for example).<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">dtherrien</span><br />
      <span class="post-time small text-muted">21st April 2011 21:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">thanks Stu, these are the three lines that I have in my .nsi file -<br />
      <br />
      <font color="navy">${DisableX64FSRedirection}<br />
      <br />
      ExecWait 'cmd /c %windir%\system32\dism.exe /online /norestart /logpath:"C:\bwm\log.etw.txt" /enable-feature /ignorecheck /featurename:"IIS-WebServerRole" /featurename:"IIS-WebServer" /featurename:"IIS-Security" /featurename:"IIS-BasicAuthentication" /featurename:"IIS-WindowsAuthentication" /featurename:"IIS-DigestAuthentication"'<br />
      <br />
      ${EnableX64FSRedirection}</font><br />
      <br />
      For some reason, it doesn't compile ?<br />
      Dave</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">22nd April 2011 06:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You might want to supply us with the compilation error, so we know what to look for.<br />
      <br />
      You need to use $WINDIR, instead of %windir%. Also you shouldn't just call 'cmd', as that could be anything. You need to execute %comspec%, so like this:<br />
      <br />
      ExpandEnvStrings $0 "%COMSPEC%"<br />
      ExecWait '$0 /foo /bar'</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">dtherrien</span><br />
      <span class="post-time small text-muted">22nd April 2011 16:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi<br />
      <br />
      Thanks for the suggestions! I am really new to installation software, so I welcome any and all changes you could recommend to this script. I'm basically installing components on a Windows 7 system to connect my php scripts to SQL Server and IIS.<br />
      <br />
      <br />
      The error I got during compilation was<br />
      <br />
      Invalid command: ${DisableX64FSRedirection}<br />
      Error in script<br />
      <br />
      <br />
      Here's my entire nsi file...<br />
      <br />
      <br />
      Function .onInit<br />
      SetOutPath $TEMP<br />
      File /oname=spltmp.bmp "ExaGridLogo.bmp"<br />
      advsplash::show 10 1000 2000 0xFFFFFE $TEMP\spltmp<br />
      Pop $0 ; $0 has '1' if the user closed the splash screen early,<br />
      ; '0' if everything closed normally, and '-1' if some error occurred.<br />
      Delete $TEMP\spltmp.bmp<br />
      FunctionEnd<br />
      <br />
      name "Backup Window Manager 1.0"<br />
      <br />
      # ------------------------------------------------------<br />
      #<br />
      # define installer name<br />
      outFile "BWM_installer.exe"<br />
      <br />
      # set default install directory<br />
      InstallDir c:\bwm<br />
      <br />
      # Request application privileges for Windows Vista<br />
      RequestExecutionLevel admin<br />
      <br />
      # --------------------------------------------------------<br />
      #<br />
      # Pages<br />
      <br />
      # Page directory<br />
      Page instfiles<br />
      <br />
      UninstPage uninstConfirm<br />
      UninstPage instfiles<br />
      <br />
      # --------------------------------------------------------<br />
      #<br />
      # default section start<br />
      section<br />
      <br />
      # define output path<br />
      setOutPath $INSTDIR<br />
      <br />
      # specify file to go in output path<br />
      <br />
      # --- php ---<br />
      file php-5.3.6-nts-Win32-VC9-x86.msi<br />
      ExecWait '"msiexec.exe" /i "$INSTDIR\php-5.3.6-nts-Win32-VC9-x86.msi" /qn'<br />
      <br />
      # --- Microsoft Visual C++ 2008 Redistributable Package (x86)<br />
      file vcredist_x86.exe<br />
      ExecWait '"$INSTDIR\Vcredist_x86.exe" /q:a /c:msiexec /i "vcredist.msi" /qn /l*v "%temp%\vcredist_x86.log"'<br />
      <br />
      # TODO: may need to support both x86 and x64 in real install!!!<br />
      # --- php Manager for IIS<br />
      file PHPManagerForIIS-1.1.2-x64.msi<br />
      ExecWait '"msiexec.exe" /i "$INSTDIR\PHPManagerForIIS-1.1.2-x64.msi" /qn'<br />
      <br />
      # TODO: may need to support both x86 and x64 in real install!!!<br />
      # --- SQL Server Native Client<br />
      file sqlncli.msi<br />
      ExecWait '"msiexec.exe" /i "$INSTDIR\sqlncli.msi" IACCEPTSQLNCLILICENSETERMS=YES /qn'<br />
      <br />
      # --- sqlsrv_* access to BackupExec SQL Server database from php<br />
      file SQLServerDriverForPHP11.EXE<br />
      ExecWait '"$INSTDIR\SQLServerDriverForPHP11.EXE" /C /T:$INSTDIR /Q'<br />
      <br />
      CopyFiles $INSTDIR\php_sqlsrv_53_nts_vc9.dll "C:\Program Files (x86)\PHP\ext"<br />
      <br />
      # --- overwrite the EDITED php.ini file<br />
      file php.ini<br />
      CopyFiles $INSTDIR\php.ini "C:\Program Files (x86)\PHP"<br />
      <br />
      # --- copy the php_cgi.exe file<br />
      file php-cgi.exe<br />
      CopyFiles $INSTDIR\php-cgi.exe "C:\Program Files (x86)\PHP"<br />
      <br />
      # --- install our own source files<br />
      file /r BWMsource\*.*<br />
      <br />
      # configure IIS - create BWM web site<br />
      ExecWait '%windir%\system32\inetsrv\appcmd.exe add site /name:BackupWindowManager /bindings:http/*:80: /physicalPath:c:\bwm'<br />
      <br />
      # --------------------------------------------------------<br />
      # --- TODO - we need to used DISM to turn on<br />
      # Windows Authentication so that we can then<br />
      # enable it later in the script.<br />
      # THE ExecWait DOESN'T WAIT LIKE IT SHOULD<br />
      #<br />
      <font color="red"><br />
      ${DisableX64FSRedirection}<br />
      <br />
      ExecWait 'cmd /c %windir%\system32\dism.exe /online /norestart /logpath:"C:\bwm\log.etw.txt" /enable-feature /ignorecheck /featurename:"IIS-WebServerRole" /featurename:"IIS-WebServer" /featurename:"IIS-Security" /featurename:"IIS-BasicAuthentication" /featurename:"IIS-WindowsAuthentication" /featurename:"IIS-DigestAuthentication"'<br />
      <br />
      ${EnableX64FSRedirection}</font><br />
      #<br />
      # --------------------------------------------------------<br />
      <br />
      <br />
      # configure IIS - enable windowsauthentication<br />
      # disable anonymous and digest authentication<br />
      <br />
      ExecWait '%windir%\system32\inetsrv\appcmd.exe set config BackupWindowManager -section:system.webServer/security/authentication/anonymousAuthentication /enabled:False /commit:apphost'<br />
      <br />
      ExecWait '%windir%\system32\inetsrv\appcmd.exe set config BackupWindowManager -section:system.webServer/security/authentication/windowsAuthentication /enabled:True /commit:apphost'<br />
      <br />
      ExecWait '%windir%\system32\inetsrv\appcmd.exe set config BackupWindowManager -section:system.webServer/security/authentication/digestAuthentication /enabled:False /commit:apphost'<br />
      <br />
      # create IIS - FastCGI process pool<br />
      ExecWait '%windir%\system32\inetsrv\appcmd set config /section:system.webServer/fastCGI /+"[fullPath=c:\Program Files (x86)\PHP\php-cgi.exe]"'<br />
      ExecWait '%windir%\system32\inetsrv\appcmd.exe set config -section:system.webServer/handlers /+"[name=PHP-FastCGI,path=*.php,verb=GET,HEAD,POST,modules=FastCgiModule,scriptProcessor=C:\Program Files (x86)\PHP\php-cgi.exe,resourceType=Either,requireAccess=Script]"'<br />
      <br />
      # -----------------------------------------------------------<br />
      #<br />
      # define uninstaller name<br />
      writeUninstaller $INSTDIR\BWM_uninstaller.exe<br />
      <br />
      # default section end<br />
      sectionEnd<br />
      <br />
      <br />
      # create a section to define what the uninstaller does.<br />
      # the section will always be named "Uninstall"<br />
      section "Uninstall"<br />
      <br />
      # Always delete uninstaller first<br />
      delete $INSTDIR\BWM_uninstaller.exe<br />
      <br />
      ExecWait '"msiexec.exe" /uninstall "$INSTDIR\php-5.3.6-nts-Win32-VC9-x86.msi" /qn'<br />
      <br />
      ExecWait '"msiexec" /uninstall "$INSTDIR\sqlncli.msi" /qn'<br />
      <br />
      ExecWait '"msiexec" /uninstall "$INSTDIR\PHPManagerForIIS-1.1.2-x64.msi" /qn'<br />
      <br />
      ExecWait '"msiexec" /uninstall "vc_red.msi" /qn'<br />
      <br />
      # now delete installed file<br />
      delete $INSTDIR\php-5.3.6-nts-Win32-VC9-x86.msi<br />
      delete $INSTDIR\vcredist_x86.exe<br />
      delete $INSTDIR\SQLServerDriverForPHP11.EXE<br />
      delete $INSTDIR\PHPManagerForIIS-1.1.2-x86.msi<br />
      delete $INSTDIR\PHPManagerForIIS-1.1.2-x64.msi<br />
      delete $INSTDIR\sqlncli.msi<br />
      delete $INSTDIR\php_sqlsrv_*.*<br />
      delete $INSTDIR\php.ini<br />
      delete $INSTDIR\SQLServerDriver*.*<br />
      rmdir $INSTDIR<br />
      sectionEnd</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">22nd April 2011 22:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">(Please use <a href="http://nsis.pastebin.com" target="_blank">http://nsis.pastebin.com</a> to paste large amounts of code, or add your script file as an attachment.)<br />
      <br />
      To use the x64 defines, you need to first !include the appropriate nsh file:<br />
      !include x64.nsh</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">dtherrien</span><br />
      <span class="post-time small text-muted">25th April 2011 14:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hey MSG - thanks for the advice. That solved my problem. Sorry about the long post. I'm new to all of this and did not know better.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
