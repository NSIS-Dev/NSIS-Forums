<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Better ActiveX registration"><title>Better ActiveX registration - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Better ActiveX registration</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=58263">Better ActiveX registration</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">AsPhunck</span><br><span class="post-time small text-muted">26th August 2001 13:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Better ActiveX registration</strong><br>There's a problem with the way we can check the version number when doing ActiveX registration. It requires the filename on the install system...<br><br>Typically you want to install an ActiveX component if the file is newer than the one already on the system... The problem is that you don't know the filename/location of the component on the system. :( The only thing you know is the "class id" of the component that you want to install. And you dont want to write the class-id's in the NSIS script, instead you want the NSIS to retrieve it from the file in...<br><br>What I am looking for could be expressed in pseudo-code it as:<br><br><br></p><pre>
<code><br>NDLL=the DLL in the NSIS package<br>IF NDLL.classid already exists on system {<br>   SDLL=the install systems DLL coresponding to NDLL.classid<br>   IF SDLL.version&lt;NDLL.version {<br>      UNREG SDLL<br>      REG NDLL<br>   } <br>}<br></code>
</pre><br>
      <br>
      I have no idea how to implement this in the NSIS source. But I doubt i am the only one that would like this feature. If there only was a function that could retrieve the filename of SDLL.
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">AsPhunck</span><br>
      <span class="post-time small text-muted">29th August 2001 10:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Am I the only one interrested in this?<br>
      <br>
      I really can't imagine it.. If your product is one with lots of ActiveX components then this feature is almost essential.<br>
      <br>
      This would be the case for almost all VB/Delphi coded products...<br>
      <br>
      Anybody got a solution?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">AsPhunck</span><br>
      <span class="post-time small text-muted">29th August 2001 10:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If nobody here has a solution then I think I will switch to the "inno" installer. It's also free, albeit not as cool...<br>
      <br>
      I might even consider writing my own using the "Seer" Scripting language.<br>
      <br>
      I don't want to switch so please send any solutions to my problem....<br>
      <br>
      ;)</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">pjw62</span><br>
      <span class="post-time small text-muted">29th August 2001 16:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">oh no... an unbeliever.. arrhgg... I will see what I can do.. if you could find an expample of how to do this progmatically, I would appreciate. I cant give it a lot of attention at the moment 'cause I'm busy ;)</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">pjw62</span><br>
      <span class="post-time small text-muted">29th August 2001 16:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">would one just read the reg key HKEY_CLASSES_ROOT\CLSID\&lt;clsid goes here&gt;\InprocServer32\<br>
      <br>
      ??<br>
      e.g.<br>
      <br>
      the default key value for<br>
      HKEY_CLASSES_ROOT\CLSID\{00000107-0000-0010-8000-00AA006D2EA4}\InprocServer32 is "C:\PROGRAM FILES\COMMON FILES\MICROSOFT SHARED\DAO\DAO360.DLL"</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">pjw62</span><br>
      <span class="post-time small text-muted">29th August 2001 16:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">as well as that, there are various other keys that can be read to get filename of related modules (16/32 bit)..<br>
      <br>
      (copied and pasted)<br>
      InprocHandler Registers a 16-bit handler DLL<br>
      @ String value<br>
      Specifies the custom handler used by the application.<br>
      InprocHandler32 Registers a 32-bit handler DLL<br>
      @ String value<br>
      Specifies the custom handler used by the application.<br>
      InprocServer Registers a 16-bit in-process server DLL<br>
      @ String value<br>
      Specifies the path to the in-process server DLL.<br>
      InprocServer32 Registers a 32-bit in-process server DLL<br>
      @ String value<br>
      Specifies the path to the 32-bit in-process server.<br>
      ThreadingModel String value<br>
      Specifies the threading model of the apartment the server can run in.<br>
      In-process servers are loaded into an existing apartment and so do not call CoInitialize or CoInitializeEx; they must use the registry to specify an application's threading model.<br>
      Allowable values are:<br>
      ThreadingModel=Apartment. Single-threaded apartment.<br>
      ThreadingModel=Both. Single-threaded or multithreaded apartment.<br>
      ThreadingModel=Free. Multithreaded apartment.<br>
      ThreadingModel=Neutral. Neutral apartment (available in Windows 2000).<br>
      <br>
      Insertable Indicates whether the object is insertable in COM applications.<br>
      Objects of this class should appear in the Insert Object dialog box's list box when used by COM container applications.<br>
      @ String value<br>
      Specifies the path to the 32-bit in-process server.<br>
      LocalServer Full path to a 16-bit local server application<br>
      @ String value<br>
      Specifies the full path to the local server, and can include command-line arguments.<br>
      LocalServer32 Full path to a 32-bit local server application<br>
      @ String value<br>
      Specifies the full path to the local server, and can include command-line arguments.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">pjw62</span><br>
      <span class="post-time small text-muted">29th August 2001 20:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">"And you dont want to write the class-id's in the NSIS script, instead you want the NSIS to retrieve it from the file in... "<br>
      <br>
      actually, on reading this, it seems that you also want a way to automatically get the CLSID from a program id, so you dont have to manually find the CLSID.<br>
      <br>
      I haven't worked with COM/ActiveX objects before, but I think you need CLSIDFromProgID and StringFromCLSID.<br>
      <br>
      I will implement this in the next release of my nsis dll.<br>
      <br>
      I think it would be possible though, to load the CLSID directly from the CLSID registry key in HKEY_CLASSES_ROOT\&lt;progid&gt;. This would save a bit in your exe header.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">AsPhunck</span><br>
      <span class="post-time small text-muted">31st August 2001 20:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks a lot... this really helped me out :)</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">AsPhunck</span><br>
      <span class="post-time small text-muted">31st August 2001 21:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">So How do you read the default value with ReadRegStr?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">AsPhunck</span><br>
      <span class="post-time small text-muted">1st September 2001 00:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">OK.....<br>
      <br>
      <br>
      Here's a little VBscript tool i made for genereating NSIS code for ActiveX registration.... :p<br>
      <br>
      I have only tested it briefly so you might want to check it out yourself... I use the generated script in conjunction with the NSIS !include command. It seems to work great.<br>
      <br>
      This is the ".vbs" CODE... If you want to know how it works i suggest you start reading about the TypeLibInfo object....<br>
      <br>
      <br></p>
      <pre>
<code><br><br>Option Explicit<br><br>Dim LabelOffset <br><br>Dim oFileOut<br>Dim oFSO<br>Dim oTLI<br><br>LabelOffset=1<br><br>Set oFSO=CreateObject("scripting.filesystemobject")<br>Set oFileOut = oFso.CreateTextFile("DLLs-include.NSI", True)<br>Set oTLI=CreateObject("TLI.TLIApplication")<br><br>dumpTypeLibInfo "c:\winnt\system32\msvbvm60.dll","$SysDir","c:\winnt\system32\vb6stkit.dll",true<br>dumpTypeLibInfo "c:\winnt\system32\comdlg32.ocx","$SysDir","",true<br>dumpTypeLibInfo "c:\winnt\system32\mci32.ocx","$SysDir","",true<br>dumpTypeLibInfo "c:\winnt\system32\mscomctl.ocx","$SysDir","",true<br>dumpTypeLibInfo "c:\winnt\system32\mswinsck.ocx","$SysDir","",true<br>dumpTypeLibInfo "c:\winnt\system32\tabctl32.ocx","$SysDir","",true<br><br><br>oFileOut.close<br><br><br><br>Sub dumpTypeLibInfo(localfilename,outpath,additionalfiles,isTypeLib)<br>        Dim guid<br>        Dim TII<br>        Dim fname<br>        Dim l<br>        Dim sFiles<br>        <br>        Set TII = oTLI.TypeLibInfoFromFile(localfilename)<br>        <br>        fname = outpath &amp; "\" &amp; mid(localfilename,instrrev(localfilename,"\")+1)<br>        <br>        <br>        guid = TII.GUID<br>        <br>        <br>        oFileOut.WriteLine("SetOutPath """ &amp; outpath &amp; """")<br><br>        If isTypeLib Then<br>                oFileOut.WriteLine("ReadRegStr $9 HKCR ""TYPELIB\" &amp; guid &amp; "\" &amp; TII.majorversion &amp; "." &amp; TII.minorversion &amp; "\"  &amp; TII.lcid &amp; "\win32"" """"")<br>        Else<br>                oFileOut.WriteLine("ReadRegStr $9 HKCR ""CLSID\" &amp; guid &amp; "\InprocServer32"" """"")<br>        End If<br><br>        oFileOut.WriteLine("ClearErrors")<br>        oFileOut.WriteLine("StrCmp $9 """" RegisterDLL" &amp; LabelOffset)<br>        oFileOut.WriteLine("CompareDLLVersions /STOREFROM """ &amp; localfilename &amp; """ """ &amp; fname &amp; """ UnRegisterDLL" &amp; LabelOffset &amp; " RegComplete" &amp; LabelOffset)<br>        oFileOut.WriteLine("Goto RegComplete" &amp; LabelOffset )<br><br>        oFileOut.WriteLine("UnRegisterDLL" &amp; LabelOffset &amp; ":")<br>        oFileOut.WriteLine("UnRegDLL """ &amp; fname &amp; """")<br>        oFileOut.WriteLine("Sleep 1000")<br>        oFileOut.WriteLine("RegisterDLL" &amp; LabelOffset &amp; ":")<br>        oFileOut.WriteLine("File """ &amp; localfilename &amp; """")<br>        sFiles=split(additionalfiles,";")<br>        For l=0 to UBound(sFiles)<br>                oFileOut.WriteLine("File """ &amp; sFiles(l) &amp; """")<br>        Next<br>        oFileOut.WriteLine("RegDLL """ &amp; fname &amp; """")<br><br><br>        oFileOut.WriteLine("RegComplete" &amp; LabelOffset &amp; ":")<br>        oFileOut.WriteLine("")<br><br>        LabelOffset=LabelOffset+1<br>End sub<br><br><br></code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">br0kenedge</span><br>
      <span class="post-time small text-muted">3rd March 2003 20:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I've been looking at safe ActiveX registration and came up with this script that seems to work well. Is there an easier way? If anyone has any suggestions or improvments feel free to post.<br>
      <br>
      ------------------<br>
      <br>
      <font size="1">[edit]edited by kichik. please attach huge scripts. attached below :down:[/edit]</font></p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">3rd March 2003 20:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">4th March 2003 17:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Seems fine. You can put it in a function since it doesn't use the File command. You can also use the System plug-in to automatically get the GUID. Can you please add it to the archive so everyone else can easily find it?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">br0kenedge</span><br>
      <span class="post-time small text-muted">4th March 2003 23:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">&gt;automatically get the GUID.<br>
      <br>
      I originally thought I would do that. I figured I could write a DLL plugin to use "TLI.TLIApplication" to extract typeLibInfo. In order to do this though, I'd have to distribute (and register) TLBINF32.DLL which comes with Visual Studio.<br>
      <br>
      &gt; System plug-in<br>
      <br>
      Does the System::call work on In-proc ActiveX components? (The documentation is hairy, it seemed like it was meant for standard DLLs)<br>
      <br>
      Is there another way?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">5th March 2003 15:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I am sorry, I have no idea. I have never worked with ActiveX. Just thought you can call CLSIDFromProgID that pjw mentioned using System.dll but it doesn't seem like it accepts file names.<br>
      <br>
      System.dll is meant for normal DLLs, but if the function is exported you can call it with System.dll. If they are not exported you'll have to use the same code you'll use with your C plug-in, but then again, it will be simpler to just create a plug-in.</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>