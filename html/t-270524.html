<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Read variable from Batch File after ExecWait" />

  <title>Read variable from Batch File after ExecWait - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Read variable from Batch File after ExecWait</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=270524">Read variable from Batch File after ExecWait</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ogreinside</span><br />
      <span class="post-time small text-muted">2nd May 2007 22:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Read variable from Batch File after ExecWait</strong><br />
      Hello,<br />
      <br />
      I am having difficulty in determining a software version that is a dependency for a package I am building an installer for. Everything else works right now. Once I can grab the existing version, I plan on using <a href="http://nsis.sourceforge.net/VersionCompare" target="_blank">VersionCompare</a> once I can determine the existing version.<br />
      <br />
      The main problem is that the company does not provide a Value for the version in the registry, only a Key. Even then, the key has no Values, and is only called the Major.Minor version, not including the Subverion that I need to test for.<br />
      <br />
      The software is EMC's Navisphere CLI. Here is a batch file I am using to grab the version:<br />
      <br />
      Called from NSIS as:<br />
      <br />
      ExecWait 'getNaviVer.cmd "$navipath"'<br />
      <br />
      getNaviVer.cmd<br />
      --<br />
      <font face="courier new"><br />
      cd %1<br />
      for /f "tokens=4" %%i in ('navicli.exe -help ^| findstr "Revision"') do set NaviCLIVersion=%%i<br />
      echo Navi Version is [%NaviCLIVersion%]<br /></font><br />
      --<br />
      <br />
      This works, and is the only way I have found to obtain the full version. However, I have not been able to read the variable set by the batch file for use by NSIS. This makes sense since this is a child process setting a variable, which would not stick to the parent.<br />
      <br />
      I tried: "ReadEnvStr $naviver NaviCLIVersion" with no luck<br />
      <br />
      Before I went down the path of looking at xset or some other hack, I wanted to check myself and see if there is an easier way to do this, since I'd prefer not to modify their environment anyway.<br />
      <br />
      Thanks for any assistance.<br />
      <br />
      Vinny</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">2nd May 2007 22:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Isn't possible to write %NaviCLIVersion% e.g. in registry and have nsis read it from there?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ogreinside</span><br />
      <span class="post-time small text-muted">2nd May 2007 22:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What a great, and simple work around :)<br />
      <br />
      I would prefer not to write anything to their system, but this would definitely work. In fact, I may write it to the existing Key as a Value, since they don't do it for you ...<br />
      <br />
      Thanks!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">3rd May 2007 18:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You can execute navicli.exe with nsExec::ExecToLog and parse the output with <a href="http://nsis.sourceforge.net/Docs/AppendixE.html#E.3.2" target="_blank">WordFind</a> and friends.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ogreinside</span><br />
      <span class="post-time small text-muted">7th May 2007 17:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for this suggestion, I figured out to use nsExec the hard way, but I like what you suggest about parsing a log. I may switch to doing that, but for now I am keeping it under a key in my own software entry. For anyone interested, here is what I ended up doing:<br />
      <br />
      --setNaviVer.cmd--<br />
      if [%1]==[] (<br />
      cd "c:\program files\emc\navisphere cli"<br />
      ) else (<br />
      cd %1<br />
      )<br />
      for /f "tokens=4" %%i in ('navicli.exe -help ^| findstr "Revision"') do set NaviCLIVersion=%%i<br />
      if defined NaviCLIVersion reg add "HKLM\SOFTWARE\My Company\My Product" /v NaviCLI_Version /d %NaviCLIVersion% /f<br />
      --setNaviVer.cmd--<br />
      <br />
      --inside nsis script--<br />
      nsExec::Exec 'setNaviVer.cmd "$navipath"'<br />
      ReadRegStr $naviVer HKLM "SOFTWARE\My Company\My Product" "NaviCLI_Version"<br />
      --inside nsis script--</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Dan9999</span><br />
      <span class="post-time small text-muted">7th May 2007 18:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The reason that your previous way didn't work is because when execwait runs your batch file, any changes to environment variables are not propagated to the parent (the nsis installer) and this is true for all programming languages.<br />
      <br />
      My favorite way out of this is to write batch files that only output the value (nothing else) and use<br />
      <br />
      var /GLOBAL myvalueinhere<br />
      nsExec::ExecToStack 'cmd /c mybatch.cmd'<br />
      pop $myvalueinhere<br />
      <br />
      and in the batch file make sure that no errors can happen so for example if reg.exe has a problem<br />
      <br />
      re.exe query etc.etc.etc... 2&gt;nul<br />
      <br />
      just in case errors get into the output because I think ExecToStack retrieves both stdout and stderr.<br />
      <br />
      Your way works too :-)</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
