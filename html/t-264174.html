<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="admin limitations on Vista?"><title>admin limitations on Vista? - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">admin limitations on Vista?</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=264174">admin limitations on Vista?</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">Takhir</span><br><span class="post-time small text-muted">22nd January 2007 16:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>admin limitations on Vista?</strong><br>&nbsp; I have small <a href="http://ineum.narod*****mgr_en.htm" target="_blank">application</a> (sorry, download is fast inside Russia only, but package is 120 kB, thanks NSIS :) ). The problem is following: on Vista when application starts first time from installer' finish page with admins privilegies from installer as child process (installer running with RequestExecutionLevel or not - both cases Vista displays UAC and elevates level to admin, installers auto-recognition feature), it not gets drag-n-drop messages and some other communication messages as well. The same happen if I start it with 'run as administrator' option later. But if I simply launch it from desktop or start menu icon (execution level 'user', admin not required) all works correct. This behavior not depends on current (start) folder. Brief google search not gave me any good links..</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">22nd January 2007 20:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">It's called User Interface Privilege Isolation. More information about this is available in <a href="http://msdn2.microsoft.com/en-us/library/aa480150.aspx" target="_blank">MSDN</a>.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Takhir</span><br><span class="post-time small text-muted">23rd January 2007 06:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks, kichik! Nice feature... I added manifest with asInvoker, but this not helped. The only way I see now is to remove 'Run' checkbox from finish page and ask user to start program manually :( But user still can run application as admin.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">23rd January 2007 09:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">There's some code to handle this in another forum thread:<br><br><a href="http://forums.winamp.com/showthread.php?s=&amp;threadid=260722&amp;highlight=vista" target="_blank">http://forums.winamp.com/showthread....ighlight=vista</a><br><br>Andres also wrote a plug-in, I think.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Takhir</span><br><span class="post-time small text-muted">23rd January 2007 10:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks again, sometimes forum search is better then google :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">23rd January 2007 17:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You can try the <a href="http://nsis.sourceforge.net/SAFER_plug-in" target="_blank">SAFER</a> plugin.<br><br>Use MUI_FINISHPAGE_RUN_FUNCTION and call the safer plugin with SAFER_LEVELID_NORMALUSER level.<br><br></p><pre>
<code>SAFER</code>::Exec NORMAL "$instdir\\myapp.exe" 
</pre>If your installer supports pre XP versions you should call SAFER::SupportsSAFER and just use normal Exec if the SAFER api is not supported</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Takhir</span><br><span class="post-time small text-muted">23rd January 2007 19:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks, Anders! I not tested it yet, but looks interesting. And I have feature request for 0.2 version :) Now I should write 3 or more lines of code:</p><pre>
if(supportsSafer)
<br> SAFER::Exec NORMAL "$instdir\myapp.exe"
<br>&gt;else
<br> Exec "$instdir\myapp.exe" 
</pre>Is it possible to do it all in a single call (CreateProcess() if no entry points in dll) and keep my brains for other fun ;) ?
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br>
      <span class="post-time small text-muted">23rd January 2007 20:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">thats what macros are for, something like:<br></p>
      <pre>
!macro ExecSAFER _level _cmdline
<br>SAFER::SupportsSAFER
<br>StrCmp$0 0 +3
<br>SAFER::Exec ${_level} '${_cmdline}'
<br>&gt;Goto +2
<br>Exec '${_cmdline}'
<br>&gt;!macroend
<br><br><br>&gt;!insertmacro ExecSAFER NORMAL 'calc.exe' 
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Takhir</span><br>
      <span class="post-time small text-muted">24th January 2007 08:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Tested. With SAFER token program fails to open file for write in $INSTDIR. I'll think later if I can use appdata folder for this file, but if I stop program and start it again - all works correct (can write file).<br></p>
      <pre>
<code>!insertmacro ExecSAFER NORMAL "$INSTDIR\${APP_EXE}"</code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">onad</span><br>
      <span class="post-time small text-muted">24th January 2007 11:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">IDEA:<br>
      1) Copy a manifest document were level is asInvoker (asInvoker is the new term on Vista versoin &gt;=Beta2) to the application directory where the application resides you want to start.<br>
      2) Start the application<br>
      3) Delete the manifest document<br>
      <br>
      NOTE:<br>
      (XML data is called a "XML document", not "XML file")</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Takhir</span><br>
      <span class="post-time small text-muted">24th January 2007 11:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><b>2 onad:</b><br>
      I wrote about this in my second post :)<br>
      Not works :(<br>
      Looks like child thread inheritation priority is high then manifests (while I not tested embedded manifest, but file priority is higher).</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">24th January 2007 11:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">There's an article on MSDN that suggests bootstrapping the installer with another application that'd run as the user and will later also execute the installed application. I really hate this method, but it does work.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br>
      <span class="post-time small text-muted">24th January 2007 15:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by Takhir</i><br>
        <b>Tested. With SAFER token program fails to open file for write in $INSTDIR. I'll think later if I can use appdata folder for this file, but if I stop program and start it again - all works correct (can write file).<br></b>
        <pre>
<b><code>!insertmacro ExecSAFER NORMAL "$INSTDIR\${APP_EXE}"</code></b>
</pre>
      </blockquote>A normal user cannot write to ProgramFiles so im not sure why it works if you start the program manually
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Takhir</span><br>
      <span class="post-time small text-muted">24th January 2007 15:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I tested program with app data folder. Launched from installer it could not write to application data/company/prog_name as well. The only place where it could was GetTempPath(). I can use tmp folder for this file, but program saves other (user's configuration) file to app_data, so this is a problem. File is too big for registry (access to registry works correct)..</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">onad</span><br>
      <span class="post-time small text-muted">24th January 2007 16:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Anders, you can write there because of Vista Virtualisation, this is a kind of backwards compatibility layer on Vista to solve problems with "old" software.<br>
      <br>
      IDEA1)<br>
      Do a run dll of an INF file there you can add an RUN entry, since the INF format description as not fully made public by MS this can be difficulult<br>
      <br>
      IDEA2)<br>
      As menationed before a bootstrap application which starts the installer with admin privileges and if finished starts another app with regular priviliges<br>
      <br>
      IDEA3)<br>
      Downgrade the options of the running process, hmmm<br>
      <br>
      IDEA4)<br>
      Set app compatibility flag to W98, test if works?<br>
      <br>
      IDEA5 ??)<br>
      Tell it to us please, be creative in thoughts....</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">24th January 2007 16:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What about CreateLowProcess from <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/ietechcol/dnwebgen/protectedmode.asp" target="_blank">MSDN</a>. It looks promising, as long as you can find out the SID for the medium integrity access level. There's code a page below CreateLowProcess that retrieves the current integrity access level. It can probably be used from a normal process to get that SID.<br>
      <br>
      Looks like SAFER is a wrapper for this as the terms are pretty similar, but who knows... I have to get myself Vista access again :(</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br>
      <span class="post-time small text-muted">24th January 2007 16:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You can inspect the process token SAFER creates with process explorer, its probably not the exact same thing as running the program manually<br>
      <br>
      There is another way to start a program non elevated on vista, documented @ <a href="http://www.tweak-uac.com/programming/vista-tools/" target="_blank">http://www.tweak-uac.com/programming/vista-tools/</a> (RunAsStdUser) I dont have Vista so I can not test or implement it</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>