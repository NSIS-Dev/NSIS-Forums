<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Unpacking: before or during?" />

  <title>Unpacking: before or during? - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Unpacking: before or during?</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=269897">Unpacking: before or during?</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bnicer</span><br />
      <span class="post-time small text-muted">21st April 2007 06:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Unpacking: before or during?</strong><br />
      Hi, I hope this isn't what you call 'pestering the developers'.<br />
      I've noticed using the highest compression and placing all sections before the body of page functions and after the page macros in the script causes the installer to unpack data prior to running. When the sections are included after the functions the setup runs right away. Unpacking takes 2-3 seconds. Is there an advantage to unpacking before? Or does it depend on how much data there is? With 700MB (in theory), you might want to unpack first and not during the installation... But why does moving the sections have that effect? What do functions have to do with it?<br />
      <br />
      regards,<br />
      Tom</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">21st April 2007 09:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">My second reply in <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=987385&amp;group_id=22049&amp;atid=373085" target="_blank">bug #987385</a> explains why this is done the way it's done.<br />
      <br />
      What you need in your script is ReserveFile as all those page functions add files to the data block. If you put the sections with the files above the page functions, those files required for the pages will be at the end of the data block. That means it'll have to decompress everything before it can get to the pages' data.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bnicer</span><br />
      <span class="post-time small text-muted">21st April 2007 15:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I haven't completely been able to isolate the files needed on startup (I'm working on it) to prevent lengthy unpacking, but I stumbled on an oddity, part of initializing. Putting an .onGUIInit function above the .onInit function shows the "Please wait while Setup is loading..." banner indicating the progress of unpacking in percent until it completes. If the functions are the other way around (.onInit second), the unpacking is silent, no banner.<br />
      <br />
      To be noted as well, .onInit internally jumps to FunctionEnd.</p>
      <pre>
<span style="color: #007700">Function.</span><span style="color: #0000BB">onInit
<br /></span><span style="color: #007700">...
<br /></span><span style="color: #0000BB">StrCmp$Language10310</span><span style="color: #007700">+</span><span style="color: #0000BB">4
<br />SetOverwriteon
<br />SetOutPath</span><span style="color: #DD0000">"$PLUGINSDIR"
<br /></span><span style="color: #0000BB">File</span><span style="color: #DD0000">"/oname=$PLUGINSDIR\modern-wizard.bmp""tigwgs.bmp"
<br /></span><span style="color: #0000BB">FunctionEnd
<br /><br /></span><span style="color: #007700">Function.</span><span style="color: #0000BB">onGUIInit_func
<br /></span><span style="color: #007700">...
<br /></span><span style="color: #0000BB">FunctionEnd
<br /></span>

<!-- php buffer end -->
                
                
                
</pre>
      <hr />
      <pre>
        
displaying the banner.
        PHP Code:
        
                
</pre>
      <hr />
      <pre>
                <code style="white-space:nowrap">
                
                        <!-- php buffer start --></code><span style="color: #000000">
<span style="color: #007700">Function.</span><span style="color: #0000BB">onInit
<br /></span><span style="color: #007700">...
<br /></span><span style="color: #0000BB">StrCmp$Language10310done
<br />SetOverwriteon
<br />SetOutPath</span><span style="color: #DD0000">"$PLUGINSDIR"
<br /></span><span style="color: #0000BB">File</span><span style="color: #DD0000">"/oname=$PLUGINSDIR\modern-wizard.bmp""tigwgs.bmp"
<br /></span><span style="color: #0000BB">done</span><span style="color: #007700">:
<br /></span><span style="color: #0000BB">FunctionEnd
<br /><br /></span><span style="color: #007700">Function.</span><span style="color: #0000BB">onGUIInit_func
<br /></span><span style="color: #007700">...
<br /></span><span style="color: #0000BB">FunctionEnd
<br /></span>
</span>
<!-- php buffer end -->
                
                
                
</pre>
      <hr />
      <pre>
        
not displaying the banner.<br /><br />As said, banner or no banner, I would like to use ReserveFile (thank you for the suggestion:)) or place the sections below the page functions to avoid initial unpacking. This is a different matter.
                
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">21st April 2007 16:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That's because you skip the file extraction in the second code so it doesn't unpack it.<br />
      <br />
      Simply reserve all files that are used outside of sections at the top of the script. Don't forget to reserve MUI files as well. See section 6 of the MUI readme - "Reserve files".</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bnicer</span><br />
      <span class="post-time small text-muted">21st April 2007 17:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Alright, forget about the banner.<br />
      <br />
      My code does extract MUI files first thing: PHP Code:</p>
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #007700">!include</span><span style="color: #DD0000">"${NSISDIR}\Contrib\ModernUI\Sysmod.nsh"</span><span style="color: #007700">;</span><span style="color: #0000BB">modifiedSystem</span><span style="color: #007700">.</span><span style="color: #0000BB">nsh<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Thingsthatneedtobeextractedonstartup</span><span style="color: #007700">(</span><span style="color: #0000BB">keeptheselinesbeforeanyFilecommand</span><span style="color: #007700">!)<br />
      ;Use</span><span style="color: #0000BB">ReserveFile</span><span style="color: #007700">for</span><span style="color: #0000BB">InstallOptionsINIfilestoo</span><span style="color: #007700">!<br />
      !</span><span style="color: #0000BB">insertmacroMUI_RESERVEFILE_INSTALLOPTIONS</span><span style="color: #007700">;</span><span style="color: #0000BB">InstallOptionsplug</span><span style="color: #007700">-</span><span style="color: #0000BB">in<br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">insertmacroMUI_RESERVEFILE_LANGDLL</span><span style="color: #007700">;</span><span style="color: #0000BB">Languageselectiondialog<br />
      ReserveFile</span><span style="color: #DD0000">"ready.ini"<br /></span> <span style="color: #0000BB">ReserveFile</span><span style="color: #DD0000">"prep.ini"</span> The missing files aren't the usual suspects. I'm still looking, believe me. I'll get to the bottom of it, if I have to remove every other file from the installer. Thanks.<br />
      <br />
      <b>edit:</b><br />
      StartMenu.dll, UserInfo.dll, System.dll and tigwgs.bmp were also referenced. Problem solved.<br />
      <br />
      I'm trying to streamline the installer which prompted this, because I wanted resolve, if possible, a hiccup sometimes when changing the image on the finish page. The image change should really happen after all files have been installed but before the finish page. You can't change the image earlier; someone might hit the Back button to return to the welcome page. I don't know if moving the sections has helped. Would it be pointless to extract the finish page image too as a ReserveFile?<br />
      <br /></span>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bnicer</span><br />
      <span class="post-time small text-muted">21st April 2007 20:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Further to the banner not appearing when files are unpacked: I've since had no banner in other situations. My code didn't cause it or wasn't the only factor. To be honest, I didn't even know a banner was supposed to appear, but it was good when it did. Sorry for getting side-tracked.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">22nd April 2007 19:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If you want a different image for the finish page, don't extract on the same filename. Simply change the INI in the pre-callback function of the finish page so it'd load another image.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bnicer</span><br />
      <span class="post-time small text-muted">23rd April 2007 05:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What's going on? I tried renaming the image before my last post, exactly as you suggest, and there was a blank page. The image didn't show up. It was there in the $PLUGINSDIR, but not on the finish page. Honest injun.<br />
      <br />
      It works now. I owe you another thank you.:)<br />
      <br />
      FWIW, I made an unrelated (rest assured only 'temporary') mistake (in the third post). Replacing the welcome page bitmap in .onInit is useless, because modern-wizard.bmp gets defined later and cancels out the change.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
