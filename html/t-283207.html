<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="ExecDos::Exec /ASYNC and ExecDos::wait - called exe doesn't end upon sucess"><title>ExecDos::Exec /ASYNC and ExecDos::wait - called exe doesn't end upon sucess - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">ExecDos::Exec /ASYNC and ExecDos::wait - called exe doesn't end upon sucess</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=283207">ExecDos::Exec /ASYNC and ExecDos::wait - called exe doesn't end upon sucess</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">inmytime3021</span><br><span class="post-time small text-muted">14th December 2007 19:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>ExecDos::Exec /ASYNC and ExecDos::wait - called exe doesn't end upon sucess</strong><br>I'm building an NSIS installer to install a data warehouse solution based on SQL Server 2005. The installer also launches a stored proc as a data job when the installer completes. Here are the basic steps:<br><br>1. Check for MSI 3.1, install if not exists.<br>2. Check for .NET 2.0, install if not exists.<br>3. Check for SQL Server 2005, install if not exists.<br>4. Run SQL scripts to create the data warehouse.<br>5. If user chooses, obtain job run configuration from them and invoke the procedure as a "post-install" step (i.e. like Run on Complete).<br><br>All works fabulous until the last step. My idea was to invoke the job after the main install via calling sqlcmd.exe. Since this job can take upwards of 20 minutes to complete, I attempted to use ExecDos::Exec /NOUNLOAD /ASYNC and kick it off that way. Then I check on the status in .onGUIEnd, and wait if it's not done, effectively allowing the GUI to tear down, yet the installer exe stay in the processes. So I do a ExecDos::wait inside .onGUIEnd to allow it to finish.<br><br>THE PROBLEM: sqlcmd suceeds but does not seem to return to the installer - it hangs in processes, but idle. So when I manually terminate it, then ExecDos returns back to the installer, I get a return code of '1' from ExecDos::wait, and then it finishes.<br><br>THE CODE:<br><br>Function LaunchJob<br>ExecDos::Exec /NOUNLOAD /ASYNC 'sqlcmd -v DataSource="$JobConfigDataSource" \ User="$JobConfigUserName" \ Password="$JobConfigPassword" \ Catalog="$JobConfigCatalog" \ Schema="$JobConfigSchema" \ Provider="$JobConfigProvider" \<br>-Q "$JobProcScript" \<br>-d "$DatabaseName" \<br>-b \<br>-S "$ServerName"'<br><br>Pop $R7<br><br>; NOTE: I tried it here too and commented out in .onGUIEnd and had the same effect.<br>;MessageBox MB_ICONEXCLAMATION|MB_OK 'onGUIEnd called...'<br>;<br>;ExecDos::isdone /NOUNLOAD $R7<br>;Pop $R1<br>;<br>;${If} $R1 == 0<br>; ; check process exit code<br>; ExecDos::wait $R7<br>; Pop $R2<br>; MessageBox MB_ICONEXCLAMATION|MB_OK 'Returned $R2"'<br>;${ElseIf} $R1 == -1<br>; MessageBox MB_ICONEXCLAMATION|MB_OK 'Error "$R1"'<br>;${EndIf}<br><br>;other stuff ...<br><br>FunctionEnd<br><br>Function .onGUIEnd<br>MessageBox MB_ICONEXCLAMATION|MB_OK 'onGUIEnd called...'<br><br>ExecDos::isdone /NOUNLOAD $R7<br>Pop $R1<br><br>${If} $R1 == 0<br>; check process exit code<br>ExecDos::wait $R7<br>Pop $R2<br>MessageBox MB_ICONEXCLAMATION|MB_OK 'Returned $R2"'<br>${ElseIf} $R1 == -1<br>MessageBox MB_ICONEXCLAMATION|MB_OK 'Error "$R1"'<br>${EndIf}<br>FunctionEnd<br><br><br>FACTS:<br><br>* Running sqlcmd manually at the command prompt works and closes at it should, because I use the '-Q' switch - which according to sqlcmd documentation will do a execute and exit; this works.<br><br>* When I do the same call with nsExec::ExecToStack, it works successfully.<br><br>* Even if I run it with ExecDos::Exec /NOUNLOAD /ASYNC "inline" - immediately grabbing the handle and calling wait on it - it still hangs out there and wont return back (see code comments).<br><br><br>I've isolated it down to this, and still cannot find what the problem is. Note though, of course, that sqlcmd does send data to stdout, so I thus get a file back from DosExec with that data - but ONLY if I manually blow away the sqlcmd process after it's completed. Can I have a few sharp eyes assist?<br><br>Also, is there source code for this plug-in that I can peek at?<br><br>Thanks much in advance,<br><br>Timex</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">14th December 2007 19:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You can create a second installer that'd just execute sqlcmd.exe with ExecDos and execute that installer with Exec. This way you won't have to use /ASYNC.<br><br>The source code is part of the ZIP available on the Wiki page.<br><br><a href="http://nsis.sourceforge.net/ExecDos_plug-in" target="_blank">http://nsis.sourceforge.net/ExecDos_plug-in</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">inmytime3021</span><br><span class="post-time small text-muted">14th December 2007 20:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">But wouldn't this installer then be synchronous to the main installer?<br><br>I'd rather keep it within a single installer solution for several reasons:<br><br>* Less maintenance and more important dependencies.<br>* I don't want or need any GUI for this last step ... it just needs to quietly run, without hanging up anything, then gracefully exit.<br><br>So, what I'm really get at...shouldn't ExecDos return from it once it's completed?! That is, return back via ExecDos::wait, so that I can Pop the return. It doesn't do this. It's like it hangs indefinitely on the ExecDos::wait, never returning me a return code. Why?<br><br>Thanks for your suggestion though! I did think of maybe moving my code to the .onGUIEnd, and running the job there SYNCHRONOUSLY via plain old nsExec::ExecToStack. That way, my GUI tears down first, then runs it silently i nthe background, and closes when finished. But, I'd hate to have to refactor my script in this fashion - less readable and not as elegant - yuck! :(<br><br>I want ExecDos::Exec /ASYNC to WORK! It is the solution I am after.<br><br>- Timex</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">14th December 2007 20:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">No, it wouldn't be synchronous as you'd use Exec and not ExecWait.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">inmytime3021</span><br><span class="post-time small text-muted">14th December 2007 20:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hmmmm, good point. Tried it and that works. Sometimes it's the simple things, heh. Well, the reason I was so hung up on doing the ExecDos and/or /ASYNC method was because originally I was doing this step during the install step and thus logging the stdout. This way works, but with the sacrifice of rich logging. Also, the command window is open, of course. But, I'll handle all of that! I saw some thread discussing this and thought I remember reading a thing or two about how to handle the command window (e.g. SW_HIDE). Besides, my job does logging in the database.<br><br>Thanks kichik! Sometimes four eyes are better than 2 (or one, lol).<br><br>- Timex</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Takhir</span><br><span class="post-time small text-muted">15th December 2007 08:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">SQL commands execution has a long history on this forum and many people had problems with it :(. The same situation I see here because simple script using consApp.exe (included to ExecDos pack) works as expected message appears 5 sec after installer close:</p><pre>
<code>!define APP_NAME onguiend<br>!define DOS_APP consApp.exe<br><br>Name "${APP_NAME} Test"<br>OutFile "${APP_NAME}.exe"<br><br>AutoCloseWindow true<br><br>!include "MUI.nsh"<br>!insertmacro MUI_PAGE_INSTFILES<br>!insertmacro MUI_LANGUAGE "English"<br><br><br>Section "Dummy Section" SecDummy<br>    ExecDos::exec /NOUNLOAD /ASYNC /TIMEOUT=5000 "$EXEDIR\consApp.exe" \<br>      "test_login$\ntest_pwd$\n" "$EXEDIR\stdout.txt"<br>    Pop $0 ; thread handle for 'wait'<br>SectionEnd<br><br>Function .onGUIEnd<br>    ExecDos::wait $0<br>    Pop $0<br>    MessageBox MB_OK "Exit code $0"<br>FunctionEnd</code>
</pre><br>
      The only thing I can offer is to add 2 parameters to ExecDos command line, "" for stdin and "$EXEDIR\stdout.txt" for stdout (temp file would be better for release script because of possible RO location).
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script type="text/javascript" src="../js/highlight.pack.js" async>
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>