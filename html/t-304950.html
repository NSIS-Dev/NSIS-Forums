<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="nsExec hangs (reproducible)" />

  <title>nsExec hangs (reproducible) - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">nsExec hangs (reproducible)</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=304950">nsExec hangs (reproducible)</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">silo5</span><br />
      <span class="post-time small text-muted">3rd April 2009 17:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>nsExec hangs (reproducible)</strong><br />
      Script compiled with v2.44 running on WinXP SP3 hangs executing nsExec::ExecToStack (and ExeDos).<br />
      Necessary conditions include:<br />
      - custom page<br />
      - ExecToStack is executed in the custom page show function<br />
      - the executed program broadcasts a windows SetNonClientMetrics message.<br />
      <br />
      Below you can find two scripts that reproduce this problem.<br />
      The second script is written in AutoIt3, it just broadcasts the message.<br />
      The first script is NSIS, it execs once in .onInit, which demonstrates that there is no failure (because it's outside the custom page). Then it execs in the custom page show function where it hangs.<br />
      You should be seeing exactly four message boxes, but you will actually see only three, one before and one after exec in .onInit, and one before exec in the show function. Then you need to kill _prog.exe which hangs in the background.<br />
      <br />
      _bug.nsi</p>
      <pre>
<span style="color: #007700">!include</span><span style="color: #DD0000">"MUI2.nsh"
<br /><br /></span><span style="color: #0000BB">AutoCloseWindowfalse
<br />WindowIconon
<br />XPSTYLEon
<br /><br />Name</span><span style="color: #DD0000">"_bug"
<br /></span><span style="color: #0000BB">OutFile</span><span style="color: #DD0000">"_bug.exe"
<br /></span><span style="color: #0000BB">Caption</span><span style="color: #DD0000">"_bug"
<br /><br /></span><span style="color: #0000BB">VIProductVersion</span><span style="color: #DD0000">"1.0"
<br /></span><span style="color: #007700">Var</span><span style="color: #0000BB">program
<br /><br />PagecustomShowLeave</span><span style="color: #DD0000">""
<br /><br /></span><span style="color: #007700">!</span><span style="color: #0000BB">insertmacroMUI_LANGUAGE</span><span style="color: #DD0000">"English"
<br /><br /></span><span style="color: #007700">!</span><span style="color: #0000BB">macro_RunProgram
<br />MessageBoxmb_ok</span><span style="color: #DD0000">"infunction${__FUNCTION__}line${__LINE__}..."
<br /></span><span style="color: #0000BB">nsExec</span><span style="color: #007700">::</span><span style="color: #0000BB">ExecToStack$program
<br />Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">0
<br />MessageBoxmb_ok</span><span style="color: #DD0000">"infunction${__FUNCTION__}line${__LINE__}execstatuswas$0"
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">macroend
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">defineRunProgram</span><span style="color: #007700">`</span><span style="color: #0000BB">!insertmacro_RunProgram</span><span style="color: #007700">`
<br /><br />Function</span><span style="color: #0000BB">Show
<br /></span><span style="color: #007700">${</span><span style="color: #0000BB">RunProgram</span><span style="color: #007700">}
<br /></span><span style="color: #0000BB">FunctionEnd
<br /><br /></span><span style="color: #007700">Function</span><span style="color: #0000BB">Leave
<br />FunctionEnd
<br /><br /></span><span style="color: #007700">Function.</span><span style="color: #0000BB">onInit
<br />InitPluginsDir
<br />strcpy$program</span><span style="color: #DD0000">"$EXEDIR\\_prog.exe"
<br /></span><span style="color: #007700">${</span><span style="color: #0000BB">RunProgram</span><span style="color: #007700">}
<br /></span><span style="color: #0000BB">FunctionEnd
<br /><br />Section
<br />SectionEnd
<br /></span>

<!-- php buffer end -->
                
                
                
</pre>
      <hr />
      <pre>
        
_prog.au3
        PHP Code:
        
                
</pre>
      <hr />
      <pre>
                <code style="white-space:nowrap">
                
                        <!-- php buffer start --></code><span style="color: #000000">
<span style="color: #007700">GlobalConst</span><span style="color: #0000BB">$WM_SETTINGCHANGE</span><span style="color: #007700">=</span><span style="color: #0000BB">0x1A
<br /></span><span style="color: #007700">GlobalConst</span><span style="color: #0000BB">$HWND_BROADCAST</span><span style="color: #007700">=</span><span style="color: #0000BB">0xFFFF
<br /></span><span style="color: #007700">GlobalConst</span><span style="color: #0000BB">$SPI_SETNONCLIENTMETRICS</span><span style="color: #007700">=</span><span style="color: #0000BB">42
<br /><br />DllCall</span><span style="color: #007700">(</span><span style="color: #DD0000">"user32.dll"</span><span style="color: #007700">,</span><span style="color: #DD0000">"int"</span><span style="color: #007700">,</span><span style="color: #DD0000">"SendMessage"</span><span style="color: #007700">,</span><span style="color: #0000BB">_
<br /></span><span style="color: #DD0000">"hwnd"</span><span style="color: #007700">,</span><span style="color: #0000BB">$HWND_BROADCAST</span><span style="color: #007700">,</span><span style="color: #0000BB">_
<br /></span><span style="color: #DD0000">"uint"</span><span style="color: #007700">,</span><span style="color: #0000BB">$WM_SETTINGCHANGE</span><span style="color: #007700">,</span><span style="color: #0000BB">_
<br /></span><span style="color: #DD0000">"wparam"</span><span style="color: #007700">,</span><span style="color: #0000BB">$SPI_SETNONCLIENTMETRICS</span><span style="color: #007700">,</span><span style="color: #0000BB">_
<br /></span><span style="color: #DD0000">"str"</span><span style="color: #007700">,</span><span style="color: #DD0000">"WindowMetrics"</span><span style="color: #0000BB">_
<br /></span><span style="color: #007700">)
</span></span>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">3rd April 2009 17:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">*SendMessage is a built-in nsis command, why not just use that?<br />
      <br />
      *you might want to try '"$EXEDIR\_prog.exe"'<br />
      <br />
      *Can AutoIt even produce console programs?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">silo5</span><br />
      <span class="post-time small text-muted">3rd April 2009 19:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The point of my post was to provide some sure way to reproduce this problem, which might even be an NSIS bug. I say might -- only the NSIS developers could say more.<br />
      <br />
      After trimming down all the fat to make the example crispy, it looks obviously artificial, but I can assure you that it is a real problem.<br />
      <br />
      I read other postings where people were reporting obscure issues with nsExec, but no clear ways to reproduce them. Maybe reproduce this problem could lead to solving other people's problems?<br />
      <br />
      Using SendMessage in my installer isn't the point. I've just tried to categorize one type of application which fails with nsExec.<br />
      <br />
      I don't know how to answer your question about AutoIt3. I don't know AutoIt3. This is the first time I use it. Does it matter?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">3rd April 2009 22:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I can't reproduce this problem, I get all 4 message boxes (NSIS 2.44, random autoit3 version)<br />
      <br />
      You need to come up with a better example, a SendMessage broadcast can lock up if there is a window in your system that is not processing messages</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">silo5</span><br />
      <span class="post-time small text-muted">4th April 2009 07:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for testing it! Are you on XP, which version? This example locks on two different XP boxes here. I want to test it again in a VM, so I can pair down running processes.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Takhir</span><br />
      <span class="post-time small text-muted">4th April 2009 15:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Tested on Vista Home Premium SP1, both nsExec and ExecDos worked correct. IMHO ping is simple test CLI application</p>
      <pre>
<code>strcpy $program "ping -n 2 localhost"</code>
</pre>should give one second delay. Also might be good to test your sample with ExecWait/Exec first - may be something happens in CLI window. autoit3 might just hang (as Anders already wrote). Or might wait for user input. Earlier we had reports about nsExec hangs only.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">4th April 2009 15:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by silo5</i><br />
        <b>Thanks for testing it! Are you on XP, which version?</b>
      </blockquote>XP SP2
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">AaronLS</span><br />
      <span class="post-time small text-muted">5th April 2009 01:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">@silo, What options are you using when you compile your AutoIt script?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">silo5</span><br />
      <span class="post-time small text-muted">6th April 2009 19:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">AaronLLS, I let SciTE compile it, using whatever are the default compiler options in the standard Scite4AutoIt distribution. I'll be happy to be more precise if you tell me where to look. I really don't know AutoIt. Thanks.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
