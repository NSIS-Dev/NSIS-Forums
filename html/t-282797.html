<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="problems inserting finish page"><title>problems inserting finish page - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">problems inserting finish page</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=282797">problems inserting finish page</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">Shwetha</span><br><span class="post-time small text-muted">7th December 2007 11:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>problems inserting finish page</strong><br>im encountering problems with insertng finish page.Im using this !insertmacro MUI_PAGE_FINISH macro code looks as below<br><br><br>;--------------------------------<br>;Modern UI Configuration<br><br>; Show a warning when the user cancels the install<br>!define MUI_ABORTWARNING<br>; I'm using some custom pages<br>!define MUI_CUSTOMPAGECOMMANDS<br>; Show a finish page at the end of the installation<br>!define MUI_FINISHPAGE<br>; Don't present the option to reboot the computer on the finish page<br>!define MUI_FINISHPAGE_NOREBOOTSUPPORT<br>; The icon for the installer title bar and .exe file<br>!define MUI_ICON "eclipse.ico"<br>; I've written a function that I want to be called when the user cancels the installation<br>!define MUI_CUSTOMFUNCTION_ABORT myOnAbort<br>; Override the text on the Finish Page<br>!define MUI_FINISHPAGE_TITLE "Installation Complete"<br>!define MUI_FINISHPAGE_TEXT "Survey has been queued for installation on the selected Palm devices.\r\n\r\nClick 'Finish,' then HotSync each device to complete publishing."<br><br>;--------------------------------<br>; Modern UI Pages (listed in order they will appear<br><br>; file installation page (preps needed files)<br>!insertmacro MUI_PAGE_INSTFILES<br>; custom page for choosing the Palm user(s) to publish to<br>Page custom ShowUserList LeaveCustom<br>;Page custom ShowUserList<br>; this will be called before the finish page is displayed to perform cleanup<br>!define MUI_PAGE_CUSTOMFUNCTION_PRE myFinishPre<br>; finish page<br>!insertmacro MUI_PAGE_FINISH<br>;--------------------------------<br>;Languages<br><br>; English only for now<br>!insertmacro MUI_LANGUAGE "English"<br><br>;--------------------------------<br><br>when i run the installer only window with close and button pops up.How do i solve this problem</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Joel</span><br><span class="post-time small text-muted">7th December 2007 14:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Why do you have <b>!insertmacro MUI_PAGE_FINISH</b> twice?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Shwetha</span><br><span class="post-time small text-muted">10th December 2007 04:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">i have inserted only once which causes only the close window appear on the screen.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">10th December 2007 10:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">What is the close window?<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Shwetha</span><br><span class="post-time small text-muted">14th December 2007 12:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">i meant to say that window pops up with close button in place of next button.How can i get the final finish page instead of this window?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">14th December 2007 15:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">That is the finish page. Maybe you mean !define MUI_FINISHPAGE_NOAUTOCLOSE.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Shwetha</span><br><span class="post-time small text-muted">25th December 2007 04:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">after publishing page with finish button should appear on the screen indicating user to perform hotsync.But this is not happening in my application</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Shwetha</span><br><span class="post-time small text-muted">25th December 2007 11:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">my script is as follows<br><br><br>; declare variables<br>Var PalmUserList ; Used to dynamically populate dropdown on User Selection page<br>Var UserChoice ; Selected Palm Username<br>Var InstallStatus ; Defined when the installer is aborting<br>Var SurveyName ; Survey full path from command line parameter<br>Var StatPDB ; full path of EpiSurveyor_stat.pdb<br>Var PublishDir<br>Var count<br>Var isSelectAll<br>Var userLists<br>Var UserSelection<br>Var HWND<br>Var ChildSurveyName<br>Var Survey<br>Name "Survey Publisher" ;Display name for installer<br><br>; declare macros<br>!macro IndexOf Var Str Char<br>Push "${Char}"<br>Push "${Str}"<br>Call IndexOf<br>Pop "${Var}"<br>!macroend<br>!define IndexOf "!insertmacro IndexOf"<br><br>!macro StrRep ResultVar String SubString RepString<br>Push "${String}"<br>Push "${SubString}"<br>Push "${RepString}"<br>Call StrRep<br>Pop "${ResultVar}"<br>!macroend<br>!define StrRep "!insertmacro StrRep"<br><br>!include "MUI.nsh"<br>!include "LogicLib.nsh"<br>!include "WinMessages.nsh"<br><br>;--------------------------------<br>;Configuration<br>; Name of the resulting executable installer file<br>OutFile "publish.exe"<br><br>; I don't intend to install any files permenantly on the PC, so<br>; use the system temporary directory<br>InstallDir "$TEMP\EpiSurveyorSetup"<br>;--------------------------------<br>;Modern UI Configuration<br><br>; Show a license agreement page<br>!define MUI_LICENSEPAGE<br>; Show a warning when the user cancels the install<br>!define MUI_ABORTWARNING<br>; I'm using some custom pages<br>!define MUI_CUSTOMPAGECOMMANDS<br>; Show a finish page at the end of the installation<br>!define MUI_FINISHPAGE<br>; Don't present the option to reboot the computer on the finish page<br>!define MUI_FINISHPAGE_NOREBOOTSUPPORT<br>; The icon for the installer title bar and .exe file<br>;!define MUI_ICON "eclipse.ico"<br>; I've written a function that I want to be called when the user cancels the installation<br>!define MUI_CUSTOMFUNCTION_ABORT myOnAbort<br>; Override the text on the Finish Page<br>!define MUI_FINISHPAGE_TITLE "Installation Complete"<br>!define MUI_FINISHPAGE_TEXT "Survey has been queued for installation on the selected Palm devices.\r\n\r\nClick 'Finish,' then HotSync each device to complete publishing."<br><br>;--------------------------------<br>; Modern UI Pages (listed in order they will appearance<br>; file installation page (preps needed files)<br>!insertmacro MUI_PAGE_INSTFILES<br>; custom page for choosing the Palm user(s) to publish to<br>Page custom ShowUserList LeaveCustom<br>!define MUI_WELCOMEFINISHPAGE_CUSTOMFUNCTION_INIT DisableBackButton<br>; this will be called before the finish page is displayed to perform cleanup<br>!define MUI_PAGE_CUSTOMFUNCTION_PRE myFinishPre<br>!insertmacro MUI_PAGE_FINISH<br><br>;--------------------------------<br>;Languages<br>; English only for now<br>!insertmacro MUI_LANGUAGE "English"<br><br>;--------------------------------<br>;Language Strings<br>;Description text that I want to appear while files are being copied<br>LangString DESC_SecCopyUI ${LANG_ENGLISH} "Copying the Palm files to your computer so they can be installed to your device."<br>;Header text for all pages in the installer<br>LangString TEXT_IO_TITLE ${LANG_ENGLISH} "EpiSurveyor"<br>LangString TEXT_IO_SUBTITLE ${LANG_ENGLISH} "Publish a survey to your devices"<br><br>;--------------------------------<br>;Reserve Files<br><br>;Things that need to be extracted first (keep these lines before any File command!)<br>;Required for proper behavior when using BZIP2 compression<br>ReserveFile "showUserList.ini"<br>!insertmacro MUI_RESERVEFILE_INSTALLOPTIONS<br><br>;--------------------------------<br>;Installer Sections<br><br>Section "Prep for install" SecCopyUI<br>; get survey name from command line parameter<br>Push $R0<br>Call GetParameters<br>Pop $R0<br>${StrRep} $R0 $R0 "/" "\" ; replace slashes<br>StrCpy $SurveyName $R0<br>Loop:<br>; loop until we have the index of the last slash<br>${IndexOf} $R1 $R0 "\"<br>IntOp $0 $R1 + 1 ;advance index past the slash<br>StrCpy $R0 $R0 "" $0 ; $R0 now has first segment of path removed<br>StrCmp $R1 -1 LastToken Next<br>Next:<br>IntOp $R2 $R2 + $R1 ; sum of segments we've traversed found so far<br>IntOp $R2 $R2 + 1 ; add one for the slash<br>GoTo Loop<br>LastToken:<br>IntOp $3 $3 + 1<br>StrCpy $Survey $R0<br>; MessageBox MB_OK|MB_ICONINFORMATION "index = $R2"<br>StrLen $1 $SurveyName<br>; MessageBox MB_OK|MB_ICONINFORMATION "path length = $1"<br>IntOp $2 $R2 - $1 ; index minux length of string: negative to count back from end of string<br>;MessageBox MB_OK|MB_ICONINFORMATION "length of shortened path = $2"<br>StrCpy $R3 $SurveyName $2<br>; MessageBox MB_OK|MB_ICONINFORMATION "value of R3 IS $R3"<br>StrCpy $PublishDir $R3<br>;MessageBox MB_OK|MB_ICONINFORMATION "publish dir is $PublishDir"<br>StrCpy $StatPDB "$R3EpiSurveyor_stat.pdb"<br>SetOutPath "$INSTDIR"<br>; Copy the files that we will use<br>File "UserData.dll"<br>File "InstAide.dll"<br><br>SectionEnd<br><br>;--------------------------------<br>;Descriptions<br><br>!insertmacro MUI_FUNCTION_DESCRIPTION_BEGIN<br>!insertmacro MUI_DESCRIPTION_TEXT ${SecCopyUI} $(DESC_SecCopyUI)<br>!insertmacro MUI_FUNCTION_DESCRIPTION_END<br><br>;--------------------------------<br>;Installer Functions<br><br>Function .onInit<br><br>;Extract InstallOptions INI Files<br>!insertmacro MUI_INSTALLOPTIONS_EXTRACT_AS "showUserList.ini" "showUserList.ini"<br>!insertmacro MUI_INSTALLOPTIONS_EXTRACT "showUserList.ini"<br>!insertmacro MUI_INSTALLOPTIONS_EXTRACT "installfiles.ini"<br>FunctionEnd<br><br>; displays our custom "Select Palm User" page<br>Function ShowUserList<br><br>Call GetPalmUserList<br>; Use this list to populate the list on our custom page<br>!insertmacro MUI_INSTALLOPTIONS_WRITE "showUserList.ini" "Field 2" "ListItems" "$PalmUserList"<br>!insertmacro MUI_HEADER_TEXT "$(TEXT_IO_TITLE)" "$(TEXT_IO_SUBTITLE)"<br>!insertmacro MUI_INSTALLOPTIONS_INITDIALOG "showUserList.ini"<br>Pop $HWND<br>GetDlgItem $1 $HWNDPARENT 1<br>EnableWindow $1 0<br><br>!insertmacro MUI_INSTALLOPTIONS_SHOW<br>Pop $0<br>InstallOptions::initDialog /NOUNLOAD "$PLUGINSDIR\showUserList.ini"<br>Call LeaveCustom<br>; if we are aborting, do not check the value of UserChoice (if we do, then<br>; if the user cancels the install without selecting a user, it will insist<br>; that the user choose a user before exiting)<br>StrCmp $InstallStatus "aborting_ir_install" End 0<br>!insertmacro MUI_INSTALLOPTIONS_READ $UserChoice "showUserList.ini" "Field 2" "State"<br>StrCmp $isSelectAll "1" End<br>StrCmp $isSelectAll "0" End<br>; Verify that the user chose a valid user. If not, display the ShowUserList<br>; screen again.<br>; Why not simply set MinLen of the dropdown to 1? This will prevent the user<br>; from continuing without selecting a user, but it will not present any<br>; messagebox or other dialog. That is confusing to the user!<br>StrCmp $UserChoice "" 0 Continue<br>MessageBox MB_OK|MB_ICONINFORMATION "You must choose at least one user to proceed."<br>Call ShowUserList<br>GoTo End<br>Continue:<br>; MessageBox MB_OK|MB_ICONINFORMATION "About to call InstallFiles function."<br>Call InstallFiles<br>; MessageBox MB_OK|MB_ICONINFORMATION "Just returned from InstallFiles function."<br>End:<br>FunctionEnd<br><br>Function LeaveCustom<br>; At this point the user has either pressed Next or one of our custom buttons<br>; We find out which by reading from the INI file<br>ReadINIStr $0 "$PLUGINSDIR\showUserList.ini" "Settings" "State"<br>!insertmacro MUI_INSTALLOPTIONS_READ $UserSelection "showUserList.ini" "Field 2" "State"<br>StrCmp $0 0 Done ; Next button?<br>StrCmp $0 3 SelectAll ; select all users<br>StrCmp $0 4 UnselectAll ; unselect all users<br>;added by shwetha on dec 07,2007<br>StrCmp $0 2 Selection<br>Abort ; Return to the page<br><br>SelectAll:<br>StrCpy $isSelectAll "1"<br>GetDlgItem $1 $HWNDPARENT 1<br>EnableWindow $1 1<br>GetDlgItem $1 $HWND 1203<br>EnableWindow $1 1<br>;added on dec 04,2007<br>GetDlgItem $1 $HWND 1202<br>EnableWindow $1 0<br>GetDlgItem $1 $HWND 1201<br>SendMessage $1 ${LB_SELITEMRANGEEX} 0 $count<br>StrCpy $userLists $PalmUserList<br>Abort<br><br>UnselectAll:<br>GetDlgItem $0 $HWND 1201<br>SendMessage $1 ${LB_SETSEL} 0 -1<br>GetDlgItem $1 $HWNDPARENT 1<br>EnableWindow $1 0<br>StrCpy $isSelectAll "0"<br>GetDlgItem $1 $HWND 1203<br>EnableWindow $1 0<br>;added on dec 04,2007<br>GetDlgItem $1 $HWND 1202<br>EnableWindow $1 1<br>StrCpy $userLists ""<br>Abort<br><br>Selection:<br>!insertmacro MUI_INSTALLOPTIONS_READ $UserSelection "showUserList.ini" "Field 2" "State"<br>StrCmp $UserSelection "" Disable<br>Disable:<br>GetDlgItem $1 $HWNDPARENT 1<br>EnableWindow $1 0<br>StrCmp $UserSelection "" End Cont<br>Cont:<br>GetDlgItem $1 $HWNDPARENT 1<br>EnableWindow $1 1<br>call InstallFiles<br>End:<br>Abort<br><br>Done:<br>StrCmp $isSelectAll 1 installAll<br>StrCmp $isSelectAll 0 next<br>StrCmp $UserChoice "" msg ; check if no users have been selected<br>installAll:<br>call InstallAllFiles<br>StrCpy $userLists ""<br>StrCmp $userLists "" msg<br>Abort<br>next:<br>StrCmp $UserChoice "" msg<br>StrCmp $isSelectAll "" msg<br>StrCmp $UserSelection "" msg<br>msg:<br>FunctionEnd<br><br>Function InstallAllFiles<br>; MessageBox MB_OK|MB_ICONINFORMATION "Installing for all the users in progress...."<br>; ==================== INSTALL PRC/PDB FILES ==========================<br>; Set the PRC file to be installed to internal memory on next HotSync<br>StrCpy $1 $UserChoice<br>StrCpy $UserChoice $userLists ;<br>Loop:<br>${IndexOf} $R0 $UserChoice "|"<br>StrCpy $R3 $R0 ; if this was the last token $R3 will be -1 and we'll stop looping<br>StrCmp $R3 -1 LastToken Moveon<br>LastToken:<br>StrCpy $1 $UserChoice<br>Goto InstallSurveyPDB<br>Moveon:<br>StrCpy $1 $UserChoice $R0 ; $1 = first token<br>IntOp $R0 $R0 + 1<br>StrCpy $R2 $UserChoice "" $R0 ; R2 = new $UserChoice<br>StrCpy $UserChoice $R2<br><br>InstallSurveyPDB:<br>StrCpy $2 "$SurveyName.pdb"<br>;MessageBox MB_OK|MB_ICONINFORMATION "Installing $2 for user $1"<br>System::Call 'InstAide::PltInstallFile(t r1, t r2) i .r3'<br>;MessageBox MB_OK|MB_ICONINFORMATION "Attempting install of $2 for user $1 PltInstallFile returned value of $3"<br>StrCmp $3 "-504" +1 +3 ;ERR_PILOT_COPY_FAILED<br>; MessageBox MB_OK|MB_ICONINFORMATION "Copy Failed"<br>Goto InstallOtherPDBs<br>StrCmp $3 "-512" +1 InstallOtherPDBs ;ERR_PILOT_FILE_ALREADY_EXISTS<br>;MessageBox MB_OK|MB_ICONINFORMATION "Uninstalling $2 for user $1"<br>System::Call 'InstAide::PltRemoveInstallFile(t r1, t r2) i .r3'<br>;MessageBox MB_OK|MB_ICONINFORMATION "PltRemoveInstallFile returned value of $3"<br>System::Call 'InstAide::PltInstallFile(t r1, t r2) i .r3'<br>;MessageBox MB_OK|MB_ICONINFORMATION "PltInstallFile returned value of $3"<br><br>InstallOtherPDBs:<br>StrCpy $2 "$StatPDB"<br>;MessageBox MB_OK|MB_ICONINFORMATION "Installing $2 for user $1"<br>System::Call 'InstAide::PltInstallFile(t r1, t r2) i .r3'<br>; MessageBox MB_OK|MB_ICONINFORMATION "PltInstallFile returned value of $3"<br>; We don't care if there is one of these in the queue already, it'll do fine<br><br>StrCpy $2 "$SurveyName_data.pdb"<br>; MessageBox MB_OK|MB_ICONINFORMATION "Installing $2 for user $1"<br>System::Call 'InstAide::PltInstallFile(t r1, t r2) i .r3'<br>;MessageBox MB_OK|MB_ICONINFORMATION "PltInstallFile returned value of $3"<br>; We don't care if there is one of these in the queue already, it'll do fine<br>Strcmp $count 0 End increment<br><br>increment:<br>IntOp $count $count - 1<br>Strcmp $count 0 End Loop<br>StrCmp $R3 -1 End Loop<br>; StrCpy $userLists ""<br>End:<br>; ==================== SHOW CUSTOM PAGE ==========================<br>; !insertmacro MUI_HEADER_TEXT "$(TEXT_IO_TITLE)" "$(TEXT_IO_SUBTITLE)"<br>;!insertmacro MUI_INSTALLOPTIONS_DISPLAY "installfiles.ini"<br><br>FunctionEnd<br><br>Function InstallFiles<br><br>; ==================== INSTALL PRC/PDB FILES ==========================<br>; Set the PRC file to be installed to internal memory on next HotSync<br>StrCpy $1 $UserChoice<br><br>StrCpy $UserSelection "$UserSelection|"<br>Loop:<br>${IndexOf} $R0 $UserSelection "|"<br>StrCpy $R3 $R0 ; if this was the last token $R3 will be -1 and we'll stop looping<br>StrCmp $R3 -1 LastToken Moveon<br>LastToken:<br>StrCpy $1 $UserSelection<br>Goto InstallSurveyPDB<br>Moveon:<br>StrCpy $1 $UserSelection $R0<br>; MessageBox MB_OK|MB_ICONINFORMATION "first user is $1"<br>IntOp $R0 $R0 + 1<br>;StrCpy $R2 $UserChoice "" $R0 ; R2 = new $UserChoice<br>StrCpy $R2 $UserSelection "" $R0 ; R2 = new $UserChoice<br>;MessageBox MB_OK|MB_ICONINFORMATION "next user is $R2"<br>StrCpy $UserSelection $R2<br><br>InstallSurveyPDB:<br>; MessageBox MB_OK|MB_ICONINFORMATION " inside InstallSurveyPDB"<br>StrCpy $2 "$SurveyName.pdb"<br>;MessageBox MB_OK|MB_ICONINFORMATION "Installing $2 for user $1"<br>System::Call 'InstAide::PltInstallFile(t r1, t r2) i .r3'<br>;MessageBox MB_OK|MB_ICONINFORMATION "Attempting install of $2 for user $1 PltInstallFile returned value of $3"<br>StrCmp $3 "-504" +1 +3 ;ERR_PILOT_COPY_FAILED<br>;MessageBox MB_OK|MB_ICONINFORMATION "Copy Failed"<br>Goto InstallOtherPDBs<br>StrCmp $3 "-512" +1 InstallOtherPDBs ;ERR_PILOT_FILE_ALREADY_EXISTS<br>; MessageBox MB_OK|MB_ICONINFORMATION "Uninstalling $2 for user $1"<br>System::Call 'InstAide::PltRemoveInstallFile(t r1, t r2) i .r3'<br>;MessageBox MB_OK|MB_ICONINFORMATION "PltRemoveInstallFile returned value of $3"<br>System::Call 'InstAide::PltInstallFile(t r1, t r2) i .r3'<br>;MessageBox MB_OK|MB_ICONINFORMATION "PltInstallFile returned value of $3"<br><br>InstallOtherPDBs:<br>;MessageBox MB_OK|MB_ICONINFORMATION " inside InstallotherPDB"<br>StrCpy $2 "$StatPDB"<br>; MessageBox MB_OK|MB_ICONINFORMATION "Installing $2 for user $1"<br>System::Call 'InstAide::PltInstallFile(t r1, t r2) i .r3'<br>;MessageBox MB_OK|MB_ICONINFORMATION "PltInstallFile returned value of $3"<br>; We don't care if there is one of these in the queue already, it'll do fine<br><br>StrCpy $2 "$SurveyName_data.pdb"<br>;MessageBox MB_OK|MB_ICONINFORMATION "Installing $2 for user $1"<br>System::Call 'InstAide::PltInstallFile(t r1, t r2) i .r3'<br>; MessageBox MB_OK|MB_ICONINFORMATION "PltInstallFile returned value of $3"<br>; We don't care if there is one of these in the queue already, it'll do fine<br><br>StrCmp $R3 -1 AbortLoop Loop<br>AbortLoop:<br>; ==================== SHOW CUSTOM PAGE ==========================<br>;!insertmacro MUI_HEADER_TEXT "$(TEXT_IO_TITLE)" "$(TEXT_IO_SUBTITLE)"<br>;!insertmacro MUI_INSTALLOPTIONS_DISPLAY "installfiles.ini"<br>FunctionEnd<br><br><br>Function GetPalmUserList<br>; NSIS has to be using the directory containing the dll for it to find it<br>SetOutPath "$INSTDIR"<br>File "UserData.dll" ; copy dll there<br>System::Call 'UserData::UmGetUserCount(v) i .r1'<br>;MessageBox MB_OK|MB_ICONINFORMATION "There seem to be $1 Palm users"<br>;added byy shwetha for retreiving the palm users count<br>StrCpy $count $1<br>;added by shwetha ends here<br>IntCmp $1 0 0 0 foundInstaller ; if return value of PltGetUserCount is 0 or negative, then we can't continue<br>MessageBox MB_OK|MB_ICONINFORMATION "No Palm Installer was found on your system. The installation cannot complete. Please ensure that the latest version of the Palm Desktop Software is installed on your computer before installing."<br>Abort<br>foundInstaller:<br><br>; Compile the list of Palm Users<br>StrCpy $2 0 ; Initialize counter<br>StrCpy $PalmUserList "" ; Initialize list<br>Loop:<br>StrCpy $4 ${NSIS_MAX_STRLEN} ; $4 will tell the function the buffer length of $3<br>; $3 will be set to the username of the user indexed by $2<br>System::Call 'UserData::UmGetUserID(i r2, *i r6r6) i .r5'<br>System::Call 'UserData::UmGetUserName(i r6, t .r3, *i r4) i .r5'<br>;MessageBox MB_OK|MB_ICONINFORMATION "User indexed at $2 has ID $6 and name $3"<br>StrCpy $PalmUserList "$PalmUserList$3|"<br>IntOp $2 $2 + 1 ; Incriment the counter<br>IntCmp $2 $1 0 Loop 0<br><br>FunctionEnd<br><br>Function RemoveFiles<br>; We need to Unload the dll so that it can be deleted<br>System::Call 'InstAide::PltGetUserCount(v) i .r1 ?u'<br>System::Call 'UserData::UmGetUserCount(v) i .r1 ?u'<br>; I read somewhere that you should do this. Don't know what it does<br>SetPluginUnload manual<br>System::Free 0<br>; Remove all of the files<br>SetOutPath $TEMP<br>Delete "$INSTDIR\InstAide.dll"<br>Delete "$INSTDIR\UserData.dll"<br>SetOutPath $PublishDir<br>Delete "$SurveyName.pdb"<br>Delete "$SurveyName_data.pdb"<br>Delete "$StatPDB"<br>RMDir /r "$INSTDIR"<br>FunctionEnd<br><br>Function RemoveInstallFiles<br>; Un-schedule the files for installation to internal memory<br><br>StrCpy $1 $UserChoice ; pipe-delimited string containing usernames<br><br>Loop:<br>; Search string for pipe to get a token<br>${IndexOf} $R0 $UserChoice "|"<br>StrCpy $R3 $R0 ; if this was the last token $R3 will be -1 and we'll stop looping<br>StrCmp $R3 -1 LastToken Moveon<br>LastToken:<br>StrCpy $1 $UserChoice<br>Goto UnInstall<br>Moveon:<br>StrCpy $1 $UserChoice $R0 ; $1 = first token<br>IntOp $R0 $R0 + 1<br>StrCpy $R2 $UserChoice "" $R0 ; R2 = new $UserChoice<br>StrCpy $UserChoice $R2<br><br>UnInstall:<br>StrCpy $2 "$SurveyName.pdb"<br>;MessageBox MB_OK|MB_ICONINFORMATION "Uninstalling $2 for user $1"<br>System::Call 'InstAide::PltRemoveInstallFile(t r1, t r2) i .r3'<br>;MessageBox MB_OK|MB_ICONINFORMATION "PltInstallFile returned value of $3"<br><br>StrCpy $2 "$SurveyName_data.pdb"<br>;MessageBox MB_OK|MB_ICONINFORMATION "Installing $2 for user $1"<br>System::Call 'InstAide::PltRemoveInstallFile(t r1, t r2) i .r3'<br>;MessageBox MB_OK|MB_ICONINFORMATION "PltInstallFile returned value of $3"<br><br>StrCpy $2 "$StatPDB"<br>;MessageBox MB_OK|MB_ICONINFORMATION "Installing $2 for user $1"<br>System::Call 'InstAide::PltRemoveInstallFile(t r1, t r2) i .r3'<br>;MessageBox MB_OK|MB_ICONINFORMATION "PltInstallFile returned value of $3"<br><br>StrCmp $R3 -1 Continue Loop<br>Continue:<br>FunctionEnd<br><br>Function DisableBackButton<br>GetDlgItem $1 $HWNDPARENT 3<br>EnableWindow $1 0<br>FunctionEnd<br><br>Function myFinishPre<br>;MessageBox MB_OK|MB_ICONINFORMATION "myFinishPre about to remove files"<br>; Before we exit the installer, clean up all of the files that we copied<br>; to the PC<br>MessageBox MB_OK|MB_ICONINFORMATION "installation completed for $Survey"<br>Call RemoveFiles<br>FunctionEnd<br><br>Function myOnAbort<br>;MessageBox MB_OK|MB_ICONINFORMATION "WE ARE ABORTING !!!"<br>; Let other parts of the installer know that we are aborting<br>StrCpy $InstallStatus "aborting_ir_install"<br>; In case we've already scheduled files for installation on the next HotSync,<br>; we should un-schedule them<br>Call RemoveInstallFiles<br>; Clean up all of the files that we copied to the PC<br>Call RemoveFiles<br>FunctionEnd<br><br>Function IndexOf<br>Exch $R0<br>Exch<br>Exch $R1<br>Push $R2<br>Push $R3<br><br>StrCpy $R3 $R0<br>StrCpy $R0 -1<br>IntOp $R0 $R0 + 1<br>StrCpy $R2 $R3 1 $R0<br>StrCmp $R2 "" +2<br>StrCmp $R2 $R1 +2 -3<br><br>StrCpy $R0 -1<br><br>Pop $R3<br>Pop $R2<br>Pop $R1<br>Exch $R0<br>FunctionEnd<br><br><br>; GetParameters<br>; input, none<br>; output, top of stack (replaces, with e.g. whatever)<br>; modifies no other variables.<br><br>Function GetParameters<br><br>Push $R0<br>; MessageBox MB_OK|MB_ICONINFORMATION "survey $R0"<br>Push $R1<br>Push $R2<br>Push $R3<br><br>StrCpy $R2 1<br>StrLen $R3 $CMDLINE<br>;Check for quote or space<br>StrCpy $R0 $CMDLINE $R2<br>StrCmp $R0 '"' 0 +3<br>StrCpy $R1 '"'<br>Goto loop<br>StrCpy $R1 " "<br><br>loop:<br>IntOp $R2 $R2 + 1<br>StrCpy $R0 $CMDLINE 1 $R2<br>StrCmp $R0 $R1 get<br>StrCmp $R2 $R3 get<br>Goto loop<br><br>get:<br>IntOp $R2 $R2 + 1<br>StrCpy $R0 $CMDLINE 1 $R2<br>StrCmp $R0 " " get<br>StrCpy $R0 $CMDLINE "" $R2<br><br>Pop $R3<br>Pop $R2<br>Pop $R1<br>Exch $R0<br>;MessageBox MB_OK|MB_ICONINFORMATION "survey $R0"<br>FunctionEnd<br><br>Function StrRep<br>/*After this point:<br>------------------------------------------<br>$R0 = RepString (input)<br>$R1 = SubString (input)<br>$R2 = String (input)<br>$R3 = RepStrLen (temp)<br>$R4 = SubStrLen (temp)<br>$R5 = StrLen (temp)<br>$R6 = StartCharPos (temp)<br>$R7 = TempStrL (temp)<br>$R8 = TempStrR (temp)*/<br><br>;Get input from user<br>Exch $R0<br>Exch<br>Exch $R1<br>Exch<br>Exch 2<br>Exch $R2<br>Push $R3<br>Push $R4<br>Push $R5<br>Push $R6<br>Push $R7<br>Push $R8<br><br>;Return "String" if "SubString" is ""<br>${IfThen} $R1 == "" ${|} Goto Done ${|}<br><br>;Get "RepString", "String" and "SubString" length<br>StrLen $R3 $R0<br>StrLen $R4 $R1<br>StrLen $R5 $R2<br>;Start "StartCharPos" counter<br>StrCpy $R6 0<br><br>;Loop until "SubString" is found or "String" reaches its end<br>${Do}<br>;Remove everything before and after the searched part ("TempStrL")<br>StrCpy $R7 $R2 $R4 $R6<br><br>;Compare "TempStrL" with "SubString"<br>${If} $R7 == $R1<br>;Split "String" to replace the string wanted<br>StrCpy $R7 $R2 $R6 ;TempStrL<br><br>;Calc: "StartCharPos" + "SubStrLen" = EndCharPos<br>IntOp $R8 $R6 + $R4<br><br>StrCpy $R8 $R2 "" $R8 ;TempStrR<br><br>;Insert the new string between the two separated parts of "String"<br>StrCpy $R2 $R7$R0$R8<br>;Now calculate the new "StrLen" and "StartCharPos"<br>StrLen $R5 $R2<br>IntOp $R6 $R6 + $R3<br>${Continue}<br>${EndIf}<br><br>;If not "SubString", this could be "String" end<br>${IfThen} $R6 &gt;= $R5 ${|} ${ExitDo} ${|}<br>;If not, continue the loop<br>IntOp $R6 $R6 + 1<br>${Loop}<br><br>Done:<br><br>;Return output to user<br>StrCpy $R0 $R2<br><br>/*After this point:<br>------------------------------------------<br>$R0 = ResultVar (output)*/<br><br>Pop $R8<br>Pop $R7<br>Pop $R6<br>Pop $R5<br>Pop $R4<br>Pop $R3<br>Pop $R2<br>Pop $R1<br>Exch $R0<br>FunctionEnd</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">25th December 2007 12:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">how about attaching such a long script next time, or use pastebin</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>