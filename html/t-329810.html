<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="First time elevating user rights" />

  <title>First time elevating user rights - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">First time elevating user rights</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=329810">First time elevating user rights</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ijese</span><br />
      <span class="post-time small text-muted">19th April 2011 12:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>First time elevating user rights</strong><br />
      I'm not a guru at all, so I have a simple installer which avoids need for admin rights by installing in c:\mydir<br />
      <br />
      Some people are irritated by installation not going into program files, and on Win 7 several different problems appeared in typical corporate environment.<br />
      <br />
      So I decided to finally do something about it. What I need is that installation checks whether user has admin rights and:<br />
      - If user is admin, then installer targets program files<br />
      - If user is not admin, installer targets c:\mydir AND warns the user that he needs admin password if he wants to change install dir to program files<br />
      <br />
      Everything fine if admin installs into program files or non-admin into c:\mydir<br />
      <br />
      If non-admin wants to (or have to) install into program files (eg. his admin is doing installation for him and wants everything in program files), then I have to use UAC plugin and be careful about what is done as "user" and what is done as "admin" (otherwise, user won't have icon on his desktop nor in start menu, etc).<br />
      <br />
      My questions are:<br />
      1. How should I go about checking whether user is admin and changing default target dir accordingly?<br />
      2. Did I get the part about UAC plugin right?<br />
      3. What happens if non-admin doesn't have access rights to c:\mydir?<br />
      <br />
      Any help greatly appreciated,<br />
      Igor</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">19th April 2011 12:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">First of all, you should not install to c:\anything in any case, whether you have admin rights or not. In Windows, admin applications are supposed to install themselves to Program Files, and non-admin applications are supposed to install themselves to $LOCALAPPDATA. That's where you need to install to. Not to c:\.<br />
      <br />
      Second, the userlevel icon problem isn't really a problem. The problem is that, once again, you're not doing what Windows demands. If you elevate your installer to admin, you MUST install your application for all users. That's how Windows is designed. Only userlevel installers are supposed to create userlevel icons.<br />
      <br />
      To answer your questions:<br />
      1. Use the UserInfo plugin in .onInit to determine whether a user is admin or not.<br />
      2. The UAC plugin is only designed to be used for one thing: Allowing an elevated installer to 'Run Installed Application' from the finish page, without giving that application admin access. What you want to do is not impossible, but it's not what the UAC plugin is designed for. (And again, see second point above. Don't create userlevel icons in an elevated installer. All elevated installers should be all-user.)<br />
      3. Your installation will fail. See first point above, userlevel installers should only install to $LOCALAPPDATA.<br />
      <br />
      <br />
      Edit: To create all-user icons, use the setshellvarcontext command.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Highcoder</span><br />
      <span class="post-time small text-muted">19th April 2011 12:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>...</strong><br />
      First that is all possible but it makes your installer more complicated.<br />
      <br />
      If the user has admin rights all will be fine. If not in most cases the admin donÂ´t want that users install things on the machine no matter which directory.<br />
      <br />
      So you should set $PROGRAMFILES always as default directory and request for admin privileges.<br />
      <br /></p>
      <pre>
<code>InstallDir</code><span style="color: #DD0000">"$PROGRAMFILES\mysoftware"
<br /></span><span style="color: #0000BB">RequestExecutionLevelAdmin</span><span style="color: #007700">;for</span><span style="color: #0000BB">Vista</span><span style="color: #007700">/</span><span style="color: #0000BB">7withUAConONLY</span><span style="color: #007700">!For</span><span style="color: #0000BB">UACoff</span><span style="color: #007700">and</span><span style="color: #0000BB">Win2k</span><span style="color: #007700">&amp;</span><span style="color: #0000BB">XPanothercheckupisrequired</span><span style="color: #007700">.
</span>
</pre>The additional checkup for adminrights for Win2k &amp; XP could we do in .onInit function.<br />
      For this the easiest way is to use the UserInfo plugin:<br />
      <br />
      PHP Code:
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #007700">Function.</span><span style="color: #0000BB">onInit<br />
      userInfo</span><span style="color: #007700">::</span><span style="color: #0000BB">getAccountType<br />
      pop</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">;</span><span style="color: #0000BB">poptheresultinto</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      strCmp</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #DD0000">"Admin"</span><span style="color: #0000BB">IsAdmin</span><span style="color: #007700">;</span><span style="color: #0000BB">compareresultwiththestring</span><span style="color: #DD0000">"Admin"</span><span style="color: #0000BB">tosee</span><span style="color: #007700">if</span><span style="color: #0000BB">theuserisadmin</span><span style="color: #007700">.If</span><span style="color: #0000BB">YesthenjumptoIsAdmin</span><span style="color: #007700">:<br /></span> <span style="color: #0000BB">messageBoxMB_OK</span><span style="color: #DD0000">"YouneedAdminrightstoinstallBlah-Soft"<br /></span> <span style="color: #0000BB">quit<br />
      IsAdmin</span><span style="color: #007700">:<br />
      ...<br /></span> <span style="color: #0000BB">FunctionEnd<br /></span></span> <!-- php buffer end -->
      <hr />
      Cheers
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
