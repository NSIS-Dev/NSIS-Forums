<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="ExecWait embeeded installation with Adminstartor rights"><title>ExecWait embeeded installation with Adminstartor rights - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">ExecWait embeeded installation with Adminstartor rights</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=303548">ExecWait embeeded installation with Adminstartor rights</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">ksngs78</span><br><span class="post-time small text-muted">27th February 2009 00:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>ExecWait embeeded installation with Adminstartor rights</strong><br>Hello,<br><br>I spent many hours in trying to find solution for following situation. My program doesn't need any "power" rights and is able to work under "normal" user. I wrote installer and use "APPDATA" as directory for installation. But my program uses third party library. Installation program of the library demands admin rights. So I need a way to execute the installer of the library under Administrator in case if the library is not installed. I looked at RunAs plugin but it demands creating of a dialog for inputing User&amp;password. It's not acceptable for security point. Is there any solution for this?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">27th February 2009 00:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">what I would do is, in .onInit, check if this library is installed, if its not (and the installer is not running as admin (check with userinfo plugin)), display a messagebox telling the user this and:<br><br>a) restart your installer with ExecShell and the runas verb<br>or<br>b) tell the user to restart your installer as admin<br><br>See also:<br><a href="http://nsis.sourceforge.net/Driver_installation_and_update" target="_blank">http://nsis.sourceforge.net/Driver_i...ion_and_update</a><br><a href="http://nsis.sourceforge.net/InstDrv_plug-in" target="_blank">http://nsis.sourceforge.net/InstDrv_plug-in</a><br>and search the wiki and forum for more info</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">ksngs78</span><br><span class="post-time small text-muted">27th February 2009 00:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Yep. I already implemented checking of admin right and etc.<br>1) ExecShell with "runas" has an ability to wait the process until it finishes? I'm not sure that it's possible because ShellExecute (Windows API) doesn't return process handle in this case (When "runas" is used). So WaitForSingleObject won't work.<br>2) If I start my installer as admin the program will be installed for admin user but I need to install it for current user. I mentioned that I use "APPDATA" of current user as destination.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">27th February 2009 01:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">ShellExecuteEx can return the child process handle, nsis does not support it out of the box, but you can call it with the system plugin or UAC::ShellExecWait (uac plugin)<br><br>The other option would be to rewrite your installer to use the UAC plugin, this way you can run as admin and still execute nsis code/extract files as the "current" user.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">ksngs78</span><br><span class="post-time small text-muted">27th February 2009 01:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I'm sorry. I mentioned ShellExecuteEx in the previous response. It doesn't return process handle for "runas" processes. ShellExecute doesn't have ability to get Process handle at all.<br><br>I tried to move forward with UAC plugin ... but I was confused and didn't understand how execute code/extract files as behalf of current user. Also "APPDATA" points to path of Administrator (not current user) and this is understandable because UAC creates a second process for installer and runs it again. And I get the same result - the program's installed for Admin user :)<br><br>BTW, UAC has its Logon dialog and it may confuse "more advanced" users.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">27th February 2009 01:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">ShellExecuteEx with runas does in fact return the process handle, and you can wait on it.<br><br>as far as the uac plugin goes, what you are looking for is UAC::ExecCodeSegment, it will execute a nsis function as the user, not the admin<br><br>I don't know what login dialog you are talking about, the UAC plugin just does ShellExecuteEx with the runas verb in 99% of system configurations</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">ksngs78</span><br><span class="post-time small text-muted">27th February 2009 01:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><i>Originally posted by Anders</i><br><b>ShellExecuteEx with runas does in fact return the process handle, and you can wait on it.</b></blockquote>Did you check it? I did. Always when I specify "runas" attribute hProccess has NULL. (WinXP + SP3)<br><br><blockquote><b><br>as far as the uac plugin goes, what you are looking for is UAC::ExecCodeSegment, it will execute a nsis function as the user, not the admin<br><br>I don't know what login dialog you are talking about, the UAC plugin just does ShellExecuteEx with the runas verb in 99% of system configurations</b></blockquote>UAC plugin has own dialog for login and password. You may find it in the source easily. Also UAC uses CreateProcessWithLogonW to start new process instead of ShellExecuteEx.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">27th February 2009 02:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I'm the author of the UAC plugin, so I know how it works...<br><br>It will use the OS runas unless the major version &gt;= 6 and UAC is off (In this configuration, UAC does not elevate so I have to roll my own solution)</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>