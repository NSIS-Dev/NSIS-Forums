<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Calculating Space required"><title>Calculating Space required - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Calculating Space required</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=291064">Calculating Space required</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">akshay.sharma</span><br><span class="post-time small text-muted">30th April 2008 12:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Calculating Space required</strong><br>Is there any way to calculate the Space Required for installation?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">30th April 2008 16:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">This is done automatically and displayed one the components page or directory page (can't remember which!)<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">akshay.sharma</span><br><span class="post-time small text-muted">2nd May 2008 05:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I have created a custom page, so how to calculate the Space required in that page</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">2nd May 2008 11:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Enumerate all of the sections, use SectionGetSize for each one and some it up with IntOp.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">6th May 2008 08:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Note that on 32bits Windows, IntOp will not allow numbers larger than 4294967296 (4GB). Use the Math plugin for larger installations.<br><br>If your problem is more related to customizing the space required depending on what files are already present on the target system, here's my code. I cloned the DIRECTORY page using nsDialogs and made it update the Space Required field realtime depending on what directory name is currently in the Install To: field.<br><br></p><pre>
<code>Function DIRECTORYpage<br>  nsDialogs::Create /NOUNLOAD 1018<br>  Pop $2<br>  GetDlgItem $1 $HWNDPARENT 1<br>  EnableWindow $1 0<br>  ${NSD_CreateLabel} 0u 0u 300u 18u "Setup will install $(^Name) in the following folder. \<br>    To install in a different folder, click Browse and select \<br>    another folder. Click Next to continue."<br>  Pop $2<br>  ${NSD_CreateGroupBox} 0u 70u 300u 35u "Destination Folder"<br>  Pop $2<br>  ${NSD_CreateDirRequest} 10u 85u 210u 12u "$INSTDIR"<br>  Pop $NSDFIELD1<br>  ${NSD_OnChange} $NSDFIELD1 DIRECTORYField1<br>  ${NSD_CreateBrowseButton} 229u 83u 59u 15u "Br&amp;owse..."<br>  pop $NSDBUTTON1<br>  ${NSD_OnClick} $NSDBUTTON1 DIRECTORYButton1<br>  ${NSD_CreateLabel} 0u 115u 100u 10u "Space required: 0MB"<br>  pop $NSDFIELD2<br>  ${NSD_CreateLabel} 0u 125u 100u 10u "Space available: 0MB"<br>  pop $NSDFIELD3<br>  call DIRECTORYField1<br>  SendMessage $NSDFIELD1 ${EM_SETSEL} 0 -1<br>  ${NSD_SetFocus} $NSDFIELD1<br>  !insertmacro MUI_HEADER_TEXT "Choose Install Location" "Choose the folder in which to install $(^Name)."<br>  nsDialogs::Show<br>FunctionEnd<br><br><br>Function DIRECTORYField1<br>  System::Call 'user32::GetWindowText(i $NSDFIELD1, t.r0, i${NSIS_MAX_STRLEN})'<br>  StrCpy $1 $0 2 1<br>  ${If} $1 == ":\" <br>    StrCpy $1 $0 2<br>    System::Call 'kernel32::GetDiskFreeSpaceExA(t, *l, *l, *l)i(r1,.r2,.,.) .r3'<br>    ${If} $3 == 0<br>      ;could not detect free space, drive probably doesn't exist. Disable Next button.<br>      SendMessage $NSDFIELD2 ${WM_SETTEXT} 0 "STR:Space required: 0MB"<br>      GetDlgItem $1 $HWNDPARENT 1<br>      EnableWindow $1 0<br>      goto DIRECTORYField1end<br>    ${EndIf}<br>    StrCpy $INSTDIR $0<br><br>    #(call some function that computes how much space is<br>    # needed, depending on what files were found in $INSTDIR)<br><br>    Math::Script 'r1 = ff(f(r2)/1048576,17); #[r1 &gt; 999, r1 = ff(r1/1024,17) + "GB", r1 = r1 + "MB"]'<br>    SendMessage $NSDFIELD3 ${WM_SETTEXT} 0 "STR:Space available: $1"<br>    Math::Script 'r1 = ff(f($SPACENEEDED)/1048576,17); #[r1 &gt; 999, r1 = ff(r1/1024,17) + "GB", r1 = r1 + "MB"]'<br>    SendMessage $NSDFIELD2 ${WM_SETTEXT} 0 "STR:Space required: $1"<br><br>    ;Prevent installing to root of $WINDIR, $WINDIR itself,<br>    ;$PROGRAMFILES or $SYSDIR (put down here because the<br>    ;Space fields should still update)<br>    StrCpy $0 $INSTDIR 3<br>    StrCpy $3 $WINDIR 3<br>    ${If} $0 == $3<br>    ${OrIf} $INSTDIR == "$PROGRAMFILES"<br>    ${OrIf} $INSTDIR == "$WINDIR"<br>    ${OrIf} $INSTDIR == "$SYSDIR"<br>      GetDlgItem $1 $HWNDPARENT 1<br>      EnableWindow $1 0<br>      goto GetINSTDIRField1end<br>    ${EndIf}<br>    <br>    Math::Script '#[$2 &gt; $SPACENEEDED, r1 = "EnoughSpace"]'<br>    ${If} $1 == "EnoughSpace"<br>      GetDlgItem $1 $HWNDPARENT 1<br>      EnableWindow $1 1<br>    ${Else}<br>      GetDlgItem $1 $HWNDPARENT 1<br>      EnableWindow $1 0<br>    ${EndIf}<br>  ${Else}<br>    SendMessage $NSDFIELD2 ${WM_SETTEXT} 0 "STR:Space required: 0MB"<br>    GetDlgItem $1 $HWNDPARENT 1<br>    EnableWindow $1 0<br>  ${EndIf}<br>  DIRECTORYField1end:<br>FunctionEnd</code>
</pre><br>
      <br>
      The function for the Browse button is as follows, in case you can use it:<br>
      <pre>
<code>Function DIRECTORYButton1<br>  ;remove all trailing backslashes and spaces from $INSTDIR<br>  StrCpy $2 $INSTDIR<br>  StrCpy $1 $2 1 -1<br>  StrCmp $1 '\' +2<br>  StrCmp $1 ' ' 0 +3<br>  StrCpy $2 $2 -1<br>  goto -3<br>  ;Get the deepest existing subdirectory in $INSTDIR<br>  ${Do}<br>    IfFileExists "$2\*.*" 0 +2<br>      ${ExitDo}<br>    ${CutBeforeLastBackslash} 3 $2<br>    StrLen $1 $3<br>    ${If} $1 &gt; 2<br>      StrCpy $2 $3<br>    ${Else}<br>      ${ExitDo}<br>    ${EndIf}<br>  ${Loop}<br>  nsDialogs::SelectFolderDialog "Select folder" $2<br>  pop $3<br>  StrCmp $3 "error" +2<br>  StrCpy $INSTDIR $3<br>  SendMessage $NSDFIELD1 ${WM_SETTEXT} 0 "STR:$INSTDIR"<br>FunctionEnd</code>
</pre><br>
      <br>
      And this uses the following macro:<br>
      <pre>
<code>;  Cut off a string just before its last backslash.<br>;  _outvar is the number/name of the variable to write to (0 for $0, 2 for $2,<br>;  NEVER USE $R# REGISTERS), _input is any string.<br>;  Example:<br>;<br>;  StrCpy $2 "c:\program files\longpath\subdir"<br>;  ${CutBeforeLastBackslash} 3 $2<br>;  # $2 is now: c:\program files\longpath\subdir<br>;  # $3 is now: c:\program files\longpath<br>!macro _CutBeforeLastBackslash _outvar _input<br>  Push $R0<br>  Push $R1<br>  Push $R2<br>  !define Lprefix L${__LINE__}<br>  StrCpy $R0 ${_input}<br>  ${Do}<br>    StrLen $R2 $R0<br>    ${If} $R2 == "0"<br>      ${ExitDo}<br>    ${EndIf}<br>    StrCpy $R1 $R0 "" -1<br>    StrCpy $R0 $R0 -1<br>    ${If} $R1 == "\"<br>      ${ExitDo}<br>    ${EndIf}<br>  ${Loop}<br>  StrCpy $${_outvar} $R0<br>  !undef Lprefix<br>  Pop $R2<br>  Pop $R1<br>  Pop $R0<br>!macroend<br>!define CutBeforeLastBackslash `!insertmacro _CutBeforeLastBackslash`</code>
</pre>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>