<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Push/Pop/Exch my head is spinning!"><title>Push/Pop/Exch my head is spinning! - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Push/Pop/Exch my head is spinning!</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=259023">Push/Pop/Exch my head is spinning!</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">davidnewcomb</span><br><span class="post-time small text-muted">6th November 2006 17:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Push/Pop/Exch my head is spinning!</strong><br>I must have written about 100 functions, and each time, I spend longer trying to figure out what order to push/pop/exch at the start and even longer figuring out what order to push/pop/exch at the end. It takes ages to figure it out and makes my head spin :(<br><br>Is there an easy trick I am missing to write saving 4 variables, popping 3 then pushing 2 and restoring 4.<br><br>Is there any chance this is going to be somthing that is going to be addressed? I was thinking of function-local stack? Eg same everything on the local stack, pop what you want, do work, push what you want, restore from function-local stack. Easy?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">niteflyer</span><br><span class="post-time small text-muted">6th November 2006 18:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">If your problem is parameter-passing to functions with the stack, you should have look at <a href="http://nsis.sourceforge.net/NfUtils_header_file," target="_blank">http://nsis.sourceforge.net/NfUtils_header_file,</a> especially <a href="http://nsis.sourceforge.net/NfUtils_header_file#nfu..21InstallFunction," target="_blank">http://nsis.sourceforge.net/NfUtils_...stallFunction,</a><br><a href="http://nsis.sourceforge.net/NfUtils_header_file#nfu..21AddFunction," target="_blank">http://nsis.sourceforge.net/NfUtils_...21AddFunction,</a><br><a href="http://nsis.sourceforge.net/NfUtils_header_file#nfu.Function" target="_blank">http://nsis.sourceforge.net/NfUtils_...e#nfu.Function</a> and<br><a href="http://nsis.sourceforge.net/NfUtils_header_file#nfu.FunctionEnd" target="_blank">http://nsis.sourceforge.net/NfUtils_...fu.FunctionEnd</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">davidnewcomb</span><br><span class="post-time small text-muted">6th November 2006 18:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks looks like that will be useful. Please can you give me an example to fit the following:<br><br>!macro GetPoolNameFromPoolId P_ID P_RET<br>Push "${TMP_POOLS_FILE}"<br>Push "${COLUMN_POOL_ID}"<br>Push "${P_ID}"<br>Push "${COLUMN_POOL_NAME}"<br>Call GetMatchInFile<br>Pop ${P_RET}<br>!macroend<br><br>Function GetMatchInFile<br><br># My temp variables are $0, $1, $2, $4<br># Then push something on the stack<br><br>FunctionEnd</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">niteflyer</span><br><span class="post-time small text-muted">6th November 2006 19:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Untested:<br></p><ul><li><font size="1"><br>${nfu.Function} GetMatchInFile out $9 in $0 in $1 in $2 in $4 '' '' '' '' '' '' '' '' '' ''<br>; you may use TMP_POOLS_FILE,COLUMN_POOL_ID,P_ID,COLUMN_POOL_NAME in $0,$1,$2,$4,<br>; collect result in $9<br>; your code, push and pop whatever you want:<br>; ...<br>; at this point the stack should be cleared from your 'local' stack-ops<br>${nfu.FunctionEnd}<br><br>${nfu.!InstallFunction} "" GetMatchInFile out RetVal in TmpPoolsFile in ColPoolID in pID in ColPoolName '' '' '' '' '' '' '' '' '' '' 'SomeDescription'<br><br>${nfu.!AddFunction} GetMatchInFile<br><br>!macro GetPoolNameFromPoolId P_ID P_RET<br>${GetMatchInFile} ${P_RET} "${TMP_POOLS_FILE}" "${COLUMN_POOL_ID}" "${P_ID}" "${COLUMN_POOL_NAME}"<br>!macroend<br><br></font></li></ul></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">6th November 2006 19:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The System plug-in can create a private stack for your function. See System::Store usage in Examples\System.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">niteflyer</span><br><span class="post-time small text-muted">7th November 2006 11:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I was just about to leave the office when I got notified of your 2nd post, so I was not really concentrated with my reply. I forgot some essentials (in red), OutFile is still missing:<br><br></p><pre>
<code><br>!include nfUtils.nsh<br><br>!define TMP_POOLS_FILE 10<br>!define COLUMN_POOL_ID 20<br>!define COLUMN_POOL_NAME 30<br><br><font color="red">!macro GetMatchInFile Un1 Un2</font> <br>${nfu.Function} <font color="red">${Un2}</font>GetMatchInFile out $9 in $0 in $1 in $2 in $4 '' '' '' '' '' '' '' '' '' ''<br>!verbose push<br>!verbose 4                 ; show my code<br>; you may use TMP_POOLS_FILE,COLUMN_POOL_ID,P_ID,COLUMN_POOL_NAME in $0,$1,$2,$4,<br>; collect result in $9<br>; your code, push and pop whatever you want:<br> StrCpy $9 "Result: $0$1$2$4"<br>; at this point the stack should be cleared from your 'local' stack-ops<br>!verbose pop<br>${nfu.FunctionEnd}<br><font color="red">!macroend</font> <br><br>${nfu.!InstallFunction} "" GetMatchInFile out RetVal in TmpPoolsFile in ColPoolID in pID in ColPoolName '' '' '' '' '' '' '' '' '' '' 'SomeDescription'<br><br>${nfu.!AddFunction} GetMatchInFile<br><br>!macro GetPoolNameFromPoolId P_ID P_RET<br>${GetMatchInFile} ${P_RET} "${TMP_POOLS_FILE}" "${COLUMN_POOL_ID}" "${P_ID}" "${COLUMN_POOL_NAME}"<br>!macroend<br><br>Section<br>SectionEnd<br><br>Function .onInit<br>; test the function<br>!insertmacro GetPoolNameFromPoolId 1 $8<br>FunctionEnd<br></code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">davidnewcomb</span><br>
      <span class="post-time small text-muted">7th November 2006 12:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If there are any other poor unfortunate individuals who are having stack problems then, this was the easiest way of solving all my problems. I'm sure that it is not as efficient as it could be, but at the end of the day its just an installer. The real goodies are in the payload!<br>
      <br>
      # Written by David Newcomb<br>
      !include "WinMessages.nsh"<br>
      <br>
      Name "Store test"<br>
      OutFile "Store.exe"<br>
      ShowInstDetails show<br>
      <br>
      Var answer<br>
      <br>
      Function .onInit<br>
      FunctionEnd<br>
      <br>
      Function StoreProt<br>
      <br>
      # Place stack protection code here<br>
      System::Store /NOUNLOAD "s"<br>
      <br>
      # Read parameters<br>
      Pop $0<br>
      Pop $1<br>
      Pop $2<br>
      Pop $3<br>
      Pop $4<br>
      <br>
      # -= Do sums =-<br>
      <br>
      # Push anser<br>
      Push "six"<br>
      <br>
      # Restore stack<br>
      System::Store "l"<br>
      <br>
      FunctionEnd<br>
      <br>
      Section<br>
      <br>
      StrCpy $0 "safe0"<br>
      StrCpy $1 "safe1"<br>
      StrCpy $2 "safe2"<br>
      StrCpy $3 "safe3"<br>
      StrCpy $4 "safe4"<br>
      StrCpy $5 "safe5"<br>
      StrCpy $6 "safe6"<br>
      StrCpy $7 "safe7"<br>
      StrCpy $8 "safe8"<br>
      StrCpy $9 "safe9"<br>
      <br>
      StrCpy $R0 "safeR0"<br>
      StrCpy $R1 "safeR1"<br>
      StrCpy $R2 "safeR2"<br>
      StrCpy $R3 "safeR3"<br>
      StrCpy $R4 "safeR4"<br>
      StrCpy $R5 "safeR5"<br>
      StrCpy $R6 "safeR6"<br>
      StrCpy $R7 "safeR7"<br>
      StrCpy $R8 "safeR8"<br>
      StrCpy $R9 "safeR9"<br>
      <br>
      Push "one"<br>
      Push "two"<br>
      Push "three"<br>
      Push "four"<br>
      Push "five"<br>
      <br>
      Call StoreProt<br>
      <br>
      Pop $answer<br>
      <br>
      DetailPrint "answer=$answer"<br>
      <br>
      DetailPrint "0 = $0"<br>
      DetailPrint "1 = $1"<br>
      DetailPrint "2 = $2"<br>
      DetailPrint "3 = $3"<br>
      DetailPrint "4 = $4"<br>
      DetailPrint "5 = $5"<br>
      DetailPrint "6 = $6"<br>
      DetailPrint "7 = $7"<br>
      DetailPrint "8 = $8"<br>
      DetailPrint "9 = $9"<br>
      <br>
      DetailPrint "R0 = $R0"<br>
      DetailPrint "R1 = $R1"<br>
      DetailPrint "R2 = $R2"<br>
      DetailPrint "R3 = $R3"<br>
      DetailPrint "R4 = $R4"<br>
      DetailPrint "R5 = $R5"<br>
      DetailPrint "R6 = $R6"<br>
      DetailPrint "R7 = $R7"<br>
      DetailPrint "R8 = $R8"<br>
      DetailPrint "R9 = $R9"<br>
      <br>
      SectionEnd</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Comm@nder21</span><br>
      <span class="post-time small text-muted">7th November 2006 19:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">i recommend reading <a href="http://nsis.sourceforge.net/Pop%2C_Push%2C_Exch..._The_Stack" target="_blank">Pop, Push, Exch... The Stack</a></p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">davidnewcomb</span><br>
      <span class="post-time small text-muted">8th November 2006 13:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I did read it, and I refer you to my orginal post.<br>
      When you have a function which pushs 4, uses 3 and pops 2 you have to spend 30 minutes drawing pictures of stacks to figure out whether to Exch 4 or 5.<br>
      Next time you write a function which pushs 2, uses 2 and pops 1, you have to do it all again, but slightly differently. I feel it is a bit of a waste of time.<br>
      Or you can Store/Restore and not care.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">niteflyer</span><br>
      <span class="post-time small text-muted">8th November 2006 13:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Or you use nfUtils' macros to wrap your function - and do not care ;)</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script type="text/javascript" src="../js/highlight.pack.js" async>
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>