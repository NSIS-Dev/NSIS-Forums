<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Installer not setting environment variables second time around."><title>Installer not setting environment variables second time around. - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Installer not setting environment variables second time around.</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=285646">Installer not setting environment variables second time around.</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">pgg1</span><br><span class="post-time small text-muted">25th January 2008 16:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Installer not setting environment variables second time around.</strong><br>Hi<br><br>I have an installer that installs my application and sets environment variables. I set these variables using kichik's script and the SetEnv.dll. I use SetEnv.dll to launch the application from the finish page. Everything work greats.<br><br>I've recently changed my script so now we uninstall any older versions of our application (if one is installed) and then install the newer one.<br><br>The problem is that the environment variables do not get set the second time around, for example:<br><br>(1) Install application (adds Environment variables).<br>(2) Uninstall the application using installer.exe, this removes the environment variables.<br>(3) Install application (DOES NOT add the Environment variables) therefore application cannot start.<br><br>Does anyone have any suggestions?<br><br>Regards<br><br>Paul</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">26th January 2008 15:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Did you execute the uninstaller from the installer? If so, the installer didn't get a chance to update its environment table and so it thinks the environment variable is still set and therefore doesn't set it again.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pgg1</span><br><span class="post-time small text-muted">27th January 2008 16:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Yes I did execute the uninstaller from the installer. How do I get around this problem?<br><br>Regards<br><br>Paul</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">27th January 2008 17:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Manually modify the environment variables for the working installer as well. Use:<br><br><a href="http://nsis.sourceforge.net/Setting_Environment_Variables_to_Active_Installer_Process" target="_blank">http://nsis.sourceforge.net/Setting_...taller_Process</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pgg1</span><br><span class="post-time small text-muted">27th January 2008 19:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Sorry I don't quite get what your saying. Could you clarify what you meant please.<br><br>At the moment I use: <a href="http://nsis.sourceforge.net/Path_Manipulation" target="_blank">http://nsis.sourceforge.net/Path_Manipulation</a><br>to set my environment variables, and this is done within a section.<br><br>I am already using:<br><a href="http://nsis.sourceforge.net/Setting_Environment_Variables_to_Active_Installer_Process" target="_blank">http://nsis.sourceforge.net/Setting_...taller_Process</a><br>in a function, and this function gets called from the active installer (i.e. finish page) so I can launch the application from the installer.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">27th January 2008 22:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">But you don't remove the path from the installer's environment after the uninstaller is executed.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pgg1</span><br><span class="post-time small text-muted">28th January 2008 06:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Isn't that just solving one problem and creating another? If I don't clean up after an uninstall then after numerous installs each one representing a newer release I will be adding duplicate environment variables. I've just tested:<br><br><a href="http://nsis.sourceforge.net/Path_Manipulation" target="_blank">http://nsis.sourceforge.net/Path_Manipulation</a><br><br>and it just concatenates to the end without any checking to determine if the environment variable your adding is already contained within.<br><br>Regards<br><br>Paul</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pgg1</span><br><span class="post-time small text-muted">28th January 2008 13:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I have a solution, I'll post what I have done later as I don't have time right now.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pgg1</span><br><span class="post-time small text-muted">28th January 2008 18:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I've taken this from a post last year.<br><br></p><pre>
<code><br>; This function allows us to add/remove directories to/from the system path.<br>!macro SetSystemPath un_<br>   function ${un_}SetSystemPath<br>      # stack top: &lt;'string to add'&gt; / &lt;AppendFlag&gt;<br>      Exch $0   ; new string<br>      Exch<br>      Exch $1   ; append = 2, prefix = 1, remove = 0<br>      Push $R0  ; saved working registers<br><br>      ReadRegStr $R0 HKLM "${REGISTRY_ENVIRONMENT}" "Path"<br><br>      ${Select} $1<br>         ${Case} 0<br>                ${${un_}WordAdd} "$R0" ";" "-$0" $R0<br>         ${Case} 1<br>                ${${un_}WordAdd} "$0" ";" "+$R0" $R0<br>         ${Case} 2<br>                ${${un_}WordAdd} "$R0" ";" "+$0" $R0<br>       ${EndSelect}<br><br>       WriteRegExpandStr HKLM "${REGISTRY_ENVIRONMENT}" "Path" "$R0"<br>       Pop $R0                          ; restore registers<br>       Pop $1<br>       Pop $0<br>       SendMessage ${HWND_BROADCAST} ${WM_WININICHANGE} 0 "STR:Environment" /TIMEOUT=5000<br>    functionEnd<br>!macroend<br>!insertmacro SetSystemPath ""<br>!insertmacro SetSystemPath "un."<br></code>
</pre><br>
      <br>
      I then use it like this in a section:<br>
      <pre>
<code><br>Push 2 ; 2 = append.<br>Push ${DLLS_ABSOLUTE_PATH}<br>Call SetSystemPath<br><br>WriteRegExpandStr HKLM "${REGISTRY_ENVIRONMENT}" "${ZANG_HOME}" "$INSTDIR"<br>  SendMessage ${HWND_BROADCAST} ${WM_WININICHANGE} 0 "STR:Environment" /TIMEOUT=5000<br><br>WriteRegExpandStr HKLM "${REGISTRY_ENVIRONMENT}" "${FFMPEG_HOME}" "$INSTDIR\ffmpeg"<br>  SendMessage ${HWND_BROADCAST} ${WM_WININICHANGE} 0 "STR:Environment" /TIMEOUT=5000<br></code>
</pre><br>
      <br>
      and uninstall:<br>
      <br>
      <pre>
<code><br>; Remove System variables.<br>  Push 0 ; 0 = remove<br>  Push ${DLLS_ABSOLUTE_PATH}<br>  Call Un.SetSystemPath<br>  <br>  ; Remove User variables.<br>  Push ${ZANG_HOME}<br>  Push $INSTDIR<br>  Call un.RemoveFromEnvVar<br>  <br>  Push ${FFMPEG_HOME}<br>  Push "$INSTDIR\ffmpeg"<br>  Call un.RemoveFromEnvVar<br></code>
</pre><br>
      <br>
      It's ugly but it works, if anyone has any further thoughts I'd appreciate them.<br>
      <br>
      Regards<br>
      <br>
      Paul
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>