<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="DEP checking/enabling/disabling" />

  <title>DEP checking/enabling/disabling - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.2/readable/bootstrap.min.css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">DEP checking/enabling/disabling</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=270520">DEP checking/enabling/disabling</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ocueed</span><br />
      <span class="post-time small text-muted">2nd May 2007 20:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>DEP checking/enabling/disabling</strong><br />
      &nbsp; Can anyone help me with issue. How I can check if DEP is enable, after that to disable it during the installation or something like that.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">3rd May 2007 19:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>
      <pre>
<code>!define PF_NX_ENABLED 12<br /><br />System::Call kernel32::IsProcessorFeaturePresent(i${PF_NX_ENABLED})i.r0<br /><br />${If} $0 != 0<br />  DetailPrint "NX enabled"<br />${Else}<br />  DetailPrint "NX disabled"<br />${EndIf}</code>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">congtak</span><br />
      <span class="post-time small text-muted">29th October 2007 01:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">in system-&gt;Advanced-&gt;Performance-&gt;Settings -&gt; Data Execution Prevention.<br />
      There are two options :<br />
      - Turn on dep for essential windows programs and services only.<br />
      - Turn on dep for all programs and services except those I select:<br />
      <br />
      How to check which one is currently selected using NSIS ?<br />
      I need my installer to change this setting to the first option. (dep for essential windows.. only).</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">29th October 2007 02:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">There are actually four DEP modes; AlwaysOn, AlwaysOff, OptIn, or OptOut.<br />
      <br />
      I think the setting might be stored in boot.ini on XP (maybe in the registry aswell) and you could probably find out with bcdedit(or whatever its called) on Vista</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">congtak</span><br />
      <span class="post-time small text-muted">29th October 2007 03:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for the quick reply..<br />
      I'm quite new to installer &amp; not very familiar with windows registry.<br />
      Where is the boot.ini located? &amp; what's the name of the entry in the windows registry?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">29th October 2007 03:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I don't know if there is a registry entry, that was just a guess.<br />
      <br />
      for boot.ini you probably have to so something like:<br />
      ReadEnvStr $0 SystemDrive<br />
      MessageBox mb_ok "$0\boot.ini"<br />
      <br />
      on vista, I have no idea, just call BCDEdit with nsExec probably<br />
      <br />
      You need to reboot to disable DEP I think, why not fix the code that has DEP issues instead?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">congtak</span><br />
      <span class="post-time small text-muted">29th October 2007 03:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">It's just that in the installer spec for the software says that DEP's setting could prevent the software from running the windows services installed. That's why i need to make sure the DEP is set to the one windows programs &amp; services only.<br />
      I still have no idea which part of the software that depends on this setting :P..</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Istaria</span><br />
      <span class="post-time small text-muted">10th April 2012 23:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Just thought I'd reply with what I wrote using the latest version of the Windows XP SP3 and higher check:<br />
      <br />
      !define DEP_SYSTEM_POLICY_TYPE_ALWAYSOFF 0 ; disabled<br />
      !define DEP_SYSTEM_POLICY_TYPE_ALWAYSON 1 ; always on, ignore white list<br />
      !define DEP_SYSTEM_POLICY_TYPE_OPTIN 2 ; only windows components<br />
      !define DEP_SYSTEM_POLICY_TYPE_OPTOUT 3 ; on, use white list<br />
      <br />
      ; take note that XP SP3 and earlier do not have this function, and return result is "error"<br />
      System::Call kernel32::GetSystemDEPPolicy()i.r0<br />
      ;MessageBox MB_OK "DEP is: $0"<br />
      <br />
      StrCmp $0 "error" skipDEP<br />
      IntCmp $0 ${DEP_SYSTEM_POLICY_TYPE_ALWAYSOFF} skipDEP<br />
      IntCmp $0 ${DEP_SYSTEM_POLICY_TYPE_OPTIN} skipDEP<br />
      <br />
      MessageBox MB_OK "DEP is currently enabled."<br />
      <br />
      skipDEP:</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">11th April 2012 02:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by Istaria</small><br />
        ; take note that XP SP3 and earlier do not have this function, and return result is "error"
      </blockquote>I'm guessing there is some undocumented function that can be used on XP.SP2 and 2003 (See <a href="http://www.hanselman.com/blog/TheWeeklySourceCode33MicrosoftOpenSourceInsideGoogleChrome.aspx" target="_blank">http://www.hanselman.com/blog/TheWee...gleChrome.aspx</a> and <a href="http://www.uninformed.org/?v=2&amp;a=4" target="_blank">http://www.uninformed.org/?v=2&amp;a=4</a> for details about setting per process DEP on these systems)
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">11th April 2012 03:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Might work, might crash (And would only be valid on XP.SP2 and 2003.SP1+ (x86))<br /></p>

      <blockquote>
        System::Call '*2147353301(&amp;i1.r7)'<br />
        DetailPrint Policy=$7
      </blockquote>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">DO_Visser</span><br />
      <span class="post-time small text-muted">12th April 2012 06:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>I found this script on the net which worked for me. Hope you can use it.</strong><br />
      &nbsp;</p>
      <pre>
;Get The DataExecutionPrevention Setting.
<br />&gt;ReadRegDword $0 HKLM "SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\NoExecuteState" "LastNoExecuteRadioButtonState"
<br /><br />&gt;;Value              Description
<br />&gt;;----------------- ------------------------------------------------------------------
<br />;0x000036BC(14012) DEP Is Enabled For Essential Windows Programs And Services Only.
<br />;0x000036BD(14013) DEP Is Enabled For All Programs And Services Except Those Seleced.
<br />;Blank             Setting Not Found, Add Program Anyway, Just To be Sure.
<br /><br />;Check If Data Execution Prevention Is Enabled.
<br />${Select} $0
<br />   ${Case} "14012"
<br />       ;Do Not Alter Registry Without Systems Adminstrator Consent.
<br />        ;Enable DEP.
<br />        ;WriteRegDWord HKLM "SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\NoExecuteState" "LastNoExecuteRadioButtonState" 0x000036BD
<br />       ;Add Your .exe To The Data Execution Prevention List.
<br />        ;WriteRegStr HKLM "SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Layers" "$EXE_DIR\$EXE_NAME" "DisableNXShowUI"
<br />   ${Case} "14013"
<br />       ;Add Your .exe To The Data Execution Prevention List.
<br />       WriteRegStr HKLM "SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Layers" "$EXE_DIR\$EXE_NAME" "DisableNXShowUI"
<br />   ${CaseElse}
<br />        ;Add Your .exe To The Data Execution Prevention List In Case It Is Enabled Later On.
<br />       WriteRegStr HKLM "SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Layers" "$EXE_DIR\$EXE_NAME" "DisableNXShowUI"
<br />&gt;${EndSelect} 
</pre>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>