<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Using external DLL's" />

  <title>Using external DLL's - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.2/readable/bootstrap.min.css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Using external DLL's</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=124306">Using external DLL's</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">djc</span><br />
      <span class="post-time small text-muted">8th February 2003 06:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Using external DLL's</strong><br />
      &nbsp; I'm developing a Palm app &amp; conduit. As part of the installation, the conduit has to be 'registered' with the Palm Hotsync manager using functions in the palm supplied "CondMgr.dll".<br />
      <br />
      How do I call/use functions in an external DLL? I've looked in the "System.dll" add on by brainsucker, but I'm not a Windows programmer and things aren't making much sense to me....<br />
      <br />
      All help/pointers/links gratefully accepted.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">8th February 2003 12:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">For this you will first have to know how exactly that function that you want to call was defined. If it's a regular registration function (DllRegisterServer) then you can just use RegDLL. If it's anything else you'll have to know the exact prototype (how the function was defined) and use System.dll to call it. If you get me the prototype I can help you write the line you need to use with System.dll.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">virtlink</span><br />
      <span class="post-time small text-muted">8th February 2003 15:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">KiCHiK, he's not a Windows programmer. With all you definition, regular registration and prototype talk, I think that you made him even more confused than he already is.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">8th February 2003 15:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Virtlink, I think he can answer by himself... If he could have typed the first post he must have a keyboard or at least a voice recognition application and a microphone... ;)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br />
      <span class="post-time small text-muted">8th February 2003 17:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">To be fair KiCHiK not only posted helpful information but offered to help further if needed. I don't think there is a non techy answer to the original question so I think KiCHiK did the only thing anyone can for a non-programmer. I'm sure given more time KiCHiK would gladly write the solution to this particular problem but he can't do that *and* try to perfect NSIS *and* be a forum moderator all at the same time!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">8th February 2003 17:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thank you Sunjammer :D</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">djc</span><br />
      <span class="post-time small text-muted">8th February 2003 22:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi kichik,<br />
      <br />
      According to the DLL doco, the function I need to us is defined as:<br />
      <br />
      int CmGetHotSyncExecPath(TCHAR *pPath, int *piSize);<br />
      <br />
      where<br />
      pPath is a pointer to a character buffer. Upon return, this is the path &amp; file name of the installed HotSync manager.<br />
      <br />
      piSize is a pointer to an integer that specifies the size (in TCHAR's), of the buffer referenced by the pPath parameter.<br />
      <br />
      result: 0 if no error, else error value<br />
      <br />
      Thanks for the offer of help. Sorry to take so long to reply, but I'm in Australia and have only just got out of bed! As Sunjammer notes, there is probably no non-technical answer to this question. As I noted before, I'm not a Windows programmer (certainly not to this level) - embedded micro's are more my area.<br />
      <br />
      Thanks again for the assistance.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br />
      <span class="post-time small text-muted">9th February 2003 00:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hmm I've just spent half an hour staring at System.txt, System.nsh,SysFunc.nsh and System.nsi. I feel like I'm soo close to being able to tell you how to use the System plugin to do this but I have to be honest, I can't quite work it out.<br />
      <br />
      If anyone else can help the point I got stuck on is this: the function populates a string, fair enough, so I use System::Alloc to alloc some space but then after the call when I've filled that space how on Earth do I get that string from the memory in the System plugin into an NSIS variable? (the variable populated by the System::Alloc call contains a pointer which is no use, I want a variable containing the string itself).<br />
      <br />
      The docs are, ahem, somewhat greek even to someone who regularly uses Windows API calls. It mostly makes sense, but I can't seem to find an example of how to deal with a function that populates a char array, all I can find is how to extract values from structures... so close and yet so far!<br />
      <br />
      I'm off to bed now, good luck!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">djc</span><br />
      <span class="post-time small text-muted">9th February 2003 04:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for spending the time Sunjammer. I'm glad I'm not the only one who finds the System plugin doco a bit cryptic.<br />
      <br />
      Hopefully someone else has had to do this and can pass on their knowledge....</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">virtlink</span><br />
      <span class="post-time small text-muted">9th February 2003 09:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Everyone has problems with that cryptic documentation, so flizebogen and Dark_boy are going to rewrite the documentation and I (propably some others also) will help.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br />
      <span class="post-time small text-muted">9th February 2003 09:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If I understand you correctly virtlink then it's great that not only the core NSIS documentation will be revised but also that of the plugins, especially System! :D</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">9th February 2003 14:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Sunjammer, you are dreaming. The only one that can rewrite that readme is Brainsucker himself :p<br />
      <br />
      Anyway, back to the original subject... I know Sunjammer has already sent you a little DLL that does this but I still had to give it a go :D<br />
      <br />
      Try:<br /></p>
      <pre>
<code>SetOutPath "C:\\Palm\\DLL\\Path"
<br />&gt;StrCpy $1 ${NSIS_MAX_STRLEN}
<br />&gt;System::Call 'dll_name::CmGetHotSyncExecPath(t, *i) i(.r0, .r1).r2'
<br />&gt;DetailPrint 'Path: "$0"'
<br />&gt;DetailPrint "Path length (I think): $1"
<br />&gt;DetailPrint "Return value: $2" 
</code>
</pre>Use this with the latest CVS version and it <i>should</i> work. Even if Sunjammer's DLL worked, please try this, I am curious :)
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br />
      <span class="post-time small text-muted">9th February 2003 15:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I think you're being optimistic KiCHiK, theoretically my DLL should work but whether or not I got it right first time who knows... then again theoretically it should be easily done using System too :)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">9th February 2003 15:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Optimisem rocks! :p<br />
      You'll see... One day, I am telling you! One day I will know how to use System.dll! :D</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">djc</span><br />
      <span class="post-time small text-muted">10th February 2003 05:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">OK, I tried kichik's code, using the latest CVS Zip file from Sourceforge. Unfortunately, no go. My code:<br />
      <br /></p>
      <pre>
<code><br />  SetOutPath $TEMP\eInspect             ; create temp directory<br />  File bin\CondMgr.dll                  ; copy dll there<br />  <br />  StrCpy $1 " " 1024<br />  System::Call 'CondMgr::CmGetHotSyncExecPath(t, *i) i(.r0, .r1).r2'<br />  DetailPrint 'Path: "$0"'<br />  DetailPrint "Path length (I think): $1"<br />  DetailPrint "Return value: $2"<br /></code>
</pre><br />
      <br />
      and the results:<br />
      <br />
      <pre>
<code><br />Output folder: c:\windows\TEMP\eInspect<br />Extract: CondMgr.dll<br />Path: ""<br />Path length (I think): 25<br />Return value: -1010<br /></code>
</pre><br />
      <br />
      Do I have to use "RegDll" before I can run this code?<br />
      <br />
      I've attached a zipped version of the DLL in question.<br />
      <br />
      Another question:<br />
      Can you please explain the syntax in the System::Call command you are using?<br />
      <br />
      <pre>
<code><br />System::Call 'CondMgr::CmGetHotSyncExecPath(t, *i) i(.r0, .r1).r2'<br /></code>
</pre><br />
      <br />
      My understanding is:<br />
      'CondMgr::CmGetHotSyncExecPath(t, *i) i' is the call to the function where t is a text string, *i is a pointer to an integer and i is an integer return value.<br />
      I also understand that r0, r1 &amp; r2 map to the NSIS variables $0, $1, $2 respectively.<br />
      What do the '.' (dots) signify? And why is the variable list presented after the function definition?<br />
      <br />
      Thanks for the assistance.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">10th February 2003 13:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">It should be:<br /></p>
      <pre>
<code>
StrCpy $1 1024 
<br />&gt;
</code>
</pre>not:<br />
      <pre>
<code>
StrCpy $1 " " 1024 
<br />&gt;
</code>
</pre>Your code copied the first 1024 chars of the string " ". I will try this myself too now that I have the DLL, and let you know.<br />
      <br />
      It will also be better if you use ${NSIS_MAX_STRLEN} instead of 1024, so you can be sure it's the right number.<br />
      <br />
      Now, for the command itself:<br />
      'CondMgr::CmGetHotSyncExecPath(t, *i) i' is indeed the prototype of the function. The last 'i' is the return type. The second list is the actualy parameters that are passed on. The dot "makes no change to source". I have no idea why we need this, but it worked with wsprintf this way. I have tried this DLL on my computer with HotSync running but it returned error -1010 yet again. Can you please find out what that error means from this DLL's docs?
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br />
      <span class="post-time small text-muted">10th February 2003 14:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">KiCHiK, what does System do about calling conventions? Windows API calls are __stdcall but I have a feeling this dll is __cdecl.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">10th February 2003 14:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Nope Sunjammer, __stdcall. Just checked that with VC. Can't get it to work with VC either though =/<br />
      It returns 0, 1 in the int pointer and nothing in the path.<br />
      <br />
      Try this one please:<br />
      System::Call 'CondMgr::CmGetHotSyncExecPath(t, *i) i(.r0, r1).r2'</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">djc</span><br />
      <span class="post-time small text-muted">10th February 2003 21:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Morning All.<br />
      <br />
      kichik, I tried the code<br /></p>
      <pre>
<code>
StrCpy $1 1024 
<br />&gt;
</code>
</pre>and my compiler barfed. I'll try to check out the latest CVS build again this morning and try the code again.<br />
      <br />
      Error codes from this function:<br />
      <br />
      0: No error<br />
      -1: A non-specific error occurred<br />
      ERR_REGISTRY_ACCESS(-1006):Unable to access the Palm configuration entries<br />
      ERR_BUFFER_TOO_SMALL(-1010): The buffer is too small to hold the requested information<br />
      ERR_INVALID_POINTER(-1013):The specified pointer is not a valid pointer<br />
      <br />
      Also, if the buffer is too small the value in *int is the size (in TCHARs) that the buffer should be.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">djc</span><br />
      <span class="post-time small text-muted">10th February 2003 21:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">YeeHa!<br />
      <br />
      We're away. Tried the latest mods that kichik suggested (i.e. remove the '.' from the pointer variable) and we're up.<br />
      <br /></p>

      <blockquote>
        Calling loadDll<br />
        Output folder: c:\windows\TEMP\eInspect<br />
        Extract: CondMgr.dll<br />
        Path: "C:\Dave\palm\Hotsync.exe"<br />
        Path length (I think): 1024<br />
        Return value: 0
      </blockquote>Sunjammer: I'll try your DLL as well after breakfast.<br />
      <br />
      Thanks **VERY** much everyone for the assistance, and for the excellent installer package.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br />
      <span class="post-time small text-muted">10th February 2003 21:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">DJC: Don't bother with the DLL, system is a much better solution.<br />
      <br />
      Could you do me a real favour please, pretty please :) Could you create a page in the Archive showing how to call your DLL function using System. It doesn't matter that others don't have your DLL, it shows a use of System that had to be figured out and that's worth showing to others.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">djc</span><br />
      <span class="post-time small text-muted">11th February 2003 00:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Sunjammer: I've posted up an example in the Archive as you suggested. See<br />
      <br />
      'Calling an external DLL using the System.dll plugin'<br />
      <br />
      in the examples section.<br />
      <br />
      Thanks everyone for your assistance anf forebearance.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">11th February 2003 15:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Told you optimisem rocks :D</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
