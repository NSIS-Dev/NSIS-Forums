<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Compiler Error with Dictionary Size &gt; 149 MB"><title>Compiler Error with Dictionary Size &gt; 149 MB - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Compiler Error with Dictionary Size &gt; 149 MB</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=291948">Compiler Error with Dictionary Size &gt; 149 MB</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">18th May 2008 00:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Compiler Error with Dictionary Size &gt; 149 MB</strong><br>Hi!<br><br>I noticed that makensis.exe fails to compile my script when I use LZMA compression with 150 MB dictionary size or even more. I get an "internal compiler error" and "failed to create uninstaller". Using 149 MB dictionary size seems to be the highest value that works. Is that an expected behavior or a bug?<br><br>Cheeeeeeeeers<br>MuldeR</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">18th May 2008 13:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Here is a log file that shows the problem:<br><br></p><pre>
<code>MakeNSIS v2.37 - Copyright 1995-2008 Contributors<br>See the file COPYING for license details.<br>Credits can be found in the Users Manual.<br><br>...<br><br>Processing script file: "Installer.nsi"<br><br>...<br><br>SetCompressor: /SOLID LZMA<br>SetCompressorDictSize: 150 mb<br><br>...<br><br>Generating uninstaller... Internal compiler error #12345:<br>  deflateInit() failed(initialization failed [-2]).<br><br>Note: you may have one or two (large) stale temporary file(s)<br>left in your temporary directory (Generally this only happens on Windows 9x).<br>!system: returned 1, aborting<br>Error in script "D:\MPUI\!_Build.nsi" on line 41 -- aborting creation process</code>
</pre><br>
      <br>
      Sorry for double posting, time limit to edit initial post was over :confused:
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">18th May 2008 19:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That large of a dictionary requires over 1.5GB of free memory. Do you have enough?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br>
      <span class="post-time small text-muted">18th May 2008 19:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">4 GB of physical RAM plus 4 GB swap file should be enough ;)<br>
      <br>
      I often use 7-Zip with LZMA mode and 256 MB of dictionary (occupies ~3,7 GB of RAM) and I'd like to do the same with NSIS...<br>
      <br>
      Did anybody manage to compile an installer with 150+ MB dictionary size yet?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br>
      <span class="post-time small text-muted">21st May 2008 04:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I noticed that the maximum dictionary size depends on the contents of the installer! I changed my installer quite a bit and now makensis suddenly fails (reproducible) with 149 MB dictionary size. Had to lower it to 144 MB to make my script compile again. Also makensis simply crashes when I use the !packhdr command to call UPX. Not using UPX plus successively lowering the dictionary size seems to workaround the compilation error...</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br>
      <span class="post-time small text-muted">23rd May 2008 14:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Sorry for posting again, but was anybody able to reproduce this problem? I think it's a bug in makensis and it should be addressed. It's not only that I have to lower the dictionary size (and waste some compression ratio), I even can't use UPX (or UPack) any more...<br>
      <br>
      If some more info is needed, please tell me what to do...</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">24th May 2008 22:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">UPX works fine for me.<br>
      <br>
      As for the dictionary, I only have 1.5GB of memory so I can't test it. I can say it fails at the right place - calling VirtualAlloc.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br>
      <span class="post-time small text-muted">24th May 2008 22:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by kichik</i><br>
        UPX works fine for me.
      </blockquote>It <i>usually</i> does work here too. But this pretty big/complex installer (the same that encounters the compiler error with dictionary size) definitely fails to compile as soon as I use !packhdr command.<br>
      <br>

      <blockquote>
        <i>Originally posted by kichik</i> As for the dictionary, I only have 1.5GB of memory so I can't test it. I can say it fails at the right place - calling VirtualAlloc. [/B]
      </blockquote>I can assure you that I have 4 GB of RAM available and the physical RAM definitely isn't out of memory. And even if so, I'd still have enough Swap File size on my HDD. Furthermore I use 7-Zip, which is the reference implementation of LZMA, quite often. And I use LZMA with 256 MB dictionary size to compress my HDD backups. That is much(!) more data than the installer has to handle, but it never failed. So I'm pretty sure that this error cannot be explained with "out of memory" error...
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">24th May 2008 22:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">There's more to it than the number of RAM chips you have. As far as I can tell from the source code, you need 1.5GB of contiguous memory. That's on top of whatever you need for the other file handling of NSIS. On a 32-bit system, that's a heavy requirement. Edit BigAlloc in Source\7zip\Common\Alloc.cpp and see if it really fails there or somewhere else.<br>
      <br>
      As for UPX, I need details as it works fine for me.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br>
      <span class="post-time small text-muted">24th May 2008 23:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by kichik</i><br>
        <b>There's more to it than the number of RAM chips you have. As far as I can tell from the source code, you need 1.5GB of contiguous memory. That's on top of whatever you need for the other file handling of NSIS. On a 32-bit system, that's a heavy requirement. Edit BigAlloc in Source\7zip\Common\Alloc.cpp and see if it really fails there or somewhere else.<br></b>
      </blockquote>Sorry, I don't have a build environment set up here. And even if so, my C++ skills are limited. So I'd need some more information on what exactly I need to edit to get more information about the problem...<br>
      <br>
      BTW: I'm running on a 64-Bit System (WinXP x64). NSIS is a 32-Bit process though.<br>
      <br>

      <blockquote>
        <i>Originally posted by kichik</i><br>
        <b>As for UPX, I need details as it works fine for me.</b>
      </blockquote>Screenshot:<br>
      <a href="http://img502.imageshack.us/my.php?image=nsiscrashjh1.png" target="_blank">http://img502.imageshack.us/my.php?i...iscrashjh1.png</a><br>
      <br>
      Log File:<br>
      <a href="http://pastebin.com/fc36186b" target="_blank">http://pastebin.com/fc36186b</a><br>
      <br>
      Compiles fine without the !packhdr command...<br>
      <br>
      The strange thing is: When I compile the "full" (bigger) version of my installer, it will work with UPX just fine. Only if I compile the "light" (smaller) version, which has some files left out via !ifdef..!endif (but is identical in all other places!), it will crash using UPX! I can compile both versions just fine by removing the !packhadr command...
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">{_trueparuex^}</span><br>
      <span class="post-time small text-muted">24th May 2008 23:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I did compile couple installers with 149 MB dictionary size without any problems and I only have 1GB of physical. Though I only packed about 20 MB installers. I did start compiling 300 MB installer too, but I didn't have the patience to wait it finish.<br>
      <br>
      Wherever 149 MB dictionary size is feasible is a completely different matter. :p<br>
      <br>
      PaR</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br>
      <span class="post-time small text-muted">24th May 2008 23:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by {_trueparuex^}</i><br>
        <b>Wherever 149 MB dictionary size is feasible is a completely different matter. :p</b>
      </blockquote>My installer is compressing ~160 MB of data, mostly EXE/DLL files. At the moment I squeezed the installer down to 24,8 MB. If you have to handle more than 20.000 downloads per month (~10 GB of traffic per day), every byte counts ^^
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br>
      <span class="post-time small text-muted">21st July 2008 02:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">After updating to NSIS 3.28, I still get the infamous "Internal compiler error #12345: deflateInit() failed(initialization failed [-2])" error at "Generating uninstaller..." when compiling my installer with to large dictionary. At the moment 145 MB works. Bigger dictonary size doesn't work...<br>
      <br>
      <b>Furthermore MakeNSIS will still crash when using !packhdr with UPX:</b><br>
      <a href="http://img516.imageshack.us/img516/3171/makensiscrashmr1.png" target="_blank">http://img516.imageshack.us/img516/3...iscrashmr1.png</a><br>
      <br>
      :cry:</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>