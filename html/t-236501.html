<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Problems on Japanese Windows XP" />

  <title>Problems on Japanese Windows XP - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Problems on Japanese Windows XP</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=236501">Problems on Japanese Windows XP</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">richardv</span><br />
      <span class="post-time small text-muted">27th January 2006 07:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Problems on Japanese Windows XP</strong><br />
      Hi all,<br />
      <br />
      I'm currently working on an NSIS installer and have run into a couple of problems testing on Japanese WinXP. The installer fails on startup with a "Error loading installer" message whenever the path to the installer executable contains Japanese Kanji characters. I've traced this to the loadHeaders() function in fileform.c to where the code does this:<br />
      <br />
      GetModuleFileName(g_hInstance, state_exe_directory, NSIS_MAX_STRLEN);<br />
      <br />
      g_db_hFile = db_hFile = myOpenFile(state_exe_directory, GENERIC_READ, OPEN_EXISTING);<br />
      if (db_hFile == INVALID_HANDLE_VALUE)<br />
      {<br />
      return _LANG_CANTOPENSELF;<br />
      }<br />
      <br />
      which more or less just plain doesn't work if there are Unicode characters in the path. Why is this using the ASCII Win32 functions? Is this because NSIS is MBCS and doesn't use Unicode because of compatibility with Win9x? I altered the code to instead use the equivalent Unicode functions and it then works correctly (though I guess it may not work right on Win9x). However, this problem appears to be more widespread: the installer fails to create any start menu or desktop items because they all have Japanese characters in the path! Is this a known issue, and if so, are there any workarounds, or does NSIS need to be extended to work correctly with Unicode path and file names? I am potentially able to assist with the work involved in improving/fixing NSIS in this area.<br />
      <br />
      Also, if anyone has any good ideas on fixing this problem: <a href="http://nsis.sourceforge.net/It%27s_all_rubbish_when_I_use_a_non-ASCII_language" target="_blank">http://nsis.sourceforge.net/It%27s_a...ASCII_language</a> then I'd be interested to know. The idea of calling SetThreadLocale() based on the selected language seems like a potentially good one, but I don't currently know enough NSIS internals to deduce whether it is workable or not.<br />
      <br />
      Thanks,<br />
      Richard</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">27th January 2006 15:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Re: Problems on Japanese Windows XP</strong><br /></p>

      <blockquote>
        <i>Originally posted by richardv</i><br />
        <b>Is this because NSIS is MBCS and doesn't use Unicode because of compatibility with Win9x?</b>
      </blockquote>Yes, exactly.

      <blockquote>
        <i>Originally posted by richardv</i><br />
        <b>I am potentially able to assist with the work involved in improving/fixing NSIS in this area.</b>
      </blockquote>There's currently an on-going effort to add Unicode support to NSIS. I've forwarded your name to the guy in charge.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">richardv</span><br />
      <span class="post-time small text-muted">29th January 2006 22:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">OK<br />
      <br />
      Who are the people that have worked on Unicode support in the past? Are there any in-progress patches that I can look at or start working with? Is there any previous discussion on how this would best be implemented? I have some ideas but I'm not certain. For my purposes I don't think Win9x support is an issue, so I may use a patched version that relies on various Unicode APIs. I'm really only needing NSIS to support Unicode in the system paths like to the desktop and start menu etc... I'm not planning on extending suport to anywhere else at the moment, we'll see how things go.<br />
      <br />
      Thanks,<br />
      Richard</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br />
      <span class="post-time small text-muted">29th January 2006 23:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The best thing would be to have NSIS scripts and language files in some Unicode format (probably UTF-8 for some backwards compatibility with US-ASCII). During run-time, all strings in memory should then be Unicode.<br />
      <br />
      Whenever the installer would run on a Win9x system the Unicode data should be converted to ANSI before making an API call without Unicode support.<br />
      <br />
      You see this system in many applications that still need to be compatible with Win9x. It is however a lot of work to add this feature to NSIS, so contributions would be very welcome.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">31st January 2006 17:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Richard, the guy in charge will fill you in on the details. As far as I know, there in-progress patches which are ready enough to work.<br />
      <br />
      Joost, it's a bit more complicated than that. There's a problem of backward compatibility with plug-ins and scripts. Using UTF-8 will practically kill every string handling script. However, using UTF-16 will kill plug-in backward compatibility.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">richardv</span><br />
      <span class="post-time small text-muted">31st January 2006 20:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">kichik,<br />
      <br />
      Great, if there are some reasonably complete patches around then it would be great to try/test them out. Who's in charge of the effort?<br />
      <br />
      If I had to choose I'd go with UTF-16 internally and require that plugins would have to be patched and recompiled. I think the translations should be able to be converted.<br />
      <br />
      I suppose it also depends how far you go with Unicode, ideally the scripts could include Unicode characters as well, UTF-8 would seem to be a good option for scripts and language files and could be converted to UTF-16 when read in and NSIS would be all UTF-16 internally like Windows is. Just a thought.<br />
      <br />
      Thanks,<br />
      Richard</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">31st January 2006 20:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Benski is working on Unicode support. There are <b>no</b> complete or even half-complete patches (missed a couple of words in the last message).<br />
      <br />
      The format of the script itself is irrelevant. That can be easily converted. It's the internal string format that matters most.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
