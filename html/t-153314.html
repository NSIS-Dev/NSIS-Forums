<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="RegDLL and ExecWait with /RegServer" />

  <title>RegDLL and ExecWait with /RegServer - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">RegDLL and ExecWait with /RegServer</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=153314">RegDLL and ExecWait with /RegServer</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mnavarro</span><br />
      <span class="post-time small text-muted">20th October 2003 17:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>RegDLL and ExecWait with /RegServer</strong><br />
      Hi all,<br />
      <br />
      My installer needs to register several COM objects. Some are DLLs and some are EXEs. I register the DLLs with RegDLL and I register the EXEs with ExecWait "myobject.exe /RegServer".<br />
      <br />
      But some EXEs depends on other DLLs and if the DLLs are not in the PATH ExecWait fails and shows an error message like "DLL &lt;dllname&gt; not found in path". That's fine. I like this message to appear to let the user know that something has gone wrong.<br />
      <br />
      But I have noticed that after the first call to RegDLL, the calls to ExecWait don't show any message (even when they are supposed to do so).<br />
      <br />
      And If I use "ExecWait regsvr32" instead of RegDLL, the next wrong calls to ExecWait DO show the error message. So there is something strange with RegDLL. Any ideas?<br />
      <br />
      Thanks<br />
      Marc</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br />
      <span class="post-time small text-muted">20th October 2003 18:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">RegDLL does exactly the same thing. Check the log to see whether the DLL registration was successful.<br />
      <br />
      Maybe RegDLL fails because the current path is wrong (you can set it using SetOutPath).</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mnavarro</span><br />
      <span class="post-time small text-muted">20th October 2003 18:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">RegDLL works fine. What is wrong are the next calls to ExecWait. Here is another example:<br />
      <br />
      Section "MySection"<br />
      RegDLL "myObject.dll"<br />
      ExecWait "a:\myapp.exe"<br />
      SectionEnd<br />
      <br />
      When this script executes (with NO disk in drive A) it shows no error. And that's wrong: it must show an error.<br />
      <br />
      If I comment the call to RegDLL or replace it with ExecWait "regsvr32 myObject.dll" then the call to ExecWait "a:..." shows an error ("There is no disk in A: Retry/Cancel/Ignore?")<br />
      <br />
      Why I don't get this error if RegDLL is used?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br />
      <span class="post-time small text-muted">20th October 2003 18:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If ExecWait/RegDLL is unable to exectue an application, the error flag is set (see documentation). It's up to the user to display a message or do something else.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mnavarro</span><br />
      <span class="post-time small text-muted">20th October 2003 18:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If I execute ExecWait "a:\app.exe" it sets the error flag, you are right, but it also displays an error message. I see no need to check the error flag in order to show an error message because ExecWait already shows an error message.<br />
      <br />
      I think I am not explaining myself clear enough. My question is not why do ExecWait fails. I know why it fails and I want it to show an error message for me. And it does. Just try ExecWait "a:\app.exe" and you will see an error.<br />
      <br />
      Then place any (succesful) call to RegDLL in the line before ExecWait and execute. You will not see any error and I expected ExecWait "a:\app.exe" to show an error (like it did the first time). Why ExecWait doesn't show an error now?<br />
      <br />
      (Maybe you think my question is "Why RegDLL doesn't show an error?" but that's not my question. I hope this time I have been clearer)<br />
      <br />
      Thanks.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br />
      <span class="post-time small text-muted">20th October 2003 18:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">As I said before, ExecWait does not show an error message. If you execute regsvr32 and it fails it is regsvr32 that displays a message, not ExecWait.<br />
      <br />
      NSIS commands like RegDLL and ExecWait never show error messages. That's because many users want to add their own error handling and messages. Instead of showing a message they set the error flag so the user can decide what to do.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mnavarro</span><br />
      <span class="post-time small text-muted">20th October 2003 18:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What you say is not completely true. Try ExecWait "a:\app.exe" and you will see that it displays an error message. Isn't it?<br />
      <br />
      I know that ExecWait doesn't show always an error message when an error occurs, but sometimes it does, like the previous example or when ou call an EXE/DLL that depends on another DLL that is not in the PATH.<br />
      <br />
      Am I right?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br />
      <span class="post-time small text-muted">20th October 2003 20:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">No. ExecWait "a:\app.exe" sets the error flag, it does not show an error message.<br />
      <br />
      It is indeed true that Windows shows an error message when a binary is executed and a dependency is missing. However, this is not related to ExecWait.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mnavarro</span><br />
      <span class="post-time small text-muted">21st October 2003 14:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Ok, so we agree that an error message appears when a binary is executed and a dependency is missing (it doesn't matter for me if Windows is the one showing it or ExecWait).<br />
      <br />
      What I am trying to tell you is that if your script performs a call to RegDLL then any other call to ExecWait that executes a binary and a depencency is missing doesn't show up any error message. I just want to know why.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">21st October 2003 15:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Different tricks to solve dependency problems with RegDLL have been used over different versions of NSIS. One of them might have an affect on the program you're trying to execute. Which version of NSIS are you using?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mnavarro</span><br />
      <span class="post-time small text-muted">21st October 2003 15:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I am using NSIS20b3.<br />
      <br />
      I want you to notice that the call that I made to RegDLL has noting to do with the call that I made to ExecWait. ExecWait has dependency problems but the reason has nothing to do with the call that I made to RegDLL. My question is not why ExecWait is failing or why RegDLL is failing. RegDLL is not failing, and ExecWait is failing because I make it on purpose.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">21st October 2003 15:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Some of the old tricks in RegDLL could have made the difference, but you're using b3 which doesn't have any of them.<br />
      <br />
      Maybe the code in the DLL registration server does this. Using RegSvr32 it runs in another process, but using RegDLL it runs in the installer's process which means it can change things like the working directory. Try forcing the working directory to something else using SetOutPath after using RegDLL.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mnavarro</span><br />
      <span class="post-time small text-muted">21st October 2003 16:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have tried SetOutPath "c:\" just after RegDLL and there is no difference. All the subsequent calls to ExecWait that should show a message (or should force Windows to show an error message) doesn't show it.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">21st October 2003 16:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well, then it must do something else. Without the source of the DLLs you are registering, I can't know for sure. But that should be the only difference between calling regsvr32 and using RegDLL.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mnavarro</span><br />
      <span class="post-time small text-muted">21st October 2003 16:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have seen that it only happens when using RegDLL with a COM DLL that uses MFC. I have sent you a project like that: it's a simple VC++ 6.0 ATL COM AppWizard project with just one COM object. I have modified the settings to use MFC: "Use MFC in a Shared DLL" in "General" tab and I have added a couple of includes in StdAfx.h.<br />
      <br />
      Compile it in Debug mode and try:<br />
      <br />
      RegDLL "C:\SimpleCom.dll"<br />
      ExecWait "a:\test.exe"<br />
      <br />
      You will not see any error message like "There is no disk in drive A:". If you remove the RegDLL line, you will see the message.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">21st October 2003 19:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Ah, COM... I am pretty sure I've read some where about COM DllRegisterServer using SetErrorMode, but I can't find that page now. If I remember correctly, that could be the source of the problem. SetErrorMode can control both of the messages you have described, so it must be it. You can call SetErrorMode using the System plug-in or use the latest CVS version. In the latest CVS version SetErrorMode is set back to 0 after RegDLL because it's set to something else before it.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mnavarro</span><br />
      <span class="post-time small text-muted">22nd October 2003 08:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Solved! Thanks!<br />
      <br />
      It was indeed related to SetErrorMode. I placed the next line after RegDLL:<br />
      <br />
      System::Call 'kernel32::SetErrorMode(i) i (0) .r1'<br />
      <br />
      and then the next calls to ExecWait displayed the error I wanted. I also checked (through the return value in $1) that RegDLL switched the error mode to<br />
      <br />
      SEM_NOOPENFILEERRORBOX | SEM_FAILCRITICALERRORS<br />
      <br />
      That's way no error was displayed.<br />
      Thanks again.<br />
      <br />
      BTW: Is there a way to tell System::Call that I want to ignore the return value? I don't want it to modify any of my registers. I know I can save the value of a register in the stack, but it would be better if I could just tell System:Call that I want no return...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">22nd October 2003 11:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You can simply not write the return value part. Use:<br />
      <br />
      System::Call "kernel32::SetErrorMode(i 0)"</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
