<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Second install directory not uninstalled"><title>Second install directory not uninstalled - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Second install directory not uninstalled</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=318535">Second install directory not uninstalled</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">hawkmaster</span><br><span class="post-time small text-muted">20th April 2010 12:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Second install directory not uninstalled</strong><br>Hello<br>I tried a script with two page directories. One for program files and one for data.<br>All works fine except the uninstall of the data directory.<br>All files and the the main install dir $INSTDIR are removed but not the<br>$INSTDIR2 folder.<br><br>I assume that $INSTDIR is not recogniced if uninstaller is starting?<br><br>Thanks for any help.<br><br>Here a part of my NSI code<br><br>-----------------------------------------------<br># First directory page for program files.<br>!insertmacro MUI_PAGE_DIRECTORY<br>; Instfiles page<br>!insertmacro MUI_PAGE_INSTFILES<br><br>##########################################################<br>##########################################################<br># Second directory page for data files.<br>var INSTDIR2<br>!define MUI_DIRECTORYPAGE_VARIABLE $INSTDIR2<br>!define MUI_PAGE_CUSTOMFUNCTION_PRE DirectoryPre<br>!insertmacro MUI_PAGE_DIRECTORY<br>!insertmacro MUI_PAGE_INSTFILES<br><br>Function DirectoryPre<br>StrCpy $INSTDIR2 "$PROGRAMFILES\Data"<br>FunctionEnd<br><br>##########################################################<br>##########################################################<br><br>; Finish page<br>!insertmacro MUI_PAGE_FINISH<br><br>; Uninstaller pages<br>!insertmacro MUI_UNPAGE_INSTFILES<br><br>; Language files<br>!insertmacro MUI_LANGUAGE "English"<br>!insertmacro MUI_LANGUAGE "French"<br>!insertmacro MUI_LANGUAGE "German"<br><br>; MUI end ------<br><br>Name "${PRODUCT_NAME} ${PRODUCT_VERSION}"<br>OutFile "Setup.exe"<br>InstallDir "$PROGRAMFILES\ITest"<br>ShowInstDetails show<br>ShowUnInstDetails show<br>....<br>....<br>Section Uninstall<br>RMDir /r "$INSTDIR2/Data"<br><br>Delete "$INSTDIR\${PRODUCT_NAME}.url"<br>Delete "$INSTDIR\uninst.exe"<br>Delete "$INSTDIR\index.php"<br>Delete "$INSTDIR\index.html"<br><br>Delete "$SMPROGRAMS\ITest\Uninstall.lnk"<br>Delete "$SMPROGRAMS\ITest\Website.lnk"<br><br>RMDir "$SMPROGRAMS\ITest"<br>RMDir "$INSTDIR"<br><br>DeleteRegKey ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}"<br>SetAutoClose true<br>SectionEnd<br>--------------------------------------------------</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">20th April 2010 13:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Variables are not transferred from the installer to the uninstaller. $INSTDIR is also not transferred. Instead, it contains the path where uninstall.exe is stored (in the hopes that this is the same as $INSTDIR was in the installer...). To transfer variables, use the registry or write the values to a file.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">hawkmaster</span><br><span class="post-time small text-muted">20th April 2010 13:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Done with ReadRegStr</strong><br>Hello,<br>thanks a lot for your help<br><br></p><blockquote><small>Originally posted by MSG</small><br>Variables are not transferred from the installer to the uninstaller. $INSTDIR is also not transferred. Instead, it contains the path where uninstall.exe is stored (in the hopes that this is the same as $INSTDIR was in the installer...). To transfer variables, use the registry or write the values to a file.</blockquote>Now I have written the variable $Instdir2 to the registry<br>WriteRegStr ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" "DataDirectory" "$INSTDIR2\Directories"<br><br>and in the unistall section I read the path from registry<br>ReadRegStr $R1 ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" "DataDirectory"<br>RMDir /r "$R1"<br>...<br><br>It works. If there is any problem with this code or if there is something to improve, please let me know.<br><br>best regards<br>Hawk</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">20th April 2010 14:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">While the basic idea is correct, there are two possible problems with that code. First of all, the regkey may not exist for some reason. In that case you'll end up calling RmDir /r "", which probably does nothing, but might perhaps also delete something you don't want deleted at all. So add a check: ${If} $R1 != "" RmDir etc ${EndIf}. Second, using the /r flag in RmDir is extremely dangerous. If some idiot end-user decided to put stuff inside your INSTDIR, you'll be deleting things the user doesn't want deleted. So it's almost <b>always</b> better to delete only those files you KNOW you want to delete:<br>Delete $R1\filename1.ext<br>Delete $R1\filename2.ext<br>RmDir $R1</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">hawkmaster</span><br><span class="post-time small text-muted">20th April 2010 14:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hello MSG,<br>thanks again for this tip.<br>Normally I always delete the files and directory like you recommend.<br>But, how can you delete and remove files from directories which have files included that are not recognized from installer?<br>Like in my Data directory. In this directory after installation there are many files copied, there a session files from the system. There are tmp files from Windows. All these files I do not know before installation.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">hawkmaster</span><br><span class="post-time small text-muted">21st April 2010 08:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>How deleting / uninstalling unknown files ?</strong><br>Hello,<br>I want to ask again:<br>I know that RMdir /r is not a good way for uninstalling files and directories.<br>But how can you make an uninstall of a directory which containts temporary files, like session files or log files?<br>all these files are created after the installation. So you cannot include it into the uninstall section.<br><br>Thanks for any hint.<br><br>regards<br>hawk</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">hawkmaster</span><br><span class="post-time small text-muted">21st April 2010 08:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>How deleting / uninstall unknown files?</strong><br>Hello,<br>I know that RMDIR /r is not a good way.<br>But how can you make an uninstall of a directory which contains files after installation?<br>For example Session files or log files which are created temporarely.<br>Or if other programs copies files in this directory.<br>All these files are not known while installing and cannot be added into the uninstall section<br><br>Thanks for any idea.<br>regards<br>hawl</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Animaether</span><br><span class="post-time small text-muted">21st April 2010 14:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You can delete files in a folder with wildcards, but you really should only remove the files you installed and files you know your program makes/might make and can safely be deleted. Any other files, such as a user's configuration settings and files written by other applications, either leave them alone or ask the user if they want to delete those, too.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">22nd April 2010 14:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I would never use RMDir /r in uninstall. If you give it an empty string and you have not set the current working directory ($OUTDIR) you will remove everything from C:\. I have heard of this happening after uninstalls and I would not be surprised if it was a lazily written NSIS uninstaller.<br><br>If you must be lazy and use RMDir /r, look at validating the contents of $INSTDIR before using it:<br><a href="http://nsis.sourceforge.net/Validating_$INSTDIR_before_uninstall" target="_blank">http://nsis.sourceforge.net/Validati...fore_uninstall</a><br><br>Stu</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script type="text/javascript" src="../js/highlight.pack.js" async></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>