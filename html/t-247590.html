<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Maintaining Ini files during upgrade" />

  <title>Maintaining Ini files during upgrade - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Maintaining Ini files during upgrade</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=247590">Maintaining Ini files during upgrade</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">beaglelander</span><br />
      <span class="post-time small text-muted">1st June 2006 12:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Maintaining Ini files during upgrade</strong><br />
      Hi everyone,<br />
      <br />
      I'm writting an installer/upgrader for an application which relies heavily on ini files to store config settings. I need the installer to be used for either a new installation or an upgrade - I don't want to have a separate installer for upgrades and another for new installations.<br />
      <br />
      New installations are fine because I can simply create ini files with the default entries in.<br />
      <br />
      My problem arises when I want to perform upgrades. I cannot recreate the entire ini file because it may overwrite some existing settings. So I was wondering, does anyone know if a function already exits similar to WriteINIStr that has an extra parameter that specifies whether to overwrite an existing entry in an ini file? This way I could ensure my existing settings do not get overwritten if they already exist, or force an overwrite if it does already exist. Or can anyone think of a better solution?<br />
      <br />
      Many thanks</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">1st June 2006 13:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Just read from the INI first and check if the result is empty and/or error flag</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">beaglelander</span><br />
      <span class="post-time small text-muted">1st June 2006 13:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well that's essentially what I want to achieve. But I can't pheasibly do this for the hundreds of entries it needs to check - the script will be huuuuuge</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">1st June 2006 14:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I'm not sure if this is what you want:<br />
      <a href="http://nsis.sourceforge.net/Update_an_existing_INI_file_with_values_from_an_updated_INI_file" target="_blank">http://nsis.sourceforge.net/Update_a...dated_INI_file</a><br />
      <br />
      -Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">beaglelander</span><br />
      <span class="post-time small text-muted">1st June 2006 15:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi Stu<br />
      <br />
      mmmmm not exactly what i'm after. That method would still overwrite my existing settings.<br />
      <br />
      Here's a full example of what I'm aiming for:<br />
      <br />
      Installer makes the following ini file with these default entries:<br />
      <br />
      A=1<br />
      B=2<br />
      C=3<br />
      <br />
      The program modifies these default settings to:<br />
      <br />
      A=1a<br />
      B=2a<br />
      C=3a<br />
      <br />
      Now, lets assume I want to run an upgrade at some later date. Let's say the program now uses D=4, so that needs to be added to the ini file. I don't want to overwrite the modifications that have been made to the existing entries (i'll have many unhappy users on my hand if I did this), so the end result is:<br />
      <br />
      [Section]<br />
      A=1a<br />
      B=2a<br />
      C=3a<br />
      D=4<br />
      <br />
      So basically, I want to do what Anders suggested and check if the entry already exists, if it does - skip it.<br />
      <br />
      I know I could do this:<br />
      <br />
      ReadINIStr $R0 "C:\myini.ini" "Section" "A"<br />
      StrCmp $R0 "" 0 +1<br />
      WriteINIStr "C:\myini.ini" "Section" "A" "1"<br />
      <br />
      <br />
      But bascially I don't want to have reems of code to check this, as it will treble the length of my script. Ideally what I'd like is this:<br />
      <br />
      WriteINIStr /c "C:\myini.ini" "Section" "A" "1"<br />
      <br />
      Where /c checks whether the entry already exists, if it does then skip it. I'm guessing something like that doesn't already exist, but I think it would be a useful addition. How difficult would it be to write a plugin?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">1st June 2006 16:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Put it in a macro...<br />
      <br /></p>
      <pre>
<code><br />!macro WriteINIStrIfMissing File Section Key Value<br />  ClearErrors<br />  ReadINIStr $R0 "${File}" "${Section}" "${Key}"<br />  IfErrors 0 +2<br />    WriteINIStr "${File}" "${Section}" "${Key}" "${Value}"<br />!macroend<br />!define WriteINIStrIfMissing `!insertmacro WriteINIStrIfMissing`<br /></code>
</pre><br />
      <br />
      Usage:<br />
      ${WriteINIStrIfMissing} "myfile.ini" "Section" "Key" "Val"<br />
      <br />
      -Stu
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">beaglelander</span><br />
      <span class="post-time small text-muted">1st June 2006 16:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Ahhhh I've never used macros before so I never thought to use one - that's excellent, thanks for your help stu! :-)</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
