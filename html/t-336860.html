<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Plugin with dependancies" />

  <title>Plugin with dependancies - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Plugin with dependancies</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=336860">Plugin with dependancies</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ginglese</span><br />
      <span class="post-time small text-muted">1st November 2011 18:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Plugin with dependancies</strong><br />
      Hi,<br />
      <br />
      i would like to create a nsis plugin to manage homemade stuff before installing my software.<br />
      So i have created a project for a nsis plugin and build it.<br />
      This plugin dll has some dependencies for Qt or homemade dll (for exemple).<br />
      <br />
      could it work ?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">1st November 2011 23:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You would have to put all DLL's that the plug-in DLL depends on into the same folder as the installer EXE (aka $EXEDIR) - <i>not</i> into the folder from where the plug-in DLL is loaded (aka $PLUGINSDIR). For details look at the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms682586%28v=vs.85%29.aspx#search_order_for_desktop_applications" target="_blank">Dynamic-Link Library Search Order</a>. Anyway, I would recommend to link everything <i>statically</i> into plug-in DLL to avoid dependencies. Qt can be built as static lib. Check your plug-in DLL with <a href="http://www.dependencywalker.com/" target="_blank">Dependency Walker</a> to make sure it doesn't have any dependencies that could prevent it from loading correctly...<br />
      <br />
      (BTW: The dependency on the Visual C++ Runtime libraries is another problem. Thus I would recommend to build plug-in DLL's with the <i>static</i> Runtime. Either that or link them against the VC 6.0 Runtime library, aka MSVCRT.DLL, which ships with Windows)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">T.Slappy</span><br />
      <span class="post-time small text-muted">2nd November 2011 06:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Read this article: <a href="http://nsis.sourceforge.net/Building_plug-ins_without_Microsoft_Visual_C_Run-Time_%28MSVCRT%29_dependency" target="_blank">http://nsis.sourceforge.net/Building...%29_dependency</a><br />
      <br />
      or this forum thread where my plug-in suffered with similar issues: <a href="http://forums.winamp.com/showthread.php?t=331275" target="_blank">http://forums.winamp.com/showthread.php?t=331275</a></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ginglese</span><br />
      <span class="post-time small text-muted">2nd November 2011 07:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi,<br />
      <br />
      Thanks a lot for the returns.<br />
      I will look at those links and post here how i handle things.<br />
      <br />
      Guillaume</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ginglese</span><br />
      <span class="post-time small text-muted">5th November 2012 12:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi,<br />
      <br />
      Just for the record, here is how I handled it :<br />
      I use the SetOutPath before using my plugin functions.<br />
      <br />
      ReserveFile "${NSISDIR}\Plugins\MyPlugin.dll"<br />
      ...<br />
      <br />
      SetOutPath $TEMP<br />
      File "MyPluginDependenciesDlls.dll"<br />
      File ...<br />
      <br />
      MyPlugin::myPluginFunction<br />
      ; get result<br />
      pop $R2<br />
      <br />
      Guillaume</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">5th November 2012 19:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I think <i>SetOutPath</i> will also change the "current directory", which is why the DLL will be loaded from there. That's because the "current directory" is one of the directories that will be searched when loading a DLL (remember the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms682586%28v=vs.85%29.aspx#search_order_for_desktop_applications" target="_blank">Dynamic-Link Library Search Order</a>). However the directory where the installer executable is located will always be searched first. This could result in the wrong DLL being loaded! Furthermore loading DLL's from the "current directory" is discouraged, because it can result in security problems. That's why most applications will disable this behavior by calling <i>SetDllDirectory("")</i> nowadays. I think you would be best off by either avoiding DLL dependencies for plug-in DLL's or, if that isn't possible, let your plug-in DLL load the required DLL via <i>LoadLibrary()</i> and a <u>full path</u>. Your plug-in DLL could determine its own location (i.e. the installer's plug-ins directory) via <i>GetModuleFileName()</i> and then construct the path.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
