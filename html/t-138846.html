<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Inconsistency/bug? with 'SetShellVarContext all '"><title>Inconsistency/bug? with 'SetShellVarContext all ' - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Inconsistency/bug? with 'SetShellVarContext all '</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=138846">Inconsistency/bug? with 'SetShellVarContext all '</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">Lilla</span><br><span class="post-time small text-muted">13th June 2003 03:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Inconsistency/bug? with 'SetShellVarContext all '</strong><br>Observation, with latest CVS, just downloaded<br><br>under Win98SE, the code below adds<br>desktop shortcuts to c:\Windows\All Users\Desktop<br>*but adds*<br>startmenu shortcuts to c:\Windows\StartMenu<br><br>Is this inconsistency a bug?<br><br><br>SetShellVarContext all<br><br>;Create startmenu shortcuts<br>CreateDirectory "$SMPROGRAMS\${MUI_PRODUCT}"<br>CreateShortCut "$SMPROGRAMS\${MUI_PRODUCT}\Uninstall.lnk" "$INSTDIR\Uninstall.exe"<br><br>CreateShortcut "$SMPROGRAMS\${MUI_PRODUCT}\cleanNdefrag.lnk" "$INSTDIR\Gui4Cli.exe" '-instance cleanNdefrag "$INSTDIR\cleanNdefrag\cleanNdefrag.gui"'<br><br>;Create desktop shortcuts<br>CreateShortcut "$DESKTOP\cleanNdefrag.lnk" "$INSTDIR\Gui4Cli.exe" '-instance cleanNdefrag "$INSTDIR\cleanNdefrag\cleanNdefrag.gui"'</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">13th June 2003 10:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Isn't C:\Windows\StartMenu the start menu directory for all users? What do you get with SetShellVarContext current?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">virtlink</span><br><span class="post-time small text-muted">13th June 2003 11:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">At my computer (Win XP), the Start Menu is in the 'All users'-directory.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Lilla</span><br><span class="post-time small text-muted">13th June 2003 18:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">To read a summary of the NSIS problem jump to the end of this post.<br><br>It looks like Office XP created the c:\WINDOWS\All Users\... folders that appear on this Win98SE system, as explained below.<br><br>This Win98SE system is a recent clean install on a freshly formatted drive. It includes IE6, Office XP, DUN 1.4, Jet4SP6, and a number of other updates. I am the only user of this system so it is a good model system. This system has (and has always had the same) one user/profile defined.<br><br>This system has the folders shown below...<br><br>It is important to note that Office XP has placed two files in the C:\WINDOWS\All Users\...\Data folder (namely Data.dat and Data.bak) and *all* other 'All Users' folders are totally empty. This is with 'Show All Files' setting.<br><br>---<br><br>The All Users folders...<br><br>C:\WINDOWS<br>C:\WINDOWS\All Users<br>C:\WINDOWS\All Users\Application Data\Microsoft<br>C:\WINDOWS\All Users\Application Data\Microsoft\HTML Help<br>C:\WINDOWS\All Users\Application Data\Microsoft\Office<br>C:\WINDOWS\All Users\Application Data\Microsoft\Office\Data<br>C:\WINDOWS\All Users\Desktop<br>C:\WINDOWS\All Users\DRM<br>C:\WINDOWS\All Users\Start Menu<br>C:\WINDOWS\All Users\Start Menu\Programs<br>C:\WINDOWS\All Users\Start Menu\Programs\Startup<br><br>----<br><br>The normal folders...<br><br>C:\WINDOWS\Application Data\ ... lots of entries below here<br>C:\WINDOWS\Desktop\<br>C:\WINDOWS\Start Menu<br>C:\WINDOWS\Start Menu\Programs\ ... lots of entries below here<br>C:\WINDOWS\Start Menu\Programs\Startup<br><br>---------------<br><br>NSIS documentation says...<br><br>SetShellVarContext<br>current|all<br><br>Sets the context of $SMPROGRAMS and other shell folders. If set to 'current' (the default), the current user's shell folders are used. If set to 'all', the 'all users' shell folder is used. The all users folder may not be supported on all OSes. If the all users folder is not found, the current user folder will be used. Please take into consideration that a "normal user" has no rights to write in the all users area. Only admins have full access rights to the all users area. You can check this by using the UserInfo Plugin. See Contrib\UserInfo\UserInfo.nsi for an example.<br><br>---<br><br>To summarize the problem with the latest NSIS CVS:<br><br>Currently, when 'all' is set on a Win98SE system with Office XP installed, NSIS adds shortcuts inconsistently<br>- NSIS adds desktop shortcuts to the 'All Users' folder<br>(c:\WINDOWS\All Users\Desktop)<br>- NSIS adds start menu shortcuts to the 'Current User' (C:\WINDOWS\Start Menu)<br>- Futher, the uninstall does not remove the desktop shortcuts that it placed in the 'All Users' folder.<br><br>Thus, the new information that NSIS needs to take into consideration is that a Win9x system with Office XP installed will have an 'All Users' folder, but you should *not* use it (at least that is how it appears to me).<br><br>I hope this additional information is helpful,<br>Lilla</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">15th June 2003 17:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I don't know what Microsoft XP thinks it's doing but "C:\WINDOWS\Start Menu" can't a certain user's start menu folder, there is no user name there... SetShellVarContext works fine on my Windows 98 and Windows XP.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Lilla</span><br><span class="post-time small text-muted">15th June 2003 19:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Kichik, I believe the problem I am reporting will be seen on any Win9x machine that has Office XP install (I haven't tested Office 2000, so I cannot say if same is true there, but it might be.)<br><br>To workaround this, I have added this test to my code:<br><br>Call GetWindowsVersion<br>Pop $7 ; at this point $7 is "NT 4.0" or whatnot<br>!define WIN_VER $7 ; create a global variable<br>; MessageBox MB_OK "GetWindowsVersion ${WIN_VER}"<br><br>StrCmp ${WIN_VER} "95" CurrentUser<br>StrCmp ${WIN_VER} "98" CurrentUser<br>StrCmp ${WIN_VER} "98 SE" CurrentUser<br>SetShellVarContext all<br>CurrentUser: ; current is the default<br><br>Lilla</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">deguix</span><br><span class="post-time small text-muted">15th June 2003 19:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Occur EXATLY that he/she say with my computer too (I have Office XP and Win 98 SE).</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">15th June 2003 19:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">BTW, as for the uninstaller, SetShellVarContext isn't remember from the installer, you have to set it again.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">deguix</span><br><span class="post-time small text-muted">15th June 2003 20:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Is not a NSIS bug, because lack a reg string that say the All Users Start Menu, so NSIS will use the current one (but if you use the $SMSTARTUP or $DESKTOP, see that will be used the All Users folder).</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Lilla</span><br><span class="post-time small text-muted">16th June 2003 20:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">kichik, that's for that extra information.<br>I will add it to my uninstall.<br><br>I think it would be great if there were an Example for AddRemovePrograms.<br><br>Lilla</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br><span class="post-time small text-muted">16th June 2003 21:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Check Appendix C.3 of the Users Manual for an Add/Remove Programs example &amp; info.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Lilla</span><br><span class="post-time small text-muted">17th June 2003 03:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">My Add/Remove example is working fine now.<br><br>Appendix C is good. Still, I think that a basic functional example would be helpful to many people. Just a thought.<br><br>Your examples have helped me immensely, they make it easy to get started. Thank you for doing them!<br><br>Lilla</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>