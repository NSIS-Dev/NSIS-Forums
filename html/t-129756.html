<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="UpgradeDLL macro not foolproof?" />

  <title>UpgradeDLL macro not foolproof? - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">UpgradeDLL macro not foolproof?</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=129756">UpgradeDLL macro not foolproof?</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">RDaneel</span><br />
      <span class="post-time small text-muted">25th March 2003 23:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>UpgradeDLL macro not foolproof?</strong><br />
      As appealing as it is to use the version checking logic to avoid "unnecessary" DLL installs, there seems to me to be an easy way for an end-user to get in trouble:<br />
      <br />
      If a user does an uninstall of your app which results in "scheduled" removal of one or more in-use DLLs, and then does a new install of your app (with the same DLL versions) WITHOUT REBOOTING, they will end up not having any of the "in-use" DLLs on their system when they do get around to rebooting!<br />
      <br />
      This happens because the install (after the uninstall) still "sees" the DLLs (which are set to be deleted at the next reboot) and, not detecting a version upgrade, fails to expand/rename any of the DLLs in question... but at the next reboot, these DLLs get deleted!<br />
      <br />
      So it looks to me like the "safe" thing to do is to always bring the "new" DLL in, though you can still try to be friendly and not require a reboot if there are no "in-use" problems. Remember, a cool install package like NSIS is there to make things easy for the user (*and* us), not create new ways for them to get themselves in trouble. :)<br />
      <br />
      In my own case, I have a Shell Extension DLL which implements a property page for my own shortcut type, and whether this DLL will be "in-use" varies across Windows versions... on everything before 2000, just having one of my shortcuts on the desktop is enough to make my DLL always "in-use". On 2000 and XP, I need to actually cause the display of my property page to "lock" my DLL (good ol' Windows Explorer).<br />
      <br />
      As always, corrections/discussion is invited!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br />
      <span class="post-time small text-muted">26th March 2003 13:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You forgot about one thing.<br />
      <br />
      If you extract the DLL using a normal File command, it will still be removed on reboot, because it is on the delete list.<br />
      <br />
      A possibility is to let the uninstaller write a temp file that will be removed on reboot, so you can prevent the installer from starting when the file exists.<br />
      <br />
      If you are using own DLL's with unique file names, you don't have to do all the version checking. But for shared DLL's, you always have to check. Overwriting new DLL's with older versions can break up other applications.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">RDaneel</span><br />
      <span class="post-time small text-muted">26th March 2003 21:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">First, thanks for responding, Joost, since this WAS posted to you. :)<br />
      <br />
      "If you extract the DLL using a normal File command, it will still be removed on reboot, because it is on the delete list."<br />
      <br />
      Of course, but then that isn't what one would do - you would bring it in under some other name and RENAME it. The main idea here is to not skip this whole process based just on a version check.<br />
      <br />
      "A possibility is to let the uninstaller write a temp file that will be removed on reboot, so you can prevent the installer from starting when the file exists."<br />
      <br />
      Clearly, one can employ various schemes to work around the fundamental problem(s) with only using a simple version-check scheme, including, say, trying to detect which of your DLLs may be scheduled for removal at the next reboot, but that isn't the point here... the point of view I am trying to support is that we, as developers, should do what we can to not make things difficult for the user, whether the "fault" lies with them or us.<br />
      <br />
      Regarding the possible solution you mention, sure, it could work, but then you will have to tell the user that, no, they CAN'T go through a "normal" uninstall - install sequence without rebooting in between... remember, users are somewhat "conditioned" to doing a reboot at the end of some installs, but are much more rarely told that they have to reboot after an uninstall.<br />
      <br />
      The simple "bring in yourdll.tmp and rename it to yourdll.dll" (which MAY require a reboot to complete) works, and allows for the expected uninstall followed by an install to proceed without ugly surprises. :)<br />
      <br />
      " If you are using own DLL's with unique file names, you don't have to do all the version checking. But for shared DLL's, you always have to check. Overwriting new DLL's with older versions can break up other applications."<br />
      <br />
      Obviously, things get trickier in the "shared DLL" case(s)... and one certainly never wants to overwrite new DLLs with old! That is sort of the definition of the classic "DLL Hell".<br />
      <br />
      So, yes, in the "shared DLL" cases, other mechanisms need to be employed, but that STILL doesn't include just simple version checking... isn't it cool that we can now use (in XP and Server 2003) "Side-By-Side assemblies" to avoid all this? Life will be SO much easier. :)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br />
      <span class="post-time small text-muted">26th March 2003 22:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The problem is not related to UpgradeDLL. If the file is on the delete list for the next reboot, it will always be removed. Rename won't solve the problem, when the DLL is not in use anymore, it will be overwritten directly.<br />
      <br />
      I see no other option than locking the installer until the system has been restarted. I have seen other installer doing this before.<br />
      <br />
      If you can think of a better solution, keep me informed :D</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">RDaneel</span><br />
      <span class="post-time small text-muted">26th March 2003 22:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You are right, there is not a problem with UpgradeDLL as such... I have just been trying to shed light on some implicit assumptions in its logic.<br />
      <br />
      So, please let me know if I have any of this wrong:<br />
      <br />
      The model is to always, in the installer, bring in your DLL with a "tmp" name, and then do a "Rename /REBOOTOK ..." to the "real" DLL name, while the uninstaller does a "Delete /REBOOTOK ..." on the DLL when IT runs.<br />
      <br />
      Now, running the uninstaller and the installer back-to-back, we have the following cases:<br />
      <br />
      1) the uninstaller deleted your DLL straight away, since it wasn't "in-use" - in this case, it is NOT on the delete list - it is just gone. When the installer runs, the rename proceeds without conflict and all is well.<br />
      <br />
      2) the uninstaller could NOT delete your DLL, because it was "in-use", and so it is placed on the delete list but is still present. When the installer runs, the rename fails, and is scheduled to happen at the next reboot - AFTER the delete has been processed (it is my understanding that this sequence WILL be maintained).<br />
      <br />
      Am I still missing something? And yes, there is still potential for ugliness if the poor user tries to "stack" things more, by adding yet another uninstall - install sequence, BUT that "shouldn't happen", since they are invited in no uncertain terms to REBOOT at the end of the initial install operation! :)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br />
      <span class="post-time small text-muted">27th March 2003 14:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Right. It should be renamed after deleting, so there is no problem.<br />
      <br />
      If the DLL's are not always in use (no shell extension, normal app that is running), the uninstaller should ask to close the application.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">virtlink</span><br />
      <span class="post-time small text-muted">28th March 2003 11:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Can't an installer remove a file from the delete list?<br />
      <br />
      <font size="1">Non NSIS Related: According to the Glossary Of Forum Terms, i'm a Regular: 'Someone who lives on the forums. Their diet usually consists of waffles, syrup and Mountain Dew. Reknowned for their general friendliness, regulars are far from being extinct. But please, support their cause by donating generously to the Poor Boy Foundation.'<br />
      Poor me! :p</font></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">RDaneel</span><br />
      <span class="post-time small text-muted">28th March 2003 19:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by virtlink</i><br />
        <b>Can't an installer remove a file from the delete list?</b>
      </blockquote>Well, if you <i><b>really</b></i> wanted to mess with the "pending for reboot" file operations (although I would think that is a Bad Idea(tm) ;) , you can check out the documentation of <i>MoveFileEx</i>, which describes where the "pending" file list is stored in both the NT-class versions (the registry) and the 9x-class style (WININIT.INI).<br />
      <br />
      The <i>MoveFileEx</i> description raises another question (possibly for kichik): since <i>MoveFileEx</i> supports [empty] directories, why doesn't <b>RMDir</b>? Is it because the 9x-style of doing things doesn't work for directories (it is not obvious from the doc)? Note that if that isn't the reason, the definition of the remove-directory-at-reboot logic makes the facility useful: the directory only needs to be empty when its turn for deletion comes up, <i>i.e.</i>, any files in it have been deleted first.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">RDaneel</span><br />
      <span class="post-time small text-muted">28th March 2003 22:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Ack! I left out a key point in my reply above!<br />
      <br />
      "... since MoveFileEx supports [empty] directories, why doesn't RMDir?"<br />
      <br />
      was <b>supposed</b> to say<br />
      <br />
      "since MoveFileEx supports <b>removing</b> [empty] directories <b>at reboot time</b>, why doesn't RMDir <b>[support the /REBOOTOK switch]</b>?"<br />
      <br />
      Doesn't that make a bit more sense? :)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br />
      <span class="post-time small text-muted">28th March 2003 22:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That is on the TODO list for the next beta version.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">RDaneel</span><br />
      <span class="post-time small text-muted">28th March 2003 22:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Sweeet! :D<br />
      <br />
      Then my uninstallers that need to do a delayed remove of an "in-use" DLL from my app directory could really get rid of everything!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">29th March 2003 11:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Was going to do it a couple of days ago and got caught up in another thing... Uploaded (source only).</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
