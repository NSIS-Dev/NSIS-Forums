<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Get # of cores AND logical processors" />

  <title>Get # of cores AND logical processors - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Get # of cores AND logical processors</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=321596">Get # of cores AND logical processors</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">redxii</span><br />
      <span class="post-time small text-muted">12th August 2010 08:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Get # of cores AND logical processors</strong><br />
      This is probably what I am looking for: <a href="http://msdn.microsoft.com/en-us/library/ms683194.aspx" target="_blank">http://msdn.microsoft.com/en-us/library/ms683194.aspx</a><br />
      <br />
      This is actually way over my head, I don't understand a damn thing about using System plug-in even after reading the readme. I want to get the number of cores when hyperthreading is involved. It should say I have 2 cores/processors and not 4.<br />
      <br />
      CPUDesc was last compiled in 2003, and it's not unicode.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">12th August 2010 09:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">(You can use the CallAnsiPlugin plug-in to execute ansi plugins on unicode NSIS.)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">redxii</span><br />
      <span class="post-time small text-muted">12th August 2010 18:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well, it also counts hyperthreading as a cpu.. even Atom processors are hyperthreaded.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">f0rt</span><br />
      <span class="post-time small text-muted">13th August 2010 17:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I took the challenge and came up with the following script.<br />
      <br />
      PHP Code:</p>
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">OutFile</span><span style="color: #DD0000">"cpuinfo.exe"<br />
      <br /></span> <span style="color: #007700">!include</span><span style="color: #DD0000">"LogicLib.nsh"<br />
      <br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">defineFALSE0<br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">defineTRUE1<br />
      <br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">defineERROR_INSUFFICIENT_BUFFER122<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">SizeofSYSTEM_LOGICAL_PROCESSOR_INFORMATIONon32</span><span style="color: #007700">-</span><span style="color: #0000BB">bitsystems<br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">defineSYS_LOG_PROC_INFO_SIZE24<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">OffsetofRelationshipintheSYSTEM_LOGICAL_PROCESSOR_INFORMATIONstructure<br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">defineRELATIONSHIP_OFFSET4<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">EnumvalueofRelationshipidentifyingProcessorCore<br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">defineRELATIONPROCESSORCORE0<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Countthenumberofbitssetingivenvalue<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Parameters</span><span style="color: #007700">:</span><span style="color: #0000BB">value<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Returns</span><span style="color: #007700">:</span><span style="color: #0000BB">numberofbitssetingivenvalue<br /></span> <span style="color: #007700">Function</span><span style="color: #0000BB">countbits<br />
      Exch</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Setinitialvalue</span><span style="color: #007700">for</span><span style="color: #0000BB">numberofbitssetin</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">10<br />
      <br /></span> <span style="color: #007700">${While}$</span><span style="color: #0000BB">0</span><span style="color: #007700">&gt;</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Clearleastsignificantbitset<br />
      IntOp</span><span style="color: #007700">$</span><span style="color: #0000BB">2</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">-</span><span style="color: #0000BB">1<br />
      IntOp</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">&amp;$</span><span style="color: #0000BB">2<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Incrementnumberofbitsset<br />
      IntOp</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #007700">+</span><span style="color: #0000BB">1<br /></span> <span style="color: #007700">${EndWhile}<br />
      <br />
      ;Return</span><span style="color: #0000BB">numberofbitsset<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      <br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Exch</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      FunctionEnd<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Evaluateprocessorinformation<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Paramaters</span><span style="color: #007700">:</span><span style="color: #0000BB">buffer</span><span style="color: #007700">,</span><span style="color: #0000BB">length<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Returns</span><span style="color: #007700">:</span><span style="color: #0000BB">numberofcores<br /></span> <span style="color: #007700">Function</span><span style="color: #0000BB">evalcpuinfo<br />
      Exch</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">;</span><span style="color: #0000BB">length<br />
      Exch<br />
      Exch</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #007700">;</span><span style="color: #0000BB">buffer<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">5</span><span style="color: #007700">;</span><span style="color: #0000BB">ProcessorCores<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">6</span><span style="color: #007700">;</span><span style="color: #0000BB">LogicalProcessors<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Setbufferoffsetattheendofthebuffer<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">2</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">InitializenumberofProcessorCores</span><span style="color: #007700">and</span><span style="color: #0000BB">LogicalProcessors<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">50<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">60<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Iteratethroughbufferstartingfromend<br /></span> <span style="color: #007700">${While}$</span><span style="color: #0000BB">2</span><span style="color: #007700">&gt;=${</span><span style="color: #0000BB">SYS_LOG_PROC_INFO_SIZE</span><span style="color: #007700">}<br />
      ;</span><span style="color: #0000BB">Calculatestartaddressofanelement<br />
      IntOp</span><span style="color: #007700">$</span><span style="color: #0000BB">2</span><span style="color: #007700">$</span><span style="color: #0000BB">2</span><span style="color: #007700">-${</span><span style="color: #0000BB">SYS_LOG_PROC_INFO_SIZE</span><span style="color: #007700">}<br /></span> <span style="color: #0000BB">IntOp</span><span style="color: #007700">$</span><span style="color: #0000BB">3</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #007700">+$</span><span style="color: #0000BB">2<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">GetProcessorMaskvaluefromelement<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"*$3(i.r4)"<br /></span> <span style="color: #0000BB">Push</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br />
      IntOp</span><span style="color: #007700">$</span><span style="color: #0000BB">3</span><span style="color: #007700">$</span><span style="color: #0000BB">3</span><span style="color: #007700">+${</span><span style="color: #0000BB">RELATIONSHIP_OFFSET</span><span style="color: #007700">}<br />
      ;</span><span style="color: #0000BB">GetRelationshipvaluefromelement<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"*$3(i.r4)"<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">4</span><span style="color: #007700">==${</span><span style="color: #0000BB">RELATIONPROCESSORCORE</span><span style="color: #007700">}<br />
      ;</span><span style="color: #0000BB">IncrementProcessorcores<br />
      IntOp</span><span style="color: #007700">$</span><span style="color: #0000BB">5</span><span style="color: #007700">$</span><span style="color: #0000BB">5</span><span style="color: #007700">+</span><span style="color: #0000BB">1<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">DeterminenumberofLogicalProcessorbycountingthebits<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">setinthevalueofProcessorMask<br />
      Callcountbits<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">SumupLogicalProcessors<br />
      IntOp</span><span style="color: #007700">$</span><span style="color: #0000BB">6</span><span style="color: #007700">$</span><span style="color: #0000BB">6</span><span style="color: #007700">+$</span><span style="color: #0000BB">4<br /></span> <span style="color: #007700">${Else}<br /></span> <span style="color: #0000BB">Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br /></span> <span style="color: #007700">${EndIf}<br />
      ${EndWhile}<br />
      <br />
      ;</span><span style="color: #0000BB">Setprocessorinformation</span><span style="color: #007700">asreturn</span><span style="color: #0000BB">value<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #DD0000">"ProcessorCore(s):$5LogicalProcessor(s):$6"<br />
      <br /></span> <span style="color: #0000BB">Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">6<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">5<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Exch</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      FunctionEnd<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Getprocessorinformation<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Returns</span><span style="color: #007700">:</span><span style="color: #0000BB">numberofProcessorCores</span><span style="color: #007700">and</span><span style="color: #0000BB">LogicalProcessors<br /></span> <span style="color: #007700">Function</span><span style="color: #0000BB">getcpuinfo<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">GetLogicalProcessorInformationisonlyavailableon<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">WindowsXPSP3</span><span style="color: #007700">or</span><span style="color: #0000BB">itssuccessors</span><span style="color: #007700">.<br />
      <br />
      ;</span><span style="color: #0000BB">Initializebuffer</span><span style="color: #007700">and</span><span style="color: #0000BB">itslength<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">10<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">20<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Determinerequiredlengthofbuffer<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"kernel32::GetLogicalProcessorInformation(ir1,*ir2r2)i.r3?e"<br /></span> <span style="color: #0000BB">Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">3</span><span style="color: #007700">==${</span><span style="color: #0000BB">FALSE</span><span style="color: #007700">}<br />
      ${If}$</span><span style="color: #0000BB">4</span><span style="color: #007700">==${</span><span style="color: #0000BB">ERROR_INSUFFICIENT_BUFFER</span><span style="color: #007700">}<br />
      ;</span><span style="color: #0000BB">Allocatebuffer<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Alloc</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">1</span><span style="color: #007700">!=</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Getprocessorinformation<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"kernel32::GetLogicalProcessorInformation(ir1,*ir2r2)i.r3?e"<br /></span> <span style="color: #0000BB">Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">3</span><span style="color: #007700">!=${</span><span style="color: #0000BB">TRUE</span><span style="color: #007700">}<br /></span> <span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #DD0000">"Error:$4"<br /></span> <span style="color: #007700">${Else}<br /></span> <span style="color: #0000BB">Push</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #007700">;</span><span style="color: #0000BB">buffer<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">2</span><span style="color: #007700">;</span><span style="color: #0000BB">length<br />
      Callevalcpuinfo<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">${EndIf}<br />
      ;</span><span style="color: #0000BB">Deallocatebuffer<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Free</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br /></span> <span style="color: #007700">${Else}<br /></span> <span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #DD0000">"Error:memoryallocationfailed!"<br /></span> <span style="color: #007700">${EndIf}<br />
      ${Else}<br /></span> <span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #DD0000">"Error:$4"<br /></span> <span style="color: #007700">${EndIf}<br />
      ${Else}<br /></span> <span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #DD0000">"GetLogicalProcessorInformationisnotavailableonyoursystem!"<br /></span> <span style="color: #007700">${EndIf}<br />
      <br /></span> <span style="color: #0000BB">Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Exch</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      FunctionEnd<br />
      <br /></span> <span style="color: #007700">Function.</span><span style="color: #0000BB">onInit<br />
      InitPluginsDir<br />
      Callgetcpuinfo<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      MessageBoxMB_OK</span><span style="color: #DD0000">"$0"<br /></span> <span style="color: #0000BB">Quit<br />
      FunctionEnd<br />
      <br />
      Section<br />
      SectionEnd<br /></span></span> <!-- php buffer end -->
      <hr />
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">redxii</span><br />
      <span class="post-time small text-muted">13th August 2010 20:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Works for me, 64-bit Win 7, reports 2 cores/4 logical . Anyone else want to test it out?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">redxii</span><br />
      <span class="post-time small text-muted">13th August 2010 23:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I tried on my AMD Turion X2 laptop and it reported correctly, and had someone test his and it reported correctly on his Core i7.<br />
      <br />
      You should wiki it since I am sure other people will find it of use.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">14th August 2010 08:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">"Processor core(s): 1 Logical Processor(s): 2" for my C2D E6750 on Windows Server 2003 SP2 (actual OS).<br />
      "GetLogicalProcessorInformation is not available on your system!" for same CPU on Windows 98 SE virtual machine.<br />
      "GetLogicalProcessorInformation is not available on your system!" for same CPU on Windows 2000 pro VM. (Is there an alternative here?)<br />
      "Processor core(s): 2 Logical Processor(s): 2" for same CPU on Windows Vista VM.<br />
      "Processor core(s): 2 Logical Processor(s): 2" for same CPU on Windows 7 pro x64 VM.<br />
      "Processor core(s): 2 Logical Processor(s): 2" for same CPU on Windows XP pro x64 VM.<br />
      <br />
      VMs are run on VMWare Workstation. Obviously there are still some kinks that need to be solved, but the help on the SYSTEM_LOGICAL_PROCESSOR_INFORMATION struct is rather confusing... If I'm reading it correctly, Windows Server 2003 and Windows XP Professional x64 Edition should both return the same thing. So maybe it's VMWare that's simulating the two C2D cores as two physical CPUs?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">redxii</span><br />
      <span class="post-time small text-muted">14th August 2010 08:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Using unicode anyway, Win 2000 users in this particular application is a very very small minority, the market share of Win 2000 isn't even half a percent. The particular program being packaged does not support 9x/ME/NT.<br />
      <br />
      Every system I tested had Win 7 64-bit.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
