<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="x64 license page problem"><title>x64 license page problem - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">x64 license page problem</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=262273">x64 license page problem</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">Takhir</span><br><span class="post-time small text-muted">22nd December 2006 12:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>x64 license page problem</strong><br>I am running setup on MS Windows Server 2003 Enterprise x64 Edition SP1, Dual Core AMD Opteron. Problem comes from .onInit syscall, but error situation appear later - on the license page only:</p><pre>
<code><br>!include "MUI.nsh" <br>!define INAME license<br><br>Name ${INAME} <br>OutFile ${INAME}.exe <br>InstallDir "$PROGRAMFILES\${INAME}"<br>BGGradient 000000 000080 FFFFFF<br><br>!insertmacro MUI_PAGE_WELCOME<br>!insertmacro MUI_PAGE_LICENSE license_en.txt<br>!insertmacro MUI_PAGE_INSTFILES<br><br>!insertmacro MUI_LANGUAGE English<br><br>Section "Dummy Section" SecDummy<br>SectionEnd<br><br>Function .onInit<br>  System::Call "kernel32::Wow64DisableWow64FsRedirection(*i)"<br>FunctionEnd</code>
</pre><br>
      With background gradient enabled I see image instead of license text (like on attached gif). If BG line commented unhandled exception occure, debug shows zero pointer. Temp dir created in the same place on all comps (user/local settings/temp). On 32 bits XP/2003 all is correct (just no dll entry point). Any short fix?
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">22nd December 2006 12:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Seems like that System call somehow runs over some memory it shouldn't touch. Does it work if you add an actual output value?</p>
      <pre>
<code>System::Call "kernel32::Wow64DisableWow64FsRedirection(*i.r0)"</code>
</pre>A quick fix would probably be using the macros in x64.nsh because they use Wow64EnableWow64FsRedirection.
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Takhir</span><br>
      <span class="post-time small text-muted">22nd December 2006 12:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>
      <pre>
<code>System::Call "kernel32::Wow64DisableWow64FsRedirection(*i.r0)"</code>
</pre>not works :( (exception without BG gradient)<br>
      The same with
      <pre>
<code>!insertmacro DisableX64FSRedirection<br></code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">22nd December 2006 13:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Doesn't the gradient window show at all? Does it only show inside the license box?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">22nd December 2006 13:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Does $TEMP change before and after the redirection changes?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Takhir</span><br>
      <span class="post-time small text-muted">22nd December 2006 13:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">$TEMP not changes: e:\docume~1\admini~1\locals~1\temp\2, just created tmp folder nsm4.tmp appear under it. Temporary files present in folder (installoptions.dll, system.dll, iospecial.ini, modern-wizard.bmp).<br>
      License window repeats top level corner of (presenting) background gradient.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">22nd December 2006 15:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What happens if you use a plug-in that disables the redirection instead of using the System plug-in? I'm a bit in the dark here, because I don't have x64 Windows to test on. Maybe it's because LoadLibrary is fooled by the disabled redirection. RichEd20.dll is used right after .onInit is called.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Takhir</span><br>
      <span class="post-time small text-muted">25th December 2006 08:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Yes, looks like wrong dll... Moving 'disable' to .onguiinit or section solves the problem. 'disable' in .oninit and then 'enable' in the same function (after environment check) also works. Thanks :)</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>