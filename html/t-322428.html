<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="makensis / logiclib crash"><title>makensis / logiclib crash - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">makensis / logiclib crash</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=322428">makensis / logiclib crash</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">Marshall7a</span><br><span class="post-time small text-muted">15th September 2010 13:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>makensis / logiclib crash</strong><br>The compiler (standard build) is crashing for me when it reaches a For loop:<br><br>${Explode} $R0 "," `$R4`<br>${For} $R1 1 $R0<br>Pop $R5<br><br>I set LOGICLIB_VERBOSITY to 4 and the compiler output is:<br>!insertmacro: end of Explode<br>!insertmacro: _For<br>!insertmacro: _ForEach<br>StrCpy $R1 "1" () ()<br>Goto: +2<br>!define: "_DoLoopExpression"="IntOp "$R1" "$R1" "+" "1""<br>!define: "_o=+"=""<br>!define: "__o"="&gt;"<br>!undef: "_o=+"<br>!insertmacro: _Do<br>!insertmacro: _PushLogic<br>!insertmacro: _PushScope<br>at this point MAKENSIS.EXE stops responding and gives the standard Windows dialog.<br><br>I tried adding an echo to _PushScope and found that we don't even compile the first line of that macro.<br>The values passed from _PushLogic to _PushScope are:<br>Logic<br>_LogicLib_Label_311<br><br>The for loop I've added is the same as many others that I already had in my script that are working fine.<br>I cannot see any reason for the compiler to crash...<br><br>Does anyone have any insight? My first thought is why doesn't the compiler report an error if there is one, so looks like compiler can't handle something, but the values passed to the macro look just fine...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Marshall7a</span><br><span class="post-time small text-muted">16th September 2010 10:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">It appears to have something to do with the amount of code / number of defines / number of includes I am using. I have 1 section included three times and that gives me the problem, but if I only include the section twice then the problem goes away.<br><br>I have searched for NSIS limits but found nothing...<br><br>Found that removing all the runtime code from the section caused the problem to move to an If statement in another macro. So there is definitely something up with a limit somewhere - maximum number of macro arg defines possibly? Can anyone shed any light on this?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Marshall7a</span><br><span class="post-time small text-muted">16th September 2010 13:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Is there perhaps a debug version of makensis that I can use to find out what is causing the error?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Marshall7a</span><br><span class="post-time small text-muted">16th September 2010 14:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I've tried attaching a debugger to this but can't really see what's going on.<br><br>Call stack of main thread<br>Address Stack Procedure / arguments Called from Frame<br>000409FC 00423B83 ? makensis.0044F8C0 makensis.00423B7E<br>00040A14 00422CE9 ? makensis.00423B60 makensis.00422CE4<br>00040A88 004239E0 ? makensis.00422650 makensis.004239DB<br>00040A8C 017B4501 Arg1 = 017B4501<br>00040AEC 00424236 ? makensis.004238D0 makensis.00424231<br>00040AF0 01675DD9 Arg1 = 01675DD9 ASCII " !define _${Type} ${label}<br>00040AF4 00000000 Arg2 = 00000000<br>00040AF8 00000000 Arg3 = 00000000<br><br>!define _${Type} ${label} looks suspicious, as that line is inside the macro but we haven't compiled the first line of the macro yet - otherwise my !echo should have been displayed. So I'm guessing the script is buffered (?)<br><br>My colleague tells me the failing instruction is<br>0044F8D7 |. 8501 |TEST DWORD PTR DS:[ECX],EAX<br>because ECX is not pointing to accessible memory (ECX=00032A00, EAX=00001630). So definitely something going wrong in makensis.<br><br>If I add an ${If} immediately before the ${For} , the error still occurs in the ${For}, but if I add a ${For} then the error occurs in that ${For} instead.<br><br>I am at a loss as to how to proceed with this, please someone help!</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">16th September 2010 14:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I've been trying to get a hold of kichik for you, but he hasn't been online yet. Please stand by, one of the devs will reply soon enough.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Marshall7a</span><br><span class="post-time small text-muted">16th September 2010 15:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks MSG, in the meantime.... I have replicated the problem using a tiny script!<br><br>====MAIN SCRIPT====<br>!include LogicLib.nsh<br>OutFile "NESTTEST.EXE"<br>InstallDir $DESKTOP\Example1<br>RequestExecutionLevel user<br>ShowInstDetails show<br>Page components<br>Page instfiles<br>Section "nested includes test" NESTTEST<br>!define FILENUM "0"<br>!include "file1.nsh"<br>SectionEnd<br><br>====FILE1.NSH====<br>!ifdef _FILENUM<br>!undef _FILENUM<br>!endif<br>!define /math _FILENUM ${FILENUM} + 1<br>!echo `I am include number ${_FILENUM}`<br>!undef FILENUM<br>!define FILENUM ${_FILENUM}<br>${For} $R0 1 5<br>${Next}<br>!include "file1.nsh"<br><br><br>Last 4 lines of compiler output (before the crash) are:<br>I am include number 8 (file1.nsh:5)<br>!undef: "FILENUM"<br>!define: "FILENUM"="8"<br>!insertmacro: _For<br><br>So there appears to be a problem with the number of nested includes combined with LogicLib!<br>Now, !include doesn't appear to have a problem going beyond 8 nested levels normally, so I suspect something in the LogicLib magic is causing trouble...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">16th September 2010 17:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You've got infinite recursion going on here. How can you expect it not to crash? You haven't put in a condition to stop it infinitely including file1.nsh...<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Marshall7a</span><br><span class="post-time small text-muted">16th September 2010 17:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">That was just to show the example. Using this instead:<br><br>====FILE1.NSH====<br>!ifdef _FILENUM<br>!undef _FILENUM<br>!endif<br>!define /math _FILENUM ${FILENUM} + 1<br>!echo `I am include number ${_FILENUM}`<br>!undef FILENUM<br>!define FILENUM ${_FILENUM}<br>${For} $R0 1 5<br>${Next}<br><br>!if ${FILENUM} &lt; 16<br>!include "file1.nsh"<br>!endif<br><br>...still crashes when filenum is 8.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">16th September 2010 17:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I guess NSIS is limited to that many recursive includes. Have you tried using a recursive insertmacro rather than a recursive file include?<br><br>Edit: Actually I doubt that will work.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Marshall7a</span><br><span class="post-time small text-muted">16th September 2010 17:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">If I comment out the ${For} and ${Next} lines, the compiler tells me this:<br><br>I am include number 10 (file1.nsh:5)<br>!undef: "FILENUM"<br>!define: "FILENUM"="10"<br>!include: "file1.nsh"<br>parseScript: too many levels of includes (10 max).<br><br>So even though the limit is 10 there is a bug with LogicLib at 8 levels.<br><br>Recursive insertmacro doesn't work either:<br>!insertmacro: macro "recurse" already being inserted!<br><br>This means there is no way to do any kind of compile-time looping which is very restrictive.<br><br>1. Bug with include/LogicLib definitely needs fixing because that could be down to something more serious.<br>2. Pretty pretty please remove the 10-level nested include limit. Unlimited if possible, increased to at least 32 if there has to be a limit... That or allow recursive macro-inserts.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">DrO</span><br><span class="post-time small text-muted">16th September 2010 18:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">the main issue with increasing the recursion limit is that makensis is more likely to run out of stack space and crash (is probably why the limit was introduced in the first place) unless you take the source code and modify it as a custom version for your own usage.<br><br>-daz</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">16th September 2010 18:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">LogicLib crashing the installer before the recursion limit is reached should definitely be fixed, though. Has someone filed a bug report yet?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">DrO</span><br><span class="post-time small text-muted">16th September 2010 18:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">i don't disagree that it shouldn't be crashing, just any high level of recursion needs to be considered for stack overflows / heap exhaustion. i doubt anyone has logged it so well volunteered :)<br><br>-daz</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Animaether</span><br><span class="post-time small text-muted">16th September 2010 20:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">question is whether it's actually LogicLib crashing things, though. I peeked at this earlier and added Echos for every step in the _For macro. It got all the way up to `!echo "!verbose LOGICLIB_VERBOSITY"`, but crashed at that point. Commenting out that !verbose line just shifted the crash to the next command line, the ${ForEach}.<br><br>LogicLib doesn't do anything funny there as far as I can tell - just looks like the given example exposes the underlying issue.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Marshall7a</span><br><span class="post-time small text-muted">16th September 2010 21:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I have logged a bug report for the crash and a feature request for extending the recursive options.</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>