<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Vista + Auto launch app - Part 2" />

  <title>Vista + Auto launch app - Part 2 - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Vista + Auto launch app - Part 2</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=270529">Vista + Auto launch app - Part 2</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">helix400</span><br />
      <span class="post-time small text-muted">2nd May 2007 22:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Vista + Auto launch app - Part 2</strong><br />
      This is a followup to see if anyone has found a clean solution to have an NSIS installer running as administrator launch an .exe as a non-admin user.<br />
      <br />
      The previous thread was here: <a href="http://forums.winamp.com/showthread.php?postid=2081977" target="_blank">Vista + Run App On Install</a><br />
      <br />
      It also linked to a helpful MSDN forum, here: <a href="http://forums.microsoft.com/MSDN/ShowPost.aspx?PostID=422705&amp;SiteID=1" target="_blank">How to CreateProcess NOT as administrator</a><br />
      <br />
      Both threads seem to conclude that there wasn't a clean solution. The best solution (but still really ugly), is to make a wrapper NSIS installer. That wrapper first launches as a normal user and installs the main installer, then launches that main installer (which will request and install as administrator), and when the main installer is finished, the wrapper launches your application.<br />
      <br />
      Ya, I could do that, but it feels like such an ugly hack. I'd really like to avoid making two NSIS installers to make it act like one should. Has anyone found any cleaner method?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">2nd May 2007 23:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I created a plugin for this, it's still a work in progress but you can check it out: <a href="http://forums.winamp.com/showthread.php?s=&amp;threadid=265780" target="_blank">http://forums.winamp.com/showthread....hreadid=265780</a></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">helix400</span><br />
      <span class="post-time small text-muted">4th May 2007 00:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Anders,<br />
      <br />
      Thanks for the plugin. I'm grateful that others are putting in the effort to give us a cleaner solution. I've been playing with it, and looking over the demos.<br />
      <br />
      However, I'm baffled on how to make it work in my situation. I hate to ask for step by step help, but I just can't wrap my head around what's going on with the plugin, so I don't know where to begin.<br />
      <br />
      Again, the scenario I'm seeing is this:<br />
      1) An installer will almost certainly be run in Vista as Administrator.<br />
      2) It will auto launch our app.<br />
      3) I need the app auto launched so it's not administrator.<br />
      <br />
      What do I need to do with the plugin to accomplish steps 2 and 3?<br />
      <br />
      <b>Edit:</b> Nevermind for now. I wasn't checking my end correctly. I'm really optimistic now...hoepfully the rest of my tests will do well.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">helix400</span><br />
      <span class="post-time small text-muted">4th May 2007 02:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Nevermind, I can't figure it out.<br />
      <br />
      All of the demos are set to RequestExecutionLevel user.<br />
      <br />
      But in my installer, I need admin access to write to the Program Files folder. Then I need to launch the application as the normal user. So I'm still stuck :(</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">4th May 2007 13:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You can also use <a href="http://www.tweak-uac.com/programming/vista-elevator2/" target="_blank">VistaElevator</a>. Download the compiled executables and copy over VE32.dll. Then use the System plug-in to call it.</p>
      <pre>
<code>StrCpy $R0 "$INSTDIR\program.exe" # program path<br />StrCpy $R1 "parmaters"            # parameters<br />StrCpy $R2 "$INSTDIR"             # working directory<br /><br />InitPluginsDir<br /><br />StrCpy $0 $PLUGINSDIR\ve32.dll<br />StrCpy $1 ?RunNonElevated@@YAHPAUHWND__@@PB_W11@Z<br /><br />File /oname=$0 ve32.dll<br /><br />System::Call 'kernel32::LoadLibrary(tr0)i.s'<br />System::Call 'kernel32::GetProcAddress(is,tr1)i.r1'<br />System::Call '::$1(i $HWNDPARENT, wR0, wR1, wR2)'</code>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">4th May 2007 14:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">RequestExecutionLevel is set to user so the "outer" instance will run as the current user, this is the whole point of the plugin</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">helix400</span><br />
      <span class="post-time small text-muted">5th May 2007 21:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Yay!<br />
      <br />
      I got it to work. It seems I was just not understanding how it worked. So here's what I can figure out so far. If I'm wrong, please correct me. :)<br />
      <br />
      1) Set RequestExecutionLevel to be user. The UAC plugin will eventually make two processes, one as a user, and one it will elevate itself to admin.<br />
      2) Just copy the .onInit function as found in most of the examples given in the plugin. That I believe elevates the visible window as be administrator, as well as checking early if it can even get adminstrator rights before continuing.<br />
      3) Anything you want done as user mode you do with the UAC plugin. For example, if I do the previous steps, UAC::Exec launches an application with user privileges.<br />
      4) Make sure the UAC plugin is unloaded before the application closes.<br />
      <br />
      One problem I did notice is that my Installer Window ended up going behind the topmost window. For example, if I had an explorer window open, and I double clicked on my NSIS .exe, the Vista UAC dialog would come up of course, and then afterwards, the Intaller Window would appear *behind* the explorer window. Is there anything I can do about that?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">6th May 2007 15:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">you can try calling SetForegroundWindow $HWNDPARENT with the system plugin in .OnGuiInit, but generally, the OS tries to stop other apps stealing focus.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">helix400</span><br />
      <span class="post-time small text-muted">7th May 2007 19:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Anders,<br />
      <br />
      I really appreciate your help. This plugin will probably be good enough for us to use.<br />
      <br />
      Though I am trying to figure how to get the window up front. I'm going to start another thread on that. It's weird, if I have, say, 5 windows open, the NSIS window doesn't go to the back of all 5, just behind the active window. And my SetForegroundWindow doesn't seem to be working either. Anyways, thanks again for the plugin.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Nihad</span><br />
      <span class="post-time small text-muted">9th May 2007 21:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Make installer window topmost</strong><br />
      in function .onGUIInit add:<br />
      <br />
      <br /></p>
      <pre>
<code><br />System::Call "*${stRECT} .r1"<br />System::Call "User32::GetWindowRect(i, i) i ($HWNDPARENT, r1) .r2"<br />System::Call "*$1${stRECT} (.r2, .r3, .r4, .r5)"<br />IntOp $6 $4 - $2 ; $2 now contains the width<br />IntOp $7 $5 - $3 ; $3 now contains the height<br /><br />System::Call 'user32::GetSystemMetrics(i 0) i .r0'<br />System::Call 'user32::GetSystemMetrics(i 1) i .r1'<br /><br />IntOp $2 $0 - $6<br />IntOp $3 $1 - $7<br />IntOp $4 $2 / 2<br />IntOp $5 $3 / 2<br /><br />System::Call "User32::SetWindowPos(i, i, i, i, i, i, i) b ($HWNDPARENT, -1, $4, $5, 0, 0, 0x201)"<br /></code>
</pre><br />
      <br />
      I hope this helps you.<br />
      <br />
      Thanks,
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">helix400</span><br />
      <span class="post-time small text-muted">9th May 2007 21:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks!<br />
      <br />
      I haven't been able to test this. I mainly needed it to work around something in the UAC plugin. But Anders made a change in the plugin so I no longer have to worry about it.<br />
      <br />
      But hopefully your code will come in handy for anyone else needing this.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">M-Force</span><br />
      <span class="post-time small text-muted">6th March 2008 15:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>RunNonElevated on Vista does not work properly</strong><br />
      Hi Kichik,<br />
      <br />
      You suggested earlier in this thread (05-04-2007 12:44 PM) a certain way how to launch an application in vista from the installer.<br />
      <br />
      You wrote "You can also use VistaElevator. Download the compiled executables and copy over VE32.dll..."<br />
      <br />
      I have tried this by including VE32.dll and calling the function RunNonElevated in order to start my application out of the installer.<br />
      It works fine with a Vista administrator user account and the application starts with a â€œmediumâ€ integrity level (process explorer) as expected.<br />
      But when i try to run the same installer with a Vista standard user account the application wonâ€™t be started at all.<br />
      <br />
      Do you or anybody else have any experience with this behavior and might also know what the problem is?<br />
      <br />
      <br />
      Thank you very much for your help.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">6th March 2008 16:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">It probably uses the task scheduler or something hacky like that</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
