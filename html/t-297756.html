<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Issues while validating license key online via installer" />

  <title>Issues while validating license key online via installer - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Issues while validating license key online via installer</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=297756">Issues while validating license key online via installer</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">pankajch82</span><br />
      <span class="post-time small text-muted">23rd September 2008 16:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Issues while validating license key online via installer</strong><br />
      HI , Have attached the script ...when i enter the correct key , it still shows Invalid key .<br />
      <br />
      URL :<a href="http://pnilyaoverseas.com/pankaj/test.php?test=aaaaa-aaaaa-aaaaa-aaaaa-aaaaa" target="_blank">http://pnilyaoverseas.com/pankaj/tes...aa-aaaaa-aaaaa</a><br />
      <br />
      SO correct key :aaaaa-aaaaa-aaaaa-aaaaa-aaaaa<br />
      <br />
      Regards<br />
      Pankaj</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">pankajch82</span><br />
      <span class="post-time small text-muted">23rd September 2008 16:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>correct file</strong><br />
      Sorry attached the wrong file , find the correct one.<br />
      <br />
      Thanks</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Animaether</span><br />
      <span class="post-time small text-muted">23rd September 2008 20:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You may wish to check your PHP code. The file that gets downloaded reads 'INVALID', itself.<br />
      <br />
      P.S. you've got a typo.. slient -&gt; silent</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">pankajch82</span><br />
      <span class="post-time small text-muted">24th September 2008 10:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Attaching the php too .<br />
      <br />
      But when i try from browser it returns "VALID"</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Animaether</span><br />
      <span class="post-time small text-muted">24th September 2008 13:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">try adding the value that the PHP appears to get ($_GET['test']) to the output, or use one of the PHP debug print statements.. I don't have a PHP server up and running anywhere, but I'm guessing that it's not getting what you think it's getting from the POST command</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">dandaman32</span><br />
      <span class="post-time small text-muted">24th September 2008 14:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Here's what you'd want to do:<br />
      <br />
      First of all, good thing you're taking measures to prevent SQL injection. However there's a much easier way to go about it:<br />
      <br />
      PHP Code:</p>
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br />
      define</span><span style="color: #007700">(</span><span style="color: #DD0000">'HOSTNAME'</span><span style="color: #007700">,</span><span style="color: #DD0000">'localhost'</span><span style="color: #007700">);<br /></span> <span style="color: #0000BB">define</span><span style="color: #007700">(</span><span style="color: #DD0000">'USERNAME'</span><span style="color: #007700">,</span><span style="color: #DD0000">'indiamm_test'</span><span style="color: #007700">);<br /></span> <span style="color: #0000BB">define</span><span style="color: #007700">(</span><span style="color: #DD0000">'PASSWORD'</span><span style="color: #007700">,</span><span style="color: #DD0000">'test'</span><span style="color: #007700">);<br /></span> <span style="color: #0000BB">define</span><span style="color: #007700">(</span><span style="color: #DD0000">'DATABASE_NAME'</span><span style="color: #007700">,</span><span style="color: #DD0000">'indiamm_pankaj'</span><span style="color: #007700">);<br /></span> <span style="color: #0000BB">define</span><span style="color: #007700">(</span><span style="color: #DD0000">'RESPONSE_KEY'</span><span style="color: #007700">,</span><span style="color: #DD0000">'4PdUAoeGZ9Tq*1bpI***93;Le4P!{MsXUtqzR***93;p!T%++xf2&amp;wbb4ISe7jGoIAQAusMw,j'</span><span style="color: #007700">);<br />
      <br /></span> <span style="color: #0000BB">$db</span><span style="color: #007700">=</span><span style="color: #0000BB">mysql_connect</span><span style="color: #007700">(</span><span style="color: #0000BB">HOSTNAME</span><span style="color: #007700">,</span><span style="color: #0000BB">USERNAME</span><span style="color: #007700">,</span><span style="color: #0000BB">PASSWORD</span><span style="color: #007700">)ORdie(</span><span style="color: #DD0000">'IcannotconnecttoMySQL.'</span><span style="color: #007700">);<br />
      if(!</span><span style="color: #0000BB">mysql_select_db</span><span style="color: #007700">(</span><span style="color: #0000BB">DATABASE_NAME</span><span style="color: #007700">))<br />
      {<br />
      die(</span><span style="color: #DD0000">'Unabletoselectdatabase.'</span><span style="color: #007700">);<br />
      }<br />
      <br /></span> <span style="color: #0000BB">$key</span><span style="color: #007700">=(isset(</span><span style="color: #0000BB">$_GET</span><span style="color: #007700">***91;</span><span style="color: #DD0000">'key'</span><span style="color: #007700">***93;))?</span><span style="color: #0000BB">mysql_real_escape_string</span><span style="color: #007700">(</span><span style="color: #0000BB">$_GET</span><span style="color: #007700">***91;</span><span style="color: #DD0000">'key'</span><span style="color: #007700">***93;):</span><span style="color: #DD0000">''</span><span style="color: #007700">;<br />
      if(empty(</span><span style="color: #0000BB">$key</span><span style="color: #007700">))<br />
      die(</span><span style="color: #DD0000">'INVALID'</span><span style="color: #007700">);<br />
      <br /></span> <span style="color: #0000BB">$result</span><span style="color: #007700">=</span><span style="color: #0000BB">mysql_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECTstatusFROMkeyWHEREid='$key';"</span><span style="color: #007700">);<br />
      if(!</span><span style="color: #0000BB">$result</span><span style="color: #007700">)<br />
      {<br />
      die(</span><span style="color: #DD0000">'INVALID'</span><span style="color: #007700">);<br />
      }<br />
      <br /></span> <span style="color: #FF8000">//checkifrecordswerereturned<br /></span> <span style="color: #007700">if(</span><span style="color: #0000BB">mysql_num_rows</span><span style="color: #007700">(</span><span style="color: #0000BB">$result</span><span style="color: #007700">)&gt;</span><span style="color: #0000BB">0</span><span style="color: #007700">)<br />
      {<br /></span> <span style="color: #FF8000">//thishashwillbeuniqueamongallinstallers.<br /></span> <span style="color: #0000BB">$hash</span><span style="color: #007700">=</span><span style="color: #0000BB">md5</span><span style="color: #007700">(</span><span style="color: #0000BB">$_GET</span><span style="color: #007700">***91;</span><span style="color: #DD0000">'test'</span><span style="color: #007700">***93;.</span><span style="color: #0000BB">RESPONSE_KEY</span><span style="color: #007700">);<br />
      echo&lt;&lt;&lt;EOF<br /></span> <span style="color: #0000BB">***91;result***93;<br />
      status=valid<br />
      hash=$hash<br /></span> <span style="color: #007700">EOF;<br />
      }<br />
      else<br />
      {<br />
      echo&lt;&lt;&lt;EOF<br /></span> <span style="color: #0000BB">***91;result***93;<br />
      status=invalid<br />
      hash=<br /></span> <span style="color: #007700">EOF;<br />
      }<br />
      @</span><span style="color: #0000BB">mysql_free_result</span><span style="color: #007700">(</span><span style="color: #0000BB">$result</span><span style="color: #007700">);<br />
      <br /></span> <span style="color: #0000BB">mysql_close</span><span style="color: #007700">(</span><span style="color: #0000BB">$db</span><span style="color: #007700">);<br />
      <br /></span> <span style="color: #0000BB">?&gt;</span></span> <!-- php buffer end -->
      <hr />
      I should warn you that simply fetching a URI is a highly un-trustworthy operation. It would be trivial for someone to fuss around with their hosts file and point the installer to a different license server through DNS spoofing. If you hardcode the IP address, that can still be changed by working with the host computer's routing tables. The only way to ensure a secure response is to use a primitive sort of digital signature to ensure that the response came from a trusted server.<br />
      <br />
      <b>Warning: reverse-engineering of the installer can still crack this!</b> I use a very similar scheme for some of my projects.<br />
      <br />
      The way you would do this is by echoing back a hash that was created from the key (ensuring that each response is unique) and also contains a (hashed) unique, global key shared among your license validation script and all your installers. A sample is shown above. Here's how you would go about validating this with NSIS:<br />
      <br />
      PHP Code:
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #007700">!</span><span style="color: #0000BB">defineRESPONSE_KEY</span><span style="color: #DD0000">'4PdUAoeGZ9Tq*1bpI***93;Le4P!{MsXUtqzR***93;p!T%++xf2&amp;wbb4ISe7jGoIAQAusMw,j'<br />
      <br /></span> <span style="color: #007700">Function</span><span style="color: #0000BB">ValidateLicense<br />
      Exch</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br />
      GetTempFileName</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      nsisdl</span><span style="color: #007700">::</span><span style="color: #0000BB">download_quiet</span><span style="color: #DD0000">"http://yoursite.com/checklicense.php?key=$0"</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      ReadINIStr</span><span style="color: #007700">$</span><span style="color: #0000BB">2</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #DD0000">"result""status"<br /></span> <span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">4</span><span style="color: #DD0000">"invalid"<br /></span> <span style="color: #0000BB">StrCmp</span><span style="color: #007700">$</span><span style="color: #0000BB">2</span><span style="color: #DD0000">"valid"""</span><span style="color: #0000BB">done<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">remoteserverclaimsthekeyisvalid<br /></span> <span style="color: #007700">;$</span><span style="color: #0000BB">2</span><span style="color: #007700">=</span><span style="color: #0000BB">hashfromserver</span><span style="color: #007700">-</span><span style="color: #0000BB">untrusted<br />
      ReadINIStr</span><span style="color: #007700">$</span><span style="color: #0000BB">2</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #DD0000">"result""hash"<br /></span> <span style="color: #007700">;$</span><span style="color: #0000BB">3</span><span style="color: #007700">=</span><span style="color: #0000BB">thecorrecthash<br />
      DCryptDll</span><span style="color: #007700">::</span><span style="color: #0000BB">MD5Hash</span><span style="color: #DD0000">"SS""$0${RESPONSE_KEY}""--End--"<br /></span> <span style="color: #0000BB">Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">makesureDCryptDlldidnterrorout<br />
      StrCmp</span><span style="color: #007700">$</span><span style="color: #0000BB">3</span><span style="color: #DD0000">"OK"""</span><span style="color: #0000BB">done<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      StrCmp</span><span style="color: #007700">$</span><span style="color: #0000BB">2</span><span style="color: #007700">$</span><span style="color: #0000BB">3</span><span style="color: #DD0000">""</span><span style="color: #0000BB">done<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">hashisvalid<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">4</span><span style="color: #DD0000">"valid"<br /></span> <span style="color: #0000BB">done</span><span style="color: #007700">:<br /></span> <span style="color: #0000BB">Delete</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Exch</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      FunctionEnd<br /></span></span> <!-- php buffer end -->
      <hr />
      This is untested code as I'm currently on a Linux system and lack the resources to test, but I believe it should work. Hopefully this will give you an idea of how a server's response can be fully authenticated.<br />
      <br />
      --Dan
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
