<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Issues while validating license key online via installer"><title>Issues while validating license key online via installer - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Issues while validating license key online via installer</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=297756">Issues while validating license key online via installer</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">pankajch82</span><br><span class="post-time small text-muted">23rd September 2008 16:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Issues while validating license key online via installer</strong><br>&nbsp; HI , Have attached the script ...when i enter the correct key , it still shows Invalid key .<br><br>URL :<a href="http://pnilyaoverseas.com/pankaj/test.php?test=aaaaa-aaaaa-aaaaa-aaaaa-aaaaa" target="_blank">http://pnilyaoverseas.com/pankaj/tes...aa-aaaaa-aaaaa</a><br><br>SO correct key :aaaaa-aaaaa-aaaaa-aaaaa-aaaaa<br><br>Regards<br>Pankaj</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pankajch82</span><br><span class="post-time small text-muted">23rd September 2008 16:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>correct file</strong><br>&nbsp; Sorry attached the wrong file , find the correct one.<br><br>Thanks</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Animaether</span><br><span class="post-time small text-muted">23rd September 2008 20:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You may wish to check your PHP code. The file that gets downloaded reads 'INVALID', itself.<br><br>P.S. you've got a typo.. slient -&gt; silent</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pankajch82</span><br><span class="post-time small text-muted">24th September 2008 10:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Attaching the php too .<br><br>But when i try from browser it returns "VALID"</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Animaether</span><br><span class="post-time small text-muted">24th September 2008 13:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">try adding the value that the PHP appears to get ($_GET['test']) to the output, or use one of the PHP debug print statements.. I don't have a PHP server up and running anywhere, but I'm guessing that it's not getting what you think it's getting from the POST command</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">dandaman32</span><br><span class="post-time small text-muted">24th September 2008 14:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Here's what you'd want to do:<br><br>First of all, good thing you're taking measures to prevent SQL injection. However there's a much easier way to go about it:<br><br></p><pre>
<code>
&lt;?php
<br>define</code>('HOSTNAME', 'localhost');
<br>&gt;define('USERNAME', 'indiamm_test');
<br>&gt;define('PASSWORD', 'test');
<br>&gt;define('DATABASE_NAME', 'indiamm_pankaj');
<br>&gt;define('RESPONSE_KEY', '4PdUAoeGZ9Tq*1bpI***93;Le4P!{MsXUtqzR***93;p!T%++xf2&amp;wbb4ISe7jGoIAQAusMw,j');
<br><br>&gt;$db = mysql_connect(HOSTNAME, USERNAME, PASSWORD) OR die ('I cannot connect to MySQL.');
<br>if ( !mysql_select_db(DATABASE_NAME) )
<br>{
<br>  die('Unable to select database.');
<br>}
<br><br>&gt;$key = ( isset($_GET***91;'key'***93;) ) ? mysql_real_escape_string($_GET***91;'key'***93;) : '';
<br>if ( empty($key) )
<br>  die('INVALID');
<br><br>&gt;$result = mysql_query("SELECT status FROM key WHERE id = '$key';");
<br>if ( !$result )
<br>{
<br>  die('INVALID');
<br>}
<br><br>&gt;// check if records were returned
<br>&gt;if ( mysql_num_rows($result) &gt; 0 )
<br>{
<br>  // this hash will be unique among all installers.
<br> $hash = md5($_GET***91;'test'***93; . RESPONSE_KEY);
<br>  echo &lt;&lt;&lt;EOF
<br>&gt;***91;result***93;
<br>status=valid
<br>hash=$hash
<br>&gt;EOF;
<br>}
<br>else
<br>{
<br>  echo &lt;&lt;&lt;EOF
<br>&gt;***91;result***93;
<br>status=invalid
<br>hash=
<br>&gt;EOF;
<br>}
<br>@mysql_free_result($result);
<br><br>&gt;mysql_close($db);
<br><br>&gt;?&gt;

</pre>I should warn you that simply fetching a URI is a highly un-trustworthy operation. It would be trivial for someone to fuss around with their hosts file and point the installer to a different license server through DNS spoofing. If you hardcode the IP address, that can still be changed by working with the host computer's routing tables. The only way to ensure a secure response is to use a primitive sort of digital signature to ensure that the response came from a trusted server.<br>
      <br>
      <b>Warning: reverse-engineering of the installer can still crack this!</b> I use a very similar scheme for some of my projects.<br>
      <br>
      The way you would do this is by echoing back a hash that was created from the key (ensuring that each response is unique) and also contains a (hashed) unique, global key shared among your license validation script and all your installers. A sample is shown above. Here's how you would go about validating this with NSIS:<br>
      <br>
      <pre>
<code>
'4PdUAoeGZ9Tq*1bpI***93;Le4P!{MsXUtqzR***93;p!T%++xf2&amp;wbb4ISe7jGoIAQAusMw,j'
<br><br>&gt;Function ValidateLicense
<br>  Exch$0
<br>  Push$1
<br>  Push$2
<br>  Push$3
<br>  Push$4
<br>  GetTempFileName$1
<br>  nsisdl</code>::download_quiet "http://yoursite.com/checklicense.php?key=$0" $1
<br>  ReadINIStr$2 $1 "result" "status"
<br> StrCpy $4 "invalid"
<br> StrCmp $2 "valid" "" done
<br>   ; remote server claims the key is valid
<br>   ; $2 = hash from server - untrusted
<br>    ReadINIStr$2 $1 "result" "hash"
<br>   ; $3 = the correct hash
<br>    DCryptDll::MD5Hash "SS" "$0${RESPONSE_KEY}" "--End--"
<br>   Pop $3
<br>   ; make sure DCryptDll didnt error out
<br>    StrCmp$3 "OK" "" done
<br>    Pop$3
<br>    StrCmp$2 $3 "" done
<br>     ; hash is valid
<br>      StrCpy$4 "valid"
<br> done:
<br> Delete $1
<br>  Pop$4
<br>  Pop$3
<br>  Pop$2
<br>  Pop$1
<br>  Exch$0
<br>FunctionEnd 
<br>&gt;

</pre>This is untested code as I'm currently on a Linux system and lack the resources to test, but I believe it should work. Hopefully this will give you an idea of how a server's response can be fully authenticated.<br>
      <br>
      --Dan
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>