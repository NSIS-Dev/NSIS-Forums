<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Inserting line halfway down an INI"><title>Inserting line halfway down an INI - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Inserting line halfway down an INI</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=301141">Inserting line halfway down an INI</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">miguez</span><br><span class="post-time small text-muted">17th December 2008 04:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Inserting line halfway down an INI</strong><br>First post.<br><br>I've done searches here and in the wiki, and asked questions (to no avail) in the IRC.<br><br>First off, NSIS rocks! I've been at it for a week now and I really like the scripting language, very simple yet powerful.<br><br>My installer needs to open an existing INI file, search for a section, then add a new section immediately after that. That means that everything else that already existed after the section I search for should be shifted down to make room for this new section.<br><br>By using WriteINIStr I can add my section, but it shows at the end of the INI file.<br><br>By using FileWrite I can add it where I want the section to be, but it overwrites the existing text from that point on.<br><br>Can anyone help me with this?<br><br>Thanks,</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Comperio</span><br><span class="post-time small text-muted">17th December 2008 05:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">An INI file doesn't have to be in any particular order since any INI file parser will find the proper section no matter where it lies in the file.<br><br>But, if you want to force it that way, here's a rough outline of what you might do:</p><ol style="list-style-type: decimal"><li>Make copy of the file. (Use $PLUGINSDIR for this)</li><li>open the copy as read-only; open the real file in either append or write mode.</li><li>Read the copy and write to the real file line by line until you get to the point where you want to insert your section.</li><li>Write your new section to the file.</li><li>Continue then reading from the copy and writing to the real file.</li><li>Close both files and delete your copy.</li></ol>(All you really need to do with the steps above is get the section header in the right place. Once you've done that, you can then use WriteINIStr for the rest of the data.)</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">miguez</span><br><span class="post-time small text-muted">20th December 2008 00:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Comperio,<br><br>This worked like a charm! I first had to figure out how to copy a file, which I did with:<br><br></p><pre>
<code>Rename $AircraftCFG "$PLUGINSDIR\aircraft.cfg"</code>
</pre><br><br>Where aircraft.cfg is the file to be copied, the original residing in a variable <font color="darkred">$AircraftCFG</font>, which holds a path. As you can see, I followed your recommendation of copying it to the <font color="darkred">$PLUGINSDIR</font>.<br><br>Then I read through the copy line by line, writing to the original as I went, until I found the place to add the new text. I added the new text, then resumed the writing of the original file.<br><br>By the way, I agree with you, in an INI file the order or location of the sections does not matter. In my case, though, the file is commonly edited by end users, so it needed to look tidy.<br><br>Here's the final function code, if anyone is interested. I am open to any suggestions on improving how I do this, as I am very far from being a good programmer.<br><br>Oh, and for those doing about the same thing, don't forget to delete the copy of the INI file at the end!<br><br><pre>
<code>Function UpdateFSXINI<br>Push $R0<br>Push $R1<br>Push $R2<br>Push $R3<br>Push $R4<br><br> StrCpy $AircraftCFG "$INSTDIR\SimObjects\Airplanes\PMDG747-400\aircraft.cfg"<br> Rename $AircraftCFG "$PLUGINSDIR\aircraft.cfg"<br> Call FindNumberPlanes<br> FileOpen $R0 $AircraftCFG a<br> FileOpen $R2 "$PLUGINSDIR\aircraft.cfg" r<br> StrCpy $FSXINIsearch "[General]"<br> Loop:<br>  FileRead $R2 $R3<br>  StrCpy $R4 $R3 9<br>  StrCmp $R4 "[General]" +1 +2<br>   Call AddFSXAoAAircraft<br>  StrCmp $R3 "" +3 +1<br>  FileWrite $R0 $R3<br>  Goto Loop<br> FileClose $R0<br> FileClose $R2<br><br> Delete "$PLUGINSDIR\aircraft.cfg"<br> FlushINI "$PLUGINSDIR\aircraft.cfg"<br><br>Pop $R4<br>Pop $R3<br>Pop $R2<br>Pop $R1<br>Pop $R0<br>FunctionEnd</code>
</pre><br>
      <br>
      Thanks for NSIS, and for all the help!!<br>
      <br>
      Best regards,
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script type="text/javascript" src="../js/highlight.pack.js" async>
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>