<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Why NSIS installer read environment variable incorrectly?" />

  <title>Why NSIS installer read environment variable incorrectly? - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Why NSIS installer read environment variable incorrectly?</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=303507">Why NSIS installer read environment variable incorrectly?</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">v_automation</span><br />
      <span class="post-time small text-muted">25th February 2009 22:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Why NSIS installer read environment variable incorrectly?</strong><br />
      Hi<br />
      <br />
      Why NSIS installer read environment variable incorrectly?<br />
      <br />
      I read processor_architecture variable on Windows x64 and installer returns x86 instead of AMD64. Why?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Comperio</span><br />
      <span class="post-time small text-muted">26th February 2009 00:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">From what I was able to gather from Google searches was that a 32-bit process returns "x86", while a 64-bit process will return "AMD64" or "IA64". (and as you may have guessed by now, NSIS is 32-bit.)<br />
      <br />
      This is explained better here:<br />
      <a href="http://msdn.microsoft.com/en-us/library/aa384274(VS.85).aspx" target="_blank">http://msdn.microsoft.com/en-us/libr...74(VS.85).aspx</a></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">26th February 2009 00:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">use x64.nsh</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">v_automation</span><br />
      <span class="post-time small text-muted">26th February 2009 07:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Re: Why NSIS installer read environment variable incorrectly?</strong><br />
      Hello Comperio, Anders!<br />
      <br />
      Thank you for your replays!<br />
      <br />
      NSIS is installer and the only reason for getting processor_architecture variable is to know in what environmen it is executed, so NSIS installer must returns correct value according to OS type.<br />
      <br />
      It is not inportant how windows changes variables, installer must allways return correct values.<br />
      <br />
      I do not want to use x64.nsh, because it require adding of additional libraries/plug-ins to installer, for something so simple and natural for any installer.<br />
      <br />
      There a lot of indirect ways OS type to be detected, so I do not need x64.nsh, but installer, must report variables accordingly, so this is bug that must be fixed!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Comperio</span><br />
      <span class="post-time small text-muted">26th February 2009 16:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">what "bug"? The link I provided from MS indicates that this problem happens on <b>ANY</b> 32-bit app.<br />
      <br />
      The only solution therefore would be to create a 64-bit version of NSIS. Unfortunately, converting NSIS to native 64-bit is not an easy task.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">26th February 2009 18:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Simple and natural? Reading environment variables is never the best way to get info, since you know, THE USER CAN CHANGE THEM. x64.nsh is part of the default nsis install, you should consider it as a part of NSIS (If you are using Modern UI, you are already using a plugin)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">26th February 2009 20:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If for whatever reason you still don't want to use the proper method, on Vista, %windir%\Sysnative redirects to the 64 bit system folder, you can use IfFileExist to check it's content and tell if you are on 64 bit or not</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">v_automation</span><br />
      <span class="post-time small text-muted">27th February 2009 10:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hello Anders, Comperio!<br />
      <br />
      Thank you for your replays!<br />
      <br />
      Replays of both of you I evaluate as useful.<br />
      <br />
      I need a most simple way to detect OS type, so I now use PROCESSOR_ARCHITEW6432 variable to check OS type.<br />
      <br />
      I call this bug because we talk for installer, but not for text editor. If NSIS is installer it must provide predefined constants as $sysdir and $windir, that to return OS version and type by simply reading them. Why I need to write code to get OS type or version, when this are parameters that are related to any setup and everyone need them by one or other reason.<br />
      <br />
      OS type and version as so natural and important to installer constants as directory constants, even more, because I can get folders paths from registry, but not and OS type<br />
      <br />
      I do not need native 64bit version of installer, because 32bit version is doing the job perfectly, while 64bit version cannot run on 32bit OS, and obviously I need it to run as on 32bit as well on 64bit, and this is why I need to detect OS type</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">14th March 2009 22:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That information is provided, as Anders mentioned, in functions defined in x64.nsh. Further functions for version detection are available in WinVer.nsh.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">rrobinson</span><br />
      <span class="post-time small text-muted">2nd May 2009 17:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You might want to try this to get the native cpu architecture. Google GetNativeSystemInfo to get the meaning of the result returned on the stack.<br />
      <br />
      Function GetCPUArchitecture<br />
      Push $2<br />
      Push $1<br />
      System::Alloc 36 ; new SYSTEM_INFO<br />
      Pop $1 ; $1 = new SYSTEM_INFO<br />
      System::Call "Kernel32::GetNativeSystemInfo(i r1)" ; GetNativeSystemInfo($1)<br />
      System::Call "*$1(&amp;i2.r2)" ; $2 = ((WORD*)$1)[0], which is the wProcessorArchitecture field<br />
      System::Free $1 ; delete $1<br />
      Pop $1<br />
      Exch $2 ;so the register $1 and $2 are preserved and the result is on the top of the stack<br />
      FunctionEnd</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
