<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="How to System::Call DLL function with reference?" />

  <title>How to System::Call DLL function with reference? - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">How to System::Call DLL function with reference?</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=251359">How to System::Call DLL function with reference?</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">dbarrett</span><br />
      <span class="post-time small text-muted">18th July 2006 04:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>How to System::Call DLL function with reference?</strong><br />
      I have a DLL with an exported function with the following signature:<br />
      <br />
      extern "C" __declspec(dllexport) HRESULT Run4( HINSTANCE, HINSTANCE, HINSTANCE, LPSTR, int, bool&amp; )<br />
      <br />
      How do I call this function and receive the 'bool&amp;' back into the NSIS script?<br />
      <br />
      The best I can come up with is:<br />
      <br />
      System::Call "MyDLL::Run4( i 0, i 0, i 0, t '', *i .r4 ), i.r3" ? u<br />
      <br />
      But the DLL segfaults when it tries to write to the boolean reference. I assume this means I'm incorrectly passing in the reference to $4. I've tried this:<br />
      <br />
      System::Alloc 4<br />
      Pop $4<br />
      System::Call "MyDLL::Run4( i 0, i 0, i 0, t '', *i .r4 ), i.r3" ? u<br />
      <br />
      And this:<br />
      <br />
      System::Alloc 4<br />
      Pop $4<br />
      System::Call "MyDLL::Run4( i 0, i 0, i 0, t '', i .r4 ), i.r3" ? u<br />
      <br />
      And this:<br />
      <br />
      System::Call "MyDLL::Run4( i 0, i 0, i 0, t '', *i 0 r4 ), i.r3" ? u<br />
      <br />
      But no effect. Can you see what mistake I'm making, or is what I'm trying to do not possible?<br />
      <br />
      -david<br />
      <br />
      PS: It works fine if I comment out the line assigning the value to the 'bool' in the DLL, so I do believe it's been narrowed down to this one issue.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joel</span><br />
      <span class="post-time small text-muted">18th July 2006 04:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Let's see:<br /></p>
      <pre>
<code>extern</code><span style="color: #DD0000">"C"</span><span style="color: #0000BB">__declspec</span><span style="color: #007700">(</span><span style="color: #0000BB">dllexport</span><span style="color: #007700">)</span><span style="color: #0000BB">HRESULTRun4</span><span style="color: #007700">(</span><span style="color: #0000BB">HINSTANCE</span><span style="color: #007700">,</span><span style="color: #0000BB">HINSTANCE</span><span style="color: #007700">,</span><span style="color: #0000BB">HINSTANCE</span><span style="color: #007700">,</span><span style="color: #0000BB">LPSTR</span><span style="color: #007700">,</span><span style="color: #0000BB">int</span><span style="color: #007700">,</span><span style="color: #0000BB">bool</span><span style="color: #007700">&amp;)
</span>
</pre>Now converted to system syntax:<br />
      <pre>
<code>System</code><span style="color: #007700">:</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'MyDLL::Run4(i0,i0,t"",i0,*i.r1)i.r0'
</span>
</pre>I don't have the dll, so I can't test it.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">dbarrett</span><br />
      <span class="post-time small text-muted">18th July 2006 04:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Alas, no luck. Every time it just segfaults when I try to write to the 'bool&amp;' parameter. :(</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">18th July 2006 11:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Can't you use BOOL with TRUE and FALSE?<br />
      It's just an int with 0 or 1 then.<br />
      <br />
      -Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">dbarrett</span><br />
      <span class="post-time small text-muted">18th July 2006 20:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Unfortunately I can't change the function signature for backwards compatability reasons. Were it up to me I'd just return 'true' or 'false' in the return value. Unfortunately, I'm stuck with a reference to a 'bool'.<br />
      <br />
      Now, I *think* a reference looks just like a pointer on the stack, and is just treated special by the compiler. Thus I'd assume the standard pointer semantics of the System::Call would work. But unfortunately I can't get them too. Can you come up with any other variations I might try?<br />
      <br />
      -david</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joel</span><br />
      <span class="post-time small text-muted">19th July 2006 02:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        Can you come up with any other variations I might try?
      </blockquote>Can you post the DLL?
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">dbarrett</span><br />
      <span class="post-time small text-muted">19th July 2006 09:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Ok, I'll put together a DLL with the same function signature and post a link here. Thanks for all your help on this.<br />
      <br />
      In the meantime, I've decided to temporarily drop the backwards compatibility requirement and go with a function that's:<br />
      <br />
      HRESULT Run( )<br />
      <br />
      Much simpler, works like a charm. However, now I've discovered another hangup: the DLL filename contains a hyphen, and that seems to muck it up. Specifically, my code is:<br />
      <br />
      System::Call "$2::Run( ) i.r3 ? u"<br />
      <br />
      So far as I can tell, this works great so long as $2 is a purely alphabetical name (eg, "MyDLL"). But a DLL name with hyphens (eg, "MyDLL-1.2-3") appears to screw it up.<br />
      <br />
      Can you recommend any way to pass in a hyphenated DLL name?<br />
      <br />
      Again, thanks for all your help with this.<br />
      <br />
      -david</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">19th July 2006 17:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by dbarrett</i><br />
        <b>Can you recommend any way to pass in a hyphenated DLL name?</b>
      </blockquote>Extract it with a hyphen-less name. You can even use GetTempFileName.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">dbarrett</span><br />
      <span class="post-time small text-muted">19th July 2006 23:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Eureka! I figured out the filename issue. My DLL filename is of the following form:<br />
      <br />
      MyDLL-X.YYY-ZZZ.dll<br />
      <br />
      And I was calling as follows:<br />
      <br /></p>
      <pre>
<code>System::Call "MyDLL-X.YYY-ZZZ::Run( ) i.r3 ? u"</code>
</pre><br />
      <br />
      However, the 'LoadLibrary' Win32 function only appends the ".dll" to the end when searching if the name passed in doesn't have an extension. And it assumed my DLL had the extension "YYY-ZZZ" and thus failed. The solution is to explicitly indicate the ".dll" extension in the System::Call as follows:<br />
      <br />
      <pre>
<code>System::Call "MyDLL-X.YYY-ZZZ.dll::Run( ) i.r3 ? u"</code>
</pre><br />
      <br />
      So, that fixes that up. Next I need to get the "bool&amp;" function signature to work, but this lets me keep moving forward. Thanks!<br />
      <br />
      -david
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
