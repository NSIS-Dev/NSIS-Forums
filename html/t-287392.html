<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Linefind text insert issue" />

  <title>Linefind text insert issue - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Linefind text insert issue</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=287392">Linefind text insert issue</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">carlosfocker</span><br />
      <span class="post-time small text-muted">22nd February 2008 19:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Linefind text insert issue</strong><br />
      Has anyone else noticed that inserting text using linefind into a file doesn't work correctly anymore. I figured it was just me so I ran the example in the documentation (Example4 (insert lines)) and found that it does not work as well. It seems to occur only when you want to write to the file and output the changes to the same filename. This did work before. I plan on looking into this but wanted to throw it out there to see if anyone noticed. Any help would be appreciated.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">22nd February 2008 19:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The first example works fine for me and the tests pass. What exactly doesn't work for you?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">carlosfocker</span><br />
      <span class="post-time small text-muted">22nd February 2008 19:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>
      <pre>
<code><br />Section<br />        ${LineFind} "C:\a.log" "" "10" "Example4"<br />        IfErrors 0 +2<br />        MessageBox MB_OK "Error"<br />SectionEnd<br /><br />Function Example4<br />        FileWrite $R4 "---First Line---$\r$\n"<br />        FileWrite $R4 "---Second Line ...---$\r$\n"<br /><br />        Push $0<br />FunctionEnd<br /><br /></code>
</pre><br />
      <br />
      This code does not insert the the two lines into c:\a.log. I ran the code and look in c:\a.log that I created before hand and nothing is inserted. If I change the output to a2.log the text is inserted into a2.log.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">22nd February 2008 19:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Code works fine for me. It inserts those two lines of text right before the 10th line.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">carlosfocker</span><br />
      <span class="post-time small text-muted">24th February 2008 18:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I know why I was seeing the issue with the example. If the file is completely empty it doesn't insert the text. If there is an actual 10th line in the file it will insert.<br />
      <br />
      The thing I don't get is I had some functionality that used the linefind that worked and just stopped working. It had a linefind call within a linefind (not sure if this matters) call. Like this:<br />
      <br /></p>
      <pre>
<code><br /><br />Section test<br /><br />   ${LineFind} "c:\file.txt" "c:\file.txt" "1:-1" "fileReplace"<br /><br />SectionEnd<br /><br />Function fileReplace<br /><br />   ;String to search for<br />   StrCpy $R0 "test="<br /><br />   ${LineFind} "c:\file.txt" "/NUL" "1:-1" "FindStringInString"<br /><br />   ;String to insert<br />   StrCpy $R0 "test=test$\r$\n"<br /><br />   ${LineFind} "c:\file.txt" "" "$R1" "FileTextInsert"<br /><br />   Push $0<br /><br />FunctionEnd<br /><br />;Writes the string provided in $R0<br />function FileTextInsert<br /><br />     ;Write the specified string ($R0) to the file specified by linefind ($R4)<br />     FileWrite $R4 $R0<br /> <br />     Push $0<br /><br />functionend<br /><br />;Searches a given string and assignes $R1 the line number where it was found + 1<br />Function FindStringInString<br /><br />      ;$R9 is the path name return by locate.  It equals the path name for the current file that was found<br />      ${TrimNewLines} '$R9' $R9              <br /><br />      ;Search the current line to see if specified value is there<br />      ${WordFind} "$R9" "$R0" "+1{" $1<br /><br />    ;If string to search is not equal to output string then line was not found.<br />    ${IfNot} $R9 == $1<br /><br />          ;Sets the $0 to contain a string that stops<br />          StrCpy $0 StopLineFind<br /><br />          ;Sets $R1 with the line number found<br />          StrCpy $R1 $R8<br /><br />          ;Increment $R1 to the next line number<br />          IntOp $R1 $R1 + 1<br /><br />    ${EndIf}<br /><br />    ;Search the next line<br />    StrCpy $R9 "$R9$\r$\n"<br /><br />    Push $0<br /><br />FunctionEnd<br /><br /><br /></code>
</pre><br />
      <br />
      I have excluded some code to make it cleaner. The problem I have is this code worked for me before and now it doesn't. I was able to get it working by calling fileReplace directly. I do realize that the way above is unnecessary and it isn't really necessary to fix.
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
