<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Appending InstallDir to browsed path ...sometimes" />

  <title>Appending InstallDir to browsed path ...sometimes - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Appending InstallDir to browsed path ...sometimes</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=221000">Appending InstallDir to browsed path ...sometimes</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Kiaser Zohsay</span><br />
      <span class="post-time small text-muted">8th July 2005 21:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Appending InstallDir to browsed path ...sometimes</strong><br />
      I have taken a journey today, and I would like to share the story of that journey, so that it may enrich the lives of others for many years to come.<br />
      <br />
      OK, seriously. I wrote a little block of code, but I think its really, really cool. So here tis:</p>
      <pre>
<code>;--------------------------------<br />; Verify the Install Dir<br />Function .onVerifyInstDir<br />  IfFileExists $INSTDIR\..\Appname.exe "" PathGood<br />    GetFullPathName $INSTDIR $INSTDIR\..<br />    FindWindow $R0 "#32770" "" $HWNDPARENT<br />    GetDlgItem $R0 $R0 1019<br />    SendMessage $R0 ${WM_SETTEXT} 0 "STR:$INSTDIR"<br />  PathGood:<br />FunctionEnd </code>
</pre>Here's a little background. Our app uses one install for both new installs and updates. Most of the time, InstallDirRegKey works like a charm, so when the user installs an update, setup remembers where it was installed originally.<br />
      <br />
      We use InstallDir without quotes, so the default directory name gets appended from the browse dialog. I personally like this, because it encourages my users to keep a consistent environment. Occasionally, some users change the install directory to something they like better.<br />
      <br />
      Here's the kicker. Many (actually most) of our users install our app on a network drive. This means that more than one user can do installs, and that a user doing an update won't necessarily have the InstallDirRegKey value in their registry.<br />
      <br />
      When InstallDirRegKey is not found, and the user has to browse for the directory, and the directory name is not the default, then the default name gets appended to the existing path as a subdirectory. The user then starts the app in the original location using the original shortcut, and they still see the previous version of the app, and my phone rings. This is a problem.<br />
      <br />
      The code sample above is the solution. I found it was easy to modify the $INSTDIR variable, but while the dialog is visible, $INSTDIR is not the primary source. The primary source is the text in the edit box of the dialog. So to really change the install dir in .onVerifyInstDir, you need to update the text box with WM_SETTEXT.<br />
      <br />
      Note that this will also prevent a user from browsing to a directory below a directory with Appname.exe in it. The browse button will work, but the directory in the text box will still be the parent. A more stringent method would be check $INSTDIR before modifying it to see if the end of the path is equal to the default directory name, which is left as an exercise.<br />
      <br />
      Enjoy!
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
