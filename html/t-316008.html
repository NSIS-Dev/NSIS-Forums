<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Deleting a registry key from HKLM in vista w/ UAC" />

  <title>Deleting a registry key from HKLM in vista w/ UAC - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Deleting a registry key from HKLM in vista w/ UAC</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=316008">Deleting a registry key from HKLM in vista w/ UAC</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">taxilian</span><br />
      <span class="post-time small text-muted">4th January 2010 23:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Deleting a registry key from HKLM in vista w/ UAC</strong><br />
      I've been using NSIS for awhile with no problems, but the last week or two I have been completely defeated.<br />
      <br />
      I recently discovered that our COM registration occasionally writes to HKLM instead of HKCU, due to some legacy code that we didn't realize was active. The problem with that is that under certain circumstances, the CLSID is still registered in HKLM and thus installs to HKCU aren't detected until it is deleted from HKLM.<br />
      <br />
      So, I set my installer to request elevation if it detects that the registry key is there. No errors, everything says it's working, but the key doesn't get deleted. So, I set "RequestEexecutionLevel admin"; no luck. Tried running the installer explicitely as Administrator; no luck.<br />
      <br />
      I have used the DeleteRegKey NSIS function, SHDeleteKey windows API function, and the RegDeleteTree windows API function introduced in Vista. None of them work. I can write to or delete from anywhere else in the registry except HKLM/SOFTWARE/Classes/CLSID; HKCU doesn't seem to even work, and HKCR accesses HKCU/SOFTWARE/Classes.<br />
      <br />
      I'm completely running out of ideas; it looks like perhaps the registry virtualization is messing me up, but I can't figure out how to fix it. I am always setting RequestExecutionLevel.<br />
      <br />
      Any ideas?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">meaningoflights</span><br />
      <span class="post-time small text-muted">6th January 2010 11:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I feel your pain.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">meaningoflights</span><br />
      <span class="post-time small text-muted">8th January 2010 11:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">have u made any progress? do you have access to the source code of the COM component? where you can put a condition to take care of it in there for vista users</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
