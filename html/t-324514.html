<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="UAC plugin - bring installer window to foreground"><title>UAC plugin - bring installer window to foreground - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">UAC plugin - bring installer window to foreground</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=324514">UAC plugin - bring installer window to foreground</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">SteveRidout</span><br><span class="post-time small text-muted">2nd December 2010 11:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>UAC plugin - bring installer window to foreground</strong><br>Hey,<br><br>Thanks Anders for sharing your UAC plugin!<br><br>I've got it working in our installer but there's one major problem, the installer window doesn't come to the foreground.<br><br>I'm using v0.2.2c and I know that you've said there were some ugly hacks to get this working in an earlier version. My questions:<br><br>1. Did the hacks result in any undesirable behaviour?<br><br>2. Is there anything changed in v0.2.2c which would not allow them to work?<br><br>3. Would it be easy for me to patch v0.2.2c to get this working?<br><br>Before I delve in and try playing around with allowSetForeground(), setForeground(), etc.. I thought you could give me maybe give me some advice?<br><br>Thanks again!<br><br>Steve</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">2nd December 2010 20:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I don't think there was any undesirable behavior, but IIRC the hack that works is to create a window with WS_EX_TRANSPARENT|WS_EX_LAYERED|WS_EX_TOOLWINDOW ex styles, this creates a transparent window in a hacky way. I don't think WS_EX_TRANSPARENT on a top level window is really supported etc.<br><br>I never figured out the actual cause of the problem, but my guess is that the nsis verify CRC dialog is the issue, and once you lose "foreground", SetForegroundWindow stops working.<br><br>You should be able to find the hacks by looking for the UAC_HACK_* #ifdef's.<br><br>It feels like years since I last messed around with this problem so I don't remember the details or how to reproduce it, drop by IRC and maybe we can come up with some new workaround...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">7th December 2010 23:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hello.<br><br>I would also be interested in a fix for that issue. With v0.2.2d I encounter the problem that the UAC dialog insn't triggered automatically, but delayed until the user clicks the installer icon in the task-bar. This means that when you launch the installer nothing will happen. Well, except for a blinking icon in the task-bar. Not every user may notice. (This was the result under Windows 7).</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">8th December 2010 00:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I have come to the conclusion that elevating in .oninit is just not going to work, and .onguiinit will have to be used instead, this of course is problematic for silent installers.<br><br>I'm guessing you guys still want silent installers to prompt (while I actually just think the process should exit with the proper error code :) )<br><br>The nsis design makes this hard to implement, but I'll try to come up with some sort of hack</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">8th December 2010 15:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by Anders</small><br>I have come to the conclusion that elevating in .oninit is just not going to work, and .onguiinit will have to be used instead, this of course is problematic for silent installers.</blockquote>So do do you suggest that simply moving the UAC initialization from .onInit to .onGuiInit will do the trick or will it require modifications inside your UAC plugin itself? Anyway, I'm going to play around with it a bit now...<br><br>BTW: currently I don't care about "silent" installers. This may easily become different in a future project, of course ;)</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">8th December 2010 16:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">(double post, by accident. srry)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">8th December 2010 16:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Update:<br><br>It seems moving the UAC initialization to .onGuiInit indeed does the trick :)<br><br>However in a MUI2-based installer, I have to use something like:<br></p><pre>
<code>!define MUI_CUSTOMFUNCTION_GUIINIT myUacInit</code>
</pre><br><br>You think it might conflict with anything MUI2 does in its own .onGuiInit functions?<br><br>Thanks!</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">8th December 2010 16:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">That just inserts Call myUacInit in .onGUIInit so it should be fine.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">8th December 2010 16:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by Afrow UK</small><br>That just inserts Call myUacInit in .onGUIInit so it should be fine.<br><br>Stu</blockquote>Yeah, but it also executes other MUI2-specific stuff before my custom GuiInit function. We probably don't want that to happen before UAC init or at all (in the "outer" installer).</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">8th December 2010 17:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I'm going to rewrite some stuff maybe, not sure what to do yet</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">11th December 2010 15:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Now that the "bring installer window to foreground" problem is resolved by doing the UAC init in .onGuiInit, a new question arises:<br><br>Where to call the "MUI_LANGDLL_DISPLAY" macro? :confused:<br><br>Before I did this in .onInit, but *after* the UAC init. And it worked as expected.<br><br>Now after the UAC init has moved to .onGuiInit, I get the MUI_LANGDLL_DISPLAY dialog twice, which isn't surprising.<br><br>Unfortunately moving MUI_LANGDLL_DISPLAY after UAC init again (in .onGuiInit) doesn't work. The language isn't applied!<br><br>So I assume that MUI_LANGDLL_DISPLAY must be called from .onInit rather than .onGuiInit to work correctly.<br><br>My workaround for this which <i>appears</i> to do the trick:<br><br></p><pre>
<code>Function .onInit<br>        ${If} ${UAC_IsInnerInstance}<br>                !insertmacro MUI_LANGDLL_DISPLAY<br>        ${EndIf}  <br>FunctionEnd</code>
</pre><br>
      <br>
      But is it considered "safe" to use ${UAC_IsInnerInstance} even before the actual UAC initialization ???<br>
      <br>
      Thanks :)
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br>
      <span class="post-time small text-muted">11th December 2010 16:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Yes, it should be safe.<br>
      <br>
      I am planning to actually make some changes so that calling from onguiint is less painful, I was thinking that it would be a two stage thing, using both oninit and onguiinit.<br>
      <br>
      I'm not really sure how to do it in practice, getting the correct language loaded in both instances is going to be a problem...<br>
      <br>
      Or maybe it would be possible to change the plugin api so that plugins can change the language after oninit.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">SteveRidout</span><br>
      <span class="post-time small text-muted">13th December 2010 11:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">It sounds like you guys have a better and simpler fix using onGuiInit, but I thought I'd share my patch to v0.2.2 which works for me and does the following:<br>
      <br>
      1. Reintroduce Ander's hack from version 0.0.11d which creates an invisible window to retain ability to set foreground<br>
      <br>
      2. Call AllowSetForeground in inner process on outer process before running an outer operation.<br>
      <br>
      3. Sleep for 5 seconds before outer window is destroyed (stops focus ability getting lost before my app splash screen shows)<br>
      <br>
      It's not pretty but works for my case. Here it is: (applies to v0.2.2) <a href="http://steveridout.com/sharedFiles/uac.patch" target="_blank">http://steveridout.com/sharedFiles/uac.patch</a><br>
      <br>
      Thanks Anders for the help over IRC</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script type="text/javascript" src="../js/highlight.pack.js" async>
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>