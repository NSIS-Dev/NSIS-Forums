<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Uninstall icon in Start Menu isn't shown"><title>Uninstall icon in Start Menu isn't shown - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Uninstall icon in Start Menu isn't shown</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=331134">Uninstall icon in Start Menu isn't shown</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">juliarg</span><br><span class="post-time small text-muted">1st June 2011 15:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Uninstall icon in Start Menu isn't shown</strong><br>Hello,<br>After installing the application, the installer and uninstaller icons are properly shown in application folder in Start menu, but the uninstaller icon is missing from the main Start menu (see attachment)<br>What am I missing here?<br><br>It's 64-bit Windows, program is installed in Program Files (x86). But looks like it's not the same problem as discussed in <a href="http://forums.winamp.com/showthread.php?t=327806" target="_blank">http://forums.winamp.com/showthread.php?t=327806</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">1st June 2011 19:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Could you give us some code?<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">juliarg</span><br><span class="post-time small text-muted">2nd June 2011 08:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">!define MUI_ICON myapp_install.ico<br>!define MUI_UNICON myapp_uninstall.ico<br><br>In install section:<br><br>CreateDirectory "$SMPROGRAMS\${APP_NAME}"<br>CreateShortCut "$SMPROGRAMS\${APP_NAME}\${APP_NAME}.lnk" "$INSTDIR\${APPFILE}"<br>CreateShortCut '$SMPROGRAMS\${APP_NAME}\${UNINSTALL_SHORTCUT}.lnk' "${UNINST_EXE}"</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">juliarg</span><br><span class="post-time small text-muted">2nd June 2011 09:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The problem appears only when installing in Program Files (x86) folder. When I install to another folder, select uninstaller icon and do "Pin to Start Menu", the uninstaller icon is ok. If I install to Program Files (x86), same actions lead to a default icon in start menu (as on the image attacted).</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">juliarg</span><br><span class="post-time small text-muted">2nd June 2011 10:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">If I select the menu item with the default icon and choose "Properties-&gt;Change Icon" I see the path to file with icons looking like this:<br><br>C:\Program Files (x86)\App\Uninstall.exe<br><br>The icon is seen in icon view below in properties. But it still doesn't appear in menu.<br><br>If I change it to<br><br>%ProgramFiles% (x86)\App\Uninstall.exe<br><br>and save this setting, the uninstaller icon appears ok.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">3rd June 2011 07:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Could you upload this .lnk somewhere?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">juliarg</span><br><span class="post-time small text-muted">3rd June 2011 10:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Here it is. I've renamed it to .lnkk for convenient uploading.<br><a href="http://www.sendspace.com/file/7jl8qq" target="_blank">http://www.sendspace.com/file/7jl8qq</a><br>This .lnk is both in Programs/AppName/ and in main start menu (on attached image). In Programs/AppName/ the icon is ok.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">3rd June 2011 11:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">That lnk does not contain a icon block so it should just use the icon of the target. Does clicking the shortcut with the broken icon actually work?<br><br></p><blockquote>Flags: 0x99<br>ShItemIdList<br>HasRelativePath<br>HasWorkDir<br>Unicode<br>TargetFileAttributes: 0x0<br>TargetCreated: N/A<br>TargetLastAccess: N/A<br>TargetModified: N/A<br>TargetSize: 0<br>IconIndex: 0<br>ShowCmd: NORMAL<br>HotKey: 0x0<br><br>RelativePath: ..\..\..\..\..\..\Program Files (x86)\Yota\Play\Uninstall.exe<br>WorkDir: C:\Program Files (x86)\Yota\Play<br><br>ShItemIdList<br>------------<br>Length: 415<br>9D 01 14 00 1F 50 E0 4F D0 20 EA 3A 69 10 A2 D8 .....P.O...:i...<br>08 00 2B 30 30 9D 19 00 2F 43 3A 5C 00 00 00 00 ..+00.../C:\....<br>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 76 ...............v<br>00 31 00 00 00 00 00 00 00 00 00 10 00 50 72 6F .1...........Pro<br>67 72 61 6D 20 46 69 6C 65 73 20 28 78 38 36 29 gram.Files.(x86)<br>00 54 00 08 00 04 00 EF BE 00 00 00 00 00 00 00 .T..............<br>00 2A 00 00 00 00 00 00 00 00 00 00 00 00 00 00 .*..............<br>00 00 00 00 00 00 00 00 00 00 00 50 00 72 00 6F ...........P.r.o<br>00 67 00 72 00 61 00 6D 00 20 00 46 00 69 00 6C .g.r.a.m...F.i.l<br>00 65 00 73 00 20 00 28 00 78 00 38 00 36 00 29 .e.s...(.x.8.6.)<br>00 00 00 22 00 4A 00 31 00 00 00 00 00 00 00 00 ...".J.1........<br>00 10 00 59 6F 74 61 00 00 36 00 08 00 04 00 EF ...Yota..6......<br>BE 00 00 00 00 00 00 00 00 2A 00 00 00 00 00 00 .........*......<br>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................<br>00 00 00 59 00 6F 00 74 00 61 00 00 00 14 00 4A ...Y.o.t.a.....J<br>00 31 00 00 00 00 00 00 00 00 00 10 00 50 6C 61 .1...........Pla<br>79 00 00 36 00 08 00 04 00 EF BE 00 00 00 00 00 y..6............<br>00 00 00 2A 00 00 00 00 00 00 00 00 00 00 00 00 ...*............<br>00 00 00 00 00 00 00 00 00 00 00 00 00 50 00 6C .............P.l<br>00 61 00 79 00 00 00 14 00 64 00 32 00 00 00 00 .a.y.....d.2....<br>00 00 00 00 00 00 00 55 6E 69 6E 73 74 61 6C 6C .......Uninstall<br>2E 65 78 65 00 48 00 08 00 04 00 EF BE 00 00 00 .exe.H..........<br>00 00 00 00 00 2A 00 00 00 00 00 00 00 00 00 00 .....*..........<br>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 55 ...............U<br>00 6E 00 69 00 6E 00 73 00 74 00 61 00 6C 00 6C .n.i.n.s.t.a.l.l<br>00 2E 00 65 00 78 00 65 00 00 00 1C 00 00 00 ...e.x.e.......<br><br>SpecialFolderDataBlock<br>----------------------<br>SpecialFolderId: 0x2A<br>PIDL Offset: 163<br><br>KnownFolderDataBlock<br>--------------------<br>KnownFolder: {7C5A40EF-A0FB-4BFC-874A-C0F2e0b9fa8e}<br>PIDL Offset: 163</blockquote>What I wanted to check was SpecialFolderId and KnownFolder, if they specify the non x86 version of the shell constant it can fail on x64, but then launching the thing should also fail (Not sure if the icon lookup uses the same algorithm as the execution) 0x2A should be the x86 specific constant.<br><br>Could it be a icon cache problem? Did you try on another machine or another user?</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">juliarg</span><br><span class="post-time small text-muted">3rd June 2011 11:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Yes, the problem persists if another user on another machine installs the app.<br>Clicking on this shortcut actually works.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">juliarg</span><br><span class="post-time small text-muted">3rd June 2011 11:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">How do you explore the .lnk file?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">3rd June 2011 12:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by juliarg</small><br>How do you explore the .lnk file?</blockquote>I used my own private tool, sorry.<br><br>The file format is documented @ <a href="http://msdn.microsoft.com/en-us/library/dd871305(PROT.10).aspx#" target="_blank">http://msdn.microsoft.com/en-us/libr...PROT.10).aspx#</a>[MS-SHLLINK]: Shell Link (.LNK) Binary File Format</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">juliarg</span><br><span class="post-time small text-muted">3rd June 2011 14:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Could you then please have a look at this .lnk file?<br><br><a href="http://www.sendspace.com/file/nqi7am" target="_blank">http://www.sendspace.com/file/nqi7am</a><br><br>It's after I changed the "search for icons in the following file" property from<br><br>C:\Program Files (x86)\App\Uninstall.exe<br><br>to<br><br>%ProgramFiles% (x86)\App\Uninstall.exe<br><br>and then, the icon is there.<br><br>I wonder how the .lnk has changed, maybe it could give a clue.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">3rd June 2011 16:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote>...<br>RelativePath: ..\..\..\..\..\..\Program Files (x86)\Yota\Play\Uninstall.exe<br>WorkDir: C:\Program Files (x86)\Yota\Play<br>IconPath: %ProgramFiles% (x86)\Yota\Play\Uninstall.exe<br><br>ShItemIdList<br>...</blockquote>But "%ProgramFiles% (x86)" is not really a valid thing, you are just getting lucky.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">juliarg</span><br><span class="post-time small text-muted">6th June 2011 13:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Is there a way to put this IconPath in the .lnk via NSIS? I'm puzzled.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">7th June 2011 09:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by juliarg</small><br>Is there a way to put this IconPath in the .lnk via NSIS? I'm puzzled.</blockquote>You can set a specific icon in the CreateShortcut call (But it should NOT be required when it is the same as the target)</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">7th June 2011 10:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I have been playing around with some code, but I don't know how to get the icon path used when a .lnk does not specify a specific icon (I could probably fall back to the path from IShellLink::GetPath but I was hoping there was some shell function that would provide it for me)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">juliarg</span><br><span class="post-time small text-muted">7th June 2011 14:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I ran your code for the problem .lnk.<br><br>GetPath:0=C:\Program Files (x86)\Yota\Play\Uninstall.exe<br>GetIconLocation:0=,0<br>IShellLink HR=0<br>GetIconLocation:0=*|idx=7 flags=12<br>Extract:0=HICON=508627137<br>SHGetFileInfo=1|,0<br>SHMapPIDLToSystemImageListIndex=7</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">juliarg</span><br><span class="post-time small text-muted">7th June 2011 15:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I tried the following:<br>CreateShortCut "$SMPROGRAMS\${APP_NAME}\${UNINSTALL_SHORTCUT}.lnk" "${UNINST_EXE}" "" "${UNINST_EXE}"<br><br>After this, the icon remained default and on attempt to look at "Look for icons in this file" property I got ""Windows cannot find the file %ProgramFiles%\Yota\Play\uninstall.exe"<br><br>I applied the workaround from this topic <a href="http://forums.winamp.com/showthread.php?t=327806" target="_blank">http://forums.winamp.com/showthread.php?t=327806</a> and the message stopped appearing, "Look for icons in this file" path is correct. But the icon remains default.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">7th June 2011 15:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by juliarg</small><br>I ran your code for the problem .lnk.</blockquote>Did the application icon change to the correct icon on the instfiles page?</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">juliarg</span><br><span class="post-time small text-muted">7th June 2011 16:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Problem is not with the app icon, but with the uninstaller icon. On all the uninstaller pages, the icon is ok. It does not show only in the Start Menu (see attachment).<br>I am inclined to think that this is a Windows icon cache issue, because after I install and then update the app, the icon is ok.<br><br>I do this call for refreshing icons.<br>System::Call 'Shell32::SHChangeNotify(i 0x8000000, i 0, i 0, i 0)'<br><br>There is no specific code in installer to add an icon to the main Start menu (in attachment). Maybe this happens when installer is deinitialized, which is after the call to SHChangeNotify</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">7th June 2011 16:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I was actually talking about the little sample code I posted, it tries to set the icon from the .lnk</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">juliarg</span><br><span class="post-time small text-muted">7th June 2011 16:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">If I point it to the uninstaller .lnk, it sets the default icon to the instfiles page. I also tried pointing it to the application .lnk, it works - the application icon appears on the instfiles page.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">7th June 2011 17:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Looking at the link dump again I see that TargetFileAttributes and TargetSize are both 0 in my dump (I did not have the target file on my system). Are you creating the shortcut before the uninstaller has been written? The shortcut target should exist when you create the shortcut...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">juliarg</span><br><span class="post-time small text-muted">8th June 2011 09:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">:) Yes, you're right. I write the uninstaller in .onInstSuccess using Advanced Uninstall Log. The shortcuts are created in the install section.<br><br>I found out that if I do this<br><br>System::Call 'Shell32::SHChangeNotify(i 0x8000000, i 0, i 0, i 0)'<br><br>not at the end of install section, but on .onGuiEnd,<br><br>the icon is ok. Everything looks pretty simple now - the icon cache was refreshed when the uninstaller still was not there.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">8th June 2011 10:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Don't use that in .onGUIEnd because it will get called when people cancel your install. You don't need to use .onInstSuccess either; just add an unnamed Section after all your sections and put any final unconditionally executed code in there.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">juliarg</span><br><span class="post-time small text-muted">8th June 2011 10:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">But, in the documentation to Advanced Uninstall Log, they recommend to call the macro which creates the uninstaller in .onInstSuccess. That's how it's done now in my installer. And I need to refresh the cache after the uninstaller is created.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Yathosho</span><br><span class="post-time small text-muted">8th June 2011 11:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">@Anders<br>wait til MSG finds out about this post, he'll teach you to attach large chunks of code :p</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">8th June 2011 12:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">At least Anders has the sense not to use the broken code tag &gt;_&gt;<br><br><br>(btw @admins: please get to fixing that already...)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">DrO</span><br><span class="post-time small text-muted">8th June 2011 13:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">actually it was me that converted it to a quote block and i'll go through the posts in a few minutes and convert things to attachments as applicable.<br><br>as for fixing the code block issue, it is logged but it's massively down at the bottom of the list of things to do (though why VB3.x does it different is beyond me).<br><br>-daz</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">8th June 2011 13:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">In that case, can't you just workaround it to let vB interpret all code tags as php or quote instead? That'd be infinitely better than the mess that currently is the code tag.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Yathosho</span><br><span class="post-time small text-muted">8th June 2011 14:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">@MSG<br>just kidding</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">DrO</span><br><span class="post-time small text-muted">8th June 2011 14:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><b>MSG:</b> that still involves someone doing something though why going from VB2.x to VB3.x broke it i just don't know. there are things listed and i've mentioned it many times but the forums are low on the list of everything else that needs to be allocated resources. same as fixing some of the attachment upload issues, etc etc.<br><br>-daz</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">8th June 2011 15:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by MSG</small><br>At least Anders has the sense not to use the broken code tag &gt;_&gt;</blockquote>The PHP formating eats the \ so I had to go with CODE</div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script type="text/javascript" src="../js/highlight.pack.js" async></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>