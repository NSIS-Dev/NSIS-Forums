<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Problems on Server 2008"><title>Problems on Server 2008 - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Problems on Server 2008</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=289801">Problems on Server 2008</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">cherdeg</span><br><span class="post-time small text-muted">7th April 2008 14:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Problems on Server 2008</strong><br>Hello altogether,<br><br>we use NSIS to build an unattended installer for our customized CYGWIN package (see attached .nsi). This installer calls up "c:\cygwin\cygwin.bat" as penultimate step (last step is cleanup).<br><br>Background: When cygwin starts regularly (e.g. by executing bash via double-clicking the CYGWIN desktop icon) all shellscripts residing in "/etc/profile.d" are automatically executed. We use this functionality to execute a special script (copied to "/etc/profile.d" by the installer) to customize further options within cygwin.<br><br>From Windows 2000 to Windows 2003 R2 SP2 the installer works perfectly on all Windows OSses (even on x64).<br><br>Now Windows Server 2008 introduces a strange problem: if "cygwin.bat" (which starts "bash --login -i") is executed by NSIS (and only by NSIS...starting it manually works smoothly), bash is missing several environmental variables (reported by bash error message: "bash: cannot create temp file for here document: Bad address") and the scripts in "/etc/profile.d" won't be run.<br><br>I am not yet able to assign the source of this problem to either CYGWIN, Windows Server 2008 or Nullsoft Installer.<br><br>Personally I suppose that there is a problem supplying the standard environmental variables to "cygwin.bat".<br><br>Does anybody have a clue?<br><br>Best Regards,<br><br>Chris</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">7th April 2008 16:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">are you sure the working dir for the .bat is correct, currently its: SetOutPath "$INSTDIR\${DEST_SCRIPT}"<br><br>maybe it should be foo\cygwin or foo\cygwin\bin or something like that (Not sure why it would only break on 2k8 tho)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">cherdeg</span><br><span class="post-time small text-muted">8th April 2008 07:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hi,<br><br>thank you very much for your reply. I'll try to set another SetOutPath (the one where the batch resides and /bin, where bash.exe is).<br><br>I'll report back asap.<br><br>Regards,<br><br>Chris</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">cherdeg</span><br><span class="post-time small text-muted">8th April 2008 08:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hi Anders,<br><br>I tried both ways described above: no changes unfortunately...<br><br>Regards,<br><br>Chris</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">8th April 2008 09:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">if you add a "set" line to the .bat, it should print all environmental variables, so you can compare with/without nsis. Also, Filemon/Procmon (<a href="http://technet.microsoft.com/en-us/sysinternals/bb896645.aspx" target="_blank">http://technet.microsoft.com/en-us/s.../bb896645.aspx</a>) might be able to give you some clues to why it can't find whatever its looking for...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">cherdeg</span><br><span class="post-time small text-muted">16th April 2008 12:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>[SOLVED]</strong><br>Hello AllofYou,<br><br>thank you very much for the efforts you took on to help me solve our problem. Finally we managed not to solve the problem itself but at least to find a workaround. Still we are not able to identifiy the one of the tree possible parties responsible for the problem: Nullsoft, Microsoft or Cygwin?<br><br>However: If, which I am sure of, anybody else in this world uses the Nullsoft-Installer to deploy an unattended Cygwin-Installation to his/her/its client machines, the person will, at latest when it comes to package-compatibility with VistaSP1 or Windows Server 2008, experience the same problem as we did. So I would like to document my workaround here:<br><br>When Cygwin's "setup.exe" is finished, it has installed a script "/etc/profile". Among others, one of the duties of this script is to find and run all scripts residing in "/etc/profile.d". This definitley does not work on VistaSP1 or Windows Server 2008...no matter who's to blame...bash reports the error: "bash: cannot create temp file for here document: Bad address" and none of the scripts in "/etc/profile" is run. The code in "/etc/profile" responsible for this is:<br><br># Run all of the profile.d scripts<br># Note that these are supplied by separate packages<br># Ascending alphanumerical order enforced<br>if [ -d "/etc/profile.d" ]; then<br>while read f; do<br>if [ -f "${f}" ]; then<br>. "${f}"<br>fi<br>done &lt;&lt;- EOF<br>`/bin/find -L /etc/profile.d -type f -iname '*.sh' -or -iname '*.zsh' | LC_ALL=C sort`<br>EOF<br>fi<br><br>We decided to workaround the problem (we don't need to run <i>all</i> scripts in "/etc/profile.d" - in our customized configuration there never will be more than three...the code of "00bash.sh" and "openssl.sh" was directly) by hardcoding them to a customized "/etc/profile":<br><br># Code from "00bash.sh"<br>/bin/test \! /bin/sh.exe -ot /bin/bash.exe<br>if ( $status ) then<br>/bin/bash.exe -c '. /etc/profile.d/00bash.sh'<br>fi<br># Code from "openssl.sh"<br>export MANPATH="${MANPATH}:/usr/ssl/man"<br># Run our script<br>if [ -e /etc/profile.d/ibm_customize_cygwin.sh ]; then<br>/etc/profile.d/./ibm_customize_cygwin.sh<br>fi;<br><br>This may not be elegant but at least works as planned. When Cygwin's "setup.exe" has finished, the Nullsoft-Installer copies and overwrites the original "/etc/profile" with our customized version which is then run every time Cygwin is started by "cygwin.bat".<br><br>Now we have another problem (regarding uninstall on W2K8), please refer to my new post in this forum.<br><br>Regards,<br><br>Christoph</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">cherdeg</span><br><span class="post-time small text-muted">16th April 2008 13:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">[wrong thread]<br><br>Ahhh...btw., what I forgot to mention: On XP the uninstall works as planned.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">16th April 2008 23:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Sounds to me like cygwin's installer is creating its environment variables only for the user which executed it. In Vista's case, with UAC turned on, that'd be the administrator and not the actual user.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">cherdeg</span><br><span class="post-time small text-muted">21st April 2008 09:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hi kichik...<br><br>thanks for your reply...the machines we have here exist solely for software testing purposes (DB2, WebSphere, AIX). If any software is installed (inclunding the relevant NSIS package) it is definitely done by the local Administrator account on the system.<br><br>Question now would be: In Windows Server 2008 and VistaSP1: Even if the logged on user is localSystem\Administrator, is there a difference between the user starting the setup (the logged on account) and the user really copying the files (e.g. a machine account of some type)?<br><br>I also asked this question on the cygwin mailing list, but nobody was able to answer clearly...probably they simply don't know.<br><br>Regards,<br><br>Chris</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">21st April 2008 21:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">That's exactly the purpose of UAC - to create that segregation between the logged on account and the user running the setup itself. If the UAC dialog shows, your setup will run in a different context.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">21st April 2008 22:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><i>Originally posted by cherdeg</i><br><b>Question now would be: In Windows Server 2008 and VistaSP1: Even if the logged on user is localSystem\Administrator, is there a difference between the user starting the setup (the logged on account) and the user really copying the files (e.g. a machine account of some type)?<br></b></blockquote>If the logged in user is a member of the admin group, then the elevated process will run as that user (But it has a different token, the original token of that user actually. The non elevated processes use a restricted version of this token, this is called the split token UAC mode)<br><br>the UAC plugin has a export you can call to detect this; UAC::GetElevationType<br><br><br><blockquote>UAC::GetElevationType<br>Parameters: &lt;none&gt;<br>Returns: $0<br>TOKEN_ELEVATION_TYPE:<br>0 Unsupported/Failed (ErrorFlag is also set)<br>1 TokenElevationTypeDefault: User is not using a split token (UAC disabled or not admin)<br>2 TokenElevationTypeFull: UAC enabled, the (current) process is elevated<br>3 TokenElevationTypeLimited: UAC enabled, the process is not elevated</blockquote>($0 &gt; 1 means split token)<br><br>This is Vista SP0, but I can't imagine things have changed</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">cherdeg</span><br><span class="post-time small text-muted">22nd April 2008 09:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Okay kichik and Anders, many thanks for your replies. BTW, at the moment we're only talking about Windows Server2008, we yet did no Vista tests. I have to re-ask my question to clarify:<br><br>If the user starting the software installation is localMachine\Administrator, UAC doesn't pop up. In this case, does the whole installation process run on the same elevation level using the same, unmodified token?<br><br>Does it matter if, e.g. as in our case, the Installer starts another executable (ExecWait setup.exe), which again calls runs certain core components (of cygwin) which again run several post-installation scripts. Later in the process the Installer starts a batch, which again starts another executable, bash.exe wich once again starts a script on the cygwin level that but accesses environmental variables defined on OS level?<br><br>Do all these manyfold processes run in the same (elevated) context of localMachine\Administrator? Or does Windows degrade the level of elevation in the 2nd or 3rd child process level?<br><br>I very much hope to have expressed my question understandable - the English classes in school are some years past meanwhile...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">22nd April 2008 10:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Check the output of following command to make sure.</p><pre>
<code>nsExec::ExecToLog "cmd /c set"</code>
</pre></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">mehdi79</span><br><span class="post-time small text-muted">22nd April 2008 15:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">just a suggestion<br>execwait has an error code return<br>verify this error code return</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>