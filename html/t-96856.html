<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="NSIS Idea - Comments Wanted"><title>NSIS Idea - Comments Wanted - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">NSIS Idea - Comments Wanted</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=96856">NSIS Idea - Comments Wanted</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br><span class="post-time small text-muted">5th August 2002 10:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>NSIS Idea - Comments Wanted</strong><br>Sorry the idea is a little hard to explain so instead of posting a huge chunk of text here I made a little web page for it.<br><br>Please please please take the time to read this and post your comments back here. I think this is a very useful feature for NSIS that could also be taken a little further.<br><br>Visit the <a href="http://www.clantpa.co.uk/nsis/idea.html" target="_blank">web page about the idea</a>.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Fiffi</span><br><span class="post-time small text-muted">5th August 2002 10:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hello Sunjammer,<br><br>your idea is good. Can you make a little HowTo for programm a plugin-dll for NSIS? What is possible to add via a dll to NSIS?<br><br>What do you think about to add encryption of the compressed data<br>to NSIS.<br><br><br>(Please reply to my NSIS-GUI thread)<br><br><br>Fiffi:)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Smile2Me</span><br><span class="post-time small text-muted">5th August 2002 11:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote>Return values, syntax</blockquote>When still calling the dll with the CallInstDll, the dll knows necessary handles and can push to the stack. I think that is the best way to handle output.<br><br>BTW, to be honest, the idea is nice, might be quite a lot of coding to actually get auto-include to work and what is the payoff? We can reduce NSIS script code by a few lines. Are you sure you want to do this? The current approach does not need to consume variables for temp-files by the way. It is safe but not strictly necessary.<br><br>Good luck, still a nice idea to get going with the development of NSIS and I like that, but we should take care that the costs do not outweight the payoff.<br><br>-Hendri.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br><span class="post-time small text-muted">5th August 2002 11:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hendri, it all works already but before including it in any release or furthering it I wanted some feedback, thanks.<br><br>The payoff I feel is far less cluttered code. (btw the implementation actually does what CallInstDLL does underneath so dlls work the same way as before, and you don't have to use the auto-push).<br><br>Also, it transparently handles packing of the dll, temporary filenames and auto-deletion of the dlls used. I find extension dlls in NSIS to be very handy but awkward to use, so I want to make them easier to use.<br><br>My changes don't add much in terms of size to the generated NSIS installer but functionally I feel it is very useful. It is only a first attempt at the idea though so maybe it's not a good idea, or maybe it could/should be done differently, or extended... tell me! :D<br><br>Fiffi: I have not created the plugin idea, NSIS already supports that, I'm just making it easier to use (I think). The contrib\ExDll directory has a bare-bones example C++ NSIS plugin. Also, I'm not talking about ways to extend NSIS at the moment, e.g. encryption, so ask that as another thread please (but personally I have no need of that feature, maybe others do?).</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br><span class="post-time small text-muted">5th August 2002 11:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">:up: Good idea!</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">CodeSquid</span><br><span class="post-time small text-muted">5th August 2002 15:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Great feature!<br>This is a really useful feature. One of my installers uses 3 different extension DLLs and the code looks a little bit ugly so this feature helps me a lot.<br>I've just discovered that this feature has been commited to the nsis2k CVS repostitory, I'll test it asap.<br><br>BTW, what about the following scenario: Imagine that there are two DLLs which export a function with the same name and your script tries to use this function from one of the DLLs, what will happen in this case?<br>Compiling will fail in this case (if the feature is correctly implemented)<br><br>If you don't have a solution for this problem, here's mine:<br>It should be possible add a prefix to the function to tell the compiler which DLL to use, like<br>mydll.dll::function or something similar.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br><span class="post-time small text-muted">5th August 2002 15:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The problem had occured to me, I was waiting to see if opinion about the idea was favourable before taking it any further. I must admit I like your prefix idea, the only brief thought I'd had was a different approach, to have an alias command in the script to provide an alternate name for a command before it is used anywhere, say at the top of the file.<br><br>I want to standardise the return mechanism too but that has some issues. For example, I can't assume that the stack contains a return value because if it doesn't and I pop the top of the stack I could mess up things. Two ideas spring to mind:<br><br>Firstly some kind of ability to designate a target for a stacked return value, perhaps something like Command=$0 arg arg etc. A second idea is a new variable to contain a return value. The second case would be problematical because I couldn't assume that the stack contained a return value, and yet if I wait until the user uses the new variable it might be too late to pop the return value off the stack.<br><br>Of course this isn't an issue for dll functions that set user variables directly rather than use the stack but I don't like them much because they mean you have to program around them in the script remembering always not to use a variable before a call.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">5th August 2002 15:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Added into NSIS 2.0a4. Great work Sunjammer!</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br><span class="post-time small text-muted">5th August 2002 15:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Has anyone other than me tested this yet? Please note that I made it so that this feature is OFF by default so as to minimize any damage it might do were it to be "released" :p</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">CodeSquid</span><br><span class="post-time small text-muted">5th August 2002 15:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I don't see any solution to the return value problem, either, a DLL function may or may not return a value.<br>I'm quite happy with the current way return values are handled, I don't think that it needs to be changed.<br><br>Another thought: Wouldn't it be better to use 'mynsisdir/bin' instead of ''mynsisdir/dlls'? All default extension DLLs are in the bin directory, the dll one does not even exist.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">5th August 2002 15:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">How about just adding an option to set the search path?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br><span class="post-time small text-muted">5th August 2002 16:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">So if I add a command line option to makensis.exe that overrides the search path, and make the default the bin directory that would address both those issues. Speak now or forever hold .. something, or else I'll implement it - tonight probably. (unles KiCHiK beats me to it :igor:)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">5th August 2002 16:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I don't think it should be a command line switch. Just a normal command. The default search path would be the bin directory and you will be able to specify more search paths with the new command.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">CodeSquid</span><br><span class="post-time small text-muted">5th August 2002 17:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I've found two rather annoying bugs.<br><br>First one:<br>Just try to call an extension DLL twice, it will fail.<br>I guess that the DLL will be deleted after the first call and the next time it can't find the DLL.<br><br>Either extract and delete the DLL on Installer start/shutdown (before the first and after the last call) or before and after each call. Mixing this is fatal.<br>Test it using the InstallOptions example and go back and forth several times, the new dialog will only appear once.<br><br>Second one:<br>Extract the attached dll from the attached .zip file to the dlls folder. With CallInstDLL I could call the function extractall, without the compiler can't find this function.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br><span class="post-time small text-muted">5th August 2002 17:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote>Just try to call an extension DLL twice, it will fail.<br>I guess that the DLL will be deleted after the first call and the next time it can't find the DLL.</blockquote>My test case calls the same function 10 times in a row. The dll is not deleted until the installer exits.<br><br><blockquote>Extract the attached dll from the attached .zip file to the dlls folder. With CallInstDLL I could call the function extractall, without the compiler can't find this function.</blockquote>When MakeNSIS ran did it list the function at the top when it was dumping detected plugins? This part of the code is immature, it's not really a bug but the PE/COFF file format (which a binary dll is) is incredibly hard to read so I currently only support my test file which all DLLs probably do not look like.<br><br>The code was meant to be a proof of concept with an adjustment period afterwards, hence my "Has anyone else tested this other than me?" comment, and hence why I didn't make available a compiled version with the code in, and why it defaults to OFF.<br><br>I'll look at these issues later tonight when I get a chance (i'm at work right now). Thanks for attaching the zip.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">CodeSquid</span><br><span class="post-time small text-muted">5th August 2002 19:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">MakeNSIS did not list the function(s) of my dll.<br><br>After some debugging I've found the problem for the function not showing up: In ExternalCommands::GetExports you're reading the offset of the peheader:<br><br>unsigned char peheaderoffset = dlldata[0x3c];<br>Here you assume that the offset is only 1 byte.<br>In fact it is at least 2 bytes long, maybe 4 (I'm not sure)<br>This is how I've fixed this problem:<br>unsigned int peheaderoffset = dlldata[0x3c] + dlldata[0x3d] * 256;<br><br>For the other problem, I've not found a solution. Apparently the InstallOptions example failes after clicking a lot of time on back and next and after a while the dialog does not show up anymore. When using CallInstDLL, I can click hundreds of time on back and next without problems.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br><span class="post-time small text-muted">5th August 2002 19:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks. I've just got home so I'm going to resolve it now.<br><br>[edit]I've added a PluginDir command... word of advice, don't be a stupid muppet like me and test it by saying ...<br><br>PluginDir "c:\winnt\system32\"<br><br>I'm still waiting for it to stop listing functions in dlls :D ... which brings me back to the problem of it not listing your function, odd since it lists all the windows ones without a hitch and all of my own NSIS dlls...[/edit]<br><br>[edit]You said:<br>unsigned char peheaderoffset = dlldata[0x3c];<br>Here you assume that the offset is only 1 byte.<br>In fact it is at least 2 bytes long, maybe 4 (I'm not sure)<br><br>This is a problem for me, because the PE/COFF file format specification is pretty poor and it says nothing about the length of that offset. I think since all other offsets in the format are 4 bytes this one probably is too. Give me some credit, I was writing that code until the small hours :D[/edit]</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br><span class="post-time small text-muted">5th August 2002 20:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">CodeSquid, I've committed to CVS the following :-<br><br>- Fixed a bug in the dll export scanner (spotted and cured by CodeSquid)<br>- Fixed a bug in the installer runtime (spotted by CodeSquid)<br>- Renamed all usage of ExternalCommand to Plugin<br>- Added a compile time PluginDir command<br>- Accidentally enabled NSIS_CONFIG_PLUGIN_SUPPORT by default.. oops. Oh well it can stay like that for now, KiCHiK can decide what to do about that.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">CodeSquid</span><br><span class="post-time small text-muted">5th August 2002 20:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Great news! I've tested it and everything works perfectly.<br><br>Found a small flaw, though: makenssi.dsp still refers to ExternalCommand.cpp instead to Plugin.cpp</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br><span class="post-time small text-muted">5th August 2002 20:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">ROFL I forgot about that, that can be fixed now, at least it wasn't a code issue that time :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">eccles</span><br><span class="post-time small text-muted">5th August 2002 21:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hi Sunjammer,<br><br>I like your idea! I'd personally prefer if it could be done just using the existing NSIS commands, but I understand the problem of not wanting to mess up a user variable.<br><br>Maybe some new variable(s) could be added which are only used internally by auto-generated NSIS commands or something. Bizarre (slightly unrelated) thought - a new NSIS variable which returns the value currently on the top of the stack (say, "$_"? :D ) - whether or not it should pop it in the process, I'm not sure.<br><br>For DLL return values issue, how about something like<br></p><pre>
<code>MyPlugin "x" "y" "z" &gt; $1 $2</code>
</pre><br>--<br>Dave Laundon</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br><span class="post-time small text-muted">5th August 2002 21:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">A lot of what you just said is very similar in to what I said in the second post on the second page of this thread. Take a look at that and then see if you can think of a solution to the problems I mention.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br><span class="post-time small text-muted">5th August 2002 21:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>:: Implemented</strong><br>Implemented CodeSquid's suggested :: syntax to specify which dll contains the comamd to run (in cases where more than one dll has the same command, OR the command is the same name as a built-in command).<br><br>Usage is exactly the same as before unless you wish to be more specific about the dll which contains the command in which case you could say :-<br><br>myInstallOptions.dll::dialog $7</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">eccles</span><br><span class="post-time small text-muted">5th August 2002 21:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I think just the fact that syntax such as "MyPlugin A B C &gt; $1" is being used should be enough to assume that the DLL is going to do the right thing. If the DLL is not designed that way then the script writer should not be using that syntax.<br><br>My rambling about $_ was unrelated to plugin support, but yes, I missed your mention of a "variable to contain a return value". So much on the NSIS board tonight - 'tis a lot to take in :) My idea for $_ would be to be able to use the value on the top of the stack in string expressions without popping it, and it would not be an error to use $_ if the stack is empty, it would just return nothing.<br><br>Anyway, I look forward to see how this all develops!<br><br>Dave.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br><span class="post-time small text-muted">5th August 2002 21:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">There is a problem with the MyPlugin A B C &gt; $1 syntax, how does the compiler know that &gt; and $1 are not validate arguments rather than special syntax. If it always treats that style as special syntax you wouldn't be able to pass those values as arguments.<br><br>This is why I suggested MyPlugin=$1 A B C, that can be detected without any problems (assuming that =$1 is never going to be part of a valid function name). That syntax is a bit odd though, but then most NSIS syntax is odd in my book (closer to assembler than anything else that springs to mind).<br><br>As for $_... I'll think about it :up: (you're not a perl programmer by any chance are you :p)<br><br>[edit]Thinking about it I should probably adopt something like MyPlugin /out=$1 A B C since that syntax already exists in NSIS... again it has the "is this a parameter or flag" problem but this is more standard (in NSIS) at least.[/edit]</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">eccles</span><br><span class="post-time small text-muted">5th August 2002 22:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Agreed about MyPlugin A B C &gt; $1. My only reason for that particular style over yours was the possibility of multiple return values (e.g. PluginX A B C &gt; $1 $2). Perhaps PluginY=$1,$2 A B C. $1,$2=PluginZ A B C would perhaps be more user-friendly, but harder for the compiler to parse I guess?<br><br>Perl? Actually I'm an extreme novice in that department, but if such a variable is ever created, it just seems like an obvious choice :D<br><br>Thinking about it again, it does not add anything that can't be done already, so no need, whereas what you're doing does actually add extra functionality (automatic extraction/clearup of the DLL).<br><br>Dave.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">5th August 2002 22:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">How about Pascal style? Func(parm1, parm2, parm3):$1 $2<br><br>[edit]On second thought, that would ruin the entire assembler look... The script would look corrupted[/edit]</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br><span class="post-time small text-muted">5th August 2002 22:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Yeah the reason I started this thread in the first place was I wasn't sure if I was really adding anything... it does make using an extension dll a lot sweeter, at least until you have to unstack return values (if the function uses the stack).<br><br>The only reason I mentioned perl is that $_ is a well known special perl variable :)<br><br>Pascal style? Eeek looks like I've given people the syntax bug :p</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br><span class="post-time small text-muted">6th August 2002 09:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Documentation</strong><br>Here is a link to a modified version of the makensis.htm that contains information on how to use plugins, both the old CallInstDLL way and my new more automatic way.<br><br><a href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/*checkout*/nsis2k/NSIS/makensis.htm?rev=1.3" target="_blank">http://cvs.sourceforge.net/cgi-bin/v...is.htm?rev=1.3</a><br><br>This is not a final version nor will it necessarily be included in the next release by KiCHiK but it should be useful to some people for now at least.</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>