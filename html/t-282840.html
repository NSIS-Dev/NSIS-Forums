<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="AddSize/SectionSetSize"><title>AddSize/SectionSetSize - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">AddSize/SectionSetSize</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=282840">AddSize/SectionSetSize</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">Merlinovich</span><br><span class="post-time small text-muted">8th December 2007 00:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>AddSize/SectionSetSize</strong><br>I am having some trouble with getting AddSize/SectionSetSize to work. I have seen several posts with people having trouble with these, but none that solved my problem.<br><br>Because of the 2 Gb limit of file size in compression, I am trying to first compress the file I want to install with the 7-Zip package, and then uncompress at runtime with 7za.exe as described in several posts. Now I want to set the size of the section correct, because the FILE command to include the zipped file will only show the compressed size. With AddSize I can do this at compile time as I want, but only with a fixed number. Instead I can do this at runtime with SectionSetSize but it will only use the users environment, which doesn't have the file I'm installing. With ${GetSize} I can get the size of the file, but it seems only at runtime, not compile-time.<br><br>What I want is not to have to code the size with AddSize with a fixed number, because each time I compile, the file name will be the same, but the size might have changed. So I want the expected size to be calculated from the uncompressed file at compile time, and then the installer to reflect the correct size at runtime. Is that possible with NSIS?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">8th December 2007 11:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Calculate it at "runtime" by executing another installer in compile time.<br><br><a href="http://nsis.sourceforge.net/Invoking_NSIS_run-time_commands_on_compile-time" target="_blank">http://nsis.sourceforge.net/Invoking...n_compile-time</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Merlinovich</span><br><span class="post-time small text-muted">10th December 2007 17:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Include big files (&gt; 2 Gb) with 7z compression</strong><br>Thanks for pushing me in the right direction, kichik! This shows once again what a versatile package NSIS is. Too bad that it can't compress bigger files than 2 Gb though. Those who get the #12345 error mmapping, you know who you are! This happens with files smaller than 2 Gb though. Mine was 1.6 Gb. Also note that this way of doing things also has the advantage of making a quicker main compilation, especially when making changes to it, because it doesn't need to make a full compression from scratch of the big file.<br><br>For the record if anybody wants the solution I came up with, here is the outline:<br><br>First you download both the 7-zip package and then the 7-zip Command line version (they are separate downloads) from<br><br><a href="http://www.7-zip.org/download.html" target="_blank">http://www.7-zip.org/download.html</a><br><br>Then you compress the file(s) you want to include, e.g. IWIS3-GMS.mdb to IWIS3-GMS.7z with the Windows interface of 7-zip (well, there are also Linux version I guess). And then you create a script to get the file size at compile time (this program creates an EXE, needs to be compiled only once, and the EXE will be run from the main script). 7za.exe is the command line unzipper.<br><br>This is GetDBsize.nsi:<br><br>!define FileGMS "C:\ICIS5\Database\IWIS3\Central\IWIS3-DMS.mdb"<br>!include "FileFunc.nsh"<br>!insertmacro GetSize<br><br>OutFile "GetDBsize.exe"<br>SilentInstall silent<br><br>Section<br>## Write it to a !define for use in main script<br>FileOpen $R0 "$EXEDIR\GetDBsize.txt" w<br>; Get Database Size DMS<br>${GetSize} "C:\ICIS5\Database\IWIS3\Central" "/M=IWIS3-DMS.mdb /S=0K /G=0" $0 $1 $2<br>FileWrite $R0 '!define SizeDMS "$0"$\r$\n'<br>FileClose $R0<br>SectionEnd<br><br>Compile it to produce GetDBsize.exe<br><br>Then the main script:<br><br>SetCompressor lzma<br><br>!system "GetDBsize.exe"<br>!include "GetDBsize.txt"<br>...<br>Function .onInit<br>; Change the section size here<br>SectionSetSize InstDMS ${SizeDMS}<br>...<br>FunctionEnd<br><br>Section "Install IWIS3 DMS database" InstDMS<br>SETOUTPATH $INSTDIR<br>File "C:\Program Files\7-Zip\7za.exe"<br>SETOUTPATH $INSTDIR\Database\IWIS3\Central<br>File C:\ICIS5\Database\IWIS3\Central\IWIS3-DMS.7z<br>nsExec::ExecToLog /OEM '"$INSTDIR\7za.exe" x "$INSTDIR\Database\IWIS3\Central\IWIS3-DMS.7z" -o"$INSTDIR\Database\IWIS3\Central"'<br>Delete $INSTDIR\Database\IWIS3\Central\IWIS3-DMS.7z<br>Delete $INSTDIR\7za.exe<br>SectionEnd<br>...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Merlinovich</span><br><span class="post-time small text-muted">18th December 2007 23:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I found a few bugs in the script above. The correct code for changing section size should be<br><br>SectionSetSize ${InstDMS} "${SizeDMS}"<br>not<br>SectionSetSize InstDMS ${SizeDMS}<br><br>and also it seems to be important that .onInit section is placed *after* the section(s) it tries to change the size of in the script, in this example section .onInit should be after section InstDMS. Otherwise all the section sizes will be zero.</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script type="text/javascript" src="../js/highlight.pack.js" async></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>