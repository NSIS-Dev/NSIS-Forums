<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Using UAC.dll based on folder selected and OS"><title>Using UAC.dll based on folder selected and OS - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Using UAC.dll based on folder selected and OS</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=327927">Using UAC.dll based on folder selected and OS</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">divyaa</span><br><span class="post-time small text-muted">28th February 2011 13:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Using UAC.dll based on folder selected and OS</strong><br>I have an installer which needs to prompt for Admin User Name and Password only in case the OS(Vista/Win7...etc) requires this for Program Files. If the user changes the install location to some other folder, then this prompt should not come up.<br><br>What I am trying to say is I need to elevate the user level only in case the selected folder is Program Files and only if the OS needs it.<br><br>I have gone through the NSIS Wiki, and this forum :confused:but am not able to find a working solution.<br><br>I always end up getting -&gt; Unable to elevate, error .<br><br>I would really appreciate if someone has a working example, or some ideas on how to achieve this, as this is really blocking my work.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">28th February 2011 14:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">What you are requesting does not make sense:<br><br>1) 2000/XP/2003 should also prompt for username/pwd since you can't write to ProgramFiles as a standard user<br><br>2) Where would you store uninstall info? HKLM or HKCU, just based on installdir?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">1st March 2011 08:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Actually what he's requesting does make sense. If you recall, that's exactly what I did using your plugin. And as I recall, you correctly noted that that is not what the plugin is designed for. :)<br><br>divyaa, what you want to do is not easy at all, because you'll run into a lot of issues that are not trivial to overcome. Here's what I ended up doing:<br>1) Call for elevation only when the user does something that will require admin.<br>2) Upon elevation, make the inner instance synchronize all important variables and component states. Then jump to the page that the user elevated from.<br>3) Be careful not to mix up userlevel (HKCU) and adminlevel (HKLM) installs! It's one of the two, never both. Probably the only case where you may mix them is if you need admin to grant alluser access on a directory, but still want a userlevel install.<br><br>Things to take into account:<br>- To test if a directory is writable, use: <a href="http://forums.winamp.com/showthread.php?t=317018" target="_blank">http://forums.winamp.com/showthread.php?t=317018</a><br>- I had trouble hiding the outer instance after elevation from an installer page. Solution: <a href="http://nsis.pastebin.com/hY8zmviQ" target="_blank">http://nsis.pastebin.com/hY8zmviQ</a><br>- Page skipping into a conditional page (custom page code with an ${If} clause) is a disaster. Solution: <a href="http://forums.winamp.com/showthread.php?t=316154" target="_blank">http://forums.winamp.com/showthread.php?t=316154</a><br>- Mixed mode installation is easy, using the UAC plugin. Mixed mode UNinstallation is more difficult, because when uninstall is run from ARP it will automatically elevate, no matter what executionlevel is requested. Solution: <a href="http://forums.winamp.com/showthread.php?t=277801" target="_blank">http://forums.winamp.com/showthread.php?t=277801</a><br><br>Kudos to the guru: Most of these tricks are inspired by Anders. :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">1st March 2011 14:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">No it does not make sense, changing from single user to all user install just based on the destination directory is crazy! But yeah, I never said it was not possible.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">1st March 2011 15:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Heh, I suppose that much is true. But using a fully mixedmode installer I can still do userlevel singleuser installation even after elevation. You just have to jump through a lot more hoops to get the installation script working properly. (Basically the installer ends up circumventing folder protection, while otherwise staying userlevel.)<br><br>And on the other hand, the 'elevate only for admin tasks' concept is very user-friendly, and I'm happy that more and more applications are starting to support it. It doesn't really work the same way for installers, but I think I got pretty close, from an end-user's perspective.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">divyaa</span><br><span class="post-time small text-muted">3rd March 2011 06:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks for your time and replies.<br><br>I might have confused in posting the question. I agree that the solution should be independent of OS type. Restating the actual problem again,<br><br>Need to elevate to admin, only if user has chosen the InstallDir as Program Files, otherwise, need to run normally.<br><br>Also, would store the uninstall info in HKLM.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">3rd March 2011 09:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Ok, now you're really not making sense. You cannot store in HKLM without elevation, because you cannot store in HKLM without admin access. If you want an all-user install (that is the same thing as an HKLM install), you must always make sure you have admin rights.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">poiru</span><br><span class="post-time small text-muted">3rd March 2011 18:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You should present users with a Portable and Standard install checkboxes, instead of guessing what they're trying to do from the path.<br><br>If you want a working example, check the Rainmeter installer. Source are available at <a href="http://code.google.com/p/rainmeter/source/browse/trunk/Install/Installer.nsi" target="_blank">http://code.google.com/p/rainmeter/s.../Installer.nsi</a><br><br>Not pretty, but it works fine on all systems.</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>