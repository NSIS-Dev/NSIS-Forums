<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Detect Internet Connection's Speed?" />

  <title>Detect Internet Connection's Speed? - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Detect Internet Connection's Speed?</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=262554">Detect Internet Connection's Speed?</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">27th December 2006 18:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Detect Internet Connection's Speed?</strong><br />
      I've found a precious piece of code by kichik <a href="http://forums.winamp.com/showthread.php?s=&amp;threadid=195301" target="_blank">on this forum thread</a> and I use it to detect If target system is connected.<br />
      I know that <a href="http://nsis.sourceforge.net/Inetc_plug-in" target="_blank">Inetc plugin</a> while downloading shows info about speed, remaining time etc.<br />
      What I want is to show some exclusive info about the estimated download time with current connection just before the actual download process is going to start. Since I know a little about APIs, I only guess that it should be possible with system plugin, and I wonder if someone from the community has achieved such a thing.<br />
      Thanks</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Takhir</span><br />
      <span class="post-time small text-muted">27th December 2006 19:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You can get connection type with InternetGetConnectedState <a href="http://forums.winamp.com/showthread.php?postid=1494691" target="_blank">http://forums.winamp.com/showthread.php?postid=1494691</a></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">27th December 2006 20:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by Takhir</i><br />
        <b>You can get connection type with InternetGetConnectedState <a href="http://forums.winamp.com/showthread.php?postid=1494691" target="_blank">http://forums.winamp.com/showthread.php?postid=1494691</a></b>
      </blockquote>Takhir thanks for the response!<br />
      I tried it and it returns an empty string! I don't know why...<br />
      I use kichik's function, the one I mentioned above, I have just replaced google with the actual server where I'm going to connect, and this is always successful. When I remove the network cable it detects no connection, when I set the cable back, successfully detects connection, when I block my pc with the firewall it detects no connection, and so on. I tested this function 100 times and always I'm getting true results.<br />
      Anyway this is not the point. This has been achieved. As I mentioned, I'd like to show some exclusive info to the end user, so, the point is if there is a function that somehow detects the speed of the connection before Inetc starts downloading, and not if there is connection. :-)
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Takhir</span><br />
      <span class="post-time small text-muted">28th December 2006 09:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Just to keep you informed :)</p>
      <pre>
<code><br />System::Call 'wininet.dll::InternetGetConnectedState(*i .r0, i 0) i.r1'<br />MessageBox MB_OK "$1 $0 Modem=1, LAN=2, Proxy=4, RAS=0x10, Offline=0x20 Configured=0x40"</code>
</pre>shows 18 - LAN and INTERNET_RAS_INSTALLED.<br />
      The only way to test performance is to download a file (silent). GetTickCount() returnes ms. Bigger file - higher precision, but more time for customer to press all buttons ;)
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">28th December 2006 11:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Great!<br />
      The code that you've posted above works as it expected!<br />
      In the envirenment that I'm currently running, it returns "1 18". I guess is means Modem and LAN and INTERNET_RAS_INSTALLED.<br />
      Perhaps you know what it returns when detects a single dial up modem?<br />
      I'm asking this because I'm thinking that probably these info are enough. When a dial up modem is detected, I could inform users that depending on modem speed, the download would need aprox. &lt;time&gt;, when a Lan/dsl is detected, then there is not need for extra info, they will see the actual download speed from Inetc.<br />
      Thanks in advance!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Takhir</span><br />
      <span class="post-time small text-muted">28th December 2006 12:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">No, function returns $1 and 1 means "state is connected" (MSDN). 18 is 0x12 that means presisely LAN + RAS. You should use 'and' to get modem bit: IntOp $0 $0 &amp; 1</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">28th December 2006 13:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Takhir thanks a lot!<br />
      Now I think I got it :-) I had to make various tests by enable/disable proxy, plug/unplug, etc, and use IntFmt to get it :-)<br />
      Now what I have is the following, please could you confirm that I'm in the right direction?<br /></p>
      <pre>
<code>System::Call 'wininet.dll::InternetGetConnectedState(*i .r0, i 0) i.r1'<br />Detailprint '$$1==$1 (connected state)'<br />; When plugged at this point $1 = 1<br />; When plugged+proxy at this point $1 = 1<br />; When unplugged at this point $1 = 0<br /><br />Detailprint '$$0==$0 (connection)'<br />; When plugged at this point $0 = 18<br />; When plugged+proxy at this point $0 = 86<br />; When unplugged at this point $0 = 16<br /><br />IntFmt $R1 "0x%X" "$0"<br />Detailprint '$$R1==$R1 (connection in hex)'<br />; When plugged at this point $R1 = 0x12<br />; When plugged+proxy at this point $R1 = 0x56<br />; When unplugged at this point $R1 = 0x10<br /><br />IntOp $R0 $0 &amp; 1<br />Detailprint '$$R0==$R0 (modem bit)'<br />; When plugged at this point $R0 = 0<br />; When plugged+proxy at this point $R0 = 0<br />; When unplugged at this point $R0 = 0</code>
</pre><br />
      Thanks in advance!
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">29th December 2006 09:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well, I was running the above code several times and I think this is all what I need.<br />
      With this code, I'm able to achieve my plan in a very single step.<br />
      Checking var $1 would tell me that the target is connected, in combination with var $R0, I would capture if the connection is lan or a dial up modem.<br />
      I guess the only thing I need further confirm is to find a pc with modem installed and check the accuracy of the code in that environment.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">31st December 2006 13:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well, the code works accurately on both environments LAN/Dial up modem :-)<br />
      Thank you very much Takhir!<br />
      <br />
      Ð¡ ÐÐžÐ’Ð«Ðœ Ð“ÐžÐ”ÐžÐœ</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Takhir</span><br />
      <span class="post-time small text-muted">31st December 2006 14:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks Major Dude ;)<br />
      eftikhes to neon ethos (may be a bit early, Greece and Russia selebrate both January 1 and 14 :) )<br />
      The only remaining question is default connection and how to use the fast one from Inetc ...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">31st December 2006 15:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Yes... a newbie Major Dude :-)<br /></p>

      <blockquote>
        eftikhes to neon ethos (may be a bit early, Greece and Russia selebrate both January 1 and 14)
      </blockquote>This isn't so bad :-) It is only that we need 2 bottles of vodka when we're going to celebrate twice :-)<br />
      <br />
      <br />

      <blockquote>
        The only remaining question is default connection and how to use the fast one from Inetc ...
      </blockquote>I really stuck on this, I can't figure it out.<br />
      Though, I have to assume that a normal user who has both connections, would never use as default connection the dial up, normally, would use as default the fast one, leaving the dial up just for cases when the fast connection is disabled.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Takhir</span><br />
      <span class="post-time small text-muted">31st December 2006 18:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        Though, I have to assume that a normal user who has both connections, would never use as default connection the dial up, normally, would use as default the fast one, leaving the dial up just for cases when the fast connection is disabled.
      </blockquote>This case might be better to check LAN bit in the code function returned ;) It gives you fastest interface. You can supose it is default. And to check modem bit otherwise.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">1st January 2007 09:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        This case might be better to check LAN bit in the code function returned It gives you fastest interface. You can suppose it is default. And to check modem bit otherwise.
      </blockquote>Obviously this is the right way to go, hopefully I wouldn't meet the weird case when a dial up connection is defined as default/always dial. (Case Internet properties/connections "always dial my default connection" radiobutton is checked.)<br />
      In both other cases "never dial a connection" radiobutton or "dial whenever a network connection is not present" radiobutton, the LAN bit is detected.
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
