<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="In 64bit installer AccessControl fail to set registry permission"><title>In 64bit installer AccessControl fail to set registry permission - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">In 64bit installer AccessControl fail to set registry permission</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=340774">In 64bit installer AccessControl fail to set registry permission</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">rijukk</span><br><span class="post-time small text-muted">17th January 2012 16:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>In 64bit installer AccessControl fail to set registry permission</strong><br>I was using NSIS AccessControl plug-in to grant registry access permission<br><br></p><blockquote>AccessControl::GrantOnRegKey HKLM "Software\Demo" "(S-1-5-20)" "FullAccess" ;"NETWORK SERVICE"</blockquote>It was working perfect, now I upgraded my installer to 64bit using "x64.nsh"'s ${RunningX64}<br>and SetRegView 64<br><br>Now<br><blockquote>AccessControl::GrantOnRegKey HKLM "Software\Demo" "(S-1-5-20)" "FullAccess"</blockquote>it fail to grant permission; however i create a key in redirected node (Wow6432Node) like HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Demo. It providing proper grant permission.<br><br>Any help will be greatly appreciated<br><br>Thank you,<br>Riju</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">T.Slappy</span><br><span class="post-time small text-muted">18th January 2012 06:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Are you running 32bit application on x64 machine?<br>If yes then this situation is correct because 32bit applications use Wow6432Node in Registry.<br><br>Your assumption is wrong:<br></p><blockquote>by I upgraded my installer to 64bit using "x64.nsh"'s ${RunningX64}</blockquote>Creating 64bit installer is possible only by recompiling NSIS as 64bit application.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">rijukk</span><br><span class="post-time small text-muted">18th January 2012 07:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hi T. Slappy,<br><br>I am upgrading the installer script with guideline provided in this link<br><a href="http://bojan-komazec.blogspot.com/2011/10/nsis-installer-for-64-bit-windows.html" target="_blank">http://bojan-komazec.blogspot.com/20...t-windows.html</a><br><br><br><br>I am able to read\write registry from HKLM\Software\Demo after using <b><font color="red">"SetRegView 64"</font></b>.<br><br></p><blockquote>; disable registry redirection (enable access to 64-bit portion of registry)<br>SetRegView 64</blockquote>Only registry fails on<br><blockquote>AccessControl::GrantOnRegKey HKLM "SOFTWARE\Demo" "(S-1-5-20)" "FullAccess"</blockquote>my installer is working perfectly in 64bit PC without any other issues<br><br><br>Thank you,<br>Riju</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">18th January 2012 09:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Could it be that the AccessControl plugin cannot handle x64 registry yet?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">18th January 2012 10:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Could it be that the AccessControl plugin doesn't support x64 registry yet?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">18th January 2012 19:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">AccessControl plug-in needs updating to handle SetRegView. I will do it when I have some time (maybe tomorrow).<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">rijukk</span><br><span class="post-time small text-muted">19th January 2012 05:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hi Stu,<br><br>So nice of you :)<br><br>Thank you,<br>Riju</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">rijukk</span><br><span class="post-time small text-muted">23rd January 2012 05:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">What i read from internet in order to accomplish this; we need to use advapi32.dll's RegSetKeySecurity in the AccessControl plugin.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">25th January 2012 23:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">It took a little longer than expected due to SetNamedSecurityInfo/GetNamedSecurityInfo complete lack of support for KEY_WOW64_64KEY (as you pointed out) so a lot of the code had to be changed quite drastically. It may also mean the plug-in will no longer work on Windows 2000, but we may have to live with that.<br><br><b>v1.0.5.0 - 25th January 2012 ~ Afrow UK</b></p><ul><li>Removed IsUserTheAdministrator.</li><li>Added NameToSid.</li><li>Major code cleanup/rewrite.</li><li>Proper Unicode build (with Unicode plugin API).</li><li>Support for 64-bit registry (SetRegView 64).</li><li>Functions now return "ok" on success or "error" otherwise. On "error", the next item on the stack will be the error description.</li><li>Added version information resource.</li></ul>Edit: I removed IsUserTheAdministrator because you can quite easily test for that yourself using the new NameToSid. Just check the result of NameToSid ends with -500.<br><br>Stu</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">26th January 2012 00:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by Afrow UK</small><br>It may also mean the plug-in will no longer work on Windows 2000, but we may have to live with that.</blockquote>IMHO the Ansi version needs to support NT4/Win95 (I don't know what the old behavior was but it can just return ok on 9x) and the unicode build 2000+ (It is unclear at this point if NT4 will be supported as unicode)</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">26th January 2012 11:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">When was ConvertSidToStringSid/ConvertStringSidToSid added to Windows? The plug-in has been using those for some time. Now it's using RegOpenKeyEx as well.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">26th January 2012 11:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">RegOpenKeyEx was added in Win95/NT4 IIRC and I don't remember off the top of my head but I'm guessing ConvertSidToStringSid was added in 2000 (You cannot trust MSDN, you must check the dll exports)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">26th January 2012 12:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">How about RegSetKeySecurity? I will look into writing replacements for ConvertSidToStringSid/ConvertStringSidToSid.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">26th January 2012 17:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><b>v1.0.6.0 - 26th January 2012 - Afrow UK</b></p><ul><li>Wrote replacements for ConvertSidToStringSid/ConvertStringSidToSid for backwards compatibility with Windows NT4/ME (ANSI build only).</li><li>Loads RegSetKeySecurity/RegGetKeySecurity functions at run-time for backwards compatibility with Windows NT4/ME (ANSI build only).</li><li>Removed commented out legacy code.</li></ul>Note that RegSetKeySecurity/RegGetKeySecurity is only used when SetRegView 64 is set.<br><br><a href="http://nsis.sourceforge.net/AccessControl_plug-in" target="_blank">http://nsis.sourceforge.net/AccessControl_plug-in</a><br><br>Stu</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">26th January 2012 18:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hate to be a nagger, but... Wasn't NT4 also unicode? Not that I feel strongly about NT4 support one way or the other, but yeah.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">26th January 2012 19:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">As Anders says I don't think Unicode NSIS supports below Windows 2000 anyway so there is no point the Unicode plug-in doing so.<br><br>Edit: If someone needs the Unicode build for NT4 they can just rebuild with ACCESS_CONTROL_NT4 preprocessor directive. Otherwise the Unicode build links to the native Windows 2000+ API's to save on code size.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">26th January 2012 22:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I did not check out the code yet but I hope you are only going down the wow64 path on NT5.2+, I don't know what happens if you pass the WOW64 flag to older registry functions...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">27th January 2012 00:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">According to MSDN KEY_WOW64_64KEY is ignored on 32-bit Windows (and Windows 2000) so I assume that means older versions of Windows too. The registry functions are only used if SetRegView 64 is set but I suppose a test for a 64-bit OS would be good too.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">rijukk</span><br><span class="post-time small text-muted">2nd February 2012 16:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><b>Thank you</b> Stu... i will test it tomorrow and let you know the feedbacks<br><br>Riju</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kalverson</span><br><span class="post-time small text-muted">8th February 2012 20:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by T.Slappy</small><br>Are you running 32bit application on x64 machine?<br>If yes then this situation is correct because 32bit applications use Wow6432Node in Registry.<br><br>Your assumption is wrong:<br><br>Creating 64bit installer is possible only by recompiling NSIS as 64bit application.</blockquote>Is there a NSIS 64 bit compiled engine/install available somewhere for download?</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">8th February 2012 20:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">No. Why do you need it?<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">9th February 2012 15:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by Afrow UK</small><br>No. Why do you need it?<br><br>Stu</blockquote>Server Core :(</div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>