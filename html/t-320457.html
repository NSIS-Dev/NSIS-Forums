<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Uninstall fails under Windows 7"><title>Uninstall fails under Windows 7 - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Uninstall fails under Windows 7</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=320457">Uninstall fails under Windows 7</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">hürnen</span><br><span class="post-time small text-muted">1st July 2010 13:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Uninstall fails under Windows 7</strong><br>Hi<br><br>I created an installer which runs just fine. I installed the application as standard user under Windows 7 into the suggested installation directory C:\Users\testUser\AppData\Local\MyApp.<br>Now I'd like to uninstall the application. The summary page shows the following:<br><br><font face="Courier New">Delete file: C:\Users\testUser\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\MyApp\Uninstall MyApp.lnk<br>Delete file: C:\Users\testUser\AppData\Local\MyApp\uninstall.exe<br>Delete on reboot: C:\Users\testUser\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\MyApp<br>Delete on reboot: C:\Users\testUser\AppData\Local\MyApp\<br>Completed</font><br><br>Basically, only the uninstall.exe and the short cut in the start menu referring to the uninstaller are removed. The whole application remains there - even after a reboot.<br>However, all the files can be manually removed without any problem.<br><br>Additional information:<br>The execution level in the nsis-script is set to:<br>!define MULTIUSER_EXECUTIONLEVEL Highest<br><br>The same procedure works as expected under Windows Vista.<br><br>Anybody knows what's going on here?<br><br>Thanks<br>Remo</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">1st July 2010 13:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Where are your program files stored?<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">hürnen</span><br><span class="post-time small text-muted">1st July 2010 15:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I'm not sure whether I understand your question correctly, but the program files are stored under C:\Users\testUser\AppData\Local\MyApp, that's the default installation path NSIS suggests when the installer is executed as standard user.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">1st July 2010 15:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Yes that's what I meant. How about doing some test on $INSTDIR. Try writing to it using FileOpen and see what happens. Either the path is wrong or you do not have write access.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">hürnen</span><br><span class="post-time small text-muted">1st July 2010 16:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The installer does edit some files in $INSTDIR during installation, which works well. You mean I should try to edit files in the uninstaller?<br>What's the execution level requested by the uninstaller? The same that I specified for the installer? Or can / should I also specify one for the uninstaller?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">1st July 2010 20:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">RequestExecutionLevel puts the manifest in both the installer and uninstaller. Yes, see if you can write to $INSTDIR in the uninstaller. Also check $INSTDIR is correct (i.e. MessageBox)<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">hürnen</span><br><span class="post-time small text-muted">2nd July 2010 07:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I added the following to section -un.post:<br><br><font face="Courier New">FileOpen $0 $INSTDIR\file.dat w<br>FileClose $0<br>MessageBox MB_OK "$INSTDIR\file.dat"<br>Delete $INSTDIR\file.dat</font><br><br>As expected, the file is being written to C:\Users\testUser\AppData\Local\MyApp, the message box with C:\Users\testUser\AppData\Local\MyApp\file.dat is shown and the file is removed afterwards.<br><br>I still have no clue why the other files cannot be removed by the uninstaller. According to the file properties (security tab), the current user has full rights on all of them.<br>And again, the same installer/uninstaller runs perfectly well under Windows Vista.<br><br>Thanks for further help<br>Remo</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">2nd July 2010 10:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Try a ClearErrors before a Delete instruction then check if the error flag is set afterwards. Also have you tried manually deleting the files?<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">hürnen</span><br><span class="post-time small text-muted">2nd July 2010 12:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Stu, as I mentioned in my first post, all the files can be deleted manually. But I tried your suggestion. The error flag is not set after trying to execute<br><br><font face="Courier New">RmDir /REBOOTOK $INSTDIR</font><br><br>Further ideas?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">2nd July 2010 12:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Try with /r ?<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">hürnen</span><br><span class="post-time small text-muted">2nd July 2010 12:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Yep that's it!<br>I created the NSIS script with an eclipse wizard. Strange that it didn't generate a /r. But also: why did it work with Vista?<br><br>Anyway, thanks for your help!</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">2nd July 2010 13:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">note: It is extremely dangerous to use RmDir /r. If your $INSTDIR happens to be, say, Program Files, you will do massive damage to the user's OS. You should not use RmDir /r. You should only delete the files you KNOW you want to delete.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">hürnen</span><br><span class="post-time small text-muted">2nd July 2010 15:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">That's a good point. But you don't want to explicitly enumerate every single file in your installer/uninstaller, do you?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">2nd July 2010 18:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">No but you should really only delete exactly what you know you've installed and nothing else. I was only suggesting trying /r to fix your problem but as MSG says it is not a solution for uninstalling.<br><br>You can do checks on $INSTDIR like this demonstrates (maybe a bit over the top though looking at it now):<br><a href="http://nsis.sourceforge.net/Validating_$INSTDIR_before_uninstall" target="_blank">http://nsis.sourceforge.net/Validati...fore_uninstall</a><br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">2nd July 2010 21:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by hürnen</small><br>That's a good point. But you don't want to explicitly enumerate every single file in your installer/uninstaller, do you?</blockquote>Actually I would say 'yes' to this. Even if there's hundreds of them, safety comes first in my opinion.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Animaether</span><br><span class="post-time small text-muted">3rd July 2010 00:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by hürnen</small><br>That's a good point. But you don't want to explicitly enumerate every single file in your installer/uninstaller, do you?</blockquote>There -are- headers that help you with this...<br><br><a href="http://nsis.sourceforge.net/Uninstall_only_installed_files" target="_blank">http://nsis.sourceforge.net/Uninstal...nstalled_files</a><br>Uses custom file manipulation macros and records them as you go.<br>( we use a similar but more flexible technique so that File /r and File with wildcards can still be used, which also keeps track of registry keys and such.. messy, though )<br><br><a href="http://nsis.sourceforge.net/Advanced_Uninstall_Log_NSIS_Header" target="_blank">http://nsis.sourceforge.net/Advanced...og_NSIS_Header</a><br>Uses file enumeration -before- installation and -after- installation, and records the difference. This works with File /r and File with wildcards, but incurs either a small or a large hit depending on how long it takes to enumerate your target folder.<br>( in our case, an add-on for a larger program which carries thousands of files and enumeration, if the OS didn't have anything cached yet, was simply too slow )<br><br>I also started a new header for exactly this sort of thing, as well as handling backing up of existing files, etc. But it's a right pain to write (it's been collecting dust as other priorities have taken over); although perhaps trying to do everything with defines to keep compiled code as clean as possible may be the wrong approach. I still think a pre-file write and post-file write callback within NSIS would be great.</div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>