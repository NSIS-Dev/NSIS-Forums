<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="EnvVarUpdate.nsh and WM_WININICHANGE timeout" />

  <title>EnvVarUpdate.nsh and WM_WININICHANGE timeout - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">EnvVarUpdate.nsh and WM_WININICHANGE timeout</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=299969">EnvVarUpdate.nsh and WM_WININICHANGE timeout</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ghennessey</span><br />
      <span class="post-time small text-muted">15th November 2008 21:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>EnvVarUpdate.nsh and WM_WININICHANGE timeout</strong><br />
      The following line of code in EnvVarUpdate.nsh hangs up my installer until the timeout is hit:<br />
      <br />
      SendMessage ${HWND_BROADCAST} ${WM_WININICHANGE} 0 "STR:Environment" /TIMEOUT=5000<br />
      <br />
      If I comment this line out, everything seems to work fine, and there is no delay - I suspect this is for older operating systems. I'm working on a Windows 2003 server (the installer is for server software). I'm using NSIS 2.40.<br />
      <br />
      Can this line be safely removed, or is there some fix?<br />
      <br />
      I'm calling the function using:<br />
      <br />
      ${EnvVarUpdate} $0 "PATH" "A" "HKLM" "$INSTDIR\lib"<br />
      <br />
      Thanks,<br />
      <br />
      Geoff.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">15th November 2008 21:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If you remove it, changes will only take effect after reboot.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ghennessey</span><br />
      <span class="post-time small text-muted">15th November 2008 21:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for the quick reply.<br />
      <br />
      The changes seem to take without a reboot on Server 2003 - at least when I go to 'Control Panel - System' and look at the environment variables it's there after running the installer.<br />
      <br />
      WM_WININICHANGE seems to have been retired in newer Windows systems:<br />
      <br />
      <a href="http://msdn.microsoft.com/en-us/library/ms725499.aspx" target="_blank">http://msdn.microsoft.com/en-us/library/ms725499.aspx</a><br />
      <br />
      I tried sending a WM_SETTINGCHANGE instead and it didn't hang up, although I'm not sure how to verify if it's working, as the change takes regardless. I'm not sure about my syntax either:<br />
      <br />
      SendMessage ${HWND_BROADCAST} ${WM_SETTINGCHANGE} 0 "STR:Environment" /TIMEOUT=5000<br />
      <br />
      Is there a way in NSIS to tell which operating system is in use, and filter the message appropriately?<br />
      <br />
      Thanks,<br />
      <br />
      Geoff.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">15th November 2008 21:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The changes will appear in the control panel but if you open up a new command shell and test it you should see it won't take effect until you reboot or use the control panel to apply the change.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ghennessey</span><br />
      <span class="post-time small text-muted">15th November 2008 22:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Yes, you're right, the changes don't show up properly when I open a new command shell.<br />
      <br />
      WM_SETTINGCHANGE also doesn't solve the problem after all, in that it still hangs up. It seemed to be working initially, but it's not anymore. I must have made a mistake and not saved the included file.<br />
      <br />
      If I reduce the timeout to 250, the wait is much shorter, and the changes take - they show up in a new command prompt window. Do you know what the timeout is waiting for?<br />
      <br />
      Thanks,<br />
      <br />
      Geoff.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">15th November 2008 22:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The timeout is waiting for one of the programs in your system which is not responding. It might be busy or it might have some sort of a bug preventing it from responding in time.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ghennessey</span><br />
      <span class="post-time small text-muted">15th November 2008 22:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That was it exactly - there was an unresponsive IEXPLORE.EXE running in the background. After rebooting, no problem with the installer hanging up.<br />
      <br />
      Is a /TIMEOUT=0 valid? Basically to say, I don't care if all the programs respond to the change, just send the message and move on? I tried it and it seems to work - a new command prompt window reflects the change.<br />
      <br />
      Thanks,<br />
      <br />
      Geoff.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">15th November 2008 23:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">/TIMEOUT=0 is invalid and will act exactly as a normal SendMessage and this means completely synchronous. That means if you get a non responding program, there will be no timeout. If you don't mind for non responding programs, use a very small timeout, but not 0.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ghennessey</span><br />
      <span class="post-time small text-muted">15th November 2008 23:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Good to know! Thanks for all your help today, it's been invaluable.<br />
      <br />
      Geoff.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
