<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Reading variables from file unseen in sections." />

  <title>Reading variables from file unseen in sections. - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Reading variables from file unseen in sections.</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=345267">Reading variables from file unseen in sections.</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">eredhal</span><br />
      <span class="post-time small text-muted">31st May 2012 10:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Reading variables from file unseen in sections.</strong><br />
      Hello, for some time already im using NSIS. Since now i used only hardcodded method for names and paths for the installation. Now i wanted to make universal installtion with config file, for names in my installation file. Sadly i got big issue with some variables.<br />
      <br />
      Thats what i do :<br /></p>
      <pre>
<code><br />MainFile.nsh<br />Name $AppName<br />!define APP_NAME $(^Name)<br />!define COMPANYNAME $CompanyName<br />Function .onInit<br />        ClearErrors<br />        Delete $TEMP\Company\install.log<br />        InitPluginsDir<br />        Push $R1<br />    File /oname=$PLUGINSDIR\spltmp.bmp "${NSISDIR}\Contrib\Graphics\Header\splash.bmp"<br />    advsplash::show 1000 600 400 -1 $PLUGINSDIR\spltmp<br />    Pop $R1<br />    Pop $R1<br />    !insertmacro MULTIUSER_INIT<br />        Iffileexists "$EXEDIR\setup.ini" 0 onInitNoFile<br />        !insertmacro "ReadSetupINI"<br />        CreateDirectory "$INSTDIR\$(^Name)"<br />        !insertmacro Logger "INFO" "Installation started, reading setup.ini"<br />        Iferrors 0 onInitSetLang<br />        !insertmacro Logger "INFO" "Setup.ini read cause an error."<br />        Goto onInitSetLang<br />        onInitNoFile:<br />        !insertmacro Logger "ERROR" "Setup.ini file doesn't exist loading default values"<br />        onInitSetLang:<br />        ${SetLanguage} $Lang<br />        StrCpy $LiczSerial "1"<br />        !insertmacro Logger "INFO" "Language has been set up to $Lang($LANGUAGE)"<br />        !insertmacro Logger "INFO" "Initialisation complete, proceed with user interface."<br />FunctionEnd<br /></code>
</pre><br />
      Thats where i want to read setup.ini, macroes(shorten) :<br />
      <pre>
<code>!define ReadSetupini "!insertmacro ReadSetupini"<br />!macro ReadSetupini<br />Clearerrors<br />${ReadSetupKey} $R0 "Startup" "CompanyName" "CompanyName"<br />${ReadSetupKey} $R0 "Startup" "Appname" "AppName"<br />${ReadSetupKey} $R0 "Startup" "ProductGUID"  "ProductGUID"<br />${ReadSetupKey} $R0 "Languages" "Default" "Lang"<br />!macroend</code>
</pre><br />
      <br />
      <pre>
<code>!define ReadSetupKey "!insertmacro ReadSetupKey"<br />!macro ReadSetupKey Var Sect Key Def<br />   ClearErrors<br />   ReadINIStr ${Var} ${SETUP_INI} ${Sect} ${Key}<br />   Var /GLOBAL ${Def} <br />   StrCpy $${Def} "${Var}"<br />   StrCmpS "${Key}" "CompanyName" "${Key}jump" 0<br />   !insertmacro Logger "INFO" "Setup.ini: Definition ${Def} is set to ${Var}"<br />   Goto "${Key}jumpend"<br />   ${Key}jump:<br />   StrCmpS $CompanyName "" 0 +2<br />   StrCpy $CompanyName "Ontia"<br />   CreateDirectory $TEMP\$CompanyName<br />   !insertmacro Logger "INFO" "Setup.ini: Definition of ${Def} wasn't set up properly, using default value"<br />   ${Key}jumpend:<br />!macroend</code>
</pre><br />
      <br />
      <br />
      For what i see, when i copy $AppName into (^Name) i can use it anywhere. However, when i get $CompanyName from a file i can use it only in .onInit. When i get into first Section and then i call Macro Logger, it shows that $CompanyName is empty(returns $CompanyName while using MessageBox)<br />
      <br />
      <pre>
<code>!define Logger "!insertmacro Logger"<br />!macro Logger Type Message<br />        ${GetTime} "" "L" $0 $1 $2 $3 $4 $5 $6<br />        nsislog::log "$TEMP\${COMPANYNAME}\install.log" "$4:$5:$6 ${Type} ${Message}"<br />!macroend</code>
</pre><br />
      <br />
      whatever i use ${CompanyName} or $CompanyName its empty and returns only those ${x} / $x<br />
      <br />
      If you ask why i did this that way, i need to make about 5 different installers, very similiar but i need them to read from file different values, and ReadSetupINI make it easier to use then setting variables inside MainFile.nsh.<br />
      <br />
      I hope that i shown clearly what i need :)
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
