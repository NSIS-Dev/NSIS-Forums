<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="debian package advice re System.dll"><title>debian package advice re System.dll - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">debian package advice re System.dll</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=227304">debian package advice re System.dll</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">pabs</span><br><span class="post-time small text-muted">30th September 2005 09:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>debian package advice re System.dll</strong><br>I've found that if I strip out the code related to System::Call from System.dll, then I can build the dll fine. This results in a fairly crippled System.dll that can't be used in the examples that rely on System.dll, because most of these use System::Call as well as the other functions.<br><br>Do people think that the System.dll functions Alloc, Free, Copy, Store and Int64Op are worth shipping a crippled System.dll in debian?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">30th September 2005 12:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">System::Call is the heart of the plug-in. I think a better idea would be to use some program that converts the ASM code. GCC just wants a different syntax...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pabs</span><br><span class="post-time small text-muted">30th September 2005 20:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Do you know of any such program? Or some document comparing the two syntaxes?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">30th September 2005 23:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I don't know such a program. The two syntaxes are Intel's and AT&amp;T's, as far as I remember. There's also a different in block identifier and type (__asm {mov eax, 1} vs. asm("mov %eax, 1")). I don't remember which names goes to which syntax.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pabs</span><br><span class="post-time small text-muted">1st October 2005 02:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Suppose I manage to translate the assembly to AT&amp;T syntax, how will this be managed? Will the Intel version change often enough for the AT&amp;T version to become out of sync?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pabs</span><br><span class="post-time small text-muted">1st October 2005 06:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">OK, converted most of the assembly to gcc syntax. I'm getting 3 errors:</p><blockquote>build/release/System/Source/System.o:System.c:(.text+0x116f): undefined reference to `proc'<br>build/release/System/Source/System.o:System.c:(.text+0xf43): undefined reference to `alloca_probe'<br>build/release/System/Source/System.o:System.c:(.text+0x10b2): undefined reference to `__LOCAL_SIZE'</blockquote>The first is because I don't know how to refer to function parameters in gcc asm.<br><br>The second is because I don't know how to refer to functions in gcc asm.<br><br>The third seems to be because the code relies on MSVC's stack layout: <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/vccelng/htm/msmod_15.asp" target="_blank">http://msdn.microsoft.com/library/de...m/msmod_15.asp</a><br><br>I think it might be easier to strip out all the assembly and write it in C. Any idea if this would be possible?</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">1st October 2005 11:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">It seems impossible to strip it all out. How do you push a variable number of parameters to a function when the number is set at runtime? How do you create a __stdcall function that accepts a variable number of arguments?<br><br>The Intel version will probably not change much, but it'd be better to have a script that automatically converts prior to compiling.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pabs</span><br><span class="post-time small text-muted">11th October 2005 06:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I wrote a script that gets most of the way to an AT&amp;T version, but the remaining 10% (needed for proper comilation) would require implmenting a proper assembly tokeniser. I think it would be much easier to just stick ifdefs around the place and add the AT&amp;T version too.<br><br>Would this be acceptable? If so, I hope to get it done in time for inclusion in 2.11.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">11th October 2005 12:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Were you able to get around __LOCAL_SIZE and alloca?<br><br>An ifdef is acceptable. Of course, a conversion script is always preferable.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pabs</span><br><span class="post-time small text-muted">11th October 2005 15:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Nope, not yet able to port __LOCAL_SIZE and alloca. I'll keep digging though.<br><br>Cool, I'll get working on the ifdefs.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pabs</span><br><span class="post-time small text-muted">12th October 2005 10:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">In wine, alloca_probe just subtracts the value in eax from esp:<br><br><a href="http://cvs.winehq.org/cvsweb/wine/dlls/ntdll/rtl.c?rev=HEAD&amp;content-type=text/x-cvsweb-markup" target="_blank">http://cvs.winehq.org/cvsweb/wine/dl...-cvsweb-markup</a><br><br>Also found a mention of gcc/__LOCAL_SIZE together:<br><br><a href="http://66.102.7.104/search?q=cache:GvAF-ein9HcJ:www.eelab.usyd.edu.au/tornado/docs/gnu2.96%2Bpentium/gcc.html+__LOCAL_SIZE+__GNUC__&amp;hl=en" target="_blank">http://66.102.7.104/search?q=cache:G...__GNUC__&amp;hl=en</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">12th October 2005 12:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I don't know how WINE handles alloca, but it's more than just subtracting a value from ESP. All references to local variables should be offseted once the value of ESP changes.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pabs</span><br><span class="post-time small text-muted">13th October 2005 05:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">OK.<br><br>Another problem - gcc does not support the naked attribute on pe-i386. You can read a flamewar about that here:<br><br><a href="http://gcc.gnu.org/ml/gcc/2004-02/msg00939.html" target="_blank">http://gcc.gnu.org/ml/gcc/2004-02/msg00939.html</a><br><a href="http://gcc.gnu.org/ml/gcc/2004-02/threads.html#00939" target="_blank">http://gcc.gnu.org/ml/gcc/2004-02/threads.html#00939</a><br><br>More links:<br><br><a href="http://www.winehq.org/hypermail/wine-devel/2004/03/0408.html" target="_blank">http://www.winehq.org/hypermail/wine...4/03/0408.html</a><br><a href="http://gcc.gnu.org/onlinedocs/gcc/Function-Attributes.html#Function%20Attributes" target="_blank">http://gcc.gnu.org/onlinedocs/gcc/Fu...n%20Attributes</a><br><a href="http://www.cs.cornell.edu/courses/cs412/2001sp/resources/microsoft-calling-conventions.html" target="_blank">http://www.cs.cornell.edu/courses/cs...nventions.html</a><br><br>Hmm, perhaps the cdecl function attribute is the appropriate one to use?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">13th October 2005 12:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">cdecl is not quite the same thing as naked. It does less than stdcall because it doesn't clean up the stack, but it still initializes the stack in the epilog and uninitializes it in the prolog. It also probably pushes registers and makes room for the local variables. At least you won't need __LOCAL_SIZE...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pabs</span><br><span class="post-time small text-muted">14th October 2005 04:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">OK, I'll try that and see if it works.<br><br>BTW, this might take a while, so feel free to release in the meantime.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">16th November 2005 21:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Couple of things I found, that might be helpful:<br><br><a href="http://wiki.bfh.ch/index.php/Inline_Assembler_with_the_GCC" target="_blank">http://wiki.bfh.ch/index.php/Inline_...r_with_the_GCC</a><br><a href="http://www.niksula.cs.hut.fi/~mtiihone/intel2gas/" target="_blank">http://www.niksula.cs.hut.fi/~mtiihone/intel2gas/</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pabs</span><br><span class="post-time small text-muted">18th January 2006 05:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Not sure if I'll be able to finish this any time soon. I've attached the current unfinished patch for anyone who wants to work on this.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pabs</span><br><span class="post-time small text-muted">16th March 2008 04:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">A Debian user is working on converting the code to pure GCC assembly so that System::Call can be compiled on Linux and other non-Windows operating systems.<br><br><a href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=319999#40" target="_blank">http://bugs.debian.org/cgi-bin/bugre...?bug=319999#40</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pabs</span><br><span class="post-time small text-muted">28th October 2008 01:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>full System::Call support on Linux, testing needed</strong><br>Hi all, I've received a patch for full System::Call support on Linux. It changes how System.dll is compiled on Windows and therefore needs testing on Windows too. Please test gcc-system-call-2.patch from here:<br><br><a href="http://sf.net/support/tracker.php?aid=2193442" target="_blank">http://sf.net/support/tracker.php?aid=2193442</a><br><br>Those of you who build NSIS on Windows using the scons build scripts, I'd be grateful if you could test it. Please also test any installers you can create with it too. The example nsi files from NSIS work fine with it, but it might break some other installer and I don't want any regressions.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pabs</span><br><span class="post-time small text-muted">7th November 2008 02:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">BUMP!<br><br>Someone, anyone, please test the latest version of the patch (gcc-system-call-3.patch).</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">7th November 2008 22:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Builds fine and the example seems to work fine.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pabs</span><br><span class="post-time small text-muted">8th November 2008 00:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Cool, thanks for testing.<br><br>Did you want to review the patch before I commit it?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">8th November 2008 12:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I want to give it a very good look before it's committed.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">29th November 2008 22:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Committed and will be included in the next version - 2.42.</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>