<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Problem with System::Call" />

  <title>Problem with System::Call - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Problem with System::Call</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=269865">Problem with System::Call</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">AxelMock</span><br />
      <span class="post-time small text-muted">20th April 2007 16:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Problem with System::Call</strong><br />
      Hi,<br />
      <br />
      I'm having a problem with a System::Call to an external DLL.<br />
      What I want to do is to port an existing InstallShield installer<br />
      for a driver to NSIS.<br />
      I've read the Readme, studied several examples but can't found what's wrong.<br />
      <br />
      <br />
      In a custom action of IS a SetupAPI calls are performed to copy/uninstall<br />
      an OEM inffile.<br />
      <br />
      SetupCopyOEMInf/SetupUninstallOEMInf are declared as follows:<br /></p>

      <blockquote>
        BOOL WINAPI SetupCopyOEMInf(<br />
        PCTSTR SourceInfFileName,<br />
        PCTSTR OEMSourceMediaLocation,<br />
        DWORD OEMSourceMediaType,<br />
        DWORD CopyStyle,<br />
        PTSTR DestinationInfFileName,<br />
        DWORD DestinationInfFileNameSize,<br />
        PDWORD RequiredSize,<br />
        PTSTR DestinationInfFileNameComponent<br />
        );<br />
        <br />
        <br />
        BOOL SetupUninstallOEMInf(<br />
        PCWSTR InfFileName,<br />
        DWORD Flags,<br />
        PVOID Reserved<br />
        );
        <hr />
      </blockquote>
    </div>
    <hr />
    <br />
    I translated these into:<br />
    <br />
    !define SETUP_COPY_OEM_INFA "SetupAPI::SetupCopyOEMInfA (t, t, i, i, *t, i, i, *t) i"<br />
    !define SETUP_UNINSTALL_OEM_INFA "SetupAPI::SetupUninstallOEMInfA (t, i, *i) i"<br />
    <br />
    <br />
    with the calls being:<br />
    <br />
    System::Call '${SETUP_COPY_OEM_INFA} (r0,,0, 2, .r2, ${NSIS_MAX_STRLEN},, )'<br />
    System::Call "${SETUP_UNINSTALL_OEM_INFA} i(r1, 1, 0) .r3"<br />
    <br />
    <br />
    These calls don't work. :-(<br />
    I don't even get a return value except for "error" from GetLastError....<br />
    <br />
    I've added Dumpstate::debug calls and MessageBox output to see stack and variables,<br />
    but it seems that the call is aborted before setting any return code.<br />
    <br />
    Can somebody point out what I'm doing wrong?<br />
    <br />
    <br />
    I do have "SetPluginUnload alwaysoff" and "SetPluginUnload manual" and "System::Free 0"<br />
    of course, globally/in the respective section.<br />
    <br />
    <br />
    If I get this working I can start work on a NSIS module implementing/using<br />
    Microsoft DIF (Driver Installation Framework), which would really simplify<br />
    driver installations.<br />
    <br />
    <br />
    <br />
    <br />
    Here are the relevant code snippets:<br />
    <br />
    Quote:

    <table cellpadding="6" cellspacing="0" border="0" width="100%">
      <tr>
        <td class="alt2">
          <hr />
          Function RegisterInf<br />
          ;prototype BOOL WINAPI SetupCopyOEMInf(<br />
          ; PCTSTR SourceInfFileName,<br />
          ; PCTSTR OEMSourceMediaLocation,<br />
          ; DWORD OEMSourceMediaType,<br />
          ; DWORD CopyStyle,<br />
          ; PTSTR DestinationInfFileName,<br />
          ; DWORD DestinationInfFileNameSize,<br />
          ; PDWORD RequiredSize,<br />
          ; PTSTR DestinationInfFileNameComponent<br />
          ;);<br />
          Exch $0 ; passed path to inf file<br />
          Push $1<br />
          Push $2<br />
          Push $3<br />
          <br />
          SetOutPath $SYSDIR<br />
          ${GetFileName} $0 $1 ; get filename part of path<br />
          Dumpstate::debug<br />
          System::Call '${SETUP_COPY_OEM_INFA} (r0,,0, 2, .r2, ${NSIS_MAX_STRLEN},, )'<br />
          Dumpstate::debug<br />
          Call CheckError<br />
          <br />
          ; return code is in $3<br />
          MessageBox MB_ICONINFORMATION|MB_OK "SetupCopyOEMInf ($0 / $2) returned $3 "<br />
          IntCmp $3 0 WriteToReg<br />
          StrCpy $2 ""<br />
          WriteToReg:<br />
          ; result is in $2<br />
          WriteRegStr ${NSIS_REGISTRY_ROOT} "Software\${OEM}\${PRODUCT}" "$1" "$2"<br />
          <br />
          Pop $3<br />
          Pop $2<br />
          Pop $1<br />
          Exch $0<br />
          <br />
          FunctionEnd<br />
          <br />
          Function un.RegisterInf<br />
          ;prototype BOOL SetupUninstallOEMInf(<br />
          ; PCWSTR InfFileName,<br />
          ; DWORD Flags,<br />
          ; PVOID Reserved<br />
          ;);<br />
          Exch $0 ; passed path inf file name<br />
          Push $1<br />
          Push $2<br />
          Push $3<br />
          <br />
          ; result is in $1<br />
          ReadRegStr $1 ${NSIS_REGISTRY_ROOT} "${NSIS_REGISTRY_PRODUCTPATH}" "$0"<br />
          ${un.GetFileName} $1 $2 ; get filename part of path<br />
          <br />
          StrCmp $OSVersion 'W2K' Case_W2K<br />
          <br />
          System::Call "${SETUP_UNINSTALL_OEM_INFA} i(r1, 1, 0) .r3"<br />
          ; return code is in $3<br />
          MessageBox MB_ICONINFORMATION|MB_OK "SetupUninstallOEMInfA ($0 / $1) returned $3 "<br />
          StrCpy $0 $3<br />
          IntCmp $3 0 Done<br />
          goto Done<br />
          <br />
          Case_W2K:<br />
          StrCpy $0 ""<br />
          SetFileAttributes $1 FILE_ATTRIBUTE_NORMAL<br />
          Delete $1<br />
          IfErrors 0 Done<br />
          StrCpy $0 "1"<br />
          <br />
          Done:<br />
          Pop $3<br />
          Pop $2<br />
          Pop $1<br />
          Exch $0<br />
          <br />
          FunctionEnd<br />
          <br />
          Function CheckError<br />
          Push $0<br />
          System::Call "Kernel32::GetLastError ()i ().r0"<br />
          Dumpstate::debug<br />
          MessageBox MB_ICONINFORMATION|MB_OK "Error code: $0 "<br />
          Pop $0<br />
          FunctionEnd Call in section:<br />

          <blockquote>
            :<br />
            StrCpy $0 "$INSTDIR\${MY_DRIVERNAME}.inf"<br />
            Push $0<br />
            Call RegisterInf<br />
            Pop $R0<br />
            IntCmpU $R0 0 InfError InfError<br />
            :
          </blockquote>
        </td>
      </tr>
    </table><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br />
      <span class="post-time small text-muted">20th April 2007 16:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Have a look at <a href="http://msdn2.microsoft.com/en-us/library/aa376990.aspx" target="_blank">SetupCopyOEMInf</a> and <a href="http://msdn2.microsoft.com/en-us/library/aa377446.aspx" target="_blank">SetupUninstallOEMInf</a><br />
      <br />
      I would define the calls as:</p>
      <pre>
<code>System::Call 'Setupapi.dll::SetupCopyOEMInfA(t r1,t r2,i r3, i r4,*t .r5,i r6,*i .r7,*t .r8)i.r9'<br />System::Call 'Setupapi.dll::SetupUninstallOEMInfA(t R1,i R2,)i.R3'</code>
</pre>So in your case it would become
      <pre>
<code>System::Call 'Setupapi.dll::SetupCopyOEMInfA(t r0,t "",i 0, i 2,*t .r2,i ${NSIS_MAX_STRLEN},*i .r3,*t .r4)i.R0'<br />System::Call 'Setupapi.dll::SetupUninstallOEMInfA(t r1,i 2,)i.R1'</code>
</pre>The first one should give you 1 (success) or 0 (fail) on $R0 and the second one should give you 1 (success) or 0 (fail) on $R1 and GetLastError will give you extended info in either case<br />
      Hope this helps<br />
      CF<br />
      <br />
      PS note that you should have admin privileges to call these functions, so you may want to add the appropriate code to make sure that the user running your app has sufficient privileges.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">AxelMock</span><br />
      <span class="post-time small text-muted">26th April 2007 08:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi,<br />
      <br />
      thanks to your example i was able to resolve the problem.<br />
      <br /></p>

      <blockquote>
        <i>Originally posted by CancerFace</i><br />
        <b>Have a look at <a href="http://msdn2.microsoft.com/en-us/library/aa376990.aspx" target="_blank">SetupCopyOEMInf</a> and <a href="http://msdn2.microsoft.com/en-us/library/aa377446.aspx" target="_blank">SetupUninstallOEMInf</a><br /></b>
      </blockquote>Although the calls do NOT return the values in the variables as described by MS, using Dumpstate::debug I was able to find out which variables to use.<br />
      <br />
      No I'm out for implementing the interface to DIF.<br />
      <br />
      Regards,<br />
      Axel
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
