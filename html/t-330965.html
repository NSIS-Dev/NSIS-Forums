<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Delete Files System32"><title>Delete Files System32 - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Delete Files System32</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=330965">Delete Files System32</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">jai123</span><br><span class="post-time small text-muted">26th May 2011 19:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Delete Files System32</strong><br>Hello,<br><br>I created a driver installer. In order to install cleanly, the driver has to first make sure that there are no previous drivers files in the system files. For example, I have to make sure that the paths below do not contain any driver file.<br><br>../System32<br>../System32/drivers<br>../SysWOW64<br><br>In window XP, I just use the delete instruction and they get erased. However, in windows 7, delete does not erase the files. Any idea why is this happening?<br><br>Thanks,</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">26th May 2011 20:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">What code are you using?<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">jai123</span><br><span class="post-time small text-muted">26th May 2011 20:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The code is below. I have already double check that the path is correct.<br><br>The first delete uses $WINDIR\System32 instead of $SYSDIR because I thought that the path could be case sensitive. It did not make a difference.<br><br>Thanks.<br><br>Function cleanFileSystem<br><br># Erase driver files from the system.<br>delete "$WINDIR\System32\drivers\windrvr6.sys"<br>delete "$SYSDIR\drivers\pciservo.sys"<br>delete "$SYSDIR\drivers\pciservo2.sys"<br>delete "$SYSDIR\wdapi*.dll"<br>delete "$SYSDIR\drivers\TechnoPCIController.sys" ; from here on, 64 bit only file<br>delete "$WINDIR\SysWOW64\wdapi*.dll"<br><br>FunctionEnd</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">26th May 2011 20:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Running as admin? Got "RequestExecutionLevel admin"?<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">jai123</span><br><span class="post-time small text-muted">26th May 2011 20:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I am administrator and even I added an admin check at the beginning of the code (added code below).<br><br>what is that "RequestExecutionLevel admin"? can I change the user privileges from the installer?<br><br>Function .onInit<br><br># call userInfo plugin to get user info. The plugin puts the result in the stack<br>userInfo::getAccountType<br><br>pop $0 ; pop the result from the stack into $0<br><br># check if user is admin.<br>${If} $0 != "Admin"<br>messageBox MB_OK "To install the drivers, log in as administrator."<br>Abort<br>${EndIf}<br><br>FunctionEnd</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">26th May 2011 20:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">RequestExecutionLevel is in the manual.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">jai123</span><br><span class="post-time small text-muted">26th May 2011 20:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">thanks, I will check it out.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">26th May 2011 20:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Please note that requestexecutionlevel does absolutely nothing on older OS versions, or on Vista/7 with UAC disabled. So even if you requestexecutionlevel admin you'll always need to manually check for admin using the UserInfo plugin, like you did.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">jai123</span><br><span class="post-time small text-muted">26th May 2011 21:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">MSG, thank you for the observation. By chance, do you know how can I pop a message that clarifies that they need to be administrators before showing the admin password info? I see some users getting confused and thinking that the installer needs a password.<br><br>Also, getting back to the original question that I had. I am running as admin, an it is still not erasing the files in the system folder. Do you have any idea why is this happening?<br><br>Thanks,</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">26th May 2011 23:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Have you disabled file system redirection (see x64.nsh)? If you haven't then Windows will redirect any reads/writes from system32 to syswow64 because NSIS is 32-bit. That is probably what your issue is.</p><blockquote>By chance, do you know how can I pop a message that clarifies that they need to be administrators before showing the admin password info?</blockquote>What's wrong with the code you've already posted? It does just that, does it not?<br><br>Stu</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">27th May 2011 06:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Either that, or the files are in use?<br><br><br></p><blockquote><small>Originally posted by Afrow UK</small><br>Have you disabled file system redirection (see x64.nsh)? If you haven't then Windows will redirect any reads/writes from system32 to syswow64 because NSIS is 32-bit. That is probably what your issue is.What's wrong with the code you've already posted? It does just that, does it not?</blockquote>He/she wants to pop an admin warning before elevation. This is possible with the UAC plugin: Simply pop a messagebox before !insertmacro UAC_RunElevated . But note that this is definitely the long way around. The password entry field shown by Windows is just that, a part of Windows. It's how it's designed. If people misunderstand, that's not your fault because you're only using Windows the way it's designed to be used. So in that vein, it's also not your problem really.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">jai123</span><br><span class="post-time small text-muted">27th May 2011 15:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Afrow UK and MSG, both of you rock.<br><br>I was missing the X64.nsh redirection macros; that is the reason that I was not erasing the files in the folders I was looking to. Now, I am able to delete the files in the right folders. However, there is still an inconsistency with the next code:<br><br>${DisableX64FSRedirection}<br>CopyFiles $OUTDIR\pciservo.sys $SYSDIR\drivers\pciservo.sys<br><br>${EnableX64FSRedirection}<br>CopyFiles $OUTDIR\wdapi1030.dll $SYSDIR\wdapi1030.dll<br><br>The first call copies pciservo.sys into the ...\System32\drivers folder, and I would expect that the second one copies it into the ...\SysWOW64 folder, but it does not redirect to it. It still copies it into the ...\System32 folder. Is the X64.nsh limited to certain api calls?<br><br>------<br>About the message box before admin password pop, I agree with you guys. I believe it is descriptive and simple. So I will leave the pop with the password and the admin, that should be more than enough.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">27th May 2011 17:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hmm I've not had that problem before. However, I tend to use this script header in my NSIS projects that need to deal with dual x86/x64 installs (attached). It disables file system redirection by default (for the current thread by the way) and gives you a new $SYSWOW64 variable:<br><br>Usage:<br>${SystemDirsInit}<br><br>x86:<br>$SYSDIR = system32<br>$SYSWOW64 = system32<br><br>x64:<br>$SYSDIR = system32<br>$SYSWOW64 = syswow64<br><br>So in other words you can just use $SYSWOW64 when you need to extract 32-bit files and you do not need to toggle file system redirection. (Also the header replaces RunningX64 with a non-System plug-in call method of detection.)<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">jai123</span><br><span class="post-time small text-muted">27th May 2011 20:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks Afrow UK, that sound like a good way to go.</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>