<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Local Machine Registry uninstaller"><title>Local Machine Registry uninstaller - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Local Machine Registry uninstaller</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=301807">Local Machine Registry uninstaller</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">bnicer</span><br><span class="post-time small text-muted">7th January 2009 21:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Local Machine Registry uninstaller</strong><br>Hi again, Forum!<br><br>I miss this place.<br><br>=============<br><br>Maybe it's more of a philosophical question.<br><br>I've noticed in Vista the registry entries for installed software are (almost?) always under HKLM\Software\Microsoft\Windows\CurrentVersion\Uninstall\.<br><br>Personally, I don't want users to have to invoke administrator privileges (for anything), which goes for the uninstallers too.<br><br>I'm forcing "RequestExecutionLevel user" and writing the uninstall registry entries into HKCU\Software\Microsoft\Windows\CurrentVersion\Uninstall\.<br><br>But I wonder if my logic is flawed. Why does nobody else use HKCU (that I've noticed)? It was rare under XP. On Vista it seems (almost?) unheard of. Is there a reason?<br><br>Can anyone shed some light on this? Thx.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">7th January 2009 21:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">no, no reason other than that most installers force you to be admin (programfiles access, broken installer or whatever the reason is)<br><br>so, if you are supporting per user installs, your are one of the (few) good guys *claps*</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">RDaneel</span><br><span class="post-time small text-muted">7th January 2009 22:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Yes, well, I changed my NSIS installer a ways back to NOT require admin, and to perform ALL "visible" changes under HKCU and outside of "Program Files*"...<br><br>... and then I realized that NSIS's support of "delete/rename at next boot" wasn't working at all. I take it this is because MoveFilesEx uses HKLM?<br><br>Put differently, I really want to stay being one of the "good guys" - but I need my installer to work!<br><br>Again, none of MY reg key or filesystem ops needs admin, so if there is a trick here that allows the evil "...on next reboot" stuff to work with a NON-admin NSIS installer, I am all ears (or whatever the appropriate sensory apparatus would be). :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">7th January 2009 22:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">MoveFilesEx is HKLM only AFAIK, but you are not replacing system files in non admin installs, so you should be able to do your own filereplace trick in HKCU\...\Run (unless you have a component that is loaded in explorer.exe, then you might have to add some sort of checking to that COM object at load time so it does not load if a replace operation is going to happen (or a simpler way would be to unregister the COM object before restarting))<br><br>Not sure if any of this changed with Vista, one would think that MS add something for non admins since thats how they want people to run now</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">bnicer</span><br><span class="post-time small text-muted">7th January 2009 22:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I have never needed a reboot, but I figure if something is still running that prevents installing right away, you could just halt the installer. Ask the user to fix it. It would be like:<br><br>"The selected folder is not empty. Please choose another destination."<br><br>Kind of.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">RDaneel</span><br><span class="post-time small text-muted">7th January 2009 22:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Indeed, my issue is because I have a Shell extension (or 2). :(<br><br>I am already doing the [re-]*registration* out of HKCU...RunOnce (based on some boilerplate from NSIS docs) using "rundll32.exe". Could you sketch out (or supply a pointer) handling deletes/renames out of HKCU...RunOnce too?<br><br>Of course, this doesn't solve the underlying problem of Microsoft's having never supplied a "guaranteed" way of updating a Shell extension without the archaic "reboot" (a major weakness of the whole component paradigm)... but it WOULD allow me to revert to non-admin installers! :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">7th January 2009 23:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">don't use RunOnce, IIRC, that is only for admin, use plain run and delete the entry after its done. The problem with shell exstensions is that they can stay loaded for a while, the only solution I could think of that does not include killing explorer.exe would be to inject a dll into explorer.exe and call CoFreeUnusedLibs or whatever that function is called</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">RDaneel</span><br><span class="post-time small text-muted">21st January 2009 22:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I found no words suggesting that RunOnce has limited usage... and it actually does seem like the ideal thing here (cleaning up automatically etc). The documentation *is* interesting in that by default, RunOnce effectively removes the entry before actually executing it - if there is an error, too bad. BUT, the documentation goes on to cover how to request special handling (like NOT deleting the entry if an error occurs). :)<br><br>I have finished converting my installer from "install-32bit-on-32bit" to "install-32bit-on-32bit-AND-install-both-on-64bit", and it went pretty easily, once I got my head around requesting the register-64bit-DLL-on-reboot issue: the "trick" here was to make sure the RunOnce [in this case] went into the 64bit version of HKCU... that way the DllRegisterServer is invoked from a 64bit process. ;)<br><br>One last comment on how MoveFileEx is "screwed up" because it only works out of HKLM (requiring admin privileges): it occurs to me that [at least with a protection model anything like Windows'] this sort of thing MUST be limited for security reasons... after all, we are talking about a system account being used to delete or rename files - so there needs to be *some* restriction on the scheduling of such operations!<br><br>This differs substantially from the "Run*" type of requests - in that case, the operations in question are run *as a user* when that user logs in, so the normal access protections are in place.<br><br>Or at least this is my current take on this - I am still open to understanding the "why" better if this is not the actual reason. ;)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">21st January 2009 22:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">"Another pitfall of the "it's for setup programs" principle is that the RunOnce key is processed only if a user with administrator privileges logs on" not sure if this is a HKLM only restriction<br><br><a href="http://technet.microsoft.com/en-us/magazine/2006.12.windowsconfidential.aspx" target="_blank">http://technet.microsoft.com/en-us/m...fidential.aspx</a><br><br>And yes, HKLM pending moves would have a problem if non admins could put stuff there. But clearly, MS should have added a pending moves key to HKCU and have userinit.exe or winlogon.exe do the operation at login time.<br><br>Maybe you should take a look at Live Mesh, it has shell extensions and stuff like that and installs/runs as non admin IIRC</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">RDaneel</span><br><span class="post-time small text-muted">21st January 2009 23:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hmmm... this is bizarre.<br><br><a href="http://msdn.microsoft.com/en-us/library/aa376977(VS.85).aspx" target="_blank">http://msdn.microsoft.com/en-us/libr...77(VS.85).aspx</a><br><br>says nothing about this restriction of RunOnce... in fact, it states explicitly and without qualification that "Run and RunOnce keys are run each time a new user logs in."<br><br>OTOH, Raymond Chen clearly knows his stuff, as any followers of his blog "The Old New Thing" will recognize.<br><br>I suppose it is indeed possible that the discussion from Raymond in your link is implicitly framed to be dealing with RunOnce entries under HKLM, and that RunOnce entries under HKCU do work the way I expect (and as my link explains).<br><br>If that isn't the case, I don't understand where that leaves us... :(</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">21st January 2009 23:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">well, you are just going to have to test HKCU then, I'm too lazy to do it ;)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">RDaneel</span><br><span class="post-time small text-muted">21st January 2009 23:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">All right, I will fire up a VM, create a completely non-privileged user, and then try to construct a scenario that actually tests this meaningfully (it's non-trivial). ;)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">RDaneel</span><br><span class="post-time small text-muted">22nd January 2009 02:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I tried to "edit", but was outside the time window...<br>----<br>Grrr! It is actually much less trivial than I thought... as I tried to use my NSIS installer to set up this test scenario, I created a completely ordinary user ("Fred").<br><br>Fred then tried to run my installer, which of course next asked for an admin password... you can guess the rest. Of course the installer was from then on running AS the admin user whose password I had used - NOT as Fred any longer (and of course, NOT using Fred's tree in HKCU). :(<br><br>So even on the latest and greatest Windows (the one having a single-digit name), the access controls seem to be stuck in the Dark Ages... all my NSIS installer is looking for is to be able to DO certain things with an admin's PERMISSION - NOT BE THE *&amp;^*%*&amp;$&amp;^$%&amp; ADMIN!<br><br>I know I have asked essentially this question before, but are things really this bad? By its very nature, this entire mechanism of any installer needing admin permission no longer being able to properly install its app into the CORRECT per-user file and registry trees is completely broken.<br><br>It is sort of hard to believe that something this broken that sabotages the whole point of wanting to have PER-USER areas of the filesystem (and registry on systems that have one) would ever be shipped. :|<br><br>So what am I missing? Or are any solutions to this outside the scope of what NSIS (or any other non-MSI installer?) can do?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">22nd January 2009 07:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">you are supposed to pick one:<br><br>a)admin aka all users install; install in $programfiles, and put global stuff in HKLM. All per user stuff must be taken care of by your app the first time it's run by a user, not the setup program<br><br>b)per user install; install in (local)app data and HKCU, you can not touch $programfiles or HKLM<br><br>to support both, you would use a custom page or something to let the user decide<br><br>there is also a hacky third option, if you use the UAC plugin, you can install as admin, but still be able to do stuff as the actual "interactive" user and not the admin used to elevate</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">RDaneel</span><br><span class="post-time small text-muted">22nd January 2009 08:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks, Anders... I will take your most recent comment as general advice to installer-writers - since all *I* complain about not being able to do is your "b)" option. ;)<br><br>That case is not really possible IF one has need of any of the "... on REBOOT" functionality of NSIS/Windows, since that facility uses HKLM. And while there are other cases, installers with Shell extensions will always be stuck with having to REBOOT from time to time. :(<br><br>OTOH, I will look into the UAC plugin you mention, since you imply that it can be used to borrow credentials while retaining the original user's identity. Sweet.</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>