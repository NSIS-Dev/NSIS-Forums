<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="NSIS.Library.RegTool.v2.exe is queued for delete by previous setup reboot"><title>NSIS.Library.RegTool.v2.exe is queued for delete by previous setup reboot - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">NSIS.Library.RegTool.v2.exe is queued for delete by previous setup reboot</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=227832">NSIS.Library.RegTool.v2.exe is queued for delete by previous setup reboot</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">bg123</span><br><span class="post-time small text-muted">6th October 2005 23:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>NSIS.Library.RegTool.v2.exe is queued for delete by previous setup reboot</strong><br>I run my setup and it says reboot is required. In registry there is a RunOnce entry to execute "c:\WINDOWS\System32\NSIS.Library.RegTool.v2.exe /S".<br>There is also a registry entry HKLM\SOFTWARE\NSIS.Library.RegTool.V2\ with entries of dlls to register on boot<br><br>After reboot, the RunOnce and associated SOFTWARE\NSIS.Library registry entries go away, and my app is installed and ready to go.<br><br>There now is an entry in "HKLM\SYSTEM\CurrentControlSet\Control\Session Manager" called "PendingFileRenameOperations" with value data<br>saying to delete C:\WINDOWS\System32\NSIS.Library.RegTool.v2.exe<br><br>If I run setup again, the RunOnce entry is added but the PendingFileRenameOperations is still there.<br><br>On reboot, windows puts up a message box saying it cannot find C:\WINDOWS\System32\NSNS.Library.RegTool.v2.exe so<br>the second install does not complete.<br><br>Help!</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">bg123</span><br><span class="post-time small text-muted">7th October 2005 16:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Is rebooting twice not considered a problem?</strong><br>Run installer, which requires reboot, then after reboot install something else which requires reboot, then during that reboot windows cannot find NSIS.Library.RegTool.v2.exe, because previous reboot put NSIS.Library.RegTool.v2.exe in the PendingFoleRenameOperations list so it was deleted before the RunOnce tried to complete the second setup.<br><br>Am I doing something wrong? Using NSIS 2.10</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">7th October 2005 16:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You're not doing anything wrong. There's a problem with files that are queued for deletion and then used again.<br><br>I'm tempted to put RegTool in the temporary directory and just leave it there. It's very small, and will be even smaller without the deletion on reboot queueing code. Any comments?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">bg123</span><br><span class="post-time small text-muted">7th October 2005 16:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I have no problem with leaving the file around at all. Is there a script file i can edit to make this happen?<br><br>Or, it could be arranged that any time the regtool is added to RunOnce, any PendingFileRenameOperations entry for it could be removed so the RunOnce will get to run. Then you still have the delayed cleanup of regtool on the next boot (unless someone runs another nsis based install)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">7th October 2005 17:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The PendingFileRenameOperations entry is not documented properly anywhere at MSDN. I don't think it'd be a good idea to mess with it.<br><br>To get RegTool to not delete itself and write to the temporary directory a few source changes needs to be made. In attach ZIP, you'll find a patch for the source code, the complete Library.nsh with the change and a compiled version of RegTool. Please test it and let me know how it goes.<br><br>If it does work, we need to consider what to do with older versions. The easiest solution would probably be bumping the version. This way, nothing bad will happen in the rare-chance that some DLL is installed to the temporary directory, which will cause the RegTool to be deployed there.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">bg123</span><br><span class="post-time small text-muted">7th October 2005 19:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The Regtool.bin worked correctly. When I was putting the changes into my nsis installation, I did my usual diff of the changed files. Library.nsh changed the file location of regtool to $TEMP, but did not change the RunOnce entry, it still used $R2. I tried it as is anyway, and of course it could not find regtool on second setup reboot. The $TEMP is in my user directory localsettings. Instead of changing the RunOnce entry in the changed Library.nsh, I reverted to the old 2.10 one. I have no problem with the exe being left in winsys. My own uninstalls do not remove my common dlls from there either. Not an issue for me, though I will follow however you decide (presumably in 2.11)<br><br>Everything works fine! Thanks very very much!</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">7th October 2005 20:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Keeping it in $SYSDIR would be a problem, because the path it's kept in is not always $SYSDIR. It's actually the path of the first installed DLL. This could leave over a lot of copies of the tool.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">bg123</span><br><span class="post-time small text-muted">7th October 2005 22:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Could the Library.nsh use a "random" (GUID) file name, like it does for the entries under the HKLM\Software\NSIS.Library.RegTool.v2, for the name of the exe it deposits in $R2 or $TEMP, and adds to RunOnce ?<br><br>If the regtool can figure out its exe file name and do the MoveFileEX to delete on next boot, it can be safely deleted, since another run of setup would extract it with a different filename for RunOnce to find.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">8th October 2005 01:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><i>Originally posted by kichik</i><br><b>I'm tempted to put RegTool in the temporary directory and just leave it there. It's very small, and will be even smaller without the deletion on reboot queueing code. Any comments?</b></blockquote>why cant RegTool just delete itself when its done?</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">bg123</span><br><span class="post-time small text-muted">8th October 2005 04:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><i>Originally posted by Anders</i><br><b>why cant RegTool just delete itself when its done?</b><hr></blockquote></div><hr>Can't delete a running executable. The best solution would be a way for a process to tell windows "wait until I exit, then delete me".<br><div class="post"><p class="post-meta"><span class="post-author text-primary">bg123</span><br><span class="post-time small text-muted">8th October 2005 04:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">This works:<br><br>1. Use the original Program Files\NSIS\bin\RegTool.bin, it figures out its filename and tells windows to delete it on next reboot.<br><br>2. Change Program Files\NSIS\Include\Library.nsh :<br>Change lines<br><br>File /oname=$R2\NSIS.Library.RegTool.v2.exe "${NSISDIR}\Bin\RegTool.bin"<br>WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\RunOnce" \<br>"NSIS.Library.RegTool.v2" '"$R2\NSIS.Library.RegTool.v2.exe" /S'<br><br>to<br>File /oname=$R2\NSIS.Library.RegTool.v2.$__INSTALLLLIB_SESSIONGUID.exe "${NSISDIR}\Bin\RegTool.bin"<br>WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\RunOnce" \<br>"NSIS.Library.RegTool.v2" '"$R2\NSIS.Library.RegTool.v2.$__INSTALLLLIB_SESSIONGUID.exe" /S'<br><br>Changed version attached.<br><br>The RegTool program gets a unique name, and RunOnce key knows to run it. After reboot regtool has run and there will be a pending delete of that file for the next boot. Another setup run before next boot will set up RegTool with a different .exe name and RunOnce entry, and on boot the old RegTool is deleted but the new one is still there and it runs (queuing itself for delete on next boot). I think any number of setups could be run with reboots between or not.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">8th October 2005 05:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Quote:</p><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">bg123</span><br><span class="post-time small text-muted">8th October 2005 05:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><i>Originally posted by Anders</i><br><b>yes it is possible, its a bit of a hack but it IS possible<br><br><a href="http://www.catch22.net/tuts/selfdel.asp" target="_blank">http://www.catch22.net/tuts/selfdel.asp</a><br><a href="http://www.nsonic.de/Delphi/txt_WIS00561.htm" target="_blank">http://www.nsonic.de/Delphi/txt_WIS00561.htm</a></b></blockquote>I didn't know about those, but never assumed it not possible. But from qa quick look at these links, the ones that truly delete from a running system do not guarantee to work in future version. Which would anser original question as to why regtool does not just delete itself. Really should be O/S support for something like that.<br><br>Cool though!</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">bg123</span><br><span class="post-time small text-muted">8th October 2005 05:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Oops...<br><br>Testing with a few setups in a row did not work. You can only have one key with the same name in registry, it seems.<br>Had to add unique id to value name in runonce.<br><br>There is a test that tries to see if RunOnce file already exists, but it is ineffective, because RunOnce value has the /S on the end, so the filename will never exist, so we create a new unique named file but can only add one of these to RunOnce (the last one is the one preserved, I think)<br><br>In Library.nsh change to:<br>;Setup RegTool<br><br>ReadRegStr $R3 HKLM "Software\Microsoft\Windows\CurrentVersion\RunOnce" "NSIS.Library.RegTool.v2.$__INSTALLLLIB_SESSIONGUID"<br>IfFileExists $R3 +3<br><br>File /oname=$R2\NSIS.Library.RegTool.v2.$__INSTALLLLIB_SESSIONGUID.exe "${NSISDIR}\Bin\RegTool.bin"<br>WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\RunOnce" \<br>"NSIS.Library.RegTool.v2.$__INSTALLLLIB_SESSIONGUID" '"$R2\NSIS.Library.RegTool.v2.$__INSTALLLLIB_SESSIONGUID.exe" /S'<br><br><br>This works for multiple setups betweem reboots. No regtools left after reboot after last install's reboot.<br><br>Changed Library.nsh attached.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">8th October 2005 14:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">There's no need to deploy more RegTools. Each one does the work for them all. The test just needs to be adjusted. This, after ReadRegStr, should do:</p><pre>
<code>StrCpy $R3 $R3 -4 1</code>
</pre>It would be possible to extract the RegTool with a unique name to avoid the original issue. It would also help avoid the temporary directory which users like to mess with.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">11th October 2005 17:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Here's what I ended up uploading. It uses the original RegTool. Let me know if there are any problems with it.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">bg123</span><br><span class="post-time small text-muted">12th October 2005 05:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I diffed with the last one.<br>Shouldn't the line<br><br>File /oname=$R2\NSIS.Library.RegTool.v2.exe "${NSISDIR}\Bin\RegTool.bin"<br><br>be<br><br>File /oname=$R2\NSIS.Library.RegTool.v2.$__INSTALLLLIB_SESSIONGUID.exe "${NSISDIR}\Bin\RegTool.bin"<br><br>to go with the WriteRegStr defining RunOnce ?<br><br>The diff shows other changes (get library version) etc. I assume they are for other things.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">12th October 2005 12:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks, fixed.<br><br>The library version changes require the latest LibraryLocal.exe as well. You can revert those changes until 2.11 if you don't want to get the latest CVS version.</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
      hljs.initHighlightingOnLoad();
      //]]></script><table cellpadding="6" cellspacing="0" border="0" width="100%"><tr><td class="alt2"><hr><i>Originally posted by bg123</i><br><b>Can't delete a running executable. The best solution would be a way for a process to tell windows "wait until I exit, then delete me".</b> yes it is possible, its a bit of a hack but it IS possible<br><br><a href="http://www.catch22.net/tuts/selfdel.asp" target="_blank">http://www.catch22.net/tuts/selfdel.asp</a><br><a href="http://www.nsonic.de/Delphi/txt_WIS00561.htm" target="_blank">http://www.nsonic.de/Delphi/txt_WIS00561.htm</a></td></tr></table></div></div></body></html>