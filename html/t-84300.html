<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="CRCCheck Feature/Bug"><title>CRCCheck Feature/Bug - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">CRCCheck Feature/Bug</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=84300">CRCCheck Feature/Bug</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">dbareis</span><br><span class="post-time small text-muted">10th April 2002 11:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>CRCCheck Feature/Bug</strong><br>&nbsp; Hi,<br><br>I did some checking and found that although a random patch in the installer EXE is detected, adding bytes to the end (changing its file size) isn't.<br><br>It makes me worry a bit about what else isn't checked... I had assumed that a CRC check would protect against viruses, I suppose that as well as adding code to the end of the EXE a virus would need to update the EXE header, hopefully this is checked...<br><br>Bye<br>Dennis</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Schultz</span><br><span class="post-time small text-muted">10th April 2002 13:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Well if you look at this page at version nsis17b.exe Justin made this changes to the crc check.<br><a href="http://www.nullsoft.com/free/nsis/version-history.html" target="_blank">http://www.nullsoft.com/free/nsis/version-history.html</a><br><br>Made CRC not check the first 512 bytes, for better compatibility with virii and with digital signing.<br><br>because too many people where complaiing that they NullSoft installers where currupt on there system. not thinking it was a Virus that was causing it etc. and some people i know wouldn't belive that it was a virus on there computer causing it to "currupt the nsis installer" so justin changed what it looked for..</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">dbareis</span><br><span class="post-time small text-muted">13th April 2002 05:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><i>Originally posted by Schultz</i><br><b>Well if you look at this page at version nsis17b.exe Justin made this changes to the crc check.<br><a href="http://www.nullsoft.com/free/nsis/version-history.html" target="_blank">http://www.nullsoft.com/free/nsis/version-history.html</a><br><br>Made CRC not check the first 512 bytes, for better compatibility with virii and with digital signing.<br><br>because too many people where complaiing that they NullSoft installers where currupt on there system. not thinking it was a Virus that was causing it etc. and some people i know wouldn't belive that it was a virus on there computer causing it to "currupt the nsis installer" so justin changed what it looked for..</b><hr></blockquote></div><hr>So it sounds like NSIS has NO virus protection and I as a package author can't decide that my installer does. If that is really the case and given that I've proven a virus can add to the end of the file without NSIS complaining and now it doesn't check the EXE header, this is looking very likely then I'm going to have to look for other installer products...<br><br>If my product has a virus then I will be blamed, I will not let this happen....<br><br>The solution is simple as suggested by me much earlier posts, change the default message to at least suggest the most likely cause is download failure or virus and allow the author to also replace this message.<br><br>Bye<br>Dennis<br><div class="post"><p class="post-meta"><span class="post-author text-primary">Repzilon</span><br><span class="post-time small text-muted">13th April 2002 18:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Problem is identified in source code</strong><br>&nbsp; From Source\exehead\main.c of version 1.94, at function int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInst,LPSTR lpszCmdParam, int nCmdShow)<br><br></p><pre>
<code>#ifdef NSIS_CONFIG_CRC_SUPPORT
<br>       if (no_crc || !(a&amp;FH_FLAGS_CRC))  break; // if first bit is not set, then no crc checking. 
<br><br>       do_crc++;
<br>        
<br>       left=dbl-4;
<br>        // end crc checking at crc :) this means you can tack shit on the end 
<br>        // and it'll still work.
<br>               
<br>        // this is in case the end part is &lt; 512 bytes. 
<br>       if (l &gt; (DWORD)left) l=(DWORD)left;
<br><br>&gt;#else//!NSIS_CONFIG_CRC_SUPPORT
<br>        break;
<br>&gt;#endif//!NSIS_CONFIG_CRC_SUPPORT 
</code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">dbareis</span><br>
      <span class="post-time small text-muted">13th April 2002 23:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Re: Problem is identified in source code</strong><br>
      &nbsp; Quote:</p>
      <hr>

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">Schultz</span><br>
        <span class="post-time small text-muted">14th April 2002 03:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Those are defined during compile time because some of the options are done for the exehead. and Justin tries to keep the exehead size as small as possible.. So you can take stuff outta the compile to reduce the exe head even smaller. And makensis i belive just take the already written exehead and just adds the stuff needed onto the end of it. So you can't have stuff definable at runtime since its using an already compiled exehead.</p>
      </div>
      <hr>

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">dbareis</span><br>
        <span class="post-time small text-muted">16th April 2002 10:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content"></p>

        <blockquote>
          <i>Originally posted by Schultz</i><br>
          <b>Those are defined during compile time because some of the options are done for the exehead. and Justin tries to keep the exehead size as small as possible.. So you can take stuff outta the compile to reduce the exe head even smaller. And makensis i belive just take the already written exehead and just adds the stuff needed onto the end of it. So you can't have stuff definable at runtime since its using an already compiled exehead.</b>
        </blockquote>Good point.<br>
        <br>
        But while a goal of keeping the header as small as possible is a good one, I think worrying about what is likely to be at most 50-100 bytes is too much (and yes I know they all add up - just like my grocery bill...). Making all NSIS installers open to viruses by default does not seem a good idea to me.<br>
        <br>
        Bye<br>
        Dennis
      </div>
      <hr>

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">Schultz</span><br>
        <span class="post-time small text-muted">16th April 2002 11:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Though in my opinion.. As long as you know you are distrubuting an Installer that is virus free on your website or how ever you distribute it.. And the End Users system has the Virus then it is there fault for having the virus.. They should be the ones responsible for having a virus scanner and keeping there virus definitions up to date. But unfortunatly most people that i know of don't do this. Ultimatly you should note that you can only guerentee that the installer is clean if they downloaded it from a "verified source" and since i haven't had a problem with virus's, does other installers such as InstallShield, Ghost(whatever) and all those have a CRC check on the exe file to make sure a virus dosen't alter there's either. (FYI i haven't looked and checked, i am just asking)</p>
      </div>
      <hr>

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br>
        <span class="post-time small text-muted">16th April 2002 19:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">When you make a freeware application which will be distributed on the internet and will be available on many internet sites, it's good to know that the installer checks for a virus. I don't care when people don't believe that they have a virus, but I don't want that infected versions of the file will be distributed.<br>
        <br>
        But Justin said this about the first 512 bytes:<br></p>

        <blockquote>
          Not CRCing the first 512 bytes isn't very unsafe. The first 512 bytes are primarily the EXE header and PSP, and if they are corrupted, the installer will likely fail before it gets a check to CRC itself. TRy randomly screwing with the first 512 bytes of a nsis installer and see what happens.<br>
          <br>
          As for compatibility with virii, I think it's best that people's first experiences with NSIS installers are it telling them that they have a virus.<br>
          <br>
          Again, the first 512 bytes, if corrupted, probably aren't going to effect the install process much.<br>
          <br>
          Prove me wrong if you disagree =)<br>
          <br>
          -Justin
        </blockquote>So not checking the first 512 bytes is for digital signing or something like that.
      </div>
      <hr>

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">justin</span><br>
        <span class="post-time small text-muted">17th April 2002 08:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Thanks Joost for quoting that old quote.<br>
        <br>
        I'll make an option in 1.97 that lets you do CONFIG_CRC_ANALCHECKING to not allow data to be tacked on the end/not allow the first 512 bytes to change.<br>
        <br>
        It's a matter of preference of how this shit works, so I own't argue the benefits of both.<br>
        <br>
        -Justin</p>
      </div>
      <hr>

      <div class="footer">
        <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
      </div>

      <table cellpadding="6" cellspacing="0" border="0" width="100%">
        <tr>
          <td class="alt2">
            <hr>
            <i>Originally posted by Repzilon</i><br>
            <b>From Source\exehead\main.c of version 1.94, at function int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInst,LPSTR lpszCmdParam, int nCmdShow)<br>
            <br></b>
            <pre>
<b><code>#ifdef NSIS_CONFIG_CRC_SUPPORT
<br>       if (no_crc || !(a&amp;FH_FLAGS_CRC))  break; // if first bit is not set, then no crc checking. 
<br><br>       do_crc++;
<br>        
<br>       left=dbl-4;
<br>        // end crc checking at crc :) this means you can tack shit on the end 
<br>        // and it'll still work.
<br>               
<br>        // this is in case the end part is &lt; 512 bytes. 
<br>       if (l &gt; (DWORD)left) l=(DWORD)left;
<br><br>&gt;#else//!NSIS_CONFIG_CRC_SUPPORT
<br>        break;
<br>&gt;#endif//!NSIS_CONFIG_CRC_SUPPORT 
</code></b>
</pre>Hi,<br>
            <br>
            Thanks for pointing that out.<br>
            <br>
            That code explains the addition of data at end and not the updating of the header but that is probably also relatively easy to find.<br>
            <br>
            However I do enough code hacking (and not enough time to do so), if I ever bother to get the NSIS code I'm likely to want to modify just about everything and I also do not wish to try to keep in sync.<br>
            <br>
            I believe that there are too many "options" like this set during compile time where there would be little if any runtime issue if they were made configurable options. These could have basic doco in a small "advanced" document (little detail as the documentation of all these options is where the main time would be!), but I really don't see why so much configuration is done during the compile.<br>
            <br>
            Bye<br>
            Dennis</td></tr></table></div></div></body></html>