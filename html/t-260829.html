<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Please help me with FileWrite and FileClose" />

  <title>Please help me with FileWrite and FileClose - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Please help me with FileWrite and FileClose</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=260829">Please help me with FileWrite and FileClose</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">sunlight112</span><br />
      <span class="post-time small text-muted">1st December 2006 06:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Please help me with FileWrite and FileClose</strong><br />
      With many supporters in forum, I can run database well. However, I have one problem which I can explain why it happens. I had worked well last week. But in this week, my code run is error although I do not repair any code line in it. I do not know why!<br />
      My code here:<br /></p>

      <blockquote>
        Function DropSchema<br />
        Detailprint "Delete database if it exists"<br />
        GetTempFileName $8<br />
        Detailprint "Get Temp File Name: $8" ##C:\Document.....<br />
        StrCpy $8 "drop.bat"<br />
        FileOpen $9 $8 "w"<br />
        FileWrite $9 "@echo off$\r$\n"<br />
        StrCpy $7 $TEMP 2 ##C:<br />
        FileWrite $9 "$7$\r$\n"<br />
        FileWrite $9 "mysql.exe --user=$root --password=$passroot &lt; c:\drop_db.sql$\r$\n"<br />
        FileWrite $9 "pause$\r$\n"<br />
        FileClose $9<br />
        nsExec::exec "$8"<br />
        Pop $8<br />
        StrCmp $8 "0" 0 Error<br />
        Delete $8<br />
        Detailprint "Delete database successful"<br />
        Goto End<br />
        Error:<br />
        Detailprint "Delete database fail"<br />
        Detailprint "Error: $8"<br />
        MessageBox MB_OK|MB_ICONSTOP "Delete database is error.$\r$\nPlease try again latter"<br />
        Abort<br />
        End:<br />
        FunctionEnd<br />
        <br />
        Section SetupSchema_RunDB<br />
        Call DropSchema<br />
        Detailprint "Create database"<br />
        GetTempFileName $5<br />
        Detailprint "Get Temp File Name: $5" ##C:\Document.....<br />
        StrCpy $5 "db.bat"<br />
        FileOpen $6 $5 "w"<br />
        FileWrite $6 "@echo off$\r$\n"<br />
        StrCpy $7 $TEMP 2 ##C:<br />
        FileWrite $6 "$7$\r$\n"<br />
        FileWrite $6 "mysql.exe --user=$root --password=$passroot &lt; c:\schema.sql$\r$\n"<br />
        FileWrite $6 "pause $\r$\n"<br />
        FileClose $6<br />
        nsExec::exec "$5"<br />
        Pop $5<br />
        StrCmp $5 "0" 0 Error<br />
        Delete $5<br />
        Detailprint "Create database successful"<br />
        Goto Next<br />
        Error:<br />
        Detailprint "Create database fail"<br />
        Detailprint "Error: $5"<br />
        MessageBox MB_OK|MB_ICONSTOP "Create database is error.Do you type correctly password?$\r$\nRun server will be error.Please try again latter"<br />
        Goto End<br />
        Next:<br />
        Detailprint "Run script"<br />
        GetTempFileName $0<br />
        Detailprint "Get Temp File Name: $0" ##C:\Document.....<br />
        StrCpy $0 "sql.bat"<br />
        FileOpen $1 $0 "w"<br />
        FileWrite $1 "@echo off$\r$\n"<br />
        StrCpy $2 $TEMP 2 ##C:<br />
        FileWrite $1 "$2$\r$\n"<br />
        FileWrite $1 "mysql.exe OpenIM --user=$root --password=$passroot &lt; c:\openim.sql$\r$\n"<br />
        FileWrite $1 "pause$\r$\n"<br />
        FileClose $1<br />
        nsExec::exec "$0"<br />
        Pop $0<br />
        StrCmp $0 "0" 0 lblError<br />
        Delete $0<br />
        Detailprint "Run database successful"<br />
        Goto End<br />
        lblError:<br />
        Detailprint "Run database fail"<br />
        Detailprint "$0"<br />
        MessageBox MB_OK|MB_ICONSTOP "Run database is error.Do you type correctly password?$\r$\nRun server will be error.Please try again latter"<br />
        Goto End<br />
        End:<br />
        SectionEnd
      </blockquote>Now I do not explain why I run it error.<br />
      I aslo compile it many times and run it again, again too much but sometime, It runs well. Sometimes, it does not run :(<br />
      Somebody know please tell me why?<br />
      Thank a lot,
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bholliger</span><br />
      <span class="post-time small text-muted">1st December 2006 09:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi sunlight112!<br />
      <br />
      If there's a problem with the database, redirect the output to a file for further diagnose.<br />
      <br /></p>
      <pre>
<code><br />mysql.exe --user=$root --password=$passroot &lt; c:\drop_db.sql &gt; c:\error.log<br /></code>
</pre><br />
      <br />
      Cheers<br />
      <br />
      Bruno
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">1st December 2006 10:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Just a quick look on your script, try this, it may help,<br />
      remove the line StrCpy $8 "drop.bat"<br />
      after FileClose use rename e.g<br />
      Rename '$8' '$TEMP\drop.bat'<br />
      nsExec::exec '$TEMP\drop.bat'</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">sunlight112</span><br />
      <span class="post-time small text-muted">4th December 2006 02:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thank bholliger and Red Wine a lot,<br />
      I has tryed with your ideas but It still can not work well.<br />
      With file error.log, after I run installer, nothing has in this file.<br />
      At that time, my installer run well. It means no error but database can not be created.<br />
      With this same installer, I run the same way, the first, It runs well.However,the second, it is still not to create database again( i has delete database from mysql before I install my installer again to check why it is wrong)<br />
      I can not explain why sometimes it works well and sometimes it can not work.<br />
      Please help me!<br />
      Does my code has some problems?<br />
      Please tell me if you do not clearly what I say :)<br />
      Thank in advance,</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bholliger</span><br />
      <span class="post-time small text-muted">4th December 2006 03:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi sunlight112!<br />
      <br />
      I forgot something. Maybe the STDERR stream is not included in the file. Try using 2&gt;&amp;1 as well.<br /></p>
      <pre>
<code><br />mysql.exe --user=$root --password=$passroot &lt; c:\drop_db.sql 2&gt;&amp;1 &gt; c:\error.log<br /></code>
</pre><br />
      <br />
      As Red Wine wrote before, I wouldn't use GetTempFileName. I'd use $TEMP\myfile.bat.<br />
      <br />
      Is mysql.exe in the path variable? What happens if you execute the string in the prompt?<br />
      <br />
      Cheers<br />
      <br />
      Bruno
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">sunlight112</span><br />
      <span class="post-time small text-muted">4th December 2006 06:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thank bholliger,<br />
      I am sure the path variable has set. I also check my command with command line and it works well.<br />
      I has changed my path to become $TEMP like this:<br /></p>
      <pre>
<code><br />Function DropSchema<br />   ClearErrors<br />   FileOpen $9 $8 "w"<br />   FileWrite $9 "@echo off$\r$\n"<br />   StrCpy $7 $TEMP 2     ##C:<br />   FileWrite $9 "$7$\r$\n"<br />   FileWrite $9 "mysql.exe --user=$root --password=$passroot &lt; c:\drop_db.sql &gt; c:\error.log$\r$\n"<br />   FileWrite $9 "pause$\r$\n"<br />   FileClose $9<br />   Rename '$8' '$TEMP\drop.bat'<br />   StrCpy $Variable '$TEMP\drop.bat'<br />   nsExec::exec '$Variable'<br />   Pop $Variable<br />   StrCmp $Variable "0" 0 Error<br />   Delete $Variable<br />      Detailprint "Delete database successful"<br />      Goto End<br />   Error:<br />      Detailprint "Delete database fail"<br />      Detailprint "Error: $Variable"<br />      MessageBox MB_OK|MB_ICONSTOP "Delete database is error.$\r$\nPlease try again latter"<br />      Abort<br />   End:<br />FunctionEnd<br /></code>
</pre><br />
      It still does not works although I try with your idea " 2&gt;&amp;1 "<br />
      I try with "2&gt;&amp;1" logfile does not appear when I run my installer.<br />
      I think my installer run unstable. But I can not repair it and make it better.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">sunlight112</span><br />
      <span class="post-time small text-muted">4th December 2006 08:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Now I can know why my installer run is wrong<br />
      It may be my error.<br />
      When I create installer, I set environment after that I run database. I think it can be this problem because sometimes it does not understand path variable of mysql. So, I can be error. However, I close my installer, I run my batch file. At that time, my batch file run well.<br />
      I know when I set environment variable I should restart computer. But it do it, how can I run my database for user?<br />
      Somebody used to pass this problem, please help me!<br />
      Your help is very useful for me!<br />
      Thank a lot,</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bholliger</span><br />
      <span class="post-time small text-muted">4th December 2006 11:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi sunlight112!<br />
      <br />
      This link [1] might help you.<br />
      <br />
      [1] <a href="http://dev.mysql.com/doc/refman/5.0/en/windows-start-command-line.html" target="_blank">http://dev.mysql.com/doc/refman/5.0/...mand-line.html</a><br />
      <br />
      Cheers<br />
      <br />
      Bruno</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">sunlight112</span><br />
      <span class="post-time small text-muted">5th December 2006 02:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thank bholliger a lot,<br />
      Now I can run my installer to create database but I am worry about root and password to run it.<br />
      I allow user to type it in my installer. But I run with the wrong password, my installer still announce "RUN DATABASE SUCCESSFUL"<br /></p>
      <pre>
<code><br />   Detailprint "Run script"<br />   GetTempFileName $0 $TEMP<br />;   StrCpy $0 "sql.bat"<br />   FileOpen $1 $0 "w"<br />   FileWrite $1 "@echo off$\r$\n"<br />   StrCpy $2 $TEMP 2     ##C:<br />   FileWrite $1 "$2$\r$\n"<br />   FileWrite $1 '"$Mysql\mysql.exe" --user=$root --password=$passroot -D openim&lt; "$path_openim\home\database\openim.sql"$\r$\n'<br />   FileWrite $1 "pause$\r$\n"<br />   FileClose $1<br />   Rename $0 '$TEMP\run.bat'<br />   StrCpy $9 '$TEMP\run.bat'<br />   nsExec::exec "$9"<br />   Pop $9<br />   Detailprint "$$9 : $9"<br />   StrCmp $9 "0" 0 lblError<br />      Delete '$TEMP\run.bat'<br />      Detailprint "Run database successful"<br />      Goto End<br />   lblError:<br />      Detailprint "Run database fail"<br />      Detailprint "$9"<br />      MessageBox MB_OK|MB_ICONSTOP "Run database is error.Do you type correctly password?$\r$\nRun server will be error.Please try again latter"<br />      Goto End<br />   End:<br /></code>
</pre><br />
      Almost POP $9 always give "0" although run database successful or fail.<br />
      How can I know to run database is error if user typed wrong password and root.<br />
      Please help me!<br />
      Thank a lot,
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bholliger</span><br />
      <span class="post-time small text-muted">5th December 2006 03:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi sunlight112!<br />
      <br />
      I'd use ExecWait to run mysql.exe. It allows you to get the return code of mysql.exe in a variable. I believe that you have to change the command. Instead of "&lt;" use -e "sourcefile". Have a look at [1] for more information.<br />
      <br />
      Altough I can't check it, the return codes mitght be those described in [2].<br />
      <br />
      Due to this change you don't have to worry about writing sql files and deleting them afterwards.<br />
      <br />
      [1] <a href="http://dev.mysql.com/doc/refman/5.0/en/batch-mode.html" target="_blank">http://dev.mysql.com/doc/refman/5.0/en/batch-mode.html</a><br />
      [2] <a href="http://dev.mysql.com/doc/refman/5.0/en/error-messages-client.html" target="_blank">http://dev.mysql.com/doc/refman/5.0/...es-client.html</a><br />
      <br />
      Have fun!<br />
      <br />
      Cheers<br />
      <br />
      Bruno</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">sunlight112</span><br />
      <span class="post-time small text-muted">5th December 2006 06:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thank bholliger a million,<br />
      Now my installer run well<br />
      :D</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
