<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="NT4 CopyFiles - Return value not working." />

  <title>NT4 CopyFiles - Return value not working. - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">NT4 CopyFiles - Return value not working.</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=143042">NT4 CopyFiles - Return value not working.</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mgillespie</span><br />
      <span class="post-time small text-muted">21st July 2003 18:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>NT4 CopyFiles - Return value not working.</strong><br />
      Have posted a bug on the SF tracker (not sure if anyone looks there, so posting here also).<br />
      <br />
      I have a project that uses the CopyFiles function. I check the error value after copying to ensure the file was copied correctly.<br />
      <br />
      This works fine under Win2k, but fails under NT4 (SP6a), where it always reports a good copy, even if it can't find the source file.<br />
      <br />
      Sample Code to reproduce the problem:<br />
      <br />
      !include "MUI.nsh"<br />
      !define MUI_PRODUCT "Modern UI Test"<br />
      !define MUI_VERSION "1.65"<br />
      OutFile "Basic.exe"<br />
      <br />
      !insertmacro MUI_PAGE_INSTFILES<br />
      !insertmacro MUI_LANGUAGE "English"<br />
      <br />
      Section "modern.exe" SecCopyUI<br />
      ClearErrors<br />
      CopyFiles "C:\1.txt" "D:\"<br />
      IfErrors +1 +3<br />
      MessageBox MB_OK|MB_ICONSTOP|MB_TOPMOST "Copy Failed"<br />
      Goto +2<br />
      MessageBox MB_OK|MB_ICONSTOP|MB_TOPMOST "Copy OK"<br />
      SectionEnd<br />
      <br />
      Complile this, and ensure that C:\1.txt does not exist. On Win2k, it will flag a error on CopyFiles, NT4 will report it as OK.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mgillespie</span><br />
      <span class="post-time small text-muted">21st July 2003 19:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Has anyone reproduced this problem? Or is it me????</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mgillespie</span><br />
      <span class="post-time small text-muted">21st July 2003 21:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">the problems with return values from SHFileOperation under NT4 seem to be widely reported on Google, but nothing I can see on MSDN.<br />
      <br />
      Is there any reason SHFileOperation is used over the more usual CopyFile() functions from the FileStorage PlatformSDK?<br />
      <br />
      This seems to work correctly on NT4:<br />
      <br />
      case EW_COPYFILES: // CopyFile (added by NOP)<br />
      {<br />
      int res;<br />
      char *buf0=process_string_fromparm_tobuf(0x00);<br />
      char *buf1=process_string_fromparm_tobuf(0x11);<br />
      log_printf3("CopyFiles \"%s\"-&gt;\"%s\"",buf0,buf1);<br />
      buf0[mystrlen(buf0)+1]=0;<br />
      buf1[mystrlen(buf1)+1]=0;<br />
      <br />
      wsprintf(buf2,"%s%s",LANG_STR(LANG_COPYTO),buf1);<br />
      res = !CopyFile( buf0, buf1, TRUE );<br />
      if (res)<br />
      { // some of these changes were from Edgewise (wiked_edge@yahoo.com)<br />
      update_status_text_from_lang(LANG_COPYFAILED,"");<br />
      g_flags.exec_error++;<br />
      }</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">21st July 2003 21:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">This was a bug and was actually fixed early today by Kichik.<br />
      Please download the latest CVS.<br />
      <br />
      -Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">22nd July 2003 08:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I wish that was true Afrow, but unfortunately I don't have access to Microsoft code yet :) As mgillespie said, it's a bug with SHFileOperation under NT 4 SP6.<br />
      <br />
      CopyFile is not used because, at least according to MSDN, it does not support wild cards. We might end up writing our own NSFileOperation because this function only brings problems. For now, you'll have to avoid this bug using either methods you've already presented above.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">22nd July 2003 16:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">LOL my mistake :)<br />
      <br />
      The best way would be to:<br />
      <br />
      CopyFiles "sourcefile" "copiedfile"<br />
      IfFileExists "copiedfile" 0 +3<br />
      <br />
      -Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mgillespie</span><br />
      <span class="post-time small text-muted">22nd July 2003 20:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That would cover 1 aspect of the problem, but there are many other problems that could case a file copy to fail, but would not get trapped.<br />
      <br />
      I am using tweaked Installer source anyhow, so I may just change the EW_COPYFILES case to use CopyFile (until something happens in the mainstream code to fix this).<br />
      <br />
      It does seem this particular script function is troublesome, as it also causes compile problems on VS6 without the latest Platform SDK. Writing a dedicated CopyFile with wildcards function would solve this also.<br />
      <br />
      If someone could supply a quick spec for a wildcard FileCopy, I can do some code for it (if required), and submit it.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">23rd July 2003 13:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">To supply wild card support you can copy the code from EW_DELETEFILE. If you're already on it, why not add RMDir support too and make it a complete replacement for EW_DELETEFILE, EW_RMDIR, EW_RENAME and EW_COPYFILES?</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
