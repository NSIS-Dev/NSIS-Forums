<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Vista problem using CopyFiles"><title>Vista problem using CopyFiles - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Vista problem using CopyFiles</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=275954">Vista problem using CopyFiles</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">KrisAster</span><br><span class="post-time small text-muted">15th August 2007 14:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Vista problem using CopyFiles</strong><br>I have an install that uses CopyFiles to copy some larger files. Because it is not in silent mode (nor do I want it to be), a progress dialog opens. But, when being run on Vista this progress dialog does not close when the files have finished copying.<br><br>I made a simple installer just to test the problem, which looks something like:<br><br></p><pre>
<code>CopyFiles "temp.txt" "temp2.txt" ; temp.txt being 10 MBs</code>
</pre><br><br>The progress dialog becomes a dead window after it's finished. It will still allow the user to interact with the windows underneath, and when the finish button is pressed and the installer is closed the progress dialog will disappear. Obviously, though, this behavior is not desireable.<br><br>Has anyone else had this problem and is there a workaround?<br><br>Thank you.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Backland</span><br><span class="post-time small text-muted">15th August 2007 14:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">If you set the /SILENT flag for CopyFiles, it will only supress that progress dialog, it will not make your installer a silent one, if thats what you mean.<br><br>Obviously this is only a workaround and there will be no progress report at all. Does the problem also occur with smaller files (&lt;1MB)?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">KrisAster</span><br><span class="post-time small text-muted">15th August 2007 16:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">No, this problem does not occur on files &lt; 1MB because the dialog does not show up.<br><br>I've contemplated using the /SILENT mode as a workaround, but when copying 300MBs or more it could seem as if the installation hung.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">demiller9</span><br><span class="post-time small text-muted">15th August 2007 16:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I don't have personal experience with Vista, but I've read that file copies sometimes don't finish for a very long time. The file copy progress dialog is generated by the API called to do the copy. If it doesn't close at the end, that sounds like a Vista issue and not an NSIS issue.<br><br>Don</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">KrisAster</span><br><span class="post-time small text-muted">15th August 2007 18:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I think you're probably right demiller9. It does seem to be at minimum a change in the way that Microsoft handles its copy dialog.<br><br>I DO know that the copy is finished by the time it moves on. The progress dialog (behind the poped up dialog) will show the rest of the installation continuing as it should. When finished is pressed, the offending dialog is removed.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Backland</span><br><span class="post-time small text-muted">15th August 2007 19:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I'm guessing a look at the NSIS source which calls that particular shell function might reveal more.<br><br>If someone with Vista could also try to replicate the issue, it could also tell us if its a Vista or NSIS problem, or an issue that is specific to your script.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">KrisAster</span><br><span class="post-time small text-muted">15th August 2007 19:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Here is a copy of the .NSI file I used to duplicate the problem. As you may be able to see, there is nothing special about it. It has the code that I had mentioned earlier was able to duplicate the problem.<br><br>All it really does is copy TEMP.TXT to TEMP2.TXT in the directory of the Setup.exe. TEMP.TXT needs to be of a substantial size to open up that dialog.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">KrisAster</span><br><span class="post-time small text-muted">15th August 2007 19:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I suppose it *might* help if I attached the script.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">15th August 2007 21:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You should always use full paths with CopyFiles. That might not solve the problem but should prevent others.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">KrisAster</span><br><span class="post-time small text-muted">16th August 2007 15:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks for the tip. This was just a dummy test script. In my release script full paths are used.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">thegrinch</span><br><span class="post-time small text-muted">18th August 2007 12:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hi!<br><br>I am just sitting here being confronted with exactly the same problem:<br><br>My installer copies a larber amount of files and the status dialog does not disappear as it should after being finished.<br><br>As soon as the user confirms with the "Finish" button the installer, both the installer as well as the CopyFiles status dialog close.<br><br>I did not use the /SILENT option.<br><br>Is this behaviour a known bug? Or, since the installer was compiled some weeks ago, has this bug perhaps already been solved ???<br><br>Thank you for your gread support and help in advance!<br><br>Best regards!<br><br>thegrinch</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">18th August 2007 12:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">It's not a known bug of NSIS, but I wouldn't be surprised to find out it's a known bug of Vista which will be fixed in SP1. Have you tried this with the SP1 beta?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">thegrinch</span><br><span class="post-time small text-muted">18th August 2007 13:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">No, I hav not tried this.<br><br>To be honest, today is the first time for me to really test and try my installers under Vista. Up to now I tried to "get around" the - sorry for saying so - mess of Vista. As far as I knew, Service Packs just consist of a collection of updates. So, if one installs all updates, there should not be a difference to installing the Service Pack. Am I right?<br><br><br>Again, thank you very much for your great and fast answers!<br><br>regards<br><br>thegrinch</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">18th August 2007 13:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><i>Originally posted by thegrinch</i><br><b>As far as I knew, Service Packs just consist of a collection of updates. So, if one installs all updates, there should not be a difference to installing the Service Pack. Am I right?</b></blockquote>No. Take XP SP2 as an example. It had lots of functionality changes not available as separate updates. Vista SP1 should also have some of those like their latest "improved performance pack" which also speaks about file copy performance.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">demiller9</span><br><span class="post-time small text-muted">18th August 2007 23:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Microsoft has article KB931770 on Vista copy problems "<a href="http://support.microsoft.com/default.aspx/kb/931770" target="_blank">The copy process may stop responding...</a>" and a lengthy discussion is here "<a href="http://forums.microsoft.com/TechNet/ShowPost.aspx?PostID=1138289&amp;SiteID=17" target="_blank">calculating time remaining moving,deleting,copying files very slow</a>"<br><br>The people who posted in the forum (second link) claim the hotfix in the first link also worked on copies made on their local drives, not just to the network like the hotfix mentions.<br><br>Don</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">1st September 2007 08:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Well? Has anyone tried <a href="http://thehotfixshare.net/board/index.php?showtopic=3170&amp;hl=931770" target="_blank">KB931770</a>?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">BrianWeed</span><br><span class="post-time small text-muted">21st September 2007 15:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I am also having this problem....CopyFiles dialog does not close on Vista.<br><br>Is there an alternative to CopyFiles (that will copy files with a progress bar, not from the embedded archive).</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">21st September 2007 16:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You can run CopyFiles silently with the /SILENT flag, but you should try KB931770 first.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">BrianWeed</span><br><span class="post-time small text-muted">29th August 2008 23:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Adding the following code after the CopyFiles instruction also seems to workaround the problem (in some cases):<br><br>System::Call `kernel32::GetModuleHandle(i 0) i.R3`<br>System::Call `user32::CreateWindowEx(i 0, t "STATIC", t "", i ${WS_CHILD}|${WS_VISIBLE}, i 0, i 0, i 100, i 100, i $HWNDPARENT, i 0, i R3, i 0) i.R1`<br><br>Sleep 900<br><br>System::Call `user32::DestroyWindow(i R1)`</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">stb</span><br><span class="post-time small text-muted">31st August 2008 20:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I cannot recommend using CopyFiles for installers. It has several problematic side effects (e.g. copying meta data of files). You generally do not want those effects.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">BrianWeed</span><br><span class="post-time small text-muted">2nd September 2008 15:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">We also found that calling MessageBox after CopyFiles will prevent the problem (causes the CopyFiles dialog box to go away when the MessageBox dialog comes up).</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Johnm312</span><br><span class="post-time small text-muted">12th September 2008 01:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">One of my main installers is biased on NSIS and the ability to copy files and with additional scripting option the hunt and pick through hundred of folders with 1000's of files in My add-on packs to install the exact game packs my users wants for their game play environment. This bug is becoming a bit of a pain in that arse for me.<br><br><br>I am sure it is a vista thing. It usually only does it on the first pass, after that it is fine until I let it sit for a while. then it starts all over with the 0MB found 0Seconds remaining.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">bgutman</span><br><span class="post-time small text-muted">4th March 2009 08:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I've found a workaround for this bug. It's not pretty, but seems to work.<br><br>It is based on the observation that "Copy Files" dialog is a top-level window belonging to the same process as the setup. Thus, we enumerate top-level windows, looking for one from the same process whose handle is different from HWNDPARENT. When found, we kill its thread with TerminateThread(). I know this is brutal and not recommended, but there seems to be no other way. Sending a WM_CLOSE message to this window changes dialog's title to "Canceling..." , but does not close it.<br><br></p><pre>
<code><br>Function VistaCopyFilesWorkaround<br>        ;get PID into $R1<br>        System::Call "kernel32::GetCurrentProcessId() i.R1"<br>        ;define callback for EnumWindows<br>        System::Get "(i.r1, i) iss"<br>        Pop $R0<br>        System::Call "user32::EnumWindows(k R0, i) i.s"<br>        loop:<br>                Pop $0<br>                StrCmp $0 "callback1" 0 done<br>                System::Call "user32::GetWindowThreadProcessId(i r1, *i .r2) i.r3"<br>                ;hwnd=$1, process ID=$2, thread ID=$3<br>                StrCpy $0 "1" ; callback's return value (1=continue enumeration)<br>                IntCmp $2 $R1 0 onceagain onceagain<br>                        ;same process, check HWND<br>                        IntCmp $HWNDPARENT $1 onceagain 0 0<br>                        ;different HWND found, try to close<br>                        System::Call "kernel32::OpenThread(i 1, i 0, i $3) i.r4"<br>                        System::Call "kernel32::TerminateThread(i $4, i 0)"<br>                        StrCpy $0 "0" ; callback's return value (0=break enumeration)<br>                onceagain:<br>                Push $0<br>                System::Call "$R0"<br>                Goto loop<br>        done:<br>        System::Free $R0<br>FunctionEnd<br></code>
</pre><br>
      <br>
      Call this function after CopyFiles.<br>
      Hope this helps someone ;)
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Collector9999</span><br>
      <span class="post-time small text-muted">9th March 2009 00:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I tried this function, but it did not work. Could it be because I have Vista 64? My installers copy large files from existing CDs. I don't want to suppress all of the progress dialog. Is there anyway to just suppress the copy popup?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bgutman</span><br>
      <span class="post-time small text-muted">12th March 2009 09:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        Could it be because I have Vista 64?
      </blockquote>Maybe, I only tested on Vista 32.<br>

      <blockquote>
        Is there anyway to just suppress the copy popup?
      </blockquote>Yes, use "CopyFiles /SILENT"
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>