<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="SelfDel plugin crashes on Win7 64Bit"><title>SelfDel plugin crashes on Win7 64Bit - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">SelfDel plugin crashes on Win7 64Bit</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=321733">SelfDel plugin crashes on Win7 64Bit</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">adriatik</span><br><span class="post-time small text-muted">17th August 2010 10:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>SelfDel plugin crashes on Win7 64Bit</strong><br>&nbsp; Hi!<br><br>I am facing a problem with the SelfDel plugin for NSIS on machines with win 7 64 bit. i am not sure which is the problem win 7 or 64bit.<br><br>It works very well unter win xp.<br><br>Can any one help with a (alternative) solution?<br><br>Thanx</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">17th August 2010 10:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">If the installer is small, you can use the same trick that NSIS uninstallers use: Copy the exe to the temp folder, run that with the original $exepath as a parameter, exit the original exe, and in .onInstSuccess delete the original.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">17th August 2010 11:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Don't post another topic.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">adriatik</span><br><span class="post-time small text-muted">17th August 2010 11:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">how is deleted then the copy ... or you still have it in the temp folder...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">17th August 2010 11:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Yes, it will be left behind in the temp folder. That's why this should only be used for very small files.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">adriatik</span><br><span class="post-time small text-muted">17th August 2010 11:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">nice solution but it is not the one i am looking for. i cannot let the copy into the temp folder. thanks though.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">17th August 2010 12:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">There isn't really any other way that I can think of. Even SelfDel injects code into a new instance of explorer.exe which waits until it can delete your chosen file. SelfDel will not work on 64-bit because the explorer.exe process is 64-bit and NSIS is not. Unless NSIS becomes 64-bit (which is not any time soon) then you have no choice but to write your own plug-in or executable to act like SelfDel does.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Animaether</span><br><span class="post-time small text-muted">17th August 2010 13:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">what if you write out a batch file on first installer run that re-runs the installer (with a flag so you can differentiate between initial run and full run), deletes the installer and deletes itself.. run that and exit the initial installer?<br>batch files can self-destruct.. the parser will complain about the batch file no longer existing, but that's kinda the point?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">17th August 2010 13:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You could use a VBS as well which will run hidden and can also delete itself leaving no trace.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">17th August 2010 13:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The SelfDel plugin should be changed and use rundll32.exe and not explorer</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Takhir</span><br><span class="post-time small text-muted">17th August 2010 18:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">SelfDel may not work on Vista, 2008, Win7 because of security limitations. And Afrow is right - no way to attach 32-bit thread to 64-bit process.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">mrjohn</span><br><span class="post-time small text-muted">5th July 2011 12:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hi adriatik,have you found some solution ?<br>I have the same problem and I tought to create a exe with nsis,pack it in original installer,drop it to TEMP then call it with EXEC command and pass main installer path,something like this :<br><br></p><pre>
!include FileFunc.nsh
<br>&gt;!include "WordFunc.nsh"
<br><br><br>&gt;Name "Example1"
<br><br>&gt;OutFile "example1.exe"
<br><br>&gt;RequestExecutionLevel user
<br>&gt;!insertmacro GetParameters
<br><br>Section ""
<br>  SetAutoClose true
<br>  SetOverwrite on
<br><br> ;File example1.nsi
<br>SectionEnd 
<br><br>&gt;Function .onInit
<br>   var /GLOBAL cmdLineParams
<br>    Push $R0
<br>   ${GetParameters} $cmdLineParams
<br>    StrCmp  $cmdLineParams"" lblExit
<br>    StrCmp  $cmdLineParams"/S" lblExit
<br><br>   ${WordReplace} $cmdLineParams "/S" "" "+" $cmdLineParams
<br>  IfFileExists"$cmdLineParams" 0 lblExit
<br>    sleep 2000
<br>    delete $cmdLineParams
<br>      
<br>lblExit:
<br>&gt;FunctionEnd 
<br>&gt;

</pre>Is it a good way ?<br>
      Thanks !
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mrjohn</span><br>
      <span class="post-time small text-muted">6th July 2011 12:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I've update the code,this works fine on XP<br>
      <br></p>
      <pre>
<code>
nsh
<br>&gt;!include "WordFunc.nsh"
<br><br>&gt;Name "dlfile"
<br><br>&gt;OutFile "dlfile.exe"
<br><br>&gt;RequestExecutionLevel user
<br>&gt;!insertmacro GetParameters
<br><br>Section ""
<br>  SetAutoClose true
<br>  SetOverwrite on
<br><br><br>SectionEnd 
<br><br>&gt;Function .onInit
<br>   var /GLOBAL cmdLineParams
<br>    Push $R0
<br>   ${GetParameters} $cmdLineParams
<br>    StrCmp  $cmdLineParams"" lblExit
<br>    StrCmp  $cmdLineParams"/S" lblExit
<br><br>   ${WordReplace} $cmdLineParams "/S" "" "+" $cmdLineParams
<br>   Push $cmdLineParams
<br>   Call Trim
<br>   Pop $cmdLineParams
<br><br>  IfFileExists $cmdLineParams 0 lblExit
<br>    sleep 2000
<br>    delete $cmdLineParams
<br>      
<br>lblExit:
<br>&gt;Delete /rebootok $EXEFILE
<br>FunctionEnd
<br><br><br>&gt;Function Trim
<br>    Exch $R1 
<br>    Push $R2
<br><br>Loop:
<br>   StrCpy $R2 "$R1" 1
<br>    StrCmp"$R2" " " TrimLeft
<br>    StrCmp"$R2" "$\r" TrimLeft
<br>    StrCmp"$R2" "$\n" TrimLeft
<br>    StrCmp"$R2" "$\t" TrimLeft
<br>    GoTo Loop2
<br>TrimLeft:
<br>   StrCpy $R1 "$R1" "" 1
<br>    Goto Loop
<br><br>Loop2:
<br>   StrCpy $R2 "$R1" 1 -1
<br>    StrCmp"$R2" " " TrimRight
<br>    StrCmp"$R2" "$\r" TrimRight
<br>    StrCmp"$R2" "$\n" TrimRight
<br>    StrCmp"$R2" "$\t" TrimRight
<br>    GoTo Done
<br>TrimRight:
<br>   StrCpy $R1 "$R1" -1
<br>    Goto Loop2
<br><br>Done:
<br>    Pop $R2
<br>    Exch $R1
<br>FunctionEnd 
<br>&gt;
</code>
</pre>usage:<br>
      <pre>
<code>
onGUIEnd
<br>  Exec 'dlfile.exe /S $EXEFILE'
<br>&gt;FunctionEnd 
<br>&gt;
</code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mrjohn</span><br>
      <span class="post-time small text-muted">7th July 2011 10:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The correct use is to pass $EXEPATH not $EXEFILE<br>
      So dropt that exe to $temp and usage is :<br></p>
      <pre>
<code>
 SetOutPath "$TEMP"
<br>   FILE dlfile.exe
<br>    Exec '$TEMP\dlfile.exe /S $EXEPATH' 
</code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">7th July 2011 11:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Bit of a messy implementation. How about just adding SilentInstall silent to avoid having to use /S (so no need for WordReplace and no UI resource is included either).<br>
      <br>
      Stu</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mrjohn</span><br>
      <span class="post-time small text-muted">7th July 2011 12:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks Afrow UK,done : <a href="http://forums.winamp.com/attachment.php?attachmentid=48958" target="_blank" title="Name: Views: Size: ">Attachment 48958</a><br>
      <br>
      usage :<br></p>
      <pre>
<code> SetOutPath "$TEMP"
<br>   FILE dlfile.exe
<br>    Exec '$TEMP\dlfile.exe $EXEPATH' 
</code>
</pre>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>