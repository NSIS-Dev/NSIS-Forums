<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="How to detect Windows Installer version?" />

  <title>How to detect Windows Installer version? - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">How to detect Windows Installer version?</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=242875">How to detect Windows Installer version?</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Kypec</span><br />
      <span class="post-time small text-muted">7th April 2006 15:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>How to detect Windows Installer version?</strong><br />
      Hi guys,<br />
      <br />
      is there some easy way to detect which version<br />
      of M$ Windows Installer is present on user's system?<br />
      What I want to achieve is this:<br />
      I have created my NSIS installer which detects the version<br />
      of .NET Framework (via DotNET.nsh) and runs <b>dotnetfx.exe</b> externally if needed.<br />
      The problem is, however, that this package requires another M$ prerequisite to be there =&gt; <b>WindowsInstaller-KB893803-v2-x86.exe</b><br />
      How can one find out whether this MSI 3.1 is already installed on user's system?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">galil</span><br />
      <span class="post-time small text-muted">7th April 2006 15:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Do a GetDLLVersion (as described in the manual or here: <a href="http://nsis.sourceforge.net/GetDllVersion_Command_Explained" target="_blank">http://nsis.sourceforge.net/GetDllVe...mand_Explained</a>) on "$SYSDIR\msi.dll"<br />
      You probably don't need to check release &amp; build parts though.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">7th April 2006 15:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You can check the version of $SYSDIR\msi.dll using GetDLLVersion. It's hardly the official method, but I couldn't find anything about it in MSDN.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">iceman_k</span><br />
      <span class="post-time small text-muted">7th April 2006 15:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by kichik</i><br />
        <b>You can check the version of $SYSDIR\msi.dll using GetDLLVersion. It's hardly the official method, but I couldn't find anything about it in MSDN.</b>
      </blockquote>It's probably the closest thing to an official method that you are going to get. It's what the Windows Installer team says you should do.<br />
      <a href="http://blogs.msdn.com/windows_installer_team/archive/2005/09/09/458528.aspx" target="_blank">http://blogs.msdn.com/windows_instal...09/458528.aspx</a>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Kypec</span><br />
      <span class="post-time small text-muted">7th April 2006 15:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Many thanks to all of you for quick replies.<br />
      I'll try what you are suggesting.:)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">panccio</span><br />
      <span class="post-time small text-muted">17th April 2006 14:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">i thank to all too.. :D</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">dhruba.bandopad</span><br />
      <span class="post-time small text-muted">10th July 2006 13:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What happens if there is no Windows Installer installed at all? Will the script crash?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">19th July 2006 14:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">No, you'll just get no version from GetDLLVersion.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">drifa</span><br />
      <span class="post-time small text-muted">30th October 2007 07:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">go to start=&gt;run and type msiexec</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">meaningoflights</span><br />
      <span class="post-time small text-muted">6th July 2008 03:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I know this thread is old but here's a working example:<br />
      <br />
      !macro CHECK_MSI_VERSION<br />
      <br />
      GetDllVersion "$SYSDIR\msi.dll" $R0 $R1<br />
      IntOp $R2 $R0 &gt;&gt; 16<br />
      IntOp $R2 $R2 &amp; 0x0000FFFF ; $R2 now contains major version<br />
      IntOp $R3 $R0 &amp; 0x0000FFFF ; $R3 now contains minor version<br />
      IntOp $R4 $R1 &gt;&gt; 16<br />
      IntOp $R4 $R4 &amp; 0x0000FFFF ; $R4 now contains release<br />
      IntOp $R5 $R1 &amp; 0x0000FFFF ; $R5 now contains build<br />
      StrCpy $0 "$R2.$R3.$R4.$R5" ; $0 now contains string like "1.2.0.192"<br />
      <br />
      MessageBox MB_ICONINFORMATION|MB_OK "The version is: $R2.$R3.$R4.$R5"<br />
      <br />
      !macroend</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jweinraub</span><br />
      <span class="post-time small text-muted">3rd May 2010 16:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">How do you detect if you have an older version installed?<br />
      For example, .net framework 2.0 requires at least version 3.1 (the above installed is 3.1.4000.2435).<br />
      <br />
      However I have 4.5.6001.22299 installed.<br />
      <br />
      Doesn't seem to work.<br /></p>
      <pre>
<code><br />GetDllVersion "$SYSDIR\msi.dll" $R0 $R1<br />IntOp $R2 $R0 &gt;&gt; 16<br />IntOp $R2 $R2 &amp; 0x0000FFFF ; $R2 now contains major version<br />IntOp $R3 $R0 &amp; 0x0000FFFF ; $R3 now contains minor version<br />IntOp $R4 $R1 &gt;&gt; 16<br />IntOp $R4 $R4 &amp; 0x0000FFFF ; $R4 now contains release<br />IntOp $R5 $R1 &amp; 0x0000FFFF ; $R5 now contains build<br />StrCpy $0 "$R2.$R3.$R4.$R5" ; $0 now contains string like "1.2.0.192"<br /><br />MessageBox MB_ICONINFORMATION|MB_OK "The version is: $R2.$R3.$R4.$R5"<br />${If} $0 &lt; "3.1.4000.2435"<br />MessageBox MB_ICONINFORMATION|MB_OK "Install 3.1"<br />${Else}<br />MessageBox MB_ICONINFORMATION|MB_OK "Go away!"<br />${EndIf}<br /></code>
</pre><br />
      <br />
      How can I use the individual numbers since I need it to have at least 3.1 to go on, so anything less has to have it install.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Animaether</span><br />
      <span class="post-time small text-muted">3rd May 2010 17:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by jweinraub</small><br />
        For example, .net framework 2.0 requires at least version 3.1 (the above installed is 3.1.4000.2435).<br />
        <br />
        However I have 4.5.6001.22299 installed.<br />
        <br />
        Doesn't seem to work.<br />
        <pre>
<code><br />${If} $0 &lt; "3.1.4000.2435"<br /></code>
</pre>
      </blockquote>Use ${VersionCompare} out of WordFunc.nsh (ships with NSIS) for comparing version numbers. Right now you're using a string comparison which can fail on version numbers.<br />
      ( You can also replace the first part of your code with ${GetFileVersion} out of FileFunc.nsh (ships with NSIS) )<br />
      <br />
      That said... even with the above deficiency, this particular case should work just fine and pop up the "Go away!" messagebox. try sticking a 'MessageBox MB_OK "[$0]"' just in front of the ${If} so you can double-check that the value of $0 is what you're expecting it to be.<br />
      ( since you're reading from $SYSDIR, also keep in mind any filesystem redirection magic on 64bit platforms )
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jweinraub</span><br />
      <span class="post-time small text-muted">3rd May 2010 17:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Is there a different installer needed if there is a 64-bit system in place?<br />
      <br />
      Because I have both .net installers for 32-bit and 64-bit versions of Windows.<br />
      My software is installed on laptops that will not have internet access therefore it is critical all prerequisites are met from the installation media itself.<br />
      <br />
      What should I be aware of for 64-bit versions for the checker?<br />
      <br /></p>
      <pre>
<code><br />${VersionCompare} $0 "3.1.4000.2435" $R0  <br />  MessageBox MB_ICONINFORMATION|MB_OK $R0  ; if R0 is 2 then install msi 3.1 installer, else go on?<br /></code>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Animaether</span><br />
      <span class="post-time small text-muted">3rd May 2010 18:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by jweinraub</small><br />
        Is there a different installer needed if there is a 64-bit system in place?
      </blockquote>No, you can have both 32bit and 64bit installers in the same package.<br />
      <br />

      <blockquote>
        <small>Originally posted by jweinraub</small><br />
        What should I be aware of for 64-bit versions for the checker?
      </blockquote>Specifically, the Sytem32 folder.<br />
      On x64 platforms, if a 32bit application reads from the system folder (i.e. $SYSDIR), it gets redirected to a different folder named SysWOW64 (Windows(32) On Windows64). So if you need to target the 64bit version of the windows installer for that part, then you will have to disable filesystem redirection (Windows XP) or read from the SysNative folder (Vista, 7) instead.<br />
      Have a search through the forums - this pops up a few times :)<br />
      <br />

      <blockquote>
        <small>Originally posted by jweinraub</small><br />
        <pre>
<code><br />${VersionCompare} $0 "3.1.4000.2435" $R0  <br />  MessageBox MB_ICONINFORMATION|MB_OK $R0  ; if R0 is 2 then install msi 3.1 installer, else go on?<br /></code>
</pre>
      </blockquote>correct - but, again, check whether the value of $0 is what you're expecting it to be with a little messagebox first.. if you have further scripts inbetween $0 might be overwritten, or perhaps the file doesn't exist and the version returned would be 0.0.0.0, etc.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jweinraub</span><br />
      <span class="post-time small text-muted">3rd May 2010 18:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by Animaether</small><br />
        No, you can have both 32bit and 64bit installers in the same package.
      </blockquote>No I meant the WindowsInstaller-KB893803-v2-x86.exe installer. Is ther an x64 version as well.<br />
      <br />
      Because I do this for x64 when it comes to .net.<br />
      <br />
      <pre>
<code> ; Detect .net 2.0 here ;<br />  System::Call `mscoree::GetCORVersion(w .R0, i ${NSIS_MAX_STRLEN}, *i) ?u`<br />  StrCpy $R0 $R0 1 1<br /><br />  ; Compare if $R0 &lt; 2 using ${If}<br /><br />  ${If} $R0 &lt; 2<br />     ; First detect if this is a 64 bit OS because you will want to install that instead ...<br />     GetVersion::WindowsPlatformArchitecture<br />     Pop $R1<br />     ${AndIf} $R1 == 64<br />        SetDetailsPrint textonly<br />        DetailPrint "Installing Microsoft .NET 2.0 x64.  This may take up to ten minutes, please be patient."<br />        SetDetailsPrint none<br />        ExecWait `"$INSTDIR\Misc\NetFx64.exe" /q:a /c:"install.exe /noaspupgrade /qb"` $R0<br />        ;SetRebootFlag true<br />     ${OrIf} $R1 == 32<br />        SetDetailsPrint textonly<br />        DetailPrint "Installing Microsoft .NET 2.0..."<br />        SetDetailsPrint none<br />        ExecWait `"$INSTDIR\Misc\dotnetfx.exe" /q:a /c:"install.exe /noaspupgrade /qb"` $R0<br />        ;SetRebootFlag true<br />  ${Else}<br />     Goto go_on<br />  ${EndIf}<br /></code>
</pre><br />
      <br />

      <blockquote>
        Originally Posted by <strong>Animaether</strong> Specifically, the Sytem32 folder.<br />
        On x64 platforms, if a 32bit application reads from the system folder (i.e. $SYSDIR), it gets redirected to a different folder named SysWOW64 (Windows(32) On Windows64). So if you need to target the 64bit version of the windows installer for that part, then you will have to disable filesystem redirection (Windows XP) or read from the SysNative folder (Vista, 7) instead.
      </blockquote>I apologise but this part I am still unclear with. I understand the different sys dirs (like program dirs), but isnt the global variable determine the correct path at runtime?<br />
      Essentially if the user doesnt have msi installer, or an older version than 3.1 I like for it to be installed. Other wise if the version is equal to or newer than the minimum it should do nothing and go on.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jweinraub</span><br />
      <span class="post-time small text-muted">3rd May 2010 18:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">why do i get all that whitespace at line breaks?!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">3rd May 2010 19:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">There doesn't appear to be a 64-bit version of Windows Installer 3.1 - I assume 4.5 is for those platforms. The forum puts in those new lines. I did ask one of the administrators but they haven't done anything. Instead of using the GetVersion plug-in you can just !include x64.nsh and use ${If} ${RunningX64}.<br />
      <br />
      Edit: If you're thinking of SetShellVarContext then that is something else. File system redirection is part of the OS and as already mentioned specifying for example C:\Windows\System32 when querying the file system from a 32-bit application, it will be redirected to C:\Windows\SysWOW64.<br />
      <br />
      Edit #2: In other words MessageBox MB_OK $SYSDIR will print the expected value (System32) but if you write to it your file will be in SysWOW64 instead unless you do ${DisableX64FSRedirection} first.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jweinraub</span><br />
      <span class="post-time small text-muted">3rd May 2010 20:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What does SetShellVarContext have to do with this? I actually make use of it only so that it installs on desktop shortcuts for All Users rather than local user (i already assume its being installed by admin).<br />
      <br />
      So for intents and purposes, I can use the VersionCompare the way I am so I can just call the installer if necessary?<br />
      <br />
      I assume even if it 0.0.0.0, the 3.x.x.x is still greater so it'll still install if needed, correct?<br />
      <br />
      So what am I missing here by just doing it the way above?<br />
      <br />
      Can I just do this?<br />
      <br />
      ; ... snip<br />
      ${VersionCompare} $0 "3.1.4000.2435" $R0<br />
      ${If} $R0 == 2<br />
      SetDetailsPrint textonly<br />
      DetailPrint "Installing Microsoft Windows Installer 3.1..."<br />
      SetDetailsPrint none<br />
      ExecWait `"$INSTDIR\Misc\WindowsInstaller-KB893803-v2-x86.exe" /quiet"` $R0<br />
      ${EndIf}<br />
      ; ... snip</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">3rd May 2010 20:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">SetShellVarContext has nothing to do with it, hence why I said that. VersionCompare will read an empty string as 0 (so an empty $0 will not break the code).<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
