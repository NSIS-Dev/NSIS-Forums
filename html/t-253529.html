<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Can somebody explain me how I can use upx" />

  <title>Can somebody explain me how I can use upx - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Can somebody explain me how I can use upx</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=253529">Can somebody explain me how I can use upx</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">UVV</span><br />
      <span class="post-time small text-muted">18th August 2006 13:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Can somebody explain me how I can use upx</strong><br />
      Now I have bat file with next context:<br /></p>
      <pre>
<code><br />del Weight.exe<br />upx --best --crp-ms=999999 --nrv2d -o Weight.exe WareHouse.exe<br />pause<br /></code>
</pre><br />
      I've read the manual, but I don't understand.<br />
      Can you explain me, what I have to write instead "$%TEMP%\exehead.tmp" that this commands will be identical?<br />
      <pre>
<code><br />!packhdr "$%TEMP%\exehead.tmp" '"C:\Program Files\UPX\upx.exe" "$%TEMP%\exehead.tmp"'<br /></code>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mihasic</span><br />
      <span class="post-time small text-muted">18th August 2006 13:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Manual says:<br />
      [skip]<br />
      Specify a temporary file name (such as "temp.dat") and a command line (such as "C:\program files\upx\upx -9 temp.dat") to compress the header.<br />
      <br />
      Russian:<br />
      Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¸Ð¼Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð° (Ñ‚Ð°ÐºÐ¾Ðµ ÐºÐ°Ðº "temp.dat") Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, "C:\program files\upx\upx -9 temp.dat")<br />
      <br />
      The temporary name could be any file name (maybe there are some restrictions), you can use the same name as in example (i.e. "temp.dat").<br />
      (Ð˜Ð¼Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð° Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð»ÑŽÐ±Ñ‹Ð¼ (Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ ÐµÑÑ‚ÑŒ ÐºÐ°ÐºÐ¸Ðµ-Ñ‚Ð¾ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ), Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ñ‚Ð°ÐºÐ¾Ðµ Ð¶Ðµ Ð¸Ð¼Ñ ÐºÐ°Ðº Ð¸ Ð² Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ðµ ("temp.dat"))</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">UVV</span><br />
      <span class="post-time small text-muted">18th August 2006 13:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I understand this, but where should I write the executable name?<br />
      Am I wrong that upx only pack the executables?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mihasic</span><br />
      <span class="post-time small text-muted">18th August 2006 13:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You should not write executable name (except for OutFile attribute).<br />
      As I wrote, you should write name for temporary file, wich will be compressed. And then (in the second parameter) that name is used at command line.<br />
      UPX compresses files in several executable formats. Extensions of this files are only used by OS, UPX determines file format by it's header.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">UVV</span><br />
      <span class="post-time small text-muted">18th August 2006 14:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">But when I pack the executable with first script (before compiling nsi-script) installer size is smaller in 15-20%. Why?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mihasic</span><br />
      <span class="post-time small text-muted">18th August 2006 19:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I suppose it's because UPX packs whole executable, not only header (as it described in manual).</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">UVV</span><br />
      <span class="post-time small text-muted">19th August 2006 17:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">This code is more efficient for me<br /></p>
      <pre>
<code><br />!define UPXParams '"upx --best --crp-ms=999999 --nrv2d -o ${OutputEXEName} ${InputEXEName}"'<br />!system ${UPXParams}<br /></code>
</pre><br />
      installer size 1.57 MB<br />
      then this<br />
      <pre>
<code><br />!packhdr "$%TEMP%\exehead.tmp" '"upx --best --crp-ms=999999 --nrv2d" "$%TEMP%\exehead.tmp"'<br /></code>
</pre><br />
      installer size 1.89 MB
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">19th August 2006 17:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What exactly are you trying to compress? The first piece of code doesn't compress the installer itself. You can't compress the installer before it's created. Even more, you can't use UPX to compress the complete installer because it'll fail the CRC check. The data after the header/stub is compressed anyway.<br />
      <br />
      What's this ${InputEXEName}? Is it the executable you're distributing? If that's the case, the second piece of code won't change it because it compresses the installer header and not the files the installer extracts.<br />
      <br />
      If you want to compress the distributed executable, the first piece of code is the way to go. However, know that your installer might be bigger because compressing compressed data doesn't usually give the best results.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">UVV</span><br />
      <span class="post-time small text-muted">19th August 2006 17:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by kichik</i><br />
        <b><br />
        What's this ${InputEXEName}? Is it the executable you're distributing? If that's the case, the second piece of code won't change it because it compresses the installer header and not the files the installer extracts.<br /></b>
      </blockquote>Yes, this is that I wanted to know.<br />
      By the way, if I choose another compressor the first part of code executed every time. How could I change this? Only via version compare?
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">19th August 2006 17:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The first piece of code will be executed every time, no matter which compressor you use. !system is only conditioned by !if[def]. !system is executed when you build the installer.<br />
      <br />
      What exactly are you trying to do? What versions do you wish to compare? Do you want to compress the executable only if it's of a certain version? Why not compress it every time?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">UVV</span><br />
      <span class="post-time small text-muted">19th August 2006 19:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by kichik</i><br />
        Why not compress it every time? [/B]
      </blockquote>Is there any reason to do it?<br />
      e.g. I set "Best Compressor" and every time when installer compressing more and more he will be pack with !system every time!<br />
      I think this solution is will be good for me...:<br />
      <pre>
<code><br />section PackExecutable<br /><br />${GetFileVersion} ${OutputEXEName} $0<br />${GetFileVersion} ${InputExeName} $1<br /><br />${VersionCompare} $0 $1 $2<br /><br />${If} $2 == 2<br />  !delfile ${OutputEXEName}<br />  !system ${UPXParams}<br />${EndIf}<br /><br />SectionEnd<br /></code>
</pre><br />
      ... if !delfile don't give compilation error when file isn't exists!
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">19th August 2006 19:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That won't work because GetFileVersion and VersionCompare are run time instructions. Variables such as $2 are also usable only at run time.<br />
      <br />
      -Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">UVV</span><br />
      <span class="post-time small text-muted">19th August 2006 20:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by Afrow UK</i><br />
        <b>That won't work because GetFileVersion and VersionCompare are run time instructions. Variables such as $2 are also usable only at run time.<br />
        <br />
        -Stu</b>
      </blockquote>So, what you advice?
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Comperio</span><br />
      <span class="post-time small text-muted">19th August 2006 23:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Going back to what Kichik already pointed out:<br /></p>

      <blockquote>
        <i>From Kichik:</i><br />
        <br />
        You can't compress the installer before it's created. Even more, you can't use UPX to compress the complete installer because it'll fail the CRC check. The data after the header/stub is compressed anyway.
      </blockquote>In other words, UPX can only compress the exe <b><u>header</u></b> not the full EXE when used from within your script. And, if you try to compress the full EXE after it's created, then you'll run into CRC errors when you try to run it.<br />
      <br />
      In my opinion, the savings you'd gain with UPX (or any other EXE compressor) would be minimal at best, which makes me wonder why you'd even want to bother. (Consider this: A barebones do nothing script compiled with NSIS compiles to about 34K. 34K is tiny!)<br />
      <br />
      So my advice would be that if you want to compress the full EXE, then just specify the compression method as solid lzma in your script. (command: SetCompressor /SOLID lzma) You won't get much better compression than that. (If you do, it will be very minimal at best.)
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
