<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Windows Built-In strings"><title>Windows Built-In strings - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content=" Windows Built-In strings"><title>Windows Built-In strings - NSIS Forums</title><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Windows Built-In strings</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=246116">Windows Built-In strings</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">CancerFace</span><br><span class="post-time small text-muted">13th May 2006 17:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Windows Built-In strings</strong><br>I was wondering if anybody knew how to get the strings that are available as descriptions for the windows Built-in accounts.<br><br>For example the Administrator is described as <i>Built-in account for administering the computer/domain</i> and the Guest is described as <i>Built-in account for guest access to the computer/domain</i>. Where can I find these strings in a language independent way?<br><br>I do not want to pull them out from the system (using say NetUserGetInfo API calls) because they may have been tampered with. Is there a dll or any other file that contains these strings?<br><br>The same goes for the default usernames (Administrator, Guest). Is there a library where they are stored so that I can get them out? Especially if the original names have been changed (and I still want to know what the original name was).<br><br>CF</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">14th May 2006 12:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I think you can check the SID or somthing like that and tell who the original admin was</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">CancerFace</span><br><span class="post-time small text-muted">16th May 2006 22:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks for the input Anders, but I do not think that this is what I am after ... If the original account has been renamed all I can get is the new name using its SID. What I need is to find, say in a French version of windows, what is the equivalent of 'Administrator' without asking the system for the administrator's SID (since that SID may point to a renamed account). The same for any other language ...<br>CF</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">OldGrumpy</span><br><span class="post-time small text-muted">17th May 2006 11:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">If I remember correctly, the Administrator *ALWAYS* has the same (special, reserved) SID...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">CancerFace</span><br><span class="post-time small text-muted">17th May 2006 11:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Maybe my initial post was not clear enough â€¦<br><br>I know that the admin's SID is ALWAYS S-1-5-xx-xxx-xxx-xxx-500 for the local machine (do not pay attention to the number of xs used here). However you can rename that account (change the username) from 'Administrator' or whatever it is in your language to anything you like. So the question was 'how do I find what the original name was, in any language, if all I have is the SID?' Obviously in english it would be 'Administrator' How about in any other language? Is there a file that contains those names?<br><br>For example, if you create a shortcut to cmd.exe and you name it <b>@shell32.dll,-22022</b> then the above will show a localized version of <i>'Command Prompt'</i>. So the string is picked from shell32.dll regardless of the language used and is always localized. Is there something similar for the default windows accounts?<br>...<br>CF</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">OldGrumpy</span><br><span class="post-time small text-muted">17th May 2006 13:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You may want to read this interesting article and the linked resources to get an idea of why your approach seems to be a bad idea :)<br><a href="http://blogs.msdn.com/michkap/archive/2005/12/27/507404.aspx" target="_blank">http://blogs.msdn.com/michkap/archiv...27/507404.aspx</a><br>Here is a list of "well-known SIDs" for your reference:<br><a href="http://support.microsoft.com/default.aspx?scid=kb;EN-US;Q243330" target="_blank">http://support.microsoft.com/default...;EN-US;Q243330</a><br>And some sample code about how to deal with localized names etc.:<br><a href="http://support.microsoft.com/kb/157234/en-us" target="_blank">http://support.microsoft.com/kb/157234/en-us</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">CancerFace</span><br><span class="post-time small text-muted">17th May 2006 13:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">:)<br>Thanks for the tip, however it is still out of context ...<br>I <b>am</b> using the SID to get the name. The problem is that <b><u>if</u></b> the name has been <b>altered</b> by a user, I <b>still</b> want to find out what the <b>original</b> name was.<br><br>In other words, if in a Chinese system the administrator has been renamed to <i>root</i>, can you tell how to find out <b>what</b> the original username was, in Chinese? How do you do that? That's why I assumed that there may be a localized string somewhere that I could use ...<br><br>I do not have an approach yet, this is what I am trying to get through, I don't know how to do this, but I <b>need</b> to know what the original name was :)<br><br>CF</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">OldGrumpy</span><br><span class="post-time small text-muted">17th May 2006 13:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Geez, first of all, why would you need the original name? It isn't useful anymore after the rename. One hint though: if I remember correctly, your "My Files" folder does not change when you rename your account. Dirty hack but probably functional :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Comperio</span><br><span class="post-time small text-muted">17th May 2006 14:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Taking a step backward here:<br><br>Why would you need to know the name of the Administrator account? It sounds a lot like perhaps all you really need is Administrator permissions, correct? If so, perhaps a plugin like the <a href="http://nsis.sourceforge.net/XtInfoPlugin_plug-in#xtInfoPlugin::IsAdministrator" target="_blank">xtinfo plugin</a> or the <a href="http://nsis.sourceforge.net/UserMgr_plug-in" target="_blank">user manager</a> plugin might be of more help.<br><br>But, maybe I'm just not seeing the whole picture here...:confused:</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">CancerFace</span><br><span class="post-time small text-muted">17th May 2006 15:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote>Geez, first of all, why would you need the original name?</blockquote>To avoid any further misunderstandings I should probably explain <b>exactly</b> what I am after:<br><br>I have a scenario where, after renaming the Administrator account in <b>any</b> language I want to create a <b>fake</b> account called 'Administrator', or whatever that name should be in the local language. The new account is stripped from all its privileges and is disabled by default. Some people feel that this will save their system from an attack that will try to get the administrator's password or some other info/function. In my point of view this is useless since, if I where to hack anything out of a system, I would use the SID of the administrator and not the username.<br><br>However, the need remains in the above scenario to create an account called Administrator. In the rare case that the original admin account has <b>already</b> been renamed, there is no way (to my knowledge) to get the original name. In a US/UK version of windows, that's easy, you call that account 'Administrator'. What about in the rest of the languages? Hence my question: How do I find the default name of the admin account? Is there a string stored somewhere?<br><br>I hope this is as clear as I think it is ... The 'dirty hack' suggested by OldGrumpy is the only option until now, but I am still thinking that the system stores the default names in some dll and then the APIs are reading them.<br><br>CF</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">OldGrumpy</span><br><span class="post-time small text-muted">17th May 2006 15:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I'll post that question to a specialist board. Let's see what they come up with :) Maybe these accounts are only created by the Windows installation program ;) I'll keep you updated on the results.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">onad</span><br><span class="post-time small text-muted">17th May 2006 15:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">&gt; How do I find the default name of the admin account? Is there a string stored somewhere?<br><br>Yes there is. You can retreive the info from a DLL resource string. Do first on a clean OS a search in ALL files (suprgrep) and the ntake a resource hacker e.g. <a href="http://www.heaventools.com/" target="_blank">http://www.heaventools.com/</a> PE tools etc.<br><br>Change the resource, retry if it worked.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">OldGrumpy</span><br><span class="post-time small text-muted">17th May 2006 19:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Onad, I did that today on my W2K machine, and couldn't find any suitable occurrences :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">CancerFace</span><br><span class="post-time small text-muted">17th May 2006 20:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Try using PE-Explorer on something like advapi32.dll and you'll see why it wont work :)<br>I have tried looking for the string 'Administrator' before but could not find it. Not to mention that using PEExplorer for each DLL in system32 is probably not the way to go. Or at least not until you post the question in case somebody has alreday tried it before :D<br><br>CF</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">galil</span><br><span class="post-time small text-muted">17th May 2006 20:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You can simply search for string (both ANSI and Unicode) in multiple files - there's plenty of tools that can do that, (including some of the better text editors) out there, you don't need PEExplorer for that.<br><br>However, these are probably set during installation of OS and such default names/desriptions would be present only somewhere in setup files on CD.<br>So probably there's no reliable way to get them without asking user to insert installation disk.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">CancerFace</span><br><span class="post-time small text-muted">18th May 2006 07:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">galil's suggestion made me look up again inside the system folder, for unicode equivalents of the strings I was after. I finally used UltraEdit to do a <b>unicode</b> search and got all the strings I was after in samsrv.dll. I am not sure if this is what I am after but it is a good start :)<br><br>I will experiment with that file to see if I can indeed get what I want but if anyone knows of another way it would be most helpful if you could post it here<br><br>CF</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">CancerFace</span><br><span class="post-time small text-muted">26th May 2006 09:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I think I managed to achieve what I was after, although I cannot check it on another language since I am running an english version of windows.<br>Here is what I did:</p><pre>
<code>!define LOAD_LIBRARY_AS_DATAFILE     0x00000002<br>!define FORMAT_MESSAGE_ALLOCATE_BUFFER  0x00000100<br>!define FORMAT_MESSAGE_FROM_HMODULE     0x00000800<br>System::Call 'kernel32::LoadLibraryExW(w "$SYSDIR\SAMSRV.DLL", i n, i ${LOAD_LIBRARY_AS_DATAFILE}) i .R0'<br>StrCpy $0 ${FORMAT_MESSAGE_FROM_HMODULE}<br>IntOp $0 $0 + ${FORMAT_MESSAGE_ALLOCATE_BUFFER}<br>StrCpy $1 8192 ; messageID for string 'Administrator'<br>System::Call 'kernel32::FormatMessageW(i r0, i R0, i r1, i 0, *w .R3, i 0, i n) i .R4'<br><br>IntOp $9 $R4 * 4<br>System::Call '*(&amp;w$9)i.R3'<br>System::Call 'kernel32::FormatMessageW(i r0, i R0, i r1, i r2, i R3, i r3, i n) i .R4 ?e'<br>System::Call '*$R3(w .R9)'<br>System::Call 'kernel32::LocalFree(i R3)i.R8'<br>System::Free $R0</code>
</pre>I had to call <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/debug/base/formatmessage.asp" target="_blank">FormatMessageW</a> twice: the first time I got the size of the message that I extracted and the second time I allocated an appropriate buffer to store it. Since it is a unicode string I don't want to pass it to a variable in NSIS, but leave it at a buffer instead and then pass that buffer to the next function (not shown here)<br>
      <br>
      I think this should work for every system. The main trick is the usage of the language ID (here I pass it as zero on the 4th parameter of FormatMessage). A better way would be to detect the system default (or the user default) language and then pass it on to the system call.<br>
      <br>
      As always any input is welcome :)<br>
      <br>
      CF
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">OldGrumpy</span><br>
      <span class="post-time small text-muted">26th May 2006 12:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I'm very surprised because I though my favorite search tool would be capable of doing unicode searches too. Obviously, it is not :(<br>
      Thanks for the investigations, CancerFace. BTW, and fully OT, why did you choose this strange nickname? :)</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br>
      <span class="post-time small text-muted">26th May 2006 13:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hmmm, it may be a bit more complicated after all. By default FormatMessage appends a trailing new line character at the end of the message unless an array of formatting instructions is supplied. And this is where I am lost since <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/debug/base/formatmessage.asp" target="_blank">this</a> page doesn't make much sense :(<br>
      I'll have to play a bit more with this ...<br>
      <br>
      Also I should probably unload the DLL using <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dllproc/base/freelibrary.asp" target="_blank">FreeLibrary</a> :</p>
      <pre>
<code>System::Call 'kernel32:FreeLibrary(i R1) i.R8'</code>
</pre>instead of using System::Free<br>

      <blockquote>
        BTW, and fully OT, why did you choose this strange nickname?
      </blockquote>I chose that nickname when I was 18 or so and have been using it ever since without realizing most of the time how awful it sounds ... It used to be a joke from a sailing instructor that I had as a kid, and I can assure you that it sounded funny in my mother language (Greek) but certainly not in English ... Nothing to do with my face or any form of cancer, if that's what you're asking :D<br>
      <br>
      CF<br>
      <br>
      [Edit] Looking at the code I posted again I reallized that I am allocating far more space than needed for my buffer. No need to run the FormatMessage function twice, just create the buffer and call the function in one go:
      <pre>
<code>!define LOAD_LIBRARY_AS_DATAFILE   0x00000002<br>!define FORMAT_MESSAGE_ALLOCATE_BUFFER  0x00000100<br>!define FORMAT_MESSAGE_FROM_HMODULE     0x00000800<br>System::Call 'kernel32::LoadLibraryExW(w "$SYSDIR\SAMSRV.DLL", i n, i ${LOAD_LIBRARY_AS_DATAFILE}) i .R0'<br>StrCpy $0 ${FORMAT_MESSAGE_FROM_HMODULE}<br>IntOp $0 $0 + ${FORMAT_MESSAGE_ALLOCATE_BUFFER}<br>StrCpy $1 8192 ; messageID for string 'Administrator'<br><br>System::Call '*(&amp;w4)i.R3'<br>System::Call 'kernel32::FormatMessageW(i r0, i R0, i r1, i r2, i R3, i r3, i n) i .R4'<br>System::Call '*$R3(w .R9)'<br>System::Call 'kernel32::LocalFree(i R3)i.R8'<br>System::Call 'kernel32:FreeLibrary(i R1) i.R8'</code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">OldGrumpy</span><br>
      <span class="post-time small text-muted">26th May 2006 14:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I think it's worth to expand the functionality and put it into a separate plugin. When I get to have some idle time at my hands, I'll take a shot at it. The code will look much nicer and cleaner when all that formatting stuff is put into a dll. And the string manipulation will become easier, too ;)</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br>
      <span class="post-time small text-muted">26th May 2006 21:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">This is tricky.<br>
      The string that I am extracting from SAMSRV.DLL has a new line appended at its end. I do not want to copy the string to an NSIS variable since it is unicode, but I want to get rid of the new line. Is there an easy way to trim a string while it exists on a memory buffer, without getting it into a variable? The FormatMessage API call returns the number of TCHARS stored in the buffer (including the new line?) so I also know its size.<br>
      <br>
      I can't seem to find an easy way to do this. :mad:<br>
      <br>
      Any input is welcome as usual<br>
      <br>
      CF</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">OldGrumpy</span><br>
      <span class="post-time small text-muted">27th May 2006 07:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I just had a look at the resources of samsrv.dll and it has no new line char at the end. Did you make sure to create a buffer large enough to carry the wide string and a terminating wide char (zero)? Did you fill the buffer with zeros before using it? It's a common mistake to allocate a buffer and just use it. A call to RtlZeroMemory doesn't take much time but can help a lot :)<br>
      I have to take a look at the plugin SDK before I can write up an appropriate plugin. But I am sure it's much more comfort to have a plugin sorting out all that crap ;)<br>
      And by the way, wouldn't it be nice to have the string converted to ANSI? I know there are pros and cons about that, what do you think?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br>
      <span class="post-time small text-muted">27th May 2006 09:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Check out my previous posts, the whole point is to have the string in a buffer as unicode. The buffer is allocated by the FormatMessage function automatically (I am using ${FORMAT_MESSAGE_ALLOCATE_BUFFER}) so it doesn't really matter what I allocate. I could even use '*(&amp;w1)i.R3' and still the API would expand this, in order to accommodate the string. Not to mention that if I try to allocate the buffer myself (without allowing the API to do so) I don't get anything out. That's why at some point I was calling the function twice so that I would get the string size first, and then allocate a buffer based on that size.<br>
      <br>
      The new line is appended by the API and there should be an easy way to get rid of it. I was unable to track down something similar on the web, since all the examples I came across use 'i n' or 'i 0' as the last parameter for the call (ie no formatting array). According to <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/debug/base/formatmessage.asp" target="_blank">MSDN</a> it should be possible to define formatting options. I found a <a href="http://members.aol.com/btmtz/vb/_misc/stringinserts1.bas" target="_blank">page</a> that shows how to use different inserts in order to format a message but this doesn't make any sense in my case. I should be able to use an escape sequence (%0) to tell the function to remove the new line but I have failed so far to achieve that ...<br>
      <br>
      Thanks for the input though :)<br>
      <br>
      CF</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">OldGrumpy</span><br>
      <span class="post-time small text-muted">27th May 2006 10:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">From looking at how FormatMessageW works, you have to supply the %0 at the end as wide chars. Did you try that? If you supply the wide char equivalent of "%1%0" as the formatting template to the API, you should get what you want :)</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br>
      <span class="post-time small text-muted">27th May 2006 10:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        If you supply the wide char equivalent of "%1%0" as the formatting template to the API, you should get what you want
      </blockquote>Haven't figured how to do this yet. I think this can be done if you extract the string from the buffer, but I may be wrong ... :)<br>
      <br>
      However I just realized that if you look at something for looooong enough you tend to forget what it says ...<br>

      <blockquote>
        The function ignores regular line breaks in the message definition text. The function stores hard-coded line breaks in the message definition text into the output buffer. The function generates no new line breaks.
      </blockquote>So if I add FORMAT_MESSAGE_MAX_WIDTH_MASK to the call the line break disappears! I am still left with a space at the end of the string but I am sure the answer in getting rid of that is here as well :)<br>
      <br>
      So now this is working and I am not getting the new line appended:
      <pre>
<code>!define LOAD_LIBRARY_AS_DATAFILE      0x00000002<br>!define FORMAT_MESSAGE_ALLOCATE_BUFFER  0x00000100<br>!define FORMAT_MESSAGE_FROM_HMODULE     0x00000800<br>!define FORMAT_MESSAGE_MAX_WIDTH_MASK   0x000000FF<br>System::Call 'kernel32::LoadLibraryExW(w "$SYSDIR\SAMSRV.DLL", i n, i ${LOAD_LIBRARY_AS_DATAFILE}) i .R0'<br>StrCpy $0 ${FORMAT_MESSAGE_FROM_HMODULE}<br>IntOp $0 $0 + ${FORMAT_MESSAGE_ALLOCATE_BUFFER}<br>IntOp $0 $0 + ${FORMAT_MESSAGE_MAX_WIDTH_MASK}<br>StrCpy $1 8192 ; messageID for string 'Administrator'<br>StrCpy $2 0<br>StrCpy $3 0<br>System::Call '*()i.R3'<br>System::Call 'kernel32::FormatMessageW(i r0, i R0, i r1, i r2, i R3, i r3, i n) i .R4'<br>System::Call '*$R3(w .R9)'<br>System::Call 'kernel32::LocalFree(i R3)i.R8'<br>System::Call 'kernel32:FreeLibrary(i R1) i.R8'</code>
</pre><br>
      <br>
      CF<br>
      <br>
      [Edit] I kept forgetting to define $2 and $3 as 0 throughout the thread ...
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">OldGrumpy</span><br>
      <span class="post-time small text-muted">27th May 2006 10:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I saw that statement in the docs, too - I just wasn't sure about what it would do. MSDN tends to be cryptic ;) Can't you just get the string length and write two zeros at the end of it? :) Additional zero bytes won't do any harm as long as you don't write beyond the end of the buffer.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br>
      <span class="post-time small text-muted">27th May 2006 16:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I am stuck with this. Although I get the wide string in a buffer, a space is appended at the end and I do not know how to get rid of it. I tried copying the buffer over to a shorter one with no success. I tried setting the size of the buffer before calling FormatMessage (removing the FORMAT_MESSAGE_ALLOCATE_BUFFER parameter and using the 6th parameter to define the buffer size) without any results either. If anyone can see a way out I will appreciate the help :)<br>
      <br>
      CF</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">galil</span><br>
      <span class="post-time small text-muted">27th May 2006 18:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Tried to specify /SIZE for System::Copy?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br>
      <span class="post-time small text-muted">27th May 2006 19:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Without any success. For any size (&gt;2) the whole string with the space at the end is copied over to the new buffer even if the new buffer is allocated in advance:</p>
      <pre>
<code>System::Alloc 2<br>Pop $R6<br>System::Copy /2 $R6 $R3<br>System::Call '*$R6(w.R9)'</code>
</pre>$R9 always contains a space at the end ...<br>
      <br>
      CF
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">27th May 2006 19:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I guess it would be a good idea to convert it to a plugin as already suggested. There is no API for trimming newlines that I could find on MSDN.<br>
      <br>
      -Stu</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">OldGrumpy</span><br>
      <span class="post-time small text-muted">27th May 2006 19:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I'll have a look at howto make an NSIS plugin in the next days. I'm quite busy with my job but I think I can find a little time to get it done.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">27th May 2006 19:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well I can do it tomorrow if you'd like me to.<br>
      <br>
      -Stu</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">OldGrumpy</span><br>
      <span class="post-time small text-muted">27th May 2006 20:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That would be really great :)</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">27th May 2006 20:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Any ideas what to call the plugin?<br>
      <br>
      -Stu</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br>
      <span class="post-time small text-muted">27th May 2006 21:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Wow, I am impressed :)<br>
      I went away for half an hour and now there is already the possibility for a plugin!<br>
      <br>
      Let me slow things down just for a sec here. I am almost convinced that the function itself is appending that space at the end of the string. Its syntax is quite strange as every parameter that you pass depends on the others. For example, there is the possibility to define the size of the buffer allocated for the string (if you don't use the FORMAT_MESSAGE_ALLOCATE_BUFFER flag) however I may be allocating the wrong amount of memory and that's why I am not getting anything out. If I call the function once then I can get the size of the string:</p>
      <pre>
<code>!define LOAD_LIBRARY_AS_DATAFILE    0x00000002<br>!define FORMAT_MESSAGE_ALLOCATE_BUFFER  0x00000100<br>!define FORMAT_MESSAGE_FROM_HMODULE     0x00000800<br>!define FORMAT_MESSAGE_MAX_WIDTH_MASK   0x000000FF<br>System::Call 'kernel32::LoadLibraryExW(w "$SYSDIR\SAMSRV.DLL", i n, i ${LOAD_LIBRARY_AS_DATAFILE}) i .R0'<br>StrCpy $0 ${FORMAT_MESSAGE_FROM_HMODULE}<br>IntOp $0 $0 + ${FORMAT_MESSAGE_ALLOCATE_BUFFER}<br>IntOp $0 $0 + ${FORMAT_MESSAGE_MAX_WIDTH_MASK}<br>StrCpy $1 8192 ; messageID for string 'Administrator'<br>StrCpy $2 0<br>StrCpy $3 0<br>System::Call 'kernel32::FormatMessageW(i r0, i R0, i r1, i r2, *w .R3, i r3, i n) i .R4'</code>
</pre>Now $R3 contains the string with a space at the end and $R4 is the length (in TCHARS) of the string. For the above example, the string is 'Administrator' on my system, and the function reports 14 TCHARS. Is that 13 + 1 (1 being the space)? If yes then I can call the function a second time, only now I will not allow it to allocate the buffer but I will create one and use it:
      <pre>
<code>StrCpy $0 ${FORMAT_MESSAGE_FROM_HMODULE}<br>IntOp $0 $0 + ${FORMAT_MESSAGE_MAX_WIDTH_MASK}<br>IntOp $9 $R4 - 1 ; # TCHARS of string<br>IntOp $3 $9 * 2 ; # of bytes for the string<br>System::Alloc $3<br>Pop $R3<br>System::Call 'kernel32::FormatMessageW(i r0, i R0, i r1, i r2, i R3, <b>i r9</b>, i n) i .R4 ?e'<br>Pop $R8</code>
</pre>The above code does not work however and I am not sure why. The error is 122 (ERROR_INSUFFICIENT_BUFFER).<br>
      <br>
      Any ideas?<br>
      <br>
      CF
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">28th May 2006 00:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I've got the code in a plugin and trimmed the new lines. What do you need to do with the string after that point?<br>
      <br>
      -Stu</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br>
      <span class="post-time small text-muted">28th May 2006 10:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks a lot by the way :) I guess I'll have to dive into making plugins myself soon ...<br>
      <br>
      Is it possible to pass it in a buffer so that I can directly pipe it to another function? I do not want to have it in a variable because it may contain unicode characters.<br>
      <br>
      Ideally I would like to pass to the plugin:<br>
      1. the library name<br>
      2. the # of the string to pull out<br>
      3. (optionaly) the system language (or you could use <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/intl/nls_4ppg.asp" target="_blank">GetSystemDefaultLangID</a> to query the system language and then pass it to FormatMessage)<br>
      <br>
      and then I would get the string in a buffer so that I can use it directly for another API call ...<br>
      <br>
      Where you able to get rid of the space appended at the end of the string?<br>
      <br>
      <br>
      CF<br>
      <br>
      [Edit] This plugin can have a more general use I guess. You could pass the string to a buffer and to some variable, or think about dealing with message strings as well instead of strings from tables etc ...</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">28th May 2006 11:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I didn't use FORMAT_MESSAGE_MAX_WIDTH_MASK so there was a \r\n and no space. It isn't possible to pass a string from one plugin to another without storing it in an NSIS variable in between. You'd have to do everything in the same plugin.<br>
      <br>
      If I use GetSystemDefaultLangID the FormatMessage call fails.<br>
      <br>
      -Stu</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">OldGrumpy</span><br>
      <span class="post-time small text-muted">28th May 2006 11:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What about calling the plugin (Get)SystemMessageStrings? I don't know if with our without "Get" is better :) Specifying the system language for the plugin seems to be superfluous to me, but it could be useful to distinguish between the system language and the user language. So we could pass a flag to the plugin that decides which of the two will be used.<br>
      Another question would be who allocates and frees the buffer memory. I'd suggest that the plugin allocates the memory, and frees it when it gets unloaded. That way, it can be ensured that no memory leaks occur. (I hope...)<br>
      <br>
      Edit: I think GetResourceString is a better name :)<br>
      2nd edit: I think the plugin should be able to convert unicode to ansi (using the system functions) optionally to enhance the comfort for nsis components. As long as nsis can't cope with unicode properly, that could be a huge help. It isn't a problem to put the string into a buffer and let the system convert it back later when needed. From 2K onwards, the system converts all ansi strings to unicode internally, anyway :)</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br>
      <span class="post-time small text-muted">28th May 2006 12:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">GOT IT!!!!! :)<br>
      <br>
      After a lot of trial-and-error runs here is what worked for me:</p>
      <pre>
<code>!define FORMAT_MESSAGE_IGNORE_INSERTS    0x00000200<br>!define FORMAT_MESSAGE_FROM_HMODULE     0x00000800<br>!define FORMAT_MESSAGE_MAX_WIDTH_MASK   0x000000FF<br><br><br># Get the system Language ID<br>System::Call 'kernel32::GetSystemDefaultLangID(i v)i .R0'<br><br># First load the library<br>System::Call 'kernel32::LoadLibraryExW(w "$SYSDIR\SAMSRV.DLL", i n, i ${LOAD_LIBRARY_AS_DATAFILE}) i .R1'<br><br># get the string out ($R2) and get its size on $R3<br>StrCpy $0 ${FORMAT_MESSAGE_FROM_HMODULE}<br>IntOp $0 $0 + ${FORMAT_MESSAGE_IGNORE_INSERTS}<br>IntOp $0 $0 + ${FORMAT_MESSAGE_MAX_WIDTH_MASK}<br>StrCpy $1 8192<br>StrCpy $2 ${NSIS_MAX_STRLEN}<br><br># prepare a buffer to accept that string<br>System::Call '*(&amp;w${NSIS_MAX_STRLEN})i.R2'<br>System::Call 'kernel32::FormatMessageW(i r0, i R1, i r1, i R0, i R2, i r2, i n) i .R3'<br><br>; Free the DLL handle<br>System::Call 'kernel32::FreeLibrary(i R1)i .R8'<br></code>
</pre>Now the string is stored in $R2 but if I try to get it out, say using
      <pre>
<code>System::Call '*$R2(w.R9)'</code>
</pre>my program fails. However if I pass this buffer directly to another API it works! Well at least in XP ... Not sure why I am not able to get the string out in $R9 though.<br>
      <br>
      I passed the buffer to the NetUserAdd API and managed to create a user called 'Administrator'<br>
      <br>
      :)<br>
      <br>
      I will test it in 2k as well and then report back ...<br>
      <br>
      CF<br>
      <br>
      [Edit] Oups, I was a bit too fast getting excited :(<br>
      It works but the name still contains a space at the end ... It works in 2k as well ...
    </div>
    <hr>
    
    
    

    <div class="container">
      

      <ol class="breadcrumb">
        <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

        <li><a href="f-65.html">NSIS Discussion</a></li>

        <li class="active">Windows Built-In strings</li>
      </ol>

      <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=246116">Windows Built-In strings</a></p><br>

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
        <span class="post-time small text-muted">28th May 2006 12:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Make sure you call LocalFree to free the buffer memory when you're finished using it.<br>
        <br>
        -Stu</p>
      </div>
      <hr>

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br>
        <span class="post-time small text-muted">28th May 2006 12:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Yes I am freeing the buffer after I pass it to the next API.<br>
        I am also still interested in your plugin Stu since I can't get rid of that !$@!#$ space at the end of the string :(<br>
        <br>
        CF</p>
      </div>
      <hr>

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br>
        <span class="post-time small text-muted">28th May 2006 12:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Problem solved!<br>
        <br>
        The trick is to copy the buffer (as galil pointed out at some point) although it looks like the buffer does not contain anything:</p>
        <pre>
<code>!define FORMAT_MESSAGE_IGNORE_INSERTS  0x00000200<br>!define FORMAT_MESSAGE_FROM_HMODULE     0x00000800<br>!define FORMAT_MESSAGE_MAX_WIDTH_MASK   0x000000FF<br><br><br># Get the system Language ID<br>System::Call 'kernel32::GetSystemDefaultLangID(i v)i .R0'<br><br># First load the library<br>System::Call 'kernel32::LoadLibraryExW(w "$SYSDIR\SAMSRV.DLL", i n, i ${LOAD_LIBRARY_AS_DATAFILE}) i .R1'<br><br># get the string out ($R2) and get its size on $R3<br>StrCpy $0 ${FORMAT_MESSAGE_FROM_HMODULE}<br>IntOp $0 $0 + ${FORMAT_MESSAGE_IGNORE_INSERTS}<br>IntOp $0 $0 + ${FORMAT_MESSAGE_MAX_WIDTH_MASK}<br>StrCpy $1 8192<br>StrCpy $2 ${NSIS_MAX_STRLEN}<br><br># prepare a buffer to accept that string<br>System::Call '*(&amp;w${NSIS_MAX_STRLEN})i.R2'<br>System::Call 'kernel32::FormatMessageW(i r0, i R1, i r1, i R0, i R2, i r2, i n) i .R3'<br><br># trim one character and copy to another buffer<br>IntOp $8 $R3 - 1<br>IntOp $9 $8 * 2<br>System::Alloc $9<br>Pop $R6<br>System::Copy /$9 $R6 $R2<br><br>; Free the DLL handle<br>System::Call 'kernel32::FreeLibrary(i R1)i .R8'</code>
</pre>Now $R6 contains the string with the exact size without any space at the end. Passing this buffer to another API works just fine. However if I try to get the string out to some NSIS variable the code fails. I am not sure why, but since it does what I was after I don't really care at this point :)<br>
        <br>
        All that remains now is to test this in a non english OS and see if the localized name is picked in the system language from samsrv.dll!<br>
        <br>
        A warm 'thank you' to all who contributed in this thread!<br>
        <br>
        CF
      </div>
      <hr>

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br>
        <span class="post-time small text-muted">30th May 2006 09:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">I saw this <a href="http://forums.winamp.com/showthread.php?postid=1790969#post1790969" target="_blank">thread</a> and I thought that this is relevant info (posted by apmolyneux):<br></p>

        <blockquote>
          I see you're getting the language of USER.EXE, which is good thinking and will work for legacy Windows versions.<br>
          <br>
          <b>However</b>, it won't work properly for users who are running the MUI (Multilingual User Interface) version of Windows 2000 or XP. USER.EXE is always "English (US)" in a MUI environment. I'm told the Enterprise and Ultimate versions of Vista will also be MUI.
        </blockquote>I was not looking for user.exe but for samsrv.dll. I installed the french MUI on a virtual PC and changed the system and user language to french. I run the code shown at my last post and I managed to pick the french equivalent of 'Administrator' using FormatMessage (that's <i>Administrateur</i> :) ). The interesting part though is that resource hacker reports that samsrv.dll has a message table with lang 1033 (English) and <b>not</b> 1036 (French)! A binary comparison of the file from the french MUI and that of the original english version of XP showed that they are <b>the same</b>. :tinfoil:<br>
        <br>
        Does anybody understand how this is working? How can the system pick the correct localized strings from a DLL that doesn't seem to contain them?<br>
        <br>
        There is also a folder present in my $WINDIR ($WINDIR\mui\FALLBACK\040C) which contains the file samsrv.dll.mui, which in fact has a message table with the correct lang/strings. How did the API call get redirected to this file? Has anyone noticed something similar?<br>
        <br>
        CF
      </div>
      <hr>

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
        <span class="post-time small text-muted">30th May 2006 11:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">That is interesting. I guess the English strings are stored in the DLL itself, whereas any other languages are stored in the seperate file.<br>
        <br>
        -Stu</p>
      </div>
      <hr>

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br>
        <span class="post-time small text-muted">2nd June 2006 23:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Added a WIKI <a href="http://nsis.sourceforge.net/Reading_Message_Table_resources_from_DLL_files" target="_blank">page</a> for this thread :D<br>
        <br>
        CF</p>
      </div>
      <hr>

      <div class="footer">
        <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
      </div>
    </div><script src="../js/highlight.pack.js" type="text/javascript">
</script> <script type="text/javascript">
//<![CDATA[
    hljs.initHighlightingOnLoad();
    //]]></script></div></body></html>