<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Installer doesn't delete icons in Start Menu Group"><title>Installer doesn't delete icons in Start Menu Group - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Installer doesn't delete icons in Start Menu Group</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=307500">Installer doesn't delete icons in Start Menu Group</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">headlock</span><br><span class="post-time small text-muted">19th June 2009 15:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Installer doesn't delete icons in Start Menu Group</strong><br>&nbsp; Hello everyone and huge thanks to NSIS community for doing a great job.<br><br>The project I'm working in is using NSIS and recently it was found that uninstaller doesn't do it's job correctly. Our installer supports multi user installation mode. The problem is that the uninstaller doesn't delete icons on the desktop and in the start menu group when installing application for the current user. I've found that the reason of it is that $SMPROGRAMS == AllUsers.<br><br>Here is the code:<br><br>...<br>!define PRODUCT_UNINST_ROOT_KEY "SHCTX"<br><br>!define MULTIUSER_EXECUTIONLEVEL Highest<br>!define MULTIUSER_MUI<br>!define MULTIUSER_INSTALLMODE_DEFAULT_REGISTRY_KEY<br>!insertmacro MULTIUSER_PAGE_INSTALLMODE<br>...<br>Section Uninstall<br>...<br>#$SMPROGRAMS points to AllUsers<br>RMDir /r "$SMPROGRAMS\${MANUFACTURER}\${PRODUCT_NAME}$suffix"<br>RMDir "$SMPROGRAMS\${MANUFACTURER}"<br>..<br>SectionEnd<br><br>Do I need to set the context of $SMPROGRAMS manually. If yes than how do I get the installation mode used in installer?<br>Can someone help me please? I would appreciate it very much.<br><br>p.s: sorry for my English, i know it's not perfect :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">redxii</span><br><span class="post-time small text-muted">19th June 2009 18:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I'm confused, are you trying to remove the shortcuts during install? The Uninstall section is used for creating the uninstaller (use WriteUninstaller to make the uninstaller .exe, placed in the installer code), uninstall sections aren't executed in the installer. Otherwise you use SetShellVarContext before using $SMPROGRAMS or other shell folders to specify current or all users.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">headlock</span><br><span class="post-time small text-muted">22nd June 2009 09:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks for your reply, redxii.<br>No, I don't try to remove shortcuts during the install process. Section 'Uninstall' is used for the uninstaller. I suppose that when user installs the application, installer writes to registry depending on what install mode has been chosen. It will write to HKLM if install mode is 'all users' or to HKCU is it's only for current user. Then, when<br>uninstaller is executed I suppose it should define how to initialize $SMPROGRAMS by itself. Otherwise, if it doesn't I need to implement some dummy logic like:<br><br>!if ${ROOT} == 'HKLM'<br>SetShellVarContext all<br>!else if ${ROOT} == 'HKCU'<br>SetShellVarContext current<br><br>In this case, how do I know the registry root of the installed application?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">22nd June 2009 12:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The value of $MultiUser.InstallMode will be AllUsers or CurrentUser. I guess we need a SetShellVarContext push and SetShellVarContext pop.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">22nd June 2009 14:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I have been thinking about the need for something like this also, it might be a good idea to be able to push/pop all the settings (SetShellVarContext,SetDetailsPrint,SetRegView etc)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">headlock</span><br><span class="post-time small text-muted">22nd June 2009 17:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks, Afrow UK! Unfortunetely that didn't help me ...<br>Here is my code:<br><br>!define MULTIUSER_EXECUTIONLEVEL Highest<br>!define MULTIUSER_INSTALLMODE_COMMANDLINE<br><br>#if uncomment this line $MultiUser.InstallMode will always be == 'CurrentUser'<br>#!define MULTIUSER_INSTALLMODE_DEFAULT_CURRENTUSER<br><br>!define MULTIUSER_INSTALLMODE_INSTDIR_REGISTRY_KEY "Software\${MANUFACTURER}\${PRODUCT_NAME}$suffix"<br>!define MULTIUSER_INSTALLMODE_INSTDIR_REGISTRY_VALUENAME "Install_Dir"<br>!define MULTIUSER_INSTALLMODE_INSTDIR "${PRODUCT_NAME}$suffix"<br>!define MULTIUSER_INSTALLMODE_DEFAULT_REGISTRY_KEY "Software\${MANUFACTURER}\${PRODUCT_NAME}$suffix"<br>!define MULTIUSER_INSTALLMODE_DEFAULT_REGISTRY_VALUENAME "Install_Mode"<br>!define MULTIUSER_MUI<br>...<br>Section Uninstall<br>...<br>${If} $MultiUser.InstallMode == 'AllUsers'<br>SetShellVarContext all<br>${ElseIf} $MultiUser.InstallMode == 'CurrentUser'<br>SetShellVarContext current<br>${EndIf}<br><br>RMDir /r "$SMPROGRAMS\${MANUFACTURER}\${PRODUCT_NAME}$suffix"<br>RMDir "$SMPROGRAMS\${MANUFACTURER}"<br>..<br>SectionEnd.<br><br>Perhaps I forgot something to do...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">22nd June 2009 20:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I think you misunderstand. You just need to SetShellVarContext current before deleting the shortcuts. I posted what I did because you may want to know what to set back with SetShellVarContext afterwards.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">phungus420</span><br><span class="post-time small text-muted">2nd July 2009 10:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hello, I have a similar problem. I'm not quite following what the solution is though from this thread. Any chance you could go in greater detail.<br><br>For me, it's slightly different. Everything in my installer works, except for the uninstalling for the start menu shortcut. The other shortcuts (quciklaunch and desktop) are removed no problem, along with the core of the mod.<br><br>For reference here is the code I am using (well the bits that are pertinant):<br><br></p><pre>
<code>...<br>  Var INSTDIR1 ; Mods<br>  Var StartMenuFolder</code>
</pre><br>
      <br>
      <pre>
<code>...<br>  !insertmacro MUI_PAGE_DIRECTORY<br>  !insertmacro MUI_PAGE_STARTMENU Application $StartMenuFolder</code>
</pre><br>
      <br>
      <pre>
<code>  Section "Start Menu Shortcut" Section4<br>        !insertmacro MUI_STARTMENU_WRITE_BEGIN Application<br>                CreateDirectory "$SMPROGRAMS\$StartMenuFolder"<br>        !insertmacro MUI_STARTMENU_WRITE_END<br>    CreateShortCut "$SMPROGRAMS\$StartMenuFolder\${NAME}.lnk" "$INSTDIR1\Civ4BeyondSword.exe" ...<br>  SectionEnd</code>
</pre><br>
      <br>
      <pre>
<code>  Section "Uninstall"<br>        <br>    ...<br>    ;Delete Start Menu Shortcut<br>        !insertmacro MUI_STARTMENU_GETFOLDER Application $StartMenuFolder<br>            Delete "$SMPROGRAMS\$StartMenuFolder\${NAME}.lnk"<br>            RMDir "$SMPROGRAMS\$StartMenuFolder"<br>    ...<br>  SectionEnd</code>
</pre><br>
      <br>
      <br>
      Now I can't at all figure out what's wrong with that. It installs fine, everything in this script works (even the optional add on stuff I have in other parts of the code), just the danged uninstaller refuses to remove the Start Menu shortcut. (also I replaced the icon stuff and beginning of the uninstall section with a ... because it was running off the screen, and works fine)<br>
      <br>
      Anyone have any idea how to fix this?
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">phungus420</span><br>
      <span class="post-time small text-muted">3rd July 2009 04:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well I've split the uninstaller into seperate sections, and added:<br>
      <br>
      SetShellVarContext "current"<br>
      <br>
      To both the onInit and un.onInit (also tried SetShellVarContext "all"), and still no dice.<br>
      <br>
      Anyone have any clue what is wrong with my Uninstaller? Everything works except the blasted Start Menu refuses to be deleted. :hang:<br>
      <br>
      Here is my unistaller code if that helps:<br>
      <br></p>
      <pre>
<code>;Uninstaller Section<br><br>  Section "un.Core" SecUnCore<br><br>    ;Delete Files<br>    RMDir /r "$0\${MOD_LOC}\*.*"<br>    ;Remove the installation directory<br>    RMDir "$0\${MOD_LOC}"<br>    ;Delete Desktop Shortcut<br>    Delete "$DESKTOP\${NAME}.lnk"<br>    ;Delete Quicklaunch Shortcut<br>    Delete "$QUICKLAUNCH\${SHORT_NAME}.lnk"<br>  SectionEnd<br><br>  Section "-un.StartMenu" SecUnStartMenu<br><br>    ;Delete Start Menu Shortcut<br>    !insertmacro MUI_STARTMENU_GETFOLDER Application $StartMenuFolder<br>    Delete "$SMPROGRAMS\$StartMenuFolder\${NAME}.lnk"<br>    RMDir "$SMPROGRAMS\$StartMenuFolder"<br>  SectionEnd<br><br>  Section "-un.Registry" SecUnRegistry<br><br>    DeleteRegValue "${MOD_REG_ROOT}" "Software\${MOD_LOC}" "Start Menu"<br>    DeleteRegKey HKEY_LOCAL_MACHINE "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\${MOD_LOC}"<br>  SectionEnd<br>  <br>  Section "-un.Uninstaller" SecUnUninstaller<br>        <br>        # delete uninstaller<br>        Delete "$INSTDIR\Uninstall.exe"<br>  SectionEnd<br><br>  Function un.onInit<br><br>    ;get mod install path of from the registy<br>    SetShellVarContext "current"<br>    ReadRegStr $0 HKEY_LOCAL_MACHINE "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\${MOD_LOC}" "ModInstDir"<br>  FunctionEnd</code>
</pre><br>
      <br>
      I've searched and searched, and been getting help from a programmer who is pretty versed in the NSIS installer on the CivFanatics forums, and no clues come up. It just doesn't work...<br>
      <br>
      :(<br>
      <br>
      Also one thing that might help would be to have a print statement to tell me what exactly the uninstaller is trying to do, that causes it to fail. Is there anyway to set up print statements in NSIS?
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">phungus420</span><br>
      <span class="post-time small text-muted">3rd July 2009 08:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well I was able to get logging to work (with some help). The issue is that when you select the folder to install the start menu to, it doesn't relate this information.<br>
      <br>
      $StartMenuFolder should be returning SELECTEDFOLDER/${MOD_LOC}, but instead only returns ${MOD_LOC}<br>
      <br>
      I thought this was the whole purpose of<br>
      MUI_STARTMENU_GETFOLDER Application $StartMenuFolder<br>
      <br>
      Anyone know how to get it to pull the selected folder the user chooses when installing?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">phungus420</span><br>
      <span class="post-time small text-muted">3rd July 2009 12:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Man this is driving me nuts, I've been hammering away at it all day. My head is about to explode. I can set up another variable, like so:<br>
      <br></p>
      <pre>
<code>  Section "Start Menu Shortcut" Section4<br>        !insertmacro MUI_STARTMENU_WRITE_BEGIN Application<br>        CreateDirectory "$SMPROGRAMS\$StartMenuFolder"<br>        CreateShortCut "$SMPROGRAMS\$StartMenuFolder ...<br>        !insertmacro MUI_STARTMENU_WRITE_END<br>        StrCpy $StartMenuFolder1 "$SMPROGRAMS\$StartMenuFolder"<br>        !define START_MENU_FOLDER "$StartMenuFolder1"<br>  SectionEnd</code>
</pre><br>
      <br>
      But there seems to be no way to reference it in the uninstaller. Everytime I do, it just comes up blank if I check it. Everything I try I'm just stuck with this in the Install section, with no way to reference it in the uninstall section....
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">phungus420</span><br>
      <span class="post-time small text-muted">3rd July 2009 13:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well I tried a really hacky work around, that I'm not sure how or why it failed. Basically I had it write the Variable to a text file it would create on install. This worked, and the document contained the correct path. Then I set it to read that file in the uninstaller. For some reason if I used a user variable, the script failed to compile. If I used one of the default variables like $R1, it compiled, but there was nothing inside it after it was told to read the file. So strange, I was sure that would work. And it's not like Read and Write code is hard, I can't see what's wrong with it (or why using a user variable would fail to compile, but using a default variable would not). For reference this is what I mean:<br>
      <br></p>
      <pre>
<code>  !define START_MENU_HACK "StartMenuHack.txt"  ;Do not change this block<br>...<br><br><br>  Var HackStartMenu<br><br>...<br><br>        StrCpy $StartMenuFolder1 "$SMPROGRAMS\$StartMenuFolder"<br>        FileOpen $4 "$INSTDIR\Mods\${MOD_LOC}\${START_MENU_HACK}" w<br>        FileWrite $4 "$StartMenuFolder1"<br>        FileClose $4<br></code>
</pre><br>
      <br>
      Above all works, was checked, it wrote the file with the correct path.<br>
      <br>
      <pre>
<code>    FileOpen $R4 "$INSTDIR\Mods\${MOD_LOC}\${START_MENU_HACK}" r<br>    FileRead $R4 $HackStartMenu<br>    FileClose $R4<br>    Delete "$HackStartMenu\${NAME}.lnk"<br>    RMDir "$HackStartMenu"</code>
</pre><br>
      Now the above failed to compile. Complaiend about the FileRead $R4 $HackStartMenu, and said something about the user variable. But the strange thing was using $R2 compiled. But when I checked what was inside of it, it just came out blank. And I did move this to the top of the uninstall functions to make sure the folder wasn't deleted before it had a chance to read it.<br>
      <br>
      I think I'm out of ideas now. Help.
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">phungus420</span><br>
      <span class="post-time small text-muted">4th July 2009 06:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Got it to work finally. I had to write the StartMenu path to the registry. Now just one minor detail left, but guess I'll start a new thread on it.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">4th July 2009 12:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I was about to go onto what I meant earlier but then I've realised what your problem is. If you'd read the Multi User readme properly you would have saved yourself a lot of hassle.<br>
      <br></p>
      <pre>
<code><br>!define MULTIUSER_EXECUTIONLEVEL Highest<br>!include MultiUser.nsh<br><br>...<br><br>Function .onInit<br>  !insertmacro MULTIUSER_INIT<br>FunctionEnd<br><br>Function un.onInit<br>  !insertmacro MULTIUSER_UNINIT<br>FunctionEnd<br></code>
</pre><br>
      <br>
      Stu
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">h√ºrnen</span><br>
      <span class="post-time small text-muted">18th October 2010 15:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi Afrow UK<br>
      <br>
      I'd like to resume this thread, as I've got some problems too. I worked through the Multi User readme, but still don't get it.<br>
      <br>
      I'll describe two scenarios, in both of which I am an admin user on XP.<br>
      1:<br>
      Install the application "for anyone using this computer". Shortcuts are created in C:\Documents and Settings\<b>All Users</b>\Startmenu\Programs\MyApp<br>
      Now I execute the uninstaller and everything (including shortcuts) is removed as expected.<br>
      <br>
      2:<br>
      Install the application "just for me". Shortcuts are created in C:\Documents and Settings\<b>myUser</b>\Startmenu\Programs\MyApp<br>
      Now I execute the uninstaller but the shortcuts won't get deleted. The uninstaller tries to remove shortcuts in C:\Documents and Settings\<b>All Users</b>\Startmenu\Programs\MyApp, but there are none.<br>
      <br>
      I assume the default "installation mode" in the uninstaller is "AllUsers", if the uninstaller is executed by an admin.<br>
      <br>
      I see two solutions:</p>

      <ul>
        <li>a check box in the uninstaller for allUsers/currentUser or</li>

        <li>I have to manually save the "installation mode" during installation in the registry and read it back during uninstallation and then call SetShellVarContext with that value.</li>
      </ul><br>
      Is there a simpler solution? Or I am completely of the track? :igor:<br>
      <br>
      Thanks,<br>
      Remo
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br>
      <span class="post-time small text-muted">18th October 2010 16:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The 2nd solution is the correct one (I believe MultiUser will do it for you if you set the correct defines) Or for my take on this: <a href="http://www.nsis.pastebin.com/PmiY8DuZ" target="_blank">http://www.nsis.pastebin.com/PmiY8DuZ</a></p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JackN</span><br>
      <span class="post-time small text-muted">25th October 2010 19:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I am trying to tailor <a href="http://www.nsis.pastebin.com/PmiY8DuZ" target="_blank">http://www.nsis.pastebin.com/PmiY8DuZ</a> to install a java app with several .jar libs and a dll. After making the changes I got the nsis compile warning:<br>
      <br></p>

      <blockquote>
        uninstall function "un.StrStr" not referenced - zeroing code (0-33) out
      </blockquote>So I tried <a href="http://www.nsis.pastebin.com/PmiY8DuZ" target="_blank">http://www.nsis.pastebin.com/PmiY8DuZ</a> no changes but got the same warning. Anyone able to point me in the right direction?<br>
      <br>

      <blockquote>
        <small>Originally posted by Anders</small><br>
        The 2nd solution is the correct one (I believe MultiUser will do it for you if you set the correct defines) Or for my take on this: <a href="http://www.nsis.pastebin.com/PmiY8DuZ" target="_blank">http://www.nsis.pastebin.com/PmiY8DuZ</a>
      </blockquote>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Animaether</span><br>
      <span class="post-time small text-muted">25th October 2010 19:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by JackN</small><br>
        After making the changes I got the nsis compile warning:<br>

        <blockquote>
          Originally Posted by <strong>NSIS</strong> uninstall function "un.StrStr" not referenced - zeroing code (0-33) out
        </blockquote>
      </blockquote>That warning is fairly benign (thus being a warning, rather than an error).<br>
      <br>
      The String Functions header uses Functions for some of its musclework. Functions can't be shared between Installer and Uninstaller, so both are defined when you use ${StrStr} to initialize the functions.<br>
      <br>
      If you then subsequently not actually call the uninstaller version of that Function anywhere from the uninstaller, NSIS will throw that warning out there.<br>
      <br>
      Unless you really, really need to save a few bytes (those zeroes compress nicely, of course), I wouldn't worry about it.
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JackN</span><br>
      <span class="post-time small text-muted">25th October 2010 20:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Uninstaller still does not delete icons in Start Menu Group or from the desktop. Do I need to delete these items explicitly? Do I need to define MUI_FINISHPAGE_RUN? This is the output from the installer followed by a script modified from <a href="http://www.nsis.pastebin.com/PmiY8DuZ:" target="_blank">http://www.nsis.pastebin.com/PmiY8DuZ:</a><br>
      <br></p>

      <blockquote>
        Delete file: C:\Program Files (x86)\MyApp\MyApp.ico<br>
        Delete file: C:\Program Files (x86)\MyApp\MyApp.jar<br>
        Delete file: C:\Program Files (x86)\MyApp\lib\jcommon-1.0.16.jar<br>
        Delete file: C:\Program Files (x86)\MyApp\lib\jfreechart-1.0.13.jar<br>
        Delete file: C:\Program Files (x86)\MyApp\lib\Serialio.jar<br>
        Remove folder: C:\Program Files (x86)\MyApp\lib\<br>
        Delete file: C:\Program Files (x86)\MyApp\uninstall.exe<br>
        Remove folder: C:\Program Files (x86)\MyApp\<br>
        Completed
      </blockquote>
      <pre>
<code>
"MyApp"
<br>&gt;!define REGUINSTKEY "{82e9dffd-fcec-4ba6-b912-a595644cf080}" ; guidgen.com
<br><br>&gt;!include x64.nsh
<br><br>OutFile "Setup_${APPNAME}.exe"
<br>&gt;Name "${APPNAME}"
<br><br>&gt;!define MULTIUSER_EXECUTIONLEVEL Highest
<br>&gt;!define MULTIUSER_INSTALLMODE_COMMANDLINE
<br>&gt;!define MULTIUSER_INSTALLMODE_InstDir "${APPNAME}"
<br><br>&gt;Var SMDir ;Start menu folder
<br><br>&gt;!define MULTIUSER_MUI
<br>&gt;!include MUI2.nsh
<br>&gt;!include MultiUser.nsh
<br><br>&gt;!macro WriteUninstData name data
<br>push "${data}"
<br>&gt;push "${name}"
<br>&gt;call WriteUninstData
<br>&gt;!macroend
<br><br>&gt;!macro ReadUninstData outvar name
<br>push "${name}"
<br>&gt;call un.ReadUninstData
<br>&gt;!if "${outvar}" != ""
<br>&gt;pop ${outvar}
<br>!endif
<br>!macroend
<br><br>&gt;Function .onInit
<br>&gt;!insertmacro MULTIUSER_INIT
<br>FunctionEnd
<br><br>&gt;Function un.onInit
<br>&gt;;MULTIUSER_UNINIT does NOT do The Right Thing(TM), so we roll our own
<br>&gt;!insertmacro MULTIUSER_INIT_TEXTS
<br>UserInfo</code>::GetAccountType
<br>Pop $MultiUser.Privileges
<br>&gt;!insertmacro ReadUninstData $1 IMode
<br>&gt;${If} $1 = 0
<br>    call un.MultiUser.InstallMode.CurrentUser
<br>&gt;${Else}
<br>    ${If}$MultiUser.Privileges != Admin
<br>        MessageBox MB_ICONSTOP "$(^Name)${MULTIUSER_INIT_TEXT_ADMINREQUIRED}"
<br>       SetErrorLevel 740 ;ERROR_ELEVATION_REQUIRED
<br>        Quit
<br>    ${EndIf}
<br>   call un.MultiUser.InstallMode.AllUsers
<br>&gt;${EndIf}
<br>&gt;FunctionEnd
<br><br>&gt;!insertmacro MUI_PAGE_WELCOME
<br>&gt;!insertmacro MULTIUSER_PAGE_INSTALLMODE
<br>&gt;#!insertmacro MUI_PAGE_COMPONENTS ;This example does not have separate components
<br>&gt;!insertmacro MUI_PAGE_DIRECTORY
<br>&gt;!insertmacro MUI_PAGE_STARTMENU 0 $SMDir
<br>&gt;!insertmacro MUI_PAGE_INSTFILES
<br>&gt;###TODO:!define MUI_FINISHPAGE_RUN "$InstDir\MyApp.exe"
<br>&gt;!define MUI_PAGE_CUSTOMFUNCTION_SHOW PageFinShow
<br>&gt;!insertmacro MUI_PAGE_FINISH
<br><br>&gt;!insertmacro MUI_UNPAGE_WELCOME
<br>&gt;!insertmacro MUI_UNPAGE_CONFIRM
<br>&gt;!insertmacro MUI_UNPAGE_INSTFILES
<br><br>&gt;!insertmacro MUI_LANGUAGE English
<br><br>&gt;Function PageFinShow
<br>&gt;!ifdef MUI_FINISHPAGE_RUN
<br>&gt;;When installmode != CurrentUser, we could end up running something as the wrong user...
<br>${If}$MultiUser.InstallMode != CurrentUser
<br>    SendMessage $mui.FinishPage.Run ${BM_SETCHECK} 0 0
<br>&gt;!if 1
<br>    EnableWindow $mui.FinishPage.Run 0
<br>&gt;!else
<br>   ShowWindow $mui.FinishPage.Run 0
<br>&gt;!endif
<br>${EndIf}
<br>!endif
<br>&gt;FunctionEnd
<br><br><br>Section "Required Files"
<br>&gt;SectionIn RO
<br>SetOutPath $InstDir
<br>WriteUninstaller "$InstDir\uninstall.exe"
<br>&gt;;Save install mode
<br>StrCpy$1 "0" 
<br>&gt;${IfThen} $MultiUser.InstallMode == AllUsers ${|} StrCpy $1 "1"  ${|}
<br>!insertmacro WriteUninstData IMode $1
<br><br>File${APPNAME}.ico
<br>File dist${APPNAME}.jar
<br>CreateDirectory "$InstDir\lib"
<br>&gt;File /oname=libjcommon-1.0.16.jar distlibjcommon-1.0.16.jar
<br>File/oname=libjfreechart-1.0.13.jar distlibjfreechart-1.0.13.jar
<br>File/oname=libSerialio.jar distlibSerialio.jar
<br>WriteUninstaller $InstDirUninstall.exe
<br>&gt;; Check OS for proper jspWin.dll
<br>&gt;${If} ${RunningX64}
<br>   File /oname=$SYSDIRjspWin.dll dll64bjspWin.dll
<br>&gt;${Else}
<br>   File /oname=$SYSDIRjspWin.dll dll32bjspWin.dll
<br>&gt;${EndIf}
<br><br>;Check for Java Runtime Environment (JRE)
<br>${If} ${RunningX64} 
<br>    ${DisableX64FSRedirection} 
<br>    ${Unless} ${FileExists} "$SYSDIR\javaw.exe" 
<br>       ExecWait '"jre-6u22-windows-x64.exe"'
<br>   ${EndUnless} 
<br>    ${EnableX64FSRedirection} 
<br>${Else}  
<br>    ${Unless} ${FileExists} "$SYSDIR\javaw.exe" 
<br>       ExecWait '"jre-6u22-windows-i586-s.exe"'
<br>   ${EndUnless} 
<br>${EndIf}  
<br>&gt;WriteRegStr SHCTX "Software\Microsoft\Windows\CurrentVersion\Uninstall\${REGUINSTKEY}" UninstallString '"$InstDir\uninstall.exe"'
<br>&gt;WriteRegStr SHCTX "Software\Microsoft\Windows\CurrentVersion\Uninstall\${REGUINSTKEY}" DisplayName "${APPNAME}"
<br>&gt;SectionEnd
<br><br>Section-StartMenu
<br>&gt;!insertmacro MUI_STARTMENU_WRITE_BEGIN 0
<br>CreateDirectory "$SMPrograms\$SMDir"
<br>&gt;###TODO: CreateShortcut "$SMPrograms\$SMDir\${APPNAME}.lnk" '"$InstDir\MyApp.exe"'
<br>&gt;CreateDirectory "$SMPrograms\$SMDir"
<br>&gt;CreateShortCut "$SMPrograms\$SMDir\${APPNAME}.lnk" "$SYSDIR\javaw.exe" "-jar ${APPNAME}.jar" "$INSTDIR\${APPNAME}.ico"
<br>&gt;CreateShortCut "$SMPrograms\$SMDir\Uninstall ${APPNAME}.lnk" "$INSTDIR\Uninstall.exe" "$INSTDIR\${APPNAME}.ico"
<br>&gt;CreateShortCut "$DESKTOP\${APPNAME}.lnk" "$SYSDIR\javaw.exe" "-jar ${APPNAME}.jar" "$INSTDIR\${APPNAME}.ico"
<br>&gt;;We need to save the startmenu folder so we can remove the shortcut in the uninstaller
<br>&gt;!insertmacro WriteUninstData SMDir $SMDir
<br>&gt;!insertmacro MUI_STARTMENU_WRITE_END
<br>SectionEnd
<br><br>Section Uninstall
<br>&gt;!insertmacro ReadUninstData $SMDir SMDir
<br>&gt;${If} $InstDir != ""
<br>   Delete "$InstDir\${APPNAME}.ico"
<br>   Delete "$InstDir\${APPNAME}.jar"
<br>   RMDir /r "$InstDir\lib"
<br>&gt;${EndIf}
<br>${If}$SMDir != ""
<br>   Delete "$SMPrograms\$SMDir\${APPNAME}.lnk"
<br>   RMDir "$SMPrograms\$SMDir"
<br>&gt;${EndIf}
<br>&gt;DeleteRegKey SHCTX "Software\Microsoft\Windows\CurrentVersion\Uninstall\${REGUINSTKEY}"
<br>&gt;Delete "$InstDir\uninstall.exe"
<br>&gt;RMDir "$InstDir"
<br>&gt;Delete "$DESKTOP\MyApp.lnk"
<br>&gt;SectionEnd
<br><br>&gt;Function WriteUninstData
<br>Exch$1
<br>push$0
<br>Exch 2
<br>FileOpen$0 "$InstDir\uninstall.exe" a
<br>FileSeek$0 0 END
<br>FileWrite$0 "$\n$1&gt;"
<br>&gt;pop $1
<br>FileWrite$0 $1
<br>FileClose$0
<br>pop$1
<br>pop$0
<br>FunctionEnd
<br><br>&gt;Function Un.ReadUninstData
<br>Exch$9
<br>Push$0
<br>Push$1
<br>Push$2
<br>Push$3
<br>FileOpen$0 "$EXEPATH" r
<br>StrCpy$3 2
<br>&gt;${Do}
<br>   IntOp $3 $3 + 1
<br>    FileSeek$0 -$3 END $1
<br>   ${If} $3 &gt; 9999 ;${If} $1 &lt; 33000
<br>        StrCpy$9 "" ;failed
<br>        ${Break}
<br>    ${EndIf}
<br>   FileRead $0 $1
<br>    StrLen$2 $9
<br>    IntOp$2 $2 + 1
<br>    StrCpy$2 $1 $2
<br>   ${If} $2 == "$9&gt;"
<br>       StrLen $2 $9
<br>        IntOp$2 $2 + 1
<br>        StrCpy$9 $1 "" $2
<br>        ${Do}
<br>           StrCpy $1 $9 1 -1
<br>           ${If} $1 != "$\n"
<br>           ${AndIf} $1 != "$\r"
<br>                ${Break}
<br>            ${EndIf}
<br>           StrCpy $9 $9 -1
<br>       ${Loop}
<br>        ${Break}
<br>    ${EndIf}
<br>${Loop}
<br>&gt;pop $3
<br>pop$2
<br>pop$1
<br>pop$0
<br>Exch$9
<br>FunctionEnd 
<br>&gt;

</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">redxii</span><br>
      <span class="post-time small text-muted">25th October 2010 21:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Just off the bat.. since you are using MultiUser for a mixed admin/non-admin install are you checking for the correct context? $SMPrograms will either be the currently logged in user's start menu if SetShellVarContext is set to 'current' (default) and it looks as if you are intending to remove all users' start menu. The same goes for $DESKTOP, its location too will depend on SetShellVarContext.<br>
      <br>
      One way is to check a string in HKCU or HKLM to see which exists, then set un.MultiUser.InstallMode.AllUsers or un.MultiUser.InstallMode.CurrentUser accordingly. You have to check HKLM and HKCU explicitly you can't use SHCTX.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br>
      <span class="post-time small text-muted">25th October 2010 22:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The warning is there because multiuser.nsh wants it, but since its uninstaller handling is broken (IMHO) I use some custom stuff and the function that uses un.StrStr never gets called. I'm guessing you could !define UnStrStr_INCLUDED before including multiuser.nsh and then undef it again.<br>
      <br>
      The normal way to deal with a problem like this is to messagebox the path in the uninstaller and make sure it is correct like redxii suggests.<br>
      <br>
      But there is a bigger problem here, why are you using a dual mode script (single and all users) when you are installing files in $sysdir, only admins can do that so normal users will not be able to install without errors!<br>
      <br>
      As a final note, adding a desktop shortcut in the startmenu section is well, not kind to your users, just add a desktop shortcut section and a components page</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JackN</span><br>
      <span class="post-time small text-muted">26th October 2010 14:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Ok: back to basics since I need to complete this. I don't need MultiUser or Admin, I was just following the example in <a href="http://www.nsis.pastebin.com/PmiY8DuZ" target="_blank">http://www.nsis.pastebin.com/PmiY8DuZ</a> hoping to get to a quick solution. I've gone back to something simpler that installs properly but uninstall is only partial. SMPrograms icons are still not being deleted. I have been programming in embedded environments for some time but I am very new to application programming and desktop environments. I am developing on Vista 64 but need to target XP and Vista 32 and 64 installs. I don't need all the bells and whistles in this 1.0 distribution but it would be nice if I could get it to uninstall properly. What is the simplest method to repair the uninstall to include SMPrograms?<br>
      <br>
      Install details:<br>
      <br></p>

      <blockquote>
        Output folder: C:\Program Files (x86)\MyApp<br>
        Extract: MyApp.ico... 100%<br>
        Extract: MyApp.jar... 100%<br>
        Create folder: C:\Program Files (x86)\MyApp\lib<br>
        Extract: lib\jcommon-1.0.16.jar... 100%<br>
        Extract: lib\jfreechart-1.0.13.jar... 100%<br>
        Extract: lib\Serialio.jar... 100%<br>
        Created uninstaller: C:\Program Files (x86)\MyApp\Uninstall.exe<br>
        Extract: C:\Windows\system32\jspWin.dll... 100%<br>
        Create folder: C:\Users\jackn\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\MyApp<br>
        Create shortcut: C:\Users\jackn\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\MyApp\MyApp.lnk<br>
        Create shortcut: C:\Users\jackn\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\MyApp\Uninstall MyApp.lnk<br>
        Completed
      </blockquote>Uninstall details:<br>
      <br>

      <blockquote>
        Delete file: C:\Program Files (x86)\MyApp\MyApp.ico<br>
        Delete file: C:\Program Files (x86)\MyApp\MyApp.jar<br>
        Delete file: C:\Program Files (x86)\MyApp\Uninstall.exe<br>
        Delete file: C:\Program Files (x86)\MyApp\lib\jcommon-1.0.16.jar<br>
        Delete file: C:\Program Files (x86)\MyApp\lib\jfreechart-1.0.13.jar<br>
        Delete file: C:\Program Files (x86)\MyApp\lib\Serialio.jar<br>
        Remove folder: C:\Program Files (x86)\MyApp\lib\<br>
        Remove folder: C:\Program Files (x86)\MyApp\<br>
        Remove folder: C:\Users\jackn\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\MyApp\<br>
        Completed
      </blockquote>
      <pre>
<code>
"MyApp"
<br>&gt;!define REGUINSTKEY "{ce9c1ec4-7410-4376-bf7e-4abf0bd9f0ac}" ; guidgen.com
<br>&gt;!include x64.nsh
<br>OutFile "Setup_${APPNAME}.exe"
<br>&gt;Name "${APPNAME}"
<br>&gt;InstallDir "$PROGRAMFILES\${APPNAME}"
<br>&gt;DirText "Please choose install directory"
<br><br>&gt;Section "Install"
<br>&gt;SetOutPath $InstDir
<br>File${APPNAME}.ico
<br>File dist</code>${APPNAME}.jar
<br>CreateDirectory "$InstDir\lib"
<br>&gt;File /oname=libjcommon-1.0.16.jar distlibjcommon-1.0.16.jar
<br>File/oname=libjfreechart-1.0.13.jar distlibjfreechart-1.0.13.jar
<br>File/oname=libSerialio.jar distlibSerialio.jar
<br>WriteUninstaller $InstDirUninstall.exe
<br>&gt;; Check OS for proper jspWin.dll
<br>&gt;${If} ${RunningX64}
<br>   File /oname=$SYSDIRjspWin.dll dll64bjspWin.dll
<br>&gt;${Else}
<br>   File /oname=$SYSDIRjspWin.dll dll32bjspWin.dll
<br>&gt;${EndIf}
<br>;Check for Java Runtime Environment (JRE)
<br>${If} ${RunningX64} 
<br>    ${DisableX64FSRedirection} 
<br>    ${Unless} ${FileExists} "$SYSDIR\javaw.exe" 
<br>       ExecWait '"jre-6u22-windows-x64.exe"'
<br>   ${EndUnless} 
<br>    ${EnableX64FSRedirection} 
<br>${Else}  
<br>    ${Unless} ${FileExists} "$SYSDIR\javaw.exe" 
<br>       ExecWait '"jre-6u22-windows-i586-s.exe"'
<br>   ${EndUnless} 
<br>${EndIf}  
<br>&gt;WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${REGUINSTKEY}" "UninstallString" '"$InstDir\Uninstall.exe"'
<br>&gt;WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${REGUINSTKEY}" "DisplayName" "${APPNAME} (remove only)"
<br>&gt;CreateDirectory "$SMPrograms\${APPNAME}"
<br>&gt;CreateShortCut "$SMPrograms\${APPNAME}\${APPNAME}.lnk" "$SYSDIR\javaw.exe" "-jar ${APPNAME}.jar" "$InstDir\${APPNAME}.ico"
<br>&gt;CreateShortCut "$SMPrograms\${APPNAME}\Uninstall ${APPNAME}.lnk" "$InstDir\Uninstall.exe" "$InstDir\${APPNAME}.ico"
<br>&gt;MessageBox MB_OK "Installation was successful."
<br>&gt;SectionEnd
<br><br>Section Uninstall
<br>&gt;${If} $InstDir != ""
<br>   Delete "$InstDir\${APPNAME}.ico"
<br>   Delete "$InstDir\${APPNAME}.jar"
<br>   Delete "$InstDir\Uninstall.exe"
<br>   RMDir /r "$InstDir\lib"
<br>   RMDir "$InstDir"
<br>&gt;${EndIf}
<br>&gt;Delete "$SMPrograms\${APPNAME}\${APPNAME}.lnk"
<br>&gt;Delete "$SMPrograms\${APPNAME}\Uninstall ${APPNAME}.lnk"
<br>&gt;RMDir "$SMPrograms\${APPNAME}"
<br>&gt;DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${REGUINSTKEY}"
<br>&gt;SectionEnd 
<br>&gt;

</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JackN</span><br>
      <span class="post-time small text-muted">26th October 2010 16:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Solved: also needed<br></p>
      <pre>
<code>
RequestExecutionLevel highest 
<br>&gt;
</code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br>
      <span class="post-time small text-muted">26th October 2010 17:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by JackN</small><br>
        Solved: also needed<br>
        <pre>
<code>
RequestExecutionLevel highest 
<br>&gt;
</code>
</pre>
      </blockquote>This issue is a known NT6 problem, see <a href="http://nsis.sourceforge.net/Shortcuts_removal_fails_on_Windows_Vista" target="_blank">http://nsis.sourceforge.net/Shortcut..._Windows_Vista</a> (Basically, MS broke all old nsis installers)<br>
      <br>
      Using "RequestExecutionLevel highest" is not the correct solution for you since you are installing stuff in $sysdir. Like I said, only admins can do that. Take a look at <a href="http://www.nsis.pastebin.com/63tS3AS2" target="_blank">http://www.nsis.pastebin.com/63tS3AS2</a> for info on how to make sure your installer runs as admin. Also, it is probably a good idea for you to set "SetShellVarContext all" in BOTH the installer and uninstaller before touching the $smprograms variable.
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>