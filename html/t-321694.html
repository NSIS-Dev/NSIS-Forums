<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Save listbox items on page leave" />

  <title>Save listbox items on page leave - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Save listbox items on page leave</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=321694">Save listbox items on page leave</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Netsurfer24</span><br />
      <span class="post-time small text-muted">15th August 2010 18:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Save listbox items on page leave</strong><br />
      Hi,<br />
      <br />
      what will be the best method to save listbox items on leaving the (custom) page so that they could be restored when the user returns to the page?<br />
      <br />
      Unfortunately NSIS doesn't support arrays (and only for this I don't want to use the array plugin - can only use headers and plugins that are included in the NSIS package!).<br />
      <br />
      Writing to a (temp) file is also unwanted.<br />
      Any other possibility?<br />
      <br />
      Thanks,<br />
      Gunther<br />
      <br />
      BTW: Is there any (understandable) explanation of nsDialogs::GetUserData?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">oldfriend</span><br />
      <span class="post-time small text-muted">15th August 2010 19:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hello.<br />
      <br />
      I had the same problem with the saving results of checkboxes. I used successfully global variables.<br />
      <a href="http://forums.winamp.com/showthread.php?t=320238" target="_blank">http://forums.winamp.com/showthread.php?t=320238</a></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Netsurfer24</span><br />
      <span class="post-time small text-muted">15th August 2010 20:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi,<br />
      <br />
      thanks for your reply, but unfortunately it doesn't help me much ..., because if you know the number of elements in advance and you can adress each element then it will be no problem.<br />
      <br />
      But i don't know how many entries an user will add to the listbox.<br />
      I can use ${NSD_LB_GetCount} to get the number but I don't know how to adress and store each entry?<br />
      <br />
      Gunther</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Animaether</span><br />
      <span class="post-time small text-muted">15th August 2010 20:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">as far as addressing listboxes, go...<br />
      <a href="http://nsis.sourceforge.net/Move_data_between_ListBoxes" target="_blank">http://nsis.sourceforge.net/Move_data_between_ListBoxes</a><br />
      <br />
      as far as storing the values goes... why not just write them out to a flat text file, and read them back in from that?<br />
      there's many alternatives, of course. If you don't want to use the Array plugin, for example, you could still create a pseudo-array using a string value with a delimiter (|, for example), and use StrTok from the String Functions header to get each one piecewise. It's more code than just dumping it to a text file but doesn't require file I/O.<br />
      <br />
      as for SetUserData and GetUserData... they allow you to store/restore data (a string, basically) as associated with an hwnd. They're useful temporary holders, or - for example - storing a URL with an NSD_CreateLink element so that upon code review you can immediately see what URL is associated with that link (and the code handling its OnClick can simply read that value).<br />
      Of course the down side is that once the hwnd is gone (i.e. you leave the page or the element is destroyed by any other means), so is the data - so it's not good for session-wide storage :)<br />
      These macros ease working with those two functions a little:<br />
      <a href="http://nsis.sourceforge.net/NsDialogs_UserData" target="_blank">http://nsis.sourceforge.net/NsDialogs_UserData</a></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Netsurfer24</span><br />
      <span class="post-time small text-muted">15th August 2010 23:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Animaether,<br />
      <br />
      many thanks for your detailed answer - it really helped me out! :up:<br /></p>

      <blockquote>
        <small>Originally posted by Animaether</small><br />
        as far as addressing listboxes, go...<br />
        <a href="http://nsis.sourceforge.net/Move_data_between_ListBoxes" target="_blank">http://nsis.sourceforge.net/Move_data_between_ListBoxes</a>
      </blockquote>OK, found also a helpful thread in the forum - <a href="http://forums.winamp.com/showpost.php?p=2226265&amp;postcount=10" target="_blank">http://forums.winamp.com/showpost.ph...5&amp;postcount=10</a><br />
      <br />
      There are two things to take care of:

      <ol style="list-style-type: decimal">
        <li>set the current selection to each item by using LB_SETCURSEL</li>

        <li>use the SystemCall instead of SendMessage</li>
      </ol>I ended up with the following leave function for the page (I am using the Unicode version):<br />
      PHP Code:
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #007700">Var</span><span style="color: #0000BB">CHART_DIR_TMP_FILE<br /></span> <span style="color: #007700">Function</span><span style="color: #0000BB">Page_SetConfig_Leave<br /></span> <span style="color: #007700">${</span><span style="color: #0000BB">NSD_LB_GetCount</span><span style="color: #007700">}</span><span style="color: #0000BB">$ListBox_SetConfig</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">0</span><span style="color: #007700">&gt;</span><span style="color: #0000BB">0<br />
      ClearErrors<br />
      FileOpen$R0$TEMPocpn_chart_dirs</span><span style="color: #007700">.</span><span style="color: #0000BB">tmpw<br />
      IfErrorsdone<br />
      IntOp</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">-</span><span style="color: #0000BB">1<br /></span> <span style="color: #007700">${For}$</span><span style="color: #0000BB">10</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      SendMessage$ListBox_SetConfig</span><span style="color: #007700">${</span><span style="color: #0000BB">LB_SETCURSEL</span><span style="color: #007700">}$</span><span style="color: #0000BB">10<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"User32::SendMessage(i$ListBox_SetConfig,i${LB_GETTEXT},i$1,t.r2)"<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">MessageBoxMB_OK</span><span style="color: #007700">|</span><span style="color: #0000BB">MB_ICONEXCLAMATION</span><span style="color: #DD0000">"Page_SetConfig_Leave$\r$\nLB_GETITEMDATA:$2"</span><span style="color: #007700">;</span><span style="color: #FF8000">#DEBUG<br /></span> <span style="color: #0000BB">FileWriteUTF16LE$R0</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      FileWriteUTF16LE$R0</span><span style="color: #DD0000">"$\r$\n"<br /></span> <span style="color: #007700">${</span><span style="color: #0000BB">Next</span><span style="color: #007700">}<br /></span> <span style="color: #0000BB">FileClose$R0<br />
      StrCpy$CHART_DIR_TMP_FILE1<br /></span> <span style="color: #007700">${EndIf}<br /></span> <span style="color: #0000BB">done</span><span style="color: #007700">:<br /></span> <span style="color: #0000BB">FunctionEnd<br /></span></span> <!-- php buffer end -->
      <hr />

      <blockquote>
        as far as storing the values goes... why not just write them out to a flat text file, and read them back in from that?
      </blockquote>As you can see I decided to do so. ;)<br />
      It's by far the easiest way ...<br />
      <br />

      <blockquote>
        there's many alternatives, of course. If you don't want to use the Array plugin, for example, you could still create a pseudo-array using a string value with a delimiter (|, for example), and use StrTok from the String Functions header to get each one piecewise. It's more code than just dumping it to a text file but doesn't require file I/O.
      </blockquote>Didn't checked it, but isn't there a great risk to "conflict" with NSIS_MAX_STRLEN when using a pseudo-array (path strings could be long)?<br />
      <br />
      So the only drawback/ side effect when storing the items to a text file is that I somehow have to delete the file if the user cancels the installation after the file was written (that's what the variable $CHART_DIR_TMP_FILE is for).<br />
      Do you have just another tip how to achieve this best?<br />
      <br />

      <blockquote>
        as for SetUserData and GetUserData...
      </blockquote>Thanks for the explanation - think I got it now.<br />
      <br />
      Gunther
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Animaether</span><br />
      <span class="post-time small text-muted">16th August 2010 00:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by Netsurfer24</small><br />
        Didn't checked it, but isn't there a great risk to "conflict" with NSIS_MAX_STRLEN when using a pseudo-array (path strings could be long)?
      </blockquote>If you're putting paths into the listbox, then yes - not recommended :)<br />
      For more typical use, it -can- be okay.. but the temp file is the most robust alternative to the Array plugin if you don't need the Array plugin's fancy features :)<br />
      <br />

      <blockquote>
        <small>Originally posted by Netsurfer24</small><br />
        So the only drawback/ side effect when storing the items to a text file is that I somehow have to delete the file if the user cancels the installation after the file was written (that's what the variable $CHART_DIR_TMP_FILE is for).<br />
        Do you have just another tip how to achieve this best?
      </blockquote>You can always just delete the file when the installer exits. Presuming you'll have a GUI (not much use for the listboxes in a silent installer), you can use .onGuiEnd. Otherwise, you can delete it in .onInstSuccess and .onInstFailed.<br />
      <br />
      That said - if you put your temp file into the PluginsDir (InitPluginsDir -&gt; $PLUGINSDIR), then it should automatically get deleted by NSIS (presuming you closed any file handles to the thing) :)
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Netsurfer24</span><br />
      <span class="post-time small text-muted">1st September 2010 10:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Just another question concerning storing variables (in my case path values) in a flat file.<br />
      <br />
      The variables (path values) are generated by scanning the HDD of the user. Every path found (there must exist two specific files) is<br />
      - added to the listbox<br />
      - written to the file<br />
      <br />
      Now the user may select certain list-items. The directories with the respective path values are then deleted.<br />
      <br />
      After they were deleted I need to remove/ delete these path values also<br />
      - from the listbox (no big deal as I get the value from it)<br />
      - from the file<br />
      <br />
      The latter is what I'd like to ask for.<br />
      How to delete certain values from the file?<br />
      <br />
      The values are stored each one in a line followed by $\r$\n.<br />
      <br />
      Thanks<br />
      <br />
      Gunther</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">1st September 2010 10:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Have you tried google?<br />
      <br />
      "nsis delete line from file"</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
