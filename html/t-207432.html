<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="system.dll problem" />

  <title>system.dll problem - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">system.dll problem</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=207432">system.dll problem</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">dilox77</span><br />
      <span class="post-time small text-muted">10th February 2005 17:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>system.dll problem</strong><br />
      Hi everybody, I'm tring to link my nsis installer with ncd by sony.<br />
      They give me dll, I put this into code:<br />
      System::Call 'libpidex_dll::cdecl_Pid_init(i) i() .r1'<br />
      System::Call 'libpidex_dll::cdecl_Pid_query_pid(t, i, *i) i(r2, r3, .r4) .r6'<br />
      System::Call 'libpidex_dll::cdecl_Pid_close(t) i() .r7'<br />
      <br />
      now:<br />
      $6 is 24, means lenght of key (ok)<br />
      $4 Pointed to buffer for returned query PID strings.<br />
      $4 is 16777216<br />
      How can I read that pointer (memory address right?) by nsis?<br />
      <br />
      Thank's in advance.<br />
      Regards, Pierluigi Di Lorenzo</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">10th February 2005 20:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Since you've used *, System.dll read the value pointed to by the pointer for you. The value is 16777216.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">dilox77</span><br />
      <span class="post-time small text-muted">11th February 2005 10:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thank's kichik, but I think I'm missing something else.<br />
      This is Query Pid synopsis:<br />
      3: Query PID<br />
      Syntax<br />
      int Pid_query_pid(char *drive, BYTE *key, BYTE *dest);<br />
      Description<br />
      drive: Pointed to NULL terminated drive letter string. e.g. "D:"<br />
      key: Reserved. Please set NULL.<br />
      dest: Pointed to buffer for returned query PID strings.<br />
      We recommend at least 256 bytes for this buffer.<br />
      return:<br />
      Negative value = Error code.<br />
      Positive value = Number of bytes for return data.<br />
      "dest" buffer structure.<br />
      Byte 0-2 :Reserved. 3bytes are all zero.<br />
      Byte 3 :Pid type. 0x00=Basic 0x01=Standard 0x02=Custom<br />
      Byte 4-7 :Number of bytes for valid PID data from Byte[8].<br />
      Little endian DWORD value.<br />
      Byte 8-n :PID Data<br />
      <br />
      I do not understand c so much.. so I'm not so sure I call System.dll with correct values.<br />
      <br />
      Moreover.. this is test.cpp they give me:<br />
      <br />
      pid_init(0);<br />
      pidLen = pid_query_pid(&amp;drive, NULL, pid_data);<br />
      <br />
      if(pidLen &gt; 0)<br />
      {<br />
      printf("\nPID from CD in Drive %c:\n\n%s\n", drive, CStr().Buffer2Hex(pid_data, pidLen));<br />
      }<br />
      else<br />
      {<br />
      printf("\nNo valid CD Drive or no PID on CD\n");<br />
      }<br />
      pid_close();<br />
      <br />
      After quering pid they have CStr().Buffer2Hex(pid_data, pidLen) function ( and result is something like: 00 00 00 01 10 00 00 00 00 00 00 00 00 00 00 00 00 00 00 04 00 00 27 A0), I think this is what I miss.<br />
      <br />
      Can somebody help me, please?<br />
      Thanks in advance, Pierluigi Di Lorenzo</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">11th February 2005 11:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If the second parameter needs NULL, don't pass the value of a register such as $2, simply use n.<br />
      <br />
      Take a look at the only FAQ item in the System readme for information on the third parameter. It explains in detail how to pass a structure to a function and how to get the values of the structure. It's exactly what you should do in this case.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">dilox77</span><br />
      <span class="post-time small text-muted">11th February 2005 15:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Great!<br />
      I put this into code:<br />
      <br />
      System::Alloc 256<br />
      Pop $4<br />
      System::Call 'libpidex_dll::cdecl_Pid_init(i) i() .r1'<br />
      System::Call 'libpidex_dll::cdecl_Pid_query_pid(t, i, i) i(r2, n, r4) .r6'<br />
      System::Call 'libpidex_dll::cdecl_Pid_close(t) i() .r7'<br />
      System::Call "*$4(l.r8, l.r9, l.r10)"<br />
      System::Free $4<br />
      <br />
      and I get this three long:<br />
      LONG HEX<br />
      68753031168--&gt;00 00 00 10 02 00 00 00<br />
      0---&gt;00 00 00 00 00 00 00 00<br />
      -4612545568545505213---&gt;BF FC F2 3E 64 8B 00 43<br />
      <br />
      key with test.exe is:<br />
      <br />
      00 00 00 02 10 00 00 00 00 00 00 00 00 00 00 00 43 00 8B 64 3E F2 FC BF<br />
      <br />
      Results are the equals inverting longs.<br />
      So.. it's possible to read ncd key from nsis :) (by libpidex_dll).<br />
      <br />
      Thanks again kichik!</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
