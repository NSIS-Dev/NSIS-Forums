<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="ServiceLib appears to have a bug..."><title>ServiceLib appears to have a bug... - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">ServiceLib appears to have a bug...</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=204726">ServiceLib appears to have a bug...</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">svendelmas</span><br><span class="post-time small text-muted">12th January 2005 18:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>ServiceLib appears to have a bug...</strong><br>Not sure whether this is the right forum, sorry if it is not.<br><br>I have been trying to register a service to run as a particular user, and noticed that the ServiceLib code is not passing a "t" for the last three arguments to CreateServiceA.<br><br>I changed the code (see below for an example... I can provide the complete file if needed), and now it works fine. Who would be in charge of updating the code on the web site (if it is deemed correct)? I tried to find a way to contact the original author of that code, but couldn't...<br><br>Also... the example page at <a href="http://nsis.sourceforge.net/archive/viewpage.php?pageid=345" target="_blank">http://nsis.sourceforge.net/archive/...php?pageid=345</a> should probably mention that the arguments passed to the call need to end with a ";" (I ran into that issue as well).<br><br>Finally, as far as I can tell, the "machine" argument should be called more something like "dependencies" (at least according to the MS docs).<br><br>Well this is reall the last question... I noticed a stalled thread on finding a way to programatically change the "log on as a service" setting for an account... is there any conclusion/solution for that?<br><br>The new code (just replace the relevant old code):<br>; create service<br>lbl_create:<br>Push $R1 ;depend<br>Push $R2 ;user<br>Push $R3 ;password<br>Push $R4 ;interact<br>Push $R5 ;autostart<br>Push $R6 ;path<br><br>!insertmacro CALL_GETPARAM $R1 "depend" "n" "lbl_depend"<br>lbl_depend:<br>StrCmp $R1 "n" lbl_depend_null lbl_depend_not_null<br>lbl_depend_null:<br>StrCpy $R7 ""<br>Goto lbl_depend_done<br>lbl_depend_not_null:<br>StrCpy $R7 "t"<br>lbl_depend_done:<br><br>!insertmacro CALL_GETPARAM $R2 "user" "n" "lbl_user"<br>lbl_user:<br>StrCmp $R2 "n" lbl_user_null lbl_user_not_null<br>lbl_user_null:<br>StrCpy $R8 ""<br>Goto lbl_user_done<br>lbl_user_not_null:<br>StrCpy $R8 "t"<br>lbl_user_done:<br><br>!insertmacro CALL_GETPARAM $R3 "password" "n" "lbl_password"<br>lbl_password:<br>StrCmp $R3 "n" lbl_password_null lbl_password_not_null<br>lbl_password_null:<br>StrCpy $R9 ""<br>Goto lbl_password_done<br>lbl_password_not_null:<br>StrCpy $R9 "t"<br>lbl_password_done:<br><br>!insertmacro CALL_GETPARAM $R4 "interact" "0x10" "lbl_interact"<br>StrCpy $6 0x10<br>IntCmp $R4 0 +2<br>IntOp $R4 $6 | 0x100<br>StrCpy $R4 $6<br>lbl_interact:<br><br>!insertmacro CALL_GETPARAM $R5 "autostart" "0x3" "lbl_autostart"<br>StrCpy $6 0x3<br>IntCmp $R5 0 +2<br>StrCpy $6 0x2<br>StrCpy $R5 $6<br>lbl_autostart:<br><br>!insertmacro CALL_GETPARAM $R6 "path" "n" "lbl_path"<br>lbl_path:<br>StrCmp $R6 "n" lbl_path_null lbl_path_not_null<br>lbl_path_null:<br>StrCpy $R0 ""<br>Goto lbl_path_done<br>lbl_path_not_null:<br>StrCpy $R0 "t"<br>lbl_path_done:<br><br>System::Call 'advapi32::CreateServiceA(i r4, t r2, t r2, i ${SERVICE_ALL_ACCESS}, i R4, i R5, i 0, $R0 R6, n, n, $R7 R1, $R8 R2, $R9 R3) i.r6'<br><br><br>Thanks,<br>Sven</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">13th January 2005 18:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><a href="http://forums.winamp.com/member.php?s=&amp;action=getinfo&amp;userid=76215" target="_blank">dselkirk</a> has a user with the same name on the forums too. You can send him a <a href="http://forums.winamp.com/private.php?s=&amp;action=newmessage&amp;userid=76215" target="_blank">private message</a>. Let me know if he doesn't respond and I'll see what I can do with the code.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">dan211a</span><br><span class="post-time small text-muted">5th May 2006 05:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hi,<br>for anyone out there still with the problem of registering a service under a particular account... I hope this will save you some time as I spent 2 hours on this. Unfortuntaley the code posted above did not work for me.<br><br>There are 2 gotchas to be aware of:<br>1. The servicelib.nsh library has a problem in formatting $R1 $R2 $R3 parameters when calling:<br><br>System::Call 'advapi32::CreateServiceA(...)<br><br>$R1 coresponds to what you define as 'machine' in the macro invocation. it will be 'n' if the machine parameter is omitted.<br><br>$R2 corresponds to what you define as 'user' in the macro invocation. it will be 'n' if the user parameter is omitted.<br><br>$R3 corresponds to what you define as 'password' in the macro invocation. it will be 'n' if the password parameter is omitted.<br><br>all works fine if you omitted those 3. If you specify them, you need to change the macro invocation and prepend to them a 't' to tell to the System::Call method that they are text strings.<br><br>So if you want to specify user and password, change the call to:<br>System::Call 'advapi32::CreateServiceA(i r4, t r2, t r2, i ${SERVICE_ALL_ACCESS}, i R4, i R5, i 0, t R6, n, n, R1, t R2, t R3) i.r6'<br><br>I know there should be a more generic method to allow user and password to be specified or not, and 'n' or 't' be used. This is just the line I use if I know that I will specify user and password.<br><br>2. you cannot set user and password if you have the parameter interact=1 . It must be set to 0. This is a windows requirement. interact=1 works if you do not specify user and password (local system account will be used).<br><br>As for username, use DOMAIN\username , or simply .\username for a local account.<br><br>Hope this helps, and thanks to everyone for contributing to NSIS!</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">6th May 2006 13:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The CreateService call indeed contains a few problems. It doesn't define the type of the last five parameters. It also tries to pass "n" inside the variable instead of at the variables's place. The later can probably be fixed with a replacement for CALL_GETPARAM that sets a define containing either "n" or "R6" according the input.</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>