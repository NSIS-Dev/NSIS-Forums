<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Re-read updated registry value"><title>Re-read updated registry value - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Re-read updated registry value</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=132798">Re-read updated registry value</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">hackingbear</span><br><span class="post-time small text-muted">23rd April 2003 03:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Re-read updated registry value</strong><br>Hi,<br><br>I'm attempting to do following:<br><br>1. Read a registry value into $R0 (J2SDK installed path)<br>2. If not set, run the external program (J2SDK installer)<br>3. Read the same registry value set by the external program into $R0<br>4. If not set, abort<br>5. continue<br><br>I found that the second read does not return me the new value set by the external program. I couldn't find anything that allows me to resync the registry. Did I do something wrong?<br><br>Thanks.<br>-HB</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br><span class="post-time small text-muted">23rd April 2003 08:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hmmm I guess Windows could be caching writes to the registry, in fact the presence of a Windows API called RegFlushKey() makes me believe that even more. I doubt there is a way to sync the entire registry since that would be very costly, I guess you could try using the System plugin to invoke RegFlushKey (and yes it does work on the major branches of the registry, e.g. HKLM or HKCU).<br><br>Microsoft MSDN informationa about RegFlushKey can be found <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/sysinfo/base/regflushkey.asp" target="_blank">here</a>.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">23rd April 2003 13:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I would first check if you have used Exec or ExecWait to execute the other installer. ExecWait will wait for the installer to finish while Exec will continue right on without waiting. If you have used ExecWait make sure it really does wait. Some installers extract a temporary executable and call it and return immediately which makes NSIS think that the program has finished, which is of course not true. If this is the case see <a href="http://forums.winamp.com/showthread.php?s=&amp;threadid=125550&amp;highlight=%2FSMS" target="_blank">this thread</a>. If your installer does wait as required use Sunjammer's solution.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">psyke</span><br><span class="post-time small text-muted">1st May 2003 04:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">any more info on this hackingbear? (or anyone else ;))<br><br>was it an exec vs/ execwait issue as kichik indicated, or was a registry flush required?<br><br>i'm just curious since i often write a registry key and then read it later on with no problems (at least i haven't become aware of any errors - lol).<br><br>I have even manipulated a key in an installer, changed the same registry key from another program and then read the updated value into the installer with nor problems <i>without</i> doing a registry flush.<br><br>I'm concerned becaused Sunjammer's approach makes sense to me and appers to be a very safe way to do what I'm doing, but i'd really rather not revise my installer script unless this flushing is really necessary. :P<br><br>Cheers. :D</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">faetter</span><br><span class="post-time small text-muted">15th June 2004 12:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I have kind of the same problem as hackingbear. Although registry values are changed by en external program the NSIS uninstaller still reads the old values.<br><br>Here's what's in my Uninstall section:<br>1. Call my application with a command line parameter to remove registry entries.<br>2. My application's files are removed.<br>3. NSIS removes it's registry entries.<br><br>The removal of reg. entries in step 1 is quite complicated so the easiest way to do it is simply to call my application .<br><br>The funny thing is, that if I make my app show a messagebox and thereby pausing its execution and then check the reg.values in regedit, they have updated correctly. But when my app has exited and the uninstaller is at step 2 the old values magically has returned.<br><br>I have checked and ExecWait correctly waits till my app has exited. I have even made the uninstaller Sleep 10000 msecs (after ExecWait has executed) and that doesn't change anything. I call the Windows API's RegFlushKey() from my app but it does not change a thing...<br><br>This is strange me thinks!</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Takhir</span><br><span class="post-time small text-muted">15th June 2004 13:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">faetter:<br>The only situation I can imagine is that registry values still remain in HKLM, so if you removed HKCU values, Window substitutes HKLM ones.<br><br>RegFlushKey() - this call may flush current open reg. key or section (HKLM), but do this (I guess, because who knows how MS lazy flusher was done) for current process only and not touches another process ( Java SDK installation). But this is still very strange, good idea is to test installation on few platforms - W2K, XP, W98 (and W95 Gold :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">faetter</span><br><span class="post-time small text-muted">15th June 2004 14:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote>The only situation I can imagine is that registry values still remain in HKLM, so if you removed HKCU values, Window substitutes HKLM ones.</blockquote>The registry entries that my application removes are located in HKEY_CLASSES_ROOT so it is probably not the issue.<br><br>That RegFlushKey() is so badly coded that it only flushes for the current proces sounds so unbelievable that I'm willing to believe you! :rolleyes:<br><br>Arrgh, I must find some other smart way to do it then i guess... Suddently everything gets sooo complicated and silly me who though I could do things the easy way -sigh-.<br><br>Btw. I'm using XP Pro.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">faetter</span><br><span class="post-time small text-muted">15th June 2004 14:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hmmm... maybe I could work around it by doing this:<br><br>1. When you click the Uninstall icon in the Start Menu it launches "MyApplication.exe -uninstall".<br>2. My application is then launced and removes the registry entries.<br>3. When done, my app will terminate itself and make the NSIS uninstaller run right after (can this be done??).<br><br>What do you think?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Takhir</span><br><span class="post-time small text-muted">15th June 2004 14:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>homegrown installer is not good for rollback</strong><br>and in some other situations. But you know all file names, so it is easy to add a part of uninstall code to your application and run uninstaller (using WinExec() for example).</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">faetter</span><br><span class="post-time small text-muted">15th June 2004 15:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">It will not be a big problem but it is not very nice I know :).<br><br>The problem is that my application must not run while NSIS is uninstalling it. Have you got an idea on how to accomplish that?<br><br>I looked at WinExec() but wont it require that my app is running at the same time as NSIS?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">faetter</span><br><span class="post-time small text-muted">15th June 2004 16:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote>I looked at WinExec() but wont it require that my app is running at the same time as NSIS?</blockquote>No it wont - I'll try WinExec() :D</div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>