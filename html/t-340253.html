<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Problem with NSIS RunAs plug-in requesting administrator permission" />

  <title>Problem with NSIS RunAs plug-in requesting administrator permission - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Problem with NSIS RunAs plug-in requesting administrator permission</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=340253">Problem with NSIS RunAs plug-in requesting administrator permission</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">amitgatech</span><br />
      <span class="post-time small text-muted">5th January 2012 14:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Problem with NSIS RunAs plug-in requesting administrator permission</strong><br />
      0<br />
      down vote<br />
      favorite<br />
      1<br />
      share [fb]<br />
      share [tw]<br />
      I am quite new with NSIS. I am trying to request administrator permissions in order to run the installer, as it messes around a bit with registries. My problem with "RequestExecutionLevel" and "MULTIUSER_EXECUTIONLEVEL" is that they both absolutely block any non-Admin user from opening the installer, even when selecting "Run as Administrator" in the context menu. I have tried using the RunAs DLL, but I have not found a single thread as to what to put in the $command variable passed to "RunAsW" function.<br />
      <br />
      Here is my (pretty hacked-up) code:<br />
      <br />
      StrCpy $0 0<br />
      StrCpy $1 ""<br />
      System::Call 'RunAs::GetAdministrators(w r1, *i .r0) i .r2 ? u'<br />
      System::Alloc 64<br />
      Pop $4<br />
      StrCpy $4 $2<br />
      StrCpy $5 ""<br />
      loop:<br />
      IntCmp $0 0 endloop<br />
      System::Call '*$4(w .r3)'<br />
      StrCpy $5 "$5|$3"<br />
      endloop:<br />
      System::Free $4 ; we free the memory used by the array<br />
      StrCpy $5 "$5" "" 1<br />
      !insertmacro MUI_INSTALLOPTIONS_WRITE "Settings.ini" "Field 1" "ListItems" $5<br />
      !insertmacro MUI_INSTALLOPTIONS_DISPLAY "Settings.ini"<br />
      !insertmacro MUI_INSTALLOPTIONS_READ $1 "UserPass" "Field 1" "State"<br />
      !insertmacro MUI_INSTALLOPTIONS_READ $2 "Settings.ini" "Field 2" "State"<br />
      StrCpy $3 "%%LOGONSERVER%%"<br />
      StrCpy $3 0<br />
      StrCpy $4 0<br />
      System::Call 'RunAs::RunAsW(w r1, w r2, w r3, *w .r4) i .r0 ? u'<br />
      MessageBox MB_OK $0<br />
      IntCmp $0 1 success<br />
      Quit<br />
      success:<br />
      !insertmacro MUI_LANGDLL_DISPLAY<br />
      A lot of it is just guess work and trial and error. (btw - I also tried running through a loop to get all Administrators, but it seems the DLL was intended only for 32-bit machines, so...).<br />
      <br />
      Anyway, my question is:<br />
      <br />
      Does anybody know of a way (using "RunAs" or otherwise) to open a dialog requesting Username and password, check the credentials and continue with the installation only if they check out?<br />
      <br />
      Also, I know there is a way to set up an installer so that it comes with that nice shield icon on it that lets users know that Admin permission will be requested. Does anybody know how to do that?<br />
      <br />
      Any help would be very much appreciated, as this is the only thing currently preventing the deployment of my app.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">5th January 2012 19:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Did you just C&amp;P the question from Stackoverflow? Did you look at the answer I posted there?</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
