<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="windows exit"><title>windows exit - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">windows exit</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=325198">windows exit</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">hnedka</span><br><span class="post-time small text-muted">23rd December 2010 22:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>windows exit</strong><br>&nbsp; Hi, I'm using NSIS to make applications I use portable, but here is a problem - when I click to shutdown/restart windows and the launcher is still running (in ExecWait function, waiting for the application to exit), it exits immediately and is not given a chance to cleanup whatever is needed. How can I force Windows to wait instead, until the launcher does whatever needs to be done and exits? There must be some API or something.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">jpderuiter</span><br><span class="post-time small text-muted">24th December 2010 08:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><a href="http://forums.winamp.com/showthread.php?s=&amp;threadid=168092&amp;highlight=shutdown" target="_blank">http://forums.winamp.com/showthread....light=shutdown</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">hnedka</span><br><span class="post-time small text-muted">24th December 2010 09:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thank you very much! ;)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">hnedka</span><br><span class="post-time small text-muted">24th December 2010 22:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Unfortunately, it doesn't work. It works only when the NSIS launcher window is visible, which is not what I want. When it is in silent mode or when I hide its window using ShowWindow, it doesn't work. My system is Windows 7, btw. Any ideas? I don't want to prevent windows shutdown completely, I just want to give my portable apps few seconds to do their cleanup (currently, they get terminated immediately). One other thing that doesn't seem to work is "ShutdownBlockReasonCreate" API, which probably requires a visible window as well (not to mention it works only on Vista and newer).</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">25th December 2010 13:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Unless I have misunderstood your problem, it would make more sense for the program(s) you are launching to act on WM_QUERYENDSESSION and clean up accordingly. If they don't have a window then you must create one (it can be hidden).<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">hnedka</span><br><span class="post-time small text-muted">25th December 2010 20:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Modifying the launched program is not an option - after all, that's the whole point of portable launchers - to cleanup after application, that doesn't do it itself (even when it's open source, modifying it is not a good idea, because you would need to update the code everytime you download a new version + plus you would need to setup you machine for the right compiler).<br><br>Anyway, I have found a partial solution and it's surprisingly simple. All that I needed to do is to create a window and now, the launcher gets 5 seconds (default Windows value, can be changed in HKEY_CURRENT_USER\Control Panel\Desktop) to cleanup, which should suffice most of the time.<br><br></p><pre>
<code> System</code>::Call `kernel32::GetModuleHandle(i 0) i.R3`
<br>&gt;System::Call `user32::CreateWindowEx(i 0, t "STATIC", t "", i 0, i 0x80000000, i 0x80000000, i 0x80000000, i 0x80000000, i $HWNDPARENT, i 0, i R3, i 0) i.R1` 
</pre>But it would be nice to be able to control it via the message loop. Will do more experiments.
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">hnedka</span><br>
      <span class="post-time small text-muted">25th December 2010 22:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">OK, this is a final solution:<br></p>
      <pre>
<code>  System</code>::Call `kernel32::GetModuleHandle(i 0) i.r3`
<br> System::Call `user32::CreateWindowEx(i 0, t "STATIC", t "MyApp Portable Launcher", i 0, i 0, i 0, i 0, i 0, i $HWNDPARENT, i 0, i r3, i 0) i.r1`
<br> System::Call `user32::ShutdownBlockReasonCreate(i r1, w "MyApp Portable Launcher Cleanup") i.r0` 
</pre>The first two calls create a long (probably indefinite) block on Windows XP and older. On Vista and newer, the app would get terminated in 5 seconds. For that case, there is the call to "ShutdownBlockReasonCreate", which will override that limit. This function is not present in XP and will fail there, but is not needed there anyway.
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>