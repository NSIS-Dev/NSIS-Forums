<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="pointers with System::Call" />

  <title>pointers with System::Call - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">pointers with System::Call</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=308865">pointers with System::Call</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">BoscoBilly</span><br />
      <span class="post-time small text-muted">24th July 2009 18:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>pointers with System::Call</strong><br />
      Hi.<br />
      I am using the GetMacAddr sample provided by Brainsucker.<br />
      Getting the IP_ADAPTER_INFO structure vars the way he did it works fine - thanks Brainsucker!<br />
      However, I am trying to get a string var in that struct that needs to be accessed by pointer.<br />
      here are two lines: the 1st is the working stuff with my attempt to get the pointer I need; the 2nd is my non-working atempt to retrieve the value of that pointer that I need.<br />
      <br />
      System::Call '*$4(i.r4,i,&amp;t260.r5, &amp;t132.r6, i.r7, l.r8,,,,,*i R1)'<br />
      <br />
      System::Call '$R1-&gt;IpAddressList.IpAddress.String(t R2)'<br />
      <br />
      At the end of the first line, var R1 is a pointer.<br />
      In the 2nd line, I try to get the string - it returns nothing.<br />
      Could someone pl explain what I am doing wrong here?<br />
      Thx.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">BoscoBilly</span><br />
      <span class="post-time small text-muted">25th July 2009 02:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I altered the prior code due to some errors.<br />
      The element I was trying to access is a struct, not ptr.<br />
      here is the new code:<br />
      <br />
      First call is working code form Brainsucker<br />
      System::Call '*$4(i.r4,i,&amp;t260.r5, &amp;t132.r6, i.r7, l.r8,,,,i.R1)' # r1 is Struct IP_ADDR_STRING<br />
      <br />
      This call is to get 2nd struct from R1<br />
      System::Call "*$R1(,i.R2)" #R1 is Struct IP_ADDR_STRING with 5 members --<br />
      <br />
      This call crashes - it should get final 1-element struct from R2<br />
      ; System::Call "*$R2(t.R3)" # R2 is struct IP_ADDR_STRING with 1 member<br />
      <br />
      The 3rd Call returns nothing.<br />
      I have been all over the System plugin doc and cannot figger out this one.<br />
      Anyone done this b4?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">BoscoBilly</span><br />
      <span class="post-time small text-muted">25th July 2009 19:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">With the original Brainsucker code, it will only get first adapter.<br />
      <br />
      I run C++ code in my app which uses this very same call and I have no problems with it on test machines that this code will:<br />
      1) only show 1 adapter when there are 5.<br />
      2) will not rtn IPAddress.<br />
      <br />
      Is there someone who can help me with these problems?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">f0rt</span><br />
      <span class="post-time small text-muted">26th July 2009 19:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I adapted Brainsucker's script to report the currently assigned IP address of a network adapter as well.<br />
      <br />
      I did not have a debugger handy to analyze the memory layout of the IP_ADAPTER_INFO structure in detail. So there might be potential pitfalls.<br />
      <br />
      PHP Code:</p>
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #007700">!include</span><span style="color: #DD0000">"LogicLib.nsh"<br />
      <br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">defineMAXSIZE4096<br />
      <br />
      Name</span><span style="color: #DD0000">"MacAddrPluginExample"<br /></span> <span style="color: #0000BB">OutFile</span><span style="color: #DD0000">"macaddr.exe"<br /></span> <span style="color: #0000BB">SetPluginUnloadalwaysoff<br />
      <br />
      Section<br />
      SetOutPath$TEMP<br />
      <br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Alloc</span><span style="color: #007700">${</span><span style="color: #0000BB">MAXSIZE</span><span style="color: #007700">}<br /></span> <span style="color: #0000BB">Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      <br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'iphlpapi::GetAdaptersInfo(ir3r4,*l${MAXSIZE}r2)i.r1'<br />
      <br /></span> <span style="color: #0000BB">MessageBoxMB_OK</span><span style="color: #DD0000">"GetAdaptersInforeturnis$1"<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">1</span><span style="color: #007700">==</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">${While}$</span><span style="color: #0000BB">4</span><span style="color: #007700">!=</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">AccessIP_ADAPTER_INFOstructure<br /></span> <span style="color: #007700">;(</span><span style="color: #0000BB">PIP_ADAPTER_INFOnext</span><span style="color: #007700">,</span><span style="color: #0000BB">DWORDComboIndex</span><span style="color: #007700">,</span><span style="color: #0000BB">charAdapterName</span><span style="color: #007700">***91;</span><span style="color: #0000BB">256</span><span style="color: #007700">+</span><span style="color: #0000BB">4</span><span style="color: #007700">***93;,</span><span style="color: #0000BB">charDescription</span><span style="color: #007700">***91;</span><span style="color: #0000BB">128</span><span style="color: #007700">+</span><span style="color: #0000BB">4</span><span style="color: #007700">***93;,<br />
      ;</span><span style="color: #0000BB">UINTAddressLength</span><span style="color: #007700">,</span><span style="color: #0000BB">BYTEAddress</span><span style="color: #007700">***91;</span><span style="color: #0000BB">8</span><span style="color: #007700">***93;,</span><span style="color: #0000BB">DWORDIndex</span><span style="color: #007700">,</span><span style="color: #0000BB">UINTType</span><span style="color: #007700">,</span><span style="color: #0000BB">UINTDhcpEnabled</span><span style="color: #007700">,<br />
      ;</span><span style="color: #0000BB">PIP_ADDR_STRINGCurrentIpAddress</span><span style="color: #007700">,</span><span style="color: #0000BB">IP_ADDR_STRINGIpAddressList</span><span style="color: #007700">,...)<br />
      ;<br />
      ;</span><span style="color: #0000BB">IP_ADDR_STRING</span><span style="color: #007700">(</span><span style="color: #0000BB">PIP_ADDR_STRING</span><span style="color: #007700">*</span><span style="color: #0000BB">Next</span><span style="color: #007700">,</span><span style="color: #0000BB">IP_ADDRESS_STRINGIpAddress</span><span style="color: #007700">,<br />
      ;</span><span style="color: #0000BB">IP_MASK_STRINGIpMask</span><span style="color: #007700">,</span><span style="color: #0000BB">DWORDContext</span><span style="color: #007700">)<br />
      ;<br />
      ;</span><span style="color: #0000BB">IP_ADDRESS_STRING</span><span style="color: #007700">(</span><span style="color: #0000BB">charString</span><span style="color: #007700">***91;</span><span style="color: #0000BB">4</span><span style="color: #007700">*</span><span style="color: #0000BB">4</span><span style="color: #007700">***93;)<br />
      <br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'*$4(i.r4,i,&amp;m260.r5,&amp;m132.r6,i.r7,l.r8,&amp;m8,i,i,i,&amp;m16.r9)'<br />
      <br />
      <br /></span> <span style="color: #0000BB">Math</span><span style="color: #007700">::</span><span style="color: #0000BB">Script</span><span style="color: #DD0000">"hex={'0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F'};"<br /></span> <span style="color: #0000BB">Math</span><span style="color: #007700">::</span><span style="color: #0000BB">Script</span><span style="color: #DD0000">"s='';a=r8;b=r7;#{b--&gt;0,s=s+hex***91;a/16%16***93;+hex***91;a%16***93;+#***91;b&gt;0,'-',''***93;;a=a/256;};R0=s;"<br />
      <br />
      <br /></span> <span style="color: #0000BB">MessageBoxMB_OK</span><span style="color: #DD0000">"Adapternameis$5$\ndesc$6$\naddrlen$7$\naddr$8$\nMacAddr:$R0$\nIpAddress:$9"<br /></span> <span style="color: #007700">${EndWhile}<br />
      ${EndIf}<br />
      <br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Free</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">lastplugincallmustnothave</span><span style="color: #007700">/</span><span style="color: #0000BB">NOUNLOADsoNSISwillbeabletodeletethetemporaryDLL<br />
      SetPluginUnloadmanual<br /></span> <span style="color: #007700">;do</span><span style="color: #0000BB">nothing<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Free0<br />
      Math</span><span style="color: #007700">::</span><span style="color: #0000BB">Script</span><span style="color: #DD0000">""<br />
      <br /></span> <span style="color: #0000BB">SectionEnd<br /></span></span> <!-- php buffer end -->
      <hr />
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">BoscoBilly</span><br />
      <span class="post-time small text-muted">26th July 2009 19:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks, fOrt!<br />
      Your IP part is the right way to do it, despite that struct chain that seemed to require multiple CALLs with *!Rx.<br />
      The final struct in the IPAdressList chain has 1 element, which is the IP. It is a 16 byte array, just as you allocated for.<br />
      <br />
      As I said in my post, in my app , I get 5 MACs on this machine using GetAdapterInfo.<br />
      This script only returns 1, which happens to be the one with the correct IP in it!<br />
      My plan was not to get the IP this way, but to loop thru the MACs, as I do in my app, comparing IPs to get the matching MAC.<br />
      Given that, I wonder how reliable this script will be?<br />
      It works on my XP pro Sp2 and W2003 server R2 machines.<br />
      It would be nice of Brainsucker could jump in here.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">f0rt</span><br />
      <span class="post-time small text-muted">26th July 2009 20:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">It would be helpful for further analysis to get a memory dump of the pAdapterInfo parameter after the return from GetAdaptersInfo.<br />
      <br />
      I would suggest to use the example provided by Microsoft <a href="http://msdn.microsoft.com/en-us/library/aa365917%28VS.85%29.aspx" target="_blank">http://msdn.microsoft.com/en-us/libr...8VS.85%29.aspx</a> as a basis and insert code to dump the memory of pAdapterInfo in the while loop.<br />
      The value of ulOutBufLen would also be of interest because the NSIS script uses a maximum buffer of 4096.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
