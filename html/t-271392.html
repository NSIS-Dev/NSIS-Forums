<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Next free drive letter"><title>Next free drive letter - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Next free drive letter</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=271392">Next free drive letter</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">Merlinovich</span><br><span class="post-time small text-muted">18th May 2007 22:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Next free drive letter</strong><br>I need to add a network drive for the next available drive letter.<br><br>I saw a post from Junior Member scatlin how to add drive Q: as a mapped network drive with the command<br>Exec '"net" "use" "Q:" "\\server\directory" ...'<br><br>However first I would like to *find* the next drive letter not in use. If I do it with Q: and the user has already mapped Q:, my user is in trouble (the installation will either overwrite what he has or abort, both of which are undesirable). I searched in the forum and help file of NSIS, but came up empty handed.<br><br>I could perhaps use {GetDrives} with some tedious looping. But I don't want to reinvent the wheel ...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">18th May 2007 23:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">"net use * \\server\share" will use the next free drive letter.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Merlinovich</span><br><span class="post-time small text-muted">18th May 2007 23:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks, Anders! This works fine (kind of circumventing the problem) but now I need to know for the rest of my script which letter was assigned?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">19th May 2007 11:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">What is the output of that command?<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Merlinovich</span><br><span class="post-time small text-muted">19th May 2007 14:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Here is a small part of my NSIS script:<br><br>Exec '"net" "use" "*" "\\PM2000\ICIS5"'<br>...<br>; Configure ODBC data source GMS Central<br>WriteRegStr HKCU "Software\ODBC\ODBC.INI\ODBC Data Sources" "$Crop-CENTRAL-GMS" "Microsoft Access Driver (*.mdb)"<br>WriteRegStr HKCU "Software\ODBC\ODBC.INI\$Crop-CENTRAL-GMS" "DBQ" "X:\Database\$Crop\Central\$Crop-GMS.mdb"<br>WriteRegStr HKCU "Software\ODBC\ODBC.INI\$Crop-CENTRAL-GMS" "Driver" "$SYSDIR\odbcjt32.dll"<br>...<br><br>I'm setting up ODBC data sources to point to the newly created mapped network drive.<br>Now I would like to set X:\ to Q:\ above if Q:\ was the drive that was assigned in the net-command.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">19th May 2007 14:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Like I said, does that command tell you anything when you execute it such as the drive that was mapped?<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Merlinovich</span><br><span class="post-time small text-muted">19th May 2007 15:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Oh, with "that command" you mean the "net use" command. Silly me. Didn't know the "net use" until I got it from scatlin and Anders.<br><br>Here is some documentation from Microsoft though:<br><br>http://www.microsoft.com/resources/documentation/windows/xp/all/proddocs/en-us/net_use.mspx?mfr=true<br><a href="http://www.microsoft.com/resources/documentation/windows/xp/all/proddocs/en-us/net_use.mspx?mfr=true" target="_blank">http://www.microsoft.com/resources/d....mspx?mfr=true</a><br><br>As far as I can tell, there is no output from the command, e.g. telling me which drive letter was assigned. I can use a bare "net use" command to get a list of connected drives, but that NSIS' GetDrives can also do, and the problem with that is that the files in the new drive could be identical to files in for instance C:\ or D:\ also (same subdirectories), and my script should not mix up these instances.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">19th May 2007 16:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I guess you could compare the old list of drives with the new list to find out which one was added.<br>You could use NSISArray for that.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">demiller9</span><br><span class="post-time small text-muted">19th May 2007 16:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Here's the output of the net command that Stu is asking for:</p><pre>
<code>C:\Documents and Settings\Owner&gt;net use * \\laptop\scc_d<br>Drive Z: is now connected to \\laptop\scc_d.<br><br>The command completed successfully.<br><br></code>
</pre>I should point out that drive letter Z was not the 'next free drive letter' available to my way of thinking - my system only uses C (hard drive) and D (CD-ROM).<br>
      <br>
      Don
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">20th May 2007 11:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thank you. Something like this should get it.<br>
      <br></p>
      <pre>
<code><br>nsExec::ExecToStack 'net use * "\\PM2000\ICIS5"'<br>Pop $R0<br>StrCpy $R0 $R0 2 6<br></code>
</pre><br>
      $R0 will contain Z:<br>
      <br>
      You might want to do some validation checks on it though (i.e. check that it isn't empty!)<br>
      <br>
      Stu
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Merlinovich</span><br>
      <span class="post-time small text-muted">22nd May 2007 16:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for the feedback. I could never get the command nsExec::ExecToStack 'net use * "\\PM2000\ICIS5"' to work nor my first attempt Exec '"net" "use" "\\PM2000\ICIS5" "&gt;out.txt"' where out.txt would be empty. Instead Exec '"net" "use" "&gt;out.txt"' worked fine and produced a listing of drives as expected, but didn't help me of course.<br>
      <br>
      Instead I opted for the NSISArray solution that Stu outlined. Here is the solution for anyone interested (sorry if I goofed up some command, I'm a newbie to NSIS):<br>
      <br></p>
      <pre>
<code><br>  !include "NSISArray.nsh"<br>  !include "LogicLib.nsh"<br>  !include "FileFunc.nsh"<br>  !include "WordFunc.nsh"<br>  !include "TextFunc.nsh"<br>  !insertmacro GetDrives<br>  !insertmacro WordReplace<br>  !insertmacro LineRead<br>  Var /Global MappedDrive<br>  ${Array} "MyArray" 30 50<br>  ${ArrayFunc} Write<br>  ${ArrayFunc} Read<br>...<br>  ; Assign a mapped drive from \\PM2000\ICIS5<br>  ; automatically and put that in ODBC sources<br>  ; If it couldn't be assigned, then C:\ICIS5\... will be used<br>  StrCpy $MappedDrive "C:\ICIS5"<br>  ; Check first if it was already assigned to some network<br>  ; drive, then recover that<br>  ${GetDrives} "NET" "RecoverMappedDrive"<br>  ; It wasn't found, so try to add it, recovering which<br>  ; drive letter was assigned<br>  ${If} $MappedDrive == "C:\ICIS5"<br>     ${MyArray-&gt;Init}<br>     StrCpy $R1 0<br>     ${GetDrives} "NET" "SaveMappedDrives"<br>     ExecWait '"net" "use" "*" "\\PM2000\ICIS5" "/persistent:yes"'<br>     StrCpy $R1 0<br>     ${GetDrives} "NET" "GetMappedDriveLetter"<br>     ${MyArray-&gt;Delete}<br>  ${EndIf}<br>  ; Use of MappedDrive, which will either contain X: or C:\ICIS5<br>  WriteRegStr HKCU "Software\ODBC\ODBC.INI\$Crop-CENTRAL-GMS" "DBQ" \<br>  "$MappedDrive\Database\$Crop\Central\$Crop-GMS.mdb"<br>SectionEnd<br><br>; Check if X:\EXES\ICIS32.DLL exists (which it will if the<br>; network directory was already mapped to X: )<br>Function RecoverMappedDrive<br>  IfFileExists $9EXES\ICIS32.DLL 0 +3<br>     StrCpy $MappedDrive $9 1<br>     StrCpy $MappedDrive "$MappedDrive:"<br>  Push $0<br>FunctionEnd<br><br>Function SaveMappedDrives<br>  ${MyArray-&gt;Write} $R1 $9<br>  IntOp $R1 $R1 + 1<br>  Push $0<br>FunctionEnd<br><br>Function GetMappedDriveLetter<br>  ${MyArray-&gt;Read} $R2 $R1<br>  IntOp $R1 $R1 + 1<br>  ${If} $MappedDrive == "C:\ICIS5"<br>     StrCmp $9 $R2 +3 0<br>        StrCpy $MappedDrive $9 1<br>        StrCpy $MappedDrive "$MappedDrive:"<br>  ${EndIf}<br>  Push $0<br>FunctionEnd<br></code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">22nd May 2007 18:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I'm sorry, this code works much better :p<br>
      <br></p>
      <pre>
<code><br>ReadEnvStr $R0 COMSPEC<br>nsExec::ExecToStack '$R0 /C net use * "\\PC-01\Drive-C\NewPCTemp"'<br>Pop $R0<br><br>StrCmp $R0 0 +4<br>  Pop $R0<br>  DetailPrint $R0<br>  Abort<br><br>Pop $R0<br>StrCpy $MappedDrive $R0 2 6<br></code>
</pre><br>
      <br>
      Stu
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Merlinovich</span><br>
      <span class="post-time small text-muted">22nd May 2007 18:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">There might still be a problem with the exact location of the drive in the string, when using e.g. Spanish Windows or another regional Windows version. Perhaps this can be mended best by searching for ':' in the string, because that probably is independent of region (well, don't know about chinese!), so the drive letter will be just before ':'.<br>
      <br>
      Thanks for the alternative. My solution had the added benefit of introducing me to NSISarray that I think will be very useful for me in the future.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">22nd May 2007 18:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Good point. Let me see what I can do.<br>
      I just think the other solution is a bit dodgy because it's not direct.<br>
      <br>
      Stu</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">22nd May 2007 18:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Here we are.<br></p>
      <pre>
<code><br>ReadEnvStr $R0 COMSPEC<br>nsExec::ExecToStack '$R0 /C net use * "\\PC-01\Drive-C\NewPCTemp"'<br>Pop $R0<br><br>StrCmp $R0 0 +4<br>  Pop $R0<br>  DetailPrint $R0<br>  Abort<br><br>Pop $R0<br>StrCpy $R1 0<br>StrLen $R3 $R0<br><br>StrCpy $R2 $R0 1 $R1<br>StrCmp $R1 $R3 0 +3<br>  DetailPrint "Error: Mapped network drive could not be located."<br>  Abort<br>IntOp $R1 $R1 + 1<br>StrCmp $R2 : 0 -5<br>IntOp $R1 $R1 - 2<br><br>StrCpy $MappedDrive $R0 2 $R1<br></code>
</pre><br>
      <br>
      Stu
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bnicer</span><br>
      <span class="post-time small text-muted">23rd May 2007 15:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Wow! Is there nothing NSIS can't do? Returning the output from a command prompt! I've used comspec, command.com and cmd.exe in vbScript. So I hope this isn't wrong. All credit goes to Stu for the solution. I noticed with cmd.exe the /c switch halts the script, and since you're running the commandline via another process, I don't know if you need to close the dos box. It may not even open. I also tried comspec with /k which is supposed to keep the window open and it doesn't.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">23rd May 2007 15:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">nsExec hides the command prompt window and it has to wait for the execution to complete to get the exit code and output.<br>
      <br>
      This code will work if the output contains unicode characters as well.<br>
      <br>
      %COMSPEC% is what you should use because command prompt can be cmd.exe or command.com depending on the operating system.<br>
      <br>
      Stu</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Merlinovich</span><br>
      <span class="post-time small text-muted">24th May 2007 05:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Yes, NSIS is versatile :)<br>
      <br>
      I tried your new code (Stu) and it works fine in my desktop computer, even with a Spanish Windows version. So just when I thought the discussion was over, I stumbled over a case where my old version would work better. Perhaps Stu's code can be mended too to handle this case:<br>
      <br>
      I was trying to install on a Linux machine (VMWare) that has Windows XP as a subsystem (don't know the right term), and that Windows subsystem didn't allow the connection to the network drive without (LAN) username and password. So my installation with Stu's code just failed, while the old code "worked" to my surprise, because the old DOS window would then ask for username and password from the command prompt, and entering these, in fact *did* connect the network drive.<br>
      <br>
      I realize the "net use /username:&lt;&gt; /password:&lt;&gt;" is possible, but then I only have this kind of problem in 5% of my company's computers, the rest will connect automatically, and then it would be tedious in the 95% of cases to ask the user for LAN username and password. One drawback to the DOS window is that it is a bit ugly and distracting user attention, looks non-professional.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">24th May 2007 16:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If it fails then perhaps you could ask for a username and password (which you would have to write a small plugin for).<br>
      <br>
      I'll have a look at not using cmd.exe.<br>
      <br>
      Stu</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">24th May 2007 16:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hmm it seems to be ok now I get 0 on success without using cmd.exe.<br>
      <br></p>
      <pre>
<code><br>nsExec::ExecToStack 'net use * "\\PC-01\Drive-C\NewPCTempo"'<br>Pop $R0<br><br>StrCmp $R0 0 +4<br>  Pop $R0<br>  DetailPrint $R0<br>  Abort<br><br>Pop $R0<br>StrCpy $R1 0<br>StrLen $R3 $R0<br><br>StrCpy $R2 $R0 1 $R1<br>StrCmp $R1 $R3 0 +3<br>  DetailPrint "Error: Mapped network drive could not be located."<br>  Abort<br>IntOp $R1 $R1 + 1<br>StrCmp $R2 : 0 -5<br>IntOp $R1 $R1 - 2<br><br>StrCpy $MappedDrive $R0 2 $R1<br></code>
</pre><br>
      <br>
      Stu
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>