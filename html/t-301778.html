<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="macro within a macro"><title>macro within a macro - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">macro within a macro</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=301778">macro within a macro</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">mstone42</span><br><span class="post-time small text-muted">6th January 2009 21:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>macro within a macro</strong><br>I've seen (and am using) the code to define a single function and use it for both installer and uninstaller.<br><br>I've run into a problem where I'm using a third-party macro within my function and the builder is complaining that I need to have "un." before uninstall functions and not in front of install functions. How do I get around this without writing two functions?<br><br></p><pre>
<code><br>!macro myfunc un<br>Function ${un}myfunc<br>  Call ${un}someotherfunc  ; this works<br>  ${ThirdPartyMacro} $arg1 $arg2 ; this fails<br>  DetailPrint "something: $arg1"<br>FunctionEnd<br>!macroend<br> <br>!insertmacro myfunc ""<br>!insertmacro myfunc "un."<br></code>
</pre><br>
      <br>
      I've tried ${un}${ThirdPartyMacro}, ${${un}ThirdPartyMacro} and ${un.ThirdPartyMacro}, and none of them work. The weird thing is that "un.ThirdPartyMacro" is actually defined in the third party nsh file.<br>
      <br>
      Thanks!<br>
      Mitch
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br>
      <span class="post-time small text-muted">6th January 2009 22:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">it would you know, help if you said the name of the macro, but, the nsh probably has so way to define the uninstall macro</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mstone42</span><br>
      <span class="post-time small text-muted">7th January 2009 18:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">In one case it's a function from the StrFunc.nsh. Using ${StrRep} in the install function, and ${UnStrRep} in the separate uninstall function works, but that's the only difference in an otherwise lengthy function, which I would like to maintain only one copy of.<br>
      <br>
      In the second case, I turned the code from here: <a href="http://nsis.sourceforge.net/REG_MULTI_SZ_Reader" target="_blank">http://nsis.sourceforge.net/REG_MULTI_SZ_Reader</a>, into a nsh file, and defined 2 macros, ReadRegMulti &amp; un.ReadRegMulti. I'm certainly willing to entertain the notion that I didn't set it up correctly, given my lack of understanding of the NSIS scripting language, so any help in configuring it correctly would be swell!<br>
      <br></p>
      <pre>
<code><br>; with respect to KiCHiK<br><br>!ifndef ReadRegMulti<br>!define ReadRegMulti "!insertmacro ReadRegMulti"<br><br>!define HKEY_CLASSES_ROOT        0x80000000<br>!define HKEY_CURRENT_USER        0x80000001<br>!define HKEY_LOCAL_MACHINE       0x80000002<br>!define HKEY_USERS               0x80000003<br>!define HKEY_PERFORMANCE_DATA    0x80000004<br>!define HKEY_PERFORMANCE_TEXT    0x80000050<br>!define HKEY_PERFORMANCE_NLSTEXT 0x80000060<br>!define HKEY_CURRENT_CONFIG      0x80000005<br>!define HKEY_DYN_DATA            0x80000006<br> <br>!define KEY_QUERY_VALUE          0x0001<br>!define KEY_ENUMERATE_SUB_KEYS   0x0008<br> <br>!define REG_NONE                 0<br>!define REG_SZ                   1<br>!define REG_EXPAND_SZ            2<br>!define REG_BINARY               3<br>!define REG_DWORD                4<br>!define REG_DWORD_LITTLE_ENDIAN  4<br>!define REG_DWORD_BIG_ENDIAN     5<br>!define REG_LINK                 6<br>!define REG_MULTI_SZ             7<br> <br>!define RegOpenKeyEx     "Advapi32::RegOpenKeyExA(i, t, i, i, *i) i"<br>!define RegQueryValueEx  "Advapi32::RegQueryValueExA(i, t, i, *i, i, *i) i"<br>!define RegCloseKey      "Advapi32::RegCloseKeyA(i) i"<br><br><br>!macro ReadRegMulti ResultVar HKEY KeyName Key<br>  Push `${HKEY}`<br>  Push `${KeyName}`<br>  Push `${Key}`<br>  Call ReadRegMulti<br>  Pop `${ResultVar}`<br>!macroend<br><br>!macro un.ReadRegMulti ResultVar HKEY KeyName Key<br>  Push `${HKEY}`<br>  Push `${KeyName}`<br>  Push `${Key}`<br>  Call ReadRegMulti<br>  Pop `${ResultVar}`<br>!macroend<br><br><br>Function ReadRegMulti<br><br>  ;Get input from user<br>  Pop $R3    # "Strings"<br>  Pop $R2    # "Software\Joe Software"<br>  Pop $R1    # ${HKEY_CURRENT_USER}<br><br>  StrCpy $0 ""<br>  StrCpy $1 ""<br>  StrCpy $2 ""<br>  StrCpy $3 ""<br>  StrCpy $9 ""<br>    <br>    SetPluginUnload alwaysoff<br>    System::Call "${RegOpenKeyEx}($R1, '$R2', 0, ${KEY_QUERY_VALUE}|${KEY_ENUMERATE_SUB_KEYS}, .r0) .r3"<br>   <br>    StrCmp $3 0 goon<br>      StrCpy $9 "Can't open registry key! ($3)"<br>      Goto done<br>  goon:<br>   <br>    System::Call "${RegQueryValueEx}(r0, '$R3', 0, .r1, 0, .r2) .r3"<br>   <br>    StrCmp $3 0 read<br>      StrCpy $9 "Can't query registry value size! ($3)"<br>      Goto done<br>   <br>  read:<br>   <br>    StrCmp $1 ${REG_MULTI_SZ} multisz<br>      StrCpy $9 "Registry value no REG_MULTI_SZ! ($3)"<br>      Goto done<br>   <br>  multisz:<br>   <br>    StrCmp $2 0 0 multiszalloc<br>      StrCpy $9 "Registry value empty! ($3)"<br>      Goto done<br>   <br>  multiszalloc:<br>   <br>    System::Alloc $2<br>    Pop $1<br>   <br>    StrCmp $1 0 0 multiszget<br>      StrCpy $9 "Can't allocate enough memory! ($3)"<br>      Goto done<br>   <br>  multiszget:<br>   <br>    System::Call "${RegQueryValueEx}(r0, '$R3', 0, n, r1, r2) .r3"<br>   <br>    StrCmp $3 0 multiszprocess<br>      StrCpy $9 "Can't query registry value data! ($3)"<br>      Goto done<br>   <br>  multiszprocess:<br>   <br>    StrCpy $4 $1<br>   <br>    IntOp $6 $4 + $2<br>    IntOp $6 $6 - 1<br>   <br>    #loop:<br>   <br>      System::Call "*$4(&amp;t${NSIS_MAX_STRLEN} .r3)"<br>      #DetailPrint $3<br>      Push $3<br>      <br>      #StrLen $5 $3<br>      #IntOp $4 $4 + $5<br>      #IntOp $4 $4 + 1<br>      #IntCmp $4 $6 0 loop<br>   <br>  done:<br>    DetailPrint $9<br>   <br>    System::Free $1<br>   <br>    StrCmp $0 0 noClose<br>      System::Call "${RegCloseKey}(r0)"<br>   <br>  noClose:<br>   <br>  SetPluginUnload manual<br>FunctionEnd<br><br>!endif<br></code>
</pre>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>