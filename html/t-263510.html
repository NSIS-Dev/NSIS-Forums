<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Store reboot flag - but where?" />

  <title>Store reboot flag - but where? - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Store reboot flag - but where?</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=263510">Store reboot flag - but where?</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">stb</span><br />
      <span class="post-time small text-muted">12th January 2007 12:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Store reboot flag - but where?</strong><br />
      Hi,<br />
      <br />
      I want to improve behaviour when reboot on install is required. Therefore I want to store the reboot flag state at the end of installation somewhere.<br />
      <br />
      My application can then read this entry and show the user a warning that he has to reboot first (for example).<br />
      <br />
      But I want that stored reboot state to be removed/changed when the user reboots the machine.<br />
      <br />
      I know of three possibilities:<br />
      <br />
      a) I create a small file which removes the stored reboot flag. This can be called by "RunOnce" registry key.<br />
      <br />
      b) I create a file "has_to_reboot" e.g. in INSTDIR and let Windows delete this file on startup (using mechanism similar to "Delete /Rebootok").<br />
      <br />
      c) I use a kernel mutex. This is not stored to disk at all. Seems this is a more elegant solution.<br />
      <br />
      Currently I tend to use "c)" because it should be even safer than the disk-stored solutions.<br />
      <br />
      Does anyone see a problem using "c)" or has a better idea?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">12th January 2007 14:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You can call RegCreateKeyEx with the system plugin and use the REG_OPTION_VOLATILE flag</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">12th January 2007 15:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I can't see where is the big deal.<br />
      If reboot is mandatory, just skip the finish page and make your installer look like most IS installers.<br />
      See the attached example,</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">stb</span><br />
      <span class="post-time small text-muted">12th January 2007 18:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Forcing reboot is bad, even with msgbox before. IMHO<br />
      <br />
      As said before I want to _improve_ my installer / user experience. ;-)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">13th January 2007 10:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        I want to _improve_ my installer / user experience.
      </blockquote>Ah! forgive me, I wasn't focused to this point of view, I was just focused to the practical side :)<br />
      Sounds great user experience!<br />

      <blockquote>
        Forcing reboot is bad, even with msgbox before.
      </blockquote>Seems that none told that to IS developers thru past 10 years, in several IS versions!
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">demiller9</span><br />
      <span class="post-time small text-muted">13th January 2007 19:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Re: Store reboot flag - but where?</strong><br /></p>

      <blockquote>
        <i>Originally posted by stb</i><br />
        <b>I want to store the reboot flag state at the end of installation somewhere.<br />
        <br />
        My application can then read this entry and show the user a warning that he has to reboot first (for example).<br />
        <br />
        But I want that stored reboot state to be removed/changed when the user reboots the machine.<br /></b>
      </blockquote>I suggest you have the installer write the current boottime to a registry key where you have your other application information stored. (If your application doesn't have any registry info, create a key under HKEY_LOCAL_MACHINE\SOFTWARE\your_company\your_application). Then when your application starts it checks the boottime against that key and (if necessary) alerts the user that they must reboot before running the app. If they have rebooted, you could delete the registry key and won't need to check it again for future executions of your app.<br />
      <br />
      Microsoft says the boottime can be determined by running "net statistics server" (<a href="http://support.microsoft.com/kb/555737" target="_blank">http://support.microsoft.com/kb/555737</a>) and scan the string produced for the line starting "Statistics since". On my system (XP SP2) that value looks like it matches the registry string in HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Prefetcher\StartTime. If that value is good for other versions of Windows, you might be able to read that instead of doing the "nsExec::ExecToStack" with the Net command and parsing through the output.<br />
      <br />
      Don
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">stb</span><br />
      <span class="post-time small text-muted">14th January 2007 14:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">@demiller9: Thanks for contributing another method. I think it is more error-prone than the other solutions.<br />
      <br />
      IMHO kernel mutex is the best one: It is quite easy to use, has no problem with windows versions, does not store anything to the disk and does use widely used techniques (so MS will less probably disable it or insert bugs into it). The only draw back I can see is the kernel mutex format for Multi processor machines on Win2003 and higher (this "Global\" thing) -- so one has to make a differentiation between old (95) and new (2003) Windows versions. But I'm getting quite theoretical here...<br />
      <br />
      @Red Wine: Sorry for flaming a bit, but IMO InstallShield is no ideal. Not for this reboot thing and not for many other reasons. It may be practical for the developer to make a simple "MsgBox + Reboot" command. The only advantage I can see is: you can be very sure the user reboots before executing the software. But I can see grave disadvantages:<br />
      <br />
      - What about silent installation? Silent reboot? :-(<br />
      <br />
      - Most users do not really read those texts and messages on the screen because we (developers) show to much silly and superfluous texts -- especially in installers. Many people just click on "next" buttons.<br />
      <br />
      - There are some users who do work with their machine. They have documents open and maybe shutdown/reboot their machine very seldom. They like software which can be installed and run directly. They might expect your installer to perform this way. And if a reboot is required they would like to continue working and try the new software later (e.g. next day). Please be aware that there are end users who will lose their work due to "forced" reboots.<br />
      <br />
      Have a look at the WinXp security update: If you install those updates they almost always require a reboot. If you decline to reboot at once the message will minimize to tray. IMHO this is good. Every 15 minutes the message box will popup again. IMHO this is crap. I want to decide for myself when to reboot. It's funny that Microsoft needs multiple weeks, monthes or years to create a patch, and that it takes something like a month to get deployed but when it is on the machine you have to decline rebooting every 15 minutes.<br />
      <br />
      Nevertheless: Thanks for all contributions.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">14th January 2007 15:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Yeah, after all "do it the way like" is the entire meaning of Nullsoft Scriptable Install System!</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
