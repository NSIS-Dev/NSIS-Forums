<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="AccessControl SetRegKeyOwner failing"><title>AccessControl SetRegKeyOwner failing - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">AccessControl SetRegKeyOwner failing</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=274276">AccessControl SetRegKeyOwner failing</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">arrow15</span><br><span class="post-time small text-muted">12th July 2007 20:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>AccessControl SetRegKeyOwner failing</strong><br>Hi.<br><br>So basically, I'm trying to use AccessControl to gain control of several registry keys before changing their permissions to FullAccess for Everyone, then deleting them. Windows Vista forces every user, including administrators to first take control of a registry key before they can make any modifications to it, if they do not already have explicit write control.<br><br>I've been successful with GrantOnRegKey:<br></p><blockquote>AccessControl::GrantOnRegKey HKLM $KeyPath "Everyone" "FullAccess"</blockquote>This works perfectly.<br><br>I haven't had the same success with SetRegKeyOwner.<br><blockquote>AccessControl::SetRegKeyOwner HKLM $KeyPath "user"</blockquote>When I pop the errors off the stack for a few of these SetRegKeyOwner, GrantOnRegKey owner sequences, there are no errors for GrantOnRegKey, but for SetRegKeyOwner calls I get the following for the first:<br><blockquote>Cannot apply new ownership.<br>Error code: 0</blockquote>Then for the rest:<br><blockquote>Cannot apply new ownership.<br>Error code: 997</blockquote>Error code 997 is ERROR_IO_PENDING, which doesn't really make sense to me, as permissions changes work, and then the first error code reads as 0 (even though it shouldn't error on 0). The user name is correct, because if I put in a bad one, it gives me a bad trustee error.<br><br>Any ideas?...</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">arrow15</span><br><span class="post-time small text-muted">12th July 2007 22:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Follow up:<br><br>So I tried manually changing the registry key's permissions to full control to everyone, and the change of ownership worked. So basically as I see it here's how things stand on Vista:<br><br>-To edit permissions of the registry key (no write owner control), I have to first have the user take control of the key from the administrators group<br><br>-To take control of the key from the administrators group, I must first take write owner control permissions.<br><br>:igor: :igor: :igor:</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">13th July 2007 09:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I don't know why it fails, but you get the wrong error codes because of a bug in AccessControl. It uses GetLastError() to get the last error of SetNamedSecurityInfo, but SetNamedSecurityInfo uses the return value for specifying the error.<br><br>I've attached a fixed version. Let me know if it works before I upload it to the Wiki.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">arrow15</span><br><span class="post-time small text-muted">13th July 2007 19:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Yes, thank you, the new version's error codes are accurate. (That's what I suspected might be happening when I looked at the source code) I now get error code 5 (Access denied), which is far more believable, and seems to be what is going wrong. As for finding a solution, I'm still looking, and I'll post it if I find something. From what I've read though, many people consider this registry permissions / ownership business a bug with Vista, because it seems to basically trap you.<br><br>Thanks again.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Lyra78</span><br><span class="post-time small text-muted">27th December 2007 16:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hi everybody.<br>I tried kichik's version of the plug-in and the most recent (November 2007).<br>I realized that "GrantOnRegKey" doesn't work properly in the last version. Kichik's version works fine.<br><br>Does anyone know why kichik's changes seem to be lost in the last official version?<br><br>Thanks!</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">27th December 2007 17:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">In what way does it not work correctly?<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Lyra78</span><br><span class="post-time small text-muted">28th December 2007 07:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Setting full access on a registry key in local machine doesn't work. It just sets this permission for administrators and power users, not for users. The previous version I mentioned works correctly.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">28th December 2007 13:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Something else is wrong. The code to change a file or registry ACL has not changed between those two version with the exception of /noinherit.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Lyra78</span><br><span class="post-time small text-muted">28th December 2007 14:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I'd like to try the intermediate version of AccessControl.dll (August 2007), but I'm not able to find it. Can you help me?<br><br>Anyway, that's what happens: in my installation I create a registry key in local machine, then I set full access for all users by "GrantOnRegKey" function. If I compile the script with the latest version of AccessControl.dll (in ProgramFiles\NSIS\Plugins), and execute the file, then in my registry I get just "reading permissions" for Users.<br>But if I compile with kichik's version installed, then I get the right permissions for all users of that registry key.<br>I executed both the compiled files on Windows XP and Vista, and found the same curious behaviour.<br><br>This is my code:<br>WriteRegStr HKLM "Software\${COMPANY}\$REG_KEY" "$REG_VALUE" "$REG_DATA"<br>AccessControl::GrantOnRegKey \<br>HKLM "Software\${COMPANY}\$REG_KEY" "(S-1-5-32-545)" "FullAccess"<br><br>Thanks for help.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">31st December 2007 11:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Any error messages on the stack?<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">7th January 2008 19:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">There was a bug.<br><a href="http://nsis.sourceforge.net/File:AccessControl.zip" target="_blank">http://nsis.sourceforge.net/File:AccessControl.zip</a><br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Lyra78</span><br><span class="post-time small text-muted">8th January 2008 09:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">That's why there weren't any errors on the stack! :-)<br><br>Thanks for the correction: now it works fine!</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>