<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Default directory"><title>Default directory - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Default directory</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=168028">Default directory</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">mantty</span><br><span class="post-time small text-muted">4th February 2004 13:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Default directory</strong><br>Hi!<br><br>For few weeks i'm working with NSIS and now i'm stuck in a problem. I want do that in my MUI Directory Page, the name of the directory not to be able to be changed (browse, edit). Also i want to do this only if a condition is satisfied.<br><br>The code that i have now is looking like this:<br><br>!define MUI_PAGE_CUSTOMFUNCTION_PRE GetDir<br>!insertmacro MUI_PAGE_DIRECTORY<br>InstallDir "$PROGRAMFILES\blabla1"<br><br>Function GetDir<br>ReadRegStr $1 HKEY_LOCAL_MACHINE "SOFTWARE\blabla" "DataPath"<br>StrCmp $1 "" NoDir DirOK<br>NoDir:<br>;here i want to show directory page with edit option<br>DirOk:<br>StrCpy $INSTDIR $1<br>;here whitout, only readonly directory name<br>FunctionEnd</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">4th February 2004 17:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Use the following in the show callback function of the page:<br><br>FindWindow $0 "#32770" "" $HWNDPARENT<br>GetDlgItem $1 $0 &lt;insert control id here&gt;<br>EnableWindow $1 &lt;0 to disable or 1 to enable&gt;<br><br>To find out the control id, open Contrib\UIs\modern.exe, if using the MUI, or Contrib\UIs\default.exe, if not, using Resource Hacker and look at dialog number 103.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">mantty</span><br><span class="post-time small text-muted">5th February 2004 08:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks a lot!!!!<br>It works!!!</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">sunil_muppirala</span><br><span class="post-time small text-muted">3rd May 2005 08:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">hi used this the control ids are 1001 and 1019<br><br>but i cant get it working ..can u give me a sample code<br><br>sunil</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">3rd May 2005 18:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Attach an example code that doesn't work and someone will surely be able to help you fix it.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">jtbalogh</span><br><span class="post-time small text-muted">12th March 2006 16:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Sorry to bump this thread, but I have the same problem with the page, MUI_PAGE_STARTMENU. The MUI_PAGE_DIRECTORY page works okay with your suggestions above, but there is no show function for the callback in the MUI_PAGE_STARTMENU page because it is a custom page and not built-in like a directory page. Maybe there is a workaround without being too complicated?<br></p><pre>
<code><br>!define MUI_PAGE_CUSTOMFUNCTION_SHOW MyStartShow<br>!insertmacro MUI_PAGE_STARTMENU<br>Function MyStartShow<br>  ; WARNING: this functions never runs ...<br>  ${If} $2 == "1" ; readonly<br>    FindWindow $0 "#32770" "" $HWNDPARENT ; dialog number 103<br>    GetDlgItem $1 $0 1019 ; control id for textbox<br>    EnableWindow $1 0 ; 0 disable, 1 enable<br>    GetDlgItem $1 $0 1001 ; control id for button<br>    EnableWindow $1 0 ; 0 disable, 1 enable<br>  ${EndIf}<br>FunctionEnd<br></code>
</pre><br>
      <br>
      Of course the control id may be different since it is a custom page and resource hacker does not show the information for custom pages? The 'system.nsf' also gives no indication what it might be?
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br>
      <span class="post-time small text-muted">12th March 2006 20:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I made the code bellow in order to build a kind of patch, I hope could help. Checking the registry if my software is installed and if so the installer jumps to the install files page.<br>
      <br>
      code:<br>
      !define PRODUCT_DIR_REGKEY "Software\Microsoft\Windows\CurrentVersion\App Paths\MySoft.exe"<br>
      .<br>
      .<br>
      .<br>
      ; Welcome page -----------<br>
      !define MUI_PAGE_CUSTOMFUNCTION_PRE WelcomePre<br>
      !insertmacro MUI_PAGE_WELCOME<br>
      <br>
      ; Directory page ---------<br>
      !define MUI_PAGE_CUSTOMFUNCTION_PRE DirectoryPre<br>
      !insertmacro MUI_PAGE_DIRECTORY<br>
      .<br>
      .<br>
      .<br>
      .<br>
      Function WelcomePre<br>
      ReadRegStr "$R0" HKLM "${PRODUCT_DIR_REGKEY}" ""<br>
      StrCpy "$R1" "$R0" -13<br>
      StrCmp $R1 "" _ShowWelcomePage<br>
      IfFileExists "$R1\*.*" _skip _ShowWelcomePage<br>
      _skip:<br>
      Abort<br>
      _ShowWelcomePage:<br>
      FunctionEnd<br>
      <br>
      Function DirectoryPre<br>
      ReadRegStr "$R0" HKLM "${PRODUCT_DIR_REGKEY}" ""<br>
      StrCpy "$R1" "$R0" -13<br>
      StrCmp $R1 "" _ShowDirectoryPage<br>
      IfFileExists "$R1\*.*" _skip _ShowDirectoryPage<br>
      _skip:<br>
      StrCpy "$INSTDIR" "$R1"<br>
      Abort<br>
      _ShowDirectoryPage:<br>
      FunctionEnd</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br>
      <span class="post-time small text-muted">12th March 2006 21:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thus, this function is to skip start menu if needed:<br>
      <br>
      Function StartMenuPre<br>
      ReadRegStr "$R0" ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" "${PRODUCT_STARTMENU_REGVAL}"<br>
      StrCmp $R0 "" _ShowSMpage<br>
      IfFileExists "$SMPROGRAMS\$R0\*.*" _skip _ShowSMpage<br>
      _skip:<br>
      StrCpy "$ICONS_GROUP" "$R0"<br>
      Abort<br>
      _ShowSMpage:<br>
      FunctionEnd</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jtbalogh</span><br>
      <span class="post-time small text-muted">12th March 2006 23:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks, but not skip the startmenu page with abort. Two problems: 1. see the data for the shortcut, just like the directory page, even though it is readonly. 2. see the 'Install' button, but skipping the page does not show it and confuses people who click 'Next' in the directory page.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jtbalogh</span><br>
      <span class="post-time small text-muted">13th March 2006 00:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The startmenu plugin shows the dialog id 1033 is used in startmenu.dll. The window class is what ? So the next step is to somehow disable control id, 1002, 1004, 1005, when the window is shown.<br>
      <br>
      As a workaround, maybe use the resource hacker to edit the startmenu.dll and disable controls manually. Somehow the installer can switch between the two different dlls as needed. Who knows.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jtbalogh</span><br>
      <span class="post-time small text-muted">13th March 2006 02:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Good news. I found a solution to modify the 'system.nsh' file so that the startmenu page (StartMenu plugin) responds to the constant MUI_PAGE_CUSTOMFUNCTION_SHOW. No special custom pages are needed nor fancy custom routines. The only drawback is that the MUI_PAGE_CUSTOMFUNCTION_PRE has to be executed.<br>
      <br>
      I can not guarentee that it works exactly the same as the 'show' feature in the directory and other built-in pages, but it is close. For backward compatibility, the original code is executed when the constant is not defined. It does not matter if the MUI_PAGE_CUSTOMFUNCTION_PRE is defined or not.<br>
      <br>
      In the 'System.nsh' file, replace each of four 'StartMenu::' with a condition to use 'show' or 'select' as in the example below. The parameters can be copied from 'select' to 'show', but are different for each 'Startmenu'. The long startmenu command was broken into separate lines for this forum only, and does not have to be.<br>
      <br></p>
      <pre>
<code><br>!macro MUI_PAGE_STARTMENUCUSTOM ID VAR<br>    ; ... leave all code as is<br>!macroend<br><br>!macro MUI_FUNCTION_STARTMENUPAGE PRE LEAVE<br>  Function "${PRE}"<br><br>    ; ... leave most of code as is<br><br>    ;StartMenu::Select ... is replaced by the following code<br><br>    !ifndef MUI_PAGE_CUSTOMFUNCTION_SHOW<br>      ; this is the original code, no custom code<br>      StartMenu::Select /noicon /autoadd /text \<br>        "${MUI_STARTMENUPAGE_TEXT_TOP}" \<br>        /lastused "${MUI_STARTMENUPAGE_VARIABLE}" \<br>        "${MUI_STARTMENUPAGE_DEFAULTFOLDER}"<br><br>    !Else<br>      ; custom code, same parameters<br>      StartMenu::Init /NOUNLOAD /noicon  /autoadd /text \<br>        "${MUI_STARTMENUPAGE_TEXT_TOP}" \<br>        /lastused "${MUI_STARTMENUPAGE_VARIABLE}" \<br>        "${MUI_STARTMENUPAGE_DEFAULTFOLDER}"<br>      Call MUI_PAGE_FUNCTION_CUSTOMinsertmacro<br>      ;!undef MUI_PAGE_CUSTOMFUNCTION_SHOW ; already done<br>      StartMenu::Show<br><br>    !EndIf<br><br>    ; ... leave rest of code as is<br><br>  FunctionEnd<br><br>  Function MUI_PAGE_FUNCTION_CUSTOMinsertmacro<br>    ; function to insert macro only once or else ignored<br>    !insertmacro MUI_PAGE_FUNCTION_CUSTOM SHOW<br>  FunctionEnd<br><br>  Function "${SHOW}"<br>    ; not applicable for custom page callbacks<br>  FunctionEnd<br><br>  Function "${LEAVE}"<br>    !insertmacro MUI_PAGE_FUNCTION_CUSTOM LEAVE<br>  FunctionEnd<br>!macroend<br></code>
</pre>My installer script is changed to use the new feature. I have to define the MUI_PAGE_CUSTOMFUNCTION_PRE too since it contains the code to check MUI_PAGE_CUSTOMFUNCTION_SHOW. Comment out the MUI_PAGE_CUSTOMFUNCTION_SHOW to ignore the custom code. Comment out the MUI_PAGE_CUSTOMFUNCTION_PRE to ignore all code.<br>
      <pre>
<code><br>Var MyStartMenuReadonly<br><br>!define MUI_PAGE_CUSTOMFUNCTION_PRE SelectPageShortcut<br>!define MUI_PAGE_CUSTOMFUNCTION_SHOW ShowPageShortcut<br>!insertmacro MUI_PAGE_STARTMENU "StartMenuPageID" "TestFolder"<br><br>Function .onInit<br>  ; Use one of the following lines for the page<br>  StrCpy $MyStartMenuReadonly "" ; false, access everything<br>  ;StrCpy $MyStartMenuReadonly "1" ; true, readonly<br>FunctionEnd<br><br>Function SelectPageShortcut<br>FunctionEnd<br><br>Function ShowPageShortcut<br>  Push $0<br>  Push $1<br><br>  ; readonly options<br>  ${If} $MyStartMenuReadonly != ""<br>    FindWindow $0 "#32770" "" $HWNDPARENT ; dialog number ?<br>    GetDlgItem $1 $0 1002 ; control id for editbox<br>    EnableWindow $1 0 ; 0 disable, 1 enable<br>    GetDlgItem $1 $0 1004 ; control id for listbox<br>    EnableWindow $1 0 ; 0 disable, 1 enable<br>  ${EndIf}<br><br>  Pop $1<br>  Pop $0<br>FunctionEnd<br></code>
</pre>Since I do not like to change the 'system.nsh' because I might loose it after reinstalling NSIS, then copy/paste/change the code into a new file and '!include' it in your program. Add the suffix, 'CUSTOM', to represent the new names. The code to copy is,<br>
      <pre>
<code><br>!macro MUI_PAGE_STARTMENUCUSTOM ID VAR<br>;!macro MUI_PAGE_STARTMENU ID VAR ; old name<br>  !insertmacro MUI_FUNCTION_STARTMENUPAGECUSTOM \<br>    ${MUI_PAGE_UNINSTALLER_FUNCPREFIX}mui.StartmenuPre_${MUI_UNIQUEID} \<br>    ${MUI_PAGE_UNINSTALLER_FUNCPREFIX}mui.StartmenuLeave_${MUI_UNIQUEID}<br>  ;!insertmacro MUI_FUNCTION_STARTMENUPAGE ; old name<br>  ; ... everything else copied with no other changes<br>!macroend<br><br>!macro MUI_FUNCTION_STARTMENUPAGECUSTOM PRE LEAVE<br>;!macro MUI_FUNCTION_STARTMENUPAGE PRE LEAVE ; old name<br>  ; ... everything else copied with no other changes<br>!macroend<br></code>
</pre>The installer script refers to the new names with,<br>
      <pre>
<code><br>!include "MyNewSystem.nsh"<br>!insertmacro MUI_PAGE_STARTMENUCUSTOM "StartMenuPageID" "TestFolder"<br>;!insertmacro MUI_PAGE_STARTMENU "StartMenuPageID" "TestFolder" ; old name<br></code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jtbalogh</span><br>
      <span class="post-time small text-muted">13th March 2006 03:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I had to fix the code above by adding the function 'MUI_PAGE_FUNCTION_CUSTOMinsertmacro' to only insert one macro, '!insertmacro MUI_PAGE_FUNCTION_CUSTOM SHOW'. It can not be inserted four times, otherwise, the last three inserted macros are ignored.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jtbalogh</span><br>
      <span class="post-time small text-muted">13th March 2006 19:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Correction, change code above:<br>
      !insertmacro MUI_PAGE_STARTMENU "StartMenuPageID" "TestFolder"<br>
      <br>
      to,<br>
      Var StartMenuFolder<br>
      !insertmacro MUI_PAGE_STARTMENU "StartMenuPageID" $StartMenuFolder</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jtbalogh</span><br>
      <span class="post-time small text-muted">13th March 2006 19:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">In case anyone has default folder screwed by the startmenu page, then always disable the listbox and always use GetWindowText. Otherwise, the leave function might not see the variable nor the MUI_STARTMENU_GETFOLDER because it is not updated yet with the input seen in the window. Otherwise, selecting a folder in the listbox adds to the name, but adds to it again if returning to edit after using 'Back/Next' from other pages.<br></p>
      <pre>
<code><br>!include "FileFunc.nsh" ; for ...<br>!insertmacro GetFileName ; from FileFunc.nsh<br>!insertmacro GetRoot ; from FileFunc.nsh<br>Var StartMenuFolder<br>Function .onInit<br>  StrCpy StartMenuFolder "foldername\subfoldername"<br>FunctionEnd<br><br>!define MUI_STARTMENUPAGE_TEXT_TOP "Enter the name of an existing \<br>or new folder in which you would like to create the program's \<br>shortcuts."<br>!define MUI_STARTMENUPAGE_DEFAULTFOLDER $StartMenuFolder<br>!define MUI_PAGE_CUSTOMFUNCTION_PRE SelectPageShortcut<br>!define MUI_PAGE_CUSTOMFUNCTION_SHOW ShowPageShortcut<br>!define MUI_PAGE_CUSTOMFUNCTION_LEAVE ValidatePageShortcut<br>!insertmacro MUI_PAGE_STARTMENU "StartMenuPageID" $StartMenuFolder<br><br>Function ShowPageShortcut<br>  Push $0<br>  Push $1<br><br>  FindWindow $0 "#32770" "" $HWNDPARENT ; dialog number ?<br>  GetDlgItem $1 $0 1004 ; control id for listbox<br>  EnableWindow $1 0 ; 0 disable, 1 enable<br><br>  ; (see code above in this thread on how to enable this function)<br><br>  Pop $1<br>  Pop $0<br>FunctionEnd<br><br>Function ValidatePageShortcut<br>  Push $R0<br>  Push $0<br>  Push $1<br><br>  ; Check results<br>  FindWindow $0 "#32770" "" $HWNDPARENT ; dialog number ?<br>  GetDlgItem $1 $0 1002 ; control id for editbox<br>  System::Call 'user32::GetWindowText(i $1, t .R0, i 256)'<br>  StrCpy $StartMenuFolder $R0 ; overwrite to ignore page problems<br><br>  ${GetRoot} "$StartMenuFolder" $1<br>  ${If} "$1" != "" ; name can not have drive/network info<br>    MessageBox MB_OK "WARNING: The name can not have information \<br>    about drives, networks, symbols, etc." IDOK<br>    Abort ; only cancels page, not program<br>  ${EndIf}<br><br>  ; (optional)<br>  ;${GetFileName} "$StartMenuFolder" $StartMenuFolder ; strip folders<br>  ;${If} "$StartMenuFolder" != "$R0" ; name can not have extra info<br>  ;  MessageBox MB_OK "WARNING: The name can not have information \<br>  ;  about paths, symbols, etc." IDOK<br>  ;  Abort ; only cancels page, not program<br>  ;${EndIf}<br><br>  ${If} "$StartMenuFolder" == "" ; can not be empty<br>    MessageBox MB_OK "WARNING: The name can not be blank." IDOK<br>    Abort ; only cancels page, not program<br>  ${EndIf}<br><br>  Pop $1<br>  Pop $0<br>  Pop $R0<br>FunctionEnd<br></code>
</pre>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>