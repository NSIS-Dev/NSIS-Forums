<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="How to Detect Other Windows Logons"><title>How to Detect Other Windows Logons - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">How to Detect Other Windows Logons</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=236729">How to Detect Other Windows Logons</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">JoeAcunzo</span><br><span class="post-time small text-muted">30th January 2006 16:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>How to Detect Other Windows Logons</strong><br>During an install, is there a way to detect if there are other Window users logged into the machine? I want to prevent installation if there are other users logged on.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">31st January 2006 18:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You can write a plug-in that'd use <a href="http://msdn.microsoft.com/library/en-us/termserv/termserv/wtsenumeratesessions.asp" target="_blank">WTSEnumerateSessions</a> or call it using the System plug-in.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JoeAcunzo</span><br><span class="post-time small text-muted">31st January 2006 22:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Yep, I've started down that path already. I wrote a small C++ program to experiment with WTSEnumerateSessions, which works nicely.<br><br>Unfortunately, it will be a bit of a pain in NSIS due to the memory pointer it returns to an array of structures. Can you point me to any sample NSIS code that does something similar (use a pointer to walk an array of structs)?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">goldy1064</span><br><span class="post-time small text-muted">31st January 2006 23:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">In the plugin you already wrote, just add another function that can return the appropriate data you need to the installer via the NSIS stack.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">3rd February 2006 10:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You said you wanted to find out if another user is logged on, there's no need to return an array to the script for that. Have the plug-in check if there's more than one session and return a simple string.<br><br>If you want to return an array anyway, check out:<br><br><a href="http://nsis.sourceforge.net/Enumerate_CD-ROM_Drives" target="_blank">http://nsis.sourceforge.net/Enumerate_CD-ROM_Drives</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">M-Force</span><br><span class="post-time small text-muted">12th November 2007 18:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Logged on more than one user detection</strong><br>Hi JoeAcunzo,<br><br>I try to figure out as well if other users are logged on to the system at install time.<br><br>Could you please post your solution how to detect if multiple users are logged on.<br><br>Thank you very much for your help.<br><br>M.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">mazdakam</span><br><span class="post-time small text-muted">22nd November 2007 15:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hello<br><br>I try to figure out as well if other users are logged on to the system at install time.<br><br>Could you please post your solution how to detect if multiple users are logged on.<br>i need it thanks</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">mazdakam</span><br><span class="post-time small text-muted">23rd November 2007 09:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">BUMP</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">mazdakam</span><br><span class="post-time small text-muted">26th November 2007 20:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Ok i try my best to fine solution and as my little knowledge in scripting i was not successes man in this case<br><br>i read whole of forum<br>and wiki and read me and hep file<br><br>as i don't want to create new topic with the same tile so decide to pop up this old topic the only one that discuss about detecting multiuser login in one system<br><br>what i need exactly?<br><br>i need a solution to detect if another user except current user are log in to the system or not and if it is force them to log off<br><br>i know all of you are busy but i will wait for your answer because i can;t down anything else i am newbie in everything :(<br><br>any help...<br>any little suggestion...<br>Thanks</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">26th November 2007 23:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I supplied the answer in my first reply.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">mazdakam</span><br><span class="post-time small text-muted">5th December 2007 21:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">please explain more how can i call WTSEnumerateSessions with system?<br><br>is there more simple way to detect if a user is log in or not? :(</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">5th December 2007 21:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><pre>
<code>!include LogicLib.nsh<br>#...<br>System::Call 'wtsapi32::WTSEnumerateSessions(i 0, i 0, i 1, *i .r0, *i .r1) i .r2'<br>${If} $2 != 0<br>        ${If} $1 != 1<br>                MessageBox MB_OK "more than one user logged in"<br>        ${EndIf}<br>        System::Call 'wtsapi32::WTSFreeMemory(i r0)'<br>${EndIf}</code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mazdakam</span><br>
      <span class="post-time small text-muted">5th December 2007 22:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">thank you very much<br>
      and worked for me<br>
      but how can i forced the other users log of after detecting other users are log in?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mazdakam</span><br>
      <span class="post-time small text-muted">5th December 2007 22:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">sorry i try it vut dowsent work correctly<br>
      in your cod wht is $2?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">6th December 2007 23:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">$2 is zero for me as it should always be.<br>
      <br>
      WTSLogoffSession can be used to logoff sessions.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mazdakam</span><br>
      <span class="post-time small text-muted">8th December 2007 16:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">you said:<br>
      WTSLogoffSession can be used to log off sessions.<br>
      <br>
      I used a shutdown plug in for force current user to log off<br>
      but if i understand right i can use WTSLogoffSession for forcing other user to log off. am i in true way?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">8th December 2007 16:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Yes.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mazdakam</span><br>
      <span class="post-time small text-muted">9th December 2007 10:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">i c. so which parameter do i need to work on it?<br>
      hServer<br>
      ppSessionInfo<br>
      pCount<br>
      <br>
      adn how tell this function to log off other user?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br>
      <span class="post-time small text-muted">9th December 2007 13:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><a href="http://msdn2.microsoft.com/en-us/library/aa383833.aspx" target="_blank">WTSEnumerateSessions</a> will give you an array of <a href="http://msdn2.microsoft.com/en-us/library/aa383864.aspx" target="_blank">WTS_SESSION_INFO</a> structures and each one contains a <i>SessionId</i> for a given active session. Use kichik's code for the WTSEnumerateSessions function but do not call the WTSFreeMemory function before you extract the info you need from the structures that reside in $0.<br>
      Then call the <a href="http://msdn2.microsoft.com/en-us/library/aa383836.aspx" target="_blank">WTSLogoffSession</a> with one of the extracted SessionIds in order to logoff that session ...<br>
      Hope this helps ...<br>
      CF</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>