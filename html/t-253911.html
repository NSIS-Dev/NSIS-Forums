<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Uninstall only installed files"><title>Uninstall only installed files - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Uninstall only installed files</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=253911">Uninstall only installed files</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">Baafen</span><br><span class="post-time small text-muted">23rd August 2006 12:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Uninstall only installed files</strong><br>Hello!<br>Im new to NSIS but i have made som installers.<br>But now im trying to make so only the installed files gets uninstalled. I found <a href="http://nsis.sourceforge.net/Uninstall_only_installed_files" target="_blank">this</a><br>But then my uninstallers uninstalls I stops then i trys to delete the folder. For example: then the uninstaller trys to uninstall INSTDIR\direxample the uninstallers stop and does nothing.<br>whats wrong with the code? If I skip to install that section that dosent work an other one makes it stop :(<br><br>Here is the code for one section that dont work:<br></p><blockquote>Section "FGDs" SEC02<br>${AddItem} "$INSTDIR\fgd"<br>${SetOutPath} "$INSTDIR\fgd\counter-strike"<br>${File} "C:\Documents and Settings\Jocke\Skrivbord\Baafens mapp\instaler\Mapping\instalfiler\FGD\fgd\counter-strike\" "cs_expert-tom793c.fgd"<br>${File} "C:\Documents and Settings\Jocke\Skrivbord\Baafens mapp\instaler\Mapping\instalfiler\FGD\fgd\counter-strike\" "halflife-cs_expert.fgd"<br>${SetOutPath} "$INSTDIR"<br>${File} "C:\Documents and Settings\Jocke\Skrivbord\Baafens mapp\instaler\Mapping\instalfiler\" "Readme Baafen VHETOOLS Pack.txt"<br>SectionEnd<hr></blockquote></div><hr>and this is how the uninstall sections looks like:<br>Quote:<table cellpadding="6" cellspacing="0" border="0" width="100%"><tr><td class="alt2"><hr>Section -closelogfile<br>FileClose $UninstLog<br>SetFileAttributes "$INSTDIR\${UninstLog}" READONLY|SYSTEM|HIDDEN<br>SectionEnd<br><br>Section Uninstall<br><br>; Can't uninstall if uninstall log is missing!<br>IfFileExists "$INSTDIR\${UninstLog}" +3<br>MessageBox MB_OK|MB_ICONSTOP "$(UninstLogMissing)"<br>Abort<br><br>Push $R0<br>Push $R1<br>Push $R2<br>SetFileAttributes "$INSTDIR\${UninstLog}" NORMAL<br>FileOpen $UninstLog "$INSTDIR\${UninstLog}" r<br>StrCpy $R1 0<br><br>GetLineCount:<br>ClearErrors<br>FileRead $UninstLog $R0<br>IntOp $R1 $R1 + 1<br>IfErrors 0 GetLineCount<br><br>LoopRead:<br>FileSeek $UninstLog 0 SET<br>StrCpy $R2 0<br>FindLine:<br>FileRead $UninstLog $R0<br>IntOp $R2 $R2 + 1<br>StrCmp $R1 $R2 0 FindLine<br><br>StrCpy $R0 $R0 -2<br>IfFileExists "$R0\*.*" 0 +3<br>RMDir $R0 #is dir<br>Goto +3<br>IfFileExists $R0 0 +2<br>Delete $R0 #is file<br><br>StrCmp $R1 0 LoopDone<br>IntOp $R1 $R1 - 1<br>Goto LoopRead<br>LoopDone:<br>FileClose $UninstLog<br>Delete "$INSTDIR\${UninstLog}"<br>Pop $R2<br>Pop $R1<br>Pop $R0<br><br>SectionEnd I have attached the script/code so you can take a look at the whole script and see if you can find anny wrong with it.<br><br>EDIT: Now I have another problem to. I have 4 things that can be installed with the installer. But I cant uninstall if the first of them is installed. Its says that it cant find the uninstal log. Again see the attached code.<br><br>EDIT Agian: Now I saw that then the uninstallers just stop The folder that it trys to remove is removed. Only 2 files is left and that is the uninstaller and the log that the uninstaller uses, How can I fix this?<br><br>// Sorry for my bad english I hope you understand</td></tr></table><br><div class="post"><p class="post-meta"><span class="post-author text-primary">Baafen</span><br><span class="post-time small text-muted">23rd August 2006 15:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Sorry for dubble post but I cant edit anymore..<br>Well I have only one thing left.<br>The uninstaller dosent delete the uninstall.log thats why my uninstaller freeze.<br><br>This part is that will delete the uninstall.log but i dont<br></p><blockquote>FileClose $UninstLog<br>Delete "$INSTDIR\${UninstLog}"<br>Pop $R2<br>Pop $R1<br>Pop $R0</blockquote></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Comperio</span><br><span class="post-time small text-muted">23rd August 2006 16:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">It's a bit odd, but here's a couple things you might look at:<br>1. $INSTDIR during uninstall is the directory in which the Uninstaller is located, which means that it's NOT necessarily what $INSTIDR was set to during the install. So it could be that you are not even in the right directory (or at least not in the directory you think you are.)<br><br>2. The uninstaller by default copies itself to the TEMP folder and runs from there, which would also mean that $INSTDIR could be pointed to your temp directory and not where you intended.<br><br>My recommendation would be that during install, you write $INSTDIR either to the registry or save it to a known file location. Then, during uninstall read the value back to you know exactly where to look.<br><br>You can also specify $INSTDIR during uninstall by using the _? switch. Refer to the section 3.2.2 of the help files for more info.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Baafen</span><br><span class="post-time small text-muted">23rd August 2006 16:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote>_?= sets $INSTDIR. It also stops the uninstaller from copying itself to the temporary directory and running from there. It can be used along with ExecWait to wait for the uninstaller to finish. It must be the last parameter used in the command line and must not contain any quotes, even if the path contains spaces.</blockquote>But the user who installs the files can choose were to install. So if I sett the $INSTDIR to C:Program/name and if the user installs the program at C:name. What will happen then?<br><br><blockquote>My recommendation would be that during install, you write $INSTDIR either to the registry or save it to a known file location. Then, during uninstall read the value back to you know exactly where to look.</blockquote>Like I said Im kind of new to NSIS so how can I make this<br>work?<br><br>I think I know what the problem is now. I think the prolem is that uninstall.log is still in use. Then I try to delete it my computer says that uninstall.log is in use.<br><br>So FileClose $UninstLog dosent do what i should do..<br>I hope someone can answear how to solve this.</div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>