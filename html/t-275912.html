<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="!tempfile problem on WIndows 2003 server"><title>!tempfile problem on WIndows 2003 server - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">!tempfile problem on WIndows 2003 server</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=275912">!tempfile problem on WIndows 2003 server</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">darthvader</span><br><span class="post-time small text-muted">14th August 2007 19:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>!tempfile problem on WIndows 2003 server</strong><br>I get a !tempfile: unable to create temporary file. error on a Windows 2003 machine. I checked all the environment variables and everything is fine. Does anyone know what else could cause the problem?<br><br>I executed a small program on the machine which throws this error and this passed too. This code is from NSIS script.cpp file.<br><br>char buf[MAX_PATH], buf2[MAX_PATH];<br><br>GetTempPath(MAX_PATH, buf);<br>if (!GetTempFileName(buf, "nst", 0, buf2))<br>{<br>ERROR_MSG("!tempfile: unable to create temporary file.\n");<br>return PS_ERROR;<br>}<br>buf and buf2 were populated correctly.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">14th August 2007 20:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Can you add a call to GetLastError() in the code and see what it says?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">darthvader</span><br><span class="post-time small text-muted">15th August 2007 03:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Sorry i did not explain it properly, the problem is i get this error only when i am compiling the script otherwise it works fine.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">darthvader</span><br><span class="post-time small text-muted">15th August 2007 17:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">This the last few lines before the compilation failed<br><br>!insertmacro: InstallLib<br>!tempfile: unable to create temporary file.<br>Error in macro __InstallLib_Helper_GetVersion on macroline 4 Error in macro InstallLib on macroline 86<br><br>When i execute the code as mentioned above it does not fail :(<br><br>Does anybody have any idea??</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">15th August 2007 21:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I was talking about NSIS's source code. I've added the call and uploaded the compiled makensis.exe to:<br><br><a href="http://stashbox.org/33659/makensis.zip" target="_blank">http://stashbox.org/33659/makensis.zip</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">darthvader</span><br><span class="post-time small text-muted">17th August 2007 02:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks for the file. I am getting a Error code 5 (Access is denied) for the return of GetLastError. I checked it up on net why this would happen but no luck.<br><br>Please help.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">darthvader</span><br><span class="post-time small text-muted">17th August 2007 06:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Ok i hacked into the source code and added few statements to figure out what exactly is going wrong<br><br>Here is the output of the analysis<br><br>!tempfile: unable to create temporary file.<br>GetLastError:5<br>Output Of GetTempPath: C:\WINDOWS\<br>Output of GetTempFileName: urrentVersion\SharedDLLs<br><br>I still cant figure out how can an MSDN function fail like this?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">17th August 2007 09:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">It would seem GetTempFileName doesn't not allow creating temporary files directly under C:\Windows. Start by verifying the TEMP and TMP environment variables and make sure they're not set to C:\Windows.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">darthvader</span><br><span class="post-time small text-muted">18th August 2007 03:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The problem is that the user is unable to create temp files in c:\windows. I am confused since the the variables<br><br>TMP=C:\Documents and Settings\User\LocalSettings\Temp<br>TEMP=C:\Documents and Settings\User\LocalSettings\Temp<br>USEPROFILE=C:\Documents and Settings\User<br><br>are set correctly. Do you know why would the query for these variables fail? According to MSDN only when query to all of these variables fail windows directory would returned :(<br><br>Could you please help me out.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">18th August 2007 09:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Maybe makensis somehow runs as a limited user with no access to those directories?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">18th August 2007 12:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Try running it with <a href="http://www.microsoft.com/technet/sysinternals/utilities/filemon.mspx" target="_blank">FileMon</a> and see what happens when it tries to create the temporary file in %TEMP%.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">darthvader</span><br><span class="post-time small text-muted">18th August 2007 15:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The problem is the installer build is an automated process run by another user(i dont have access to the account, Hence faing a lot of problems). Hence i am unable to use the Filemon on that machine. Is there an other way?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">darthvader</span><br><span class="post-time small text-muted">18th August 2007 16:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>makensis permisssion issue</strong><br>I think i have found the problem. The GetTempPath is trying to query the registry for the TMP,TEMP and USERPROFILE keys. Since the user does not have any permissions to do so, all the calls to it are failing.<br><br>Hence the only option left is to return the windows directory(according to MSDN), since this also fails due to permissions issue of the user. the whole thing fails miserably:(.<br><br>Does makensis require all the builds to be run under Administrator mode(it doesnt mention this anywhere(correct me if I am wrong))? Is it possible to change the code for tempfile, delfile and execute(other bunch of stuff which does require administrator rights) to reflect all these?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">18th August 2007 16:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">No, it doesn't require administrator privileges. It does, however, makes the reasonable assumption that it could create temporary files in the temporary directory. If this is an automated system, you can make it set the TEMP environment variable and point it to somewhere the user can write to.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">darthvader</span><br><span class="post-time small text-muted">18th August 2007 17:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">This is a guest account. Is it possible to set a TEMP variable for this account?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">18th August 2007 17:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Of course. Every user can have environmental variables.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">darthvader</span><br><span class="post-time small text-muted">18th August 2007 17:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I just have a feeling that GetTempPath queries the registry for the environment variables. Hence its failing for the guest account. Could you please comment on this?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">18th August 2007 17:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The guest user has its own registry hive which it can query. No user can function without a hive. I have a guest account on my computer and it works perfectly fine with its own temporary directory.</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>