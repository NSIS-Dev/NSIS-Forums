<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="ShellExecAsUser plugin" />

  <title>ShellExecAsUser plugin - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">ShellExecAsUser plugin</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=335435">ShellExecAsUser plugin</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">installer32</span><br />
      <span class="post-time small text-muted">30th September 2011 16:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>ShellExecAsUser plugin</strong><br />
      I've created a new ShellExecAsUser plugin:<br />
      <a href="http://nsis.sourceforge.net/ShellExecAsUser_plug-in" target="_blank">http://nsis.sourceforge.net/ShellExecAsUser_plug-in</a><br />
      It allows to execute the specified program in non-admin context, i.e. it is intended for installers that run with admin rights but need to execute something in non-admin context.<br />
      It uses desktop COM interface to execute process, so that process is launched by explorer (<a href="http://brandonlive.com/2008/04/27/getting-the-shell-to-run-an-application-for-you-part-2-how/" target="_blank">http://brandonlive.com/2008/04/27/ge...ou-part-2-how/</a>).<br />
      Any comments are welcome.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">1st October 2011 12:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Sound like something that can pretty useful :cool:<br />
      <br />
      Two questions:<br />
      * What operating systems does it work with? Any "fall back" mode for WinXP and Win2k?<br />
      * Can you please compile a Unicode version of that plug-in?<br />
      <br />
      (Sorry, did not have time to examine your code yet)<br />
      <br />
      Regards,<br />
      MuldeR.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">installer32</span><br />
      <span class="post-time small text-muted">1st October 2011 15:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        * What operating systems does it work with? Any "fall back" mode for WinXP and Win2k?
      </blockquote>It should work starting from Win2k. On WinXP, Win2k (or if UAC is disabled) the plugin will do the launch using ShellExecute.<br />
      <br />

      <blockquote>
        * Can you please compile a Unicode version of that plug-in?
      </blockquote>Ok I'll do.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">1st October 2011 15:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thank you!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">1st October 2011 17:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have adopted your ExecShellAsUser method into my StdUtils plug-in:<br />
      <a href="http://pastie.org/private/b9cymlmclyuo6b1f4kcmfg" target="_blank">http://pastie.org/private/b9cymlmclyuo6b1f4kcmfg</a><br />
      <br />
      (ANSI and Unicode builds attached)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">1st October 2011 18:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">So, what, does this do what the UAC plugin was also designed to do, but without two installer instances?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">1st October 2011 18:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by MSG</small><br />
        So, what, does this do what the UAC plugin was also designed to do, but without two installer instances?
      </blockquote>Yup. It generates a non-elevated process right from the elevated installer instance.<br />
      <br />
      Seems to work for me on Windows 7 (x64). I don't have any other UAC-enabled test platforms.<br />
      <br />
      On Windows XP and earlier it simply falls back to the normal ShellExecute()...
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">installer32</span><br />
      <span class="post-time small text-muted">1st October 2011 18:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        I have adopted your ExecShellAsUser method into my StdUtils plug-in:
      </blockquote>Ok but note that I used another thread for desktop COM calls. Otherwise I (sometimes) got RPC_E_CANTCALLOUT_ININPUTSYNCCALL error, which is solved if you do it on another thread.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">1st October 2011 18:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by installer32</small><br />
        Ok but note that I used another thread for desktop COM calls. Otherwise I (sometimes) got RPC_E_CANTCALLOUT_ININPUTSYNCCALL error, which is solved if you do it on another thread.
      </blockquote>Thanks for the hint!<br />
      <br />
      (I already noticed that CoInitializeEx() fails, because, I think, COM already is initialized with other parameters for the calling thread. So I switched back to CoInitialize() again. But I will implement your suggestion now)<br />
      <br />
      <b>[UPDATE]</b> Done. New version is attached. <b>[/UPDATE]</b>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">1st October 2011 20:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Very cool! I use the UAC plugin for double install mode all-through, for which case I guess it is more convenient to have two instances. But this is a very cool alternative, and a lot simpler to use!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">2nd October 2011 13:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Small update:<br />
      <a href="http://nsis.sourceforge.net/StdUtils_plug-in#ExecShellAsUser" target="_blank">http://nsis.sourceforge.net/StdUtils...xecShellAsUser</a></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">2nd October 2011 18:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Sorry, here are some more fixes:</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">2nd October 2011 20:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">This COM hack is problematic and/or broken when:<br />
      <br />
      <b>A)</b><br />
      Explorer is not running<br />
      <br />
      <b>B)</b><br />
      Explorer is elevated (Rare, but some people do it)<br />
      <br />
      <b>C)</b><br />
      Desktop user is not the correct parent:<br />
      User A is logged on,<br />
      runs setup as non-admin user B with runas.exe,<br />
      setup is elevated with user C;<br />
      The correct user is B, not A.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">2nd October 2011 21:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">In case (A) it will fall back to the normal ShellExecute(). Not ideal, but well...<br />
      <br />
      I'm not sure what will happen in case (B) or how to reproduce this, but I guess in that case we will either fail to get the COM interface and thus fall back to the normal ShellExecute(), or we will simply create an elevated instance.<br />
      <br />
      Again not ideal, but if you run your Explorer in an elevated way, then problems are preprogrammed anyway :rolleyes:<br />
      <br />
      (And in case (C) it may depend on the situation/purpose whether user <i>A</i> or <i>B</i> is the "correct" one)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">installer32</span><br />
      <span class="post-time small text-muted">2nd October 2011 21:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Anders<br />
      You are right and I'll add your remarks to plugin description, though I think it's quite uncommon and as such these limitations are acceptable to many people.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">9th October 2011 16:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have updated my <u>StdUtils plug-in</u> to use the "new" plug-in API, i.e. get rid of explicit unload.<br />
      <br />
      Furthermore I added a version of <font face="Lucida Console">ExecShell</font> with <i>wait</i> capability as well as some more convenience functions.<br />
      <br />
      New version here:<br />
      <a href="http://nsis.sourceforge.net/StdUtils_plug-in" target="_blank">http://nsis.sourceforge.net/StdUtils_plug-in</a><br />
      <br />
      (BTW: Could some mod please delete the obsolete versions attached to my previous posts?)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">21st October 2012 18:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">In case somebody is interested, I just uploaded a new version of my StdUtils plug-in:<br />
      <a href="http://nsis.sourceforge.net/StdUtils_plug-in" target="_blank">http://nsis.sourceforge.net/StdUtils_plug-in</a></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">23rd October 2012 01:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by LoRd_MuldeR</small><br />
        In case somebody is interested, I just uploaded a new version of my StdUtils plug-in:<br />
        <a href="http://nsis.sourceforge.net/StdUtils_plug-in" target="_blank">http://nsis.sourceforge.net/StdUtils_plug-in</a>
      </blockquote>I've just uploaded yet another update, which fixes a potential crash related to CoUninitialize() and certain certain Shell Extensions. In my case it was Tortoise GIT. Put simply, CoUninitialize() might still crash, even if all COM interfaces were released properly before. Happens if there are outstanding messages. It turns out we must dispatch all pending messages explicitly <i>before</i> calling CoUninitialize().<br />
      <br />
      As this might be relevant for <b>all</b> NSIS plug-in's that deal with COM interfaces (and the Shell), you might want to have a look here:<br />
      <a href="http://stackoverflow.com/questions/13018389/ishelldisptach-why-does-folderitemverbsrelease-couninitialize-crash" target="_blank">http://stackoverflow.com/questions/1...itialize-crash</a>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
