<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="More text replacement woes..."><title>More text replacement woes... - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">More text replacement woes...</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=195615">More text replacement woes...</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">moop</span><br><span class="post-time small text-muted">5th October 2004 02:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>More text replacement woes...</strong><br>I have read the docs. I have been searching these forums for hours. I still need help. I have installed and used the StrReplace and ReplaceInFile scripts from the Archive. I'm not a programmer by day, so bear with me, please. The closest solution to what I've found so far is <a href="http://forums.winamp.com/showthread.php?s=&amp;threadid=165838&amp;highlight=replace" target="_blank">HERE</a>.<br><br>Basically, I want to do two things. I'll wait before posting the second one because hopefully I can learn how to do it from the response I get to this one.<br><br>----my text file----<br>asdfasdf<br>CDPath=F:<br>asdfasdf<br>----eof-------------<br><br>Wherein F: can be anything, from blank, to a longer string.<br><br>I have seen how to replace a full line, but not unless I match the string exactly. How can I flush the junk after the equals sign and keep the rest intact? I have used the ReplaceInFile !insertmacro, but that only works if my string matches exactly, and although I can "cheat" by inserting a $\r$\n, that still just moves the "junk" after the equals sign to another line I would still need to delete.<br><br>I'm not a programmer by day, please forgive my noobishness... This isn't second nature to me yet, and I'm certain a NSIS whiz could do what I want in 5 minutes, which has taken me... longer than I care to admit.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">5th October 2004 18:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I think this calls for another text manipulation function by Afrow!<br><br>Please bare with me and I will have one written shortly.<br><br>-Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">5th October 2004 18:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Done:<br><a href="http://nsis.sourceforge.net/archive/nsisweb.php?page=626" target="_blank">http://nsis.sourceforge.net/archive/...b.php?page=626</a><br><br>You want to do this:<br></p><pre>
<code>Push "$INSTDIR\file.ext"<br>Push "CDPath="<br>Push "CDPath=new value"<br>Call ReplaceLineStr</code>
</pre><br>
      <br>
      -Stu
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">moop</span><br>
      <span class="post-time small text-muted">5th October 2004 20:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks a ton. I had gone to the IRC chatroom yesterday where Anders gave me some useful code, but most of it was greek. I still want to use it to learn though, but yours is immediately helpful. Thanks very much, Afrow! I hope I can help my community as much as you help NSIS. :cool:</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">razor_x</span><br>
      <span class="post-time small text-muted">6th October 2004 18:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">sweet afrow..can this be made into a macro too?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">6th October 2004 19:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">...<br>
      <br></p>
      <pre>
<code><br>!macro ReplaceLineStr File StartStr LineStr<br>Push "${File}"<br>Push "${StartStr}"<br>Push "${LineStr}"<br>Call ReplaceLineStr<br>!macroend<br><br>!insertmacro ReplaceLineStr "$INSTDIR\file.ext" "CDPath=" "CDPath=new value"</code>
</pre><br>
      <br>
      -Stu
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Kolya</span><br>
      <span class="post-time small text-muted">3rd March 2010 20:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Sorry for bumping such an old thread...<br>
      <br>
      This function has been very helpful but it misses one important feature for me: If the searched string isn't found, I'd like to write the replacement string to a new line, instead of just dropping it.<br>
      <br>
      I know how to add the new line at the bottom of the file, but I need help with writing that exception.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Kolya</span><br>
      <span class="post-time small text-muted">4th March 2010 23:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Some help please? Or am I missing something obvious?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Kolya</span><br>
      <span class="post-time small text-muted">5th March 2010 17:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Nevermind, I eventually used the script to delete any previously existing matching lines and then added my lines at the bottom.<br>
      <br>
      This worked for me because it doesn't matter where the new lines are.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Kolya</span><br>
      <span class="post-time small text-muted">24th March 2013 19:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Eventually I did need a solution that adds the new line to the bottom if it isn't found in the file. It also echoes in the details how many times which line was replaced in which file or if it was added to he bottom.<br>
      I'm sure this could be done more elegantly, but it was the first time I screwed with NSIS functions.<br>
      <br></p>
      <pre>
<code>Function ReplaceLineStr<br> Exch $R0 ; string to replace that whole line with<br> Exch<br> Exch $R1 ; string that line should start with<br> Exch<br> Exch 2<br> Exch $R2 ; file<br> Push $R3 ; file handle<br> Push $R4 ; temp file<br> Push $R5 ; temp file handle<br> Push $R6 ; global<br> Push $R7 ; input string length<br> Push $R8 ; line string length<br> Push $R9 ; global<br> <br> Var /GLOBAL T0 ; counter<br> StrCpy $T0 0           ; reset<br> <br>  StrLen $R7 $R1<br> <br>  GetTempFileName $R4<br> <br>  FileOpen $R5 $R4 w<br>  FileOpen $R3 $R2 r<br> <br>  ReadLoop:<br>  ClearErrors<br>                FileRead $R3 $R6<br>                        IfErrors Done<br>                <br>                StrLen $R8 $R6<br>                StrCpy $R9 $R6 $R7 -$R8<br>                StrCmp $R9 $R1 0 +4<br> <br>                FileWrite $R5 "$R0$\r$\n"<br>                IntOp $T0 $T0 + 1<br>                Goto ReadLoop<br>         <br>                FileWrite $R5 $R6<br>                Goto ReadLoop<br> <br>  Done:<br> <br>  FileClose $R3<br>  FileClose $R5<br>  <br>  SetDetailsPrint none<br>   Delete $R2<br>   Rename $R4 $R2<br>  SetDetailsPrint both<br>        <br>        ${If} $T0 != 0<br>                DetailPrint "$\"$R1$\" replaced $T0 times with $\"$R0$\" in $\"$R2$\"."<br>        ${Else}<br>                FileOpen $T0 $R2 a<br>                FileSeek $T0 0 END<br>                FileWrite $T0 $R0<br>                FileWriteByte $T0 "13"<br>                FileWriteByte $T0 "10"<br>                FileClose $T0<br>                DetailPrint "$\"$R0$\" not found in $\"$R2$\", added to bottom of file."<br>        ${EndIf}<br><br>        <br> Pop $R9<br> Pop $R8<br> Pop $R7<br> Pop $R6<br> Pop $R5<br> Pop $R4<br> Pop $R3<br> Pop $R2<br> Pop $R1<br> Pop $R0<br>FunctionEnd</code>
</pre>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>