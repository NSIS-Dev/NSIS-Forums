<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="uninstall does not remove $DATADIR (app data) from 64 bit windows systems" />

  <title>uninstall does not remove $DATADIR (app data) from 64 bit windows systems - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">uninstall does not remove $DATADIR (app data) from 64 bit windows systems</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=368666">uninstall does not remove $DATADIR (app data) from 64 bit windows systems</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">anderci</span><br />
      <span class="post-time small text-muted">11th August 2013 19:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>uninstall does not remove $DATADIR (app data) from 64 bit windows systems</strong><br />
      I think I did a poor job of asking my question in another thread.<br />
      ( NSIS Develop, Deploy 32 bit applications to 64 bit Windows? )<br />
      My NSIS script successfully installs my 32 bit apps on both 32 and 64 bit windows systems.<br />
      They can run successfully on both.<br />
      <br />
      The problem is the uninstall process leaves the application data behind.<br />
      <br />
      x64 requires two 'install directories', one for the app and one for any data created by the app (including its .ini file) In addition to the $INSTDIR variable, I defined another: $DATADIR<br />
      What am I missing?<br />
      Here are parts of the script that almost works:<br />
      <br />
      var DATADIR<br />
      :<br />
      :<br />
      Function .onVerifyInstDir<br />
      ${If} ${RunningX64}<br />
      ${Else}<br />
      StrCpy $DATADIR $INSTDIR<br />
      ${EndIf}<br />
      FunctionEnd<br />
      :<br />
      :<br />
      :<br />
      !define MUI_WELCOMEPAGE<br />
      !define MUI_LICENSEPAGE<br />
      !define MUI_DIRECTORYPAGE<br />
      <br />
      !define MUI_ABORTWARNING<br />
      !define MUI_UNINSTALLER<br />
      !define MUI_UNCONFIRMPAGE<br />
      !define MUI_FINISHPAGE<br />
      <br />
      Function .onInit<br />
      ${If} ${AtLeastWinVista}<br />
      ${If} ${RunningX64}<br />
      StrCpy $INSTDIR "$PROGRAMFILES32\Clark_Anderson\${MUI_FILE}"<br />
      StrCpy $DATADIR "C:\Users\Public\Clark_Anderson\${MUI_FILE}"<br />
      ${Else}<br />
      StrCpy $INSTDIR "C:\Users\Public\Clark_Anderson\${MUI_FILE}"<br />
      StrCpy $DATADIR "C:\Users\Public\Clark_Anderson\${MUI_FILE}"<br />
      ${EndIf}<br />
      ${Else}<br />
      StrCpy $INSTDIR "$PROGRAMFILES\Clark_Anderson\${MUI_FILE}"<br />
      StrCpy $DATADIR "$PROGRAMFILES\Clark_Anderson\${MUI_FILE}"<br />
      ${EndIf}<br />
      FunctionEnd<br />
      :<br />
      :<br />
      :<br />
      Section "Sample Data Files (Optional: Recommended for starting)"<br />
      SectionIn 2<br />
      SetOutPath "$DATADIR\DataBases"<br />
      :<br />
      :<br />
      SectionEnd<br />
      <br />
      Section "Uninstall"<br />
      :<br />
      :<br />
      :<br />
      :<br />
      ;Delete Files<br />
      Delete "$INSTDIR\*.*"<br />
      Delete "$DATADIR\Reports\Templates\*.*"<br />
      Delete "$DATADIR\Reports\*.*"<br />
      Delete "$DATADIR\DataBases\*.*"<br />
      Delete "$DATADIR\ExpImport\*.*"<br />
      Delete "$DATADIR\*.*"<br />
      <br />
      ;Remove the installation directory<br />
      RMDir /r "$INSTDIR"<br />
      RMDir /r "$DATADIR\Reports\Templates\*.*"<br />
      RMDir /r "$DATADIR\Reports\*.*"<br />
      RMDir /r "$DATADIR\DataBases\*.*"<br />
      RMDir /r "$DATADIR\ExpImport\*.*"<br />
      RMDir /r "$DATADIR"</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">12th August 2013 14:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Are you doing StrCpy $DATADIR "C:\Users\Public\Clark_Anderson\${MUI_FILE}" in the uninstaller?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">anderci</span><br />
      <span class="post-time small text-muted">12th August 2013 16:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thank you for responding.<br />
      No I am depending only on the definition in:<br />
      <br />
      Function .onInit<br />
      ${If} ${AtLeastWinVista}<br />
      ${If} ${RunningX64}<br />
      StrCpy $INSTDIR "$PROGRAMFILES32\Clark_Anderson\${MUI_FILE}"<br />
      StrCpy $DATADIR "C:\Users\Public\Clark_Anderson\${MUI_FILE}"<br />
      ${Else}<br />
      StrCpy $INSTDIR "C:\Users\Public\Clark_Anderson\${MUI_FILE}"<br />
      StrCpy $DATADIR "C:\Users\Public\Clark_Anderson\${MUI_FILE}"<br />
      ${EndIf}<br />
      ${Else}<br />
      StrCpy $INSTDIR "$PROGRAMFILES\Clark_Anderson\${MUI_FILE}"<br />
      StrCpy $DATADIR "$PROGRAMFILES\Clark_Anderson\${MUI_FILE}"<br />
      ${EndIf}<br />
      FunctionEnd<br />
      <br />
      followed by:<br />
      <br />
      Function .onVerifyInstDir<br />
      ${If} ${RunningX64}<br />
      ${Else}<br />
      StrCpy $DATADIR $INSTDIR<br />
      ${EndIf}<br />
      FunctionEnd</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">anderci</span><br />
      <span class="post-time small text-muted">12th August 2013 17:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have tried out modifying the<br />
      <br />
      Function .onInit<br />
      :<br />
      StrCpy $DATADIR "C:\Users\Public\Clark_Anderson\${MUI_FILE}"<br />
      to<br />
      StrCpy $DATADIR "$APPDATA\Clark_Anderson\${MUI_FILE}"<br />
      <br />
      but that seems to have sent the app data folders and files to:<br />
      C:\Users\Administrator\AppData\Roaming\Clark_Anderson\SurvyMgr<br />
      <br />
      I have not been able to 'see' those data folders and files after the install and cannot confirm if they were successfully uninstalled.<br />
      <br />
      <br />
      Also, I tried changing ShowUninstDetails "nevershow" to "show" or show<br />
      <br />
      The details went by so fast I could not hope to read them. Are there any ideas to allow me to examine uninstall details?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">12th August 2013 18:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You have to restore $datadir in the uninstaller, variables are not saved for you but like I already said, it does not make sense that this is a x64 only thing...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">anderci</span><br />
      <span class="post-time small text-muted">12th August 2013 18:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thank you,<br />
      <br />
      Is it that NSIS built-in variables are saved for uninstall, but developer created variables are not?<br />
      <br />
      Are Push and/or Pop commands of any use with this?<br />
      <br />
      For all 32 bit windows installations, I can and do define the $DATADIR == $INSTDIR<br />
      <br />
      For 64 bit windows installations, the $INSTDIR for 32 bit applications MUST be in the C:\Program Files (x86)\... folder structure. The data MUST be elsewhere.<br />
      A Microsoft help line representative recommended the C:\Users\Public\... folder structure.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">12th August 2013 19:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">No variables are saved.<br />
      <br />
      You can put readonly data in $programfiles, data written to by users should go somewhere else but that is true for all NT systems, also on 32bit Windows...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">anderci</span><br />
      <span class="post-time small text-muted">12th August 2013 20:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">By 'No variables are saved.' do you mean 'developer created variables' as differentiated from those like $INSTDIR</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">13th August 2013 01:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">$exedir/path and $instdir are set in the uninstaller before .oninit but $instdir is just the same as the folder the uninstaller is in unless it was started with a special parameter.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">anderci</span><br />
      <span class="post-time small text-muted">13th August 2013 01:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thank you.<br />
      <br />
      I was about to say 'I wish I understood this better', but maybe the uninstaller knows about $INSTDIR merely because it is local to the uninstaller program.<br />
      <br />
      A little bit discouraging. I guess, until a better idea comes, I will need to but the defining of $DATADIR in the uninstall section, also.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">anderci</span><br />
      <span class="post-time small text-muted">14th August 2013 15:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">An additional part of the solution from <a href="http://forums.winamp.com/showthread.php?t=220552" target="_blank">http://forums.winamp.com/showthread.php?t=220552</a><br />
      One of my applications uses only one subdirectory of the $DATADIR and required the:<br />
      SetOutPath "$TEMP" in the Section "Uninstall" as well as the separate:<br />
      <br />
      ${If} ${RunningX64}<br />
      StrCpy $DATADIR "C:\Users\Public\Clark_Anderson\${MUI_FILE}"<br />
      ${Else}<br />
      StrCpy $DATADIR $INSTDIR<br />
      ${EndIf}<br />
      definition.<br />
      <br />
      Now the uninstall works completely for 32 bit and 64 bit Windows!<br />
      Thank you.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">15th August 2013 17:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That looks like you're setting $DATADIR to a path which is only valid for your build machine. Why?<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">anderci</span><br />
      <span class="post-time small text-muted">15th August 2013 19:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Stu,<br />
      <br />
      If ${AtLeastWinVista}, Windows has established the C:\Users\Public\... folder structure. This structure is available to anyone on the PC.<br />
      <br />
      'Some real help came from lengthy phone conversations with very patient Microsoft<br />
      Windows 7 Customer Support agents. They were not programmers, but I learned<br />
      enough from them to figure the rest out.'<br />
      <br />
      Windows 7 x64 has a system variable/constant: PUBLIC=C:\Users\Public<br />
      I have not tested, but I think Vista and Win7 have the same definition for PUBLIC.<br />
      <br />
      I have not, yet, found a similar $PUBLIC defined in NSIS.<br />
      <br />
      For Pre-Vista Windows I put everything in the ProgramFiles=C:\Program Files\... folder structure or D:\Program Files\... folder structure or E:\Program Files\... folder structure<br />
      <br />
      I wrote a small VB6 function to identify which of the Windows variables (ProgramFiles(x86), PUBLIC, ProgramData) and set a variable (replacing App.Path) accordingly.<br />
      <br />
      Multiple instances of one of my freeware applications is sometimes used with a shared database located on the LAN.<br />
      <br />
      I hope this answers your question.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">16th August 2013 23:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">ReadEnvStr $DATADIR PUBLIC<br />
      <br />
      Never hard code such paths. Windows installed with other languages will not necessarily have that path.<br />
      <br />
      Edit: I have checked and the PUBLIC environment variable exists on Vista and above.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">anderci</span><br />
      <span class="post-time small text-muted">17th August 2013 00:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Stu,<br />
      Thank you. I use the PUBLIC Environment Variable in my VB program.<br />
      <br />
      In the NSIS script, I replaced<br />
      StrCpy $DATADIR "C:\Users\Public\Clark_Anderson\${MUI_FILE}"<br />
      with<br />
      ReadEnvStr $DATADIR PUBLIC\Clark_Anderson\${MUI_FILE}<br />
      I must be doing something wrong, because $DATADIR ended up blank.<br />
      Must I do it: ReadEnvStr $DATADIR PUBLIC"\Clark_Anderson\${MUI_FILE}"<br />
      or: ReadEnvStr $DATADIR PUBLIC<br />
      StrCpy $DATADIR $DATADIR"\Clark_Anderson\${MUI_FILE}"</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">17th August 2013 11:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">ReadEnvStr requires the environment variable name. If you have a path, use ExpandEnvStrings:<br />
      <br />
      ExpandEnvStrings $DATADIR `%PUBLIC%\Clark_Anderson\${MUI_FILE}`<br />
      <br />
      If in doubt, always check the manual.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">anderci</span><br />
      <span class="post-time small text-muted">17th August 2013 12:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Stu<br />
      <br />
      Thank you very much.<br />
      I found 4.9.2.7 ExpandEnvStrings</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
