<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="DB call from plugin inside a custom PRE function"><title>DB call from plugin inside a custom PRE function - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">DB call from plugin inside a custom PRE function</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=186725">DB call from plugin inside a custom PRE function</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">coho</span><br><span class="post-time small text-muted">15th July 2004 23:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>DB call from plugin inside a custom PRE function</strong><br>I have a custom page with a create and leave function. It is right before my MUI_PAGE_INSTFILES page.<br>In the create function, I make a call to my plugin dll.<br>The plugin creates a connection to a database with CDatabase::OpenEx() and executes some SQL.<br>Everything on the custom page works fine - callbacks, leave function is called, etc...<br>Then the INSTFILES page is shown, but everything is grayed out/frozen, I cannot even close the setup dialog without killing the process. The details button and listbox are not shown yet either.<br>I placed a messagebox into my -pre Section, but code never reaches this point.<br><br>It seems so strange that simply opening a connection to a db in my plugin causes this effect downstream. I removed every line in my plugin function except the opening and closing of the db - I have stepped over it, it runs fine with no exceptions thrown. If I remove the db.openex call, it runs fine. If I remove the line that calls this plugin in my nsi script, it installs fine.<br><br>Anybody seen anything like this?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">zimsms</span><br><span class="post-time small text-muted">16th July 2004 15:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You may need to use the adsize statement and declare enough memory for your plugin to run properly. What I believe is happening is that everything your plugin is doing is being placed in the installers stack, and therefore corrupting everything when it returns to the installer. By declaring a chunk of memory for your plugin to run in may resolve this issue.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">coho</span><br><span class="post-time small text-muted">16th July 2004 22:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">My plugin is huge, and I already make many calls to it without any trouble. I had narrowed the culprit down to a call to comctrl.dll from User32.dll. However, your tip led me to look in a different place. I was focusing on memory/stack usage, but the addsize statement deals with disk space.<br>I then ran across the FileBufSize statement, which was defaulted to 32 mb for the compiler. Being used for both input and output, it might reach a size of 64 mb... but<br>my Setup.exe was compiling to well over 40 mb.<br><br>I doubled my FileBufSize to be 64mb, and !BAM! it works.<br>Amazing.<br><br>Thanks for the lead,<br>-Coho</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">coho</span><br><span class="post-time small text-muted">17th July 2004 00:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">hahaha.... I hate it when I speak too soon. My C++ pugin and my script were out of synch, and this problem is not yet fixed.<br>I now believe it has something to do with the Windows Side by Side architechure (support for older versions of C++). SxS is Kinda like .NET's GAC, but for C++.<br><br>Anyways, NSIS loads this SxS version of comctl32.dll:<br><br>C:\WINDOWS\WinSxS\x86_Microsoft.Windows.Common-Controls_6595b64144ccf1df_6.0.2600.1515_x-ww_7bb98b8a\comctl32.dll<br><br>for use with its dialogs. When I make a call to CDatabase::OpenEx, this one is loaded:<br><br>c:\Windows\System32\comctl32.dll<br><br>and then unloaded. I believe these both cannot be loaded in memory at the same time - ? - and the SxS is possibly unloaded. Since my failure is a call from User32 to comctrl32, with a response of "Function not found", I believe the SxS is either unloaded, or User32.dll tries to look in the other comctrl32 for a function that no longer exists in memory.<br><br>I will try to load the SxS comctl32 library back after my db call, then I will try to reload User32 if that fails.<br><br>I'll write back with my findings.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">coho</span><br><span class="post-time small text-muted">17th July 2004 00:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Ok, now it really works. I scattered a bunch of GetModuleHandle calls in my plugin:<br><br>HMODULE hm;<br><br>hm = GetModuleHandle( _T("comctl32.dll") );<br><br>hm = GetModuleHandle( _T("C:\\WINDOWS\\WinSxS\\x86_Microsoft.Windows.Common-Controls_6595b64144ccf1df_6.0.2600.1515_x-ww_7bb98b8a\\comctl32.dll") );<br><br>hm = GetModuleHandle( _T("C:\\WINDOWS\\system32\\comctl32.dll") );<br><br>And found out that both comctl32s can be loaded at once.<br><br>Status before my CDatabase::OpenEx call.<br>Just DLL name: loaded, and gets the SxS one.<br>SxS specific: loaded, and gets same handle.<br>Windows32 path: not loaded.<br><br>After my Db call.<br>DLL name only: loaded (SxS).<br>SxS name: same handle.<br>Windows32 path: loaded with diff handle.<br><br>After my CDatabase object goes out of scope.<br>DLL Name: SxS still loaded<br>SxS Name: still loaded<br>Windows32 path: no longer loaded.<br><br>I thus thought User32.dll was calling into the unloaded comctl32.dll<br>But no, freeing and reloading user32 it did not help.<br><br>If I add the line...<br><br>hm = LoadLibrary( _T("C:\\WINDOWS\\system32\\comctl32.dll") );<br><br>...it is fixed. For reals this time. Apparently MUI_PAGE_INSTFILES needs this version of comctl32.dll loaded, and thinks it is still loaded after the db call - even though the db call loads then unloads it.<br>So the fix is to manually load it after my CDatabase object goes out of scope.<br><br>I think this is an NSIS bug - why does this page not load the dll it needs? It is not loaded to begin with... Does the reference count for this dll get set improperly?<br><br>-Coho</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">17th July 2004 08:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">NSIS does not load or unload any DLL for any page (besides the plug-in itself of course...). NSIS has imports from comctl32.dll and a manifest file that tells Windows to load comctl32.dll version 6, if available.<br><br>If getting unloaded by your DLL causes comctl32.dll version 5 to freezee NSIS, you can keep your DLL loaded with /NOUNLOAD the installation finishes.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">coho</span><br><span class="post-time small text-muted">19th July 2004 18:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I use /NOUNLOAD for all my dll calls, but this is not the issue. The destructor for my CDatabase object unloads the current windows version of comctl32.dll because the CDatabase object is the one that loads it. So the comctl32.dll gets unloaded even if my dll is still loaded.<br>-<br>Somehow, even though one version of comctl32.dll is loaded (the SxS one), when CDatabase loads and unloads the other comctl32.dll, NSIS breaks because it tries to call into the unloaded one. I'm not sure how NSIS keeps track of which dlls to use, but it seems to either become confused or it confuses Windows somehow.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">22nd July 2004 18:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">NSIS doesn't handle DLL loading. Windows loader does this according to the IAT of the PE.</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>