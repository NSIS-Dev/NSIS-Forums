<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Problems with InstDrv Plugin"><title>Problems with InstDrv Plugin - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Problems with InstDrv Plugin</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=287558">Problems with InstDrv Plugin</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">OrBiTaL</span><br><span class="post-time small text-muted">25th February 2008 14:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Problems with InstDrv Plugin</strong><br>Hello,<br><br>I've made an installer using InstDrv plugin, but I had some issues.<br><br>First, the driver I'm trying to install is a virtual device, a display mirror driver. I'm not the one who developed it, but I think it may have some bugs (I'll explain later in this post).<br><br>I've managed to make it install the driver (InitDriverSetup &gt; CreateDevice &gt; InstallDriver), but the function "CountDevices" don't find the installed device, the function "DeleteOemInfFiles" don't delete the INF files and the function "RemoveAllDevices" don't remove the installed devices.If I call "InstallDriver" with a previous driver installed, it updates the driver.<br><br>I don't know if this plugin has a bug, since I saw many people reporting problems with it, but the most problems were with the installation, and this is working here. But the problem might be in the driver. I tryed to edit the INF to find any possible bug, but I'm not familiar with driver development.<br><br>Here are the codes from INF and the part of my code that Install the driver:<br><br>PS: I made some comments with URLs in the INF to help me debug it.<br><br></p><pre>
<code><br>    # Initialization<br>    InstDrv::InitDriverSetup /NOUNLOAD "{4D36E968-E325-11CD-BFC1-08002BE10318}" "CxDD_Mirror_Display1"<br>    Pop $0<br>    DetailPrint "Driver Setup Initiated"<br>    <br>    # Check if there is any device already installed<br>    InstDrv::CountDevices /NOUNLOAD<br>    Pop $0<br>    DetailPrint "Devices Found: $0"<br>    StrCmp $0 "0" Continue Remove<br>    <br>  Remove:<br>    # Remove all instances of the Driver<br>    InstDrv::RemoveAllDevices /NOUNLOAD<br>    Pop $0<br>    StrCmp $0 "00000000" +4 +1<br>    <br>    DetailPrint "Old Devices: Could not remove [Code: $0]"<br>    MessageBox MB_OK "Error removing old devices"<br>    Goto Finish<br>    <br>    DetailPrint "Old Devices: Removed"<br><br>  Continue:<br>    # Delete previous Driver INF and PNF files (stored by Windows on INF folder)<br>    InstDrv::DeleteOemInfFiles /NOUNLOAD<br>    Pop $0<br>    StrCmp $0 "00000103" +4 +1<br>    <br>    DetailPrint "Old INF Files: Could not remove [Code: $0]"<br>    MessageBox MB_OK "Error removing old INF files"<br>    Goto Finish<br>    <br>    Pop $1<br>    Pop $2<br>    DetailPrint "Old INF Files: Removed ($1, $2)"<br>    <br>    # Create the device<br>    InstDrv::CreateDevice /NOUNLOAD<br>    Pop $0<br>    StrCmp $0 "00000000" +4 +1<br>    <br>    DetailPrint "New Device: Could not create [Code: $0]"<br>    MessageBox MB_OK "Error creating Device"<br>    Goto Finish<br>    <br>    DetailPrint "New Device: created"<br>    <br>    # Install the Driver and check if a reboot is needed<br>    DetailPrint "Installing driver from: $INSTDIR\Driver\CxDD.inf"<br>    InstDrv::InstallDriver /NOUNLOAD "$INSTDIR\Driver\CxDD.inf"<br>    Pop $0<br>    StrCmp $0 "00000000" +4 +1<br>    <br>    DetailPrint "New device driver: Not installed [Code: $0]"<br>    MessageBox MB_OK "Error installing driver"<br>    Goto Finish<br>  <br>    DetailPrint "New device driver: Installed"<br>    <br>    # Check if a reboot is needed<br>    Pop $0<br>    StrCmp $0 "0" Finish<br>    DetailPrint "Reboot Needed"<br>    SetRebootFlag true<br>  <br>  Finish:<br>    # Count how many Devices are present now<br>    InstDrv::CountDevices /NOUNLOAD<br>    Pop $0<br>    DetailPrint "Devices Found After Install: $0"<br></code>
</pre><br>
      <br>
      <br>
      <pre>
<code><br>; CxDD.inf<br>;<br>; Installation inf for the CxDD Mirror graphics adapter.<br>;<br>; Copyright (c) 2006 VAT Tecnologia da Informacao. All rights reserved<br>;<br>; <a href="http://msdn2.microsoft.com/en-us/library/ms790223.aspx" target="_blank">http://msdn2.microsoft.com/en-us/library/ms790223.aspx</a><br>;<br><br>[Version]<br>Signature="$CHICAGO$"<br>Provider=%Company%<br>Class=Display<br>ClassGUID={4D36E968-E325-11CE-BFC1-08002BE10318}<br>DriverVer=01/31/2006,1.0.0.2<br>;CatalogFile=CxDD.cat ; Used by WHQL Digital Signatures<br><br>[DestinationDirs]<br>; Section = DirID<br>DefaultDestDir = 11<br>cxdd.Display   = 11  ; system32<br>cxdd.Miniport  = 12  ; drivers<br><br>;<br>; Driver information<br>;<br><br>[Manufacturer]<br>; <a href="http://msdn2.microsoft.com/en-us/library/ms794359.aspx" target="_blank">http://msdn2.microsoft.com/en-us/library/ms794359.aspx</a><br>; Manufacturer = Models Section [,TargetOSVersion] [,TargetOSVersion] ...<br>; TargetOSVersion = NT[Architecture][.[OSMajorVersion][.[OSMinorVersion][.[ProductType][.SuiteMask]]]] (WinXP and Later)<br>%Company%   = CxDD.Mfg<br><br>[CxDD.Mfg]<br>; <a href="http://msdn2.microsoft.com/en-us/library/ms794357.aspx" target="_blank">http://msdn2.microsoft.com/en-us/library/ms794357.aspx</a><br>; device-description = install-section-name,hw-id[,compatible-id...]<br>%CxDD% = CxDD_Inst, CxDD_Mirror_Display1<br><br>;<br>; General installation section<br>;<br><br>[CxDD_Inst]<br>; <a href="http://msdn2.microsoft.com/en-us/library/ms794553.aspx" target="_blank">http://msdn2.microsoft.com/en-us/library/ms794553.aspx</a><br>CopyFiles = CxDD.Miniport, CxDD.Display<br><br>;<br>; File List sections<br>;<br><br>[CxDD.Miniport]<br>CxDD.sys<br><br>[CxDD.Display]<br>CxDD.dll<br><br>;<br>; Service Installation<br>;<br><br>[CxDD_Inst.Services]<br>; <a href="http://msdn2.microsoft.com/en-us/library/ms794347.aspx" target="_blank">http://msdn2.microsoft.com/en-us/library/ms794347.aspx</a><br>; <a href="http://msdn2.microsoft.com/en-us/library/ms794559.aspx" target="_blank">http://msdn2.microsoft.com/en-us/library/ms794559.aspx</a><br>; AddService = ServiceName,[flags],service-install-section[,event-log-install-section[,[EventLogType][,EventName]]]...<br>AddService = cxdd, 0x00000002, CxDD_Service_Inst, CxDD_EventLog_Inst<br><br><br>[CxDD_Service_Inst]<br>DisplayName    = %CxDD.SvcName%     ; Friendly Name<br>Description    = %CxDD.SvcDesc%     ; Longer description<br>ServiceType    = 1                  ; SERVICE_KERNEL_DRIVER<br>StartType      = 1                  ; SERVICE_SYSTEM_START<br>ErrorControl   = 0                  ; SERVICE_ERROR_IGNORE<br>LoadOrderGroup = Video<br>ServiceBinary  = %12%\CxDD.sys<br><br>[CxDD_EventLog_Inst]<br>AddReg = CxDD_EventLog_AddReg<br><br>[CxDD_EventLog_AddReg]<br>HKR,,EventMessageFile,0x00020000,"%SystemRoot%\System32\IoLogMsg.dll;%SystemRoot%\System32\drivers\CxDD.sys"<br>HKR,,TypesSupported,0x00010001,7<br><br>;<br>; Software Installation<br>;<br><br>[CxDD_Inst.SoftwareSettings]<br>; <a href="http://msdn2.microsoft.com/en-us/library/ms801089.aspx" target="_blank">http://msdn2.microsoft.com/en-us/library/ms801089.aspx</a><br>AddReg = CxDD_SoftwareDeviceSettings<br><br>[CxDD_SoftwareDeviceSettings]<br>HKR,, MirrorDriver,                %REG_DWORD%,    1<br>HKR,, InstalledDisplayDrivers,     %REG_MULTI_SZ%, cxdd<br>HKR,, VgaCompatible,               %REG_DWORD%,    0<br>HKR,, Attach.ToDesktop,            %REG_DWORD%,    1<br><br>[CxDD_Inst.OpenGLSoftwareSettings]<br>AddReg = CxDD_OpenGLSoftwareSettings<br><br>[CxDD_OpenGLSoftwareSettings]<br>; Not currently used:<br><br><br>[CxDD_Inst.GeneralConfigData]<br>MaximumNumberOfDevices    = 1<br>KeepExistingDriverEnabled = 1<br><br>;<br>; Source file information<br>;<br><br>[SourceDisksNames.x86]<br>1 = %DiskId%,,,""<br><br>[SourceDisksFiles]<br>cxdd.sys = 1<br>cxdd.dll = 1<br><br>[Strings]<br><br>;<br>; Non-Localizable Strings<br>;<br>REG_SZ         = 0x00000000<br>REG_MULTI_SZ   = 0x00010000<br>REG_EXPAND_SZ  = 0x00020000<br>REG_BINARY     = 0x00000001<br>REG_DWORD      = 0x00010001<br>SERVICEROOT    = "System\CurrentControlSet\Services"<br><br>;<br>; Localizable Strings<br>;<br>DiskId       = "CxDD Mirror Installation DISK (VIDEO)"<br>GraphAdap    = "Graphics Adapter"<br>CxDD         = "CxDD Mirror Driver"<br>Company      = "IPTV - VAT Tecnologia da Informacao"<br>CxDD.SvcName = "IPTV - Mirror Driver Service"<br>CxDD.SvcDesc = "Give Application Sharing access to capture screen"<br></code>
</pre>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>