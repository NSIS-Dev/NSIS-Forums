<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Patching/Merging text files"><title>Patching/Merging text files - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Patching/Merging text files</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=158582">Patching/Merging text files</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">IncidentR</span><br><span class="post-time small text-muted">5th December 2003 01:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Patching/Merging text files</strong><br>****************************************************************<br>I am attempting to create an installer script that will allow me<br>to distribute only patches rather than completely new files.<br><br>Within *NIX and *NIX-like OS's this can be accomplished fairly<br>easily with a unified diff file and the patch executable.<br><br>Within MS though, I am still searching. MS VisualStudio .NET<br>installer has this functionality, but I would prefer not to incur<br>the associated overhead of requiring all of the end-users to<br>install the .NET Framework at 23+Mb from Microsoft.<br><br>An alternative would be to be able to open a file "handle" for<br>append and read in a series of sub-files to create the updated<br>main file, then write the handle to the needed file name.<br><br>I have searched for various topics and questions, tried adapting<br>some of the scripts I found on the "Archive" page, etc. all with<br>no luck.<br><br>Can anyone offer some advice? Or point out any resources that I<br>might have overlooked?<br><br>Thanks,<br><br>- Ed</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Vytautas</span><br><span class="post-time small text-muted">5th December 2003 01:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Have you tried the vpatch plugin?<br><br>Vytautas</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">IncidentR</span><br><span class="post-time small text-muted">5th December 2003 20:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I found and tried that, but it fails to modify the file (creates<br>the temp file successfully, but then it skips the patch data<br>file and leaves the original file untouched).<br><br>I followed the readme pretty much to the letter - I also looked<br>within the .pat file and that was generated correctly (or at<br>least my changes were there).<br><br>Any ideas?<br><br>- Ed<br><br>Here is the fail output from the compiled installer:<br><br>Output folder: D:\DOCUME~1\allusers\LOCALS~1\Temp<br>Skipped tk_output.pat<br>Ok<br>Delete file: f:\XMLFiles\Output.xml<br>Rename: f:\XMLFiles\~output.tmp-&gt;f:\XMLFiles\Output.xml<br>Delete file: D:\DOCUME~1\allusers\LOCALS~1\Temp\~output.tmp<br><br>And here is the compile time thread from the HM NIS editor:<br><br>MakeNSIS v2.0b4 - Copyright 1999-2003 Nullsoft, Inc.<br><br>Portions Copyright (C) 1995-1998 Jean-loup Gailly and Mark Adler (zlib).<br>Includes portions derived from bzip2 (see documentation for details).<br>Contributors: <a href="mailto:nnop@newmail.ru">nnop@newmail.ru</a>, Ryan Geiss, Andras Varga, Drew Davidson, Peter Windridge, Dave Laundon, Robert Rainwater, Yaroslav Faybishenko, Jeff Doozan, Amir Szekely, Ximon Eighteen, et al.<br><br><br><br>Processing config:<br>!define: "MUI_INSERT_NSISCONF"=""<br>Changing directory to: "D:\Documents and Settings\allusers\My Documents\Install Scripts"<br><br>Processing plugin dlls: "E:\Program Files\NSIS\plugins\*.dll"<br>- advsplash::show<br>- Banner::destroy<br>- Banner::show<br>- BgImage::AddImage<br>- BgImage::AddText<br>- BgImage::Clear<br>- BgImage::Destroy<br>- BgImage::Redraw<br>- BgImage::SetBg<br>- BgImage::SetReturn<br>- BgImage::Sound<br>- Dialer::AttemptConnect<br>- Dialer::AutodialHangup<br>- Dialer::AutodialOnline<br>- Dialer::AutodialUnattended<br>- Dialer::GetConnectedState<br>- InstallOptions::dialog<br>- InstallOptions::initDialog<br>- InstallOptions::show<br>- LangDLL::LangDialog<br>- Math::Script<br>- nsExec::Exec<br>- nsExec::ExecToLog<br>- nsExec::ExecToStack<br>- nsisdl::download<br>- nsisdl::download_quiet<br>- splash::show<br>- StartMenu::Select<br>- System::Alloc<br>- System::Call<br>- System::Copy<br>- System::Free<br>- System::Get<br>- System::Int64Op<br>- System::Store<br>- UserInfo::GetAccountType<br>- UserInfo::GetName<br>- VPatch::vpatchfile<br><br><br>Processing script file: "D:\Documents and Settings\allusers\My Documents\Install Scripts\tking-output-anim01.nsi"<br>!define: "PRODUCT_NAME"="TKing's Output Animation"<br>!define: "PRODUCT_VERSION"="2.1.0"<br>!define: "PRODUCT_PUBLISHER"="TKing/Remelio"<br>!define: "PRODUCT_WEB_SITE"="http://home.comcast.net/~tomjking"<br>!define: "PRODUCT_DIR_REGKEY"="Software\Microsoft\Windows\CurrentVersion\App Paths\makensis.exe"<br>!define: "PRODUCT_UNINST_KEY"="Software\Microsoft\Windows\CurrentVersion\Uninstall\TKing's Output Animation"<br>!define: "PRODUCT_UNINST_ROOT_KEY"="HKLM"<br>!include: "MUI.nsh"<br>!include: "E:\Program Files\NSIS\Contrib\Modern UI\System.nsh"<br>NSIS Modern User Interface version 1.67 - Â© 2002-2003 Joost Verburg (E:\Program Files\NSIS\Contrib\Modern UI\System.nsh:11)<br>!include: closed: "E:\Program Files\NSIS\Contrib\Modern UI\System.nsh"<br>!include: closed: "E:\Program Files\NSIS\Include\MUI.nsh"<br>!include: "E:\Program Files\NSIS\Contrib\VPatch\patchlib.nsi"<br>!include: closed: "E:\Program Files\NSIS\Contrib\VPatch\patchlib.nsi"<br>!define: "MUI_ABORTWARNING"=""<br>!define: "MUI_ICON"="E:\Program Files\NSIS\Contrib\Graphics\Icons\modern-install.ico"<br>!define: "MUI_UNICON"="E:\Program Files\NSIS\Contrib\Graphics\Icons\modern-uninstall.ico"<br>!insertmacro: MUI_PAGE_WELCOME<br>!insertmacro: end of MUI_PAGE_WELCOME<br>!insertmacro: MUI_PAGE_DIRECTORY<br>!insertmacro: end of MUI_PAGE_DIRECTORY<br>!insertmacro: MUI_PAGE_INSTFILES<br>!insertmacro: end of MUI_PAGE_INSTFILES<br>!insertmacro: MUI_PAGE_FINISH<br>!insertmacro: end of MUI_PAGE_FINISH<br>!insertmacro: MUI_UNPAGE_INSTFILES<br>!insertmacro: end of MUI_UNPAGE_INSTFILES<br>!insertmacro: MUI_LANGUAGE<br>!insertmacro: end of MUI_LANGUAGE<br>Name: "TKing's Output Animation v2.1.0"<br>OutFile: "outputanim-setup.exe"<br>InstallDir: "F:\XMLFiles"<br>ShowInstDetails: show<br>ShowUnInstDetails: show<br>Section: "Master" -&gt;(SEC01)<br>SetOutPath: "$INSTDIR"<br>overwrite = 3, last_overwrite = 0<br>SetOverwrite: ifnewer<br>File: "makensis.exe" [compress] 197552/416256 bytes<br>File: "tk_output01.tga" [compress] 133400/262188 bytes<br>File: "tk_output03.tga" [compress] 148866/262188 bytes<br>File: "tk_output02.tga" [compress] 154501/262188 bytes<br>File: "tk_output04.tga" [compress] 97792/262188 bytes<br>CopyFiles: "$INSTDIR\Output.xml" -&gt; "$INSTDIR\Output.bak", size=0KB<br>!insertmacro: PatchFile<br>SetOutPath: "$TEMP"<br>File: "tk_output.pat" [compress] 639/16990 bytes<br>File: "VPatch.dll"-&gt;"$PLUGINSDIR\VPatch.dll" [compress] 2370/21086 bytes<br>Plugin Command: vpatchfile $TEMP\tk_output.pat $INSTDIR\Output.xml $INSTDIR\~output.tmp<br>Pop: $1<br>DetailPrint: "$1"<br>StrCpy $1 "$1" (2) ()<br>StrCmp "$1" "OK" equal=ok_$INSTDIR\Output.xml, nonequal=<br>SetErrors<br>IfFileExists: "$INSTDIR\~output.tmp" ? +1 : end_$INSTDIR\Output.xml<br>Delete: "$INSTDIR\Output.xml"<br>Rename: /REBOOTOK $INSTDIR\~output.tmp-&gt;$INSTDIR\Output.xml<br>Delete: "$TEMP\tk_output.pat"<br>!insertmacro: end of PatchFile<br>IfErrors ?in.onFailPatch:done<br>MessageBox: 64: "The VPatch failed miserably"<br>SectionEnd<br>Section: "-Post"<br>WriteUninstaller: "$INSTDIR\uninst.exe"<br>SectionEnd<br>Function: ".onVerifyInstDir"<br>IfFileExists: "$INSTDIR\Output.xml" ? PathGood :<br>CopyFiles: "$INSTDIR\..\default\Output.xml" -&gt; "$INSTDIR", size=0KB<br>FunctionEnd<br>Function: "un.onUninstSuccess"<br>HideWindow<br>MessageBox: 64: "$(^Name) was successfully removed from your computer."<br>FunctionEnd<br>Function: "un.onInit"<br>MessageBox: 292: "Are you sure you want to completely remove $(^Name) and all of its components?" (on IDYES goto +2)<br>Abort: ""<br>FunctionEnd<br>Section: "Uninstall"<br>Delete: "$INSTDIR\uninst.exe"<br>Delete: "$INSTDIR\tk_output04.tga"<br>Delete: "$INSTDIR\tk_output02.tga"<br>Delete: "$INSTDIR\tk_output03.tga"<br>Delete: "$INSTDIR\tk_output01.tga"<br>Delete: "$INSTDIR\Output.xml"<br>CopyFiles: "$INSTDIR\Output.bak" -&gt; "$INSTDIR\Output.xml", size=0KB<br>Delete: "$INSTDIR\makensis.exe"<br>SetAutoClose: false<br>SectionEnd<br><br>Processed 1 file, writing output:<br>Adding plug-ins initializing function... Done!<br>Processing pages... Done!<br>Removing unused resources... Done!<br>Generating language tables... Done!<br>Generating uninstaller... Done!<br><br>Output: "D:\Documents and Settings\allusers\My Documents\Install Scripts\outputanim-setup.exe"<br>Install: 5 pages (320 bytes), 2 sections (1 required) (48 bytes), 234 instructions (6552 bytes), 137 strings (2471 bytes), 1 language table (290 bytes).<br>Uninstall: 2 pages (128 bytes),<br>1 section (24 bytes), 50 instructions (1400 bytes), 67 strings (1046 bytes), 1 language table (214 bytes).<br>Datablock optimizer saved 7364 bytes (~0.9%).<br><br>Using zlib compression.<br><br>EXE header size: 47104 / 34816 bytes<br>Install code: 2668 / 10049 bytes<br>Install data: 744550 / 1556496 bytes<br>Uninstall code+data: 10641 / 14934 bytes<br>CRC (0x21BC080C): 4 / 4 bytes<br><br>Total size: 804967 / 1616299 bytes (49.8%)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">6th December 2003 13:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The skipped line is not coming from VPatch, it's coming from the installer. You've used SetOverwrite ifnewer and are extracting over an existing .pat file which is not older than the on you're trying to extract. You should extract it to $PLUGINSDIR which is assured to be empty of any files you don't need. This way you won't get any skip message.<br><br>The "Ok" line is the line that VPatch is outputting, which probably means the patching succeeded.</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>