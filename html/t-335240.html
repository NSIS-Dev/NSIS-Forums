<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Windows 7 registry startup problem." />

  <title>Windows 7 registry startup problem. - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Windows 7 registry startup problem.</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=335240">Windows 7 registry startup problem.</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">uixza</span><br />
      <span class="post-time small text-muted">25th September 2011 22:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Windows 7 registry startup problem.</strong><br />
      I am using NSIS and I use WriteRegStr to make my program startup when windows starts. It works fine on Win XP and in Win 7 as admin (haven't tested Vista), but in Win 7 with a normal user the registry key doesn't get added, I don't get any UAC windows or anything like that, the key just doesn't get added into the registry.<br />
      <br />
      I use this on the .nsi:<br />
      <br />
      WriteRegStr HKEY_CURRENT_USER "Software\Microsoft\Windows\CurrentVersion\Run" "ProgramName.exe" "$APPDATA\MyProgramFolder\ProgramName.exe"<br />
      <br />
      How can I make it work on Win 7 with a normal user?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">25th September 2011 22:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You don't need elevated rights for writing to the HKEY_CURRENT_USER branch, I think. But if you added "RequestExecutioLevel admin" to your installer (or did not use "RequestExecutioLevel" at all), then your installer will get elevated when it is started. For "restricted" (no-admin) user accounts this means that UAC will ask for Admin login credentials when the installer is run. The installer will then run under the Admin account. So in this situation HKEY_CURRENT_USER will probably refer to the Admin's registry key, instead of the registry key of the "restricted" user who originally ran the installer. You can't use HKEY_LOCAL_MACHINE to add your app to the Autostart for <i>all</i> users?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">uixza</span><br />
      <span class="post-time small text-muted">25th September 2011 23:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I use RequestExecutionLevel user, shouldn't I be able to write that reg key? (without UAC prompt)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">26th September 2011 00:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by uixza</small><br />
        I use RequestExecutionLevel user, shouldn't I be able to write that reg key? (without UAC prompt)
      </blockquote>If you explicitly use "RequestExecutionLevel user" your installer won't be elevated.<br />
      <br />
      You still should be able to write to the HKEY_CURRENT_USER branch (because that key doesn't require special permissions) and, as no elevation takes place, that key should refer to the account of the user who ran the installer.<br />
      <br />
      I think you should monitor the installer with <b><a href="http://technet.microsoft.com/en-us/sysinternals/bb896645" target="_blank">ProcessMonitor</a></b> and check whether the Registry access fails (and why).
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">26th September 2011 00:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The following code works for me:<br />
      <a href="http://pastie.org/private/8r3wdvbj9krxbwksoxaa" target="_blank">http://pastie.org/private/8r3wdvbj9krxbwksoxaa</a><br />
      <br />
      Tested with an Admin account and with a limited (guest) account, on Windows 7.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">29th September 2011 10:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You might find UAC is blocking writing to that registry key to prevent malware. On Windows 7, many keys are protected in the same way (changing the ACL has no effect). The only way to safely write to these keys is from a Windows service (SYSTEM account).<br />
      <br />
      How about putting a shortcut to your program in $SMSTARTUP instead. Your user will receive a UAC prompt when the application runs if UAC is enabled though.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
