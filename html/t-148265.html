<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Problem with InstallOptions &quot;WMCommandProc&quot;" />

  <title>Problem with InstallOptions "WMCommandProc" - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Problem with InstallOptions "WMCommandProc"</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=148265">Problem with InstallOptions "WMCommandProc"</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">rsegal</span><br />
      <span class="post-time small text-muted">5th September 2003 21:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Problem with InstallOptions "WMCommandProc"</strong><br />
      Possibly a problem with WMCommandProc function in the InstallOptions DLL. This is the current function. A possible crash exists as nIdx is not checked for a value &lt; 0 before it is used which would result in an invalid array index.<br />
      <br /></p>
      <pre>
<code>LRESULTWMCommandProc</code><span style="color: #007700">(</span><span style="color: #0000BB">HWNDhWnd</span><span style="color: #007700">,</span><span style="color: #0000BB">UINTid</span><span style="color: #007700">,</span><span style="color: #0000BB">HWNDhwndCtl</span><span style="color: #007700">,</span><span style="color: #0000BB">UINTcodeNotify</span><span style="color: #007700">){
<br />switch(</span><span style="color: #0000BB">codeNotify</span><span style="color: #007700">){
<br />case</span><span style="color: #0000BB">BN_CLICKED</span><span style="color: #007700">:
<br />{
<br /></span><span style="color: #0000BB">intnIdx</span><span style="color: #007700">=</span><span style="color: #0000BB">FindControlIdx</span><span style="color: #007700">(</span><span style="color: #0000BB">id</span><span style="color: #007700">);
<br /><br />if(</span><span style="color: #0000BB">pFields</span><span style="color: #007700">***91;</span><span style="color: #0000BB">nIdx</span><span style="color: #007700">***93;.</span><span style="color: #0000BB">nType</span><span style="color: #007700">==</span><span style="color: #0000BB">FIELD_BROWSEBUTTON</span><span style="color: #007700">){
<br /></span><span style="color: #0000BB">intnParentIdx</span><span style="color: #007700">=</span><span style="color: #0000BB">pFields</span><span style="color: #007700">***91;</span><span style="color: #0000BB">nIdx</span><span style="color: #007700">***93;.</span><span style="color: #0000BB">nParentIdx</span><span style="color: #007700">;
<br />switch(</span><span style="color: #0000BB">pFields</span><span style="color: #007700">***91;</span><span style="color: #0000BB">nParentIdx</span><span style="color: #007700">***93;.</span><span style="color: #0000BB">nType</span><span style="color: #007700">){
<br />case</span><span style="color: #0000BB">FIELD_FILEREQUEST</span><span style="color: #007700">:
<br /></span><span style="color: #0000BB">BrowseForFile</span><span style="color: #007700">(</span><span style="color: #0000BB">nParentIdx</span><span style="color: #007700">);
<br />break;
<br />case</span><span style="color: #0000BB">FIELD_DIRREQUEST</span><span style="color: #007700">:
<br /></span><span style="color: #0000BB">BrowseForFolder</span><span style="color: #007700">(</span><span style="color: #0000BB">nParentIdx</span><span style="color: #007700">);
<br />break;
<br />}
<br />break;
<br />}elseif(</span><span style="color: #0000BB">pFields</span><span style="color: #007700">***91;</span><span style="color: #0000BB">nIdx</span><span style="color: #007700">***93;.</span><span style="color: #0000BB">nType</span><span style="color: #007700">==</span><span style="color: #0000BB">FIELD_LINK</span><span style="color: #007700">){
<br /></span><span style="color: #0000BB">ShellExecute</span><span style="color: #007700">(</span><span style="color: #0000BB">hMainWindow</span><span style="color: #007700">,</span><span style="color: #0000BB">NULL</span><span style="color: #007700">,</span><span style="color: #0000BB">pFields</span><span style="color: #007700">***91;</span><span style="color: #0000BB">nIdx</span><span style="color: #007700">***93;.</span><span style="color: #0000BB">pszState</span><span style="color: #007700">,</span><span style="color: #0000BB">NULL</span><span style="color: #007700">,</span><span style="color: #0000BB">NULL</span><span style="color: #007700">,</span><span style="color: #0000BB">SW_SHOWDEFAULT</span><span style="color: #007700">);
<br />}
<br />}
<br />break;
<br />}
<br />return</span><span style="color: #0000BB">0</span><span style="color: #007700">;
<br />}
</span>
</pre>The modified version with the array bounds check,<br />
      <br />
      <pre>
<code>LRESULTWMCommandProc</code><span style="color: #007700">(</span><span style="color: #0000BB">HWNDhWnd</span><span style="color: #007700">,</span><span style="color: #0000BB">UINTid</span><span style="color: #007700">,</span><span style="color: #0000BB">HWNDhwndCtl</span><span style="color: #007700">,</span><span style="color: #0000BB">UINTcodeNotify</span><span style="color: #007700">){
<br />switch(</span><span style="color: #0000BB">codeNotify</span><span style="color: #007700">){
<br />case</span><span style="color: #0000BB">BN_CLICKED</span><span style="color: #007700">:
<br />{
<br /></span><span style="color: #0000BB">intnIdx</span><span style="color: #007700">=</span><span style="color: #0000BB">FindControlIdx</span><span style="color: #007700">(</span><span style="color: #0000BB">id</span><span style="color: #007700">);
<br /><br /></span><span style="color: #FF8000">//Ionlyaddedthenexttwolinesforsomeerror
<br />//checking
<br /></span><span style="color: #007700">if(</span><span style="color: #0000BB">nIdx</span><span style="color: #007700">&lt;</span><span style="color: #0000BB">0</span><span style="color: #007700">)
<br />break;
<br /><br />if(</span><span style="color: #0000BB">pFields</span><span style="color: #007700">***91;</span><span style="color: #0000BB">nIdx</span><span style="color: #007700">***93;.</span><span style="color: #0000BB">nType</span><span style="color: #007700">==</span><span style="color: #0000BB">FIELD_BROWSEBUTTON</span><span style="color: #007700">){
<br /></span><span style="color: #0000BB">intnParentIdx</span><span style="color: #007700">=</span><span style="color: #0000BB">pFields</span><span style="color: #007700">***91;</span><span style="color: #0000BB">nIdx</span><span style="color: #007700">***93;.</span><span style="color: #0000BB">nParentIdx</span><span style="color: #007700">;
<br />switch(</span><span style="color: #0000BB">pFields</span><span style="color: #007700">***91;</span><span style="color: #0000BB">nParentIdx</span><span style="color: #007700">***93;.</span><span style="color: #0000BB">nType</span><span style="color: #007700">){
<br />case</span><span style="color: #0000BB">FIELD_FILEREQUEST</span><span style="color: #007700">:
<br /></span><span style="color: #0000BB">BrowseForFile</span><span style="color: #007700">(</span><span style="color: #0000BB">nParentIdx</span><span style="color: #007700">);
<br />break;
<br />case</span><span style="color: #0000BB">FIELD_DIRREQUEST</span><span style="color: #007700">:
<br /></span><span style="color: #0000BB">BrowseForFolder</span><span style="color: #007700">(</span><span style="color: #0000BB">nParentIdx</span><span style="color: #007700">);
<br />break;
<br />}
<br />break;
<br />}elseif(</span><span style="color: #0000BB">pFields</span><span style="color: #007700">***91;</span><span style="color: #0000BB">nIdx</span><span style="color: #007700">***93;.</span><span style="color: #0000BB">nType</span><span style="color: #007700">==</span><span style="color: #0000BB">FIELD_LINK</span><span style="color: #007700">){
<br /></span><span style="color: #0000BB">ShellExecute</span><span style="color: #007700">(</span><span style="color: #0000BB">hMainWindow</span><span style="color: #007700">,</span><span style="color: #0000BB">NULL</span><span style="color: #007700">,</span><span style="color: #0000BB">pFields</span><span style="color: #007700">***91;</span><span style="color: #0000BB">nIdx</span><span style="color: #007700">***93;.</span><span style="color: #0000BB">pszState</span><span style="color: #007700">,</span><span style="color: #0000BB">NULL</span><span style="color: #007700">,</span><span style="color: #0000BB">NULL</span><span style="color: #007700">,</span><span style="color: #0000BB">SW_SHOWDEFAULT</span><span style="color: #007700">);
<br />}
<br />}
<br />break;
<br />}
<br />return</span><span style="color: #0000BB">0</span><span style="color: #007700">;
<br />}
</span>
</pre>End result, everything is super. I do wonder why I was getting an array index less than 0 but I was.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">7th September 2003 15:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks, I have uploaded a version that checks the return value of FindControlIdx. I'm still waiting for Ramon to look over it to see where the problem really comes from.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ramon18</span><br />
      <span class="post-time small text-muted">8th September 2003 10:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi rsegal,<br />
      <br />
      Can you upload the ini file that cause this problems? thanks.<br />
      The reason why I don't check the return value from FindControlIdx is to save some code bytes, so the problem should be elsewhere, just because FindControlIdx should always find the right control when receiving messages through WMCommandProc, but, hummm, I must admit parent WM_COMMAND messages are forward now to child windows if not handled by main window (ie: Back, Next, Cancel buttons), maybe the problem arise here!<br />
      <br />
      Perhaps, your fix is really needed there. But I want to inspect with the ini that cause the problems<br />
      <br />
      Ramon,<br />
      cyas</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
