<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Need help with callbacks"><title>Need help with callbacks - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Need help with callbacks</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=292028">Need help with callbacks</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">xplct0</span><br><span class="post-time small text-muted">20th May 2008 01:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Need help with callbacks</strong><br>I'm trying to make use of CopyFileEx. Here's the MSDN ref: <a href="http://msdn.microsoft.com/en-us/library/aa363852.aspx" target="_blank">http://msdn.microsoft.com/en-us/library/aa363852.aspx</a><br><br>I can't figure out why none of my callback's params are being properly filled out. I'm also not sure if I'm setting this up correctly in the first place -- I'm slightly confused by the documentation. The only parameter that seems to get filled out with anything cogent is: dwStreamNumber, which is set to 1, and according to MSDN, it's "A handle to the current stream. The first time CopyProgressRoutine is called, the stream number is 1." Great. But every thing else seems to be NULL, even though the file does get copied over properly. (the file is &gt; 0 bytes) If anyone can help that'd be great. Thanks!<br><br>Code<br><br>#(0) __in LARGE_INTEGER TotalFileSize,<br>#(1) __in LARGE_INTEGER TotalBytesTransferred,<br>#(2) __in LARGE_INTEGER StreamSize,<br>#(3) __in LARGE_INTEGER StreamBytesTransferred,<br>#(4) __in DWORD dwStreamNumber,<br>#(5) __in DWORD dwCallbackReason,<br>#(6) __in HANDLE hSourceFile,<br>#(7) __in HANDLE hDestinationFile,<br>#(8) __in_opt LPVOID lpData<br>System::Get "(i .r0, i .r1, i .r2, i .r3, i .r4, i .r5, i .r6, i .r7, i .r8) isR0"<br>System::Call 'kernel32::CopyFileEx(t "C:/from/test.txt", t "c:/to/test.txt", k r0, i 0, i 0, i 1) i .r3'<br><br>loop:<br>StrCmp $R0 "callback1" 0 done<br>Goto loop<br>done:<br><br>MessageBox MB_OK $0<br>MessageBox MB_OK $1<br>MessageBox MB_OK $2<br>MessageBox MB_OK $3<br>MessageBox MB_OK $4<br>MessageBox MB_OK $5<br>MessageBox MB_OK $6<br>MessageBox MB_OK $7<br>MessageBox MB_OK $8</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">20th May 2008 02:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">your stuff is all messed up, you need to use L for 64 bit numbers etc...<br><br>this seems to work tho:<br></p><pre>
<code><br>SetPluginUnload alwaysoff<br>System::Get "(l.R0,l,l.R1,l,i.R2,i.R3,i,i,i)isr1"<br>pop $0<br>System::Call 'kernel32::CopyFileEx(t "$temp\Temp.exe", t "$temp\dest.txt",k r0,i,i,i)i.r9'<br>loop:<br>        StrCmp $1 "callback1" 0 done<br>        DetailPrint "cb: totsize=$R0|strmsize=$R1|strmid=$R2|cbreason=$R3"<br>        Push 0 # return value of the callback<br>        StrCpy $1 "" # clear $R0 in case there are no more callback calls<br>        System::Call $0 # tell system to return from the callback<br>        Goto loop<br>done:<br>SetPluginUnload manual<br>DetailPrint CopyFileEx($0)ret=$9<br>System::Free $0<br></code>
</pre><br>
      <br>
      nsis already supports file copy, not sure why you are doing this
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">xplct0</span><br>
      <span class="post-time small text-muted">20th May 2008 04:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">AGGGHHH FINALLY! I got it working!! Thanks for the cb help, Anders.<br>
      <br>
      So everyone kept saying it wasn't possible to display billboards based on %copy complete, which is just silly if you have access to the win32. I know this is sloppy, but I just got it working:<br>
      <br></p>
      <pre>
<code><br>!include 'MUI.nsh'<br>!include 'Image.nsh'<br><br>!define AppName `Sand`<br>Name '${AppName}'<br>OutFile 'Sandbox.exe'<br>InstallDir '$PROGRAMFILES\${AppName}'<br><br>!insertmacro MUI_PAGE_WELCOME<br>!insertmacro MUI_PAGE_DIRECTORY<br>!insertmacro MUI_PAGE_INSTFILES<br>!insertmacro MUI_PAGE_FINISH<br>!insertmacro MUI_LANGUAGE "English"<br><br>#Dumpstate::debug<br># Fix the rukus vista has been causing with shortcut removals.<br>RequestExecutionLevel admin<br><br>Section 'CD_ONE'<br>    <br>    strcpy $9 'ladeda'<br>    SetPluginUnload alwaysoff<br>    System::Get "(l,l.R1,l,l,i,i,i,i,i)isr1"<br>    pop $0<br>    System::Call 'kernel32::CopyFileEx(t "c:\from\test.txt", t "c:\to\test.txt",k r0,i,i,i)i.r9'<br>    <br>    loop:<br>        StrCmp $1 "callback1" 0 done<br>    <br>        IntCmp $R1 40000000 0 lessthan40mb morethan40mb<br>        lessthan40mb:<br>          strcmp $9 '0' doneCmp +1<br>          !insertmacro DisplayImage 'c:\Bilboard0.bmp'<br>          strcpy $9 '0'<br>          Goto doneCmp<br>          <br>        morethan40mb:<br>          strcmp $9 '1' doneCmp +1<br>          !insertmacro DisplayImage 'c:\Bilboard1.bmp'<br>          strcpy $9 '1'<br>          Goto doneCmp<br>        doneCmp:<br>        <br>        Push 0 # return value of the callback<br>        StrCpy $1 "" # clear $R0 in case there are no more callback calls<br>        System::Call $0 # tell system to return from the callback<br>        <br>        Goto loop<br>    done:<br>    SetPluginUnload manual<br>    System::Free $0<br> <br>SectionEnd<br></code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">20th May 2008 11:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That could be tidied up quite nicely using some LogicLib.<br>
      <br>
      Stu</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>