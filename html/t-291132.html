<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Newbie Help With Updater Code"><title>Newbie Help With Updater Code - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Newbie Help With Updater Code</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=291132">Newbie Help With Updater Code</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">grendell2099</span><br><span class="post-time small text-muted">1st May 2008 17:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Newbie Help With Updater Code</strong><br>Hi all, I am working on my first NSIS updater project and need some help. I am trying to create an updater that compares an ini file on our internal web site (â€œupdateâ€) with a shared user local ini file (â€œinstallâ€). If the update version is higher than the install, it will download the specified file to the userâ€™s folder &amp; edit the version number in the install ini. After checking for/ downloading the updates, it will open the â€œapplicationâ€.<br>So, I found a great example here that would loop through each line in an ini file and return the section, key, and value and then tried to add my code:<br>First, I wanted to be able to prevent users from opening the â€œappâ€ in case I needed to do some maintenance on the system. So the updater should look at the â€œlockoutâ€ key first and either exit or continue on. This seems to work fine.<br>Next I wanted it to search for users computer name in the update file (the â€œappâ€ has several files housed on a share drive and one file that sits on the users C drive) and update that if necessary. This also seems to work fine.<br>After that, it should loop through all of the entries in the [Files] section, compare to the install ini, and update if necessary. This is where I am stuck.<br>I have tested the individual pieces and they seem to work, but I am clearly missing something when it comes to stitching it all together. It fails at the â€œReadINIFileKeysâ€ section. I do not think I am handling/passing my variables correctly- but I cannot figure it out. Below is the code- I would greatly appreciate any input.<br><br>THE CODE:<br>OutFile "LOOP_TEST.exe"<br>SilentInstall silent<br><br>Var Ufile ;update ini file on sharepoint ($R0)<br>Var Ifile ;install ini file installed on F drive ($R1)<br>Var Usection ;section header of update ini file ($Usection)<br>Var Ukey ;key of update ini file ($R4)<br>Var Uval ;key value of update ini file ($R5)<br>Var LockOutSetting<br>Var LockoutMsg ;lockout message from update ini file<br>Var UserName ;user computer name<br>Var Uversion ;front end version in update ini<br>Var Iversion ;front end version in install ini<br>Var UPath ;path to update file location on sharepoint<br>Var DPath ;path to download the update file to<br>Var MyFileName ;name of file to download<br><br>Function .onInit<br>#-------Start New Code Added By Me-------------<br>#get computer name<br>ReadRegStr $UserName HKLM "System\CurrentControlSet\Control\ComputerName\ActiveComputerName" "ComputerName"<br>#MessageBox MB_OK "$UserName"<br>StrCpy $Ufile "R:\SANDBOX\NSIS\METACupdate.ini"<br>StrCpy $Ifile "R:\SANDBOX\NSIS\METACinstall.ini"<br>;check to see if system is locked out<br>ReadINIStr $LockOutSetting $Ufile "Settings" "LockOut"<br>StrCmp $LockOutSetting "yes" LockedOut NotLockedOut<br>LockedOut:<br>ReadINIStr $LockOutMsg $Ufile "Settings" "LockOutMsg"<br>MessageBox MB_OK "$LockOutMsg"<br>abort<br>NotLockedOut:<br>MessageBox MB_OK "Not Locked Out"<br>;check the computers version number- if computer name isn't found, close<br>ReadINIStr $Uversion $Ufile "Files" $UserName<br>StrCmp $Uversion "" "" FoundIt<br>MessageBox MB_OK "Could not identify computer- application will close"<br>abort<br>FoundIt: ;compare the version numbers<br>MessageBox MB_OK "Found Uversion"<br>ReadINIStr $Iversion $Ifile "Files" $UserName<br>StrCmp $Uversion $Iversion NoUpdate GetUpdate<br>GetUpdate:<br>StrCpy $Ukey $UserName<br>StrCpy $MyFileName "mylicense.txt"<br>call DownloadUpdate<br>WriteINIStr $Ifile "Files" $UserName $Uversion<br>;abort<br>NoUpdate:<br><br>MessageBox MB_OK "Before ReadINIFileKeys loop: Usection= $Usection : Ukey= $Ukey : Uval= $Uval"<br>#----End New Code Added by Me---------------------<br>Call ReadINIFileKeys<br><br>FunctionEnd<br>Function StrTrimNewlines<br>Exch $Ufile<br>Push $Ifile<br>Push $R2<br>StrCpy $Ifile 0<br><br>loop:<br>IntOp $Ifile $Ifile - 1<br>StrCpy $R2 $Ufile 1 $Ifile<br>StrCmp $R2 "$\r" loop<br>StrCmp $R2 "$\n" loop<br><br>IntOp $Ifile $Ifile + 1<br>IntCmp $Ifile 0 no_trim_needed<br>StrCpy $Ufile $Ufile $Ifile<br><br>no_trim_needed:<br>Pop $R2<br>Pop $Ifile<br>Exch $Ufile<br>FunctionEnd<br><br>Function SplitFirstStrPart<br>Exch $Ufile<br>Push $Ifile<br>Push $R2<br>StrLen $Ifile $Ufile<br>IntOp $Ifile $Ifile + 1<br>loop:<br>IntOp $Ifile $Ifile - 1<br>StrCpy $R2 $Ufile 1 -$Ifile<br>StrCmp $Ifile 0 exit0<br>StrCmp $R2 "=" exit1 loop ; Change " " to "\" if str=dirpath<br>exit0:<br>StrCpy $Ifile ""<br>Goto exit2<br>exit1:<br>IntOp $Ifile $Ifile - 1<br>StrCpy $R2 $Ufile "" -$Ifile<br>IntOp $Ifile $Ifile + 1<br>StrCpy $Ufile $Ufile -$Ifile<br>StrCpy $Ifile $R2<br>exit2:<br>Pop $R2<br>Exch $Ifile ;rest<br>Exch<br>Exch $Ufile ;first<br>FunctionEnd<br>Function ReadINIFileKeys<br>Exch $Ifile ;INI file to write<br>Exch<br>Exch $Ufile ;INI file to read<br>Push $R2<br>Push $R3<br>Push $Ukey ;uni var<br>Push $Uval ;uni var<br>Push $Usection ;last INI section<br><br>FileOpen $R2 $Ufile r<br><br>Loop:<br>FileRead $R2 $R3 ;get next line into R3<br>IfErrors Exit<br><br>Push $R3<br>Call StrTrimNewLines<br>#Call TrimNewLines<br>Pop $R3<br><br>StrCmp $R3 "" Loop ;if blank line, skip<br><br>StrCpy $Ukey $R3 1 ;get first char into R4<br>StrCmp $Ukey ";" Loop ;check it for semicolon and skip line if so(ini comment)<br><br>StrCpy $Ukey $R3 "" -1 ;get last char of line into R4<br>StrCmp $Ukey "]" 0 +6 ;if last char is ], parse section name, else jump to parse key/value<br>StrCpy $Usection $R3 -1 ;get all except last char<br>StrLen $Ukey $Usection ;get str length<br>IntOp $Ukey $Ukey - 1 ;subtract one from length<br>StrCpy $Usection $Usection "" -$Ukey ;copy all but first char to trim leading [, placing the section name in R6<br>Goto Loop<br><br>Push "=" ;push delimiting char<br>Push $R3<br>Call SplitFirstStrPart<br>Pop $Ukey<br>Pop $Uval<br><br>#---------------Start New Code Added By Me-----------<br>MessageBox MB_OK "Usection= $Usection : Ukey= $Ukey : Uval= $Uval"<br><br>StrCmp $Usection "Settings" NoUpdateA NotSettings ;already checked the settings section, so skip here<br>NotSettings:<br>MessageBox MB_OK "NotSettings"<br>StrCmp $Usection "FilePaths" exit NotFilePaths ;stop when loop gets to the filepaths section<br>NotFilePaths:<br>MessageBox MB_OK "NotFilePaths"<br>MessageBox MB_OK "Updateversion= $Uval"<br>;get the install file version number for Ukey<br>ReadINIStr $Iversion $Ifile $Usection $Ukey<br>MessageBox MB_OK "Ifile= $Ifile: Usection= $Usection: Ukey= $Ukey: Iversion= $Iversion"<br>;compare the install version number to the update version number<br>StrCmp $Uversion $Iversion NoUpdateA GetUpdateA<br>GetUpdateA:<br>StrCpy $MyFileName $Ukey<br>Call DownloadUpdate<br>NoUpdateA:<br><br>#---------------End New Code Added By Me-----------------<br>Goto Loop<br>Exit:<br>FileClose $R2<br>Pop $Usection<br>Pop $Uval<br>Pop $Ukey<br>Pop $R3<br>Pop $R2<br>Pop $Ufile<br>Pop $Ifile<br><br>#launch the front end<br>execshell "" "R:\SANDBOX\NSIS\MAIN_APP.txt"<br>Quit<br>FunctionEnd<br><br>Function DownloadUpdate ;NEW FUNCTION ADDED BY ME<br>StrCpy $UPath "http://sharepoint/cross-functional/H2QCE/interior/Site%20Appearance/Forms/AllItems.aspx?RootFolder=%2fcross%2dfunctional%2fH2QCE%2finterior%2fSite%20Appearance%2fMETAC&amp;View=%7bFB5ABE34%2d4B2C%2d475C%2d80A2%2dFC460C24D942%7d/" ;DOWNLOAD_TEST_FILE.TXT" "$5\DOWNLOAD_TEST_FILE.TXT"<br>ReadINIStr $Dpath $Ufile "Filepaths" $Ukey<br>MessageBox MB_OK "download from: $Upath$MyFileName"<br>MessageBox MB_OK "download to: $Dpath$MyFileName"<br>#InetLoad::load /POPUP "Front End Software Update" "http://sharepoint/cross-functional/H2QCE/interior/Site%20Appearance/Forms/AllItems.aspx?RootFolder=%2fcross%2dfunctional%2fH2QCE%2finterior%2fSite%20Appearance%2fMETAC&amp;View=%7bFB5ABE34%2d4B2C%2d475C%2d80A2%2dFC460C24D942%7d/DOWNLOAD_TEST_FILE.TXT" "$5\DOWNLOAD_TEST_FILE.TXT"<br>InetLoad::load /POPUP "Front End Software Update" "$Upath$MyFileName" "$Dpath$MyFileName"<br>Pop $9 # return value = exit code, "OK" if OK<br>MessageBox MB_OK "Download Status: $9"<br>FunctionEnd<br><br># default section start; every NSIS script has at least one section.<br>section "dummy"<br><br># default section end<br>sectionEnd<br>AutoCloseWindow true</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>