<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="NSIS 3.0a1"><title>NSIS 3.0a1 - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content=" NSIS 3.0a1"><title>NSIS 3.0a1 - NSIS Forums</title><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">NSIS 3.0a1</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=366503">NSIS 3.0a1</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">16th July 2013 13:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>NSIS 3.0a1</strong><br><a href="http://nsis.sourceforge.net/Download" target="_blank">This release</a> fixes some of the issues reported in the first alpha and also added manifest support for the Win8.1 Preview GUID.<br><br>If you find any new issues, report them in this thread or on the SF bug tracker and please include compiler error messages and sample code if possible...<br><br>(New) Known issues:</p><ul><li>NSIS Menu caption displays the name of the HTML file (Fixed in SVN)</li><li>Crash on startup when compiled with certain versions of MSVC (Fixed in SVN)</li><li>RTF license open URL broken (Fixed in SVN)</li><li>Unicode !define \0 terminator bug (Fixed in SVN)</li></ul></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Pawel</span><br><span class="post-time small text-muted">16th July 2013 18:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hey Anders,<br>I decided to try to compile NSIS 3.0 sources. I have some problems with this. I hope you can help me with this.<br><br>I am doing this on Win7 SP1 x64, Visual Studio 2008 Express Edition (Python 2.6, wxWidgets 2.8.10). On this platform I was successfully compiling NSIS 2.46.<br><br>1. I started to build NSIS menu. Compilation is OK.<br>2. I started to build NSIS (using cmd via Visual Studio Command Prompt). Here is a log:<br><br><i>C:\NS&gt;scons<br>scons: Reading SConscript files ...<br>Mkdir("build\urelease\config")<br>Delete("nsis-16-Jul-2013.cvs")<br>Delete(".instdist")<br>Delete(".test")<br>Using Microsoft tools configuration<br>Checking for memset requirement... yes<br>Checking for C library gdi32... yes<br>Checking for C library user32... yes<br>Checking for C library pthread... no<br>Checking for C library iconv... no<br>Checking for C library shlwapi... yes<br>Checking for C library version... yes<br>Please specify folder of zlib for Win32 via ZLIB_W32</i><br><br>As you can see, there is a problem with ZLIB library (there was no such problem on previous 2.64 edition)... What should I do? Should I install zlib and add it to System PATH? Or what?<br>-Pawel</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">16th July 2013 20:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><a href="http://nsis.sourceforge.net/Zlib" target="_blank">http://nsis.sourceforge.net/Zlib</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Pawel</span><br><span class="post-time small text-muted">16th July 2013 20:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks, I was checking with zlib file downloaded from official zlib website... Copied to system32... but it was not working... And I didnt see that this is described in docs.<br>Will let you know if my compilation is successful.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Pawel</span><br><span class="post-time small text-muted">16th July 2013 21:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">OK, I run compilation again. ZLIb problem is gone.<br>But, of course, there is another one...<br><br>Here is the last part of log:<br><br><i>Source\util.cpp(437) : warning C4290: C++ exception specification ignored except to indicate a function is not __declspe<br>c(nothrow)<br>Source\util.cpp(639) : error C2065: 'ENOMEM' : undeclared identifier<br>Source\util.cpp(661) : error C2065: 'ECHILD' : undeclared identifier<br>scons: *** [build\urelease\Library\LibraryLocal\util.obj] Error 2<br>scons: building terminated because of errors.<br>C:\NSIS3&gt;</i><br><br>How to fix it?<br><br>Ps: Here is a full log: <a href="http://www.meggamusic.co.uk/shup/1374007350/NSIS3_Build_Log.txt" target="_blank">http://www.meggamusic.co.uk/shup/137..._Build_Log.txt</a><br>-Pawel</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">16th July 2013 22:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Add #include &lt;stdlib.h&gt; to the top of util.cpp and if that is not enough, try errno.h</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Pawel</span><br><span class="post-time small text-muted">16th July 2013 23:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">It works (stdlib.h did nothing, but adding errno.h helped).<br><br>However, there is one more problem. I use "scons dist" command.<br>It should create zip and installer. But, when scons run makensis it hangs. So, i can not run just compiled makensis.exe. Windows displays error message - makensis.exe stopped working, etc...<br><br>Here is a log: <a href="http://www.meggamusic.co.uk/shup/1374012505/NSIS_3_Build_Log.txt" target="_blank">http://www.meggamusic.co.uk/shup/137..._Build_Log.txt</a><br>Here is a screen: <a href="http://www.meggamusic.co.uk/shup/1374012698/Screen.png" target="_blank">http://www.meggamusic.co.uk/shup/1374012698/Screen.png</a><br><br>Should I provide something else? I wonder why it crash...<br>-Pawel<br><br>Ps: Thanks for your patience, Anders... I have to tell, that each time i try to compile nsis sources i have some problems.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">17th July 2013 01:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Does it crash if you compile example1.nsi or run it with no parameters? My guess is that the CRT is responsible for the 255 exit code.<br><br>You could try running it in WinDbg and see what "!analyze -v" says.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Pawel</span><br><span class="post-time small text-muted">17th July 2013 17:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I am not sure if you understood me well. I can not compile any script, as makensis.exe seems to be broken. It crash on open (in my case, during source compilation, when it tries to compile makensis.nsi).<br><br>So, something went wrong during source compilation... god knows what.<br>-Pawel<br><br><br>PS: I made a video, that presents compilation:<br><a href="http://www.meggamusic.co.uk/shup/1374786840/NSIS_3_Compilation.zip" target="_blank">http://www.meggamusic.co.uk/shup/137...ompilation.zip</a><br>You will see that makensis.exe is broken. It crashes ("scons dist" starts at 3 minute of video).<br><br>Edit:<br>Problem is now solved. To compile NSIS 3 using Visual Studio 2008 Express Edition (maybe also other versions) you need to:<br>1. Add errno.h header to util.cpp<br>2. Change <i><font color="RoyalBlue">ExpandoStrFmtVaList_vsnwprintf</font></i> from utils.cpp to: <i><font color="DimGray">#define ExpandoStrFmtVaList_vsnwprintf(d,c,f,v) ( INT_MAX==(c) ? _vscwprintf((f),(v)) : _vsnwprintf((d),(c)?(c)-1:0,(f),(v)) )</font></i><br>-Pawel</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">aerDNA</span><br><span class="post-time small text-muted">21st July 2013 16:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Can't break alpha</strong><br>I have some rather complex scripts, with code ranging from classic stuff to not-so-standard usage. So far, I couldn't detect any unexpected behaviour or get compiler errors (tested both ansi&amp;unicode where possible). I realize I'm one user and there isn't much value in 'no-bug reports'; just wanted to say it's looking proper and I'd be surprised if any significant number of bugs is reported until the final release.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Pawel</span><br><span class="post-time small text-muted">4th August 2013 22:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">@Anders<br>Here are few problems to fix in NSIS 3.0a1 (minor)<br><br>1. In the About dialog of MakeNSISW "Close" button do nothing.<br><a href="http://www.meggamusic.co.uk/shup/1375652199/MakeNSISW_about.png" target="_blank">http://www.meggamusic.co.uk/shup/137...SISW_about.png</a><br>It should perform some action (here: the same procedure as defined for OK button - Close the form). As I remember, it was the same in older NSIS builds (maybe there is some reason for that)<br><br>2. When you choose "NSIS update" menu entry from MakeNSISW it shows a dialog that a new version is available (it is not true, as the newest one is already installed)<br><a href="http://www.meggamusic.co.uk/shup/1375652459/NSIS_Update.png" target="_blank">http://www.meggamusic.co.uk/shup/137...SIS_Update.png</a><br><br>3. NSIS.exe application has a header image. It has a gap from the right side. Should be eliminated (title text bug is already reported)<br><a href="http://www.meggamusic.co.uk/shup/1375652608/NSIS_Menu.png" target="_blank">http://www.meggamusic.co.uk/shup/137.../NSIS_Menu.png</a><br><br>4. I think, there is a problem with lang files with UTF-8 encoding, in Unicode installers.<br>I had a file encoded in that format and after compilation NSIS installer displayed wrong characters (I have no screenshot). Everything works perfect with UCS-2 Little Endian.<br><br>5. Problem (or not) with output language value stored in exe resource file. It is hard to explain, will try to do this...<br>I am not sure, but in NSIS 2.46 when you compiled your installer it saves to installer resource file "Neutral Language". <a href="http://www.meggamusic.co.uk/shup/1375653170/Lang.png" target="_blank">http://www.meggamusic.co.uk/shup/1375653170/Lang.png</a><br><br>Now, it saves last defined language in script...<br>For example:<br>Last language in code is "English". Result:<br><a href="http://www.meggamusic.co.uk/shup/1375653361/Last_English.png" target="_blank">http://www.meggamusic.co.uk/shup/137...st_English.png</a><br><br>And now:<br>Last language in code is "Turkish". Result:<br><a href="http://www.meggamusic.co.uk/shup/1375653516/Last_Turkish.png" target="_blank">http://www.meggamusic.co.uk/shup/137...st_Turkish.png</a><br><br>Or maybe this is how it was ment to be?<br><br>-Pawel</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">5th August 2013 17:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by Pawel</small><br>Here are few problems to fix in NSIS 3.0a1 (minor)</blockquote>Thanks for finding and reporting all these issues!<br><ol style="list-style-type: decimal"><li>Fixed</li><li>Todo: I believe this is a issue on the server</li><li>I made the dialog 2 pixels thinner, might not fix it 100% on your end, some font &amp; dialog unit calculation is probably required to completely fix this (The gap is probably from wxWidgets changes, not something we did)</li><li>Do you have a small sample file I can use for testing?</li><li>There was a change to the language blocks in the version info a while back but I'm guessing you are not adding the info correctly, if you don't use /LANG= the language used is indeed the last loaded. You should either add the VI keys for a language after you load the language or use /LANG.<br><a href="http://i.imgur.com/4qtk3lA.png" target="_blank"></a><a href="http://i.imgur.com/4qtk3lAs.png" target="_blank">http://i.imgur.com/4qtk3lAs.png</a><br>(Resource Hacker is buggy when it comes to multiple language blocks and cannot be trusted)</li></ol></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Pawel</span><br><span class="post-time small text-muted">5th August 2013 18:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Anders,<br>Ad4. Sent example installer code via PM (it seems that the problem exists with UTF-8 without BOM).<br>Ad5. Thanks. You are right. I forgot about that lang switch.<br>-Pawel</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">T.Slappy</span><br><span class="post-time small text-muted">7th August 2013 06:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Small problem (not a real bug) which is really annoying me:<br><br>When I compile .nsi file with makensisW (right click the .nsi file -&gt; Compile NSIS Script) and compilation is successful I cannot run generated installer by pressing Enter (or Space) key because Close button has focus and makensisW closes. This is because Close is default button for this form.<br><br>My suggestion is to set <b>Test Installer</b> button as default.<br>If anyone wants to close the window he can do that with Esc key (this is already working).</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">7th August 2013 20:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by T.Slappy</small><br>My suggestion is to set <b>Test Installer</b> button as default.</blockquote>Fixed</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">T.Slappy</span><br><span class="post-time small text-muted">19th September 2013 08:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">What about creating About dialog and adding it into NSIS's menu?<br><br>I saw something similar in Inno Setup and I think it is really nice feature which can propagate NSIS further.<br><br><a href="http://graphical-installer.com/temp/nsis-about.jpg" target="_blank">http://graphical-installer.com/temp/nsis-about.jpg</a><br><br>Simple MessageBox could be enough, no large fancy stuff.<br><br>What's your opinion?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">19th September 2013 15:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by T.Slappy</small><br>What about creating About dialog and adding it into NSIS's menu?<br><br>What's your opinion?</blockquote>BrandingText is not enough?<br><br>I'm not a big fan of apps that change the system menu and adding to the bottom is horrible, that is right where close is supposed to be when you right-click its taskbar button on &lt;= Vista.<br><br>If you wanted to put your own stuff there you could create a plugin...</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">TrifonovS</span><br><span class="post-time small text-muted">20th September 2013 11:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I tried to compile one of my ready installers (compiled with v2.46) and I got the following error:<br><br>(C:\Program Files (x86)\NSIS\Include\StrFunc.nsh:52)<br>Internal compiler error: installer's shell constants are different than uninstallers!<br><br>abnormal program termination<br><br>Can you help me to solve it, please???</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">20th September 2013 17:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by TrifonovS</small><br>I tried to compile one of my ready installers (compiled with v2.46) and I got the following error:<br><br>(C:\Program Files (x86)\NSIS\Include\StrFunc.nsh:52)<br>Internal compiler error: installer's shell constants are different than uninstallers!<br></blockquote>Could you provide a minimal code sample?</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">TrifonovS</span><br><span class="post-time small text-muted">23rd September 2013 09:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I tried to prepare for you a simpler installer that reproduces the problem, because my installer needs a lot of additional files, plug-ins,... But when I removed code from the script I found what makes the problem. I have my own MultyUser.nsh (of course with changed name). If I remove it, all works fine. Now I have to find out why it can be compiles with v2.46, but not with v3.0. If I need additional help I will ask again.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">yclkvnc</span><br><span class="post-time small text-muted">26th September 2013 11:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hi Guys,<br><br>I will use NSIS for the first time. Even though issues are sourceforge or in this thread are minor, I'm not sure if I should use 3.0a1 since it's an alpha release.<br>Do you think it's stable enough or should I use 2.46 for now ?<br><br>Sorry if it's on wrong thread.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">26th September 2013 14:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by yclkvnc</small><br><br>I will use NSIS for the first time. Even though issues are sourceforge or in this thread are minor, I'm not sure if I should use 3.0a1 since it's an alpha release.<br>Do you think it's stable enough or should I use 2.46 for now ?</blockquote>The license URL bug is the only one the end user will see, if you don't have URLs in your license then I guess you can.<br><br>There should be another alpha soon. The remaining work before we can do betas is mainly POSIX related...</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">f0rt</span><br><span class="post-time small text-muted">5th October 2013 21:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Big thanks for the NSIS Unicode work.<br><br>I am curious about the plans for POSIX.<br><br>The command "scons UNICODE=no utils makensis" fails to build the ANSI versions of utils and makensis from source. I thought about resurrecting the defunct ANSI makensis and utils for POSIX. This may sound awkward. However the wchar_t type is ambiguous and compiler-specific.<br><br>If the GNU C Compiler is instructed to override the underlying type for 'wchar_t' to be 'short unsigned int' by the flag '-fshort-wchar' then standard and third-party library code using the POSIX default definiton of wchar_t (32 bit) won't be usable from code compiled with '-fshort-wchar' due to incompatible wchar_t sizes. WCHAR could be used but also with the expense to reimplement the used standard library functions.<br><br>makensis and utils as ANSI/UTF-8 executables could be implemented in way to be able to produce Unicode installers. The plugins and stubs are anyway built in a version for ANSI as well as Unicode. One of the open issues is the internal representation of language and text strings. My guess is that UTF-8 could be easier converted into Unicode respectivly other required codepages. Though the current implementation of ANSI makensis seems to use CP_ACP (system default Windows ANSI code page) if I correctly understood the code.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">6th October 2013 02:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Why is using wchar_t (32bit) in makensis/cputils a problem?<br><br>The old ANSI makensis did not really care, all NSIS instructions are ASCII safe and anything above 127 is just "bytes" and so CP_ACP does not really come into the picture until setup is running on the end users machine IIRC...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">6th October 2013 07:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hi, testing nsis 3.0a1 and I found a quirk (sorry if it's reported on the sf bug tracker, I haven't checked there yet). Firstly I like how the .nsi file can be ansi or unicode, and it will still compile to what the Unicode statement defines (true or false).<br><br>The quirk is that the license file has to be the same encoding as the Unicode statement, ie using an ansi license file with "Unicode true" results in a bunch of chinese or japanese characters. The other way round results in 3 weird chars and the rest is blank.<br><br>So I think the fix could be making the license file reading code the same as the .nsi reading code, where it doesn't matter what the input encoding is, it will output the correct encoding as defined with the Unicode statement.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">6th October 2013 08:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I wrote the nsi reader from scratch, the license handling mostly comes from the unicode fork/merge.<br><br>Just to be clear, you are talking about a .txt license file and not RTF?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">7th October 2013 09:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Correct, though I haven't used *.rtf files in installers yet.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">7th October 2013 11:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">So the idea looks similar to this:<br><br></p><blockquote>handle = openfile(filename.txt);<br>if (isUnicodeInstaller()) // returns true or false<br>{<blockquote>if (isUnicodeFile(handle)) // if both the same, do nothing<br>{<br>}<br>else // ansi file, convert to unicode<br>{<blockquote>convertToUnicode(handle);</blockquote>}<br></blockquote>else // ansi installer<br>{<blockquote>if (isUnicodeFile(handle)) // if unicode file, convert to ansi<br>{<blockquote>convertToAnsi(handle);</blockquote>}<br>else // both the same, do nothing<br>{<br>}</blockquote>}</blockquote>I have had a quick look at the code for the license loading, but I don't understand alot of it because I'm not familiar with the c++ side, though it looks like the LoadLicenseFile function (in script.cpp) is converting the text to wchar_t regardless of the file encoding.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">8th October 2013 12:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I have done a bit more testing, and it turns out that .rtf files are fine, it's the .txt encoding that's the problem.<br>If it's ansi, the compiler will compile both ansi and unicode installers correctly.<br>If it's unicode, the compiler will throw the same error for both ansi and unicode installers. Compiler log:<br></p><blockquote>SetCompressor: lzma<br>!define: "MUI_CUSTOMFUNCTION_GUIINIT"="onGUIinit"<br>!insertmacro: MUI_PAGE_LICENSE<br>LicenseData: wchar_t conversion failed!<br>Error in macro MUI_PAGEDECLARATION_LICENSE on macroline 17<br>Error in macro MUI_PAGE_LICENSE on macroline 6<br>Error in script "D:\Jason\Projects\maketest.nsi" on line 21 -- aborting creation process</blockquote>Which is this part (CEXEBuild::LoadLicenseFile) in script.cpp:<br><blockquote>// We have to convert the content of the license file to wchar_t<br>const WORD srccp=strm.StreamEncoding().IsUnicode() ? strm.StreamEncoding().GetCodepage() : AnsiCP;<br>const UINT cbcu=NStreamEncoding::GetCodeUnitSize(srccp);<br>if (sizeof(TCHAR) &lt; cbcu)<br>{<br>l_errwcconv:<br>ERROR_MSG(_T("%s: wchar_t conversion failed!\n"),cmdname);<br>return PS_ERROR;<br>}</blockquote>I will be diving into the source code for those first two lines to see what is happening, and if I can make a patch to fix this problem.<br><br>[edit]<br>I decided to test other encodings first. I use notepad in Windows 7 to save the encoding type. UTF-8 and Unicode big endian work fine, it's the vanilla Unicode setting that throws the error. I don't know what that encoding type is so unfortunately I can't go any further there.<br>[/edit]</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">8th October 2013 20:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The problem is not the lines you posted, it was the Dup before the goto. Anyway, I fixed the bug...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">8th October 2013 20:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Awesome, if I see any other quirks I'll shout out :D.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">nidzadragon</span><br><span class="post-time small text-muted">9th October 2013 00:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Linux build</strong><br>Can I build source of nsis3.0 on linux? :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">9th October 2013 02:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Not yet, though it will be worked on later in development, probably once everything is integrated and working well enough.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">9th October 2013 04:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by nidzadragon</small><br>Can I build source of nsis3.0 on linux? :)</blockquote>It would be really helpful if someone would be willing to try to fix POSIX and submit some patches...</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">nidzadragon</span><br><span class="post-time small text-muted">9th October 2013 08:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I already tried to build this version using SCons, but I get error "zlib is missing" even if I set correct path to zlib trough ZLIB_W32 environment variable.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">10th October 2013 08:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I know very little about python but I'm giving posix compiling a go.<br><br>I'm using ubuntu 12.04, 64 bit.<br>If I have to, I'll do my testing on virtualbox under the 32 bit version.<br><br>This is the line I'm using: scons SKIPSTUBS=all SKIPPLUGINS=all SKIPUTILS=all SKIPMISC=all SKIPDOC=all<br><br>I got the zlib dependancy working, and halibut compiles up correctly but it won't execute, throwing up an error saying "Permission denied", so I have commented that section out of Sconstruct for now.<br><br>Question: is pluginapi.c really required for compiling makensis? Because the first line in it is: #include &lt;windows.h&gt;, which of course doesn't exist on linux, and it throws an error. I have substituted a basic cross-plaform ready file in it's place.<br><br>Also, I noticed that the first file that doesn't compile is related to makensis, specifically:<br>o build/urelease/makensis/7zip/7zGuids.o -c -Wno-non-virtual-dtor -Wall -O2 -DNSISCALL="__attribute__((__stdcall__))" -D_UNICODE -DUNICODE -D__BIG_ENDIAN__ -DMAKENSIS -D_WIN32_IE=0x0500 -DCOMPRESS_MF_BT -Ibuild/urelease/config Source/7zip/7zGuids.cpp<br>sh: 1: o: not found<br><br>I wil do some more testing on the 32 bit version and see if these pop up there too.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Theresias</span><br><span class="post-time small text-muted">10th October 2013 09:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">[REMOVED]<br><br>...nevermind, stupid me - found the issue on my end. Compiler flags FTW. ;)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">10th October 2013 12:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I'm running a 32 bit environment now, and all those errors above have vanished, with a new one (several, actually) popping up:<br></p><blockquote>g++ -o build/urelease/makensis/DialogTemplate.o -c -Wno-non-virtual-dtor -Wall -O2 -DNSISCALL="__attribute__((__stdcall__))" -D_UNICODE -DUNICODE -DMAKENSIS -D_WIN32_IE=0x0500 -Ibuild/urelease/config Source/DialogTemplate.cpp<br>Source/DialogTemplate.cpp: In function 'void ReadVarLenArr(unsigned char*&amp;, WCHAR*&amp;, unsigned int)':<br>Source/DialogTemplate.cpp:62:38: error: cannot convert 'WCHAR* {aka short unsigned int*}' to 'const wchar_t*' for argument '1' to 'wchar_t* wcsdup(const wchar_t*)'</blockquote>I am also getting a bunch of functions that aren't declared: _wcsnicmp, _wcsicmp. It also appears the family of "wcs" functions are either not declared or have type-cast conversion problems. I'm still looking through the source code to find these functions and maybe fix them if I'm confident enough. I wish Visual Studio worked on linux, the "Find in Files" search is so great.<br><br>[edit] I managed to type-cast that function above so it will compile, wether it works or not is another story: readInto = _wcsdup((wchar_t*)arr);.<br><br>Here's one of the "not declared" errors:<br><blockquote>Source/DialogTemplate.cpp: In member function 'void CDialogTemplate::AddItem(DialogItemTemplate)':<br>Source/DialogTemplate.cpp:306:44: error: '_wcsdup' was not declared in this scope</blockquote>Also, these functions that aren't declared are confusing, I followed the include chain and the function prototype is definitely being declared, so I don't know what's going on there :igor:.<br><br>Another question: I see there are some defines like this: '#if 0 '. Are these really needed? Because the number of errors are reduced alot when they are removed (like the one above is resolved). Should I put them in #ifdef _WIN32, #else, #endif blocks? Or remove them altogether?</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">10th October 2013 17:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">We should try to stay away from casting to shut up the compiler. In the dialog stuff there might be some strings that are always UTF16LE that end up as resources in the .exe. IIRC there is a StrLenUTF16 in utf.h and some other helpers in winchar.cpp<br><br>I'll jump on IRC now if you want some more help...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">10th October 2013 17:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I have found most of the type-cast's are dealing with TCHAR*, WCHAR* and wchar_t*. There are also some missing function prototypes, but I am making a list of each change I'm making so it's easier for experienced programmers to change. gcc is an anal b**** :mad:.</p></div><hr><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">NSIS 3.0a1</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=366503">NSIS 3.0a1</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">10th October 2013 19:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I noticed that WCHAR is typedef'ed unsigned short in Platform.h. Apparently these two can be directly type-cast with no problems, though I don't know the truth.<br><br></p><blockquote>#if !defined(_NATIVE_WCHAR_T_DEFINED)<br>typedef unsigned short WCHAR;<br>#else<br>typedef wchar_t WCHAR;<br>#endif</blockquote></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">10th October 2013 21:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by JasonFriday13</small><br>I noticed that WCHAR is typedef'ed unsigned short in Platform.h. Apparently these two can be directly type-cast with no problems, though I don't know the truth.</blockquote>Yes but I believe it really is there just for the exehead stuff, you should not be calling the wcs* string functions with a WCHAR* parameter in makensis code (Not portable)</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">11th October 2013 05:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I've had enough for now. I don't know if windows is smart and knows about the implied cast-typing, but gcc sure doesn't and it catches every type problem, which makes it very hard to troubleshoot. I might start on the non unicode version first as that seems easier to get change it around between ansi and unicode versions.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">11th October 2013 15:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The ANSI version is going to have even more issues so I don't think that is a good idea. What about the diff I sent you?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">12th October 2013 05:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I applied that patch to a fresh 3.0a1 source (compiling with unicode on) and it's getting better, DialogTemplate.cpp compiles with no errors now. Also I have to remove 'ExDLL' from the lib_plugins list in Sconstruct, because it tries compiling pluginapi.c, which of course includes windows.h and throws an error about not finding it.<br><br>I am now getting another error in ResourceEditor.cpp, in:<br>return UpdateResourceW(szType, MAKEINTRESOURCEW(szName), wLanguage, lpData, dwSize);<br>saying "no type conversion found for argument 1". So I added this function to convert it:<br></p><blockquote>return UpdateResourceW(WinWStrDupFromTChar(szType), MAKEINTRESOURCEW(szName), wLanguage, lpData, dwSize);</blockquote>I did this to the four "Resource" functions, and there are no errors there now. Also I changed this function call at line 985 to:<br><blockquote>return WinWStrLen(m_szName); // wcslen(m_szName);</blockquote>which cleared up that error.<br><br>I am getting one error for this file still (other files don't compile if there are errors):<br><blockquote>Source/ResourceEditor.cpp: In member function 'int CResourceDirectory::Find(const WCHAR*)':<br>Source/ResourceEditor.cpp:865:40: error: '_wtoi' was not declared in this scope</blockquote>I'll look around for alternatives for that function.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">12th October 2013 06:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Calling WinWStrDupFromTChar like that is a memory leak but its fine for testing.<br><br>There is probably something like myatoi in util.c or one of the plugin files, use it to create a WinWStrToInt in winchar.cpp/h if you cannot come up with anything else. I'll try to take a look at the code tonight...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">12th October 2013 08:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">There is, it's in "source/exehead/util.c", so I copied it over into "winchar.c" and renamed it like this:<br></p><blockquote>#ifndef _WIN32 // existing #ifdef<br>int WinWStrToInt(const WINWCHAR *s)<br>{<br>unsigned int v=0;<br>int sign=1; // sign of positive<br>TCHAR m=10; // base of 10<br>TCHAR t=_T('9'); // cap top of numbers at 9<br><br>if (*s == _T('-'))<br>{<br>s++; //skip over -<br>sign=-1; // sign flip<br>}<br><br>if (*s == _T('0'))<br>{<br>s++; // skip over 0<br>if (s[0] &gt;= _T('0') &amp;&amp; s[0] &lt;= _T('7'))<br>{<br>m=8; // base of 8<br>t=_T('7'); // cap top at 7<br>}<br>if ((s[0] &amp; ~0x20) == _T('X'))<br>{<br>m=16; // base of 16<br>s++; // advance over 'x'<br>}<br>}<br><br>for (;; )<br>{<br>int c=*s++;<br>if (c &gt;= _T('0') &amp;&amp; c &lt;= t) c-=_T('0');<br>// clever little trick to do both upper and lowercase A-F.<br>else if (m==16 &amp;&amp; (c &amp; ~0x20) &gt;= _T('A') &amp;&amp; (c &amp; ~0x20) &lt;= _T('F')) c = (c &amp; 7) + 9;<br>else break;<br>v*=m;<br>v+=c;<br>}<br>return ((int)v)*sign;<br>}</blockquote>I added it to the header and to ResourceEditor.cpp, and it compiles. I hope it actually works.<br><br>Now I'm getting this error:<br><blockquote>In file included from Source/ResourceVersionInfo.h:30:0,<br>from Source/ResourceVersionInfo.cpp:19:<br>Source/strlist.h: In member function 'int SortedStringListND&lt;T&gt;::find(const TCHAR*, int, int, int, int*)':<br>Source/strlist.h:402:38: error: there are no arguments to '_wcsicmp' that depend on a template parameter, so a declaration of '_wcsicmp' must be available [-fpermissive]<br>Source/strlist.h:402:38: note: (if you use '-fpermissive', G++ will accept your code, but allowing the use of an undeclared name is deprecated)</blockquote>It comes up a few times. This is one of the code parts the function refers to in "strlist.h":<br><blockquote>if (case_sensitive)<br>res = _tcscmp(str, pCurr);<br>else<br>res = _tcsicmp(str, pCurr);</blockquote>It's weird how it's brother "_wcscmp" is declared, but "_wcsicmp" is not declared in this scope. There are also some "'_swprintf' was not declared in this scope" errors, I would change these to "wsprintf", but is this a good function or should a different one be used?</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">12th October 2013 09:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">What about adding "|| !defined _WIN32" to line 53 in tchar.h? Because swprintf is recongnised under linux.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">12th October 2013 14:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I also noticed on linux, swprintf also requires a max length argument:<br></p><blockquote>int swprintf(wchar_t *wcs, size_t maxlen, const wchar_t *format, ...);</blockquote>I quick dodgied the code (with #warning tags for stuff I changed or removed) to see what other errors I got, and it looks like build.cpp has lots of errors there. Also I had to comment out line 246 in Sconstruct because "tchar.h" doesn't exist in the build directory. And all the TEXT() macros that are in the source files I have been changing to _T(), because that is supported under linux.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">12th October 2013 20:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The *icmp stuff is not really part of the standard, the string support sucks.<br><br><a href="http://pastebin.com/ceCXMnVK" target="_blank">Here</a> is another diff, should probably apply it to svn trunk and not alpha 1 if you can.<br><br>Not sure what to do about swprintf, I'll have to think about it some more...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">13th October 2013 05:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">you could try this<br></p><blockquote>#ifndef _WIN32<br>int swprintf(wchar_t*buf, const wchar_t*fmt, ...) // non-standard overloaded version for MSVC compatibility<br>{<br>va_list val;<br>va_start(val, fmt);<br>int res = vswprintf(buf, -1, fmt, val);<br>va_end(val);<br>return res;<br>}<br>#endif<br></blockquote></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">13th October 2013 09:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">So went and downloaded the trunk source-tree, and added both of those diff's you gave me to a fresh copy.<br><br>I put that function into "Source/util.cpp" and it's prototype in "Source/util.h", it still gave a compile error saying it's undeclared, so I changed line 53 in "tchar.h" to<br></p><blockquote>#if (defined(_MSC_VER) &amp;&amp; (_MSC_VER&lt;=1310)) || defined(__MINGW32__) || !defined _WIN32</blockquote>and it compiles without an error.<br><br>So far these are the files that are compiling successfully (in this order):<br><blockquote>scons: Cleaning targets ...<br>Removed build/urelease/halibut/biblio.o<br>Removed build/urelease/halibut/bk_xhtml.o<br>Removed build/urelease/halibut/contents.o<br>Removed build/urelease/halibut/error.o<br>Removed build/urelease/halibut/help.o<br>Removed build/urelease/halibut/index.o<br>Removed build/urelease/halibut/input.o<br>Removed build/urelease/halibut/keywords.o<br>Removed build/urelease/halibut/licence.o<br>Removed build/urelease/halibut/main.o<br>Removed build/urelease/halibut/malloc.o<br>Removed build/urelease/halibut/misc.o<br>Removed build/urelease/halibut/style.o<br>Removed build/urelease/halibut/tree234.o<br>Removed build/urelease/halibut/ustring.o<br>Removed build/urelease/halibut/version.o<br>Removed build/urelease/halibut/halibut<br>Removed build/urelease/Docs/html/IndexPage.html<br>Removed build/urelease/Docs/html/Contents.html<br>Removed build/urelease/Docs/html/Chapter1.html<br>Removed build/urelease/Docs/html/Chapter2.html<br>Removed build/urelease/Docs/html/Chapter3.html<br>Removed build/urelease/Docs/html/Chapter4.html<br>Removed build/urelease/Docs/html/Chapter5.html<br>Removed build/urelease/Docs/html/AppendixA.html<br>Removed build/urelease/Docs/html/AppendixB.html<br>Removed build/urelease/Docs/html/AppendixC.html<br>Removed build/urelease/Docs/html/AppendixD.html<br>Removed build/urelease/Docs/html/AppendixE.html<br>Removed build/urelease/Docs/html/AppendixF.html<br>Removed build/urelease/Docs/html/AppendixG.html<br>Removed build/urelease/Docs/html/AppendixH.html<br>Removed build/urelease/Docs/html/AppendixI.html<br>Removed build/urelease/makensis/7zip/7zGuids.o<br>Removed build/urelease/makensis/7zip/7zip/Common/OutBuffer.o<br>Removed build/urelease/makensis/7zip/7zip/Common/StreamUtils.o<br>Removed build/urelease/makensis/7zip/7zip/Compress/LZ/LZInWindow.o<br>Removed build/urelease/makensis/7zip/7zip/Compress/LZMA/LZMAEncoder.o<br>Removed build/urelease/makensis/7zip/7zip/Compress/RangeCoder/RangeCoderBit.o<br>Removed build/urelease/makensis/7zip/Common/Alloc.o<br>Removed build/urelease/makensis/7zip/Common/CRC.o<br>Removed build/urelease/makensis/DialogTemplate.o<br>Removed build/urelease/makensis/Plugins.o<br>Removed build/urelease/makensis/ResourceEditor.o<br>Removed build/urelease/makensis/ResourceVersionInfo.o<br>Removed build/urelease/makensis/ShConstants.o<br>scons: done cleaning targets.</blockquote>Next on the fail list is build.cpp, which gives all these errors (I combed out the duplicates to save some space):<br><blockquote>g++ -o build/urelease/makensis/build.o -c -Wno-non-virtual-dtor -Wall -O2 -DNSISCALL="__attribute__((__stdcall__))" -D_UNICODE -DUNICODE -DMAKENSIS -D_WIN32_IE=0x0500 -Ibuild/urelease/config Source/build.cpp<br>Source/build.cpp: In member function 'void CEXEBuild::initialize(const TCHAR*)':<br>Source/build.cpp:388:44: error: '_wgetenv' was not declared in this scope<br>Source/build.cpp:394:16: error: invalid conversion from 'const char*' to 'wchar_t' [-fpermissive]<br>/usr/include/c++/4.6/bits/basic_string.h:560:7: error: initializing argument 1 of 'std::basic_string&lt;_CharT, _Traits, _Alloc&gt;&amp; std::basic_string&lt;_CharT, _Traits, _Alloc&gt;::operator=(_CharT) [with _CharT = wchar_t, _Traits = std::char_traits&lt;wchar_t&gt;, _Alloc = std::allocator&lt;wchar_t&gt;, std::basic_string&lt;_CharT, _Traits, _Alloc&gt; = std::basic_string&lt;wchar_t&gt;]' [-fpermissive]<br>Source/build.cpp: In member function 'int CEXEBuild::add_string(const TCHAR*, int, UINT)':<br>Source/build.cpp:487:33: error: '_wcsdup' was not declared in this scope<br>Source/build.cpp: In function 'char* convert_processed_string_to_ansi(char*, const TCHAR*, WORD)':<br>Source/build.cpp:533:90: error: cannot convert 'const TCHAR* {aka const wchar_t*}' to 'LPCWSTR {aka const short unsigned int*}' for argument '3' to 'int WideCharToMultiByte(UINT, DWORD, LPCWSTR, int, LPSTR, int, LPCSTR, LPBOOL)'<br>Source/build.cpp:543:34: error: 'LOBYTE' was not declared in this scope<br>Source/build.cpp:544:34: error: 'HIBYTE' was not declared in this scope<br>Source/build.cpp: In member function 'int CEXEBuild::preprocess_string(TCHAR*, const TCHAR*, WORD)':<br>Source/build.cpp:655:69: error: 'MAKEWORD' was not declared in this scope<br>Source/build.cpp: In member function 'int CEXEBuild::add_label(const TCHAR*)':<br>Source/build.cpp: In member function 'int CEXEBuild::resolve_jump_int(const TCHAR*, int*, int, int, int)':<br>Source/build.cpp:1364:29: error: '_wtoi' was not declared in this scope<br>Source/build.cpp: In member function 'int CEXEBuild::AddVersionInfo()':<br>Source/build.cpp:1816:112: error: no matching function for call to 'CResourceEditor::UpdateResource(LPSTR, int, LANGID&amp;, BYTE*, int)'<br>Source/build.cpp:1816:112: note: candidate is:<br>Source/ResourceEditor.h:117:9: note: bool CResourceEditor::UpdateResource(const TCHAR*, WORD, LANGID, BYTE*, DWORD)<br>Source/ResourceEditor.h:117:9: note: no known conversion for argument 1 from 'LPSTR {aka char*}' to 'const TCHAR* {aka const wchar_t*}'<br>Source/build.cpp: In member function 'int CEXEBuild::ProcessPages()':<br>Source/build.cpp:2186:10: error: no matching function for call to 'CResourceEditor::GetResource(LPSTR, int, int)'<br>Source/build.cpp:2186:10: note: candidate is:<br>Source/ResourceEditor.h:118:9: note: BYTE* CResourceEditor::GetResource(const TCHAR*, WORD, LANGID)<br>Source/ResourceEditor.h:118:9: note: no known conversion for argument 1 from 'LPSTR {aka char*}' to 'const TCHAR* {aka const wchar_t*}'<br>Source/build.cpp: In member function 'int CEXEBuild::pack_exe_header()':<br>Source/build.cpp:2505:28: error: '_wremove' was not declared in this scope<br>Source/build.cpp:2511:26: error: '_wremove' was not declared in this scope<br>Source/build.cpp: In member function 'int CEXEBuild::write_output()':<br>Source/build.cpp:2947:7: error: 'LPTSTR' was not declared in this scope<br>Source/build.cpp:2947:14: error: expected ';' before 'cmdstr'<br>Source/build.cpp:2948:14: error: expected ';' before 'arg'<br>Source/build.cpp:2949:11: error: 'arg' was not declared in this scope<br>Source/build.cpp:2952:9: error: 'cmdstrbuf' was not declared in this scope<br>Source/build.cpp:2952:30: error: expected ';' before 'malloc'<br>Source/build.cpp:2958:47: error: 'cmdstr' was not declared in this scope<br>Source/build.cpp:2965:49: error: 'cmdstr' was not declared in this scope<br>Source/build.cpp:2974:12: error: 'cmdstrbuf' was not declared in this scope<br>scons: *** [build/urelease/makensis/build.o] Error 1<br>scons: building terminated because of errors.</blockquote></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">13th October 2013 23:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><a href="http://pastebin.com/iQUUqY2U" target="_blank">This</a> should contain all fixes so far except swprintf.<br><br><br></p><blockquote>because "tchar.h" doesn't exist in the build directory.</blockquote>I don't really know what this means. nsis-version.h?</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">14th October 2013 02:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Yeah, Sconstruct writes "#include "tchar.h"" into "nsis-version.h", but tchar.h is in the source directory, not the current directory ("build/urelease/config").<br><br>I'll add that patch now and get back to you.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">14th October 2013 05:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">So I added that patch you gave me, and I had to add #include "tchar.h" and #include "utf.h" to "ResourceVersionInfo.cpp" for it to compile with no errors.<br><br>That Sconstruct patch has caused a problem, these two lines:<br></p><blockquote>defenv.Append(NSIS_CPPDEFINES = [('PREFIX_CONF', 'L"%s"' % defenv.subst('$PREFIX_CONF'))])<br>defenv.Append(NSIS_CPPDEFINES = [('PREFIX_DATA', 'L"%s"' % defenv.subst('$PREFIX_DATA'))])</blockquote>gives this as it's output in "nsis-defines.h":<br><blockquote>definedlist.add(_T("PREFIX_CONF"), _T("L"/usr/local/etc""));<br>definedlist.add(_T("PREFIX_DATA"), _T("L"/usr/local/share/nsis""));</blockquote>Which of course causes a few compiler errors.<br>I'm still getting these errors in build.cpp (I combed the duplicates to save space):<br><blockquote>Source/build.cpp:1816:112: error: no matching function for call to 'CResourceEditor::UpdateResource(LPSTR, int, LANGID&amp;, BYTE*, int)'<br>Source/build.cpp:1816:112: note: candidate is:<br>Source/ResourceEditor.h:117:9: note: bool CResourceEditor::UpdateResource(const TCHAR*, WORD, LANGID, BYTE*, DWORD)<br>Source/ResourceEditor.h:117:9: note: no known conversion for argument 1 from 'LPSTR {aka char*}' to 'const TCHAR* {aka const wchar_t*}'<br>Source/build.cpp:2186:10: error: no matching function for call to 'CResourceEditor::GetResource(LPSTR, int, int)'<br>Source/build.cpp:2186:10: note: candidate is:<br>Source/ResourceEditor.h:118:9: note: BYTE* CResourceEditor::GetResource(const TCHAR*, WORD, LANGID)<br>Source/ResourceEditor.h:118:9: note: no known conversion for argument 1 from 'LPSTR {aka char*}' to 'const TCHAR* {aka const wchar_t*}'</blockquote>[edit] Turns out these are related to the MAKEINTRESOURCE macros in "Platform.h", and I've come up with a fix in "Platform.h" on line 491. The macro is basically a type-cast, so I just made up another that works for wchar_t (don't know if this will work at runtime though). The "D" suffix is obviously for 'define':<br><blockquote>#ifndef _UNICODE<br># define MAKEINTRESOURCED MAKEINTRESOURCEA<br>#else<br># define MAKEINTRESOURCED(i) ((wchar_t*)((ULONG_PTR)((WORD)(i))))<br>#endif<br><br>#ifndef RT_BITMAP<br># define RT_BITMAP MAKEINTRESOURCED(2)<br>#endif<br>#ifndef RT_ICON<br># define RT_ICON MAKEINTRESOURCED(3)<br>#endif<br>#ifndef RT_DIALOG<br># define RT_DIALOG MAKEINTRESOURCED(5)<br>#endif<br>#ifndef RT_GROUP_ICON<br># define RT_GROUP_ICON MAKEINTRESOURCED(14)<br>#endif<br>#ifndef RT_VERSION<br># define RT_VERSION MAKEINTRESOURCED(16)<br>#endif</blockquote></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">14th October 2013 10:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Oh and I managed to fix "pluginapi.c" from trying to compile on linux. I changed line 691 in Scontruct from this:<br></p><blockquote>for plugin in plugin_libs + plugins:</blockquote>To this:<br><blockquote>for plugin in plugin_libs and plugins:</blockquote></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">14th October 2013 21:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><a href="http://pastebin.com/JYrJnfMh" target="_blank">New Diff</a>, I believe I fixed the tchar.h path issue and maybe messed up something else ;)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">15th October 2013 05:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Yeah something else did mess up:<br></p><blockquote>In file included from Source/util.h:25:0,<br>from Source/DialogTemplate.cpp:21:<br>Source/ResourceEditor.h: In member function 'bool CResourceEditor::UpdateResource(const WCHAR*, WORD, LANGID, BYTE*, DWORD)':<br>Source/ResourceEditor.h:129:28: error: cast from 'const WCHAR* {aka const short unsigned int*}' to 'WORD {aka short unsigned int}' loses precision [-fpermissive]<br>Source/ResourceEditor.h: In member function 'BYTE* CResourceEditor::GetResource(const WCHAR*, WORD, LANGID)':<br>Source/ResourceEditor.h:134:25: error: cast from 'const WCHAR* {aka const short unsigned int*}' to 'WORD {aka short unsigned int}' loses precision [-fpermissive]</blockquote></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">15th October 2013 07:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Also, the compile system stops on the first error encountered, so several files still need to be compiled. For one, I know "dirreader.cpp" will need it's function prototypes changed, and "script.cpp" isn't being compiled yet either, along with a few others like "lineparse.cpp" and "lang.cpp".</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br><span class="post-time small text-muted">16th October 2013 09:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I have also been working on some stuff and I have made a .txt file that should describe everything that's wrong (though I might have missed something) and a few minor fixes that I've done. It's over 1600 lines but 3/4 of it includes one of the patches you gave me.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">TrifonovS</span><br><span class="post-time small text-muted">13th November 2013 08:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">When I compile my existing projects with the new NSIS version 3.0a1, it prints only several lines in the output window of the editor. With the older version 2.46 this is different. I see a lot of prints during the whole compilation. Of course I don't read all of them, but this can give me information what the compiler is doing currently. My script is huge and it needs probably 7-8 minutes for compilation and without prints with V3.0a1, it looks that it hangs and I don't know when it will finish. So is this behavior expected? Can I enable the prints similar to V2.46?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">14th November 2013 02:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by TrifonovS</small><br>When I compile my existing projects with the new NSIS version 3.0a1, it prints only several lines in the output window of the editor. With the older version 2.46 this is different.</blockquote>This change is listed in the release notes. It should also compile a little faster without all the prints.<br><br>Use makensis -v4 foo.nsi to print everything...</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">TrifonovS</span><br><span class="post-time small text-muted">21st November 2013 08:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I think that there is a problem with some existing plug-ins when the unicode support is enabled (Unicode true). For example Aero plug-in can not show correct some German letters. The problem is not in my code, because when I don't enable Aero plug-in the branding text is shown correct. I also had a problem with the caption-text of the inetc plug-in. When I disable unicode support all works fine. But when I enable it, the installer stops with a strange message.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">21st November 2013 09:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by TrifonovS</small><br>I think that there is a problem with some existing plug-ins when the unicode support is enabled (Unicode true). For example Aero plug-in can not show correct some German letters. The problem is not in my code, because when I don't enable Aero plug-in the branding text is shown correct. I also had a problem with the caption-text of the inetc plug-in. When I disable unicode support all works fine. But when I enable it, the installer stops with a strange message.</blockquote>I thought Afrow UK already said this was a bug in his plugin?<br><br>For anything else, post some example code or something, we are not mind readers...</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">TrifonovS</span><br><span class="post-time small text-muted">21st November 2013 11:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote>I thought Afrow UK already said this was a bug in his plugin?</blockquote>This was for showing of the ampersand symbol. I though that this is different problem.<br><br><blockquote>For anything else, post some example code or something, we are not mind readers...</blockquote>Of course, you are right. I was under a big time pressure with my project and I came back to NSIS V2.46. I will try to find time to install again NSIS V3.0a1 and to prepare simple code that can reproduce the problem (at least this one with inetc plug-in). I just though that might be useful to write some notes, because probably somebody already knows about these problems.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">TrifonovS</span><br><span class="post-time small text-muted">21st November 2013 14:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">So here is simple script that shows a strange behavior of the inetc plug-in. It just tries to download SP3 for Windows XP from a predefined location. When Unicode is true, after execution, it doesn't download anything, but just exits and the returned value is shown in a message box. The return value is unreadable. But when Unicode is set to false, the downloading is started. At the end (or if it is interrupted) the returned value is readable as it is expected.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">21st November 2013 15:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by TrifonovS</small><br>So here is simple script that shows a strange behavior of the inetc plug-in. It just tries to download SP3 for Windows XP from a predefined location. When Unicode is true, after execution, it doesn't download anything, but just exits and the returned value is shown in a message box. The return value is unreadable. But when Unicode is set to false, the downloading is started. At the end (or if it is interrupted) the returned value is readable as it is expected.</blockquote>...and you are using the Unicode version of the plugin?</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">21st November 2013 15:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">When strings are wrong/corrupted/1 character long you should always make sure that you are using the correct plugin that matches your target.<br><br></p><blockquote>*Unicode true<br>*!addplugindir to inetc unicode folder<br>*change $TEMP\ServicePack3 to $TEMP\Download in inetc::get call</blockquote>and it works...</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">TrifonovS</span><br><span class="post-time small text-muted">21st November 2013 18:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">That's right! I really forgot that I have to use an Unicode version of the plug-in. Thanks a lot and sorry for my mistake.</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
    hljs.initHighlightingOnLoad();
    //]]></script></div></body></html>