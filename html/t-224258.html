<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="$DOCUMENTS does not change to Shared Documents with SetShellVarContext" />

  <title>$DOCUMENTS does not change to Shared Documents with SetShellVarContext - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">$DOCUMENTS does not change to Shared Documents with SetShellVarContext</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=224258">$DOCUMENTS does not change to Shared Documents with SetShellVarContext</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">timbuck</span><br />
      <span class="post-time small text-muted">19th August 2005 13:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>$DOCUMENTS does not change to Shared Documents with SetShellVarContext</strong><br />
      Hi there, I've tried to find the answer on this website with no luck, although I am pretty sure someone else must have seen this. :)<br />
      <br />
      I want to install some files to the 'shared documents' folder.<br />
      <br />
      The documentation says...<br />
      <br /></p>

      <blockquote>
        $DOCUMENTS<br />
        <br />
        The documents directory. A typical path for the current user is C:\Documents and Settings\Foo\My Documents. The context of this constant (All Users or Current user) depends on the SetShellVarContext setting. The default is the current user.
      </blockquote>But if I compile the following script and run it on NT4 or XP PRO I only get the users documents folder. Strangely it works on XP Home.<br />
      <br />
      <pre>
<code><br />Name "Test"<br />OutFile "Setup.exe"<br /><br />Function .onInit<br />   MessageBox MB_OK "$DOCUMENTS"<br />   MessageBox MB_OK "$SMPROGRAMS"<br /><br />   SetShellVarContext "all"<br />   MessageBox MB_OK "$DOCUMENTS"<br />   MessageBox MB_OK "$SMPROGRAMS"<br />FunctionEnd<br /><br />Section "default"<br />SectionEnd<br /></code>
</pre><br />
      <br />
      (I should add that $SMPROGRAMS functions correctly, but not $DOCUMENTS)<br />
      <br />
      Does anyone know why this is, or is there a suggested workaround?<br />
      <br />
      From a C++ windows API point of view the Shared Documents file does exist on these systems and is retrieved by a call to SHGetSpecialFolderPath(...) so I am not sure why $DOCUMENTS would differ from this.<br />
      <br />
      I'd just like to add that I really have preffered NSIS over other certain offerings that do a lot of (irritating) things by default and you spend ages trying to turn it all off. NSIS on the other hand just does what you tell it to. Nice. ;)
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">timbuck</span><br />
      <span class="post-time small text-muted">19th August 2005 14:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well... I've had to come up with a workaround that uses a new method in our plugin dll (taken from the example exdll).<br />
      <br />
      I'd still like to know if I could avoid it though!<br />
      <br />
      Here is the workaround<br />
      <br />
      C++:<br /></p>
      <pre>
<code><br />void __declspec(dllexport) GetSharedFolderLocation<br />   (<br />   HWND hwndParent,          // <br />   int string_size,          // <br />   char *variables,          // <br />   stack_t **stacktop,       // <br />   extra_parameters *extra   // <br />   ) <br />{<br />   g_hwndParent=hwndParent;<br />   <br />   EXDLL_INIT();<br /> <br />   // do your stuff here<br />   {<br />      // Get the Shared Folder<br />      // get path of Shared Documents<br />      char sharedDocsPath[MAX_PATH];<br />      SHGetSpecialFolderPath(NULL, sharedDocsPath, CSIDL_COMMON_DOCUMENTS, 0);<br />      pushstring( sharedDocsPath );<br />   }<br />}<br /><br /></code>
</pre><br />
      <br />
      NSIS:<br />
      <pre>
<code><br />   utils::GetSharedFolderLocation<br />   Pop $0<br />   MessageBox MB_OK "$0"<br /></code>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">19th August 2005 16:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">$DOCUMENTS is implanted using SHGetSpecialFolderLocation with CSIDL_COMMON_DOCUMENTS, which should be no different. I have no idea why it should work differently at all, and specifically on different versions of XP. We can not use SHGetSpecialFolderPath because it's not available on all supported versions of Windows.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">timbuck</span><br />
      <span class="post-time small text-muted">19th August 2005 21:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi, thanks for your reply!<br />
      <br />
      That IS strange, I am going to do a little test and I'll post the results on monday when I can get to the other machines.<br />
      <br />
      Apparently a quick read suggests SHGetFolderPath superceded both of our functions with Win 2000/ME and it looks like it exists in both Shfolder.dll and Shell32.dll depending on what you link with I think. I wonder if one function is linking into one and the other into the other?<br />
      <br />
      Thankfully, I am ok to call this function during the installation because we install the shfolder.dll redistributable (shfolder.exe) before we call it.<br />
      <br />
      Anyway, I'll let you know what the other Shell functions are returning on these machines when I get back in to work!<br />
      <br />
      (I am probably unlucky and our systems dept have our machines setup weirdly! We'll see.)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">timbuck</span><br />
      <span class="post-time small text-muted">19th August 2005 21:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Just thought, I hadn't installed the ShFolder.dll on the NT box before running the test, which may explain it's behavior, but that still leaves me with the XP Pro/Home mystery.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
