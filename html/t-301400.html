<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Migration from 2.41 to 2.42 failed" />

  <title>Migration from 2.41 to 2.42 failed - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Migration from 2.41 to 2.42 failed</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=301400">Migration from 2.41 to 2.42 failed</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Theresias</span><br />
      <span class="post-time small text-muted">25th December 2008 13:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Migration from 2.41 to 2.42 failed</strong><br />
      First of all, once again thank you for an awesome tool which (once you put some work and thinking in your scripts) does exactly whats needed while being slim and simple for the end user. :up:<br />
      <br />
      Now to the part where I have to ask for help. ;)<br />
      <br />
      Even though we are using NSIS for a couple of years now, I have never come across a problem like this. My script works fine with NSIS 2.41 and it even compiles just fine with 2.42 but once you run it the installer claims to be "incomplete/broken".<br />
      <br />
      Since there is no real run-time debugging, I frustrated myself with testing for quite a while and apparently this seems to be related to my installation directory or (which I think is more likely) the variables I am using to specify it.<br />
      <br />
      I have read the release notes for 2.42 and came across the part with the plugins as well as header functions and their declaration. Sadly I was not able to find any details on the header function part.<br />
      <br />
      P.S.: Please excuse me not posting the script itself since I am reluctant to do so, but if you want specific parts from it I am sure I can supply them.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">25th December 2008 13:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">It would help if you could narrow down the problem a bit, and maybe come up with a minimal example that reproduces the problem</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">gbpa005</span><br />
      <span class="post-time small text-muted">25th December 2008 16:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Me too</strong><br />
      I have the same problem. I use Eclipse with EclipseNSIS, but compiling the scripts with HMNSIEdit as well generates corrupt installers (Vista). I tried several different installation scripts (absolutely standard installers without any special function): The compilation with 2.41 is absolutely fine and there is no error message with 2.42. When starting the installer, Vista comes up with a "No valid Win32 application"-Error message. Switching back to 2.41 solves the problem.<br />
      If there is additional information, that I can give you (logs etc.), please let me know.<br />
      <br />
      Bye<br />
      <br />
      <br />
      P.S.: A simple autogenerated sample script (EclipseNSIS), that as well causes the problem:<br /></p>

      <blockquote>
        # Auto-generated by EclipseNSIS Script Wizard<br />
        # 25.12.2008 16:58:26<br />
        <br />
        Name "My Application"<br />
        <br />
        # General Symbol Definitions<br />
        !define REGKEY "SOFTWARE\$(^Name)"<br />
        <br />
        # MUI Symbol Definitions<br />
        !define MUI_ICON "${NSISDIR}\Contrib\Graphics\Icons\modern-install-colorful.ico"<br />
        !define MUI_FINISHPAGE_NOAUTOCLOSE<br />
        !define MUI_STARTMENUPAGE_REGISTRY_ROOT HKLM<br />
        !define MUI_STARTMENUPAGE_NODISABLE<br />
        !define MUI_STARTMENUPAGE_REGISTRY_KEY ${REGKEY}<br />
        !define MUI_STARTMENUPAGE_REGISTRY_VALUENAME StartMenuGroup<br />
        !define MUI_STARTMENUPAGE_DEFAULTFOLDER "My Application"<br />
        !define MUI_UNICON "${NSISDIR}\Contrib\Graphics\Icons\modern-uninstall-colorful.ico"<br />
        !define MUI_UNFINISHPAGE_NOAUTOCLOSE<br />
        <br />
        # Included files<br />
        !include Sections.nsh<br />
        !include MUI2.nsh<br />
        <br />
        # Variables<br />
        Var StartMenuGroup<br />
        <br />
        # Installer pages<br />
        !insertmacro MUI_PAGE_WELCOME<br />
        !insertmacro MUI_PAGE_DIRECTORY<br />
        !insertmacro MUI_PAGE_STARTMENU Application $StartMenuGroup<br />
        !insertmacro MUI_PAGE_INSTFILES<br />
        !insertmacro MUI_PAGE_FINISH<br />
        !insertmacro MUI_UNPAGE_CONFIRM<br />
        !insertmacro MUI_UNPAGE_INSTFILES<br />
        <br />
        # Installer languages<br />
        !insertmacro MUI_LANGUAGE German<br />
        <br />
        # Installer attributes<br />
        OutFile setup.exe<br />
        InstallDir "$PROGRAMFILES\My Application"<br />
        CRCCheck on<br />
        XPStyle on<br />
        ShowInstDetails show<br />
        InstallDirRegKey HKLM "${REGKEY}" Path<br />
        ShowUninstDetails show<br />
        <br />
        # Installer sections<br />
        Section -Main SEC0000<br />
        SetOutPath $INSTDIR<br />
        SetOverwrite on<br />
        File "C:\Program Files\Eclipse\notice.html"<br />
        WriteRegStr HKLM "${REGKEY}\Components" Main 1<br />
        SectionEnd<br />
        <br />
        Section -post SEC0001<br />
        WriteRegStr HKLM "${REGKEY}" Path $INSTDIR<br />
        SetOutPath $INSTDIR<br />
        WriteUninstaller $INSTDIR\uninstall.exe<br />
        !insertmacro MUI_STARTMENU_WRITE_BEGIN Application<br />
        SetOutPath $SMPROGRAMS\$StartMenuGroup<br />
        CreateShortcut "$SMPROGRAMS\$StartMenuGroup\Uninstall $(^Name).lnk" $INSTDIR\uninstall.exe<br />
        !insertmacro MUI_STARTMENU_WRITE_END<br />
        WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" DisplayName "$(^Name)"<br />
        WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" DisplayIcon $INSTDIR\uninstall.exe<br />
        WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" UninstallString $INSTDIR\uninstall.exe<br />
        WriteRegDWORD HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" NoModify 1<br />
        WriteRegDWORD HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" NoRepair 1<br />
        SectionEnd<br />
        <br />
        # Macro for selecting uninstaller sections<br />
        !macro SELECT_UNSECTION SECTION_NAME UNSECTION_ID<br />
        Push $R0<br />
        ReadRegStr $R0 HKLM "${REGKEY}\Components" "${SECTION_NAME}"<br />
        StrCmp $R0 1 0 next${UNSECTION_ID}<br />
        !insertmacro SelectSection "${UNSECTION_ID}"<br />
        GoTo done${UNSECTION_ID}<br />
        next${UNSECTION_ID}:<br />
        !insertmacro UnselectSection "${UNSECTION_ID}"<br />
        done${UNSECTION_ID}:<br />
        Pop $R0<br />
        !macroend<br />
        <br />
        # Uninstaller sections<br />
        Section /o -un.Main UNSEC0000<br />
        Delete /REBOOTOK $INSTDIR\notice.html<br />
        DeleteRegValue HKLM "${REGKEY}\Components" Main<br />
        SectionEnd<br />
        <br />
        Section -un.post UNSEC0001<br />
        DeleteRegKey HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)"<br />
        Delete /REBOOTOK "$SMPROGRAMS\$StartMenuGroup\Uninstall $(^Name).lnk"<br />
        Delete /REBOOTOK $INSTDIR\uninstall.exe<br />
        DeleteRegValue HKLM "${REGKEY}" StartMenuGroup<br />
        DeleteRegValue HKLM "${REGKEY}" Path<br />
        DeleteRegKey /IfEmpty HKLM "${REGKEY}\Components"<br />
        DeleteRegKey /IfEmpty HKLM "${REGKEY}"<br />
        RmDir /REBOOTOK $SMPROGRAMS\$StartMenuGroup<br />
        RmDir /REBOOTOK $INSTDIR<br />
        SectionEnd<br />
        <br />
        # Installer functions<br />
        Function .onInit<br />
        InitPluginsDir<br />
        FunctionEnd<br />
        <br />
        # Uninstaller functions<br />
        Function un.onInit<br />
        ReadRegStr $INSTDIR HKLM "${REGKEY}" Path<br />
        !insertmacro MUI_STARTMENU_GETFOLDER Application $StartMenuGroup<br />
        !insertmacro SELECT_UNSECTION Main ${UNSEC0000}<br />
        FunctionEnd
      </blockquote>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Theresias</span><br />
      <span class="post-time small text-muted">25th December 2008 16:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by Anders</i><br />
        <b>It would help if you could narrow down the problem a bit, and maybe come up with a minimal example that reproduces the problem</b>
      </blockquote>I'll try but since the whole script is rather complicated by now stripping it is not so easy. So far my guess is that the problem is related to directly or file operations in my case since it only happens when creating shortcuts or creating/copying to the installation directory.<br />
      <br />
      The exact error message in my case is "BeschÃ¤digtes Installations-Programm: ungÃ¼ltiger Befehlscode", which resembles "Damaged installation program: invalid operating code". Interesting though, the error occurs in different parts of the procedure depending on the operating system. On Windows Vista x64 is crashes earlier than for example Windows 98.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">25th December 2008 23:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Can you attach an example of a corrupt installer? I need the executable itself, not the script. Also, I'd try disabling any anti-virus programs just to make sure it's not a problem with a false positive.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">gbpa005</span><br />
      <span class="post-time small text-muted">26th December 2008 08:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Here is an example: <a href="http://www.wolfgang.lenhard*******setup.exe" target="_blank">www.wolfgang.lenhard*******setup.exe</a></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">26th December 2008 10:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">gbpa005, it seems you're using old stubs with new plug-ins. Your stub doesn't have the new plug-in API in it. Are you sure you've properly installed everything? Try a complete uninstall and reinstall and make sure the NSIS folder is empty between them. Note that this will delete any special plug-ins you've installed into C:\Program Files\NSIS\Plugins, so back them up first.<br />
      <br />
      Theresias, your problem is even more bizarre and my best theory for it is the anti-virus. A compiled installer would help best at understanding this.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">gbpa005</span><br />
      <span class="post-time small text-muted">26th December 2008 14:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi Kichik,<br />
      I did a complete reinstall of NSIS, but the problem stays the same: http://www.wolfgang.lenhard*******setup2.exe<br />
      I did not install any plugins, just a clean installation from the sourceforge NSIS installer.<br />
      <br />
      Bye,<br />
      Wolfgang</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">26th December 2008 18:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Your stubs are still from the old version. Make sure C:\Program Files\NSIS\Stubs is clean before you reinstall. The stubs should have the following md5 sums:</p>
      <pre>
<code>f18bd2eba1b69083c7eea0e1f7080332 *bzip2<br />3d72747ff56ee61e3703911ef6207905 *bzip2_solid<br />116f5484e2b8e877d4115cb8af5df10f *lzma<br />21b89230e9b293d8cdf1618da17f63b9 *lzma_solid<br />f3885e2b42ee5b16289d12ff1790b48f *zlib<br />7afcb25acd4f874a7fe6b29b90b9699c *zlib_solid</code>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">gbpa005</span><br />
      <span class="post-time small text-muted">26th December 2008 19:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I completely deleted the NSIS folder (and all stubs) before reinstalling and I tried so several times. Unless Vista is hiding something from me, the wrong stubs come with the current installer.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">26th December 2008 20:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I used the current installer to get those md5 sums. Maybe you're using stubs from a different folder by mistake. Try opening C:\Program Files\NSIS\makensisw.exe manually instead of using any shortcuts.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">gbpa005</span><br />
      <span class="post-time small text-muted">28th December 2008 18:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Ok, it was the usual Vista confusion. There had been a directory under VirtualStore, that contained the old stubs. This might pose a problem for a good number of people, who are updating from an older NSIS version. Deleting the folder "VirtualStore\Program Files\NSIS" solves the problem.<br />
      <br />
      Bye,<br />
      Wolfgang</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Theresias</span><br />
      <span class="post-time small text-muted">29th December 2008 01:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">kichik, I put our faulty installer online and sent you a link via PM. Thanks for taking the time to look into it.<br />
      <br />
      BTW: I'm very certain this is not anti-virus related since some of the test systems we are using are running in a virtual environment without any protection of some sort. Also haven't totally reinstalled NSIS yet as suggested with gbpa005's problem, will try that tomorrow.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
