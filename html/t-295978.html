<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Rollback"><title>Rollback - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Rollback</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=295978">Rollback</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">urugan</span><br><span class="post-time small text-muted">15th August 2008 12:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Rollback</strong><br>Hello everybody, it's my first post.<br>I'm doing evaluation on nsis and inno to choose the one that suits me more.<br>I've read and seen enough, just need one last question answered.<br>Does NSIS supports rollback functionality?<br>I mean, if I have a scenario of upgrade, which contains copying a lot of files over existing installation and after that calling some sophisticated sql scripts, which can fail, will it be possible to (depending on sql actions outcome) rollback the whole installation to the point before upgrade?<br>I am pretty sure Inno has it.<br>p.s.<br>I don't want no flamewar, just a simple answer, perhaps with some links.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">urugan</span><br><span class="post-time small text-muted">15th August 2008 17:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">oh come on!<br>Nobody?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">15th August 2008 18:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">no, there is no rollback, you could copy the original files to a backupdir and "restore" from that if needed</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">urugan</span><br><span class="post-time small text-muted">15th August 2008 19:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">thx man.<br>I was already trying this route.<br>In my case it also means copying a db. But it should be do-able...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">15th August 2008 19:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">This might help you:<br><a href="http://nsis.sourceforge.net/Backup_files_on_install,_restore_on_uninstall" target="_blank">http://nsis.sourceforge.net/Backup_f...e_on_uninstall</a><br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Andrew Wallo</span><br><span class="post-time small text-muted">20th August 2008 21:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>rollback.nsh</strong><br>I'm working on a nice rollback include. ( Aptly titled rollback.nsh ) Just a set of macros really, but it sets up a log that can be saved to a provided path.... builds the log...as you install or edit files and registry entries... and when you're done you close the "session". Then later you could come back and execute the rollback.<br><br>Works well for my application which can't really depend on having a clean folder for its files. So 'rollback' means recopying whatever files I detect that I've stepped on, back into the working folder on a rollback. ( Essentially parsing the log file... for FILE entries, and putting it back where the PATH attribute says to go. )<br><br>Maybe we should include a log for SQL calls to? Or better a log to execute SQL files against a database... that might abstract your issue better.<br><br>It'd be ready for a demo as a general include, except that I'd like to include the ability to tie in a CallBack on a failed copy.... i.e. If you tried to restore a file it was tied up or something. Currently I have a string that gets read from the log file and passed to ExecWait but that's just a bit limiting and somewhat impractical. I'd rather be able to read a string from the log file and call back a function in the NSIS script... like so:<br><br>Function handleErrorWithCustomCallback<br>MessageBox MB_OK "Handled Error."<br>FunctionEnd<br><br>## SNIP ##<br>## In some Section or function...<br>ReadFile $myFile $myCallBackString ; blah blah blah<br>## myCallBackString now has "handleErrorWithCustomCallback"<br><br>Call $myCallBackString ; but this isn't resolving....<br>; macros seem to do something like this with ${_label} but not quite....<br><br>The lack of runtime binding/resolution seems to not resolve this.... or maybe I'm not resolving the var's contents like I should be.... any comments Stu?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">20th August 2008 23:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Try using GetFunctionAddress.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Andrew Wallo</span><br><span class="post-time small text-muted">21st August 2008 02:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Not the answer.... still requries compile time binding.</strong><br>Sadly, that doesn't seem to work.... for example....<br><br>Function testCallback<br>MessageBox MB_OK "Called it"<br>FunctionEnd<br><br><br>;--------------------------------<br>; There are no sections or pages in this installer. It just executes the .onInit and closes.<br>;<br>Function .onInit<br>var /GLOBAL testTheCallback<br>StrCmp "1" "0" 0 +2<br>call testCallback ; this so it doesn't zero the code.<br><br>MessageBox MB_OK "Testing callback:"<br>StrCpy $testTheCallback "testCallback"<br>GetFunctionAddress $R1 $testTheCallback ;Doesnt' work.<br><br>###<br>## WORKS: GetFunctionAddress $R1 "testCallback"<br>## BUT SINCE ITS READING IT FROM A FILE ITS NOT USEFUL.<br>#######################################################<br>Call $R1<br>FunctionEnd<br><br><br>GetFunctionAddress seems to want the literal function name entered, not some variable.....</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br><span class="post-time small text-muted">21st August 2008 13:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The actual names of function and variables are not included in the compiled installer.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Andrew Wallo</span><br><span class="post-time small text-muted">21st August 2008 17:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>agreed......</strong><br>Considering that we're sort of operating in an Assembly like stack mentality... I understand that the nice readable names get stored merely as a memory location.<br><br>Are you saying that there is no runtime-linking to functions based on an evaluated string? i.e...... something like this in a javascript mentality might look like.... ( during runtime... obviously )<br><br>myVar = eval("customFunctionName");<br><br>Thus, we could use a line like to this to interpret text files into operating instructions at runtime... such as a call back function for some condition.<br><br><font color="darkblue">What you are saying is that there is no way to reference that function abstractly in code during runtime?</font></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">mgillespie</span><br><span class="post-time small text-muted">16th April 2010 08:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Sorry to bump an old thread, but I did have something to contribute.<br><br>We are using quite an old version of NSIS, (2.14), with some custom modifications to the NSIS code to provide a primitive (but works for us) automated rollback system.<br><br>Deep down in the NSIS core, where the file is actually written to disk, before the write is actually done, we check to see if it already exists, if it does, we append the existing filename with the .previous extension and then write the new file. On uninstall, it's simply a process of recursively scanning the installation folder, if we find a .previous, delete the original file and restore the .previous version.<br><br>The whole .previous creation process can be enabled or disabled during the script execution by setting $R9 (this clearly could be improved to make it a keyword)<br><br>Anyone want the patch? (the reason we are still using NSIS 2.14 is because of the source changes we made, we don't see any issues with this old NSIS version, and don't want to constantly merge our NSIS, so there is a benefit for us if we can get this patch, or equivalent functionality into NSIS, so we can use standard NSIS)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">16th April 2010 08:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">There is no need to edit the NSIS sourcecode to get this behaviour. It's extremely simple to do this in script alone. I therefore very much doubt that your patch will be merged into the trunk.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Animaether</span><br><span class="post-time small text-muted">16th April 2010 12:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote>It's extremely simple to do this in script alone.</blockquote>Since when? :x<br><br>Not that I'm advocating this patch per se - but unless I missed something, you're going to need quite a bit of code to actually get this sort of behavior out of NSIS. There's probably examples in the wiki that make it easier because you don't have to come up with something from scratch*, but...<br><br>For single files, you'd have to define a macro that replaces the File command you'd normally use which...<br>1. Checks if the file exists<br>2. If it does, creates a backup*<br>3. Tries to overwrite the file<br>3a. If it succeeds - great, done<br>3b.1 If not, delete the backup<br>3b.2 Catch the error with custom handling if desired (see some other thread on this)<br>* and in the backup section check if you can actually back up to the location you want to back up to.<br><br>And that's single files. As soon as you use the File command to include multiple files or files recursively, you have to either... A. Drop that construction entirely and make a pre-installer build installer that generates a file inclusion list for the actual installer, or B. First extract the files to a temporary location and instead of using the File command to place the files directly, find the files that were created in the temporary location and use CopyFiles and CreateDirectory instead (further handling is similar to the above).<br><br>You'd need these as separate macros as well - or as a single macro but for 'single file' calls you'd have to explicitly indicate that it is such. e.g.<br>!macro macroname source dest recursive<br>For a single file would always have to specify the 'recursive' bit as being 'false', '0', or whatever one chooses.<br>This applies for every parameter in the File command that you'd want to support. Adding support for /x (exclude files) means adding another parameter... now a single file call might end up looking like:<br>${macroname} "somefile.ext" "$InstDir\somefile.ext" 0 0<br>Alternatively you'd have to define them before your call.. or callS in which case you have to make sure you don't forget to undefine them afterward.. etc.<br><br>It's not impossible, but 'extremely simple' is not how I would choose to describe it in general ;)</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">16th April 2010 15:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by Animaether</small><br>It's not impossible, but 'extremely simple' is not how I would choose to describe it in general ;)</blockquote>I was referring to the fact that it mostly requires just a bunch of ${If} statements, which are trivial to code if you're clearheaded enough. But sure, I stand corrected, it takes some effort to get it exactly right. :-)<br><br>(You could of course make two macros, one single and one recursive/wildcard...)</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Animaether</span><br><span class="post-time small text-muted">16th April 2010 16:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by MSG</small><br>(You could of course make two macros, one single and one recursive/wildcard...)</blockquote>Well that's something I addressed toward the end... now you want to support /x as well.<br>So now you need macros:<br>File<br>FileR<br>FileX<br>FileRX<br><br>Now add /a and /nonfatal ;) Granted, those are a little more obscure, but you can see how things quickly tend to explode into a number of macros. Hence why instead one might have something like a context switch...<br>${NonFatal} true<br>${FileSomething} a x ...<br>${FileSomething} b x ...<br>${FileSomething} c x ...<br>${NonFatal} False<br><br>But you phrased it well when you said<blockquote>it takes some effort to get it exactly right. :-)</blockquote>:)</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">mgillespie</span><br><span class="post-time small text-muted">27th April 2010 15:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">And this was precisely the reason we decided on a change deep down at file writing level, as it works regardless of how the file is added to the installer :-)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Animaether</span><br><span class="post-time small text-muted">27th April 2010 16:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by mgillespie</small><br>And this was precisely the reason we decided on a change deep down at file writing level, as it works regardless of how the file is added to the installer :-)</blockquote>Only to an extent, though, if I read your original post right:<br><blockquote>Originally Posted by <strong>mgillespie</strong> We check to see if it already exists, if it does, we append the existing filename with the .previous extension and then write the new file.</blockquote>So what if filename.previous already exists?<br><br><blockquote>Originally Posted by <strong>mgillespie</strong> On uninstall, it's simply a process of recursively scanning the installation folder, if we find a .previous, delete the original file and restore the .previous version.</blockquote>And what if 'the original' is not actually -your- original?<br><br>Doing it 'right' will never be easy - if even possible at all - but there's certainly room for improvement.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">mathrick</span><br><span class="post-time small text-muted">27th April 2011 17:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by Andrew Wallo</small><br>I'm working on a nice rollback include. ( Aptly titled rollback.nsh ) Just a set of macros really, but it sets up a log that can be saved to a provided path.... builds the log...as you install or edit files and registry entries... and when you're done you close the "session". Then later you could come back and execute the rollback.</blockquote><blockquote>It'd be ready for a demo as a general include, except that I'd like to include the ability to tie in a CallBack on a failed copy.... i.e. If you tried to restore a file it was tied up or something. Currently I have a string that gets read from the log file and passed to ExecWait but that's just a bit limiting and somewhat impractical. I'd rather be able to read a string from the log file and call back a function in the NSIS script... like so:<br><br>Function handleErrorWithCustomCallback<br>MessageBox MB_OK "Handled Error."<br>FunctionEnd<br><br>## SNIP ##<br>## In some Section or function...<br>ReadFile $myFile $myCallBackString ; blah blah blah<br>## myCallBackString now has "handleErrorWithCustomCallback"<br><br>Call $myCallBackString ; but this isn't resolving....<br>; macros seem to do something like this with ${_label} but not quite....<br><br>The lack of runtime binding/resolution seems to not resolve this.... or maybe I'm not resolving the var's contents like I should be.... any comments Stu?</blockquote>Any progress on that? I've coded a macro-based semi-solution which allows registering "callback groups", each containing up to 16 callbacks. See callback.nsh for code, and testcallback.nsi for an example of usage. In exchange I'd really like to see your rollback code :)</div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>