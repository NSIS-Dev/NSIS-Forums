<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Using chngvrbl.dll to set $PLUGINSDIR"><title>Using chngvrbl.dll to set $PLUGINSDIR - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Using chngvrbl.dll to set $PLUGINSDIR</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=242800">Using chngvrbl.dll to set $PLUGINSDIR</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">torpark</span><br><span class="post-time small text-muted">6th April 2006 16:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Using chngvrbl.dll to set $PLUGINSDIR</strong><br>I am trying to use chngvrbl.dll to set the $PLUGINSDIR variable. The reason for this is my program runs on a USB keychain, and I don't want it to write any files to the hard drive, not even temporarily. I want them all on the USB drive.<br><br>However, I am less than brilliant at NSIS, and I could use some help. The code seems to only work for chngvrbl.dll, the other DLLs I call are all still written to the c:..\temp dir. So this implies that $PLUGINSDIR is not actually being changed:<br><br>ProfileFound:<br>StrCpy $9 "$EXEDIR"<br>SetOutPath $9<br>File /oname=$9\chngvrbl.dll ${NSISDIR}\Plugins\chngvrbl.dll"<br>Push $9<br>Push 25<br>CallInstDLL "$9\chngvrbl.dll" changeVariable<br><br>LaunchProgram:<br>ExecDos::exec /NOUNLOAD /ASYNC `"$TORDIRECTORY\tor.exe" -f "$TORDIRECTORY\torrc"`<br>FindProcDLL::FindProc "firefox.exe"<br><br><br>ExecDos and FindProcDLL are still being written to C:, solution? What am I doing wrong?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">6th April 2006 18:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Well it would be better probably to use CallInstDll to call all the other plugins as well.<br>You'll have to make a modified copy of Modern UI's Contrib\Modern UI\System.nsh and change it all in there as well. Modern UI also places ioSpecial.ini in there as well, so you could probably just replace $PLUGINSDIR with a different variable and remove any InitPluginsDir instructions. Sounds like a lot of work, but at the end of the day it's less installer overhead.<br><br>-Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">torpark</span><br><span class="post-time small text-muted">6th April 2006 18:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I think what I'm using is already modified for this specific purpose. I just can't seem to implement it correctly. Here is the thread:<br><a href="http://forums.winamp.com/showthread.php?s=&amp;threadid=179738&amp;highlight=%24pluginsdir" target="_blank">http://forums.winamp.com/showthread....=%24pluginsdir</a><br><br>Here is the file:<br><a href="http://nsis.sourceforge.net/wiki/Change_Variable_Plugin" target="_blank">http://nsis.sourceforge.net/wiki/Change_Variable_Plugin</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">6th April 2006 18:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Try calling InitPluginsDir before StrCpy $9 "$EXEDIR"<br><br>-Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">torpark</span><br><span class="post-time small text-muted">6th April 2006 19:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Still not working. It is like $PLUGINSDIR isn't getting changed at all. Only that CallIstDLL is writing chngvrbl.dll to $9.<br><br>InitPluginsDir<br><br>StrCpy $9 "$EXEDIR"<br>SetOutPath $9<br>File /oname=$9\chngvrbl.dll "${NSISDIR}\Plugins\chngvrbl.dll"<br>Push $9<br>Push 25 ; $PLUGINSDIR<br>CallInstDLL "$9\chngvrbl.dll" changeVariable<br>File /oname=$PLUGINSDIR\splash.jpg "${NAME}.gif"<br>newadvsplash::show /NOUNLOAD 16000 400 400 -1 /L $PLUGINSDIR\splash.jpg</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">torpark</span><br><span class="post-time small text-muted">6th April 2006 19:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">InitPluginsDir has no effect.<br>After having the message box popup, it still tells me it is in the c: temp:<br><br>StrCpy $9 "$EXEDIR"<br>SetOutPath $9<br>File /oname=$9\chngvrbl.dll "${NSISDIR}\Plugins\chngvrbl.dll"<br>Push $9<br>Push 25 ; $PLUGINSDIR<br>CallInstDLL "$9\chngvrbl.dll" changeVariable<br>MessageBox MB_OK|MB_ICONINFORMATION `The Pluginsdir is now $PLUGINSDIR`</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">torpark</span><br><span class="post-time small text-muted">6th April 2006 19:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Infact, the Pluginsdir is C:\DOCUME~1\...\Temp\nsq8C1.tmp<br><br>It seems that it is compiling as a solid file, instead of a directory. But wait, I checked the compiler and I am only using regular compression, not solid compression. So it should be decompressing into a file. So I checked the script, there is no set compression in there either. So... why is it writing a compressed directory as a file?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">galil</span><br><span class="post-time small text-muted">6th April 2006 20:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Um, do the<br>InitPluginsDir<br>right after you call the chngvrbl.dll to change the $PLUGINSDIR.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">6th April 2006 20:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">%TEMP%\nsq8C1.tmp <b>is</b> a directory. Directory names can half dots in as well :p<br><br>galil is correct. If you place InitPluginsDir right after the plugin call, $PLUGINSDIR will be set to [my path]\ns####.tmp<br><br>-Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">torpark</span><br><span class="post-time small text-muted">6th April 2006 20:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">chgvrbl.dll is written to $EXEDIR, but splash and the rest of my files are still written to C:\%TEMP%<br><br>And messagebox still says $PLUGINSDIR is %TEMP%<br><br>ProfileFound:<br>;=== Show the splash screen before processing the files<br><br>StrCpy $9 "$EXEDIR"<br>SetOutPath $9<br>File /oname=$9\chngvrbl.dll "${NSISDIR}\Plugins\chngvrbl.dll"<br>Push $9<br>Push 25 ; $PLUGINSDIR<br>CallInstDLL "$9\chngvrbl.dll" changeVariable<br>InitPluginsDir<br>MessageBox MB_OK|MB_ICONINFORMATION `The Pluginsdir is now $PLUGINSDIR`<br><br>File /oname=$PLUGINSDIR\splash.jpg "${NAME}.gif"<br>newadvsplash::show /NOUNLOAD 16000 400 400 -1 /L $PLUGINSDIR\splash.jpg</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">6th April 2006 20:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I guess you've got the code in the wrong place. I'm guessing that Modern UI calls InitPluginsDir internally as well. If InitPluginsDir is called before your code snippet then no doubt it won't work. Where are you using your code? Move it to .onInit.<br><br>-Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">torpark</span><br><span class="post-time small text-muted">6th April 2006 20:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">It has been moved to the beginning, right after the variables and before the main section. $PLUGINSDIR is still %TEMP%.<br><br>...<br>Var INIPATH<br>Var ISFILELINE<br><br><br>Function .onInit<br><br>StrCpy $9 "$EXEDIR"<br>SetOutPath $9<br>File /oname=$9\chngvrbl.dll "${NSISDIR}\Plugins\chngvrbl.dll"<br>Push $9<br>Push 25 ; $PLUGINSDIR<br>InitPluginsDir<br>CallInstDLL "$9\chngvrbl.dll" changeVariable<br>MessageBox MB_OK|MB_ICONINFORMATION `The Pluginsdir is now $PLUGINSDIR`<br><br>FunctionEnd<br><br>Section "Main"<br>;=== Find the INI file, if there is one<br>IfFileExists "$EXEDIR\${NAME}.ini" "" CheckSubINI<br>StrCpy "$INIPATH" "$EXEDIR\"<br>Goto ReadINI<br>....</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">torpark</span><br><span class="post-time small text-muted">6th April 2006 21:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>FOUND THE SOLUTION</strong><br>InitPluginsDir was the problem. Don't need it!<br><br>Function .onInit<br>StrCpy $9 "$EXEDIR"<br>SetOutPath $9<br>File /oname=$9\chngvrbl.dll "${NSISDIR}\Plugins\chngvrbl.dll"<br>Push $9<br>Push 25 ; $PLUGINSDIR<br>CallInstDLL "$9\chngvrbl.dll" changeVariable<br>MessageBox MB_OK|MB_ICONINFORMATION `The Pluginsdir is now $PLUGINSDIR`<br>FunctionEnd<br><br>It works! Thanks for the help. I just needed to make sure it was inside .onInit, and that InitPluginsDir was never called.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">6th April 2006 21:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Well in the code you posted last you did have InitPluginsDir before the plugin call instead of after it. :p<br><br>-Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">7th April 2006 11:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">InitPluginsDir creates and sets $PLUGINSDIR. If you set it yourself, you don't need to call InitPluginsDir. However, variable number 25 is $TEMP and not $PLUGINSDIR, so you do need InitPluginsDir in order for $PLUGINSDIR to be created in your newly set $TEMP. $PLUGINSDIR is actually number 26, but it's a good thing that you set $TEMP and not $PLUGINSDIR. If you'd have set $PLUGINSDIR to $EXEDIR, $EXEDIR would have been deleted at the end of the installation. When you set $TEMP to $EXEDIR, InitPluginsDir will create a new folder inside $EXEDIR.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">torpark</span><br><span class="post-time small text-muted">12th April 2006 02:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>repercussions</strong><br>Now when I call a execdos plugin to run tor.exe, tor terminates instantly. If I remove the pluginsdir code<br>change, everything is normal again. Seems like the $PLUGINSDIR change code must have something wrong. Any ideas? (nsi included)<br><br>the tor.exe log:<br><br>Apr 11 20:22:18.640 [notice] Tor v0.1.1.14-alpha. This is experimental software. Do not rely on it for strong anonymity.<br>Apr 11 20:22:18.640 [notice] Initialized libevent version 1.1a+imweasel using method win32. Good.<br>Apr 11 20:22:18.640 [warn] Error creating directory tor\data: No such file or directory<br>Apr 11 20:22:18.640 [err] options_act_reversible(): Couldn't access/create private data directory "tor\data"<br>Apr 11 20:22:18.640 [err] tor_init(): Reading config failed--see warnings above. For usage, try -h.<br><br><br>Here is my code to call tor.exe:<br><br>ExecDos::exec /NOUNLOAD /ASYNC `"$EXEDIR\tor\tor.exe" -f "$EXEDIR\tor\torrc"` "" "$EXEDIR\execdos.log" ; Launch Tor<br><br><br>Here is my code for the pluginsdir change:<br><br>Function .onInit<br>StrCpy $9 "$EXEDIR\temp"<br>SetOutPath $9<br>File /oname=$9\chngvrbl.dll "${NSISDIR}\Plugins\chngvrbl.dll"<br>Push $9<br>Push 26 ; $PLUGINSDIR<br>CallInstDLL "$9\chngvrbl.dll" changeVariable<br>FunctionEnd</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">12th April 2006 11:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Try putting SetOutPath '$EXEDIR\tor' before ExecDos::exec.<br><br>-Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">torpark</span><br><span class="post-time small text-muted">13th April 2006 06:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Everything seemed to work out well. But occaisonally when I terminate the program, I get this error:<br><br>"The instruction at '0x0101130e' referenced memory at '0x0101130e'. The memory could not be 'read'.<br><br>Click on OK to terminate the program<br>Click on CANCEL to debug the program"<br><br>When I click cancel, nothing seems to happen. Ideas on how to debug or find out where it is coming from?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">13th April 2006 10:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Why are you terminating the program or are you trying to close it safely?<br><br>-Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">torpark</span><br><span class="post-time small text-muted">13th April 2006 14:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I figured it out. The last plugin I executed used NOUNLOAD and I was forcing it to unload. Problem fixed by calling it again without nounload and async.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Brummelchen</span><br><span class="post-time small text-muted">30th August 2008 18:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">That DLL is not working with NSIS 2.37<br></p><pre>
<code>;NSIS Modern User Interface version 1.70<br>;Basic Example Script<br>;Written by Joost Verburg<br><br>;--------------------------------<br>;Include Modern UI<br><br>  !include "MUI.nsh"<br><br>;--------------------------------<br>;General<br><br>  ;Name and file<br>  Name "Modern UI Test 1.70"<br>  OutFile "Basic.exe"<br><br>  ;Default installation folder<br>  InstallDir "$EXEDIR"<br>  <br>;--------------------------------<br>;Interface Settings<br><br>  !define MUI_ABORTWARNING<br><br>;--------------------------------<br>;Pages<br><br>  !insertmacro MUI_PAGE_COMPONENTS<br>  !insertmacro MUI_PAGE_DIRECTORY<br>  !insertmacro MUI_PAGE_INSTFILES<br>  <br>  !insertmacro MUI_RESERVEFILE_INSTALLOPTIONS<br>  <br>;--------------------------------<br>;Languages<br> <br>  !insertmacro MUI_LANGUAGE "English"<br>  <br>Function .onInit<br><br>  ; Use whatever you use to get the user defined temp parameter from $CMDLINE<br>  ;Push "/TEMP="<br>  ;Call GetParam<br>  ;Pop $0<br>  StrCpy $0 "c:\usertemp"<br><br>  ; If the user doesn't pass a parameter just let NSIS determine the $PLUGINSDIR<br>  StrCmp $0 "" nousertemp usertemp<br>     usertemp:<br>         SetOutPath $0<br>         File /oname=$0\chngvrbl_.dll "${NSISDIR}\Plugins\chngvrbl.dll"<br>         Push $0<br>         Push 25 ; $PLUGINSDIR<br>         CallInstDLL "$0\chngvrbl_.dll" changeVariable<br>         Delete "$0\chngvrbl_.dll"<br>         Goto show<br>     nousertemp:<br>         InitPluginsDir<br>     show:<br>     MessageBox MB_OK|MB_ICONINFORMATION "Pluginsdir: '$PLUGINSDIR'"<br><br>FunctionEnd<br><br>;--------------------------------<br>;Installer Sections<br><br>Section "Dummy Section" SecDummy<br><br>  SetOutPath "$INSTDIR"<br>  <br>  ;ADD YOUR OWN FILES HERE...<br>  <br>  ;Store installation folder<br>  ;WriteRegStr HKCU "Software\Modern UI Test" "" $INSTDIR<br>  <br>  ;Create uninstaller<br>  ;WriteUninstaller "$INSTDIR\Uninstall.exe"<br><br>SectionEnd<br><br>;--------------------------------<br>;Descriptions<br><br>  ;Language strings<br>  LangString DESC_SecDummy ${LANG_ENGLISH} "A test section."<br><br>  ;Assign language strings to sections<br>  !insertmacro MUI_FUNCTION_DESCRIPTION_BEGIN<br>    !insertmacro MUI_DESCRIPTION_TEXT ${SecDummy} $(DESC_SecDummy)<br>  !insertmacro MUI_FUNCTION_DESCRIPTION_END<br><br>;--------------------------------<br></code>
</pre><br>
      Return-Value is empty :(
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Brummelchen</span><br>
      <span class="post-time small text-muted">31st August 2008 03:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">#edit after above<br>
      i reinstalled nsis to get the original stubs and makensis.exe<br>
      - i use the 8192 bytes version. the script above does not work,<br>
      but mine do. why? at first - its not at the 8192 version, that<br>
      works too - its the InitPluginsDir after that.<br>
      first i had this:<br></p>
      <pre>
<code>Function plugins_dir<br>  StrCpy $0 "$EXEDIR"<br>  StrCmp $0 "" nousertemp<br>    SetOutPath $0<br>    File /oname=$0\chngvrbl.dll "${NSISDIR}\Plugins\chngvrbl.dll"<br>    Push $0<br>    Push 25 ; $PLUGINSDIR<br>    CallInstDLL "$0\chngvrbl.dll" changeVariable<br>    Delete "$0\chngvrbl.dll"<br>    StrCmp $PLUGINSDIR "" nousertemp<br>    Return<br>  nousertemp:<br>    InitPluginsDir<br>FunctionEnd<br></code>
</pre><br>
      now i have that<br>
      <pre>
<code>Function plugins_dir<br>  StrCpy $0 "$EXEDIR"<br>  StrCmp $0 "" nousertemp<br>    SetOutPath $0<br>    File /oname=$0\chngvrbl.dll "${NSISDIR}\Plugins\chngvrbl.dll"<br>    Push $0<br>    Push 25 ; $PLUGINSDIR<br>    CallInstDLL "$0\chngvrbl.dll" changeVariable<br>    Delete "$0\chngvrbl.dll"<br>  nousertemp:<br>    InitPluginsDir<br>FunctionEnd<br></code>
</pre><br>
      the content of pluginsdir is why ever emtpy after the change,<br>
      but after InitPluginsDir it has the right pointer to the subdir.<br>
      <br>
      In contrast to written<br>

      <blockquote>
        InitPluginsDir was the problem. Don't need it!
      </blockquote>its needed.<br>
      <br>
      Can someone explain it please?
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>