<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Cookies, take 2" />

  <title>Cookies, take 2 - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Cookies, take 2</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=205287">Cookies, take 2</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">DBecker</span><br />
      <span class="post-time small text-muted">18th January 2005 20:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Cookies, take 2</strong><br />
      Hello all,<br />
      We have created the following function that checks if specific cookies exist in the cookies folder (format: user@CookieName[3], user@CookieName[2], user@CookieName[1]. When a cookie is found it should take some text from within the cookie and plug it into the PC's registry.<br />
      The problem is that it doesn't work the first time and the only predictable way is to run the setup twice (with no uninstall after the first time). During the second install it works.<br />
      I am pasting the code here and would appreciate any ideas that users of this forum may have.<br />
      Thanks a lot,<br />
      David<br />
      <br />
      ---- CODE STARTS HERE ----<br />
      <br />
      ;Cookie read and record functions<br />
      <br />
      ; TrimNewlines<br />
      ; input, top of stack (e.g. whatever$\r$\n)<br />
      ; output, top of stack (replaces, with e.g. whatever)<br />
      ; modifies no other variables.<br />
      Function TrimNewlines<br />
      Exch $R0<br />
      Push $R1<br />
      Push $R2<br />
      StrCpy $R1 0<br />
      <br />
      loop:<br />
      IntOp $R1 $R1 - 1<br />
      StrCpy $R2 $R0 1 $R1<br />
      StrCmp $R2 "$\r" loop<br />
      StrCmp $R2 "$\n" loop<br />
      IntOp $R1 $R1 + 1<br />
      IntCmp $R1 0 no_trim_needed<br />
      StrCpy $R0 $R0 $R1<br />
      <br />
      no_trim_needed:<br />
      Pop $R2<br />
      Pop $R1<br />
      Exch $R0<br />
      FunctionEnd<br />
      <br />
      ;Will detect and register the Cookie in the registry<br />
      Function RegisterKBID<br />
      Push $R0<br />
      ;Search for the first cookie<br />
      FindFirst $R0 $R1 "$COOKIES\*.*"<br />
      Loop:<br />
      IfErrors Done<br />
      ;Find the most recent cookie - as the IE enumerates them by [x] value, while the biggest is the latest.<br />
      ;There shouldn't be more then 1, but for any case...<br />
      StrCpy $R2 $R1 "" -24<br />
      StrCmp $R2 "@testcookie[3].txt" OpenCookie<br />
      StrCmp $R2 "@testcookie[2].txt" OpenCookie<br />
      StrCmp $R2 "@testcookie[1].txt" 0 NextCookie<br />
      ;Open the cookie<br />
      OpenCookie:<br />
      FileOpen $R2 "$COOKIES\$R1" "r"<br />
      CookieLoop:<br />
      ClearErrors<br />
      ;Read the first line of the cookie<br />
      FileRead $R2 $R3<br />
      IfErrors CookieDone<br />
      <br />
      ;Find the cookie id<br />
      Push $R3<br />
      ;Trim the /r and /n characters<br />
      Call TrimNewLines<br />
      Pop $R3<br />
      ;See whether it's a valid cookie, i.e. it contains the KBID identifier<br />
      StrCmp $R3 "KBID" 0 CookieLoop<br />
      <br />
      ;Get the KBID value<br />
      FileRead $R2 $R3<br />
      Push $R3<br />
      ;Trim the /r and /n characters again<br />
      Call TrimNewLines<br />
      Pop $R3<br />
      <br />
      ;Write it in the registry<br />
      WriteRegStr HKLM "Software\TestCookie" "client_id" "$R3"<br />
      <br />
      CookieDone:<br />
      FileClose $R2<br />
      Goto Done<br />
      ;Go to the next cookie<br />
      NextCookie:<br />
      ClearErrors<br />
      FindNext $R0 $R1<br />
      Goto Loop<br />
      Done:<br />
      FindClose $R0<br />
      FunctionEnd</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">robber98</span><br />
      <span class="post-time small text-muted">19th January 2005 22:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Have you try "InternetGetCookieEx" from Wininet library? You can use system.dll to call this function and "retrieves data stored in cookies associated with a specified URL".<br />
      <br />
      FYI: <a href="http://msdn.microsoft.com/library/en-us/wininet/wininet/internetgetcookieex.asp?frame=true" target="_blank">http://msdn.microsoft.com/library/en...asp?frame=true</a> :)</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
