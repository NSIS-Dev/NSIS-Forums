<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="addtopath function doesnt work anymore" />

  <title>addtopath function doesnt work anymore - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">addtopath function doesnt work anymore</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=270992">addtopath function doesnt work anymore</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jweinraub</span><br />
      <span class="post-time small text-muted">11th May 2007 15:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>addtopath function doesnt work anymore</strong><br />
      i have used addtopath for some time, and it worked. now it seems it stopped working. did some new MS patch cause this not to work?<br />
      <br />
      if i manually add it, the remove it from path in the uninstaller works fine. the adding doesnt!<br />
      <br />
      Section "MainSection" SEC01<br />
      SetDetailsPrint textonly<br />
      DetailPrint "Installing My Special Software..."<br />
      SetDetailsPrint none<br />
      SetOutPath "$INSTDIR"<br />
      ; WTF - not working - and it should - really - it should !!!<br />
      Push $INSTDIR<br />
      Call AddToPath<br />
      Push "PATH"<br />
      Push $INSTDIR<br />
      Call AddToEnvVar</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jweinraub</span><br />
      <span class="post-time small text-muted">11th May 2007 16:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Also, I noticed it sorta works on a select set of machines. However, when it adds it to the environment path, it doesnt refresh, like that moment pause if one were to do it manually to activate it. one of my files that needs to register resides in the product directory and when the dll registers, it wont work because the dependencies are there, but the system doesnt know about it!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jweinraub</span><br />
      <span class="post-time small text-muted">11th May 2007 19:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Okay, another development. It still doesnt work on my desktop, but on my laptop, it adds the path, doesnt activate it still, and when i uninstall it gets removed. however, when i reinstall it, the path no longer gets added.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">13th May 2007 19:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Are you saying Explorer doesn't refresh its environment table? If you Start-&gt;Run-&gt;cmd-&gt;echo %PATH% after installation, you don't see it there?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jweinraub</span><br />
      <span class="post-time small text-muted">14th May 2007 14:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">On my desktop, nothing ever shows up for %PATH%.<br />
      On my laptop, after I uninstall it, it shows up in the path variable. It does not show up in the path variable if you right click the system properties, but it still shows up when I echo it.<br />
      <br />
      If I reboot the system, it finally removes itself from the path.<br />
      <br />
      After installing the software again, it does not show up it the %PATH% and after rebooting the system it does show up.<br />
      <br />
      I am using Windows XP SP2 on all systems. This has always worked in the past. Nothing has changed other than various MS patches and newer versions of the NSIS compiler. I do not know when this stopped working properly.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">14th May 2007 18:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I works perfectly fine for me with a fully patched Windows XP SP2. AddToPath checks for the existence of the directory and if it's already in the PATH before actually adding it. Make sure that the directory exists and that you run your test installer from explorer.exe and not makensisw.exe or any other IDE so the environment will be up-to-date. Also try a small test version of the script that just adds a directory.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jweinraub</span><br />
      <span class="post-time small text-muted">14th May 2007 19:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">As you can see in my above code I call it after the directory gets created. i tried putting it towards the bottom with the same problem.<br />
      <br />
      i run the setup.exe on two different laptops and both exhibit the same problem. one is a member of my corporate domain, and one is not.<br />
      <br />
      both have the same issues. both require a reboot for %PATH% to be updated when installed, and when uninstalled. the uninstalled doesnt bother me as much, but the install does, since i need the instdir to be in the path to register certain dll files. i rather not copy them into system32 as when the product gets uninstalled i dont want them orphaned and i rather not touch a users system32.<br />
      <br />
      so far, i cant see anything that is causing this. especially that nothing changed and it used to work in the past and now it doesnt.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">14th May 2007 19:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">And what about the stale environment block of your IDE? Are you running your installer from Explorer.exe? Are you running the program that you use to test the new PATH from Explorer.exe?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jweinraub</span><br />
      <span class="post-time small text-muted">14th May 2007 19:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">i am not running the installer from the IDE. I am running it from explorer because the file i saved on my flash drive and i saved it to the C drive on my test computers. I double click the setup.exe from there, in explorer.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">14th May 2007 19:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">And a script that just adds the directory to the path? Also try a script that does just the following after you manually add the directory to the registry (HKCU\Environment\PATH):</p>
      <pre>
<code>!include WinMessages.nsh<br />SendMessage ${HWND_BROADCAST} ${WM_WININICHANGE} 0 "STR:Environment" /TIMEOUT=5000</code>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jweinraub</span><br />
      <span class="post-time small text-muted">14th May 2007 20:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">okay, i can now say wtf...bc my simple script worked. i even put some files that was causing the problem earlier.<br />
      <br />
      and it worked.<br />
      <br />
      interesting. even on my desktop that wasnt working from the beginning./ i dont know why it worked on others, 50%, but 0% on my desktop.<br />
      <br />
      i guess now comes to figuring out why it doesnt work with my aster installer.<br />
      <br />
      i do have a lot of tests going on, so perhaps that is the cause.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">14th May 2007 20:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Attach your script, if you can, and I'll have a look as well.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jweinraub</span><br />
      <span class="post-time small text-muted">14th May 2007 20:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">well i tried to clean it up as possible, trying not to be too revealing...<br />
      <br /></p>
      <pre>
<code><br />!define PRODUCT_NAME "Phantom"<br />!define PRODUCT_VERSION "643"<br />!define PRODUCT_PUBLISHER "Company"<br />!define PRODUCT_WEB_SITE "mysite.com"<br />!define PRODUCT_DIR_REGKEY "Software\Microsoft\Windows\CurrentVersion\App Paths\PH643.EXE"<br />!define PRODUCT_UNINST_KEY "Software\Microsoft\Windows\CurrentVersion\Uninstall\${PRODUCT_NAME}"<br />!define PRODUCT_UNINST_ROOT_KEY "HKLM"<br />!define SHCNE_ASSOCCHANGED 0x08000000<br />!define SHCNF_IDLIST 0<br />!define ALL_USERS<br /><br />!include "WinMessages.NSH"<br />!include "AddToPath.nsh"<br />!include WinVer.nsh<br /><br />!include LogicLib.nsh<br /><br />; lets try this compressor instead<br />SetCompressor lzma<br /><br />; MUI 1.67 compatible ------<br />!include "MUI.nsh"<br /><br />; MUI Settings<br />!define MUI_ABORTWARNING<br />!define MUI_ICON "setup.ico"<br /><br /><br />!define MUI_UNICON "uninstall.ico"<br /><br />; Welcome page<br />!insertmacro MUI_PAGE_WELCOME<br /><br />; eula<br />!define MUI_LICENSEPAGE_RADIOBUTTONS<br />!insertmacro MUI_PAGE_LICENSE "END USER AGMT.rtf"<br />!define MUI_LICENSEPAGE_RADIOBUTTONS<br />!insertmacro MUI_PAGE_LICENSE "FIRMWARE_EULA.rtf"<br /><br />; Instfiles page<br />!insertmacro MUI_PAGE_INSTFILES<br /><br /><br />; Finish page<br />!define MUI_FINISHPAGE_SHOWREADME "$INSTDIR\README.rtf"<br />!define MUI_FINISHPAGE_SHOWREADME_NOTCHECKED<br />!define MUI_FINISHPAGE_RUN "$INSTDIR\PH643.EXE"<br />!define MUI_FINISHPAGE_RUN_NOTCHECKED<br />!insertmacro MUI_PAGE_FINISH<br /><br />; Uninstaller pages<br />!insertmacro MUI_UNPAGE_INSTFILES<br /><br />; Language files<br />!insertmacro MUI_LANGUAGE "English"<br /><br />; Reserve files<br />!insertmacro MUI_RESERVEFILE_INSTALLOPTIONS<br /><br />BrandingText "${PRODUCT_PUBLISHER}"<br />; MUI end ------<br /><br /><br />Function .onInit<br /><br /><br />;; denied<br />GetVersion::WindowsName<br />Pop $R0<br /><br />${If} $R0 == "XP"<br />  Goto xp<br />${ElseIf} $R0 == "2000"<br />  Goto go_away<br />${ElseIf} $R0 == "Server 2003"<br />  Goto go_away<br />${Elseif} $R0 == "Server 2003 R2"<br />  Goto go_away<br />${Else}<br />  Goto error<br />${EndIf}<br /><br />xp:<br />   GetVersion::WindowsType<br />   Pop $R0<br />   StrCmp $R0 "Home Edition" xp_home_error go_away<br /><br />xp_home_error:<br />    MessageBox MB_OK|MB_ICONSTOP "Windows XP Home Edition is not supported by the software.  $\n$\nPlease call 1-800-for additional support options." IDOK<br />    Quit<br />    <br />error:<br />    MessageBox MB_OK|MB_ICONSTOP "Windows $R0 is not supported by the software.  $\n$\nPlease call 1-800- for additional support options." IDOK<br />    Quit<br /><br /><br />go_away:<br /><br />;;;;;;; DENY ALL OPERATING SYSTEMS BUT ALLOW SUPPORTED ONES:<br />;<br />;       XP PRO<br />;       2000<br />;       SERVER 2003<br />;       SERVER 2003 R2<br />;<br />;       AWAITING APPROVAL FOR:<br />;<br />;       XP 64<br />;       VISTA<br />;       SERVER LONGHORN<br /><br /><br />  ReadRegStr $R0 HKLM \<br />  "Software\Microsoft\Windows\CurrentVersion\Uninstall\${PRODUCT_NAME}" \<br />  "UninstallString"<br />  StrCmp $R0 "" done<br /><br />  MessageBox MB_OKCANCEL|MB_ICONEXCLAMATION \<br />  "${PRODUCT_NAME} is already installed. $\n$\nClick `OK` to remove the \<br />  previous version or `Cancel` to cancel this upgrade." \<br />  IDOK uninst<br />  Abort<br /><br />;Run the uninstaller<br />uninst:<br />  ClearErrors<br />  ExecWait '$R0 _?=$INSTDIR' ;Do not copy the uninstaller to a temp file<br /><br />  IfErrors no_remove_uninstaller<br />  no_remove_uninstaller:<br /><br />done:<br /><br />FunctionEnd<br /><br />!define myStrStr "!insertmacro myStrStr"<br /><br /><br />Function RefreshShellIcons<br />  ; By jerome tremblay - april 2003<br />  System::Call 'shell32.dll::SHChangeNotify(i, i, i, i) v \<br />  (${SHCNE_ASSOCCHANGED}, ${SHCNF_IDLIST}, 0, 0)'<br />FunctionEnd<br /><br /><br />Name "${PRODUCT_NAME} ${PRODUCT_VERSION}"<br />OutFile "setup.exe"<br />InstallDir "$PROGRAMFILES\Phantom"<br />InstallDirRegKey HKLM "${PRODUCT_DIR_REGKEY}" ""<br />ShowInstDetails NeverShow<br />ShowUnInstDetails NeverShow<br /><br />Section "MainSection" SEC01<br />  SetDetailsPrint textonly<br />  DetailPrint "Installing Phantom Software..."<br />  SetDetailsPrint none<br />  SetOutPath "$INSTDIR"<br />  Push $INSTDIR<br />  Call AddToPath<br />  File "ijl15.dll"<br />  File "ipl.dll"<br />  File "ipla6.dll"<br />  File "IPLM5.DLL"<br />  File "PH643.EXE"<br /> ; ..... snip a roo<br />  File "PHCON.DLL"<br />  File "PHFILE.DLL"<br />  File "PHINT.DLL"<br />  File "PHSIG.DLL"<br />  File "PHSIGV.DLL"<br />  File "phicon.dll"<br />  File "PhThumb.dll"<br />  File "MFC71.dll"<br />  File "Microsoft.VC80.CRT.manifest"<br />  File "msvcm80.dll"<br />  File "msvcp80.dll"<br />  File "msvcr80.dll"<br />  File "mfc80.dll"<br />  File "Phantom.chm"<br />  File "Release.chm"<br />  File "TechSupp.chm"<br /><br />  ; fix bug bc last version i over wrote the path<br />  ReadRegStr $1 HKLM \<br />  "SYSTEM\CurrentControlSet\Control\Session Manager\Environment" Path<br />  Push $1<br />  Push "wbem"<br />  Call StrStr<br />  Pop $R0<br /><br />  StrCmp $R0 "" true false<br />  <br />  true:<br />  ; the item isnt here so add it now<br />  Push "$sysdir\wbem"<br />  Call AddToPath<br />  Goto End<br />  <br />  false:<br />  ;nothing to do today, hurray!<br />  Goto End<br /><br />  End:<br /><br />  SetOutPath "$INSTDIR"<br />  File "msvcr71.dll"<br /><br />  SetShellVarContext all<br />  CreateShortCut "$DESKTOP\Panel.lnk" "$INSTDIR\PhPanel.exe"<br />  <br /><br />  ${If} ${IsWinXP}<br />  Goto section_xp<br />  ${EndIf}<br /><br />  ${If} ${IsWin2000}<br />  Goto section_2000<br />  ${EndIf}<br /><br />  <br />  section_xp:<br />     SetDetailsPrint textonly<br />     DetailPrint "Copying Windows XP IEEE 1394 Drivers..."<br />     SetDetailsPrint none<br />     SetOutPath "$INSTDIR\WinXP Drivers"<br />     File "WinXP Drivers\Ph1394.dll"<br />     File "WinXP Drivers\Ph1394.inf"<br />     File "WinXP Drivers\Ph1394.sys"<br />     SetOutPath "$INSTDIR\XP System Files"<br />     File "XP System Files\1394bus.sys"<br />     File "XP System Files\ohci1394.sys"<br />     File "XP System Files\READ ME.txt"<br />     Goto the_rest<br /><br /><br />  section_2000:<br />     SetDetailsPrint textonly<br />     DetailPrint "Copying Windows 2000 IEEE 1394 Drivers..."<br />     SetDetailsPrint none<br />     SetOutPath "$INSTDIR\Win2K Camera Drivers"<br />     File "Win2K Camera Drivers\Ph1394.dll"<br />     File "Win2K Camera Drivers\Ph1394.inf"<br />     File "Win2K Camera Drivers\Ph1394.sys"<br />     SetOutPath "$INSTDIR\Win2k System Files"<br />     File "Win2k System Files\1394bus.sys"<br />     File "Win2k System Files\ohci1394.sys"<br />     File "Win2k System Files\READ ME.txt"<br />     Goto the_rest<br /><br />  the_rest:<br />  UnRegDll "$INSTDIR\PhThumb.dll"<br />  RegDll "$INSTDIR\PhThumb.dll"<br />  SetOutPath "$INSTDIR"<br /><br /><br />  SetDetailsPrint textonly<br />  DetailPrint "Associating Movies to Software..."<br />  SetDetailsPrint none<br />  ;; file associations for xxx file<br /> ; back up old value of .xxx<br />!define Index "Line${__LINE__}"<br />  ReadRegStr $1 HKCR ".xxx" ""<br />  StrCmp $1 "" "${Index}-NoBackup"<br />    StrCmp $1 "XXXFile" "${Index}-NoBackup"<br />    WriteRegStr HKCR ".xxx" "backup_val" $1<br />"${Index}-NoBackup:"<br />  WriteRegStr HKCR ".xxx" "" "xxxFile"<br />  ReadRegStr $0 HKCR "xxxFile" ""<br />  StrCmp $0 "" 0 "${Index}-Skip"<br />        WriteRegStr HKCR "xxxFile" "" "XXX File"<br />        WriteRegStr HKCR "xxxFile\shell" "" "open"<br />        WriteRegStr HKCR "xxxFile\DefaultIcon" "" "$INSTDIR\phicon.dll,1"<br />"${Index}-Skip:"<br />  WriteRegStr HKCR "xxxFile\shell\open\command" "" \<br />    '$INSTDIR\PH643.EXE "%1"'<br />!undef Index<br /><br />  ;; file associations for cci file<br /><br /> ; back up old value of .cci<br />!define Index "Line${__LINE__}"<br />  ReadRegStr $1 HKCR ".cci" ""<br />  StrCmp $1 "" "${Index}-NoBackup"<br />    StrCmp $1 "PhantomCciFile" "${Index}-NoBackup"<br />    WriteRegStr HKCR ".cci" "backup_val" $1<br />"${Index}-NoBackup:"<br />  WriteRegStr HKCR ".cci" "" "PhantomCciFile"<br />  ReadRegStr $0 HKCR "PhantomCciFile" ""<br />  StrCmp $0 "" 0 "${Index}-Skip"<br />        WriteRegStr HKCR "PhantomCciFile" "" "Phantom Cine File"<br />        WriteRegStr HKCR "PhantomCciFile\shell" "" "open"<br />        WriteRegStr HKCR "PhantomCciFile\DefaultIcon" "" "$INSTDIR\phicon.dll,0"<br />"${Index}-Skip:"<br />  WriteRegStr HKCR "PhantomCciFile\shell\open\command" "" \<br />    '$INSTDIR\PH643.EXE "%1"'<br />!undef Index<br /><br /><br />;;; add cine format as well??.... i say no, add cine format with 644+ with new phthumb!!!<br /><br /><br />; Rest of script<br />Call RefreshShellIcons<br />SectionEnd<br /></code>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">14th May 2007 20:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Please attach large scripts next time.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jweinraub</span><br />
      <span class="post-time small text-muted">14th May 2007 21:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by kichik</i><br />
        <b>Please attach large scripts next time.</b>
      </blockquote>sorry... :(
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jweinraub</span><br />
      <span class="post-time small text-muted">15th May 2007 19:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I looked and relooked at the code and I really can't find anything that would cause this to stop working. Can the OS denial stuff include some headers that can cause it to stop? I think thats about the only thing I changed recently.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">15th May 2007 19:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Maybe a local version of WinMessages.nsh overriding the one from nsisdir\Include? Take a look at the makensis log and look for the SendMessage line. Make sure it has normal values and not zeros or unexpanded strings.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jweinraub</span><br />
      <span class="post-time small text-muted">15th May 2007 20:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">SendMessage: (timeout=5000)(0xFFFF,0x001A,0,STR:Environment)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jweinraub</span><br />
      <span class="post-time small text-muted">15th May 2007 20:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">No winmessages in any directory other than include</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
