<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="File association/defaults question" />

  <title>File association/defaults question - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">File association/defaults question</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=323199">File association/defaults question</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Majek</span><br />
      <span class="post-time small text-muted">17th October 2010 18:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>File association/defaults question</strong><br />
      Hello again, I'm trying to associate my application with .txt files and make it the default program for opening .txt files. My app only runs on Vista/Windows 7 so I figured IApplicationAssociationRegistration would do the trick.<br />
      <br />
      I found this plugin on the nsis website:<br />
      <a href="http://nsis.sourceforge.net/Application_Association_Registration_plug-in" target="_blank">http://nsis.sourceforge.net/Applicat...ration_plug-in</a><br />
      <br />
      I have a custom InstallOptions page with a checkbox "Make Notpad the default text editor". First it associates .txt files then reads the ini to get the checkbox state. If checked, it sets the app as default:<br />
      <br />
      Function CustomPageEnd<br />
      WriteRegStr HKLM "Software\Classes\Notpad.TextFile" "" "Text Document"<br />
      WriteRegStr HKLM "Software\Classes\Notpad.TextFile\DefaultIcon" "" "$INSTDIR\Notpad.exe, 1"<br />
      WriteRegStr HKLM "Software\Classes\Notpad.TextFile\shell\open\command" "" "$INSTDIR\Notpad.exe %1"<br />
      <br />
      SetRegView 64<br />
      WriteRegStr HKLM "Software\Notpad\Capabilities" "ApplicationDescription" "Notpad is not Notepad"<br />
      WriteRegStr HKLM "Software\Notpad\Capabilities\FileAssociations" ".txt" "Notpad.TextFile"<br />
      <br />
      WriteRegStr HKLM "Software\RegisteredApplications" "Notpad" "Software\Notpad\Capabilities"<br />
      SetRegView 32<br />
      <br />
      !insertmacro MUI_INSTALLOPTIONS_READ $R1 "notpad.ini" "Field 3" "State"<br />
      ${If} $R1 == 1<br />
      AppAssocReg::SetAppAsDefault "Notpad" ".txt" "file"<br />
      Pop $0<br />
      MessageBox MB_ICONINFORMATION|MB_OK "SetAppAsDefault Result = $0"<br />
      ${EndIf}<br />
      FunctionEnd<br />
      <br />
      It seems to associate the type correctly, I can right-click .txt files and Notpad appears in the "Open with" submenu. The problem is the SetAppAsDefault function always returns "method failed". I don't know if I'm using it properly the documentation on the plugin page is a little confusing.<br />
      <br />
      I looked in the registry and everything looks good, except it creates 2 copies of the RegisteredApplications\Notpad key. One in HKLM\Software and one in HKLM\Software\Wow6432Node, even when I use SetRegView 64 in the script. Maybe this is whats causing SetAppAsDefault to fail. Am I doing something wrong?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Wizou</span><br />
      <span class="post-time small text-muted">17th October 2010 19:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Try to contact the plugin's author ?<br />
      <br />
      Anybody can list his plugin on <a href="http://nsis.sourceforge.net/" target="_blank">http://nsis.sourceforge.net/</a><br />
      I'm not sure the author reads this forum regularly.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Majek</span><br />
      <span class="post-time small text-muted">18th October 2010 19:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well I've done a few tests and noticed something strange...<br />
      First I created a managed wrapper around the IApplicationAssociationRegistration COM interface, and tried using it in my application.<br />
      <br />
      <a href="http://pastebin.com/L5xfjdij" target="_blank">http://pastebin.com/L5xfjdij</a><br />
      <br />
      private void SetDefault()<br />
      {<br />
      var aar = new ApplicationAssociationRegistration();<br />
      var iaar = (IApplicationAssociationRegistration)aar;<br />
      string currentDefault = iaar.QueryCurrentDefault(".txt", Global.AssociationType.AT_FILEEXTENSION, Global.AssociationLevel.AL_EFFECTIVE);<br />
      if (currentDefault != "Notpad.TextFile") iaar.SetAppAsDefault("Notpad", ".txt", AssociationType.AT_FILEEXTENSION);<br />
      }<br />
      <br />
      From c# everything works fine, QueryCurrentDefault returns "txtfile", then it sets the default to my app. But when I try the same code in my script using the plugin:<br />
      <br />
      AppAssocReg::QueryCurrentDefault ".txt" "file" "effective"<br />
      Pop $0<br />
      ${If} $0 != "Notpad.TextFile"<br />
      AppAssocReg::SetAppAsDefault "Notpad" ".txt" "file"<br />
      Pop $1<br />
      MessageBox MB_ICONINFORMATION|MB_OK "SetAppAsDefault Result: $1"<br />
      ${EndIf}<br />
      <br />
      QueryCurrentDefault works, but SetAppAsDefault still returns "method failed". The strange thing is when I try other applications and association types like "Internet Explorer" "http" "protocol", the function succeeds and sets the default.<br />
      <br />
      Has anyone else used this plugin before or the IApplicationAssociationRegistration api in their script? I don't understand why it works for other apps but not mine :(</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">demiller9</span><br />
      <span class="post-time small text-muted">18th October 2010 20:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Would it make a difference if <b>Notepad</b> were spelled correctly?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Majek</span><br />
      <span class="post-time small text-muted">18th October 2010 22:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Notpad is the name of my application. It's a replacement for notepad with more features like tabs, desktop composition and windows 7 jumplists. To replace notepad as the default text editor I need to use IApplicationAssociationRegistation api in my nsis script.<br />
      <br />
      The creator of the plugin says it works 100% on vista/7. The api works fine when I run it from c#, it only fails when I run it from my script using the plugin.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Majek</span><br />
      <span class="post-time small text-muted">20th October 2010 04:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">After trying some more tests the error the function is really returning is HRESULT 0x80070002 (file not found). I get the same error from c# so the plugin seems to be working fine. I still can't figure out whats causing it to fail, I'll keep trying I guess :(<br />
      <br />
      If anyone knows what is causing this error please let me know!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Majek</span><br />
      <span class="post-time small text-muted">20th October 2010 05:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Sorry for double posting, but I noticed something else very strange...<br />
      <br />
      SetAppAsDefault fails when called from the installer<br />
      SetAppAsDefault fails when called from Notpad.vshost.exe (Debug mode)<br />
      SetAppAsDefault succeeds when called from Notpad.exe (Release mode)<br />
      <br />
      It appears the function only succeeds if the process is open, but that still doesn't explain why it works for other programs like ie.<br />
      <br />
      I guess my only option is to launch Notpad.exe silently from the installer and set the default that way. I still need a way to reset the default back to notepad when Notpad is uninstalled.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
