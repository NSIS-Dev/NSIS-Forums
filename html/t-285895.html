<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="wierd nsDialogue crash issue" />

  <title>wierd nsDialogue crash issue - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">wierd nsDialogue crash issue</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=285895">wierd nsDialogue crash issue</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mordekai</span><br />
      <span class="post-time small text-muted">29th January 2008 17:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>wierd nsDialogue crash issue</strong><br />
      I'm having a wierd issue where, in the SelectFolderDialogue, if i try to create a new folder (using the supplied button), and select that folder, the proceeding call to SetWindowText crashes my installer...<br />
      <br />
      any ideas?<br />
      <br />
      #I've created a custom page, here's the loader function for it:<br />
      <br />
      Function customDirectoryDlg<br />
      nsDialogs::Create /NOUNLOAD 1018<br />
      Pop $0<br />
      ${NSD_CreateDirRequest} 0 20u 80% 15u "$INSTDIR"<br />
      Pop $DIR_EDIT<br />
      ${NSD_CreateButton} 82% 20u 40u 15u "Browse..."<br />
      Pop $DIR_BUTTON<br />
      ${NSD_OnClick} $DIR_BUTTON DirButtonOnClick<br />
      nsDialogs::Show<br />
      FunctionEnd<br />
      <br />
      # and here's the ButtonClick event function:<br />
      Function DirButtonOnClick<br />
      Pop $0 #HWND<br />
      nsDialogs::SelectFolderDialog /NOUNLOAD "Select folder" "$INSTDIR"<br />
      Pop $0<br />
      # in the SelectFolderDialog, if you create a new folder,<br />
      # and select that new folder, the following line will<br />
      # crash the installer<br />
      System::Call `user32::SetWindowText(i $DIR_EDIT, t "blah")`<br />
      FunctionEnd</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">29th January 2008 18:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What are the crash details?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mordekai</span><br />
      <span class="post-time small text-muted">29th January 2008 19:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I get a Microsoft dialogue with the following buttons as options:<br />
      <br />
      "Debug"<br />
      "Send Error Report"<br />
      "Don't Send"<br />
      <br />
      There is also a binary dump of the exe and a list of dll/modules (i suspect) in their various states at the time of the crash.<br />
      <br />
      Is this any help? Is there any other information you need?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">29th January 2008 20:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Any details at all would help as currently I can't reproduce the problem. An installer that reproduces this or, even better, a complete and minimal script, would also help.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mordekai</span><br />
      <span class="post-time small text-muted">29th January 2008 20:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I'm attaching a small script that duplicates the problem.<br />
      I narrowed the problem down to the interaction between my OnClick function and my OnChange function.<br />
      <br />
      in my OnClick function, the user selects the folder. I post this new folder string to my Edit box (for which there is an OnChange event). the OnChange event gets called, calls GetWindowText, which appears to succeed (the final MessageBox gets called with the appropriate data). Then the installer crashes.<br />
      <br />
      I'm wondering if i'm butchering the stack? Popping when i shouldn't be? not popping when i should be?<br />
      <br />
      thanks for your support in this!<br />
      -chris</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">29th January 2008 21:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That script did reproduce the problem. The problem appears to be calling the System plug-in in gxDirEditOnChange which is triggered by the call to SetWindowText in gxDirButtonOnClick. Because /NOUNLOAD wasn't used in the GetWindowText call, the System plug-in was unloaded while it was still processing the SetWindowText higher up in the stack.<br />
      <br />
      This is an issue I haven't considered when I introduced function callbacks for plug-ins. I am unsure of the best solution for this.<br />
      <br />
      The immediate solution for your problem is using /NOUNLOAD on line 36.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mordekai</span><br />
      <span class="post-time small text-muted">29th January 2008 21:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Interesting.<br />
      that solution works, and is certainly easy enough.<br />
      <br />
      Thanks for your help Kichik :)<br />
      <br />
      -chris</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Daniel James</span><br />
      <span class="post-time small text-muted">17th February 2008 15:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Re: wierd nsDialogue crash issue</strong><br /></p>

      <blockquote>
        <i>Originally posted by mordekai</i><br />
        I'm having a wierd issue where, in the SelectFolderDialogue, if i try to create a new folder (using the supplied button), and select that folder, the proceeding call to SetWindowText crashes my installer...<br />
        <br />
        any ideas?
      </blockquote>Interesting ... I've just been doing the same thing. It's something I'd have expected to find in the NSIS examples and it hurts to find it isn't quite the no-brainer it should be!<br />
      <br />

      <blockquote>
        &lt;snip&gt;<br />
        # and here's the ButtonClick event function:<br />
        Function DirButtonOnClick<br />
        Pop $0 #HWND<br />
        nsDialogs::SelectFolderDialog /NOUNLOAD "Select folder" "$INSTDIR"<br />
        Pop $0<br />
        # in the SelectFolderDialog, if you create a new folder,<br />
        # and select that new folder, the following line will<br />
        # crash the installer<br />
        System::Call `user32::SetWindowText(i $DIR_EDIT, t "blah")`<br />
        FunctionEnd
      </blockquote>System::Call seems like a sledgehammer to crack a nut, here, though. Why not just use SendMessage? I have something like this:<br />
      <br />
      <pre>
<code><br />Function doBrowse<br /><br />   pop $0  ; get control hwnd off stack<br /><br />   nsDialogs::SelectFolderDialog /NOUNLOAD "Select Install Folder" "C:\MyApp"<br />   pop $0<br /><br />   ${If} $0 == "error"<br />      Return<br />   ${EndIf}<br /><br />   SendMessage $InstDirCtl ${WM_SETTEXT} 0 "STR:$0"<br /><br />FunctionEnd<br /></code>
</pre><br />
      Note the all-important "STR:" in front of the lparam argument.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">29th November 2008 22:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">This will be fixed in the next version - 2.42.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
