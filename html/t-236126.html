<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="LZMA Compression vs. 7zip SFX"><title>LZMA Compression vs. 7zip SFX - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">LZMA Compression vs. 7zip SFX</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=236126">LZMA Compression vs. 7zip SFX</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">RobertStrong</span><br><span class="post-time small text-muted">22nd January 2006 05:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>LZMA Compression vs. 7zip SFX</strong><br>I have noticed that I am unable to get NSIS LZMA to compress as much as 7zip SFX. For example, with the exact same files LZMA SOLID will give me an exe that is 4.98 MB while using 7zip SFX with the same files and the NSIS installer will give me an exe of 4.73 MB.<br><br>Though it may not seem like much size is extremely critical in this case and I am wondering if there is a way to get NSIS to improve the compression to the same level when using LZMA?<br><br>Thanks,<br>Robert</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Comperio</span><br><span class="post-time small text-muted">22nd January 2006 06:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Have you tried increasing the dictionary size by using SetCompressorDictSize?<br><br>I found this from the 7-zip help file:<br></p><blockquote>...Usually higher Dictionary size gives more compression ratio. But compressing can be slower and it can require more memory.<br><br>Memory (RAM) usage for LZMA compressing is about 10 times more than dictionary size. Memory usage for LZMA decompressing is close to value of dictionary size. Memory usage for PPMd compressing and decompressing is almost equal to dictionary size...</blockquote></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">RobertStrong</span><br><span class="post-time small text-muted">22nd January 2006 07:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Yes, with the default size of 8 MB the exe size is 5.0 MB<br>with SetCompressorDictSize 16 and above the size is 4.98 MB<br><br>With the following 7zip packaging I get an exe of 4.73 MB<br>7z a -t7z out.7z &lt;path to files&gt;\*.* &lt;path to NSIS exe&gt;\installer.exe -mx -m0=BCJ2 -m1=LZMA:d24 -m2=LZMA:d19 -m3=LZMA:d19 -mb0:1 -mb0s1:2 -mb0s2:3<br>upx --best 7zSD.sfx<br>copy /b 7zSD.sfx+config.txt+out.7z setup.exe<br><br>Except for the File /r "&lt;path to files&gt;\*" in the installer both installers are the same.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Comperio</span><br><span class="post-time small text-muted">22nd January 2006 17:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The only explaination I can come up with is the BCJ2 option you have in your 7-zip command line. 7z docs indicate that BCJ2 is a method that allows 32-bit x86 executables to be compressed even further--a feature that may not be implemented in NSIS.<br><br>I found more info about this at <a href="http://en.wikipedia.org/wiki/LZMA" target="_blank">http://en.wikipedia.org/wiki/LZMA</a><br><br>There may be other reasons. Perhaps someone with more programming experience can give a more detailed (and possibly more accurate) explanation.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Comm@nder21</span><br><span class="post-time small text-muted">22nd January 2006 20:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">another possibility:<br>once lzma has been implemented in NSIS, the devs took a version of the lzma sdk and modified it to match nsis' structure.<br><br>i don't know, if it ever has been updated since then.<br>because lzma itself has been updated more than one time and improved speed and compression quality.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">DrO</span><br><span class="post-time small text-muted">22nd January 2006 20:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">nsis's version of lzma hasn't been updated in a while and yes, it was taken from the sdk and then tweaked (quite extensively from memory) to fit into the size constraints expected from zlib and bzip methods<br><br>-daz</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">RobertStrong</span><br><span class="post-time small text-muted">22nd January 2006 23:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks for the responses.... I was thinking that it may be due to using the older SDK or not using the BCJ2 option... if the reason could be confirmed I might attempt updating NSIS to the latest SDK or adding the BCJ2 option.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">24th January 2006 17:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Only the decoder was tweaked to fit the size limits. The encoder itself wasn't touched. The code was indeed not updated for a while, but I don't recall seeing any improved compressions in latest versions. BCJ2 is not used in NSIS and can result in better ratios, if you compress 32-bit executables.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">RobertStrong</span><br><span class="post-time small text-muted">24th January 2006 18:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">kichik - thanks! It does appear to be due to BCJ2... the size difference is approximately the same. I'll take a look at what it would entail implementing BCJ2 in NSIS in the next month or two. If you know of anyone caveats / issues with implementing this I'd appreciate hearing about them.<br><br>Cheers,<br>Robert</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">24th January 2006 18:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">There's one issue of aggregating the compression decoder and BCJ2's decoder. BCJ2 doesn't work with single bytes, it needs 5 due to op size. Because streams aren't used, this is a bit harder. You can either go over the entire data again after it's extracted, or preserve a state in the BCJ2 decoder.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Comm@nder21</span><br><span class="post-time small text-muted">24th January 2006 18:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">would it be possible to upgrade NSIS with latest LZMA codecs?<br><br>maybe something for the TODO list :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">24th January 2006 18:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">It's on the TODO, but it's not that important. I haven't seen anything too exciting in the change log. However, if a patch is submitted... ;)</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>