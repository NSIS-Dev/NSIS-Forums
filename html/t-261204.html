<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Plugin problem, CoInitialize() fails.."><title>Plugin problem, CoInitialize() fails.. - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Plugin problem, CoInitialize() fails..</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=261204">Plugin problem, CoInitialize() fails..</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">joe131</span><br><span class="post-time small text-muted">6th December 2006 13:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Plugin problem, CoInitialize() fails..</strong><br>Hi All,<br><br>I'm trying to get a plugin DLL working that uses several<br>"functions", but it has problems..<br><br>The first call to CoInitialize() fails..<br><br>hr = CoInitialize(NULL);<br>if ( hr != S_OK )<br>{<br>printf("CoInitialize() Failed\n");<br>reply = "CoInitialize() Failed";<br>goto Create_Exit;<br>}<br><br>I first wrote, compiled, and ran them all, by themselves,<br>and they all worked.<br><br>for each I use:<br><br>extern "C" void __declspec(dllexport) CreateUser(HWND hwndParent, int string_size,<br>char *variables, stack_t **stacktop)<br>{<br>char *reply = "Failed"; // Default..<br><br>g_hwndParent = hwndParent;<br><br>EXDLL_INIT();<br><br>}<br><br>And finish with:<br><br>BOOL WINAPI DllMain(HANDLE hInst, ULONG ul_reason_for_call, LPVOID lpReserved)<br>{<br>g_hInstance = (HINSTANCE)hInst;<br>return TRUE;<br>}<br><br>It has all the right includes, and the DLL compiles and<br>links okay.<br><br>So is there anything special that I need to add to it<br>to get it to "work"?<br><br>The file is .cpp, because the compiler and linker seem<br>to be much happier with that than using a .c<br><br>None of the functions require any input.<br><br>I'm using a Microsoft compiler and linker..<br><br><br>Thanks,<br><br>Joe S.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">onad</span><br><span class="post-time small text-muted">6th December 2006 16:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">IMHO, it is best to compile an NSIS example plugin first.<br>For this download the NSIS source! via nightly TARball or cvs.<br><br>then take a look in ( \cvs\nsis\NSIS\Contrib\ExDLL\ )<br><br>.. and see if you can get that exmaple working.<br>add some of your code to this plugin and see if all still works... then move on to your own full plugin...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">joe131</span><br><span class="post-time small text-muted">6th December 2006 17:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Excellent idea! I'll try it.<br><br>Thanks,<br><br>Joe S.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">joe131</span><br><span class="post-time small text-muted">6th December 2006 19:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">No luck.. :-(<br><br>Here's a "simple" full example that compiles and links<br>okay, but will fail..<br><br><br>#include &lt;windows.h&gt;<br><br>#define _WIN32_DCOM<br><br>#include &lt;Wbemidl.h&gt;<br>#include "activeds.h"<br>#include &lt;objbase.h&gt; // Co..<br>#include &lt;oleauto.h&gt; // SysAllocString()<br><br>#include "stdio.h"<br><br>#include "exdll.h"<br><br><br><br>HINSTANCE g_hInstance;<br><br>HWND g_hwndParent;<br><br>extern "C" void __declspec(dllexport) getComputerName(HWND hwndParent, int string_size,<br>char *variables, stack_t **stacktop)<br>{<br>g_hwndParent=hwndParent;<br><br>EXDLL_INIT();<br><br>char computerNameBuf[100];<br><br>HRESULT hr = S_OK;<br><br>IADsWinNTSystemInfo *pNtSys = NULL;<br><br>BSTR bstrComputer = NULL;<br>hr = CoInitialize(NULL);<br>if ( hr != S_OK )<br>{<br>// printf("CoInitialize() Failed\n");<br>goto GetComputerName_Exit;<br>}<br><br>hr = CoCreateInstance(CLSID_WinNTSystemInfo,<br>NULL,<br>CLSCTX_INPROC_SERVER,<br>IID_IADsWinNTSystemInfo,<br>(void**)&amp;pNtSys);<br>if ( hr != S_OK )<br>{<br>// printf("CoCreateInstance() Failed\n");<br>goto GetComputerName_Exit;<br>}<br><br>// printf("CoCreateInstance() OK\n");<br><br>hr = pNtSys-&gt;get_ComputerName(&amp;bstrComputer);<br>if ( hr != S_OK )<br>{<br>// printf("get_ComputerName() Failed\n");<br>goto GetComputerName_Exit;<br>}<br><br>// printf("get_ComputerName() OK\n");<br><br>sprintf(computerNameBuf, "%s", bstrComputer);<br>// printf("computerNameBuf: '%S'\n", computerNameBuf);<br><br><br>SysFreeString(bstrComputer);<br><br>pushstring(computerNameBuf);<br><br><br>GetComputerName_Exit:<br><br>if ( pNtSys != NULL )<br>{<br>pNtSys-&gt;Release();<br>}<br><br>CoUninitialize();<br>}<br><br><br><br>BOOL WINAPI DllMain(HANDLE hInst, ULONG ul_reason_for_call, LPVOID lpReserved)<br>{<br>g_hInstance = (HINSTANCE)hInst;<br>return TRUE;<br>}</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">7th December 2006 18:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">NSIS already calls OleInitialize for plug-ins, which internally calls CoInitializeEx. When COM is already initialized for a certain thread, CoInitlaize returns S_FALSE. It's not a real failure, just a notice so you won't call CoUninitialize.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">7th December 2006 21:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Actually, you should call CoUninitialize for each time you call CoInitialize[Ex]. If you test with the SUCCEEDED macro instead of testing for S_OK everything should be ok</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">joe131</span><br><span class="post-time small text-muted">8th December 2006 12:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Man! You're right!<br><br>I changed all my:<br><br>if ( hr != S_OK )<br><br>tests to use<br><br>if ( ! SUCCEEDED(hr) )<br><br>and most everything started to work! lol Doh! :-)<br><br>Sometimes I'd rather use what the macro tries to<br>do internally, directly, testing for S_OK,<br>but I guess in this case it came back and bit me.. lol :-)<br><br>Thanks so much everybody!!<br><br>Joe S.</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>