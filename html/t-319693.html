<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="AppData/LocalLow Temp Directory and Uninstall" />

  <title>AppData/LocalLow Temp Directory and Uninstall - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">AppData/LocalLow Temp Directory and Uninstall</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=319693">AppData/LocalLow Temp Directory and Uninstall</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Gnometech</span><br />
      <span class="post-time small text-muted">4th June 2010 22:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>AppData/LocalLow Temp Directory and Uninstall</strong><br />
      Greetings!<br />
      <br />
      I'm using NSIS to install an IE8 browser plug-in into AppData/LocalLow under Vista -- a Protected Mode plug-in. That works as expected and all is well. However, I run into trouble with the automatically generated uninstaller.<br />
      <br />
      I understand that the NSIS uninstaller automatically copies itself into the system's TEMP directory to allow for complete removal of the original directory. Under Vista this points to AppData/Local/Temp, which is fine for a normal application. Unfortunately, this is incorrect for a Protected Mode application, where the TEMP directory should be AppData/LocalLow/Temp. NSIS responds with the following dialog when attempting to launch the uninstaller:<br />
      <br /></p>

      <blockquote>
        Error writing temporary file. Make sure your temp folder is valid.
      </blockquote>It doesn't look like NSIS is taking the Protected Mode into account and switching to the correct directory.<br />
      <br />
      Under the current version of NSIS, is there anything I can do to work around this? Can I force the directory the uninstaller will be copied to? I would even settle for not copying the uninstaller at all and just leave the directory around on the system.<br />
      <br />
      If there is no current work around, are there any plans on supporting these types of Protected Mode applications?<br />
      <br />
      Thanks!<br />
      <br />
      - Dave
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">coliveira</span><br />
      <span class="post-time small text-muted">4th June 2010 23:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If you can pass command-line options to the installer, _?= should solve your problem. See <a href="http://nsis.sourceforge.net/Docs/Chapter3.html#3.2" target="_blank">http://nsis.sourceforge.net/Docs/Chapter3.html#3.2</a></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">5th June 2010 07:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Blame windows for this, NSIS just asks for the temp dir with the official API and we get "the wrong one" (You would expect Protected Mode to handle this, but it does not) If you can point me to a API we could use without hardcoding the path, we should be able to fix it...<br />
      <br />
      As a workaround, generate the uninstaller at compile time like we do with signing, include this uninstaller in a small nsis "application" (not uninstaller) that just extracts the real uninstaller to $appdata\locallow\temp and runs the uninstaller (don't forget to run it with ?= and the path)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Gnometech</span><br />
      <span class="post-time small text-muted">16th June 2010 16:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Greetings!<br />
      <br />
      I've now come back to this and tried out your suggestions. Thanks coliveira and Anders!<br />
      <br />
      I've gone ahead and did what Anders suggested. I've created a simple installer that wraps around the actual uninstaller. This "uninstaller installer" puts the uninstaller into LocalLow/Temp and does an Exec while including the _?= parameter. Unfortunately, I still end up with the following dialog:<br />
      <br /></p>

      <blockquote>
        Error writing temporary file. Make sure your temp folder is valid.
      </blockquote>Interestingly, this error dialog appears with the "uninstaller installer" even before it gets to copying the true uninstaller. Do NSIS installers also make use of the system's TEMP directory? Or would not being able to access the TEMP directory while creating the %TEMP% constant also cause this error? I suspect Protected Mode is causing even more issues with NSIS.<br />
      <br />
      To test this out, I copied my working NSIS installer -- the one that installs my program I'm trying to uninstall -- into the LocalLow directory. When I try to run it, I get that same error dialog about the temporary file. The installer of course works if it is run from a user's documents directory.<br />
      <br />
      As another test, I manually copied my uninstaller (created using the procedure suggested by Anders) into LocalLow/Temp. I then run it from the command line and include the _?= parameter pointing to the correct directory. And once again, I still get that temporary file dialog.<br />
      <br />
      Finally, I manually copied my uninstaller into the Local/Temp directory and ran it from the command line using the correct _?= parameter. From there it runs just fine.<br />
      <br />
      It would be great if you guys could try this out too. Under a non-privileged account, copy any NSIS installer into a LocalLow directory (could use LocalLow/Temp if you'd like). Then try to run the installer and see what happens. You could also take any NSIS uninstaller executable and run it from the LocalLow/Temp directory with the _?= parameter and see what happens.<br />
      <br />
      At this point, I'm stuck. It doesn't look like NSIS installers or uninstallers may be run from the Protected Mode LocalLow directory (TEMP or not). Hopefully given that this may be tested from any Vista (and Win7?) machine with a non-privileged account, and any NSIS installer or uninstaller, the NSIS code base could be changed in the future to better support Protected Mode. This would include not erroring out when there are issues with the temporary directory (maybe through a command line switch).<br />
      <br />
      Vista sucks in that it doesn't provide the correct APIs to deal with Protected Mode. Nor, from my own experience, does it modify the output of its existing APIs when working in Protected Mode. Unfortunately we need to use Protected Mode to allow for non-privileged plug-ins to run under IE8.<br />
      <br />
      Thanks!<br />
      <br />
      - Dave
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">16th June 2010 20:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I'm guessing we will need to hardcode the temp path to %localappdatalow%\temp if the normal temp path fails</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Gnometech</span><br />
      <span class="post-time small text-muted">16th June 2010 22:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for replying, Anders.<br />
      <br />
      If someone does go down the path of modifying NSIS to support protected mode, this may help: <a href="http://msdn.microsoft.com/en-us/library/bb625966.aspx" target="_blank">Getting the Integrity Level for an Access Token</a><br />
      <br />
      I've not tried it out myself just yet, but it looks like if the process comes back as Low Integrity, assume the localappdatalow Temp directory. Once that change goes in, I'd be willing to test it out. :D<br />
      <br />
      Thanks!<br />
      <br />
      - Dave</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">16th June 2010 22:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I don't really see the need to check the token, if we don't have write access to %temp% or %windir%\temp, we should just try the low temp dir</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">PoRtAbLe_StEaLtH</span><br />
      <span class="post-time small text-muted">6th January 2013 07:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>update</strong><br /></p>

      <blockquote>
        <small>Originally posted by Anders</small><br />
        I'm guessing we will need to hardcode the temp path to %localappdatalow%\temp if the normal temp path fails
        <hr />
      </blockquote>
    </div>
    <hr />
    <br />
    is $LOCALAPPDATALOW an official variable?<br />
    i can't seem to find any documentation on it.<br />
    i've been using it for quite a while.. and works well except in XP.. it leaves behind:<br />
    <pre>
<code>Application DataLOW</code>
</pre><br />
    <br />
    not that big a deal..<br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">6th January 2013 08:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">$LOCALAPPDATALOW is not a variable. $LOCALAPPDATA is, so if you enter $LOCALAPPDATALOW it will append 'LOW' to the contents of $LOCALAPPDATA. I'm assuming that the exact name of the locallow folder can be changed by the user, so appending LOW to localappdata will not always work. You'll probably have to call SHGetKnownFolderPath to get the actual path.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Brummelchen</span><br />
      <span class="post-time small text-muted">6th January 2013 15:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">LocalLow is not for user business, its strict OS business - keep your fingers off.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">7th January 2013 03:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Quote:</p>
      <hr />

      <div class="footer">
        <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
      </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
      hljs.initHighlightingOnLoad();
      //]]>
      </script>

      <table cellpadding="6" cellspacing="0" border="0" width="100%">
        <tr>
          <td class="alt2">
            <hr />
            Originally Posted by <strong>Brummelchen</strong> (Post 2906452) LocalLow is not for user business, its strict OS business - keep your fingers off. Apps that run @ Low IL (IE Protected mode) are allowed to use the Low folder, that's what it's there for...
          </td>
        </tr>
      </table>
    </div>
  </div>
</body>
</html>
