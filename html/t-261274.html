<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Problem using System to Call COM DLL.." />

  <title>Problem using System to Call COM DLL.. - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Problem using System to Call COM DLL..</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=261274">Problem using System to Call COM DLL..</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">joe131</span><br />
      <span class="post-time small text-muted">7th December 2006 15:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Problem using System to Call COM DLL..</strong><br />
      Hi All,<br />
      <br />
      I tried to write a Plugin DLL that used some COM<br />
      functions, but gave-up when it wouldn't work<br />
      for whatever reason.<br />
      <br />
      So I wrote a regular DLL with one exported function,<br />
      to create a user, and to make sure that it "worked",<br />
      I wrote this test app:<br />
      <br />
      #include &lt;windows.h&gt;<br />
      #include &lt;stdio.h&gt;<br />
      <br />
      <br />
      // Import function..<br />
      extern "C" __declspec(dllimport) int CreateUser();<br />
      <br />
      int main(int argc, char* argv[])<br />
      {<br />
      <br />
      int iRet;<br />
      <br />
      iRet = CreateUser();<br />
      printf("iRet: %d\n", iRet);<br />
      <br />
      return 0;<br />
      }<br />
      <br />
      I ran the test app and it created the user<br />
      perfectly.<br />
      <br />
      And when I try to use System to call it, I can't get it<br />
      to work. Here's what my test installer uses:<br />
      <br />
      ; Point to DLL location..<br />
      SetOutPath "C:\apache\Webserver\bin"<br />
      <br />
      System::Call 'ServerSrv::CreateUser()'<br />
      <br />
      ( I know I wasn't doing anything with the return,<br />
      but I figured it wasn't that important )<br />
      <br />
      Does the .lib have to also be in the same directory??<br />
      <br />
      All my exported functions only return an int and<br />
      don't take any parameters.<br />
      <br />
      Also, after I make the "Call", what is the best way to<br />
      "wait" until the function "finishes"?<br />
      <br />
      If someone could point out what I'm doing wrong<br />
      I'd really appreciate it. :-)<br />
      <br />
      <br />
      Thanks,<br />
      <br />
      Joe S.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">7th December 2006 19:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">There's no need for the .lib file. It only needs to find the DLL itself. It probably fails to find the DLL, though I see you did use SetOutPath. If that's not the problem, there might be a problem with the DLL itself. You said it uses COM and your other thread said a plug-in of yours fails to initialize COM. Maybe it's the same problem.<br />
      <br />
      System::Call is fully synchronous. It doesn't open a new thread to call your function, so it'd "wait" for it to finish.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">joe131</span><br />
      <span class="post-time small text-muted">7th December 2006 20:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">My DLL has to be working right because my test app<br />
      called the exported DLL function and it created the user<br />
      perfectly. :-\<br />
      <br />
      One other thing, what's the exact syntax I need to use<br />
      for the System::Call, I haven't found a single example<br />
      where there are no input parameters and it returns an int.<br />
      <br />
      Like:<br />
      <br />
      int MyFunction()<br />
      <br />
      <br />
      Thanks,<br />
      <br />
      Joe S.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">joe131</span><br />
      <span class="post-time small text-muted">7th December 2006 20:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Here's everything, the source to the DLL, the DLL,<br />
      the source to the test app that calls the DLL, and the<br />
      test app's .exe.<br />
      <br />
      It creates a user "MobileSrvUser" and adds it to the<br />
      local Administrators group.<br />
      <br />
      After you see that it works, you can just delete<br />
      that user.<br />
      <br />
      <br />
      Thanks,<br />
      <br />
      Joe S.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">8th December 2006 02:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">To get the computer name, you can use the UserInfo plug-in.<br />
      <br />
      You can't use printf, because there's no console. Use OutputDebugString and use DebugView to view what you print.<br />
      <br />
      The wiki and the System documents have lots of examples. The readme explains everything you have to know. To call your function and have the result in $0, use:</p>
      <pre>
<code>System::Call "plugin::func()i.r0"</code>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">joe131</span><br />
      <span class="post-time small text-muted">8th December 2006 13:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">It works! :-)<br />
      <br />
      After switching from using "if ( hr != S_OK )" to<br />
      "if ( ! SUCCEEDED(hr) )" mostly for the<br />
      <br />
      hr = CoInitialize(NULL);<br />
      <br />
      Doh! lol :-)<br />
      <br />
      Everything seems to be working now, even with<br />
      my Plugin DLL! :-)<br />
      <br />
      There is one exported function that keeps failing in<br />
      my Plugin DLL, but the regular DLL version,<br />
      where I use System::Call, works fine, so I'll<br />
      probably go with using that. :-)<br />
      <br />
      Thanks for everyones help! :-)<br />
      <br />
      Joe S.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
