<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="32bit Application on 64 bit Windows Vista Home issue" />

  <title>32bit Application on 64 bit Windows Vista Home issue - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">32bit Application on 64 bit Windows Vista Home issue</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=314732">32bit Application on 64 bit Windows Vista Home issue</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">xsinx</span><br />
      <span class="post-time small text-muted">19th November 2009 20:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>32bit Application on 64 bit Windows Vista Home issue</strong><br />
      Hello everyone,<br />
      <br />
      I'm not sure this is even NSIS related but I figured I might be able to find an answer here. We have this 32bit application that we install using NSIS. This is a mainstream application and have probably around 100K clients using this application right now.<br />
      <br />
      The application EXE is VB.NET assembly forced to x86 mode. It uses about 75 external DLL's, a third of which are COM ATL 32bit DLL's, an other third are plain 32bit DLL's and the last third are .NET DLL assemblies forced to x86. It has been tested successfully on pretty much all Windows versions, including XP 32/64, Vista 32/64, Windows 7 32/64, be it home, developer, Ultimate, you name it we tested it.<br />
      <br />
      We have 2 clients for whom the COM ATL DLL's won't load (CLSIDFromProgID fails with 800401F3 "Invalid Class String"). First reaction was to check the registry and indeed, something weird is going on for these clients, the class in question is registered in CLASSES_ROOT instead of Wow6432Node as it should on a 64 bit system. I managed to get around this by forcing NSIS to use the REGSVR32 in the SysWow64 folder but the error remains exactly the same.<br />
      <br />
      After a lot of messing around, we found out that running the application as an admin for these clients fixes the issue.<br />
      <br />
      Now... Could someone explain to me:<br />
      <br />
      1. How did stuff ever get outside of the Wow6432Node in the registry? I was under the assumption that 32 bit code was restricted to that node by the virtualization system. The erroneous entries were apparently created by NSIS, we using the internal RegDLL function to register our DLL's.<br />
      <br />
      2. Why does running the app as an admin have any effect on this problem? If this is a registry issue, shouldn't an elevated account have the same problem?<br />
      <br />
      Any other info to clarify this issue would be appreciated. For now, the users are forcing their app to run as an admin but it won't be too long before another comes up which can't get an admin account (using the software in a secured workplace for instance).<br />
      <br />
      I've worked like 15 hours straight on this and I'm about to go crazy! Thanks in advance for any help you can provide.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">redxii</span><br />
      <span class="post-time small text-muted">19th November 2009 23:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Try Library.nsh: <a href="http://nsis.sourceforge.net/Docs/AppendixB.html" target="_blank">http://nsis.sourceforge.net/Docs/AppendixB.html</a><br />
      <br />
      You're thinking of redirection, and I don't believe it restricts anything from anything.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">xsinx</span><br />
      <span class="post-time small text-muted">20th November 2009 03:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">How is it different from using RegDLL? The DLL is installed in the proper folder using a "File" command in NSIS and I'm using RegDLL to register it. This is working for 99.99% of our users, why would those two have a different outcome?<br />
      <br />
      Before I even fix this, I'd like to understand what's going on... How could using an elevated account vs a non-elevated account (same account, which has admin rights) change the behaviour of CLSIDFromProgID? I want to get to the deep of this and really understand what we are doing wrong. Is this a .NET bug? a Windows bug? Some security loophole? A virus or other similar interference? A recent Windows Update that could have trigged this?<br />
      <br />
      One detail I forgot to mention is that one of these users, the one I spent the most time debugging, had this software installed for months without any issue. One morning it just didn't work anymore without any software or hardware change, it just stopped being able to load the COM object. Using elevation, the software runs as expected with no issue. How is this possible? We cleaned all reference to our software in the registry, uninstalled the software and reinstalled from scratch with the same installer that works for all our other users and it's still not working, so it's not a case of corruption of our software in particular.<br />
      <br />
      It's as if the 32 bit redirection is partially failing only in non-elevated mode, I'm totally confused by this.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">redxii</span><br />
      <span class="post-time small text-muted">20th November 2009 06:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Are any of the other 99.99% of users running a 64-bit OS? If it happened months after being installed then it isn't the installer.<br />
      <br />
      There is a program called Process Monitor by Microsoft (SysInternals), it can show you everything the program is accessing, whether or not access was denied to a particular file or registry key, and compare it to what happened ran as admin vs non-admin. I used it a lot to find out why programs don't run as administrator (usually trivial reasons like write access to a folderor registry key).</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
