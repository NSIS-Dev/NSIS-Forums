<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="cannot disable file system redirection on 64-bit Windows"><title>cannot disable file system redirection on 64-bit Windows - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">cannot disable file system redirection on 64-bit Windows</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=271513">cannot disable file system redirection on 64-bit Windows</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">SunToo</span><br><span class="post-time small text-muted">21st May 2007 07:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>cannot disable file system redirection on 64-bit Windows</strong><br>Hi,<br>I wrote an installer that detects during initialization whether it is running on 32-bit or 64-bit Windows. If the latter is true it disables file system redirection for the following reasons:<br><br>1) I want to write to the system32 directory.<br>2) I want to use the same script for both 32-bit or 64-bit Windows.<br><br>But it doesn't work. Please try running the following example installer (compiled with NSIS v2.27) on 64-bit Windows.<br><br>OutFile "test64.exe"<br>Name "test64"<br>AllowSkipFiles off<br>SetOverwrite try<br><br><br>Function .onInit<br>push $0<br>push $1<br>push $2<br><br>;disable the file system redirector for the current thread<br>System::Call 'kernel32::Wow64DisableWow64FsRedirection(*i .r1) i .r2 ?e'<br>Pop $0<br>IntCmp $2 0 0 label_OK label_OK<br>;The call failed.<br>MessageBox MB_OK "Wow64DisableWow64FsRedirection failed with error $0"<br>Abort<br>label_OK:<br>;Installation of a dummy file: This installation works.<br>File "/oname=$SYSDIR\test1.txt" "${NSISDIR}\Docs\Splash\splash.txt"<br><br>pop $2<br>pop $1<br>Pop $0<br>FunctionEnd<br><br>Section "Install"<br><br>;Installation of another dummy file: This file is installed in the wrong directory!!!<br>File "/oname=$SYSDIR\test2.txt" "${NSISDIR}\Docs\Splash\splash.txt"<br><br>SectionEnd<br><br>While test1.txt is installed correctly in the system32 directory test2.txt is installed in the wrong directory SysWOW64. Why?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">21st May 2007 09:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Why not put the code in a dummy section before all other sections instead.<br><br>Section -DisableWow64FsRedirection<br>...<br>SectionEnd<br><br>Maybe it's because the UI is not initialised until after .onInit perhaps :S<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">SunToo</span><br><span class="post-time small text-muted">21st May 2007 09:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks for you reply, Afrow UK.<br><br>The example only demonstrates the problem I detected. Actually my installer does something more. Since NSIS doesn't allow to compile real 64-bit installer, I try to simulate it as best I can. E.g., I disable file system and registry redirection during initialization.<br><br>The workaround you proposed may work for some specific installations (I didn't tested it). But installation of files doesn't only occur during installation part. And I don't want to rewrite the installer completely new for every installation task. I want to create a framework which is suitable for most installation tasks.<br><br>So I think the better solution would be to identify and solve the problem.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">21st May 2007 10:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Try moving it to .onGUIInit then.<br>If using Modern UI you will have to declare your own using !define MUI_CUSTOMFUNCTION_GUIINIT.<br><br>On a side note, you shouldn't really modify the user's system before the install files page in case the user chooses to cancel.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">SunToo</span><br><span class="post-time small text-muted">21st May 2007 10:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Regarding your side note: File system redirection is only disabled for the thread that calls Wow64DisableWow64FsRedirection. So it only affects the installer. SetRegView also only affects the installer.<br><br>Regarding the failed redirection: By what is it caused?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">21st May 2007 20:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">As you said, Wow64DisableWow64FsRedirection only affects the current thread. The thread that runs .onInit is not the same thread that runs the sections, unless you're running the installer silently.<br><br>You should <b>not</b> disable redirection for the entire installer but only for those specific files that you do wish to put in system32. That could get Windows to load the wrong DLL files in <a href="http://forums.winamp.com/showthread.php?s=&amp;threadid=262273" target="_blank">some cases</a>.<br><br>You should also use the macros from x64.nsh which make it a bit easier.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">SunToo</span><br><span class="post-time small text-muted">22nd May 2007 07:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><i>Originally posted by kichik</i><br><b>As you said, Wow64DisableWow64FsRedirection only affects the current thread. The thread that runs .onInit is not the same thread that runs the sections, unless you're running the installer silently.<br></b></blockquote>Oops, I didn't expected that because of the straight workflow of an installation. Can you tell be more about the running threads?<br><br><blockquote><b><br>You should</b> not disable redirection for the entire installer but only for those specific files that you do wish to put in system32. That could get Windows to load the wrong DLL files in <a href="http://forums.winamp.com/showthread.php?s=&amp;threadid=262273" target="_blank">some cases</a>.<br></blockquote>I'm not sure whether I understand this problem correctly. Do you mean that I have to ensure not to install my own 32-bit DLLs into the system32 directory of 64-bit Windows? Or do you mean that the NSIS framework gets some problems by loading the wrong DLLs?</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">22nd May 2007 12:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Not too much to tell. One thread runs the GUI, the other executes the sections.<br><br>As for the DLL files, you should disable redirection right before you drop a file into system32 and enable it back again right after. If you don't, the wrong DLL files may be loaded as shown in <a href="http://forums.winamp.com/showthread.php?s=&amp;threadid=262273" target="_blank">the link</a>. It could be just a bug in RichEdit, but I'd restrict the disabling of redirection to the bare minimum anyway.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Comperio</span><br><span class="post-time small text-muted">22nd May 2007 22:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Here's another way to look at it:<br><br>If you are running a 32-bit app under 64-bit, Windows redirection will take over and redirect that exe back to the 32-bit sections of the file system and registry.<br><br>If you force the install to install that EXE's components under the 64-bit sections, then it will likely fail when you run it because it won't be able to find its "parts" in the proper places.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">SunToo</span><br><span class="post-time small text-muted">23rd May 2007 14:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Now the penny has dropped. In another thread I mentioned myself the problems of loading 64-bit DLLs by a 32-bit application. But I didn't realized the problem of finding the right ones. Sorry and thanks for your patience.</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script type="text/javascript" src="../js/highlight.pack.js" async></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>