<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="upgrading protected vb6 dlls"><title>upgrading protected vb6 dlls - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">upgrading protected vb6 dlls</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=183807">upgrading protected vb6 dlls</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">freeberm</span><br><span class="post-time small text-muted">18th June 2004 22:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>upgrading protected vb6 dlls</strong><br>I have an installation package that is attempting to upgrade the following DLLs:<br>Oleaut32.dll<br>stdole2.tlb<br>msvcrt.dll<br><br>Upon installation on a machine with older libraries, the reboot prompt occurrs (correctly). However the libraries are not upgraded upon reboot.<br><br>The first two are part of the vb6 runtime libraries. The last is required for installation of the microsoft scripting runtime libraries (scrrun.dll).<br><br>I searched for and read a post by a user having the exact same problem:<br><a href="http://forums.winamp.com/showthread.php?s=&amp;threadid=122953&amp;highlight=msvcrt.dll" target="_blank">http://forums.winamp.com/showthread....ght=msvcrt.dll</a><br>where the conclusion by Joost Verburg was that the library in question (msvcrt.dll) is a protected library.<br><br>I am wondering if this is still thought to be the case or if there is a workaround that has been found (the original post is a couple of years old). I would not think the vb runtime libraries are protected. Can I verify what dlls are protected somewhere in the registry?<br><br>I am using NSIS v2.0. Here is a small snippet of code from the script:<br>*************<br>!insertmacro UpgradeDLL ${VBFILESDIR}\Oleaut32.dll $SYSDIR\Oleaut32.dll $SYSDIR<br><br>!define UPGRADEDLL_NOREGISTER<br>!insertmacro UpgradeDLL ${VBFILESDIR}\Stdole2.tlb $SYSDIR\Stdole2.tlb $SYSDIR<br>!insertmacro UpgradeDLL ${VBFILESDIR}\msvcrt.dll $SYSDIR\msvcrt.dll $SYSDIR ;required if installing scrrun<br>!undef UPGRADEDLL_NOREGISTER<br>**************<br><br>Does anyone know how to upgrade these files or what might be happening? Is it possible another app/service is grabbing the dlls before the RunOnce registry key is fired (this occurrs after a logon)? As you can tell from the code, only one file is registered but all three are set to be renamed and copied from temporary files on reboot.<br><br>Thanks for the help.<br>Sorry for the long post.<br><br>Paul</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br><span class="post-time small text-muted">18th June 2004 22:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">These OLE files are indeed protected by modern Windows versions. You can't update them, but there is also no need to update, they are linked the the operating system. Your application works fine with these files.<br><br>If you want to prevent the installer from trying to update, check the windows version during installation using the GetWindowsVersion function (ME/2000/XP have this protection).</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">freeberm</span><br><span class="post-time small text-muted">18th June 2004 22:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks! Yes the application works fine even though the upgrade does not occur.<br><br>Just a quick note though... the code for installation of the VB6 runtime files came from the following section in the NSIS documentation:<br>C.4 How to install the VB6 runtimes<br><br>It should probably be updated to reflect the need to only install if the files do not exist (since upgrade is not allowed).<br><br>Thanks again for the quick response!<br><br>Paul</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br><span class="post-time small text-muted">18th June 2004 22:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Note that you still have to upgrade all files when running Windows 95/98/NT4.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">freeberm</span><br><span class="post-time small text-muted">18th June 2004 22:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks again... I realized that after hitting send on the last post.<br><br>One other quick question. Is there a way to determine which files are protected on the system? Is there a list in the registry somewhere?<br><br>It would be nice to know for future reference since I am sure I will attempt this in the future with a different protected file.<br><br>Thanks,<br>Paul</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br><span class="post-time small text-muted">18th June 2004 23:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">There is a hidden folder called dllcache in your system folder which contains the files.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">freeberm</span><br><span class="post-time small text-muted">19th June 2004 00:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Interestingly, I checked this cache and only found two of the three files I mentioned previously. I could not find msvcrt.dll.<br><br>In searching on the net I seemed to find that the files that are protected do not necessarily exist in this directory. If they do not exist here and they are protected, the user will be prompted to insert the windows installation disk to restore the protected file.<br><br>I will keep looking for how to determine which files are protected, but as of yet I have not found a way to determine this for sure.<br><br>Thanks for the help.<br>Paul</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br><span class="post-time small text-muted">19th June 2004 23:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You can always try to remove the file on reboot. If it doesn't work the file is protected.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">freeberm</span><br><span class="post-time small text-muted">21st June 2004 19:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Unfortunately that will cause the same problem as simply attempting to upgrade the dll that is protected. I would like to avoid forcing the user to reboot when it is unecessary. In addition to being forced to reboot, the user may be required to insert their windows install disk to replace the changed dll with the protected version.<br><br>I attached code I wrote to wrap around UpgradeDLL.<br><br>Any comments would be appreciated (I'm still new to writing NSIS scripts). It works well for what I would like to do, you just need to know which files might be protected prior to calling it.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br><span class="post-time small text-muted">21st June 2004 20:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">That script doesn't work at all, remember that defines are processed on compile-time.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">freeberm</span><br><span class="post-time small text-muted">21st June 2004 20:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">freeberm</span><br><span class="post-time small text-muted">21st June 2004 21:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I guess it appeared to work since I haven't tested it on a non Windows File Protection enabled system. Thanks for the response. I will change the code.<br><br>Paul</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">freeberm</span><br><span class="post-time small text-muted">21st June 2004 21:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>corrected script</strong><br>here is a second attempt at that script. This should work as it uses variables instead of defines.<br><br>Thanks again for the help.<br><br>Paul<br><br>(I changed the script slightly so that it is no longer necessary to call CheckSFC prior to including the macro.)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br><span class="post-time small text-muted">21st June 2004 22:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">That looks better. Why define 3 unique values? One is enough.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">freeberm</span><br><span class="post-time small text-muted">21st June 2004 22:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">good point :)<br><br>I have changed the script to reflect this.<br><br>Thanks so much for your help.<br><br>(I added a comment regarding when to use this file for anyone who happens to download it.)</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script type="text/javascript" src="../js/highlight.pack.js" async></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>