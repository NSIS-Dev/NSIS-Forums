<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Issues on NSIS.pas"><title>Issues on NSIS.pas - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Issues on NSIS.pas</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=344675">Issues on NSIS.pas</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">Speed78</span><br><span class="post-time small text-muted">6th May 2012 21:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Issues on NSIS.pas</strong><br>Dear all,<br><br>my plugins should in the (near) future support unicode. The plugins are developed in Delphi 6 without any unicode support. Now I got Delphi XE2 and I refresh the current NSIS.pas from the 2.46 release to my project.<br><br>But with this update I got some strange issues:<br><br>1. My plugin crashes in the Init-Method in this line:<br><br>extrap := g_extraparameters^;<br><br>I think "g_extraparameters" is nil and this is the reason why it crashes. Without this line it works.<br><br>2. The method "LogMessage" typecasts to "PAnsiChar" in this line:<br><br>item.pszText := PAnsiChar(Msg);<br><br>This will not work in Delphi Vesions which supports Unicode by default. It must be:<br><br>item.pszText := PChar(Msg);<br><br>or<br><br>item.pszText := PWideChar(Msg);<br><br>3. After fixing the first to points in the NSIS.pas everything looks ok and my plugin works with the NSIS Unicode version without any problems. If I use the same Plugin DLL in the "ANSI"-Version of NSIS but this crashes during the execution of my NSIS-Setup.<br><br>The reason why it crashes is the following line in the method "PopString":<br><br>Result := PChar(@th.text);<br><br>If I change it to...<br><br>Result := String(PAnsiChar(@th.text));<br><br>...and it works. At this point I'm helpless because I don't understand why this works (or better why the first line doesn't work). Maybe some user of this board or another NSIS developer can give me a hint about this problem?<br><br>Maybe this can be solved in a way that NSIS.pas can be used for "ANSI"-NSIS and "Unicode"-NSIS.<br><br>As a temporarily solution I used a condition compilation.<br><br>If I want to compile for "ANSI"-NSIS I use:<br><br>Result := String(PAnsiChar(@th.text));<br><br>If I want to compile fir "Unicode"-NSIS I use:<br><br>Result := PChar(@th.text);<br><br>Kind regards<br><br>Rainer</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">7th May 2012 00:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I have not used Pascal in years so I don't really remember the details.<br><br>Why do you need String(PAnsiChar( and not just PAnsiChar(@?<br><br>Is there something in the precompiler we can use to detect if compiling as unicode?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Speed78</span><br><span class="post-time small text-muted">7th May 2012 16:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hi,<br><br>I use the String typecast to avoid a compiler warning but it is not necessary. But the typecast to "PAnsiString" is the important point. It is necessary to typecast to "PAnsiChar" if the plugin should be executed in the "ANSI" version of NSIS otherwise you will not get correct string values. So this is my code at the moment:<br><br>-------<br>{$IFDEF NSIS_UNICODE}<br>Result := PChar(@th.text); // PChar is here PWideChar<br>{$ELSE}<br>Result := String(PAnsiChar(@th.text)); // String TypeCast is only to avoid compiler warning<br>{$ENDIF}<br>-------<br><br>I thought that "AnsiStrings" are 100% complain to UnicodeString. Therefore I expect that the values in "th.text" should be converted to a UnicodeString in the "ANSI"-NSIS version but this will not work. Does anybody know why?<br><br>Kind regards<br><br>Rainer</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">7th May 2012 18:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">In ANSI NSIS, Result should be a AnsiString.<br><br>Can you redefine types?<br><br>{$IFDEF UNICODE}<br>type string = UnicodeString<br>{$ELSE}<br>type string = AnsiString //or {$H}{$P+} ?OpenString? or RawByteString?<br>{$ENDIF}<br><br>PChar would also need fixing, maybe as a helper function? UnicodeString does not exist in older versions, there you would need to use WideString. (Not sure which version from <a href="http://docwiki.embarcadero.com/RADStudio/en/Compiler_Versions" target="_blank">http://docwiki.embarcadero.com/RADSt...piler_Versions</a>)<br><br>See also:<br><a href="http://www.embarcadero.com/images/dm/technical-papers/delphi-unicode-migration.pdf" target="_blank">http://www.embarcadero.com/images/dm...-migration.pdf</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Speed78</span><br><span class="post-time small text-muted">7th May 2012 18:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hey,<br><br>the compiler directives {$H}{$P+} will not work. I just tried it.<br><br>The string type cannot be redefined but I can create an own String Type like<br><br>{$IFDEF UNICODE}<br>TString = UnicodeString;<br>PChar = PWideChar;<br>{$ELSE}<br>TString = AnsiString;<br>PChar = PAnsiChar;<br>{$ENDIF}<br><br>This will work but my current solution will work too. The problem is that I want to know why the typecast of "PChar(@th.text)" will not work in the ANSI version of NSIS.<br><br>Kind regards<br><br>Rainer</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">7th May 2012 19:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">PChar is PWideChar is Delphi 2009 and PAnsiChar in older versions</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script type="text/javascript" src="../js/highlight.pack.js" async></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>