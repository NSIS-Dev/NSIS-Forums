<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="System::Call is not working with Win98"><title>System::Call is not working with Win98 - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">System::Call is not working with Win98</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=191949">System::Call is not working with Win98</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">Gurleen</span><br><span class="post-time small text-muted">31st August 2004 00:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>System::Call is not working with Win98</strong><br>I have a custom Dll, that I use with System::Call . It works fine with 2000 , 2003 and XP , but it does not work with win98. Is it a problem with my Dll or with System:Call compatability with win98.<br><br>Eg:<br><br>System::Call 'InstLibrary::isValidProductKey(t r1)i .r2'<br>IntCmp $2 1 validKey<br>MessageBox MB_OK|MB_ICONSTOP "Key Not valid!!!"</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">KrYpT</span><br><span class="post-time small text-muted">31st August 2004 05:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">System::Call should work on Win98, AFAIK. What exactly is going wrong? (I think you can pop an error message from the stack if System::Call fails.) Also maybe check your search path; I know the different operating systems use different search paths, and that may stop it from finding your DLL.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Joel</span><br><span class="post-time small text-muted">31st August 2004 14:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">What's <b>r1</b>? Maybe some attachment I can try it in my old Win98?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Gurleen</span><br><span class="post-time small text-muted">31st August 2004 15:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I copy the dll to a temp directory. The I set the SetOutPath to that location so that system::call can see my dll</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Gurleen</span><br><span class="post-time small text-muted">31st August 2004 15:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">r1 is a string . It's a product key . I use a function in the dll to check if it's a valid key . The problem is not with the function as I tried caling several other function in the dll and none gets called.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Gurleen</span><br><span class="post-time small text-muted">31st August 2004 15:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The odd thing is that there is no error also . It skips the iferrors statement and dies on IntCmp statement. The output from the MessageBox MB_OK|MB_ICONSTOP " Output: $2"<br>is " Output: error" . Hope this may shed some light on the problem.<br><br><br>clearerrors<br>; check if the product key is valid<br>System::Call 'InstLibrary::isValidProductKey(t r1) i .r2'<br>MessageBox MB_OK|MB_ICONSTOP " Output: $2"<br>iferrors 0 moveNextInst<br>MessageBox MB_OK|MB_ICONSTOP " Error in System Call:"<br>quit<br>moveNextInst:<br>IntCmp $2 1 validKey<br>MessageBox MB_OK|MB_ICONSTOP "Key Not valid!!!"<br>Quit</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Joel</span><br><span class="post-time small text-muted">31st August 2004 15:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Sorry... same :/<br><br>From this view, I don't see problems with your last post code.... I'm still confised about <b>r1</b>, can you post how <b>r1</b> become string?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">zimsms</span><br><span class="post-time small text-muted">31st August 2004 15:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Sounds like a "no unicode support" error. Try installing unicows.dll (The win9x unicode support library) onto your 95/98/ME, NT4 box, then try again.<br><br>Those platforms listed above don't support unicode fully, and if your dll calls any unicode function, or was compiled with unicode support on a box that supports unicode, your dll may not function on these OSes.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Gurleen</span><br><span class="post-time small text-muted">31st August 2004 16:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>For Lobo Lunar -</strong><br>Now you cans ee where the value is coming from. It's a custom Page that asks for a username and a password. But that should have no effect on the outcome of the system:call<br><br>*******************************************************<br>Push ${TEMP1}<br>InstallOptions::dialog $PLUGINSDIR\CustomDialog.ini<br>Pop ${TEMP1}<br>StrCmp ${TEMP1} "success" 0 continue<br>; get the values of the Name and Product key<br>ReadINIStr $0 "$PLUGINSDIR\CustomDialog.ini" "Field 1" "State"<br><br>ReadINIStr $1 "$PLUGINSDIR\CustomDialog.ini" "Field 3" "State"<br><br>strcmp $debugMode "Yes" 0 +2<br>MessageBox MB_OK|MB_ICONSTOP " $\nName: $0 $\nKEY: $1"<br>clearerrors<br>; check if the product key is valid<br>System::Call 'InstLibrary::isValidProductKey(t r1) i .r2'<br>MessageBox MB_OK|MB_ICONSTOP " Output: $2"<br>iferrors 0 moveNextInst<br>MessageBox MB_OK|MB_ICONSTOP " Error in System Call:"<br>quit<br>moveNextInst:<br>IntCmp $2 1 validKey<br>MessageBox MB_OK|MB_ICONSTOP "Key Not valid!!!"<br>Quit<br>validKey:<br>Strcpy $UserName $0<br>StrCpy $Key $1<br>*******************************************************</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">KrYpT</span><br><span class="post-time small text-muted">31st August 2004 16:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I have no idea why this would work on any OS, but is your dll function _stdcall or _cdecl?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Gurleen</span><br><span class="post-time small text-muted">31st August 2004 17:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I use stdcall for my functions . This is what I use.<br><br>extern "C" int __stdcall isValidProductKeyNSIS( const char *productKey )</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">KrYpT</span><br><span class="post-time small text-muted">31st August 2004 17:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Is there any difference between isValidProductKey and isValidProductKeyNSIS? (and shouldn't that declaration have included a __declspec(dllexport)?)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Joel</span><br><span class="post-time small text-muted">31st August 2004 18:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Try from this:<br></p><pre>
<code><br>System::Call 'InstLibrary::isValidProductKey(t r1) i .r2'<br></code>
</pre><br>
      To this:<br>
      <pre>
<code><br>System::Call 'InstLibrary::isValidProductKey(t "$1") i .r2'<br></code>
</pre><br>
      <br>
      /edit: Forgot the "'s
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Gurleen</span><br>
      <span class="post-time small text-muted">31st August 2004 19:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">-Is there any difference between isValidProductKey and isValidProductKeyNSIS? (and shouldn't that declaration have included a __declspec(dllexport)?)<br>
      <br>
      Well I use a .def file for exporting the functions, the function name was just a misspell in the previous post , sorry about that<br>
      *****************************************************<br>
      <br>
      "Lobo Lunar"<br>
      System::Call 'InstLibrary::isValidProductKey(t "$1") i .r2'<br>
      <br>
      Well what did you wanted me to do with the "'s .Also the coe that I am using works fine with ME,2000, XP So i think there is nothing wrong with the syntax. It's just that maybe my installer cannot locate the dll.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joel</span><br>
      <span class="post-time small text-muted">31st August 2004 19:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        Well what did you wanted me to do with the "'s
      </blockquote>Nowhere :/<br>
      <br>
      Is just my personal not that I forgot to include the ".<br>
      If the path is the problem, then you should try use the <b>InitpluginsDir</b>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Gurleen</span><br>
      <span class="post-time small text-muted">31st August 2004 19:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I do use the InitpluginsDir</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joel</span><br>
      <span class="post-time small text-muted">31st August 2004 19:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Then... I rest my case.... :/</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">31st August 2004 20:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If $2 is "error" after the call, System.dll couldn't find or load the DLL or the address of the requested function.<br>
      <br>
      I suggest you try loading the DLL using a call to kernel32::LoadLibrary with the ?e flag and see what you get.<br>
      <br>
      It's probably a missing import.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Gurleen</span><br>
      <span class="post-time small text-muted">31st August 2004 20:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Can you tell me the full command name. Also where is the manual for system dll ( like the info on return values etc)<br>
      This looks like a good lead.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">31st August 2004 20:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Which command name? LoadLibrary? That's already the full name.<br>
      <br>
      The documentation is, as always, in Contrib\&lt;Plug-in name&gt;. In this case, Contrib\System\System.txt or System.html if you're using the latest CVS version.<br>
      <br>
      You should also take a look at:<br>
      <br>
      <a href="http://forums.winamp.com/showthread.php?s=&amp;threadid=180856&amp;highlight=system+documentation" target="_blank">http://forums.winamp.com/showthread....+documentation</a></p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Gurleen</span><br>
      <span class="post-time small text-muted">31st August 2004 20:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">So I need to load the dll first with kernel32::LoadLibrary<br>
      and then call system::call</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">31st August 2004 20:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">No. You should use LoadLibrary and the ?e flag to see if you get any error. If you get an error, you know something went wrong with loading the DLL and you also have the error code.<br>
      <br>
      It's a test, not a solution.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Gurleen</span><br>
      <span class="post-time small text-muted">31st August 2004 21:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You mean something like this<br>
      <br>
      System::Call 'kernel32::LoadLibrary(t "${INSTALLERDLL}\ApplianzInstallerLibrary.dll" ) v ?e'<br>
      and then pop the stack</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">31st August 2004 21:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Yes. But I'd get the return value too, just to make sure you get all the details.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Gurleen</span><br>
      <span class="post-time small text-muted">31st August 2004 21:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What is the function prototype for Kernel::LoadDll<br>
      Does it return a int or a pointer to an Int.<br>
      <br>
      System::Call 'kernel32::LoadLibrary(t "${INSTALLERDLL}\ApplianzInstallerLibrary.dll" ) i .r4 ? e'<br>
      <br>
      OR<br>
      <br>
      System::Call 'kernel32::LoadLibrary(t "${INSTALLERDLL}\ApplianzInstallerLibrary.dll" ) !i .r4 ?e'</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">31st August 2004 21:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">It returns HMODULE which you should treat as an integer.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Gurleen</span><br>
      <span class="post-time small text-muted">31st August 2004 21:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">When I pop the variable I get the result 1157 . The return value is 0.<br>
      <br>
      System::Call 'kernel32::LoadLibrary(t "${INSTALLERDLL}\ApplianzInstallerLibrary.dll" ) i .r4 ? e'<br>
      POP $5<br>
      MessageBox MB_OK|MB_ICONSTOP "Library Loadinjg Message: $5 , return value : $4"</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">31st August 2004 21:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">From WinError.h:<br>
      <br>
      #define ERROR_DLL_NOT_FOUND 1157L</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Gurleen</span><br>
      <span class="post-time small text-muted">31st August 2004 22:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">So how do I get system:: to see my dll . I have tried putting it in system folder , system32 , windows . What can it be ?<br>
      I am dining the temp dir as :<br>
      <br>
      !define INSTALLERDLL "$TEMP\eInspect"<br>
      <br>
      The I copy the dll with these commands<br>
      <br>
      SetOutPath ${INSTALLERDLL}<br>
      File C:\ApplianzDevWorkingFolder\Client\ApplianzInstallerLibrary\Debug\ApplianzInstallerLibrary.dll<br>
      <br>
      SetOutPath ${INSTALLERDLL}<br>
      System::Call 'ApplianzInstallerLibrary::isValidProductKeyNSIS(t r1) i .r2'</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">31st August 2004 22:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hmm... Lets skip this method, seems not so reliable. Go to Start-&gt;Run and type:<br>
      <br>
      regsvr32 "C:\ApplianzDevWorkingFolder\Client\ApplianzInstallerLibrary\Debug\ApplianzInstal<br>
      lerLibrary.dll"<br>
      <br>
      What does the error message say?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Gurleen</span><br>
      <span class="post-time small text-muted">31st August 2004 22:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well I am attching the screenshot of what I got after running the command.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">31st August 2004 22:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That looks like XP. Didn't you say your problem is on Windows 98?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Gurleen</span><br>
      <span class="post-time small text-muted">31st August 2004 22:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Sorry for that. I did not realise I was running the command on Xp . Well when I ran that on win98 it said "Bdd Command" . Does that mean that I am missing some basic libraries on 98 .</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">31st August 2004 22:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">No, it probably means the path is not set right. Anyway, lets just skip the testing part and assume it is a missing import. Use Dependency Walker on the DLL (from Windows 98) and see what it's missing.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Gurleen</span><br>
      <span class="post-time small text-muted">31st August 2004 22:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well I did run it. It gave the following error</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">31st August 2004 22:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Taken from:<br>
      <br>
      <a href="http://support.microsoft.com/default.aspx?scid=kb;en-us;249873" target="_blank">http://support.microsoft.com/default...b;en-us;249873</a><br>
      <br></p>

      <blockquote>
        LoadLibrary("Dllname") failed. GetlastError returns 0x00000485<br>
        <br>
        From Winerror.h, 0x00000485 = 1157 (ERROR_DLL_NOT_FOUND), which means "One of the library files needed to run this application cannot be found." For example, typing regsvr32 missing.dll returns this error message if the Missing.dll file is not found.
      </blockquote>So it really is a missing import. Use Dependecy Walker to find out which one it is.<br>
      <br>
      [edit] hmm... misread that... seems like it can't find the DLL. Assuming the DLL is really located in C:\, I'd still say it's a missing import.
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">KrYpT</span><br>
      <span class="post-time small text-muted">31st August 2004 22:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">My two bits: Why are you tring to use the debug version of the DLL? Maybe switching to a release version would help.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Gurleen</span><br>
      <span class="post-time small text-muted">31st August 2004 22:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I ran the Depends and it says I am missing msi.dll</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">31st August 2004 22:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Then you must require the user to install <a href="http://www.microsoft.com/downloads/details.aspx?FamilyID=cebbacd8-c094-4255-b702-de3bb768148f&amp;displaylang=en" target="_blank">MSI</a>, or, the more reasonable solution, remove that dependency as it makes no sense. You're already using NSIS, why would you need MSI?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Gurleen</span><br>
      <span class="post-time small text-muted">31st August 2004 23:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Thanks Man .. It Worked</strong><br>
      Well in the end it required MSI.dll . But why would it require MSI.dll . I just created a dll using VS6.0 .<br>
      But in the end it worked.. Thats what matters. Thanks a lot for helping me out. Now I can sleep tonight. Thanks to all of you who gave their input and special thanks to "kichik" for meking it work.</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>