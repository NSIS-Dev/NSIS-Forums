<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Uninstall" />

  <title>Uninstall - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Uninstall</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=327120">Uninstall</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">wili</span><br />
      <span class="post-time small text-muted">10th February 2011 12:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Uninstall</strong><br />
      Hello<br />
      <br />
      After the installation, it is possible that some folders are added in the Directory from the user where I installed my files. So i don't know all the files and folders which i've to delete with my uninstaller. Additionaly I unzipp some folder, so there ara a lot of files after the Installation.<br />
      <br />
      I'm using the Modern UI. At the moment my uninstaller looks like:<br />
      RMDir /r $INSTDIR\Installation<br />
      RMDir /r $INSTDIR\play<br />
      RMDir /r $INSTDIR\myfolder<br />
      <br />
      I know it is a bit dangerous. I searched a while and only found the "Uninstall only installed files" unlist.nsi. But this function only create a list during the installation. And i'm looking for creating a list during uninstallation, while some files and order are added after my installation.<br />
      <br />
      Does it already exist a function which search every file and folder in the installed directory and delete each file?<br />
      Maybe I missed a simple plug-in or something similar?<br />
      <br />
      Thanks and Regards,<br />
      Wili</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">10th February 2011 14:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by wili</small><br />
        Does it already exist a function which search every file and folder in the installed directory and delete each file?
      </blockquote>Think again please. "Make a list of all files and folders, and then delete the items on that list", is EXACTLY the same as "Delete all files and folders".<br />
      <br />
      If you don't know what you want to delete, Delete /r is the only possible solution. This probably means that you need to change your application, so that you DO know what you want to delete.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">wili</span><br />
      <span class="post-time small text-muted">10th February 2011 15:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi<br />
      <br />
      Thanks for your answer.<br />
      Does theire exist a function which generate a list of all files and folders during the Uninstall Section?<br />
      <br />
      Thanks and Regards,<br />
      Marco</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">10th February 2011 17:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What I would do is write a small program (it could be a silent NSIS executable) and run it at compile time using !system. It will simply write the NSIS File instructions to one file (which you !include in your install section(s)) and the NSIS Delete instructions to another file (which you !include in your uninstall section(s)). If you write the executable in NSIS, you can use Locate (look in the manual). Job done.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">wili</span><br />
      <span class="post-time small text-muted">11th February 2011 10:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks a lot for your hints.<br />
      <br />
      I'll change my uninstaller Ideas.<br />
      Last Question, is it possible to figure when unistaller.exe is launched, on with path it was stored?<br />
      <br />
      The $EXEPATH, etc. shows the path where it is executed.<br />
      But I'm looking to read out, where the uninstaller was store. Is theire a simple way?<br />
      <br />
      Thanks and regards,<br />
      Marco</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">11th February 2011 10:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">In the uninstaller, $INSTDIR contains the directory of uninstall.exe. (Note: This is also why it's so dangerous to do RmDir /r $INSTDIR, because someone might have moved uninstall.exe to Program Files!)<br />
      <br />
      You can store the actual installation directory in an ini file or the registry, during installation. (You can also use that to check if uninstall.exe has been moved, before you start the uninstallation.)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">wili</span><br />
      <span class="post-time small text-muted">11th February 2011 11:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks a lot.<br />
      So i'll check if the uninstaller.exe is still at the same folder (with filexists...).<br />
      <br />
      Regards,<br />
      Marco</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">11th February 2011 16:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What would you want to do with FileExists? o_O<br />
      <br />
      ReadRegStr $0 HKLM YourRegKey YourRegString<br />
      ${If} $0 != $INSTDIR<br />
      MessageBox MB_OK "Warning here"<br />
      ${EndIf}</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Smurge</span><br />
      <span class="post-time small text-muted">1st May 2011 16:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have realised the danger of RMDir /r "$INSTDIR", even if it is a really small possibility that a user move the Uninstall.exe to another directory...<br />
      <br />
      so I thought about a solution for my script and just replace the $INSTDIR with value from the registry. My questions: Why does this not work? (the installdir is untouched after uninstall is finished - nothing is deleted! but the key is there and is been showed "MessageBox MB_OK "echo - $0")<br />
      and: is there another universal solution?<br />
      <br />
      example:<br /></p>
      <pre>
<code>Section</code><span style="color: #007700">-</span><span style="color: #0000BB">End
<br />WriteUninstaller</span><span style="color: #DD0000">"$INSTDIR\Uninstall.exe"
<br /></span><span style="color: #0000BB">WriteRegStrHKLM</span><span style="color: #DD0000">"Software\Microsoft\Windows\CurrentVersion\Uninstall\myprogram""UninstallString"'"$INSTDIR\Uninstall.exe"'
<br /></span><span style="color: #0000BB">WriteRegStrHKLM</span><span style="color: #DD0000">"Software\Microsoft\Windows\CurrentVersion\Uninstall\myprogram""DisplayIcon"'"$INSTDIR\myprogram.exe"'
<br /></span><span style="color: #0000BB">WriteRegStrHKLM</span><span style="color: #DD0000">"Software\Microsoft\Windows\CurrentVersion\Uninstall\myprogram""InstallPath"'"$INSTDIR"'
<br /></span><span style="color: #0000BB">SectionEnd
<br /><br /><br />Section</span><span style="color: #DD0000">"Uninstall"
<br /></span><span style="color: #007700">.
<br /></span><span style="color: #0000BB">ReadRegStr</span><span style="color: #007700">$</span><span style="color: #0000BB">0HKLM</span><span style="color: #DD0000">"Software\Microsoft\Windows\CurrentVersion\Uninstall\myprogram""InstallPath"
<br /></span><span style="color: #0000BB">RMDir</span><span style="color: #007700">/</span><span style="color: #0000BB">r</span><span style="color: #007700">$</span><span style="color: #0000BB">0
<br /></span><span style="color: #007700">.
<br /></span><span style="color: #0000BB">SectionEnd
<br /></span>

<!-- php buffer end -->
                
                
                
</pre>
      <hr />
      <pre>
        
bye
                
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">1st May 2011 17:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If you checked the value of $0 you'd know. You've put quotes around the value in the registry. Also your script is just as bad as using $INSTDIR. If someone deletes that registry value, RMDIR will be given an empty string, i.e. the <b>root</b> and delete EVERYTHING. Please either avoid RMDir completely or do at least some validation on the path you are giving it.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Smurge</span><br />
      <span class="post-time small text-muted">1st May 2011 18:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">hi<br />
      <br />
      -but RMDir /r "$INSTDIR" have also quotes and it works,... the $0 includes the "" so i removed them in the script -&gt; RMDir /r $0<br />
      <br /></p>

      <blockquote>
        The error flag will be set and $x will be set to an empty string ("") if the string is not present.
      </blockquote>RMDir /r "" -&gt; doesn NOT delete ROOT or anything else. I tested it right now on the VM. =)<br />
      <br />
      I think, the best way will be to check that the last dir is ..."/MyProgram" to make sure the User didnt use "C:\" or "C:\Program Files" as installation directory!? but how to do it?<br />
      <br />
      btw. That some one deletes the Reg entry is very unlikely, IMHO<br />
      <br />
      --------------<br />
      I have testet your Example: <a href="http://nsis.sourceforge.net/Uninstall_only_installed_files" target="_blank">http://nsis.sourceforge.net/Uninstal...nstalled_files</a><br />
      But it does not work. I guess it is because of * or *.*<br />
      This is what i use in my script:<br />
      <br />
      PHP Code:
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">Section</span><span style="color: #DD0000">"MainFiles"</span><span style="color: #0000BB">test32<br />
      <br />
      SectionInRO<br />
      SetOutPath$INSTDIR<br />
      File</span><span style="color: #007700">/</span><span style="color: #0000BB">r</span><span style="color: #DD0000">"${BIN}\*"<br />
      <br />
      <br /></span> <span style="color: #007700">${If}${</span><span style="color: #0000BB">RunningX64</span><span style="color: #007700">}<br /></span> <span style="color: #0000BB">File</span><span style="color: #007700">/</span><span style="color: #0000BB">r</span><span style="color: #DD0000">"${BIN64}\*.*"<br /></span> <span style="color: #007700">${EndIf}<br />
      <br />
      <br />
      ${If}${</span><span style="color: #0000BB">IsWin2000</span><span style="color: #007700">}<br /></span> <span style="color: #0000BB">File</span><span style="color: #007700">/</span><span style="color: #0000BB">r</span><span style="color: #DD0000">"${BINWin2k}\*.*"<br /></span> <span style="color: #007700">${EndIf}<br /></span> <span style="color: #0000BB">SectionEnd<br /></span></span> <!-- php buffer end -->
      <hr />
      <br />
      when i try to use your script, the compiller breaks with:<br />

      <blockquote>
        -&gt;$UninstLog<br />
        Usage: File [/nonfatal] [/a] ([/r] [/x filespec [...]] filespec [...] |<br />
        /oname=outfile one_file_only)<br />
        Error in macro File on macroline 3<br />
        Error in script "stdin" on line 270 -- aborting creation process
      </blockquote>I implement it exactly as you described.<br />
      The line of error:<br />
      ${File} /r "${BIN}\*"<br />
      <br />
      bye
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">1st May 2011 19:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by Smurge</small><br />
        btw. That some one deletes the Reg entry is very unlikely, IMHO
      </blockquote>The regentry not existing is actually far more likely than a user moving uninstall.exe. And the consequences if it happens are far far worse. So summing up, your method is <b>extremely</b> dangerous. (Example: User installs to D:\Software\YourApp, then formats C: and reinstalls windows, then runs your uninstaller. As you can see, this could happen very easily.)<br />
      <br />
      <br />
      Here's what I do:<br />
      PHP Code:
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #007700">;</span><span style="color: #0000BB">Checkvalidityofthe$INSTDIRvariable<br /></span> <span style="color: #007700">${If}</span><span style="color: #0000BB">$ALLUSERS</span><span style="color: #007700">==</span><span style="color: #0000BB">1<br />
      ReadRegStr</span><span style="color: #007700">$</span><span style="color: #0000BB">2HKLM</span><span style="color: #DD0000">"Software\${REGKEY_GROUP}\${REGKEY_NAME}""InstallDir"<br /></span> <span style="color: #007700">${Else}<br /></span> <span style="color: #0000BB">ReadRegStr</span><span style="color: #007700">$</span><span style="color: #0000BB">2HKCU</span><span style="color: #DD0000">"Software\${REGKEY_GROUP}\${REGKEY_NAME}""InstallDir"<br /></span> <span style="color: #007700">${EndIf}<br />
      ${If}$</span><span style="color: #0000BB">2</span><span style="color: #007700">!=</span><span style="color: #0000BB">$INSTDIR<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Somethingiswrong</span><span style="color: #007700">!</span><span style="color: #0000BB">Fallbacktochecking</span><span style="color: #007700">for</span><span style="color: #0000BB">filenames</span><span style="color: #007700">.<br />
      ${</span><span style="color: #0000BB">IfNot</span><span style="color: #007700">}${</span><span style="color: #0000BB">FileExists</span><span style="color: #007700">}</span><span style="color: #DD0000">"$INSTDIR\MyApp.exe"<br /></span> <span style="color: #007700">${</span><span style="color: #0000BB">OrIfNot</span><span style="color: #007700">}${</span><span style="color: #0000BB">FileExists</span><span style="color: #007700">}</span><span style="color: #DD0000">"$INSTDIR\MyOtherFile.dat"<br /></span> <span style="color: #007700">${</span><span style="color: #0000BB">OrIfNot</span><span style="color: #007700">}${</span><span style="color: #0000BB">FileExists</span><span style="color: #007700">}</span><span style="color: #DD0000">"$INSTDIR\Etcetera.etc"<br /></span> <span style="color: #0000BB">MessageBoxMB_YESNO</span><span style="color: #007700">|</span><span style="color: #0000BB">MB_ICONEXCLAMATION</span><span style="color: #DD0000">"WARNING:Setupcouldnotverifythatthisuninstallerisbeingrunfromitsproper\<br />
      directory.IfyouhavemovedUninstall.exetoadirectoryotherthantheactualinstallationfolder,itis\<br />
      impossibletoguaranteethattheuninstallationwillbeexecutedproperly.Ifyouproceed,itistheoretically\<br />
      possiblethatsetupwilldeletefilesthatshouldnotbedeleted.Areyousureyouwishtocontinuewith\<br />
      theuninstallation?"</span><span style="color: #0000BB">IDYES</span><span style="color: #007700">+</span><span style="color: #0000BB">2<br />
      quit</span><span style="color: #007700">;</span><span style="color: #0000BB">quitinstaller</span><span style="color: #007700">.<br />
      ${EndIf}<br />
      ${EndIf}</span> This is still not waterproof safe. But it's pretty safe as long as the filenames in my software (MyApp.exe and the others) are very specific and unlikely to be used in other software.<br />
      <br />
      And together with the above code, I NEVER use RmDir /r, no matter how badly I want to. I only delete the files I know I should delete. Nothing else. It's just a matter of courtesy to your users that you don't take frivolous risks with their computers. Even if it means leaving some files behind after uninstall, there's just no excuse to risk destroying someone's OS.<br />
      <br /></span>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Smurge</span><br />
      <span class="post-time small text-muted">1st May 2011 21:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">This doesn't cover the case when the user installed the app in C:\ ... :D<br />
      hmm, so ideally the installer should delete 1 file at the time, and delete directory's only if the dir is empty?<br />
      <br />
      Thanks for the example. I will use it in my script. But what i don't understand is the "$ALLUSERS == 1" thing.<br />
      I didn't find this Variable in the manual. Is this automatically detected when "SetShellVarContext all" is set previously? or do i need a "!include ..." to use this?<br />
      <br />
      bye</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">1st May 2011 21:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        -but RMDir /r "$INSTDIR" have also quotes and it works,... the $0 includes the "" so i removed them in the script -&gt; RMDir /r $0
      </blockquote>That is the same as doing <b>RMDir /r '"some_path"'</b>. RMDir does not accept quotes around its path.

      <blockquote>
        RMDir /r "" -&gt; doesn NOT delete ROOT or anything else. I tested it right now on the VM. =)
      </blockquote>Looks like code was added quite a while ago to prevent this. My bad.

      <blockquote>
        I think, the best way will be to check that the last dir is ..."/MyProgram" to make sure the User didnt use "C:\" or "C:\Program Files" as installation directory!? but how to do it?
      </blockquote>Use StrCpy $0 $path "" -X to get the last X characters of the path.

      <blockquote>
        when i try to use your script, the compiller breaks with:<br />
        <br />
        I implement it exactly as you described.<br />
        The line of error:<br />
        ${File} /r "${BIN}\*"
      </blockquote>You cannot use the recursive switch as the macro requires you to explicitly tell it each file name/path. If you need to use these macros but with recursion then you need to write a program that generates the NSIS script (i.e. the individual ${File} instructions for each file).<br />
      <br />
      Stu
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">1st May 2011 21:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Ignore that $ALLUSERS bit. Uninstall registry is always under HKLM.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Smurge</span><br />
      <span class="post-time small text-muted">1st May 2011 21:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        That is the same as doing RMDir /r '"some_path"'. RMDir does not accept quotes around its path.
      </blockquote>I just assumed that the Path have to be in "". I dint know that it needed ' to function properly. All examples i read, had "" with RMDir! so what is the problem with it?<br />
      <br />
      The manual don't show any necessary format:<br />
      <a href="http://nsis.sourceforge.net/Docs/Chapter4.html#4.9.1.8" target="_blank">http://nsis.sourceforge.net/Docs/Chapter4.html#4.9.1.8</a><br />
      <br />
      --------<br />

      <blockquote>
        <small>Originally posted by Afrow UK</small><br />
        If you need to use these macros but with recursion then you need to write a program that generates the NSIS script (i.e. the individual ${File} instructions for each file).
      </blockquote>This is too complex for me. I don't have any professional programming skills.<br />
      <br />
      Cant i just use the ${File} ..\* for the app and any sub directory? will this delete/uninstall those sub dirs as well?<br />
      <br />
      ------<br />
      <br />
      by ignore you mean to skip the IF? like this:<br />
      <br />
      <pre>
<code>ReadRegStr</code><span style="color: #007700">$</span><span style="color: #0000BB">2HKLM</span><span style="color: #DD0000">"Software\${REGKEY_GROUP}\${REGKEY_NAME}""InstallDir"
<br /></span><span style="color: #007700">${If}$</span><span style="color: #0000BB">2</span><span style="color: #007700">!=</span><span style="color: #0000BB">$INSTDIR
<br /></span><span style="color: #007700">;</span><span style="color: #0000BB">Somethingiswrong</span><span style="color: #007700">!</span><span style="color: #0000BB">Fallbacktochecking</span><span style="color: #007700">for</span><span style="color: #0000BB">filenames</span><span style="color: #007700">.
<br />${</span><span style="color: #0000BB">IfNot</span><span style="color: #007700">}${</span><span style="color: #0000BB">FileExists</span><span style="color: #007700">}</span><span style="color: #DD0000">"$INSTDIR\MyApp.exe"
<br /></span><span style="color: #007700">${</span><span style="color: #0000BB">OrIfNot</span><span style="color: #007700">}${</span><span style="color: #0000BB">FileExists</span><span style="color: #007700">}</span><span style="color: #DD0000">"$INSTDIR\MyOtherFile.dat"
<br /></span><span style="color: #007700">${</span><span style="color: #0000BB">OrIfNot</span><span style="color: #007700">}${</span><span style="color: #0000BB">FileExists</span><span style="color: #007700">}</span><span style="color: #DD0000">"$INSTDIR\Etcetera.etc"
<br /></span><span style="color: #0000BB">MessageBoxMB_YESNO</span><span style="color: #007700">|</span><span style="color: #0000BB">MB_ICONEXCLAMATION</span><span style="color: #DD0000">"WARNING:Setupcouldnotverifythatthisuninstallerisbeingrunfromitsproper\
<br />directory.IfyouhavemovedUninstall.exetoadirectoryotherthantheactualinstallationfolder,itis\
<br />impossibletoguaranteethattheuninstallationwillbeexecutedproperly.Ifyouproceed,itistheoretically\
<br />possiblethatsetupwilldeletefilesthatshouldnotbedeleted.Areyousureyouwishtocontinuewith\
<br />theuninstallation?"</span><span style="color: #0000BB">IDYES</span><span style="color: #007700">+</span><span style="color: #0000BB">2
<br />quit</span><span style="color: #007700">;</span><span style="color: #0000BB">quitinstaller</span><span style="color: #007700">.
<br />${EndIf}
<br />${EndIf}
</span>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">1st May 2011 22:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        Cant i just use the ${File} ..\* for the app and any sub directory? will this delete/uninstall those sub dirs as well?
      </blockquote>No you can't I'm afraid. If you really want to only uninstall installed files you will have to explicitly include File instructions for each file as a bare minimum. That script will generate a text file listing the files and folders to later delete during uninstall, saving you from having to write those Delete instructions yourself. In my opinion though, it is better to explicitly write the Delete instructions in the uninstaller too, rather than rely on an external text file. If the text file goes missing then you get problems, yet again.

      <blockquote>
        by ignore you mean to skip the IF? like this:
      </blockquote>That is correct.<br />
      <br />
      Stu
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">1st May 2011 22:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Also remember the uninstall code needs to delete in reverse order to the order that the files were extracted/created. E.g.</p>
      <pre>
<code>Section Install<br />  SetOutPath 1<br />  File a<br />  SetOutPath 1\2<br />  File b<br />  SetOutPath 1\2\3<br />  File c<br />SectionEnd<br />Section Uninstall<br />  Delete 1\2\3\c<br />  RMDir 1\2\3<br />  Delete 1\2\b<br />  RMDir 1\2<br />  Delete 1\a<br />  RMDir 1<br />SectionEnd</code>
</pre>Stu
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">2nd May 2011 06:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by Smurge</small><br />
        This doesn't cover the case when the user installed the app in C:\ ... :D
      </blockquote>Actually I disallow root-directory installations, as well as installs to $PROGRAMFILES, $WINDIR etc, on my DIRECTORY page. But you're very right, I should add a check for these directories in the uninstaller as well, in case some joker moves uninstall.exe to one of those directories. :-)<br />
      <br />

      <blockquote>
        <small>Originally posted by Smurge</small><br />
        hmm, so ideally the installer should delete 1 file at the time, and delete directory's only if the dir is empty?
      </blockquote>Yeah, that's the only safe way to do it.<br />
      <br />

      <blockquote>
        <small>Originally posted by Smurge</small><br />
        I just assumed that the Path have to be in "". I dint know that it needed ' to function properly. All examples i read, had "" with RMDir! so what is the problem with it?
      </blockquote>The *parameter* of RmDir should be without quotes. The *command call* to RmDir may have quotes, because those quotes are for the compiler. If you do this: RmDir "$INSTDIR\something", then the compiler removes those quotes for you. But if you do RmDir $0, and $0 contains quotes itself, then the compiler cannot prevent the quote characters from ending up in the RmDir parameter. That's why you need to strip quote characters after reading a path string from registry (if there's a chance that the string contains quotes).<br />
      <br />

      <blockquote>
        <small>Originally posted by Afrow UK</small><br />
        Uninstall registry is always under HKLM.
      </blockquote>Single-user installations' ARP info is stored in HKCU, actually.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">2nd May 2011 10:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        Single-user installations' ARP info is stored in HKCU, actually.
      </blockquote>That's interesting. There isn't even an Uninstall key under HKCU but if I create one and add an entry to does work. I wonder why that isn't used more often.<br />
      <br />
      Edit: And for all this time I've been avoiding add/remove programs and using an Uninstall short-cut only lol. Thanks :)<br />
      <br />
      Stu
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Smurge</span><br />
      <span class="post-time small text-muted">2nd May 2011 11:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">so back to my question: what do i need to use the "$ALLUSERS == 1"<br />
      Your example is working in my installer, when i move the deinstaller to another location the MassageBox pops out.<br />
      There is only a tiny flaw... the compiler shows a warning:<br /></p>

      <blockquote>
        1 warning:<br />
        unknown variable/constant "ALLUSERS" detected, ignoring (macro:_==:1)
      </blockquote>-------<br />
      btw. the '"$INSTDIR\myprogram.exe"' only happened because i copy-pasted this line from another script. I removed the quotes from all WriteRegStr and now its working perfectly!<br />
      <br />
      thanks
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">2nd May 2011 11:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">MSG was just giving you an idea to use that variable to indicate an all users / current user install. Doesn't mean you need to use it.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Smurge</span><br />
      <span class="post-time small text-muted">2nd May 2011 13:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have modified the example a little bit. This is what i use:<br />
      <br /></p>
      <pre>
<code>Section</code><span style="color: #007700">-</span><span style="color: #0000BB">End
<br /></span><span style="color: #007700">.
<br /></span><span style="color: #0000BB">WriteUninstaller</span><span style="color: #DD0000">"$INSTDIR\Uninstall.exe"
<br /></span><span style="color: #0000BB">WriteRegStrHKLM</span><span style="color: #DD0000">"Software\Microsoft\Windows\CurrentVersion\Uninstall\myprogram""InstallPath"'$INSTDIR'
<br /></span><span style="color: #007700">.
<br /></span><span style="color: #0000BB">SectionEnd
<br /><br /><br />Section</span><span style="color: #DD0000">"Uninstall"
<br /></span><span style="color: #007700">.
<br />;</span><span style="color: #FF8000">#Checkvalidityofthe$INSTDIRvariable.Comparestheuninstall.exelocationwiththeRegKeyvalue.
<br /></span><span style="color: #0000BB">ReadRegStr</span><span style="color: #007700">$</span><span style="color: #0000BB">2HKLM</span><span style="color: #DD0000">"Software\Microsoft\Windows\CurrentVersion\Uninstall\myprogram""InstallPath"
<br /></span><span style="color: #0000BB">IfErrors0</span><span style="color: #007700">+</span><span style="color: #0000BB">2
<br />ReadRegStr</span><span style="color: #007700">$</span><span style="color: #0000BB">2HKCU</span><span style="color: #DD0000">"Software\Microsoft\Windows\CurrentVersion\Uninstall\myprogram""InstallPath"
<br /></span><span style="color: #007700">${If}$</span><span style="color: #0000BB">2</span><span style="color: #007700">!=</span><span style="color: #0000BB">$INSTDIR
<br /></span><span style="color: #007700">;</span><span style="color: #FF8000">#Somethingiswrong!Fallbacktocheckingforfilenames.
<br /></span><span style="color: #007700">${</span><span style="color: #0000BB">IfNot</span><span style="color: #007700">}${</span><span style="color: #0000BB">FileExists</span><span style="color: #007700">}</span><span style="color: #DD0000">"$INSTDIR\MyProgram.exe"
<br /></span><span style="color: #0000BB">MessageBoxMB_OKCANCEL</span><span style="color: #007700">|</span><span style="color: #0000BB">MB_ICONEXCLAMATION</span><span style="color: #DD0000">"WARNING:Setupcouldnotverifythatthisuninstallerisbeingrunfromitsproper\
<br />directory.IfyouhavemovedUninstall.exetoadirectoryotherthantheactualinstallationfolder,itis\
<br />impossibletoguaranteethattheuninstallationwillbeexecutedproperly.Ifyouproceed,itistheoretically\
<br />possiblethatsetupwilldeletefilesthatshouldnotbedeleted.Areyousureyouwishtocontinuewith\
<br />theuninstallation?$\r$\r-OKtocontinueanduninstalltheapplicationfrom:$\r$\n'$2'$\r$\n-CANCELtoend"</span><span style="color: #0000BB">IDOK</span><span style="color: #007700">+</span><span style="color: #0000BB">2
<br />quit</span><span style="color: #007700">;</span><span style="color: #FF8000">#quitinstaller.
<br /></span><span style="color: #007700">${EndIf}
<br />${EndIf}
<br />.
<br /></span><span style="color: #0000BB">RMDir</span><span style="color: #007700">/</span><span style="color: #0000BB">r</span><span style="color: #007700">$</span><span style="color: #0000BB">2
<br /></span><span style="color: #007700">.
<br /></span><span style="color: #0000BB">SectionEnd
<br /></span>

<!-- php buffer end -->
                
                
                
</pre>
      <hr />
      <pre>
        
<br />I think, together with the Path saved in the RegKey and the user feedback, it is a good compromise.
                
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">2nd May 2011 14:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I would add a ClearErrors above ReadRegStr just in case you later add code which may set the error flag. Also, should that not be an OR (you are implying an AND by using two If statements. I.e. it should be <b>If $2 != $INSTDIR OR !FileExists $INSTDIR\MyProgram.exe</b>). With your code, if someone moves the uninstall executable to another folder with a MyProgram.exe in it (unlikely I know), then the uninstall will continue.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">2nd May 2011 18:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Stu: That depends on what you decide is more important. If my regentry is there and the value matches $instdir, then I don't check which files are there. This is in order to support rollback in case of installation failure (the regkey is created first thing during installation). But yeah, Or might be the better option generally speaking.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Smurge</span><br />
      <span class="post-time small text-muted">3rd May 2011 18:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for the tip, i extended the script with the ClearErrors, changed it to an OR case and added a check for the RegKey existence in "un.onInit". But i dont get the result i expected.<br />
      <br />
      1. Question: Why is ${Usedinstpath} defined, even if it is "jumped" by a GOTO? (in the un.onInit part)<br />
      2. Question: Why does the Uninstaller not delete the directory that is defined in $2 and ${Usedinstpath}? (the App Directory remains untouched after successful uninstallation)<br />
      <br />
      <br />
      PHP Code:</p>
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #007700">Function</span><span style="color: #0000BB">un</span><span style="color: #007700">.</span><span style="color: #0000BB">onInit<br /></span> <span style="color: #007700">;</span><span style="color: #FF8000">#CheckexistenceoftheRegKey.Ifnotthere(incaseofanerrororwindowsreinstallation)thentrytotousethecurrentInstallerlocationaspath<br /></span> <span style="color: #0000BB">ClearErrors<br />
      ReadRegStr</span><span style="color: #007700">$</span><span style="color: #0000BB">1HKLM</span><span style="color: #DD0000">"Software\Microsoft\Windows\CurrentVersion\Uninstall\Hybrid""InstallPath"<br /></span> <span style="color: #0000BB">IfErrors0</span><span style="color: #007700">+</span><span style="color: #0000BB">2<br />
      ReadRegStr</span><span style="color: #007700">$</span><span style="color: #0000BB">1HKCU</span><span style="color: #DD0000">"Software\Microsoft\Windows\CurrentVersion\Uninstall\Hybrid""InstallPath"<br /></span> <span style="color: #0000BB">IfErrors</span><span style="color: #DD0000">""</span><span style="color: #0000BB">goout<br /></span> <span style="color: #007700">;</span><span style="color: #FF8000">#Asktousepathorelseabort<br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">ifndef</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      MessageBoxMB_YESNO</span><span style="color: #007700">|</span><span style="color: #0000BB">MB_ICONQUESTION</span><span style="color: #DD0000">"Cantdeterminetheinstallpathfromregistry.Shalltheinstallerusethecurrentlocationoftheinstaller?$\r$\nInstallerpath?-&gt;'$INSTDIR'"</span><span style="color: #0000BB">IDYESdefinepath<br />
      quit<br />
      definepath</span><span style="color: #007700">:<br />
      !</span><span style="color: #0000BB">defineUsedinstpath</span><span style="color: #DD0000">"$INSTDIR"<br /></span> <span style="color: #007700">!endif<br /></span> <span style="color: #0000BB">goout</span><span style="color: #007700">:<br />
      <br />
      ;</span><span style="color: #0000BB">INFO<br />
      MessageBoxMB_OK</span><span style="color: #DD0000">"1-s1-$1$\r$\ninstdir-$INSTDIR$\r$\nuserinstpath-${Usedinstpath}"<br />
      <br /></span> <span style="color: #0000BB">FunctionEnd<br />
      <br />
      <br />
      Section</span><span style="color: #DD0000">"Uninstall"<br />
      <br /></span> <span style="color: #0000BB">SetShellVarContextall<br /></span> <span style="color: #007700">;</span><span style="color: #FF8000">#Checkvalidityofthe$INSTDIRvariable.Comparestheuninstall.exelocationwiththeRegKeyvalue.<br /></span> <span style="color: #0000BB">ClearErrors<br />
      ReadRegStr</span><span style="color: #007700">$</span><span style="color: #0000BB">2HKLM</span><span style="color: #DD0000">"Software\Microsoft\Windows\CurrentVersion\Uninstall\Hybrid""InstallPath"<br /></span> <span style="color: #0000BB">IfErrors0</span><span style="color: #007700">+</span><span style="color: #0000BB">2<br />
      ReadRegStr</span><span style="color: #007700">$</span><span style="color: #0000BB">2HKCU</span><span style="color: #DD0000">"Software\Microsoft\Windows\CurrentVersion\Uninstall\Hybrid""InstallPath"<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">INFO<br />
      MessageBoxMB_OK</span><span style="color: #DD0000">"2-s2-$2$\r$\ninstdir-$INSTDIR$\r$\nuserinstpath-${Usedinstpath}"<br />
      <br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">2</span><span style="color: #007700">!=</span><span style="color: #0000BB">$INSTDIR<br />
      GOTOcantfinddirwarning<br /></span> <span style="color: #007700">${EndIf}<br />
      ${</span><span style="color: #0000BB">IfNot</span><span style="color: #007700">}${</span><span style="color: #0000BB">FileExists</span><span style="color: #007700">}</span><span style="color: #DD0000">"$INSTDIR\Hybrid.exe"<br /></span> <span style="color: #0000BB">GOTOcantfinddirwarning<br /></span> <span style="color: #007700">${EndIf}<br /></span> <span style="color: #0000BB">GOTOstartuninstall<br />
      <br />
      cantfinddirwarning</span><span style="color: #007700">:<br />
      ;</span><span style="color: #FF8000">#Somethingiswrong!Fallbacktocheckingforfilenames.<br /></span> <span style="color: #0000BB">MessageBoxMB_OKCANCEL</span><span style="color: #007700">|</span><span style="color: #0000BB">MB_ICONEXCLAMATION</span><span style="color: #DD0000">"WARNING:Setupcouldnotverifythatthisuninstallerisbeingrunfromitsproper\<br />
      directory.IfyouhavemovedUninstall.exetoadirectoryotherthantheactualinstallationfolder,itis\<br />
      impossibletoguaranteethattheuninstallationwillbeexecutedproperly.Ifyouproceed,itistheoretically\<br />
      possiblethatsetupwilldeletefilesthatshouldnotbedeleted.Areyousureyouwishtocontinuewith\<br />
      theuninstallation?$\r$\r-OKtocontinueanduninstalltheapplicationfrom:$\r$\n'$2${Usedinstpath}'$\r$\n-CANCELtoend"</span><span style="color: #0000BB">IDOK</span><span style="color: #007700">+</span><span style="color: #0000BB">2<br />
      quit</span><span style="color: #007700">;</span><span style="color: #FF8000">#quitinstaller.<br />
      <br />
      <br /></span> <span style="color: #0000BB">startuninstall</span><span style="color: #007700">:<br />
      !</span><span style="color: #0000BB">ifdef</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      RMDir</span><span style="color: #007700">/</span><span style="color: #0000BB">r</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br /></span> <span style="color: #007700">!endif<br />
      !</span><span style="color: #0000BB">ifdef</span><span style="color: #007700">${</span><span style="color: #0000BB">Usedinstpath</span><span style="color: #007700">}<br /></span> <span style="color: #0000BB">RMDir</span><span style="color: #007700">/</span><span style="color: #0000BB">r</span><span style="color: #007700">${</span><span style="color: #0000BB">Usedinstpath</span><span style="color: #007700">}<br />
      !endif</span> thx<br />
      <br /></span>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">3rd May 2011 19:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by Smurge</small><br />
        1. Question: Why is ${Usedinstpath} defined, even if it is "jumped" by a GOTO? (in the un.onInit part)
      </blockquote>Because !defines are executed at compiletime, whereas gotos are runtime commands. You'll need to learn the difference between compiletime and runtime. Google may have some explanations.<br />
      <br />

      <blockquote>
        <small>Originally posted by Smurge</small><br />
        2. Question: Why does the Uninstaller not delete the directory that is defined in $2 and ${Usedinstpath}?
      </blockquote>Because "$2" is not a define, so "!ifdef $2" is always false and the compiler completely skips the RmDir command. You need to use ${If} $2 != "" . Once again, you're confusing compiletime with runtime.
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
