<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Signing an uninstaller when script runs on a networked drive..."><title>Signing an uninstaller when script runs on a networked drive... - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Signing an uninstaller when script runs on a networked drive...</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=344265">Signing an uninstaller when script runs on a networked drive...</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">kinar</span><br><span class="post-time small text-muted">20th April 2012 22:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Signing an uninstaller when script runs on a networked drive...</strong><br>I'm using a slightly modified version of <a href="http://nsis.sourceforge.net/Signing_an_Uninstaller" target="_blank">http://nsis.sourceforge.net/Signing_an_Uninstaller</a><br><br>When I run my script on a local drive, it works fine...<br><br>However, when we build the installer for our release builds, it runs on a networked location. In this scenario, the following line fails<br><br>!system '$\"${NSISDIR}\makensis.exe$\" /DWRITE_TEMP_UNINSTALLER_FOR_SIGNING .\${__FILE__}' = 0<br><br>With the error:<br><br>Can't open script ".\my_script.nsi"<br>!system: returned 1, aborting<br>Error in script "\\networklocation\my_script.nsi" on line 135 -- aborting creation process<br><br>My only guess is that I need to fully path the script location but I can't for the life of me find any NSIS functions to know the path where my script is located (I'm sure one exists but my google-fu is weak)...<br><br>ideas?<br><br>-edit- just found this further up in the execution log which pretty much confirms my suspicions...but I don't know how to fix it:<br><br>!system: ""C:\Program Files\NSIS\makensis.exe" /DWRITE_TEMP_UNINSTALLER_FOR_SIGNING my_script.nsi"<br>'\\networklocation\'<br>CMD.EXE was started with the above path as the current directory.<br>UNC paths are not supported. Defaulting to Windows directory.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">21st April 2012 01:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I could not really reproduce this problem, maybe because I'm on XP or that I have the UNC reghack for cmd.exe. Or maybe you have something in your script or cmd.exe autorun that changes the working directory.<br><br>Anyway, you know the filename the first time you call makensis, if the parent is a batch file you can get the full path there and pass it in as a define.<br><br>You can try to pipe it in:</p><blockquote>!system 'type .\${__FILE__}|$\"${NSISDIR}\makensis.exe$\" /DWRITE_TEMP_UNINSTALLER_FOR_SIGNING -' = 0</blockquote>There is no easy way to get the full path in NSIS but you can do something like this:<br><blockquote>!tempfile temp<br>!system 'for %A in (".\${__FILE__}") do echo %~fA &gt; "${temp}"' = 0<br>!searchparse /file "${temp}" "" myfullpath<br>!delfile "${temp}"<br>!echo "self=${myfullpath}"</blockquote></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kinar</span><br><span class="post-time small text-muted">23rd April 2012 19:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Anders, thanks for looking into this. What is the UNC registry hack that you are using? I'm guessing that is why you aren't seeing the issue.<br><br>I'm not scripting the install (yet) from a batch file. Instead I'm using HM NIS Edit 2.0.3 to compile the script.<br><br>Right now I've reverted to using the script on the wiki to get it to work (none of my modifications) and having very little luck.<br><br>So repo steps would be:<br><br>1) create script with the following:<br></p><pre>
<code>!ifdef INNER<br>  !echo "Inner invocation"                  ; just to see what's going on<br>  OutFile "$%TEMP%\tempinstaller.exe"       ; not really important where this is<br>  SetCompress off                           ; for speed<br>!else<br>  !echo "Outer invocation"<br><br>  ; Call makensis again, defining INNER.  This writes an installer for us which, when<br>  ; it is invoked, will just write the uninstaller to some location, and then exit.<br>  ; Be sure to substitute the name of this script here.<br><br>  !system "$\"${NSISDIR}\makensis$\" /DINNER ${__FILE__}" = 0<br><br>  ; So now run that installer we just created as %TEMP%\tempinstaller.exe.  Since it<br>  ; calls quit the return value isn't zero.<br><br>  !system "$%TEMP%\tempinstaller.exe" = 2<br><br>  ; That will have written an uninstaller binary for us.  Now we sign it with your<br>  ; favourite code signing tool.<br><br>  !system "SIGNCODE &lt;signing options&gt; $%TEMP%\uninstaller.exe" = 0<br><br>  ; Good.  Now we can carry on writing the real installer.<br><br>  OutFile "my_real_installer.exe"<br>  SetCompressor /SOLID lzma<br>!endif<br><br>Function .onInit<br>!ifdef INNER<br><br>  ; If INNER is defined, then we aren't supposed to do anything except write out<br>  ; the installer.  This is better than processing a command line option as it means<br>  ; this entire code path is not present in the final (real) installer.<br><br>  WriteUninstaller "$%TEMP%\uninstaller.exe"<br>  Quit  ; just bail out quickly when running the "inner" installer<br>!endif<br><br>FunctionEnd<br><br><br>Section "Files" ; or whatever<br><br><br>  ; where you would normally put WriteUninstaller ${INSTDIR}\uninstaller.exe put instead:<br><br>!ifndef INNER<br>  SetOutPath ${INSTDIR}<br><br>  ; this packages the signed uninstaller<br><br>  File $%TEMP%\uninstaller.exe<br>!endif<br><br>SectionEnd<br><br>!ifdef INNER<br>Section "Uninstall"<br><br>  ; your normal uninstaller section or sections (they're not needed in the "outer"<br>  ; installer and will just cause warnings because there is no WriteInstaller command)<br><br>SectionEnd<br>!endif</code>
</pre><br>
      <br>
      2) place this script on a networked location (I believe anything not on the local PC will work)<br>
      <br>
      3) try to compile the script and you should get the same error in my initial post.<br>
      <br>
      I tried your idea of writing the path to a temp file but it doesn't work with the same failure scenario (C:\Windows\&lt;script filename&gt; gets written to the temp file since the !system command redirects to windows directory).<br>
      <br>
      For now, I've found a workaround of mapping a drive to the network location (which seems to work fine but has the added overhead of either using a batch file to map the drive on the fly or a manual pre-build environment setup step)
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>