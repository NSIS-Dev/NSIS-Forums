<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Linker for listview subitems"><title>Linker for listview subitems - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Linker for listview subitems</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=329848">Linker for listview subitems</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">zenpoy</span><br><span class="post-time small text-muted">20th April 2011 08:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Linker for listview subitems</strong><br>&nbsp; Hi,<br><br>I wrote a very basic plugin, based on the old linker.dll, that support also listview subitems. I couldn't get it to change the fonts and styles of the subitem (but again, I didn't really try so you are all welcome to fix it :))<br><br>Linker::lvlink /NOUNLOAD ${hwndLV_} ${iItem_} ${iSubItem_} ${url_}<br><br>The original linker:<br><a href="http://nsis.sourceforge.net/Linker_plug-in" target="_blank">http://nsis.sourceforge.net/Linker_plug-in</a><br><br>for some reason I can't upload the attachment... so here it is:<br><br><a href="http://www.mediafire.com/?smb6nz5oarpfmk5" target="_blank">http://www.mediafire.com/?smb6nz5oarpfmk5</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">20th April 2011 08:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Good work. Please post on the Wiki so that it doesn't get lost. Just upload to <a href="http://nsis.sf.net/File:Linker.zip" target="_blank">http://nsis.sf.net/File:Linker.zip</a>.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">zenpoy</span><br><span class="post-time small text-muted">20th April 2011 09:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">uploaded to <a href="http://nsis.sf.net/File:Linker.zip" target="_blank">http://nsis.sf.net/File:Linker.zip</a>.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">jiake</span><br><span class="post-time small text-muted">22nd April 2011 08:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I only see black text, without underline, and normal cursor when hovering, except it will open browser when I click the text. But after read the source I find that it support underline etc. It is very strange that it displays like normal text on My Windows XP.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">zenpoy</span><br><span class="post-time small text-muted">26th April 2011 09:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by jiake</small><br>I only see black text, without underline, and normal cursor when hovering, except it will open browser when I click the text. But after read the source I find that it support underline etc. It is very strange that it displays like normal text on My Windows XP.</blockquote>Hi jiake,<br><br>In the code there are two event listeners, one for labels (the original linker) and one for listviews (with _lv_ somewhere in its name). The original *IS* adding the style, cursor, etc. and I didn't change it at all. I removed the style changes for the listview methods as I couldn't get the handle for the text (and I don't think it has one, cause if it had everything would be a lot easier to begin with). Anyway, this is my first attempt to edit/create a plugin and my knowledge in WIN32 programming is below basic. So if any of you WIN32 sharks are willing to take a look at the code and make the desired changes so the text in the subitem will be underlined, blue and with correct cursor when being hovered you are most welcome.<br><br>Thanks,<br><br>J</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">zenpoy</span><br><span class="post-time small text-muted">15th May 2011 16:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Trying to change listview subitem color</strong><br>&nbsp; Hi,<br><br>I'm trying to change the color of the text of the subitems that are defined as links. But I'm having troubles: I have a handler which:<br><br></p><pre>
<code>case WM_NOTIFY:<br>                {       switch (((LPNMHDR)lParam)-&gt;code)<br>                        {       case NM_CUSTOMDRAW:<br>                                {       SetWindowLongPtr(hwnd, DWL_MSGRESULT,(LONG_PTR)ProcessCustomDraw(lParam));<br>                                        return TRUE;<br>                                }       <br>                        }<br>                        break;<br>                }<br><br>...<br>...<br><br>return CallWindowProc(oldproc,hwnd,uMsg,wParam,lParam);</code>
</pre><br>
      <br>
      but when it calls the oldproc (original handler), after changing DWL_MSGRESULT to be CDRF_NOTIFYITEMDRAW (0x20) for example, I get an error saying that there is a read violation when trying to access 0x00000020 (which is the DWL_MSGRESULT) I suspect that there's a bug in the original handler who for some reason tries to read result as a pointer instead of a value, or maybe I'm calling it the wrong way - I think it is part of the nsDialogs, but I'm not sure. If I use instead the DefWindowProc I don't get the error but I also don't see any of the items... any ideas?:(
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">15th May 2011 16:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><a href="http://msdn.microsoft.com/en-us/library/ff919573%28v=vs.85%29.aspx" target="_blank">http://msdn.microsoft.com/en-us/libr...=vs.85%29.aspx</a><br>
      <br>
      Stu</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">zenpoy</span><br>
      <span class="post-time small text-muted">15th May 2011 20:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi Stu,<br>
      <br>
      Thanks for the reply. It seems now that I tried everything and nothing works. The problem I got earlier was due to returning the result with SetWindowLong which is relevant only for Dialog window.<br>
      <br>
      I would really (really really) appreciate it if you could take a look in the code and help me out :).<br>
      <br>
      <a href="http://www.mediafire.com/?pd6tf3p1r269d84" target="_blank">http://www.mediafire.com/?pd6tf3p1r269d84</a><br>
      <br>
      p.s.<br>
      <br>
      the relevant code is around lines 304 and 279 of URLCtrl.c</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">T.Slappy</span><br>
      <span class="post-time small text-muted">16th May 2011 06:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Maybe this tutorial can help you: <a href="http://www.codeguru.com/cpp/controls/staticctrl/article.php/c5803" target="_blank">http://www.codeguru.com/cpp/controls...icle.php/c5803</a></p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">zenpoy</span><br>
      <span class="post-time small text-muted">16th May 2011 07:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi T.Slappy,<br>
      <br>
      Thanks for your reply. My current problem is accessing the subitems in the list view - I'm not getting the event (CDDS_ITEMPREPAINT | CDDS_SUBITEM). as a matter of fact I suspect I'm getting the notifications only for the titles and not for the items themselves: If I have 4 colums and 10 rows I get only 5 NM_CUSTOMDRAW events - one is PREPAINT and the other four are ITEMPREPAINTs.<br>
      <br>
      Anyway, once I'll get notifications for each subitem I would do something like what you sent. But I'm still not there.<br>
      <br>
      Thanks,<br>
      <br>
      J</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">zenpoy</span><br>
      <span class="post-time small text-muted">17th May 2011 14:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi,<br>
      <br>
      I've managed to solve all the problems and I now released a new version which better supports subitems in listviews. It now changes the color to blue and after a click it changes to purple (this is the default, but can be changed the same way it is with labels). It also changes the cursor to a hand when hovering on the subitem.<br>
      <br>
      (it's already updated in <a href="http://nsis.sourceforge.net/File:Linker.zip" target="_blank">http://nsis.sourceforge.net/File:Linker.zip</a>)<br>
      <br>
      J</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">T.Slappy</span><br>
      <span class="post-time small text-muted">23rd May 2011 10:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi<br>
      For some time I am trying to subclass label #1006 on Install page and draw text by myself.<br>
      I looked into Linker sources and I found this issue in this plugin:<br>
      <br>
      Your window procedure looks like this:<br></p>
      <pre>
<code>LRESULT CALLBACK UrlMainProc</code>(HWND hwnd,UINT uMsg,WPARAM wParam,LPARAM lParam)
<br>caseWM_PAINT:
<br>{   PAINTSTRUCT ps;
<br>   HDC hdc=(HDC)wParam;
<br>    if(wParam==0) hdc=BeginPaint(hwnd,&amp;ps);
<br>    if(hdc)
<br>    {   DrawUrl(hwnd,hdc,NULL); // HERE IS THE MAIN DRAWING - YOUR FUNCTION
<br>           if(wParam==0) EndPaint(hwnd,&amp;ps);
<br>    }
<br>    return0;
<br>}        
<br>caseWM_SETTEXT:
<br>{    
<br>   LRESULT result=CallWindowProc(oldproc,hwnd,uMsg,wParam,lParam); // HERE you call standard Win function to draw the text
<br>&gt;.....
<br>} 
</pre>The problem is that you draw text in WM_SETTEXT by CallWindowProc() and then next in WM_PAINT in your function.<br>
      Whole text is drawn twice which produces ugly effect (however it is not visible because you fill area with BTNFACE color)<br>
      This problem is visible when I use TRANSPARENT color for background in my plugin.<br>
      <br>
      How can I reduce this twice writing?<br>
      Commenting out LRESULT result=CallWindowProc()... will not help, because text will not be refreshed properly and it will be written over itself (like in layers).
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">zenpoy</span><br>
      <span class="post-time small text-muted">23rd May 2011 12:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi,<br>
      <br>
      The part that changes the text on labels was taken from <a href="http://www.catch22.net/tuts/urlctrl" target="_blank">http://www.catch22.net/tuts/urlctrl</a>, so your answer might lie there.<br>
      <br>
      For what it worth, I think that WM_SETTEXT is being sent when the text is changed and the handler changes the the url to be placed in the correct position. WM_PAINT does the actual draw of the url.</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>