<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Problem with EnumRegValue" />

  <title>Problem with EnumRegValue - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Problem with EnumRegValue</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=212246">Problem with EnumRegValue</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">stb</span><br />
      <span class="post-time small text-muted">4th April 2005 11:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Problem with EnumRegValue</strong><br />
      Hi,<br />
      <br />
      by testing my solution for the <a href="http://forums.winamp.com/showthread.php?s=&amp;threadid=211446" target="_blank">issue with library.nsh</a> I found another one:<br />
      <br />
      Please correct me if I'm wrong:<br />
      <br />
      EnumRegValue maybe has an error by design. The example in NSIS documentation (2.06) shows that comparing the result to "" can be used as abort criteria for the loop. In reality those empty "registry variable names" are allowed and regularly used. So a key where such a "default value" is set will not be traversed by that EnumRegValue-loop.<br />
      <br />
      I don't know whether the empty variable name is always the first one (last EnumRegValue parameter=0) in the loop.<br />
      <br />
      I know that there probably is a workaround using ReadRegStr and checking the error flag.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">7th April 2005 18:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Please submit a <a href="http://sourceforge.net/tracker/?atid=373085&amp;group_id=22049&amp;func=browse" target="_blank">bug report</a>.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">stb</span><br />
      <span class="post-time small text-muted">7th April 2005 19:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1178756&amp;group_id=22049&amp;atid=373085" target="_blank">done</a></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bluenet</span><br />
      <span class="post-time small text-muted">8th April 2005 03:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi stb, you can use this macro to get the number of value<br />
      <br />
      !define RegOpenKey "Advapi32::RegOpenKey(i, t, i) i"<br />
      !define RegCloseKey "Advapi32::RegCloseKey(i) i"<br />
      !define RegQueryInfoKey "Advapi32::RegQueryInfoKey(i, t, i, i, i, i, i, i, i, i, i, i) i"<br />
      !define HKEY_CLASSES_ROOT 0x80000000<br />
      !define HKEY_CURRENT_USER 0x80000001<br />
      !define HKEY_LOCAL_MACHINE 0x80000002<br />
      !define HKEY_USERS 0x80000003<br />
      !define HKEY_PERFORMANCE_DATA 0x80000004<br />
      <br />
      !macro GetRegValueNum OUTPUT ROOT KEY<br />
      Push `${KEY}`<br />
      Push `${ROOT}`<br />
      Push $R0<br />
      Push $R1<br />
      Exch 2<br />
      Exch<br />
      Exch 3<br />
      Exch<br />
      System::Call /NOUNLOAD "*(i 0) i .R0"<br />
      System::Call /NOUNLOAD "${RegOpenKey}(s, s, R0)"<br />
      Push $R0<br />
      System::Call /NOUNLOAD "*$R0(&amp;i4 .R0)"<br />
      System::Call /NOUNLOAD "*(i 0) i .R1"<br />
      System::Call /NOUNLOAD "${RegQueryInfoKey}(R0, i 0, 0, 0, 0, 0, 0, R1, 0, 0, 0, 0)"<br />
      System::Call /NOUNLOAD "*$R1(i .s)"<br />
      System::Free /NOUNLOAD $R1<br />
      System::Call /NOUNLOAD "${RegCloseKey}(R0)"<br />
      Exch<br />
      Pop $R0<br />
      System::Free $R0<br />
      Exch<br />
      Pop $R1<br />
      Exch<br />
      Pop $R0<br />
      Pop ${OUTPUT}<br />
      !macroend<br />
      <br />
      And using like this:<br />
      !insertmacro GetRegValueNum $0 ${HKCU} Key<br />
      ${For} $1 0 $0<br />
      ;do something<br />
      ${Next}</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">stb</span><br />
      <span class="post-time small text-muted">8th April 2005 09:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for the macro, bluenet! There are two things:<br />
      <br />
      1. If the key does not exist the error flag should be set and the macro should skip the remaining lines and return 0.<br />
      2. I think this should be an internal NSIS command and the example for EnumRegValue should use this new internal command (perhaps named "RegValueCount") instead of "" as stop criteria.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bluenet</span><br />
      <span class="post-time small text-muted">9th April 2005 03:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">And a "RegKeyCount"? QueryRegKeyInfo may be better.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bd2005</span><br />
      <span class="post-time small text-muted">9th April 2005 08:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">This looks interesting, I have a need to use something like this.<br />
      <br />
      How do I run this macro ... just exactly what does it do?<br />
      <br />
      Nsis tells me missing section and missing output file?<br />
      <br />
      Thks.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">stb</span><br />
      <span class="post-time small text-muted">9th April 2005 09:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">compare this code to the example from manual (4.9.2.6)<br />
      <br /></p>
      <pre>
<code><br />!insertmacro GetRegValueNum $3 HKLM Software\Microsoft\Windows\CurrentVersion<br />StrCpy $0 0<br />loop:<br />  IntCmp $3 $0 done<br />  EnumRegValue $1 HKLM <br />Software\Microsoft\Windows\CurrentVersion $0<br />  IntOp $0 $0 + 1<br />  ReadRegStr $2 HKLM Software\Microsoft\Windows\CurrentVersion $1<br />  MessageBox MB_YESNO|MB_ICONQUESTION "$1 = $2$\n$\nMore?" IDYES loop<br />done:<br /></code>
</pre><br />
      (not tested yet)<br />
      <br />
      You have to include the !macro part (!defines and !macro...!macroend) somewhere into your script and then you can insert the code lines above in a section/function. Please look at other examples and the nice NSIS manual for basics.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bluenet</span><br />
      <span class="post-time small text-muted">9th April 2005 15:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If using LogicLib it simple like this<br />
      <br /></p>
      <pre>
<span style="color: #007700">!include</span><span style="color: #0000BB">LogicLib</span><span style="color: #007700">.</span><span style="color: #0000BB">nsh
<br /><br /></span><span style="color: #007700">!</span><span style="color: #0000BB">defineRegOpenKey</span><span style="color: #DD0000">"Advapi32::RegOpenKey(i,t,i)i"
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">defineRegCloseKey</span><span style="color: #DD0000">"Advapi32::RegCloseKey(i)i"
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">defineRegQueryInfoKey</span><span style="color: #DD0000">"Advapi32::RegQueryInfoKey(i,t,i,i,i,i,i,i,i,i,i,i)i"
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">defineHKCR0x80000000
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">defineHKCU0x80000001
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">defineHKLM0x80000002
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">defineHKU0x80000003
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">defineHKPD0x80000004
<br /><br /></span><span style="color: #007700">!</span><span style="color: #0000BB">macroGetRegValueNumOUTPUTROOTKEY
<br />Push</span><span style="color: #007700">`${</span><span style="color: #0000BB">KEY</span><span style="color: #007700">}`
<br /></span><span style="color: #0000BB">Push</span><span style="color: #007700">`${</span><span style="color: #0000BB">ROOT</span><span style="color: #007700">}`
<br /></span><span style="color: #0000BB">Push$R0
<br />Push$R1
<br />Exch2
<br />Exch
<br />Exch3
<br />Exch
<br />System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">/</span><span style="color: #0000BB">NOUNLOAD</span><span style="color: #DD0000">"*(i0)i.R0"
<br /></span><span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">/</span><span style="color: #0000BB">NOUNLOAD</span><span style="color: #DD0000">"${RegOpenKey}(s,s,R0)"
<br /></span><span style="color: #0000BB">Push$R0
<br />System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">/</span><span style="color: #0000BB">NOUNLOAD</span><span style="color: #DD0000">"*$R0(&amp;i4.R0)"
<br /></span><span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">/</span><span style="color: #0000BB">NOUNLOAD</span><span style="color: #DD0000">"*(i0)i.R1"
<br /></span><span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">/</span><span style="color: #0000BB">NOUNLOAD</span><span style="color: #DD0000">"${RegQueryInfoKey}(R0,i0,0,0,0,0,0,R1,0,0,0,0)"
<br /></span><span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">/</span><span style="color: #0000BB">NOUNLOAD</span><span style="color: #DD0000">"*$R1(i.s)"
<br /></span><span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Free</span><span style="color: #007700">/</span><span style="color: #0000BB">NOUNLOAD$R1
<br />System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">/</span><span style="color: #0000BB">NOUNLOAD</span><span style="color: #DD0000">"${RegCloseKey}(R0)"
<br /></span><span style="color: #0000BB">Exch
<br />Pop$R0
<br />System</span><span style="color: #007700">::</span><span style="color: #0000BB">Free$R0
<br />Exch
<br />Pop$R1
<br />Exch
<br />Pop$R0
<br />Pop</span><span style="color: #007700">${</span><span style="color: #0000BB">OUTPUT</span><span style="color: #007700">}
<br />!</span><span style="color: #0000BB">macroend
<br /><br /></span><span style="color: #007700">!</span><span style="color: #0000BB">insertmacroGetRegValueNum</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">${</span><span style="color: #0000BB">HKLM</span><span style="color: #007700">}</span><span style="color: #DD0000">"SOFTWARE\Microsoft\Windows\CurrentVersion"
<br /></span><span style="color: #007700">${For}$</span><span style="color: #0000BB">10</span><span style="color: #007700">$</span><span style="color: #0000BB">0
<br />EnumRegValue</span><span style="color: #007700">$</span><span style="color: #0000BB">2HKLM</span><span style="color: #DD0000">"SOFTWARE\Microsoft\Windows\CurrentVersion"</span><span style="color: #007700">$</span><span style="color: #0000BB">1
<br />DetailPrint</span><span style="color: #007700">$</span><span style="color: #0000BB">2
<br /></span><span style="color: #007700">${</span><span style="color: #0000BB">Next</span><span style="color: #007700">}
</span>
</pre>This code will list all value under HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion.<br />
      Note that you should use ${HKLM} instead of HKLM in this macro
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
