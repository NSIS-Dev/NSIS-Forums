<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="UAC and launching an exe on Finish"><title>UAC and launching an exe on Finish - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">UAC and launching an exe on Finish</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=333206">UAC and launching an exe on Finish</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">SJSJ</span><br><span class="post-time small text-muted">5th August 2011 07:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>UAC and launching an exe on Finish</strong><br>Hello,<br><br>I have an installer which uses UAC plugin which has<br><br>1. RequestExecutionLevel set to user.<br>2. privileges raised in onInit using UAC plugin.<br>3. to launch an exe in the INSTALLDIR in the Finish page. This exe installs the application as a Windows Service, which is shortly started in the next step<br>4. UMUI for pages.<br><br>On Windows7, when the exe is launched by the NSIS installer using nsExec::ExecToLog, the service is installed and started without any error. Eventually, the service should start a web service, which it is not. I suspect, starting the webservice requires Administrator privileges to store config data in system folders.<br><br>Currently, when I run the exe through command line by choosing "Run as administrator", the application works fine, the web service starts and there are no permission issues. But when I run the application by starting it as a service (manually from Windows Services or through script), it does not seem to start the web service.<br><br>Is this an UAC issue?<br>Since installer is elevated, will it not run the exe also in elevated mode?<br>How do I launch the exe and give it suficient privilege?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Yathosho</span><br><span class="post-time small text-muted">5th August 2011 09:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">probably not an answer to your question, but i've noticed there can be different behaviour when using Exec or nsExec. i have previously found myself in the situation that an installer with admin rights would execute an application (which also required admin rights) with one command (Exec) but not the other (nsExec).</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">SJSJ</span><br><span class="post-time small text-muted">5th August 2011 09:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thank you for the quick response!<br>Yes, I have tried it using Exec too. It is the same behaviour, at least in this case.<br>As I mentioned, even when I start the service from Windows Services directly, the application does not start the web service.<br>So I doubt if it is do with how we launch it from script!<br>What I would like to know is if this is a case of UAC blocking the app? If so, will the UAC plugin help me in anyway to launch the application with right privileges.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">5th August 2011 13:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">If a child process is created from an elevated process, that child process will be elevated too.<br><br>That actually is a problem, if the installer needs elevation, but you want to launch the application in non-elevated mode.<br><br>With "RequestExecutionLevel Admin" you make the installer (and all its child processes!) execute in elevated mode.<br><br>All the purpose of the UAC plugin is: Have the installer run elevated, but still be able to launch child-processes non-elevated.<br><br>UAC plugin does this by running two instances of the installer. The "outer" non-elevated one and the "inner" elevated one.<br><br>The "inner" instance is the actual installer instance, but it can ask the "outer" instance to do things in a non-elevated way.<br><br>In your case you probably do NOT want this behavior, as you want the child process to be elevated (just like your installer).<br><br>So I don't see why you need to use the UAC plugin, rather than a simple "RequestExecutionLevel Admin" :confused:<br><br><br>BTW: If your installer is <b>not</b> running elevated (i.e. "RequestExecutionLevel User" + <b>no</b> UAC plug-in) and you try to launch an application that <i>explicitly</i> requires elevation (by embedded Manifest), then Exec() will simply fail. You need to use ShellExec with "runas" verb instead...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Yathosho</span><br><span class="post-time small text-muted">5th August 2011 18:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">also have a look at this <a href="http://forums.winamp.com/showthread.php?t=332228" target="_blank">recent topic</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">5th August 2011 20:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by LoRd_MuldeR</small><br>You need to use ShellExec with "runas" verb instead...</blockquote>If the exe has a manifest you don't really need the runas verb, the shell will detect it for you. (on NT5 you need the verb, but there you can "elevate" with a non admin user also so...)</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">5th August 2011 22:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Don't Vista and higher ignore the levelrequest in the manifest when UAC is turned off?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">5th August 2011 22:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by MSG</small><br>Don't Vista and higher ignore the levelrequest in the manifest when UAC is turned off?</blockquote>Well, if UAC is turned off (generally a bad idea!), then "elevation" is not needed/possible.<br><br>UAC works with two access tokens:<br>One "full" token which contains the full rights of the user account and a second "limited" token with minimum rights.<br><br>By default an application get's the "limited" token. Via elevation it can get the "full" token instead.<br><br>Without UAC, however, there only is a single "default" token...</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">5th August 2011 22:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by LoRd_MuldeR</small><br>Well, if UAC is turned off (generally a bad idea!), then "elevation" is not needed/possible.<br><br>UAC works with two access tokens:<br>One "full" token which contains the full rights of the user account and a second "limited" token with minimum rights.<br><br>By default an application get's the "limited" token. Via elevation it can get the "full" token instead.<br><br>Without UAC, however, there only is a single "default" token...</blockquote>Hmm, UAC probably did introduce the term elevation... But I was referring to running at higher privileges, regardless of whether UAC was involved or not. If elevation is something else, what's a good shorthand for 'running as admin'? &gt;_&gt;</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">5th August 2011 23:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">When UAC is off, the runas verb is broken on NT6 (It works on NT5 but you can use a non admin user in the combo box)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">6th August 2011 00:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by MSG</small><br>Hmm, UAC probably did introduce the term elevation... But I was referring to running at higher privileges, regardless of whether UAC was involved or not. If elevation is something else, what's a good shorthand for 'running as admin'? &gt;_&gt;</blockquote>Well, I think, on pre-Vista systems running "as admin" means <i>running as a different user</i>, if the logged on user doesn't have admin rights. On these systems the process always gets the full rights of the user. The only way to prevent processes from getting full rights on these systems was logging in with some "limited" user account. And only if you did that, you'd have to run certain processes "as admin".<br><br>With UAC you no longer need to use "limited" user accounts. Running "elevated" means giving the process the full rights of the user. And it's required even for "admin" users. That's because, with UAC enabled, processes get only limited rights by default - even if run by a user with full admin rights. So you can use safely use an "admin" account for regular work. At least that's the theory...<br><br><blockquote><small>Originally posted by Anders</small><br>When UAC is off, the runas verb is broken on NT6 (It works on NT5 but you can use a non admin user in the combo box)</blockquote>In my experience it will trigger an UAC dialog :confused:</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">6th August 2011 01:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by LoRd_MuldeR</small><br>On these systems the process always gets the full rights of the user.</blockquote>Not 100% true, you can give a admin token to CreateRestrictedToken or the Safer API and create a process that does not have admin rights (The (run as dialog) protect my computer checkbox on XP/2003), but from a security point of view this was not enough because of shatter attacks and other issues. The NT6 limited token is probably similar to this but with the added security of UIPI (and IL) and session 0 isolation...</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">SJSJ</span><br><span class="post-time small text-muted">8th August 2011 05:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thank you, all, for your responses.<br>I used UAC plugin and "RequestExecutionLevel user" because the installer process needed to install it for a user, create shortcuts for local user etc.<br>Only the exe called in the finish page needed an admin privilege.<br><br>One more strange observation which I failed to mention in my post was that this problem occured only during a first-time install. After installation, the first time the application is run as service, the service starts, it calls the exe, but the exe fails to launch the web service.<br><br>Once the service is restarted, everything starts working again - including the web service. Similarly, if I uninstall the first installation and install once again, there is no problem seen in running the web service.<br><br>Now, I am beginning to think there is Access control involved too.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">8th August 2011 12:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by SJSJ</small><br>Thank you, all, for your responses.<br>I used UAC plugin and "RequestExecutionLevel user" because the installer process needed to install it for a user, create shortcuts for local user etc.</blockquote>How does this prevent you from using "RequestExecutionLevel admin" ???<br><br>UAC elevation generally will <i>not</i> run the installer with a different user account, but run the process with the full rights of the current user account - instead of giving the process only small subset of the current user's rights. Elevation <i>is</i> required even for "unrestricted" (admin) user accounts. Still the (elevated) installer process will run in the context of the current user account.<br><br>See here:<br><a href="http://forums.winamp.com/showpost.php?p=2792787&amp;postcount=8" target="_blank">http://forums.winamp.com/showpost.ph...87&amp;postcount=8</a><br><br>AFAIK UAC elevation would only trigger a "Login" (aka <i>run as a different user</i>) dialog, instead of the normal "Elevation" dialog, if the installer is run by a user with an "restricted" (non-admin) user account. But then the problem is <i>not</i> UAC, but the fact the current user simply doesn't have the required rights to install (and therefore shouldn't be running the installer anyway).<br><br>Also it might make much sense to create shortcuts for <a href="http://nsis.sourceforge.net/Docs/Chapter4.html#4.9.7.7" target="_blank"><b>ALL</b></a> users, rather than for a single user who happened to run the installer.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">8th August 2011 13:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Now you're just making things complicated. He/she needs admin access to register a service. Elevating will get that access. It doesn't matter whether the access is given by UAC to a UAC-protected adminlevel user, or by secondary logon to an admin user parallel to the current user.<br><br>So using the UAC plugin to elevate the installer works just fine for what he wants to do: Installing an app at userlevel, and installing a service as admin.<br><br>(Whether or not that's a good thing to do is an entirely different matter. I don't know much about services but afaik they run for all users. In that case the app should probably also be installed for all users...)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">8th August 2011 14:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by MSG</small><br>Now you're just making things complicated. He/she needs admin access to register a service. Elevating will get that access. It doesn't matter whether the access is given by UAC to a UAC-protected adminlevel user, or by secondary logon to an admin user parallel to the current user.</blockquote>Hmm, I think it does make a difference for $SMPROGRAMS (in "user" shell context), which was one of his concerns...</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">8th August 2011 16:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">No, anything user-level should be done in the outer instance (userlevel instance) of the installer. It doesn't matter whether the inner instance (admin instance) is the same user or a different one.<br><br>(Of course you shouldn't do anything in user shellcontext in the admin instance. But that's pretty much a given. You use the admin instance to make system-wide changes, not to create shortcuts in an admin profile...)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">SJSJ</span><br><span class="post-time small text-muted">12th August 2011 09:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks for your replies.<br>The problem seems to have occured in another portion of the code. The web service was trying to create temp config files inside system32\config\systemprofile\appdata when it didn't have sufficient privileges.<br>Fixed it by providing an accessible temp dir and things worked.<br><br>A special note of thanks to all of you who responded to my query. NSIS forum rocks!!</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>