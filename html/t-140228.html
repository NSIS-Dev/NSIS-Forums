<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="An idea for a function" />

  <title>An idea for a function - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">An idea for a function</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=140228">An idea for a function</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">26th June 2003 21:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>An idea for a function</strong><br />
      I was trying to find a way to copy a string to the Windows clipboard using the System plugin, but was unable to find a way (I'm no C++ programmer see!)<br />
      I was wondering how this would be achieved?<br />
      <br />
      When I mean "Windows clipboard" I mean so that the user can do a Ctrl+V and the string is copied automatically (without the user doing a Ctrl+C before hand)<br />
      <br />
      -Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joel</span><br />
      <span class="post-time small text-muted">26th June 2003 21:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">In think that there's a "Message" for that:<br />
      See in the ${NSISDIR}\Include\WinMessages.nsh</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">26th June 2003 22:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Ah ok.<br />
      I have no idea what to do next however...<br />
      <br />
      -Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joel</span><br />
      <span class="post-time small text-muted">26th June 2003 22:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Maybe with the "SendMessage" use it :weird:<br />
      But, don't you need to reply that message?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">brainsucker</span><br />
      <span class="post-time small text-muted">26th June 2003 22:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">System::Call 'user32::OpenClipboard(i 0)'<br />
      System::Call 'user32::EmptyClipboard()'<br />
      System::Call '*(&amp;t1024 "Just a clipboard demo!") i.r0'<br />
      System::Call 'user32::SetClipboardData(i 1, i r0)'<br />
      System::Call 'user32::CloseClipboard()'<br />
      System::Free $0</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">26th June 2003 22:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by Lobo Lunar</i><br />
        <b>Maybe with the "SendMessage" use it :weird:<br />
        But, don't you need to reply that message?</b>
      </blockquote>Well duh.<br />
      Thanks for the System dll way - that's the kind of way which I was trying to find.<br />
      <br />
      -Stu
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joel</span><br />
      <span class="post-time small text-muted">26th June 2003 22:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well...don't blame me for trying :D</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">26th June 2003 22:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Now, how would I go about getting text from the clipboard into a string :)<br />
      <br />
      -Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">brainsucker</span><br />
      <span class="post-time small text-muted">26th June 2003 23:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">System::Call 'user32::OpenClipboard(i 0)'<br />
      System::Call 'user32::GetClipboardData(i 1) t .r0'<br />
      System::Call 'user32::CloseClipboard()'</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">26th June 2003 23:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">brainsucker, according to MSDN you are not supposed to free the memory of the clipboard data, and if allocated it should use GMEM_MOVEABLE. So the code should probably look like this:<br />
      <br />
      StrCpy $0 "string to put in clipboard"<br />
      System::Call 'user32::OpenClipboard(i 0)'<br />
      System::Call 'user32::EmptyClipboard()'<br />
      StrLen $1 $0<br />
      System::Call 'kernel32::GlobalAlloc(i 2, i $1) i.r1'<br />
      System::Call 'kernel32::lstrcpyA(i $1, t $0)'<br />
      System::Call 'user32::SetClipboardData(i 1, i r1)'<br />
      System::Call 'user32::CloseClipboard()'<br />
      <br />
      Also, SetClipboardData and CloseClipboard both return a value. Does System.dll default to int return value if nothing is specified?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">brainsucker</span><br />
      <span class="post-time small text-muted">26th June 2003 23:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">MSDN: The application can read the data, but must not free the handle or leave it locked until the CloseClipboard function is called. (The application can access the data after calling CloseClipboard).<br />
      "Can access" could mean 'free', imho.<br />
      No considirations about GMEM_MOVEABLE, anyway your way is more correct, but my way works to :) for strings at least ;)<br />
      <br />
      Functions/Procedures return values in registers, and it doesn't matter how we process it... So if we don't specify return type system plugin just skips the converting step...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">26th June 2003 23:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><a href="http://msdn.microsoft.com/library/en-us/winui/WinUI/WindowsUserInterface/DataExchange/Clipboard/UsingtheClipboard.asp?frame=true" target="_blank">MSDN example</a> doesn't free the memory, so I guess we shouldn't too. But it does something else that I have forgotten in my code, it uses GlobalLock. Complete code should be:<br />
      <br />
      StrCpy $0 "string to put in clipboard"<br />
      System::Call 'user32::OpenClipboard(i 0)'<br />
      System::Call 'user32::EmptyClipboard()'<br />
      StrLen $1 $0<br />
      System::Call 'kernel32::GlobalAlloc(i 2, i $1) i.r1'<br />
      System::Call 'kernel32::GlobalLock(i $1) i.r2'<br />
      System::Call 'kernel32::lstrcpyA(i $2, t $0)'<br />
      System::Call 'kernel32::GlobalUnlock(i $1)'<br />
      System::Call 'user32::SetClipboardData(i 1, i r1)'<br />
      System::Call 'user32::CloseClipboard()'</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">27th June 2003 10:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">So, which are the final two scripts?<br />
      I'd like to add them to the archive when I get back home...<br />
      <br />
      -Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">27th June 2003 12:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The last one is the final for copy. The only one that was supposed to be for paste is still the final ;)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">27th June 2003 16:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks!<br />
      <a href="http://nsis.sourceforge.net/archive/nsisweb.php?page=338&amp;instances=0,11,122" target="_blank">http://nsis.sourceforge.net/archive/...ances=0,11,122</a><br />
      <br />
      -Stu :)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">brainsucker</span><br />
      <span class="post-time small text-muted">2nd July 2003 18:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I've missed some 'tips' in Kichik's script, the right version should look like:<br />
      <br />
      <br />
      StrCpy $0 "string to put in clipboard"<br />
      System::Call 'user32::OpenClipboard(i 0)'<br />
      System::Call 'user32::EmptyClipboard()'<br />
      StrLen $1 $0<br />
      IntOp $1 + 1<br />
      System::Call 'kernel32::GlobalAlloc(i 2, i r1) i.r1'<br />
      System::Call 'kernel32::GlobalLock(i r1) i.r2'<br />
      System::Call 'kernel32::lstrcpyA(i r2, t r0)'<br />
      System::Call 'kernel32::GlobalUnlock(i r1)'<br />
      System::Call 'user32::SetClipboardData(i 1, i r1)'<br />
      System::Call 'user32::CloseClipboard()'<br />
      <br />
      <br />
      All changes of $n to rn are non fatal, beside the line with lstrcpy,<br />
      where $0 shouldn't and couldn't work right.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
