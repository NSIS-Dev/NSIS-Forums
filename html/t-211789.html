<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="HKCU on multiple user systems" />

  <title>HKCU on multiple user systems - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">HKCU on multiple user systems</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=211789">HKCU on multiple user systems</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">DennisFeiock</span><br />
      <span class="post-time small text-muted">30th March 2005 14:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>HKCU on multiple user systems</strong><br />
      I was hoping to get some help with a problem I am running into. I have tried doing a search, but havent come up with much... I could just not be searching quite the way I should be. Regardless, here is what I am doing:<br />
      <br />
      I am automating installs of applications. Naturally, most of these installs write registry entries to the HKCU. The problem I am having is writing the required HKCU keys for a second user logging into the system.<br />
      <br />
      I attempted just making the required changes to HKEY_USERS for each user on the system (manually), but it doesnt load the changes into the HKCU when the user logs in.<br />
      <br />
      As far as I see it, there is two ways to make the necessary changes:<br />
      1) With the install, write all the necessary HKCU entries to the HKEY_USERS, for each user. Then force windows to load the changes when the users log in.<br />
      <br />
      2) Write a HKLM key (Installed.Apps) and a HKCU key (Configured.Apps). Upon the user logging in, compare Installed.Apps to Configured.Apps, and run the secondary installs (which would contain just HKCU entries) if an application has not been configured for that user yet.<br />
      <br />
      Now, for each of these options I would still need assistance with the following things:<br />
      <br />
      Situation 1) I'm not sure if there is a command to load the user's registry entries from the HKEY_USERS keys to HKCU (such as "System::Call 'Shell32::SHChangeNotify(i ${SHCNE_ASSOCCHANGED}, i ${SHCNF_IDLIST}, i 0, i 0)'" for loading changes to file associations). Each system has users that has logged into the system already. I would need to read out each user under HKEY_USERS (eg: S-1-5-18, S-1-5-19, etc) in order to make the changes to all the users correctly. Then, of course, I would have to make the changes to the Default user as well.<br />
      <br />
      Situation 2) Not all the systems have the same installed applications. When using ReadRegStr, you have to define the Name of what entry you want to read. I would have to append the names to the default key, then parse them out to be able to compare.<br />
      <br />
      Those are the two scenarios that I could think of that would resolve this problem I am having. There could be others, and I would be more than happy to hear them. Any help would be greatly appreciated. :D<br />
      <br />
      Thanks!<br />
      Dennis Feiock</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">31st March 2005 19:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You can try the following solution from the Archive:<br />
      <br />
      <a href="http://nsis.sourceforge.net/archive/viewpage.php?pageid=511" target="_blank">http://nsis.sourceforge.net/archive/...php?pageid=511</a></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">DennisFeiock</span><br />
      <span class="post-time small text-muted">1st April 2005 12:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for the input kichik.<br />
      <br />
      The only problem with the solution provided there is that it only pertains to that single application.<br />
      <br />
      What I am attempting to do is make any HKCU registry changes for a user silently when logging in. So it will have to detect which applications are installed on the system, and which have been configured for the user.<br />
      <br />
      I almost got it done yesterday by writing a reg key to HKLM and HKCU specifing which apps are installed, and which are configured for the current user. Then parsing out those entries and running the secondary (HKCU entries only) installs if needed.<br />
      <br />
      The problem I ran into doing it that way was if there were a version upgrade with new registry entires required, and removing the value for apps that have been uninstalled. The cause of the problem was that I was just using the default key and dumping like so:<br />
      "app1;app2;app3;"<br />
      <br />
      And after 100 lines of script (wich spacious formatting) with 4 loops, I figured enough was enough. :(<br />
      <br />
      After rethinking the situatuion, there are really only about 20 different installers that I might create. So, using the array header found here (Thanks Afrow UK!):<br />
      <a href="http://forums.winamp.com/showthread.php?s=&amp;threadid=210311&amp;highlight=array" target="_blank">http://forums.winamp.com/showthread....ighlight=array</a><br />
      I am rebuilding the app and will just make an array with the registry keys that need to be checked. I really think this one should take care of it for me. Or I hope at least. Will let you know how it goes. :D<br />
      <br />
      - DF</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">1st April 2005 12:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The application list doesn't have to be in one value. You can create a key and add several values to it. Use EnumRegKey to find out which applications need to be configured. It will save you the string hassling.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">DennisFeiock</span><br />
      <span class="post-time small text-muted">1st April 2005 12:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I figured there had to be a way to do that, I just didnt know the command and didnt know where to look to find it.<br />
      <br />
      Thanks a ton! :D<br />
      <br />
      - DF</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">DennisFeiock</span><br />
      <span class="post-time small text-muted">1st April 2005 19:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>WORKIING!</strong><br />
      Well! I finally got things working the way that I wanted them to. Just thought I would post my results here for anyone that might be doing a search that has a similar problem.<br />
      <br />
      Now, I will be the first to admit that I am pretty new to NSIS. Maybe 2 weeks or so... So Im sure theres a way to clean up this code and make it more efficent... but here goes...<br />
      <br />
      ::ASSUMPTIONS:<br />
      1. All install exe's are located on a network share<br />
      2. Registry keys are created to point to the location for different installs<br />
      <br />
      ::HKLM REGISTRY EXAMPLE::<br />
      Lets say I created an install called "App1" and it is shared at "\\server\share\App1.exe"<br />
      <br />
      With App1, you would need to create a registry structure such as:<br />
      HKLM\Software\Custom.Apps\Installed.Apps\App1<br />
      "Default" "" (Not used)<br />
      "CUInstall" "[Path to CU install]" (secondary install with just HKCU and shortcut entries)<br />
      "Install" "[Path to install]" (path to full install exe)<br />
      "Version" "[#]" (Version number of the application)<br />
      <br />
      So, in this case, there would be the following Names and Values:<br />
      "CUInstall" "\\server\share\App1-CU.exe"<br />
      "Install" "\\server\share\App1.exe" (Not used by my script, just thought it would be a good idea)<br />
      "Version" "1.0"<br />
      <br />
      ::APP1-CU::<br />
      This would be a compiled exe with only Registry entries and user-specific shortcuts. I ended up completely removing these options from the full install, then calling the system to run the RegCheck application to inject the necessary files/entries after the full install is completed.<br />
      <br />
      ::HKCU REGISTRY EXAMPLE::<br />
      With the App1-CU, you would need to add the following registry entries to compare what was installed on the local system.<br />
      HKCU\Software\Custom.Apps\Configured.Apps\App1<br />
      "Default" "" (Not Used)<br />
      "un.CUInstall" "[Path to install]" (uninstall if needed)<br />
      "Version" "[#]" (Version number of the application)<br />
      <br />
      ::CODE::<br />
      OutFile RegCheck.exe<br />
      Name RegCheck<br />
      Caption RegCheck<br />
      <br />
      Section<br />
      Push $R0 #Counter<br />
      Push $R1 #EnumValue<br />
      Push $R2 #HKLMversion<br />
      Push $R3 #HKCUversion<br />
      Push $R4 #CUInstallPath<br />
      Push $R5 #un.CUInstallPath<br />
      <br />
      StrCpy $R0 0<br />
      <br />
      HKLMloop:<br />
      EnumRegKey $R1 HKLM Software\Custom.Apps\Installed.Apps\ $R0<br />
      StrCmp $R1 "" +5<br />
      DetailPrint "HKLM Install found: $R1"<br />
      Call HKLMCheck<br />
      IntOp $R0 $R0 + 1<br />
      goto HKLMloop<br />
      StrCpy $R0 0<br />
      HKCUloop:<br />
      EnumRegKey $R1 HKCU Software\Custom.Apps\Configured.Apps\ $R0<br />
      StrCmp $R1 "" +5<br />
      DetailPrint "HKCU Install found: $R1"<br />
      Call HKCUCheck<br />
      IntOp $R0 $R0 + 1<br />
      goto HKCUloop<br />
      <br />
      Pop $R0<br />
      Pop $R1<br />
      Pop $R2<br />
      Pop $R3<br />
      Pop $R4<br />
      Pop $R5<br />
      <br />
      SectionEnd<br />
      <br />
      Function HKLMCheck<br />
      ReadRegStr $R2 HKLM Software\Custom.Apps\Installed.Apps\$R1 "Version"<br />
      ReadRegStr $R3 HKCU Software\Custom.Apps\Configured.Apps\$R1 "Version"<br />
      StrCmp $R2 $R3 +4 0<br />
      ReadRegStr $R4 HKLM Software\Custom.Apps\Installed.Apps\$R1 "CUInstall"<br />
      ExecWait '"$R4" /S'<br />
      DetailPrint "Installing HKCU entries for: $R1"<br />
      DetailPrint "Check OK."<br />
      FunctionEnd<br />
      <br />
      Function HKCUCheck<br />
      ReadRegStr $R2 HKLM Software\Custom.Apps\Installed.Apps\$R1 "Version"<br />
      ReadRegStr $R3 HKCU Software\Custom.Apps\Configured.Apps\$R1 "Version"<br />
      StrCmp $R3 $R2 +5 0<br />
      ReadRegStr $R5 HKCU Software\Custom.Apps\Configured.Apps\$R1 "un.CUInstall"<br />
      ExecWait '"$R5" /S'<br />
      IntOp $R0 $R0 - 1<br />
      DetailPrint "HKCU entry with no HKLM setup, running uninstall for: $R1"<br />
      DetailPrint "Check OK."<br />
      FunctionEnd<br />
      <br />
      ::END OF CODE::<br />
      The one thing that I really wanted to do with this, but could not get it to work would to only have one loop rather than a HKLM and HKCU loop. Unfortunatly, I had some problems with the EnumRegKey running completely off of variables. And even when I hardcoded those in, I still could not get the Call command to work with a variable.<br />
      <br />
      As far as implementing the RegCheck application, I created an install that would create a batch file which would eventually run RegCheck.exe from the server each time a user would log in. I had to do it that way because there were some problems where the network interface would not act right unless I tried to do an "ipconfig /renew" first. Even though the command would timeout. Was pretty strange...<br />
      <br />
      So, as a final result, this application runs when each user logs into the system. It runs silently, and calls any needed user configuration installs silently. For my purposes, this makes it so that each user doesnt have to go in and define querys/servers/etc. for certain applications. Then again, Im sure some of the application bundles I am makinig might not work so well without the HKCU entries.<br />
      <br />
      Anyways! Thanks for all the help with EnumRegKey kichik :D<br />
      <br />
      - DF</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
