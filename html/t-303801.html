<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="ReplaceOnline repeats line problem" />

  <title>ReplaceOnline repeats line problem - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">ReplaceOnline repeats line problem</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=303801">ReplaceOnline repeats line problem</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">BerSerK6996</span><br />
      <span class="post-time small text-muted">5th March 2009 18:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>ReplaceOnline repeats line problem</strong><br />
      Hi,<br />
      <br />
      I'm trying to use a simple ReplaceOnLine to replace the text on 1 line from a text file.<br />
      <br />
      here's my code ;<br /></p>
      <pre>
<code>!include LogicLib.nsh<br />!include TextFunc.nsh<br />!include functions.nsh<br />!insertmacro GetDrives<br />!insertmacro GetTime<br /><br />Name "add_text_file"<br />OutFile "add_text_file.exe"<br />XPStyle on<br />ShowInstDetails show<br />InstallDir "C:\"<br /><br />Page directory<br />Page instfiles<br /><br />LoadLanguageFile "${NSISDIR}\Contrib\Language files\French.nlf"<br /><br />Section "";<br /><br />InitPluginsDir<br /><br />SetOutPath $INSTDIR<br /><br />ClearErrors<br />Push 'test1'<br />Push 'test2'<br />Push 1<br />Push "C:\file.txt"<br />Call ReplaceOnLine<br /><br />SectionEnd</code>
</pre><br />
      <br />
      Content of file.txt before ;<br />
      <pre>
<code>test1</code>
</pre><br />
      <br />
      Content of file.txt after ;<br />
      <pre>
<code>test2test1test2test2test2test1test2test2test2test2test2test2test2test1test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test1test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2  test2test2test2test2test2test2test2test2test2test2test2test1test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2  test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test1test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2  test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2  test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2  test2test2test2test1test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2  test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2  test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2  test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2test2  test2test2test2test2test2test2test2test2tes</code>
</pre><br />
      <br />
      Content of functions.nsh ;<br />
      <pre>
<code>Function DriveType<br />        StrCmp $9 $R0 0 +3<br />        StrCpy $R1 $8<br />        StrCpy $0 StopGetDrives<br /><br />        Push $0<br />FunctionEnd<br /><br />Function ReplaceOnLine<br />Exch $R0 ;file<br />Exch<br />Exch $R1 ;line<br />Exch 2<br />Exch $R2 ;replace with<br />Exch 2<br />Exch 3<br />Exch $R3 ;string to replace<br />Exch 3<br />Push $R4<br />Push $R5<br />Push $R6<br />Push $R7<br />Push $R8<br />Push $R9<br />Push $9<br /> FileOpen $R4 $R0 r<br /> GetTempFileName $R5<br /> FileOpen $R6 $R5 w<br />Top:<br />  FileRead $R4 $R7<br />  IntOp $R8 $R8 + 1<br />  StrCmp $R8 $R1 +3<br />  FileWrite $R6 $R7<br />  Goto Top<br />   StrLen $9 $R3<br />Loop_Top:<br />   StrCpy $R8 0<br />Loop:<br />   IntOp $R8 $R8 - 1<br />   StrCpy $R9 $R7 $9 $R8<br />   StrCmp $R9 "" Finish<br />   StrCmp $R9 $R3 0 Loop<br />    StrCpy $R9 $R7 $R8<br />    IntOp $R8 $R8 + $9<br />    StrCpy $R7 $R7 "" $R8<br />    StrCpy $R7 $R9$R2$R7<br />;detailprint $R7<br />    FileWrite $R6 $R7<br />    Goto Loop_Top<br />Finish:<br />  ClearErrors<br />  FileRead $R4 $R7<br />  IfErrors +3<br />  FileWrite $R6 $R7<br />  Goto Finish<br />FileClose $R4<br />FileClose $R6<br />SetDetailsPrint none<br />Delete $R0<br />Rename $R5 $R0<br />SetDetailsPrint both<br />Pop $9<br />Pop $R9<br />Pop $R8<br />Pop $R7<br />Pop $R6<br />Pop $R5<br />Pop $R4<br />Pop $R3<br />Pop $R2<br />Pop $R1<br />Pop $R0<br />FunctionEnd<br /><br />Function GetServicePack<br />        Push $R0<br />        Push $R1<br /> <br />        ReadRegDWORD $R0 HKLM "System\CurrentControlSet\Control\Windows" "CSDVersion"<br />        IntOp $R1 $R0 % 256                     ;get minor version<br />        IntOp $R0 $R0 / 256                     ;get major version<br /> <br />        Exch $R1<br />        Exch<br />        Exch $R0<br />FunctionEnd<br /><br />Function GetWindowsVersion <br />  Push $R0<br />  Push $R1<br /> <br />  ClearErrors<br /> <br />  ReadRegStr $R0 HKLM \<br />  "SOFTWARE\Microsoft\Windows NT\CurrentVersion" CurrentVersion<br /> <br />  IfErrors 0 lbl_winnt<br />  <br />  ; we are not NT<br />  ReadRegStr $R0 HKLM \<br />  "SOFTWARE\Microsoft\Windows\CurrentVersion" VersionNumber<br /> <br />  StrCpy $R1 $R0 1<br />  StrCmp $R1 '4' 0 lbl_error<br /> <br />  StrCpy $R1 $R0 3<br /> <br />  StrCmp $R1 '4.0' lbl_win32_95<br />  StrCmp $R1 '4.9' lbl_win32_ME lbl_win32_98<br /> <br />  lbl_win32_95:<br />    StrCpy $R0 '95'<br />  Goto lbl_done<br /> <br />  lbl_win32_98:<br />    StrCpy $R0 '98'<br />  Goto lbl_done<br /> <br />  lbl_win32_ME:<br />    StrCpy $R0 'ME'<br />  Goto lbl_done<br /> <br />  lbl_winnt:<br /> <br />  StrCpy $R1 $R0 1<br /> <br />  StrCmp $R1 '3' lbl_winnt_x<br />  StrCmp $R1 '4' lbl_winnt_x<br /> <br />  StrCpy $R1 $R0 3<br /> <br />  StrCmp $R1 '5.0' lbl_winnt_2000<br />  StrCmp $R1 '5.1' lbl_winnt_XP<br />  StrCmp $R1 '5.2' lbl_winnt_2003<br />  StrCmp $R1 '6.0' lbl_winnt_vista lbl_error<br /> <br />  lbl_winnt_x:<br />    ;StrCpy $R0 "NT $R0" 6<br />    StrCpy $R0 'NT'<br />  Goto lbl_done<br /> <br />  lbl_winnt_2000:<br />    Strcpy $R0 '2000'<br />  Goto lbl_done<br /> <br />  lbl_winnt_XP:<br />    Strcpy $R0 'XP'<br />  Goto lbl_done<br /> <br />  lbl_winnt_2003:<br />    Strcpy $R0 '2003'<br />  Goto lbl_done<br /> <br />  lbl_winnt_vista:<br />    Strcpy $R0 'Vista'<br />  Goto lbl_done<br /> <br />  lbl_error:<br />    Strcpy $R0 ''<br />  lbl_done:<br /> <br />  Pop $R1<br />  Exch $R0<br />FunctionEnd<br /><br />Function FileSearch<br />Exch $R0 ;search for<br />Exch<br />Exch $R1 ;input file<br />Push $R2<br />Push $R3<br />Push $R4<br />Push $R5<br />Push $R6<br />Push $R7<br />Push $R8<br />Push $R9<br /> <br />  StrLen $R4 $R0<br />  StrCpy $R7 0<br />  StrCpy $R8 0<br /> <br />  ClearErrors<br />  FileOpen $R2 $R1 r<br />  IfErrors Done<br /> <br />  LoopRead:<br />    ClearErrors<br />    FileRead $R2 $R3<br />    IfErrors DoneRead<br /> <br />    IntOp $R7 $R7 + 1<br />    StrCpy $R5 -1<br />    StrCpy $R9 0<br /> <br />    LoopParse:<br />      IntOp $R5 $R5 + 1<br />      StrCpy $R6 $R3 $R4 $R5<br />      StrCmp $R6 "" 0 +4<br />        StrCmp $R9 1 LoopRead<br />          IntOp $R7 $R7 - 1<br />          Goto LoopRead<br />      StrCmp $R6 $R0 0 LoopParse<br />        StrCpy $R9 1<br />        IntOp $R8 $R8 + 1<br />        Goto LoopParse<br /> <br />  DoneRead:<br />    FileClose $R2<br />  Done:<br />    StrCpy $R0 $R8<br />    StrCpy $R1 $R7<br /> <br />Pop $R9<br />Pop $R8<br />Pop $R7<br />Pop $R6<br />Pop $R5<br />Pop $R4<br />Pop $R3<br />Pop $R2<br />Exch $R1 ;number of lines found on<br />Exch<br />Exch $R0 ;output count found<br />FunctionEnd<br /></code>
</pre><br />
      <br />
      ANY help would be greatly appreciated!<br />
      <br />
      Thanks
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bubustoober</span><br />
      <span class="post-time small text-muted">5th May 2009 11:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I just went through a similar problem in using ReplaceOnLine. Ultimately I realized that ReplaceOnLine's usage of memory registers was stepping on (or being stepped on by) my usage of memory registers. I'm no expert at NSIS, but I suggest you check your memory usage very carefully.<br />
      <br />
      I was getting output that was repeating itself in various shapes...<br />
      <br />
      pre-execution file contents:<br />
      line 1: blah blah<br />
      line 2: original content<br />
      line 3:<br />
      <br />
      Push "original content"<br />
      Push "replacement"<br />
      Push 2<br />
      Push "some\path\file.txt"<br />
      Call ReplaceOnLine<br />
      <br />
      post-execution file contents:<br />
      <br />
      line 1: blah blah<br />
      line 2: replacement replacement<br />
      line 3: replacement replacement replacement<br />
      line 4: replacement replacement replacement replacement<br />
      etc.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">BerSerK6996</span><br />
      <span class="post-time small text-muted">5th May 2009 12:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">ok thanks, I'll look into it.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
