<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Calling managed .NET DLL from NSIS - this works :-)" />

  <title>Calling managed .NET DLL from NSIS - this works :-) - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content=" Calling managed .NET DLL from NSIS - this works :-)" />

  <title>Calling managed .NET DLL from NSIS - this works :-) - NSIS Forums</title>
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" />
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content=" Calling managed .NET DLL from NSIS - this works :-)" />

  <title>Calling managed .NET DLL from NSIS - this works :-) - NSIS Forums</title>
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" />
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Calling managed .NET DLL from NSIS - this works :-)</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=295881">Calling managed .NET DLL from NSIS - this works :-)</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">13th August 2008 09:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Calling managed .NET DLL from NSIS - this works!</strong><br />
      Hi there,<br />
      <br />
      This is a howto on calling managed .NET DLLs from NSIS. It works and is very easy.<br />
      <br />
      Background:<br />
      <br />
      One thing you should know is, that when you call a .NET DLL from NSIS, your installer will be dependent upon that the .NET framework is installed. The NSIS documentation contains information on how to detect the presence of the framework and how to download and install it if nessecary.<br />
      <br />
      If you have a C# DLL, it requires that you write a managed .NET C++/CLR wrapper. You do not need to write a C++ Win32 wrapper, which is not so funny when you want to call your managed C# DLL. In your wrapper you will be able to call your C# code directly.<br />
      <br />
      Setting up your project:<br />
      <br />
      I assume you already have your C# DLL ready with some classes and methods in it you want to call. If you have this in a solution, you can now add a new project to the solution, select C++ CLR, then select class library. This will generate a managed C++/CLR dll and this is the DLL you will be calling from NSIS. Remember to add your C# project as a reference in your C++/CLR project.<br />
      <br />
      The C++/CLR code:<br />
      <br />
      Alright. What you have to do now is to write a C++/CLR funtion for each C# method you want to call. The C++/CLR function should look like this in your cpp or h file:<br />
      <br /></p>
      <pre>
<span style="color: #FF8000">#pragmaonce//placedatthetopofthefile
<br /><br /></span><span style="color: #0000BB">extern</span><span style="color: #DD0000">"C"</span><span style="color: #0000BB">__declspec</span><span style="color: #007700">(</span><span style="color: #0000BB">dllexport</span><span style="color: #007700">)</span><span style="color: #0000BB">char</span><span style="color: #007700">*</span><span style="color: #0000BB">SomeFunction</span><span style="color: #007700">()
<br />{
<br /></span><span style="color: #FF8000">//getastringfromyourC#method(inthiscaseitisastaticmethod)
<br /></span><span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">String</span><span style="color: #007700">^</span><span style="color: #0000BB">str</span><span style="color: #007700">=</span><span style="color: #0000BB">MyNamespace</span><span style="color: #007700">::</span><span style="color: #0000BB">MyClass</span><span style="color: #007700">::</span><span style="color: #0000BB">MyMethod</span><span style="color: #007700">();
<br /><br /></span><span style="color: #FF8000">//convertstringtochar*(thisisoneline)
<br /></span><span style="color: #0000BB">char</span><span style="color: #007700">*</span><span style="color: #0000BB">chp</span><span style="color: #007700">=(</span><span style="color: #0000BB">char</span><span style="color: #007700">*)(</span><span style="color: #0000BB">void</span><span style="color: #007700">*)</span><span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Runtime</span><span style="color: #007700">::</span><span style="color: #0000BB">InteropServices</span><span style="color: #007700">::</span><span style="color: #0000BB">Marshal</span><span style="color: #007700">::</span><span style="color: #0000BB">StringToHGlobalAnsi</span><span style="color: #007700">(</span><span style="color: #0000BB">str</span><span style="color: #007700">);
<br /><br /></span><span style="color: #FF8000">//returnthechar*toNSIS
<br /></span><span style="color: #007700">return</span><span style="color: #0000BB">chp</span><span style="color: #007700">;
<br />}
</span>
</pre>That's it :) To call the function from NSIS:<br />
      <pre>
<code>SetOutPath$PLUGINSDIR
<br />System</code><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'DLLName::SomeFunction(v)t.r0'
</span>
</pre>This will return the string in register $0. You can have parameters too. See the NSIS documentation for more information on System::Call.<br />
      <br />
      Make sure to include both the C++/CLR dll and the C# dll in your installer and place them in for instance the $PLUGINSDIR. When calling the C++/CLR dll with System::Call, be sure to make a call to SetOutPath $PLUGINSDIR first, so NSIS can find the DLLs.<br />
      <br />
      Hope you can use this.<br />
      <br />
      Regards Claes Brandt
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">13th August 2008 13:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Nice! Please could you make a Wiki page for this?<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">13th August 2008 20:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Done. It is now located here:<br />
      http://nsis.sourceforge.net/Calling_Managed_.Net_DLL_From_NSIS</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">15th August 2008 10:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I justed tested my installer on a system with no .NET framework at all, and it seems I have to make sure that both the .NET framework and Visual C++ redistributable are installed. I'm gonna write this into the wiki.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">15th August 2008 11:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Forget that. I found it to be something else. Basically it is because the cannot find the C# dll when calling it via the C++ dll. I will work on it and get back when I have the solution.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">15th August 2008 11:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Try setting the current directory to $PLUGINSDIR with SetOutPath. If that doesn't work you could try updating the PATH variable to point to $PLUGINSDIR. Maybe it would be easier just to extract the C# dll to $SYSDIR.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">15th August 2008 14:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Unfortunately none of those three method works, I tried them. It would have been nice. I will explain at the bottom of this post why and some details, but here is a workaround, that will work:<br />
      <br />
      1) Create your script that calls your C++/CLR DLL which then in turn calls your C# DLL. This is what I described in the first post. But do not copy your C# DLL file in this script. Resulting exe could be for instance setup1.exe<br />
      <br />
      2) Create another script that includes your C# DLL and setup1.exe. In .onGUIInit it copies them to $TEMP, then executes setup1.exe. When setup1.exe runs and calls the C++/CLR DLLs, which in turn calls the C# DLLs, the .NET framework can find the C# DLLs. When setup1.exe finishes, you delete both the C# DLL and setup1.exe then call abort. You will never see the first installer.<br />
      <br />
      I guess I should include this in the Wiki page?<br />
      <br />
      ---<br />
      <br />
      Here is why it will not work trying to set the current dir, setting the path or extract the C# dll to $SYSDIR: When the NSIS installer invokes those C++/CLR DLL functions, .NET assumes it should look for the C# DLLs in the same directory as the installer exe.<br />
      <br />
      Now, we could extract the C# DLL in the same directory as where the installer exe runs, but if it runs from a readonly directory, it extract will fail.<br />
      <br />
      There are ways to make .NET probe for DLLs in other directories than where the executing exe is located. This MSDN article explains it: http://msdn.microsoft.com/en-us/library/15hyw9x3(VS.71).aspx. The problem in those methods is that we still cannot copy a config file to a readonly directory.<br />
      <br />
      We could also use reflection to load the C# assembly from any location we want, but then we loose compile-time error catching, and loading the assembly like this is ugly and I had some trouble getting NSIS to release the assembly file once it was loaded - it simply couldn't delete the DLL when exiting the installer.<br />
      <br />
      Claes</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">15th August 2008 17:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have work in progress :) This time it is a real NSIS plug-in, that can load a .NET DLL. I guess it will be called CLR.dll or CLRLoader.dll or something. What I have working so far:<br />
      <br />
      1) It is placed in the plugins dir in NSIS.<br />
      2) It is called with (in one line):<br /></p>
      <pre>
<code>CLRLoader</code><span style="color: #007700">::</span><span style="color: #0000BB">Invoke</span><span style="color: #DD0000">"SomeAssembly.dll""SomeNamespace.SomeClass""SomeMethod""param1,param2,param3"
<br /></span><span style="color: #0000BB">pop</span><span style="color: #007700">$</span><span style="color: #0000BB">0
<br /></span>

<!-- php buffer end -->
                
                
                
</pre>
      <hr />
      <pre>
        
3) It can handle string parameters and string return value at the moment.<br /><br />Todo: Dynamic number of parameters.<br />Todo: Object type return value.<br />Todo: Fix a bug where that causes the DLL to remain in the tmp directory. NSIS can't delete it.<br /><br />I also have it in a version, where you call it with System::Call, and this version does not remain in the tmp directory. This version has to be included manually in the installer and placed in for instance $PLUGINSDIR.<br /><br />It is called with (one line):<br />        PHP Code:
        
                
</pre>
      <hr />
      <pre>
                <code style="white-space:nowrap">
                
                        <!-- php buffer start --></code><span style="color: #000000">
<span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'CLRLoader::Invoke(t"SomeAssembly.dll",t"SomeNamespace.SomeClass",t"SomeMethod",t"param1,param2,param3")t.r0'
</span></span>
</pre>Both versions are attached.<br />
      <br />
      If you want to try it, remember to rename the desired DLL to CLRLoader.dll. If it is the "native" NSIS version, put it in the pluginsdir.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">18th August 2008 12:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">My new NSIS plug-in is now working. It can call methods in managed .NET DLLs. It supports dynamic number of parameters of types void, string (unicode), int, float, bool. Return value can be these types too. Strings and floats must be enclosed in "". The .NET classes called must have a default constructor.<br />
      <br />
      You can find the plug-in attached to this post. This is version 0.1 of the plugin. I will write a wiki plug-in page for it shortly. It is provided here as-is for testing.<br />
      <br />
      Let me know what you think of it, if you have any suggestions, questions or have trouble using it. Also, if you think more types should be supported for input and return values, let me know.<br />
      <br />
      The following is a sample script that copies a .NET dll to pluginsdir along with this plugin. The .NET method called takes the following parameters: string, int, float and boolean. It then returns a string.<br /></p>
      <pre>
<code>SetOutPath$PLUGINSDIR
<br />File</code><span style="color: #DD0000">"SomeAssembly.dll"</span><span style="color: #007700">;</span><span style="color: #0000BB">sometest</span><span style="color: #007700">.</span><span style="color: #0000BB">NETassembly
<br />File</span><span style="color: #DD0000">"CLR.dll"</span><span style="color: #007700">;</span><span style="color: #0000BB">thisplugin
<br />System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">`</span><span style="color: #0000BB">CLR::Call(w'SomeAssembly.dll::SomeNamespace::SomeClass::SomeMethod("somestringvalue",12,"15,8",false)')w.r0</span><span style="color: #007700">`
</span>
</pre>This replaces the above method I described and my former <a href="http://nsis.sourceforge.net/Calling_Managed_.Net_DLL_From_NSIS" target="_blank">wiki</a>, as this plug-in fixes some issues with the method described previously.<br />
      <br />
      Regards Claes<br />
      <br />
      P.S.: Minor issue: You have to call it via System::Call. While this works perfectly, I would like it to be a true NSIS plugin. The reason for why it is called via System::Call is that if I make it a real NSIS plugin, the DLL remains in the $PLUGINS dir when the installer closes. If I get to fix that issue, I can make it a real NSIS plugin, that does not need System::Call.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">18th August 2008 13:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You can use `` for outer quotes saving you having to use $\" for ".<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">18th August 2008 13:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Excellent, thanks :). I corrected the post with your suggestion.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">19th August 2008 09:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Stu, I have a question. I really would like this to be a native NSIS dll, but as stated, the dll will not be deleted by NSIS, when the installer closes. I found out that it is automatically marked by NSIS to be deleted along with the directory, on next reboot, and so the file is gone. My question is, would that be ok? Or should I for now stick to the version where I call it with System::Call? The call would be much cleaner, if I made it a native NSIS plugin, and I probably would devide the parameters up into different parts. And the user would not have to include it manually, just put it in the plugins dir.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">19th August 2008 16:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Sure keep as both and let the user decide which to use.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">20th August 2008 10:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Stu, would it be possible to remove the zip file from post #8, as it seems some have downloadet that instead of the zip in post #9. The zip in post #8 should not be used.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">20th August 2008 14:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Sorry I just deleted the wrong one. Either way it would be best to upload to the Wiki instead.<br />
      <br />
      Upload to for example:<br />
      <a href="http://nsis.sf.net/File:CLRLoader.zip" target="_blank">http://nsis.sf.net/File:CLRLoader.zip</a><br />
      <br />
      Then to embed in your page:<br />
      &lt;attach&gt;CLRLoader.zip&lt;/attach&gt;<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">20th August 2008 20:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>New wiki page including download</strong><br />
      No problem :) I just made a new wiki page at http://nsis.sourceforge.net/Call_.NET_DLL_methods_plug-in, including the download. It is located under plug-ins.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">20th August 2008 23:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I noticed your float has a comma in it rather than a full stop in the sample code.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">20th August 2008 23:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Yes, in Denmark we use a comma there. I know that you use dot in UK and US, so I will correct the sample. However, I am working on another way to pass in parameters (using variable arguments in c++), which will eliminate the problem.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">rbchasetfb</span><br />
      <span class="post-time small text-muted">3rd September 2008 20:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Love the CLRLoader...did just what I needed. However, is there a trick to get the CLRLoader.dll to delete from the $PLUGINSDIR when the NSIS Setup ends. All the other DLLs and files delete okay, including the one that CLRLoader calls, just the CLRLoader.dll is left behind. Here's the code snipet:<br />
      <br /></p>
      <pre>
<code>SetPluginUnloadalwaysoff
<br /><br /></code><span style="color: #007700">Function</span><span style="color: #0000BB">loadDll
<br />InitPluginsDir
<br />SetOutPath$PLUGINSDIR
<br />File</span><span style="color: #DD0000">"${NSISDIR}\\Plugins\\CLRLoader.dll"
<br /></span><span style="color: #0000BB">File</span><span style="color: #DD0000">"ITMInstaller.dll"
<br /></span><span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">${</span><span style="color: #0000BB">NSIS_MAX_STRLEN</span><span style="color: #007700">}
<br /></span><span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'CLRLoader::Call(w"ITMInstaller::NSIS::ITMInstaller::GetDomain()")w.r0'</span><span style="color: #007700">?</span><span style="color: #0000BB">u
<br />MessageBoxMB_OK</span><span style="color: #007700">|</span><span style="color: #0000BB">MB_ICONINFORMATION</span><span style="color: #DD0000">"$0"
<br /></span><span style="color: #0000BB">SetPluginUnloadmanual
<br />System</span><span style="color: #007700">::</span><span style="color: #0000BB">Free</span><span style="color: #007700">$</span><span style="color: #0000BB">0
<br />Delete</span><span style="color: #DD0000">"$PLUGINSDIR\\CLRLoader.dll"
<br /></span><span style="color: #0000BB">FunctionEnd
<br /><br />Section</span><span style="color: #DD0000">"MainSection"</span><span style="color: #0000BB">SEC01
<br />CallloadDll
<br />SectionEnd
<br /></span>

<!-- php buffer end -->
                
                
                
</pre>
      <hr />
      <pre>
        
Thanks in Advance for the help.
                
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">3rd September 2008 23:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Yes, it is a known issue. I am working on how to fix it, but for now you just have to leave it as is. The file is deleted the next time the user reboots the system. Did you use the new plug-in located at http://nsis.sourceforge.net/Call_.NET_DLL_methods_plug-in, or did you you one of the previous versions?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">rbchasetfb</span><br />
      <span class="post-time small text-muted">3rd September 2008 23:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for the quick reply. I did get the one from that link. I found that I could delete CLRLoader.dll right after the NSIS installer closed and not have to wait for the reboot.<br />
      <br />
      I actually loaded up the code that was in the Zip and played around a bit in VS2005 (I'm an old c programmer). Your code does a good job of cleaning up and it does successfully free the called .NET assembly as it is deleted on installer exit. It seems its the way that the System::Call is releasing the resources associated with the CLRLoader.dll...or at least CLRLoader.dll is not getting/responding to a command to "unload".<br />
      <br />
      Hope that helps and thanks for coming up with this one. Looking forward to the eventual fix.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">3rd September 2008 23:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Just one question: Is there a specific reason why your "CLR.dll" must be called through the System-Plugin instead of making it a "normal" NSIS plugin? This way the parameters could be passed to the CLR plugin directly, instead of wrapping them into the System plugin parameters. Like this:<br />
      <br /></p>
      <pre>
<code>CLR::Call 'SomeAssembly.dll::SomeNamespace::SomeClass::SomeMethod("some string value",12,"15.8",false)'</code>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">4th September 2008 00:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">There is no reason anymore, and I will soon replace it with a native NSIS plugin.<br />
      <br />
      One reason why it is not a native NSIS plugin yet is that when I startet this, the dll wouldn't be deleted from the temporary folder. But when I called it through the System::Call, the dll was deleted. However, at some point during development of the dll, even when calling through System::Call the dll is not deleted. So at this point it is not anymore a valid argument for not making it a native NSIS plugin.<br />
      <br />
      The more important reason for the delay of the native dll release is that I am not sure if NSIS supports unicode out of the box. I have not yet had any luck passing unicode strings to the native dll. I tried with CHAR and wchar_t in exdll.h, but no luck. Can anyone help me with this?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">4th September 2008 00:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I don't think NSIS does support Unicode yet. But there is development going into that direction. However I think the strings passed from NSIS to the System-Plugin are *not* Unicode, so passing the None-Unicode strings directly from NSIS to your CLR-Plugin should be no worse at least...<br />
      <br />
      BTW: Do you remember to unload the plugin after all work is done in order to allow the plugin DLL to be delete?<br />
      <br />
      Like this:<br />
      <br /></p>
      <pre>
<code>CLR::Call /NOUNLOAD 'SomeAssembly.dll::SomeNamespace::SomeClass::SomeMethod("some string value",12,"15.8",false)'<br />...<br />(Some other important stuff here)<br />...<br />CLR::Destroy</code>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">4th September 2008 01:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Alright. I have uploaded a new version of the plugin, version 0.2. It is now a native NSIS plugin :) I have updated the wiki page too. Found a bug too and added a parameter type.<br />
      <br />
      Thanks for the feedback rbchasetfb. I have tried in those directions too regarding unloading.<br />
      <br />
      LoRd_MuldeR, regarding making a Destroy function. I am not quite sure what to put in that function.<br />
      <br />
      Another thing. Is there a way to get to know how many parameters I have passed in, so I can skip passing in the int with number of parameters?<br />
      <br />
      Wiki page: http://nsis.sourceforge.net/Call_.NET_DLL_methods_plug-in.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">4th September 2008 02:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by claesabrandt</i><br />
        LoRd_MuldeR, regarding making a Destroy function. I am not quite sure what to put in that function.[/B]
      </blockquote>The important thing is, that you call your Plugin one time *without* the "/NOUNLOAD" option, before the installer exists. Otherwise the DLL won't be freed and thus cannot be deleted. If you don't have any resources to free inside your DLL, simply implement a dummy "Destroy" method. Sidenote: Calling the plugin with /NOUNLOAD will prevent the DLL from loosing it's "internal" state after every single call. It will also prevent the DLL from being re-initialized at/before very single call...<br />
      <br />

      <blockquote>
        <i>Originally posted by claesabrandt</i> Another thing. Is there a way to get to know how many parameters I have passed in, so I can skip passing in the int with number of parameters?[/B]
      </blockquote>Nope, you cannot. NSIS arguments are simply passed on the NSIS stack and your plugin MUST know how many arguments it has to pop off the stack. I highly recommend you don't let the user call your plugin directly! Provide some macros instead. This makes it much safer and much more easy to use as well!<br />
      <br />
      <pre>
<code>!macro _CallCRL dll namespace class method args<br />  CLR::Call /NOUNLOAD `${dll}::${namespace}::${class}::${method}(${args})`<br />!macroend<br /><br />!define CallCRL "!insertmacro _CallCRL"</code>
</pre>
      <pre>
<code>Section<br />  ${CallCRL} "SomeAssembly.dll" "SomeNamespace" "SomeClass" "SomeMethod" '"some string value",12,"15.8",false'<br />SectionEnd</code>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">rbchasetfb</span><br />
      <span class="post-time small text-muted">4th September 2008 02:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for the speedy update, claesabrandt. I've downloaded and tried your example, but when I call pop $0 after CLR:Call, $0 contains the name of my DLL. If I call pop $0 again, it contains the "Namespace.Classname" parameter. I'm probably missing something, but I did use the testscript.nsi you included, just don't seem to be able to get the return string in $0.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br />
      <span class="post-time small text-muted">4th September 2008 02:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Returning a value could also be "optimized" with a macro:<br />
      <br /></p>
      <pre>
<code>!macro _CallCRL return_var dll namespace class method args<br />  CLR::Call /NOUNLOAD `${dll}::${namespace}::${class}::${method}(${args})`<br />  Pop ${return_var}<br />!macroend<br /><br />!define CallCRL "!insertmacro _CallCRL"</code>
</pre>
      <pre>
<code>Section<br />  ${CallCRL} $0 "SomeAssembly.dll" "SomeNamespace" "SomeClass" "SomeMethod" '"some string value",12,"15.8",false'<br />  MessageBox MB_OK "Return value is: $0"<br />SectionEnd</code>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">4th September 2008 10:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">rbchasetfb, I had the same problem, but then I found out that I still was compiling the old CLR.dll with the installer. Make sure no CLR.dll is located in the script's directory and that you do not call File CLR.dll. Just put the CLR.dll in NSIS's plugins dir. Let me know if it helps.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">4th September 2008 13:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Just corrected a bug where if more that one class were found in the .net assembly, only the first class could be loaded. Version 0.3 can be downloaded now and the wiki has been updated.<br />
      <br />
      Wiki: http://nsis.sourceforge.net/Call_.NET_DLL_methods_plug-in</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">rbchasetfb</span><br />
      <span class="post-time small text-muted">4th September 2008 14:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Ok. Here's the latest.<br />
      TEST SCENARIO 1:<br />
      Downloaded your new v0.3. Copied the CLR.dll to my NSIS\Plugins folder and insured that CLR.dll exists no where else. Compiled and ran the test script and it returned the dll file name again.<br />
      <br />
      TEST SCENARIO 2:<br />
      So, took the code from the zip file, converted the vcproj file to work in VS2005 (changed version to 8.00 and removed the MinFrameworkVersion attribute from the AssemblyReference tags), opened the vcproj in VS2005 and compiled it. Insured the new CLR.dll was in the plugins folder and built and ran the test script...got the right result back from the .NET function called!!! However, the DLL was left behind in $PLUGINSDIR again.<br />
      <br />
      TEST SCENARIO 3:<br />
      So, opened up a virtual machine of mine and installed VS C++ 2008 Express, loaded the unaltered code from the zip file, compiled it. Moved it to NSIS\Plugins, built and ran the test script and got the same result as in Test Scenario 1 above, the dll filename was returned.<br />
      <br />
      BTW Thanks for working on this one as much as you are. It has some great value. I will use the one I built in Scenario 2 for now, but look forward to any advancements you make.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">4th September 2008 17:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That is really strange. I'm already compiling it for .NET framework 2.0, just using VS2008 to do it. I cannot reproduce the error at all :( I wil continue to try to reproduce the error in various ways.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">rbchasetfb</span><br />
      <span class="post-time small text-muted">4th September 2008 17:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">claesabrandt, I think I fixed the need for passing the number of parameters. In the Call function in your code, replace the num params and params sections with the following code and add the itreplace function above the Call function in the code.<br />
      Here's the code to replace in the Call function:<br />
      PHP Code:</p>
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #FF8000">//params<br /></span> <span style="color: #0000BB">popstring</span><span style="color: #007700">(</span><span style="color: #0000BB">buf</span><span style="color: #007700">);<br /></span> <span style="color: #0000BB">stringsargs</span><span style="color: #007700">=</span><span style="color: #0000BB">string</span><span style="color: #007700">(</span><span style="color: #0000BB">buf</span><span style="color: #007700">);<br /></span> <span style="color: #0000BB">vector</span><span style="color: #007700">&lt;</span><span style="color: #0000BB">string</span><span style="color: #007700">&gt;</span><span style="color: #0000BB">args</span><span style="color: #007700">;<br /></span> <span style="color: #0000BB">stringseparator</span><span style="color: #007700">=</span><span style="color: #0000BB">string</span><span style="color: #007700">(</span><span style="color: #DD0000">","</span><span style="color: #007700">);<br /></span> <span style="color: #0000BB">std</span><span style="color: #007700">::</span><span style="color: #0000BB">string</span><span style="color: #007700">::</span><span style="color: #0000BB">size_typestart</span><span style="color: #007700">=</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br /></span> <span style="color: #0000BB">std</span><span style="color: #007700">::</span><span style="color: #0000BB">string</span><span style="color: #007700">::</span><span style="color: #0000BB">size_typeend</span><span style="color: #007700">=</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br />
      while((</span><span style="color: #0000BB">end</span><span style="color: #007700">=</span><span style="color: #0000BB">sargs</span><span style="color: #007700">.</span><span style="color: #0000BB">find</span><span style="color: #007700">(</span><span style="color: #0000BB">separator</span><span style="color: #007700">,</span><span style="color: #0000BB">start</span><span style="color: #007700">))!=</span><span style="color: #0000BB">std</span><span style="color: #007700">::</span><span style="color: #0000BB">string</span><span style="color: #007700">::</span><span style="color: #0000BB">npos</span><span style="color: #007700">)<br />
      {<br /></span> <span style="color: #0000BB">stringtmp</span><span style="color: #007700">=</span><span style="color: #0000BB">sargs</span><span style="color: #007700">.</span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">start</span><span style="color: #007700">,</span><span style="color: #0000BB">end</span><span style="color: #007700">-</span><span style="color: #0000BB">start</span><span style="color: #007700">);<br /></span> <span style="color: #0000BB">itreplace</span><span style="color: #007700">(</span><span style="color: #0000BB">tmp</span><span style="color: #007700">,</span><span style="color: #DD0000">"'"</span><span style="color: #007700">,</span><span style="color: #DD0000">""</span><span style="color: #007700">);<br /></span> <span style="color: #0000BB">args</span><span style="color: #007700">.</span><span style="color: #0000BB">push_back</span><span style="color: #007700">(</span><span style="color: #0000BB">tmp</span><span style="color: #007700">);<br /></span> <span style="color: #0000BB">start</span><span style="color: #007700">=</span><span style="color: #0000BB">end</span><span style="color: #007700">+</span><span style="color: #0000BB">separator</span><span style="color: #007700">.</span><span style="color: #0000BB">size</span><span style="color: #007700">();<br />
      }<br /></span> <span style="color: #0000BB">stringtmp</span><span style="color: #007700">=</span><span style="color: #0000BB">sargs</span><span style="color: #007700">.</span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">start</span><span style="color: #007700">);<br /></span> <span style="color: #0000BB">itreplace</span><span style="color: #007700">(</span><span style="color: #0000BB">tmp</span><span style="color: #007700">,</span><span style="color: #DD0000">"'"</span><span style="color: #007700">,</span><span style="color: #DD0000">""</span><span style="color: #007700">);<br /></span> <span style="color: #0000BB">args</span><span style="color: #007700">.</span><span style="color: #0000BB">push_back</span><span style="color: #007700">(</span><span style="color: #0000BB">tmp</span><span style="color: #007700">);</span> Basically, this code performs a split function on the string popped of the stack and adds each split-off element to the args vector, performing a replace of the single quotes along the way.<br />
      <br />
      Here's the itreplace function:<br /></span>
      <pre>
<code>voiditreplace</code><span style="color: #007700">(</span><span style="color: #0000BB">string</span><span style="color: #007700">&amp;</span><span style="color: #0000BB">source</span><span style="color: #007700">,const</span><span style="color: #0000BB">stringfind</span><span style="color: #007700">,</span><span style="color: #0000BB">stringreplace</span><span style="color: #007700">)
<br />{
<br /></span><span style="color: #0000BB">size_tj</span><span style="color: #007700">;
<br />for(;(</span><span style="color: #0000BB">j</span><span style="color: #007700">=</span><span style="color: #0000BB">source</span><span style="color: #007700">.</span><span style="color: #0000BB">find</span><span style="color: #007700">(</span><span style="color: #0000BB">find</span><span style="color: #007700">))!=</span><span style="color: #0000BB">string</span><span style="color: #007700">::</span><span style="color: #0000BB">npos</span><span style="color: #007700">;)
<br />{
<br /></span><span style="color: #0000BB">source</span><span style="color: #007700">.</span><span style="color: #0000BB">replace</span><span style="color: #007700">(</span><span style="color: #0000BB">j</span><span style="color: #007700">,</span><span style="color: #0000BB">find</span><span style="color: #007700">.</span><span style="color: #0000BB">length</span><span style="color: #007700">(),</span><span style="color: #0000BB">replace</span><span style="color: #007700">);
<br />}
<br />}
</span>
</pre>Then, in the NSIS project, do the plugin call this way:<br />
      <pre>
<code>CLR</code><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"Somedotnet.dll""namespace.class""TestFunction""TestingString,35.56,true"
</span>
</pre>OR...the code has the provision to do it this way with single quotes around strings to be visually clean:<br />
      <pre>
<code>CLR</code><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"Somedotnet.dll""namespace.class""TestFunction""'TestingString',35.56,true"
</span>
</pre>You can also leave the spaces out after the commas in the parameter list if you like.<br />
      <br />
      On the issue of the strange results from my test scenario's I wrote about earlier, I've even tried the tests on other machines and get the same results. My last test runthrough was on a Windows 2003 Server with only .net 2.0 installed. For now, I'll live with the stay-behind dll file and use the VS2005 compiled one with the changes above.<br />
      <br />
      Thanks again. Let me know if you find any bugs in the above code.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">4th September 2008 17:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for the reply, it is nice to have other eyes on this, I appreciate your help :)<br />
      <br />
      I had that model ealier too (splitting a parameters string), but what happens if your strings has commas in them? Actually, I still prefer having the parameters as they are now in the plugin, as it is cleaner to read instead of having them all in one string. I do have some code to split that string taking into acount that strings can have commas in them that are not two seperate parameters. But, isn't it okay as it is now?<br />
      <br />
      What I would like to spend some time on is 1) Getting the DLL to be deleted after install and 2) Investigating the problem you encountered with the return value. Could it be the stack that is corrupted in some way?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">rbchasetfb</span><br />
      <span class="post-time small text-muted">4th September 2008 19:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Okay, maybe on to something here. That return value being the dll name problem seems to stem from the version of .NET installed.<br />
      <br />
      My development box, and the two machines I was testing on, both had .NET 2.0 installed as well as the .NET 2.0 Service Pack 1 and .NET 3.0 Service Pack 1.<br />
      <br />
      When I went to a machine with no .NET 2.0 installed, then installed the base .NET 2.0 redistributable with no Services packs, the dll name showed up as the return value.<br />
      <br />
      Once I installed just the .NET 2.0 Service pack 1, the problem resolved and I got expected responses from the dll calls.<br />
      <br />
      BTW - this is all with my VS2005 compiled DLL. I still get the dll name returned with your VS2008 compiled DLL on the new .NET 2.0 w/SP1 machine.<br />
      <br />
      This may be coming down to some variations of the .NET 2.0 environment based on other .NET Framework installs. If I'm not mistaken, VS2008 requires .NET 3.5 installed. Maybe that has affected the .NET 2.0 assemblies in some way.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">rbchasetfb</span><br />
      <span class="post-time small text-muted">5th September 2008 20:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">claesabrandt, can you check the file version of you System.dll in the C:\WINDOWS\Microsoft.NET\Framework\v2.0.50727 folder. Mine reads 2.0.50727.1433. It seems that the .1433 build number is the important part, when its .42, my VS2005 build doesn't work (dll calls return the dll filename).<br />
      <br />
      I've tried installing .NET 3.5 SP1 on my test machine which installs .NET 2.0 System.dll with a file version of 2.0.50727.3053 and your compiled CLR.dll returns the dll filename as before.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">5th September 2008 20:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Mine reads 2.0.50727.1433 as yours. Now that you mention this, I have a vmware machine where my plugin sometimes returns a bogus value. I will investigate too, but it sounds like the stack is getting messed up in some way.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">rbchasetfb</span><br />
      <span class="post-time small text-muted">5th September 2008 20:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I was thinking it might read something differently entirely on your machine than .1433, .42 or .3053. So it would seem that that is not it. I'm at a loss on this issue as neither of us are able to both compile the same CLR.dll and subsequently recreate the problem.<br />
      <br />
      At this point, I've changed my prerequisite NSIS code to install NetFx20SP1_x86.exe instead of the usual dotnetfx.exe. This insures .NET 2.0 SP1 is installed. Additionally, I'm using the VS2005 compiled version of the CLR.dll.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">5th September 2008 20:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hmm, I just tried it on my vwmare machine, and on that System.dll has the same version 2.0.50727.1433. Here the call actually fails and has the same result as you experienced - it returns the name of the dll file. Don't worry, we will eventually find the problem :)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
      <span class="post-time small text-muted">5th September 2008 20:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Wait, it seems the problem is completely different. NSIS actually outputs the error "Could not load "..blabla..CLR.dll". However, the DLL has been copied by NSIS to the correct location, so it is some load error.</p>
    </div>
    <hr />
    <!-- Bootstrap core CSS -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    <div class="container">
      <!-- Put navigation bar here -->

      <ol class="breadcrumb">
        <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

        <li><a href="f-65.html">NSIS Discussion</a></li>

        <li class="active">Calling managed .NET DLL from NSIS - this works :-)</li>
      </ol>

      <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=295881">Calling managed .NET DLL from NSIS - this works :-)</a></p><br />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
        <span class="post-time small text-muted">8th September 2008 10:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Hmm, I now even tried compiling a C++ Win32 DLL without any .NET. This is only code from exdll.c and exdll.h. It does not run on the machine that my .NET plugin could not run on. Anyony any ideas?</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
        <span class="post-time small text-muted">9th September 2008 08:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">I finally found the problem! My CLR.dll must be compiled in release mode and the system onto which the installer is going to run must have the MS Visual C++ 2008 Redist package installed, which can be included in the installer.<br />
        <br />
        I will release a new version of the zip file (v0.4). Could you test it for me rbchasetfb, so we can verify that the problem is fixed? If you want to use the 2005 edition of the redist, you can just compile the CLR.dll with VS2005 instead.<br />
        <br />
        Would there be a greater wish for having it use the 2005 redist as default instead?</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
        <span class="post-time small text-muted">9th September 2008 09:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Just uploaded version 0.5 which is compiled with Visual Studio 2005, release mode. The need for MS Visual C++ 2008 Redist is now eliminated, in fact, it seems the 2005 redist is not needed either - just the .NET 2.0 framework. Thanks goes to rbchasetfb for great input.</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">rbchasetfb</span><br />
        <span class="post-time small text-muted">10th September 2008 20:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">claesabrandt, very cool that we got through that one. Thanks for sticking with it too. As a thanks, I thought I would post some code that I use in my .NET dll that CLR.dll is calling. It allows the functions in the .NET dll to update the Details list during the install without have to wait to return to the installer and then do a DetailPrint call with some funky string work. The code is in VB.NET, but could easily be converted to C#. The error handling is a little brute force in the MakeLogEntry function, it just ignores the error and returns, potentially writing nothing to the Details list. Non-the-less, very useful I think.<br />
        <br />
        VB.NET Code Required:<br /></p>
        <pre>
<code>ImportsSystem
<br />ImportsSystem</code><span style="color: #007700">.</span><span style="color: #0000BB">Runtime</span><span style="color: #007700">.</span><span style="color: #0000BB">InteropServices
<br />ImportsSystem</span><span style="color: #007700">.</span><span style="color: #0000BB">Threading
<br />ImportsSystem</span><span style="color: #007700">.</span><span style="color: #0000BB">IO
<br />ImportsSystem</span><span style="color: #007700">.</span><span style="color: #0000BB">Windows</span><span style="color: #007700">.</span><span style="color: #0000BB">Forms
<br /><br />NamespaceNSIS
<br /><br /></span><span style="color: #007700">PublicClass</span><span style="color: #0000BB">TestClass
<br /><br /></span><span style="color: #FF8000">//LVITEMStructureDeclaration.
<br /></span><span style="color: #007700">&lt;</span><span style="color: #0000BB">StructLayout</span><span style="color: #007700">(</span><span style="color: #0000BB">LayoutKind</span><span style="color: #007700">.</span><span style="color: #0000BB">Sequential</span><span style="color: #007700">)&gt;</span><span style="color: #0000BB">_
<br /></span><span style="color: #007700">Public</span><span style="color: #0000BB">StructureLVITEM
<br /></span><span style="color: #007700">Public</span><span style="color: #0000BB">mask</span><span style="color: #007700">As</span><span style="color: #0000BB">Int32
<br /></span><span style="color: #007700">Public</span><span style="color: #0000BB">iItem</span><span style="color: #007700">As</span><span style="color: #0000BB">Int32
<br /></span><span style="color: #007700">Public</span><span style="color: #0000BB">iSubItem</span><span style="color: #007700">As</span><span style="color: #0000BB">Int32
<br /></span><span style="color: #007700">Public</span><span style="color: #0000BB">state</span><span style="color: #007700">As</span><span style="color: #0000BB">Int32
<br /></span><span style="color: #007700">Public</span><span style="color: #0000BB">stateMask</span><span style="color: #007700">As</span><span style="color: #0000BB">Int32
<br /></span><span style="color: #007700">Public</span><span style="color: #0000BB">pszText</span><span style="color: #007700">As</span><span style="color: #0000BB">String
<br /></span><span style="color: #007700">Public</span><span style="color: #0000BB">cchTextMax</span><span style="color: #007700">As</span><span style="color: #0000BB">Int32
<br /></span><span style="color: #007700">Public</span><span style="color: #0000BB">iImage</span><span style="color: #007700">As</span><span style="color: #0000BB">Int32
<br /></span><span style="color: #007700">Public</span><span style="color: #0000BB">lParam</span><span style="color: #007700">As</span><span style="color: #0000BB">IntPtr
<br />EndStructure
<br /><br /></span><span style="color: #FF8000">//SendMessageAPIdeclarations.
<br /></span><span style="color: #007700">PublicDeclareFunction</span><span style="color: #0000BB">SendMessageLVLib</span><span style="color: #DD0000">"user32"</span><span style="color: #0000BB">Alias_
<br /></span><span style="color: #DD0000">"SendMessageA"</span><span style="color: #007700">(</span><span style="color: #0000BB">ByValhwnd</span><span style="color: #007700">As</span><span style="color: #0000BB">IntPtr</span><span style="color: #007700">,</span><span style="color: #0000BB">_
<br />ByValwMsg</span><span style="color: #007700">As</span><span style="color: #0000BB">Int32</span><span style="color: #007700">,</span><span style="color: #0000BB">_
<br />ByValwParam</span><span style="color: #007700">As</span><span style="color: #0000BB">Integer</span><span style="color: #007700">,</span><span style="color: #0000BB">_
<br />ByReflParam</span><span style="color: #007700">As</span><span style="color: #0000BB">LVITEM</span><span style="color: #007700">)As</span><span style="color: #0000BB">Integer
<br /></span><span style="color: #007700">PublicDeclareFunction</span><span style="color: #0000BB">SendMessageLib</span><span style="color: #DD0000">"user32"</span><span style="color: #0000BB">Alias_
<br /></span><span style="color: #DD0000">"SendMessageA"</span><span style="color: #007700">(</span><span style="color: #0000BB">ByValhwnd</span><span style="color: #007700">As</span><span style="color: #0000BB">IntPtr</span><span style="color: #007700">,</span><span style="color: #0000BB">_
<br />ByValwMsg</span><span style="color: #007700">As</span><span style="color: #0000BB">Int32</span><span style="color: #007700">,</span><span style="color: #0000BB">_
<br />ByValwParam</span><span style="color: #007700">As</span><span style="color: #0000BB">Integer</span><span style="color: #007700">,</span><span style="color: #0000BB">_
<br />ByReflParam</span><span style="color: #007700">As</span><span style="color: #0000BB">Integer</span><span style="color: #007700">)As</span><span style="color: #0000BB">Integer
<br /><br /></span><span style="color: #FF8000">//ConstantsusedbyLVITEMandSendMessage
<br /></span><span style="color: #007700">PublicConst</span><span style="color: #0000BB">LVM_FIRST</span><span style="color: #007700">as</span><span style="color: #0000BB">Integer</span><span style="color: #007700">=&amp;</span><span style="color: #0000BB">H1000
<br /></span><span style="color: #007700">PublicConst</span><span style="color: #0000BB">LVM_GETITEMCOUNT</span><span style="color: #007700">as</span><span style="color: #0000BB">Integer</span><span style="color: #007700">=</span><span style="color: #0000BB">LVM_FIRST</span><span style="color: #007700">+</span><span style="color: #0000BB">4
<br /></span><span style="color: #007700">PublicConst</span><span style="color: #0000BB">LVM_GETITEM</span><span style="color: #007700">as</span><span style="color: #0000BB">Integer</span><span style="color: #007700">=</span><span style="color: #0000BB">LVM_FIRST</span><span style="color: #007700">+</span><span style="color: #0000BB">5
<br /></span><span style="color: #007700">PublicConst</span><span style="color: #0000BB">LVM_INSERTITEM</span><span style="color: #007700">as</span><span style="color: #0000BB">Integer</span><span style="color: #007700">=</span><span style="color: #0000BB">LVM_FIRST</span><span style="color: #007700">+</span><span style="color: #0000BB">7
<br /></span><span style="color: #007700">PublicConst</span><span style="color: #0000BB">LVM_SCROLL</span><span style="color: #007700">as</span><span style="color: #0000BB">Integer</span><span style="color: #007700">=</span><span style="color: #0000BB">LVM_FIRST</span><span style="color: #007700">+</span><span style="color: #0000BB">20
<br /></span><span style="color: #007700">PublicConst</span><span style="color: #0000BB">LVIF_TEXT</span><span style="color: #007700">as</span><span style="color: #0000BB">Integer</span><span style="color: #007700">=&amp;</span><span style="color: #0000BB">H0001
<br /></span><span style="color: #007700">PublicConst</span><span style="color: #0000BB">LVIS_FOCUSED</span><span style="color: #007700">as</span><span style="color: #0000BB">Integer</span><span style="color: #007700">=&amp;</span><span style="color: #0000BB">H0001
<br /><br /></span><span style="color: #FF8000">//TestfunctionforcallingfromanNSISinstallerusingCLR.dll
<br /></span><span style="color: #007700">PublicFunction</span><span style="color: #0000BB">ChopString</span><span style="color: #007700">(</span><span style="color: #0000BB">_
<br />ByValhwnd</span><span style="color: #007700">as</span><span style="color: #0000BB">IntPtr</span><span style="color: #007700">,</span><span style="color: #0000BB">_
<br />ByValstringToChop</span><span style="color: #007700">as</span><span style="color: #0000BB">String</span><span style="color: #007700">,</span><span style="color: #0000BB">_
<br />ByValchopToLength</span><span style="color: #007700">as</span><span style="color: #0000BB">Integer</span><span style="color: #007700">)As</span><span style="color: #0000BB">String
<br />Dimret</span><span style="color: #007700">as</span><span style="color: #0000BB">String</span><span style="color: #007700">=</span><span style="color: #DD0000">""
<br /></span><span style="color: #007700">If</span><span style="color: #0000BB">stringToChop</span><span style="color: #007700">.</span><span style="color: #0000BB">Length</span><span style="color: #007700">&gt;</span><span style="color: #0000BB">chopToLengthThen
<br />MakeLogEntry</span><span style="color: #007700">(</span><span style="color: #0000BB">hwnd</span><span style="color: #007700">,</span><span style="color: #DD0000">"ChoppingString'"</span><span style="color: #007700">&amp;</span><span style="color: #0000BB">stringToChop</span><span style="color: #007700">&amp;</span><span style="color: #DD0000">"'."</span><span style="color: #007700">)
<br /></span><span style="color: #0000BB">ret</span><span style="color: #007700">=</span><span style="color: #0000BB">stringToChop</span><span style="color: #007700">.</span><span style="color: #0000BB">SubString</span><span style="color: #007700">(</span><span style="color: #0000BB">0</span><span style="color: #007700">,</span><span style="color: #0000BB">chopToLength</span><span style="color: #007700">)
<br /></span><span style="color: #0000BB">MakeLogEntry</span><span style="color: #007700">(</span><span style="color: #0000BB">hwnd</span><span style="color: #007700">,</span><span style="color: #DD0000">"Stringchoppedto'"</span><span style="color: #007700">&amp;</span><span style="color: #0000BB">ret</span><span style="color: #007700">&amp;</span><span style="color: #DD0000">"'."</span><span style="color: #007700">)
<br />Else
<br /></span><span style="color: #0000BB">MakeLogEntry</span><span style="color: #007700">(</span><span style="color: #0000BB">hwnd</span><span style="color: #007700">,</span><span style="color: #DD0000">"String'"</span><span style="color: #007700">&amp;</span><span style="color: #0000BB">_
<br />stringToChop</span><span style="color: #007700">&amp;</span><span style="color: #0000BB">_
<br /></span><span style="color: #DD0000">"'toshorttochoptolength'"</span><span style="color: #007700">&amp;</span><span style="color: #0000BB">_
<br />chopToLength</span><span style="color: #007700">&amp;</span><span style="color: #DD0000">"'."</span><span style="color: #007700">)
<br /></span><span style="color: #0000BB">End</span><span style="color: #007700">If
<br />Return</span><span style="color: #0000BB">ret
<br />End</span><span style="color: #007700">Function
<br /><br /></span><span style="color: #FF8000">//Here'sthekeyfunctionthatwritestotheDetailslist.
<br /></span><span style="color: #007700">Public</span><span style="color: #0000BB">SubMakeLogEntry</span><span style="color: #007700">(</span><span style="color: #0000BB">ByValhwnd</span><span style="color: #007700">As</span><span style="color: #0000BB">IntPtr</span><span style="color: #007700">,</span><span style="color: #0000BB">entry</span><span style="color: #007700">as</span><span style="color: #0000BB">String</span><span style="color: #007700">)
<br />Try
<br /></span><span style="color: #FF8000">//Getcurrentlistcount
<br /></span><span style="color: #0000BB">Dimc</span><span style="color: #007700">as</span><span style="color: #0000BB">Integer</span><span style="color: #007700">=</span><span style="color: #0000BB">SendMessage</span><span style="color: #007700">(</span><span style="color: #0000BB">hwnd</span><span style="color: #007700">,</span><span style="color: #0000BB">LVM_GETITEMCOUNT</span><span style="color: #007700">,</span><span style="color: #0000BB">0</span><span style="color: #007700">,</span><span style="color: #0000BB">0</span><span style="color: #007700">)+</span><span style="color: #0000BB">1
<br /></span><span style="color: #FF8000">//SetupaLVITEMstructurefortheInsertmessage
<br /></span><span style="color: #0000BB">Dimlv</span><span style="color: #007700">AsNew</span><span style="color: #0000BB">LVITEM
<br />lv</span><span style="color: #007700">.</span><span style="color: #0000BB">iItem</span><span style="color: #007700">=</span><span style="color: #0000BB">c
<br />lv</span><span style="color: #007700">.</span><span style="color: #0000BB">pszText</span><span style="color: #007700">=</span><span style="color: #0000BB">entry
<br />lv</span><span style="color: #007700">.</span><span style="color: #0000BB">mask</span><span style="color: #007700">=</span><span style="color: #0000BB">LVIF_TEXT
<br />lv</span><span style="color: #007700">.</span><span style="color: #0000BB">stateMask</span><span style="color: #007700">=</span><span style="color: #0000BB">LVIS_FOCUSED
<br />lv</span><span style="color: #007700">.</span><span style="color: #0000BB">state</span><span style="color: #007700">=</span><span style="color: #0000BB">LVIS_FOCUSED
<br /></span><span style="color: #FF8000">//InserttheLVITEMintothelist
<br /></span><span style="color: #0000BB">c</span><span style="color: #007700">=</span><span style="color: #0000BB">SendMessageLV</span><span style="color: #007700">(</span><span style="color: #0000BB">hwnd</span><span style="color: #007700">,</span><span style="color: #0000BB">LVM_INSERTITEM</span><span style="color: #007700">,</span><span style="color: #0000BB">0</span><span style="color: #007700">,</span><span style="color: #0000BB">lv</span><span style="color: #007700">)
<br /></span><span style="color: #FF8000">//Scrollthelistsotheitemisvisible
<br /></span><span style="color: #0000BB">SendMessage</span><span style="color: #007700">(</span><span style="color: #0000BB">hwnd</span><span style="color: #007700">,</span><span style="color: #0000BB">LVM_SCROLL</span><span style="color: #007700">,</span><span style="color: #0000BB">0</span><span style="color: #007700">,</span><span style="color: #0000BB">12</span><span style="color: #007700">)
<br />Catch</span><span style="color: #0000BB">ex</span><span style="color: #007700">As</span><span style="color: #0000BB">Exception
<br /></span><span style="color: #007700">Do</span><span style="color: #0000BB">Nothing</span><span style="color: #007700">,</span><span style="color: #0000BB">just</span><span style="color: #007700">return
<br /></span><span style="color: #0000BB">End</span><span style="color: #007700">Try
<br /></span><span style="color: #0000BB">EndSub
<br /><br />End</span><span style="color: #007700">Class
<br /><br /></span><span style="color: #0000BB">EndNameSpace
<br /></span>

<!-- php buffer end -->
                
                
                
</pre>
        <hr />
        <pre>
        
NSIS Code with CLR.dll call to test with:<br />        PHP Code:
        
                
</pre>
        <hr />
        <pre>
                <code style="white-space:nowrap">
                
                        <!-- php buffer start --></code><span style="color: #000000">
<span style="color: #0000BB">Name</span><span style="color: #DD0000">"TestCLRDLLMakeLogEntry"
<br /></span><span style="color: #0000BB">OutFile</span><span style="color: #DD0000">"TestCLRDLL.exe"
<br /></span><span style="color: #0000BB">ShowInstDetailsshow
<br /></span><span style="color: #007700">Var</span><span style="color: #0000BB">DetailsHWND
<br />Pageinstfiles
<br /><br />Section
<br />DetailPrint</span><span style="color: #DD0000">"StartingTest"
<br /></span><span style="color: #0000BB">InitPluginsDir
<br />SetOutPath$PLUGINSDIR
<br />File</span><span style="color: #DD0000">"TestCLRDLL.dll"
<br /></span><span style="color: #0000BB">FindWindow</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #DD0000">"#32770"""</span><span style="color: #0000BB">$HWNDPARENT
<br />GetDlgItem$DetailsHWND</span><span style="color: #007700">$</span><span style="color: #0000BB">01016
<br />CLR</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"TestCLRDLL.dll"
<br />"NSIS.TestClass"
<br />"ChopString"
<br /></span><span style="color: #0000BB">3
<br />$DetailsHWND</span><span style="color: #DD0000">"TestingMakeLogEntry"</span><span style="color: #0000BB">9
<br />Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">0
<br />DetailPrint</span><span style="color: #DD0000">"ChopStringResult=$0"
<br /></span><span style="color: #0000BB">DetailPrint</span><span style="color: #DD0000">"TestComplete"
<br /></span><span style="color: #0000BB">SectionEnd
<br /></span>
</span>
<!-- php buffer end -->
                
                
                
</pre>
        <hr />
        <pre>
        
Lastly, I've attached a zip file of the TestCLRDLL.dll project for VS2005 and included the TESTCLRDLL.nsi as will. Enjoy. I hope it's as useful for use as it is for me.
                
</pre>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
        <span class="post-time small text-muted">10th September 2008 20:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Weeeeeee I cannot say how enthusiastic I am that you post this sample. I really need this too. Cool stuff. Thanks so much :)<br />
        <br />
        You should make a nsis wiki sample page with this. Would be very beneficial.</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">rbchasetfb</span><br />
        <span class="post-time small text-muted">10th September 2008 20:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">:) Glad you needed it...thought it would be handy. Will work on the wiki page over the next couple of days.</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
        <span class="post-time small text-muted">11th September 2008 07:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">You can use my old wiki page on the subject. The code in it is not valid anymore, and the explanation on how to make the CLR.dll is outdated and users should look in the source code for the CLR.dll plugin instead. It is located here: http://nsis.sourceforge.net/Calling_Managed_.Net_DLL_From_NSIS<br />
        <br />
        You can just change the author and move the page to another name, that fits with your purpose. If you want I can make the initial posting for you. Or you can make a brand new page if you want to.</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
        <span class="post-time small text-muted">11th September 2008 08:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">If anyone needs to convert that VB.NET code to C#, here is a useful link: http://labs.developerfusion.co.uk/convert/vb-to-csharp.aspx. When converted some minor ajustments needs to be made. I guess I could post the C# version when I get home tonight.<br />
        <br />
        Btw rbchasetfb, I noticed in your sample that you call CLR::Call without /NOUNLOAD. I found that if you attempt to call CLR:Call again after that, the installer hangs. You must specify the /NOUNLOAD each time. Then when done, call CLR:: Destroy, for instance in .onGUIEnd (without the space but smileys are attacking me). For instance:<br />
        PHP Code:</p>
        <hr />
        <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">CLR</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">/</span><span style="color: #0000BB">NOUNLOADparameters</span><span style="color: #007700">...<br /></span> <span style="color: #0000BB">CLR</span><span style="color: #007700">::</span><span style="color: #0000BB">Destroy<br /></span></span> <!-- php buffer end -->
        <hr />
        I will update the plugin wiki with this information.
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">rbchasetfb</span><br />
        <span class="post-time small text-muted">11th September 2008 15:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Thanks, claesabrandt, I'll get that page setup to on the wiki. I've also made the changes to the example. It is the way I'm using CLR.dll, just forgot to put it in the example. I've uploaded the new zip here until I get the wiki page done.</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">rbchasetfb</span><br />
        <span class="post-time small text-muted">12th September 2008 15:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content"><strong>Wiki Page For DetailPrint from Inside .NET DLL</strong><br />
        The wiki page for DetailPrint from Inside .NET DLL is finally up. I've posted some modified source code and some other things of value along with it, including the complete VS2005 project for the TestCLRDLL.<br />
        <br />
        http://nsis.sourceforge.net/DetailPrint_From_Inside_.NET_DLL<br />
        <br />
        claesabrandt, maybe you can put a link to it on your NSIS wiki page as I've posted it to the Code Examples category since it's not really a plugin.<br />
        <br />
        Enjoy.</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
        <span class="post-time small text-muted">13th September 2008 01:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Really nice article. I made a link to it from the plugin page.</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">indimini</span><br />
        <span class="post-time small text-muted">19th September 2008 22:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Clasesabrandt, thanks for putting this plugin together. It's turning into a life saver for me as I migrate from the Installer projects in VS 2008.<br />
        <br />
        I've got my install actions from my VS 2008 installer ported over to use your plugin, but I'm stuck trying to figure out how to run a .NET method during uninstall. It seems like the DLL file used during installation is not available. Any thoughts or suggestions?</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
        <span class="post-time small text-muted">20th September 2008 01:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">If you need to perform some .NET call on uninstallation, I would keep a copy of the dll file in $INSTDIR, then when uninstalling I would copy that dll file to $PLUGINSDIR.</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">rbchasetfb</span><br />
        <span class="post-time small text-muted">24th September 2008 17:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content"><strong>Improved Tokenizer</strong><br />
        claesabrandt,<br />
        <br />
        I found a solution to the need for passing the parameter count. When we talked before, I had implemented a parameter parser that didn't take into account commas in string parameters, well, I found the fix for that. Found a string tokenizer code module that allows you to spec the delimiters, constraining quotes that will cause delimiter to be ignored and a couple other cool options. To use this, replace the following code in NSIS_CLR_Loader.cpp:<br />
        PHP Code:</p>
        <hr />
        <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #FF8000">//numparams<br /></span> <span style="color: #0000BB">popstring</span><span style="color: #007700">(</span><span style="color: #0000BB">buf</span><span style="color: #007700">);<br /></span> <span style="color: #0000BB">intnumparams</span><span style="color: #007700">=</span><span style="color: #0000BB">atoi</span><span style="color: #007700">(</span><span style="color: #0000BB">buf</span><span style="color: #007700">);<br />
        <br /></span> <span style="color: #FF8000">//params<br /></span> <span style="color: #0000BB">vector</span><span style="color: #007700">&lt;</span><span style="color: #0000BB">string</span><span style="color: #007700">&gt;</span><span style="color: #0000BB">args</span><span style="color: #007700">;<br />
        for(</span><span style="color: #0000BB">inti</span><span style="color: #007700">=</span><span style="color: #0000BB">0</span><span style="color: #007700">;</span><span style="color: #0000BB">i</span><span style="color: #007700">&lt;</span><span style="color: #0000BB">numparams</span><span style="color: #007700">;</span><span style="color: #0000BB">i</span><span style="color: #007700">++)<br />
        {<br /></span> <span style="color: #0000BB">popstring</span><span style="color: #007700">(</span><span style="color: #0000BB">buf</span><span style="color: #007700">);<br /></span> <span style="color: #0000BB">stringtmp</span><span style="color: #007700">=</span><span style="color: #0000BB">string</span><span style="color: #007700">(</span><span style="color: #0000BB">buf</span><span style="color: #007700">);<br /></span> <span style="color: #0000BB">args</span><span style="color: #007700">.</span><span style="color: #0000BB">push_back</span><span style="color: #007700">(</span><span style="color: #0000BB">tmp</span><span style="color: #007700">);<br />
        }</span> With the following code:<br /></span>
        <pre>
<span style="color: #FF8000">//params
<br /></span><span style="color: #0000BB">popstring</span><span style="color: #007700">(</span><span style="color: #0000BB">buf</span><span style="color: #007700">);
<br /></span><span style="color: #0000BB">stringsargs</span><span style="color: #007700">=</span><span style="color: #0000BB">string</span><span style="color: #007700">(</span><span style="color: #0000BB">buf</span><span style="color: #007700">);
<br /></span><span style="color: #0000BB">vector</span><span style="color: #007700">&lt;</span><span style="color: #0000BB">string</span><span style="color: #007700">&gt;</span><span style="color: #0000BB">args</span><span style="color: #007700">;
<br /><br /></span><span style="color: #0000BB">tokenize</span><span style="color: #007700">(</span><span style="color: #0000BB">sargs</span><span style="color: #007700">,</span><span style="color: #0000BB">args</span><span style="color: #007700">,</span><span style="color: #DD0000">","</span><span style="color: #007700">,</span><span style="color: #DD0000">""</span><span style="color: #007700">,</span><span style="color: #DD0000">"\\\\'"</span><span style="color: #007700">,</span><span style="color: #DD0000">"\\\");
<br /></span>

<!-- php buffer end -->
                
                
                
</pre>
        <hr />
        <pre>
        
Add the following include directive:<br />        PHP Code:
        
                
</pre>
        <hr />
        <pre>
                <code style="white-space:nowrap">
                
                        <!-- php buffer start --></code><span style="color: #000000">
<span style="color: #FF8000">#include"tokenizer.h"
</span></span>
</pre>Then add the code and header files from the attached zip file.<br />
        <br />
        Lastly, the only catch I found is that when passing file paths, they need to have double backslashes. I'm sure there's a fix in the c++ code somewhere, just haven't found it yet. So I just modified my NSIS macro that calls CLR::Call to do a string replace of single backslashes with double backslashes.<br />
        <br />
        Here's the CodeProject website that I found this tokenizer at.<br />
        <br />
        http://www.codeproject.com/KB/stl/tokenizer.aspx<br />
        <br />
        Enjoy.
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
        <span class="post-time small text-muted">25th September 2008 10:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Very nice code you found there. However I prefer the current method as it keeps the parameter list cleaner and easier to read. Having them inside a single string is harder to read.<br />
        <br />
        What do you think? Is it better to have all parameters in one string, or is it better to have them seperated?<br />
        <br />
        Actually, I could just make an additional function with the tokenizer, so people can choose themselves :) Should I do that?</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">PeanutMocha</span><br />
        <span class="post-time small text-muted">27th October 2008 08:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">I'm trying to use this plugin for the first time and get an error message:<br />
        <br />
        Error calling .NET DLL method<br />
        Number of parameters does not match<br />
        <br />
        I'm trying to call my C# method:<br />
        <br /></p>
        <pre>
<span style="color: #007700">publicstatic</span><span style="color: #0000BB">boolLogTest</span><span style="color: #007700">(</span><span style="color: #0000BB">stringeventSource</span><span style="color: #007700">)
</span>
</pre>with a line of code like this:<br />
        <br />
        <pre>
<code>CLR</code><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">/</span><span style="color: #0000BB">NOUNLOADUtil</span><span style="color: #007700">.</span><span style="color: #0000BB">dllUtilLogTest</span><span style="color: #DD0000">"Sample"
</span>
</pre>and also tried this variant (unsure if I need to specify the number of parameters):<br />
        <br />
        <pre>
<code>CLR</code><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">/</span><span style="color: #0000BB">NOUNLOADUtil</span><span style="color: #007700">.</span><span style="color: #0000BB">dllUtilLogTest</span><span style="color: #DD0000">"Sample"</span><span style="color: #0000BB">1
<br /></span>

<!-- php buffer end -->
                
                
                
</pre>
        <hr />
        <pre>
        
What am I doing wrong?<br /><br />Thanks!
                
</pre>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
        <span class="post-time small text-muted">27th October 2008 08:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">You have to put the 1 before the parameter and it seems you are missing the namespace, should be something like this:<br />
        PHP Code:</p>
        <hr />
        <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">CLR</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">/</span><span style="color: #0000BB">NOUNLOADUtil</span><span style="color: #007700">.</span><span style="color: #0000BB">dllSomeNamespace</span><span style="color: #007700">.</span><span style="color: #0000BB">UtilLogTest1</span><span style="color: #DD0000">"Sample"</span><br />
        <br /></span>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">PeanutMocha</span><br />
        <span class="post-time small text-muted">27th October 2008 16:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Thanks, putting the number of parameters first did the trick :-)<br />
        <br />
        It might be worth updating the Wiki a bit to make the parameter passing scheme clearer. Reading through this thread, there have been a few iterations on how to pass parameters so something in the Wiki like:<br />
        <br />
        CLR::Call /NOUNLOAD MyModule.dll My.Name.Space MyMethod [NumberOfParameters] [Parameter List]<br />
        <br />
        Where [NumberOfParameters] is the integer number of parameters present<br />
        <br />
        [Parameter List] is a list of string, float or integer parameters separated by space. String parameters must be enclosed in quotes.<br />
        <br />
        Would make things a bit clearer to those new to NSIS and this plugin.</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
        <span class="post-time small text-muted">27th October 2008 17:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Did you read the wiki here: http://nsis.sourceforge.net/Call_.NET_DLL_methods_plug-in.</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">SlyW</span><br />
        <span class="post-time small text-muted">28th October 2008 20:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content"><strong>Could not load ...\CLR.dll</strong><br />
        I am running into a situation where I am unable to load the CLR.dll on 3 out of 5 machines. I have checked the .Net Framework versions and have concluded that although there are some discrepancies, at least two of the failing machines match the Framework version of one of the machine which does work.<br />
        <br />
        Is there an enhanced logging mechanism I can invoke to obtain more information relating to the inability to load the library?<br />
        <br />
        When it works, I am in love with plugin. Thank you VERY much!<br />
        <br />
        - SlyW<br />
        <br />
        P.S. If you want my .nsi and .Net DLL, please ask.</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
        <span class="post-time small text-muted">28th October 2008 20:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Hi SlyW. From your .NET dll, are you calling further into other .NET dlls?</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">SlyW</span><br />
        <span class="post-time small text-muted">28th October 2008 21:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content"><strong>None of my writing...</strong><br />
        It is calling the System.Cryptography classes, but no other .NET DLLs of my creation.<br />
        <br />
        I have attached complete source code to this message including the source of my encryption library.<br />
        <br />
        Thanks!<br />
        <br />
        -SlyW</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
        <span class="post-time small text-muted">28th October 2008 22:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">SlyW, I am looking into it, but at the moment I am a bit clueless about it, as it sounds like NSIS can't load the plugin. I guess you don't have problems with other plugins on those machines? I am thinking of if you could try installing the Visual C++ 2005 redist on those machines. That should not be needed, but maybe you have found a scenario where it is needed. It is the CLR.dll it cannot find, right? Not your crypto dll.</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">SlyW</span><br />
        <span class="post-time small text-muted">29th October 2008 05:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content"><strong>I will try...</strong><br />
        I will install the VC++ redist on one of the machines upon which the installer fails and let you know the progress. I would have done it already had I not been required to attend parent-teacher conferences.<br />
        <br />
        Thanks for your excellent responses so far!</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">SlyW</span><br />
        <span class="post-time small text-muted">29th October 2008 18:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">No luck. Installed the VC++ 2005 Redist on one of the XP machines with the same results. Could not load CLR.dll and the value popped was the name of the encryption DLL.</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
        <span class="post-time small text-muted">30th October 2008 12:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Thanks for the testing. This sounds like a problem rbchasetfb encountered back in the beginning of september. Back then we fixed it by making sure the DLL was compiled using Visual Studio 2005 and not 2008, as it seems it fixed it then. But I will have to look further into why NSIS fails to load the DLL in some cases. My first tasks is to reproduce the error myself. I might ask additional questions of you, to reproduce your scenario.</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">SlyW</span><br />
        <span class="post-time small text-muted">30th October 2008 14:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Ask away! And I will see if I can get VS.NET C++ installed locally. I might try installing VS.NET C++ on one of the machines where it fails and see if it helps. I know that VS.NET is installed on all three failing machines, however, only the VB.NET and Web Developer components are installed.<br />
        <br />
        If there are debug flags you want me to use, please do not hesitate to ask.</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">teiles</span><br />
        <span class="post-time small text-muted">30th October 2008 22:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">My CLR.exe based DLL works on some machines and not others.<br />
        <br />
        What I know:<br />
        <br />
        Win XP SP2 w/.NET 2/3/3.5 works<br />
        Vista SP1 w/.NET 2/3/3.5 works<br />
        Win 2003 w/.NET 2/3/3.5 works<br />
        Win 2003 w/.NET 2 DOES NOT WORK</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">rbchasetfb</span><br />
        <span class="post-time small text-muted">31st October 2008 14:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">I'll add some other successful test environments:<br />
        <br />
        Win 2003 w/SP1 or SP2 and a minimum of .NET 2.0 SP1<br />
        Win XP SP2 with a minimum of .NET 2.0 SP1<br />
        <br />
        The catch is the SP1 version of .NET 2.0. The CLR plugin on DotNET 2.0 without SP1 will not work on any of these environments. The reason your .NET 2/3/3.5 works is the .NET 3 and 3.5 installers install the .NET 2.0 SP1 patches. claesabrandt, that's why the VS2005 compiled CLR only works on this .NET 2.0 SP1 setup...because you have installed .NET 3 and/3.5.<br />
        <br />
        To overcome this, I've added a prerequisites custom page to my installers, right after my license page, that checks for and downloads, installs/upgrades .NET 2.0 SP1 before any calls to the CLR plugin. I use the CLR plugin in custom pages after the components selection page. If this sequence doesn't work for you, you can put a .NET check-download-and-install into the .onInit. A recommended .onInit would do some conformance checks anyway, so here's a good order:<br />
        <br />
        1. Check if installer is already running, if so abort<br />
        2. Check for local admin rights, if not, abort<br />
        3. Check for and Install IIS (if installing a web site on IIS)<br />
        4. Check for and Install .NET 2.0 SP1<br />
        <br />
        It took me some time to figure this one out - and lots of VirtualMachine undo drive wipes - so I hope this saves you all some time.</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
        <span class="post-time small text-muted">31st October 2008 15:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">rbchasetfb, very very good. SlyW, could you please try installing .NET 2.0 SP1 on the machines that fail?</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">teiles</span><br />
        <span class="post-time small text-muted">31st October 2008 16:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">I just installed the .NET 2.0 SP1 on the Win 2003 .NET 2.0 that was failing.<br />
        <br />
        CLR.exe now WORKS!!!<br />
        <br />
        Thanks --- Ted</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
        <span class="post-time small text-muted">31st October 2008 18:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Great! Thanks for the excellent testing SlyW and teiles. rbchasetfb, you are my hero again :) I have updated the wiki with the SP1 prerequisite. I assume that this is the solution to the problem. Let me know if not.</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">SlyW</span><br />
        <span class="post-time small text-muted">1st November 2008 20:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">I will install SP1 on one or more of the failing machines and let you know the success/failure of each.<br />
        <br />
        Thank you _all_ for making this a useful forum and an even more useful plugin!</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
        <span class="post-time small text-muted">6th November 2008 07:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Now that we are at the issues. I have encountered an annoying thing and have a workaround for it. If you call a second custom .NET DLL from your first custom .NET DLL, you will run into an issue about the .NET framework cannot find the second DLL, even if you have placed both DLLs in the $PLUGINSDIR. Your second DLL is referenced in your first DLLs Visual Studio project.<br />
        <br />
        The reason the second DLL cannot be found is that .NET looks for the DLL in the same directory as the calling process, which in this is case is the installer exe. You can make .NET look in a subdirectory of the calling process, but here comes the issue. Your installer will run from some location, and then it unpacks everything into a temp directory. From that directory it loads the first DLL by loading it into memory and then using reflection to scan the methods and properties, so the process does not have to look for the DLL. The second DLL is not loaded this way as it is referenced from the first DLL's project. Here I rely on that the .NET framework can find it, and as it was not unpacked in the installer's directory or subdirectory, I have not found a way to make .NET find it.<br />
        <br />
        My workaround has been to make a second NSIS script that wraps my installer script and wraps the .NET DLLs needed in my installer script. These are unpacked to the temp directory together and when the second script is executed using Exec, the second installer will be the executing process and thus it can find the DLLs. When the second installer finishes, I delete the files again.<br />
        <br />
        Although this works, it would be nice to have a "real" solution, where the .NET framework can actually find the second DLL. I have tried all kinds of things, googled for it etc. I have not yet found a solution to make .NET look for a DLL in another directory other than where the calling process is run from or subdirectories of that. If anyone have ideas, let's see if we can find a better solution.<br />
        <br />
        A note: One should not unpack the DLLs in the same directory as the installer, as the installer might be run from a CD-Rom or other readonly media.<br />
        <br />
        A second note: One could use reflection, like how the first DLL is loaded, to load the second DLL. But this as two drawbacks: 1) Using reflection, there will be a weak binding between your DLLs and you will not have code completion in your project when trying to call things in the second DLL. 2) You would have to use reflection again if trying to call a third or fourth DLL.<br />
        <br />
        Regards Claes</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">SlyW</span><br />
        <span class="post-time small text-muted">10th November 2008 03:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Success! I have successfully run the sample installer on a machine _after_ installing SP1. Now, to make SP1 a pre-req for installing our app.<br />
        <br />
        Thanks again for all your help (to everyone)!<br />
        <br />
        BTW: Do we dare ask what SP1 brings to the table that suddenly enables this functionality?</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">SlyW</span><br />
        <span class="post-time small text-muted">17th November 2008 16:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content"><strong>Found additional error messages</strong><br />
        I just happened to be perusing the Event Viewer on a machine where the CLR.dll failed to load and discovered the following three entries:<br />
        <br />
        Dependent Assembly Microsoft.VC80.CRT could not be found and Last Error was The referenced assembly is not installed on your system.<br />
        <br />
        Resolve Partial Assembly failed for Microsoft.VC80.CRT. Reference error message: The referenced assembly is not installed on your system.<br />
        <br />
        Generate Activation Context failed for C:\DOCUME~1\USERSL~1\LOCALS~1\Temp\nsy57D.tmp\CLR.dll. Reference error message: The operation completed successfully.<br />
        <br />
        So, apparently SP1 somehow brings Microsoft.VB80.CRT into the fold?</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">AuGuS666</span><br />
        <span class="post-time small text-muted">28th March 2009 06:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content"><strong>Class Property</strong><br />
        Hi and thx for watching this:<br />
        <br />
        Calling the method "SayHi" from my c# dll works fine, but the set_MyProperty method to setting the public property "name" dont work for me, here is my simple C# class:<br /></p>
        <pre>
<code>usingSystem</code><span style="color: #007700">;
<br /></span><span style="color: #0000BB">usingSystem</span><span style="color: #007700">.</span><span style="color: #0000BB">Collections</span><span style="color: #007700">.</span><span style="color: #0000BB">Generic</span><span style="color: #007700">;
<br /></span><span style="color: #0000BB">usingSystem</span><span style="color: #007700">.</span><span style="color: #0000BB">Text</span><span style="color: #007700">;
<br /><br /></span><span style="color: #0000BB">namespaceDllTest</span><span style="color: #007700">{
<br /><br />publicclass</span><span style="color: #0000BB">greeting</span><span style="color: #007700">{
<br /><br />private</span><span style="color: #0000BB">stringm_strname</span><span style="color: #007700">;
<br /><br />public</span><span style="color: #0000BB">greeting</span><span style="color: #007700">(){
<br />}
<br /><br />public</span><span style="color: #0000BB">stringSayHi</span><span style="color: #007700">(){
<br />return</span><span style="color: #DD0000">"hi"</span><span style="color: #007700">+</span><span style="color: #0000BB">name</span><span style="color: #007700">;
<br /><br />}
<br /><br />public</span><span style="color: #0000BB">stringname</span><span style="color: #007700">{
<br /></span><span style="color: #0000BB">get</span><span style="color: #007700">{return</span><span style="color: #0000BB">m_strname</span><span style="color: #007700">;}
<br /></span><span style="color: #0000BB">set</span><span style="color: #007700">{</span><span style="color: #0000BB">m_strname</span><span style="color: #007700">=</span><span style="color: #0000BB">value</span><span style="color: #007700">;}
<br />}
<br />}
<br />}
</span>
</pre>And this is my nsis source:<br />
        <br />
        PHP Code:
        <hr />
        <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">Section<br />
        SetOutPath$PLUGINSDIR<br />
        File</span><span style="color: #DD0000">"DllTest.dll"<br /></span> <span style="color: #0000BB">CLR</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">/</span><span style="color: #0000BB">NOUNLOADDllTest</span><span style="color: #007700">.</span><span style="color: #0000BB">dllDllTest</span><span style="color: #007700">.</span><span style="color: #0000BB">greetingset_name1</span><span style="color: #DD0000">"augus666"<br /></span> <span style="color: #0000BB">CLR</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">/</span><span style="color: #0000BB">NOUNLOADDllTest</span><span style="color: #007700">.</span><span style="color: #0000BB">dllDllTest</span><span style="color: #007700">.</span><span style="color: #0000BB">greetingSayHi0<br />
        pop</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
        detailprint</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
        CLR</span><span style="color: #007700">::</span><span style="color: #0000BB">Destroy<br />
        <br />
        SectionEnd<br /></span></span> <!-- php buffer end -->
        <hr />
        I did compilated my DllTest.dll on DEBUG, RELEASE, with Framework 2 SP1, i did try with VS Net 2005 and VS Net 2008 classes, Windows Xp SP3 Pc's and nothing yet (btw the get_ method works).<br />
        <br />
        Thx for replays ;)
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
        <span class="post-time small text-muted">28th March 2009 07:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">What error do you experience?</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">AuGuS666</span><br />
        <span class="post-time small text-muted">28th March 2009 16:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content"><strong>Re: Class Property</strong><br />
        I cant change the value of the property with the _setMyProperty method</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
        <span class="post-time small text-muted">24th June 2009 09:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content">Sry for the delay. I have to look into this. I suspect it could have something to do with the internal variable not keeping the value between the calls. I am not sure how NSIS manages the memory when using NOUNLOAD on the calls. I thought the variables would keep their values. However, for now you must keep values in the NSIS script and pass them to the methods when needed.</p>
      </div>
      <hr />
      <!-- Bootstrap core CSS -->
      <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
      <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

      <div class="container">
        <!-- Put navigation bar here -->

        <ol class="breadcrumb">
          <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

          <li><a href="f-65.html">NSIS Discussion</a></li>

          <li class="active">Calling managed .NET DLL from NSIS - this works :-)</li>
        </ol>

        <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=295881">Calling managed .NET DLL from NSIS - this works :-)</a></p><br />

        <div class="post">
          <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
          <span class="post-time small text-muted">24th June 2009 09:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

          <p class="post-content">SlyW: Sorry for the delay. I honestly don't know why .NET Framework SP1 makes things work, but your findings sound resonable.</p>
        </div>
        <hr />

        <div class="post">
          <p class="post-meta"><span class="post-author text-primary">dmccoy</span><br />
          <span class="post-time small text-muted">18th August 2009 17:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

          <p class="post-content"><strong>Dependency Assemblies</strong><br />
          This may be old news, but I believe I have found a fix for the dependent assemblies problem using the AssemblyResolve event. I hope it will be of use to you.<br />
          <br />
          My managed C++ skills are not the greatest, but please find attached my modified source file.<br />
          <br />
          Thank you for creating the CLR NSIS plug in. It has proven very valuable - we use it often.<br />
          <br />
          Best Regards,<br />
          <br />
          David</p>
        </div>
        <hr />

        <div class="post">
          <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
          <span class="post-time small text-muted">19th August 2009 07:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

          <p class="post-content"><strong>Re: Dependency Assemblies</strong><br />
          David, that looks interesting! That is really something I want to fix in the plugin. I will take a look at your code. I don't think this is old news, at least not for me, because I still had no solution to it. If I understand it right, will it then be possible to place the dependant assemblies anywhere and not necessarily in the same folder hierachy as the calling exe/dll?</p>
        </div>
        <hr />

        <div class="post">
          <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
          <span class="post-time small text-muted">19th August 2009 09:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

          <p class="post-content">What are the requirements for building this plug-in? Can I build it using VC6?</p>
        </div>
        <hr />

        <div class="post">
          <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
          <span class="post-time small text-muted">19th August 2009 09:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

          <p class="post-content">No. It has to be at least Visual Studio 2005 as .NET 2.0 must be supported.</p>
        </div>
        <hr />

        <div class="post">
          <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
          <span class="post-time small text-muted">19th August 2009 10:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

          <p class="post-content">Too bad... Will just have to wait for the day I finally switch to 2008 I guess. But keep 'em coming. It's a useful plug-in.</p>
        </div>
        <hr />

        <div class="post">
          <p class="post-meta"><span class="post-author text-primary">claesabrandt</span><br />
          <span class="post-time small text-muted">19th August 2009 10:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

          <p class="post-content">The free express editions of VS works too, and can be installed alongside with VC6. Anyway, I will most likely implement Davids modification in the CLR.dll, so the dependant assembly problem will be solved for everyone, without having to recompile the source.</p>
        </div>
        <hr />

        <div class="post">
          <p class="post-meta"><span class="post-author text-primary">dmccoy</span><br />
          <span class="post-time small text-muted">19th August 2009 16:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

          <p class="post-content">Hi Claes,<br />
          <br />
          The default assembly resolution mechanism should be called first, so assemblies registered in the GAC should still work. However, if the default assembly resolution fails it will attempt to load the assembly from the directory containing the assembly that was explicitly executed using CallCLR. I suppose it could be modified without a great deal of effort to accept a Java-like class path of directories to search for dependency assemblies.<br />
          <br />
          Again, thank you for creating this plug in. We used it to replace a very clunky XML-driven solution that we used to use for performing install tasks from .NET DLLs.<br />
          <br />
          Best Regards,<br />
          <br />
          David</p>
        </div>
        <hr />

        <div class="post">
          <p class="post-meta"><span class="post-author text-primary">timc_</span><br />
          <span class="post-time small text-muted">17th June 2010 08:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

          <p class="post-content">I notice it has been quite some time since talk of changing the way dependent assemblies are located. Is this no longer likely to happen?<br />
          <br />
          Also, is there any particular reason why the plugin requires the assembly being called to have a .dll extension? I tried making calls to an exe (eg. foo.exe) and received a message indicating that the file (eg. foo.exe.dll) could not be found.</p>
        </div>
        <hr />

        <div class="post">
          <p class="post-meta"><span class="post-author text-primary">jayfox911</span><br />
          <span class="post-time small text-muted">27th September 2010 18:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

          <p class="post-content">Has anyone tested with Windows 7? I am trying to recompile my NSIS installer that was built on XP but now it will not work on Windows 7.<br />
          I have .NET 2.0 SP1 framework installed and download the newest CLR.zip form<br />
          <a href="http://nsis.sourceforge.net/Call_.NET_DLL_methods_plug-in" target="_blank">http://nsis.sourceforge.net/Call_.NE...ethods_plug-in</a><br />
          <br />
          nsi file<br />
          PHP Code:</p>
          <hr />
          <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">OutFile</span><span style="color: #DD0000">"setup.exe"<br /></span> <span style="color: #0000BB">Section<br />
          <br />
          InitPluginsDir<br />
          SetOutPath$PLUGINSDIR<br />
          <br />
          File</span><span style="color: #DD0000">"AccessClass.dll"<br /></span> <span style="color: #0000BB">FileCLR</span><span style="color: #007700">.</span><span style="color: #0000BB">dll<br />
          CLR</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">/</span><span style="color: #0000BB">NOUNLOADAccessClass</span><span style="color: #007700">.</span><span style="color: #0000BB">dllAccessClass</span><span style="color: #007700">.</span><span style="color: #0000BB">AccessremoveData1</span><span style="color: #DD0000">"dataTable"<br />
          <br /></span> <span style="color: #0000BB">pop</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
          MessageBoxMB_OK</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
          CLR</span><span style="color: #007700">::</span><span style="color: #0000BB">Destroy<br />
          <br />
          SectionEnd<br /></span></span> <!-- php buffer end -->
          <hr />
          From the MakeNSISW<br />
          PHP Code:
          <hr />
          <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">InitPluginsDir<br />
          SetOutPath</span><span style="color: #007700">:</span><span style="color: #DD0000">"$PLUGINSDIR"<br /></span> <span style="color: #0000BB">File</span><span style="color: #007700">:</span><span style="color: #DD0000">"AccessClass.dll"</span><span style="color: #007700">***91;</span><span style="color: #0000BB">compress</span><span style="color: #007700">***93;</span><span style="color: #0000BB">4493</span><span style="color: #007700">/</span><span style="color: #0000BB">24576bytes<br />
          File</span><span style="color: #007700">:</span><span style="color: #DD0000">"CLR.dll"</span><span style="color: #007700">***91;</span><span style="color: #0000BB">compress</span><span style="color: #007700">***93;</span><span style="color: #0000BB">31773</span><span style="color: #007700">/</span><span style="color: #0000BB">95744bytes<br />
          Invalidcommand</span><span style="color: #007700">:</span><span style="color: #0000BB">CLR</span><span style="color: #007700">::</span><span style="color: #0000BB">Call<br />
          Errorinscript</span><span style="color: #DD0000">"C:\testscript.nsi"</span><span style="color: #0000BB">online9</span><span style="color: #007700">--</span><span style="color: #0000BB">abortingcreationprocess<br /></span></span> <!-- php buffer end -->
          <hr />
        </div>
        <hr />

        <div class="post">
          <p class="post-meta"><span class="post-author text-primary">jayfox911</span><br />
          <span class="post-time small text-muted">27th September 2010 23:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

          <p class="post-content"></p>

          <blockquote>
            <small>Originally posted by rbchasetfb</small><br />
            claesabrandt, very cool that we got through that one. Thanks for sticking with it too. As a thanks, I thought I would post some code that I use in my .NET dll that CLR.dll is calling. It allows the functions in the .NET dll to update the Details list during the install without have to wait to return to the installer and then do a DetailPrint call with some funky string work. The code is in VB.NET, but could easily be converted to C#. The error handling is a little brute force in the MakeLogEntry function, it just ignores the error and returns, potentially writing nothing to the Details list. Non-the-less, very useful I think.<br />
            <br />
            VB.NET Code Required:<br />
            PHP Code:
            <hr />
            <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">ImportsSystem<br />
            ImportsSystem</span><span style="color: #007700">.</span><span style="color: #0000BB">Runtime</span><span style="color: #007700">.</span><span style="color: #0000BB">InteropServices<br />
            ImportsSystem</span><span style="color: #007700">.</span><span style="color: #0000BB">Threading<br />
            ImportsSystem</span><span style="color: #007700">.</span><span style="color: #0000BB">IO<br />
            ImportsSystem</span><span style="color: #007700">.</span><span style="color: #0000BB">Windows</span><span style="color: #007700">.</span><span style="color: #0000BB">Forms<br />
            <br />
            NamespaceNSIS<br />
            <br /></span> <span style="color: #007700">PublicClass</span><span style="color: #0000BB">TestClass<br />
            <br /></span> <span style="color: #FF8000">//LVITEMStructureDeclaration.<br /></span> <span style="color: #007700">&lt;</span><span style="color: #0000BB">StructLayout</span><span style="color: #007700">(</span><span style="color: #0000BB">LayoutKind</span><span style="color: #007700">.</span><span style="color: #0000BB">Sequential</span><span style="color: #007700">)&gt;</span><span style="color: #0000BB">_<br /></span> <span style="color: #007700">Public</span><span style="color: #0000BB">StructureLVITEM<br /></span> <span style="color: #007700">Public</span><span style="color: #0000BB">mask</span><span style="color: #007700">As</span><span style="color: #0000BB">Int32<br /></span> <span style="color: #007700">Public</span><span style="color: #0000BB">iItem</span><span style="color: #007700">As</span><span style="color: #0000BB">Int32<br /></span> <span style="color: #007700">Public</span><span style="color: #0000BB">iSubItem</span><span style="color: #007700">As</span><span style="color: #0000BB">Int32<br /></span> <span style="color: #007700">Public</span><span style="color: #0000BB">state</span><span style="color: #007700">As</span><span style="color: #0000BB">Int32<br /></span> <span style="color: #007700">Public</span><span style="color: #0000BB">stateMask</span><span style="color: #007700">As</span><span style="color: #0000BB">Int32<br /></span> <span style="color: #007700">Public</span><span style="color: #0000BB">pszText</span><span style="color: #007700">As</span><span style="color: #0000BB">String<br /></span> <span style="color: #007700">Public</span><span style="color: #0000BB">cchTextMax</span><span style="color: #007700">As</span><span style="color: #0000BB">Int32<br /></span> <span style="color: #007700">Public</span><span style="color: #0000BB">iImage</span><span style="color: #007700">As</span><span style="color: #0000BB">Int32<br /></span> <span style="color: #007700">Public</span><span style="color: #0000BB">lParam</span><span style="color: #007700">As</span><span style="color: #0000BB">IntPtr<br />
            EndStructure<br />
            <br /></span> <span style="color: #FF8000">//SendMessageAPIdeclarations.<br /></span> <span style="color: #007700">PublicDeclareFunction</span><span style="color: #0000BB">SendMessageLVLib</span><span style="color: #DD0000">"user32"</span><span style="color: #0000BB">Alias_<br /></span> <span style="color: #DD0000">"SendMessageA"</span><span style="color: #007700">(</span><span style="color: #0000BB">ByValhwnd</span><span style="color: #007700">As</span><span style="color: #0000BB">IntPtr</span><span style="color: #007700">,</span><span style="color: #0000BB">_<br />
            ByValwMsg</span><span style="color: #007700">As</span><span style="color: #0000BB">Int32</span><span style="color: #007700">,</span><span style="color: #0000BB">_<br />
            ByValwParam</span><span style="color: #007700">As</span><span style="color: #0000BB">Integer</span><span style="color: #007700">,</span><span style="color: #0000BB">_<br />
            ByReflParam</span><span style="color: #007700">As</span><span style="color: #0000BB">LVITEM</span><span style="color: #007700">)As</span><span style="color: #0000BB">Integer<br /></span> <span style="color: #007700">PublicDeclareFunction</span><span style="color: #0000BB">SendMessageLib</span><span style="color: #DD0000">"user32"</span><span style="color: #0000BB">Alias_<br /></span> <span style="color: #DD0000">"SendMessageA"</span><span style="color: #007700">(</span><span style="color: #0000BB">ByValhwnd</span><span style="color: #007700">As</span><span style="color: #0000BB">IntPtr</span><span style="color: #007700">,</span><span style="color: #0000BB">_<br />
            ByValwMsg</span><span style="color: #007700">As</span><span style="color: #0000BB">Int32</span><span style="color: #007700">,</span><span style="color: #0000BB">_<br />
            ByValwParam</span><span style="color: #007700">As</span><span style="color: #0000BB">Integer</span><span style="color: #007700">,</span><span style="color: #0000BB">_<br />
            ByReflParam</span><span style="color: #007700">As</span><span style="color: #0000BB">Integer</span><span style="color: #007700">)As</span><span style="color: #0000BB">Integer<br />
            <br /></span> <span style="color: #FF8000">//ConstantsusedbyLVITEMandSendMessage<br /></span> <span style="color: #007700">PublicConst</span><span style="color: #0000BB">LVM_FIRST</span><span style="color: #007700">as</span><span style="color: #0000BB">Integer</span><span style="color: #007700">=&amp;</span><span style="color: #0000BB">H1000<br /></span> <span style="color: #007700">PublicConst</span><span style="color: #0000BB">LVM_GETITEMCOUNT</span><span style="color: #007700">as</span><span style="color: #0000BB">Integer</span><span style="color: #007700">=</span><span style="color: #0000BB">LVM_FIRST</span><span style="color: #007700">+</span><span style="color: #0000BB">4<br /></span> <span style="color: #007700">PublicConst</span><span style="color: #0000BB">LVM_GETITEM</span><span style="color: #007700">as</span><span style="color: #0000BB">Integer</span><span style="color: #007700">=</span><span style="color: #0000BB">LVM_FIRST</span><span style="color: #007700">+</span><span style="color: #0000BB">5<br /></span> <span style="color: #007700">PublicConst</span><span style="color: #0000BB">LVM_INSERTITEM</span><span style="color: #007700">as</span><span style="color: #0000BB">Integer</span><span style="color: #007700">=</span><span style="color: #0000BB">LVM_FIRST</span><span style="color: #007700">+</span><span style="color: #0000BB">7<br /></span> <span style="color: #007700">PublicConst</span><span style="color: #0000BB">LVM_SCROLL</span><span style="color: #007700">as</span><span style="color: #0000BB">Integer</span><span style="color: #007700">=</span><span style="color: #0000BB">LVM_FIRST</span><span style="color: #007700">+</span><span style="color: #0000BB">20<br /></span> <span style="color: #007700">PublicConst</span><span style="color: #0000BB">LVIF_TEXT</span><span style="color: #007700">as</span><span style="color: #0000BB">Integer</span><span style="color: #007700">=&amp;</span><span style="color: #0000BB">H0001<br /></span> <span style="color: #007700">PublicConst</span><span style="color: #0000BB">LVIS_FOCUSED</span><span style="color: #007700">as</span><span style="color: #0000BB">Integer</span><span style="color: #007700">=&amp;</span><span style="color: #0000BB">H0001<br />
            <br /></span> <span style="color: #FF8000">//TestfunctionforcallingfromanNSISinstallerusingCLR.dll<br /></span> <span style="color: #007700">PublicFunction</span><span style="color: #0000BB">ChopString</span><span style="color: #007700">(</span><span style="color: #0000BB">_<br />
            ByValhwnd</span><span style="color: #007700">as</span><span style="color: #0000BB">IntPtr</span><span style="color: #007700">,</span><span style="color: #0000BB">_<br />
            ByValstringToChop</span><span style="color: #007700">as</span><span style="color: #0000BB">String</span><span style="color: #007700">,</span><span style="color: #0000BB">_<br />
            ByValchopToLength</span><span style="color: #007700">as</span><span style="color: #0000BB">Integer</span><span style="color: #007700">)As</span><span style="color: #0000BB">String<br />
            Dimret</span><span style="color: #007700">as</span><span style="color: #0000BB">String</span><span style="color: #007700">=</span><span style="color: #DD0000">""<br /></span> <span style="color: #007700">If</span><span style="color: #0000BB">stringToChop</span><span style="color: #007700">.</span><span style="color: #0000BB">Length</span><span style="color: #007700">&gt;</span><span style="color: #0000BB">chopToLengthThen<br />
            MakeLogEntry</span><span style="color: #007700">(</span><span style="color: #0000BB">hwnd</span><span style="color: #007700">,</span><span style="color: #DD0000">"ChoppingString'"</span><span style="color: #007700">&amp;</span><span style="color: #0000BB">stringToChop</span><span style="color: #007700">&amp;</span><span style="color: #DD0000">"'."</span><span style="color: #007700">)<br /></span> <span style="color: #0000BB">ret</span><span style="color: #007700">=</span><span style="color: #0000BB">stringToChop</span><span style="color: #007700">.</span><span style="color: #0000BB">SubString</span><span style="color: #007700">(</span><span style="color: #0000BB">0</span><span style="color: #007700">,</span><span style="color: #0000BB">chopToLength</span><span style="color: #007700">)<br /></span> <span style="color: #0000BB">MakeLogEntry</span><span style="color: #007700">(</span><span style="color: #0000BB">hwnd</span><span style="color: #007700">,</span><span style="color: #DD0000">"Stringchoppedto'"</span><span style="color: #007700">&amp;</span><span style="color: #0000BB">ret</span><span style="color: #007700">&amp;</span><span style="color: #DD0000">"'."</span><span style="color: #007700">)<br />
            Else<br /></span> <span style="color: #0000BB">MakeLogEntry</span><span style="color: #007700">(</span><span style="color: #0000BB">hwnd</span><span style="color: #007700">,</span><span style="color: #DD0000">"String'"</span><span style="color: #007700">&amp;</span><span style="color: #0000BB">_<br />
            stringToChop</span><span style="color: #007700">&amp;</span><span style="color: #0000BB">_<br /></span> <span style="color: #DD0000">"'toshorttochoptolength'"</span><span style="color: #007700">&amp;</span><span style="color: #0000BB">_<br />
            chopToLength</span><span style="color: #007700">&amp;</span><span style="color: #DD0000">"'."</span><span style="color: #007700">)<br /></span> <span style="color: #0000BB">End</span><span style="color: #007700">If<br />
            Return</span><span style="color: #0000BB">ret<br />
            End</span><span style="color: #007700">Function<br />
            <br /></span> <span style="color: #FF8000">//Here'sthekeyfunctionthatwritestotheDetailslist.<br /></span> <span style="color: #007700">Public</span><span style="color: #0000BB">SubMakeLogEntry</span><span style="color: #007700">(</span><span style="color: #0000BB">ByValhwnd</span><span style="color: #007700">As</span><span style="color: #0000BB">IntPtr</span><span style="color: #007700">,</span><span style="color: #0000BB">entry</span><span style="color: #007700">as</span><span style="color: #0000BB">String</span><span style="color: #007700">)<br />
            Try<br /></span> <span style="color: #FF8000">//Getcurrentlistcount<br /></span> <span style="color: #0000BB">Dimc</span><span style="color: #007700">as</span><span style="color: #0000BB">Integer</span><span style="color: #007700">=</span><span style="color: #0000BB">SendMessage</span><span style="color: #007700">(</span><span style="color: #0000BB">hwnd</span><span style="color: #007700">,</span><span style="color: #0000BB">LVM_GETITEMCOUNT</span><span style="color: #007700">,</span><span style="color: #0000BB">0</span><span style="color: #007700">,</span><span style="color: #0000BB">0</span><span style="color: #007700">)+</span><span style="color: #0000BB">1<br /></span> <span style="color: #FF8000">//SetupaLVITEMstructurefortheInsertmessage<br /></span> <span style="color: #0000BB">Dimlv</span><span style="color: #007700">AsNew</span><span style="color: #0000BB">LVITEM<br />
            lv</span><span style="color: #007700">.</span><span style="color: #0000BB">iItem</span><span style="color: #007700">=</span><span style="color: #0000BB">c<br />
            lv</span><span style="color: #007700">.</span><span style="color: #0000BB">pszText</span><span style="color: #007700">=</span><span style="color: #0000BB">entry<br />
            lv</span><span style="color: #007700">.</span><span style="color: #0000BB">mask</span><span style="color: #007700">=</span><span style="color: #0000BB">LVIF_TEXT<br />
            lv</span><span style="color: #007700">.</span><span style="color: #0000BB">stateMask</span><span style="color: #007700">=</span><span style="color: #0000BB">LVIS_FOCUSED<br />
            lv</span><span style="color: #007700">.</span><span style="color: #0000BB">state</span><span style="color: #007700">=</span><span style="color: #0000BB">LVIS_FOCUSED<br /></span> <span style="color: #FF8000">//InserttheLVITEMintothelist<br /></span> <span style="color: #0000BB">c</span><span style="color: #007700">=</span><span style="color: #0000BB">SendMessageLV</span><span style="color: #007700">(</span><span style="color: #0000BB">hwnd</span><span style="color: #007700">,</span><span style="color: #0000BB">LVM_INSERTITEM</span><span style="color: #007700">,</span><span style="color: #0000BB">0</span><span style="color: #007700">,</span><span style="color: #0000BB">lv</span><span style="color: #007700">)<br /></span> <span style="color: #FF8000">//Scrollthelistsotheitemisvisible<br /></span> <span style="color: #0000BB">SendMessage</span><span style="color: #007700">(</span><span style="color: #0000BB">hwnd</span><span style="color: #007700">,</span><span style="color: #0000BB">LVM_SCROLL</span><span style="color: #007700">,</span><span style="color: #0000BB">0</span><span style="color: #007700">,</span><span style="color: #0000BB">12</span><span style="color: #007700">)<br />
            Catch</span><span style="color: #0000BB">ex</span><span style="color: #007700">As</span><span style="color: #0000BB">Exception<br /></span> <span style="color: #007700">Do</span><span style="color: #0000BB">Nothing</span><span style="color: #007700">,</span><span style="color: #0000BB">just</span><span style="color: #007700">return<br /></span> <span style="color: #0000BB">End</span><span style="color: #007700">Try<br /></span> <span style="color: #0000BB">EndSub<br />
            <br />
            End</span><span style="color: #007700">Class<br />
            <br /></span> <span style="color: #0000BB">EndNameSpace<br /></span></span> <!-- php buffer end -->
            <hr />
            NSIS Code with CLR.dll call to test with:<br />
            PHP Code:
            <hr />
            <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">Name</span><span style="color: #DD0000">"TestCLRDLLMakeLogEntry"<br /></span> <span style="color: #0000BB">OutFile</span><span style="color: #DD0000">"TestCLRDLL.exe"<br /></span> <span style="color: #0000BB">ShowInstDetailsshow<br /></span> <span style="color: #007700">Var</span><span style="color: #0000BB">DetailsHWND<br />
            Pageinstfiles<br />
            <br />
            Section<br />
            DetailPrint</span><span style="color: #DD0000">"StartingTest"<br /></span> <span style="color: #0000BB">InitPluginsDir<br />
            SetOutPath$PLUGINSDIR<br />
            File</span><span style="color: #DD0000">"TestCLRDLL.dll"<br /></span> <span style="color: #0000BB">FindWindow</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #DD0000">"#32770"""</span><span style="color: #0000BB">$HWNDPARENT<br />
            GetDlgItem$DetailsHWND</span><span style="color: #007700">$</span><span style="color: #0000BB">01016<br />
            CLR</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"TestCLRDLL.dll"<br />
            "NSIS.TestClass"<br />
            "ChopString"<br /></span> <span style="color: #0000BB">3<br />
            $DetailsHWND</span><span style="color: #DD0000">"TestingMakeLogEntry"</span><span style="color: #0000BB">9<br />
            Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
            DetailPrint</span><span style="color: #DD0000">"ChopStringResult=$0"<br /></span> <span style="color: #0000BB">DetailPrint</span><span style="color: #DD0000">"TestComplete"<br /></span> <span style="color: #0000BB">SectionEnd<br /></span></span> <!-- php buffer end -->
            <hr />
            Lastly, I've attached a zip file of the TestCLRDLL.dll project for VS2005 and included the TESTCLRDLL.nsi as will. Enjoy. I hope it's as useful for use as it is for me.
          </blockquote>This example will not work for me also. Any ideas?
        </div>
        <hr />

        <div class="post">
          <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
          <span class="post-time small text-muted">28th September 2010 20:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

          <p class="post-content">Firstly you don't need to extract plug-in DLL's to use them. NSIS handles that itself. Also, if NSIS says a plug-in call is an invalid command then that means your plug-in DLL isn't in the NSIS Plugins folder.<br />
          <br />
          Stu</p>
        </div>
        <hr />

        <div class="post">
          <p class="post-meta"><span class="post-author text-primary">jayfox911</span><br />
          <span class="post-time small text-muted">28th September 2010 21:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

          <p class="post-content"></p>

          <blockquote>
            <small>Originally posted by Afrow UK</small><br />
            Firstly you don't need to extract plug-in DLL's to use them. NSIS handles that itself. Also, if NSIS says a plug-in call is an invalid command then that means your plug-in DLL isn't in the NSIS Plugins folder.<br />
            <br />
            Stu
          </blockquote>Thank you that worked.<br />
          I put the CLR.dll in the \Program Files\NSIS\Plugins\ folder. Just like the second sentence of the CLR wiki says to do. Next time I will RTFM
        </div>
        <hr />

        <div class="post">
          <p class="post-meta"><span class="post-author text-primary">taralex</span><br />
          <span class="post-time small text-muted">10th November 2010 20:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

          <p class="post-content"><strong>Unicode support</strong><br />
          I got stuck for a couple of days when trying to move my installation to a Unicode-based NSIS. All my calls just stopped working. After a vain search for a similar dll, but supporting unicode, I downloaded the original source and upgraded it.<br />
          Now this was my first ever experience with c++, so I'm really not sure if I just didn't screw something up, but it worked in a couple of tests I did. I posted the link to the updated code on the Viki page.<br />
          <br />
          I moved all the more or less complex functionality to a .net dll now, because all other means of calling dlls (like System::Call) stopped working in the Unicode release of NSIS.</p>
        </div>
        <hr />

        <div class="post">
          <p class="post-meta"><span class="post-author text-primary">langdon</span><br />
          <span class="post-time small text-muted">19th September 2011 18:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

          <p class="post-content">Is anyone capable of recompiling this to add 4.0 support? It'll execute 4.0 assemblies, but will fail if you use any 3.5+ features (like simple Linq statements).</p>
        </div>
        <hr />

        <div class="post">
          <p class="post-meta"><span class="post-author text-primary">mfiedlerwd</span><br />
          <span class="post-time small text-muted">17th August 2012 12:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

          <p class="post-content">Hi Claes,<br />
          <br />
          I have already problems on setting/getting Properties.<br />
          <br /></p>

          <blockquote>
            namespace test<br />
            {<br />
            public class test<br />
            {<br />
            <br />
            // Properties<br />
            private string _Name = "";<br />
            <br />
            public string Name<br />
            {<br />
            get { return _Name; }<br />
            set { _Name = value; }<br />
            }<br />
            <br />
            <br />
            public string helloworld()<br />
            {<br />
            return "Hello " + Name;<br />
            }<br />
            }<br />
            }
          </blockquote>I first call the set_name Property, then the helloworld method. But allways the Propety is empty on the second call.<br />
          <br />
          It seems that on every call will generated a new object instance of the dll.<br />
          <br />
          Did you already hav fixed this problem? Or have a solution?<br />
          <br />
          Best Regards,<br />
          Michael
        </div>
        <hr />

        <div class="post">
          <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
          <span class="post-time small text-muted">17th August 2012 18:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

          <p class="post-content">To avoid incompatibility issues which can occur with different .NET versions I would put your .NET code into a command-line executable and run it using ExecDos.<br />
          <br />
          Stu</p>
        </div>
        <hr />

        <div class="post">
          <p class="post-meta"><span class="post-author text-primary">mfiedlerwd</span><br />
          <span class="post-time small text-muted">20th August 2012 08:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

          <p class="post-content">Hi Stu, thanks for the suggestion.<br />
          <br />
          Well, when i do a simple call it works fine with an exe or the dll as well.<br />
          <br />
          But when i need to do multiple calls, i think i will have a problem with an exe. (ex. i have to do some database related work and in OLEDB-PLUGIN script files are limited to 60k, so i wrote a .net dll )<br />
          <br />
          Best regards<br />
          <br />
          Michael</p>
        </div>
        <hr />

        <div class="footer">
          <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
        </div>
      </div><script src="../js/highlight.pack.js" type="text/javascript">
</script> <script type="text/javascript">
//<![CDATA[
      hljs.initHighlightingOnLoad();
      //]]>
      </script>
    </div>
  </div>
</body>
</html>
