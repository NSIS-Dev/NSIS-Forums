<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Binary read"><title>Binary read - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Binary read</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=204832">Binary read</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">superruzafa</span><br><span class="post-time small text-muted">13th January 2005 20:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Binary read</strong><br>Hi,<br><br>I must modify some parts of a 153 Mb binary file. The only function I've found that performs this is FileReadByte and FileWriteByte but are toooooooooo slow.<br><br>Is there any way to read/write strings of non-character bytes using FileRead/FileWrite? Or I must making an external program who performs that?<br><br>Thanks</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">13th January 2005 20:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">If you want to patch a binary file, why not use VPatch?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">superruzafa</span><br><span class="post-time small text-muted">13th January 2005 20:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Could you write the link?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">13th January 2005 21:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">It's in your Contrib folder.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">superruzafa</span><br><span class="post-time small text-muted">13th January 2005 21:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Sorry, I'm a total newbie and I don't know where that folder is. I'll search other posts ;)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">13th January 2005 21:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Where you installed NSIS, there's a folder named Contrib. Inside that folder, there's a folder named VPatch. Normally, that should be:<br><br>C:\Program Files\NSIS\Contrib\VPatch</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">13th January 2005 21:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Have a good look around your NSIS directory. It's always a good idea to know what's available to you :)<br><br>-Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Takhir</span><br><span class="post-time small text-muted">14th January 2005 11:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I had to write my own binary read script for license page. It was empty installer with all files located in CVS folders including installer itself and license file, and like Joost wrote long ago we can use WM_SETTEXT for txt files. The only problem I found - System plug-in can not allocate variable size memory (&amp;t$1), but calloc() can ;) Sample script attached.<br>Might be good to allow users to skip License file name for such situations in MUI page definition, 0 parameters may create warning only, in this script I had to use additional short "dummy.txt" file (not committed to our CVS, this may create problems with later installer rebuilds :( ).</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">14th January 2005 11:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The System.dll plug-in should have no problem allocating variable size memory blocks. The problem you've encountered is probably NSIS's string size limit (1024 by default). If you read using FileRead and then append using a call to lstrcat, it should be OK.<br><br>BTW, it's not a good idea to allocate using calloc and free using System::Free. They use two different allocation methods. In the worst case, it can cause a crash. Usually, it should just create a memory leak.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Takhir</span><br><span class="post-time small text-muted">14th January 2005 12:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks, KichiK!<br>Might be something was wrong in my syntax, this not worked with System::Call allocation, but looks OK now with Alloc and Free.<br>BTW I used<br>System::Alloc '$1 .r0'<br>syntax in the updated file, and this works fine, but System.htm uses<br>System::Alloc 64<br>Pop $0<br>Is my variant correct?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">14th January 2005 12:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Your variant is incorrect. Take a look at Contrib\System\Source\Buffers.c. Alloc is right on the top.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Takhir</span><br><span class="post-time small text-muted">14th January 2005 12:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">OK, I'll better use my favourite msvcrt calls ;)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">superruzafa</span><br><span class="post-time small text-muted">14th January 2005 14:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I've found very interesting all you have talk.<br><br>Where can I find more info about system calls and the parameters for that functions?<br><br>BTW, I made an patch.exe file which does the patching logic and I call externally.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">14th January 2005 14:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You can find information about the System plug-in in its readme. You can find the readme, the source code and some examples in &lt;nsis folder&gt;\Contrib\System.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">superruzafa</span><br><span class="post-time small text-muted">14th January 2005 16:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Take a look of that code. I have a binary file "prueba.bin" who is 1024 bytes and I try to copy into another file, but nothing happens.<br><br>Need more code? (includes, defines) or simplily the params are wrong?<br><br></p><pre>
<code><br>System::Call 'msvcrt.dll::calloc(i 1024, i 1) i .r0' ; creates a 1024 size buffer<br><br>System::Call 'msvcrt.dll::_open(t "$INSTDIR\prueba.bin,  i 0x8000) i .r1' ; open first file<br>System::Call 'msvcrt.dll::_open(t "$INSTDIR\prueba2.bin, i 0x8101) i .r2' ; open second file<br>System::Call 'msvcrt.dll::_read(i r1, i r0, 1024) i .r3' ;read the first file<br>System::Call 'msvcrt.dll::_write(i r2, i r0, 1024) i .r3' ;and writes to the second<br><br>System::Call 'msvcrt.dll::_close(i r1)' ; close file 1<br>System::Call 'msvcrt.dll::_close(i r2)' ; close file 2<br></code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">14th January 2005 16:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You're missing closing quotes for the file names in both _open calls.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">superruzafa</span><br>
      <span class="post-time small text-muted">14th January 2005 16:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by kichik</i><br>
        <b>You're missing closing quotes for the file names in both _open calls.</b>
      </blockquote>:eek: Ups. Now file is created but nothing is readed nor writed. I'll continue investigating about that :cool:
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">14th January 2005 16:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">It might be because you're missing an `i` before 1024 in the _read and _write lines.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">superruzafa</span><br>
      <span class="post-time small text-muted">14th January 2005 16:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I got it! :D<br>
      <br>
      It failed type for 1024. Well, hope this will serve for others.<br>
      <br></p>
      <pre>
<code><br>System::Call 'msvcrt.dll::_read(i r1, i r0, /* this -&gt; */ i 1024) i .r3'<br>System::Call 'msvcrt.dll::_write(i r2, i r0, /* and this -&gt; */ i 1024) i .r3'<br></code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">superruzafa</span><br>
      <span class="post-time small text-muted">14th January 2005 16:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">It seems we are writing at time, ;)<br>
      <br>
      Thanks for all, guys</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Takhir</span><br>
      <span class="post-time small text-muted">15th January 2005 10:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">And<br>
      System::Call 'msvcrt.dll::free(i ro)'<br>
      at the end of code :)</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">superruzafa</span><br>
      <span class="post-time small text-muted">15th January 2005 11:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I've used System::Alloc and System::Free for that.<br>
      <br>
      Is a good idea to allocate memory with those functions and then use the memory allocated with msvcrt.dll call functions?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Takhir</span><br>
      <span class="post-time small text-muted">15th January 2005 11:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">This is not a problem I guess, both allocs should work with this code 100%. But System::Alloc + Pop take 2 lines of script :( - this is the only reason why I used direct msvcrt calls.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">superruzafa</span><br>
      <span class="post-time small text-muted">17th January 2005 13:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What if msvcrt.dll isn't installed? Must I include in the installer? And then, extract and installing?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Takhir</span><br>
      <span class="post-time small text-muted">17th January 2005 13:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Don't worry about msvcrt.dll ;)<br>
      Only msvcrtd.dll (debug version) may not present.</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>