<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="problem with icons, CreateShortcut on 64-bit Windows and &quot;C:\Program Files (x86)&quot;" />

  <title>problem with icons, CreateShortcut on 64-bit Windows and "C:\Program Files (x86)" - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">problem with icons, CreateShortcut on 64-bit Windows and "C:\Program Files (x86)"</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=327806">problem with icons, CreateShortcut on 64-bit Windows and "C:\Program Files (x86)"</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">o___O</span><br />
      <span class="post-time small text-muted">24th February 2011 23:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>problem with icons, CreateShortcut on 64-bit Windows and "C:\Program Files (x86)"</strong><br />
      I've creating an NSIS package and noticed that when a program is installed to the legacy 32-bit folder on 64-bit Windows 7 Ultimate SP1, that "C:\Program Files (x86)" is being translated either by NSIS or Windows to the environmental variable "%ProgramFiles%" which resolves to the 64-bit version of Program Files. Where I'm running into a problem is with CreateShortcut and the custom icon setting. Here's my code for starters:<br />
      <br /></p>

      <blockquote>
        CreateShortcut "$SMPROGRAMS\${APP_NAME}\${APP_NAME}.lnk" "$INSTDIR\online.exe" "" "$INSTDIR\online.exe" "" "" "" "Launches PSOBB"<br />
        CreateShortcut "$SMPROGRAMS\${APP_NAME}\Visit schtserv.com.lnk" "http://www.schtserv.com/" "" "$INSTDIR\online.exe" "" "" "" "Visit the SCHTHACK website"<br />
        CreateShortcut "$SMPROGRAMS\${APP_NAME}\Register a game account.lnk" "http://www.schtserv.com/bbregister.php" "" "$INSTDIR\online.exe" "" "" "" "You need an account to play PSOBB"<br />
        CreateShortcut "$SMPROGRAMS\${APP_NAME}\Community forums and support.lnk" "http://schtserv.com/forum/" "" "$INSTDIR\online.exe" "" "" "" "Join the community"<br />
        CreateShortcut "$SMPROGRAMS\${APP_NAME}\Readme.txt.lnk" "$INSTDIR\readme.txt" "" "" 0 "" "" "o_o"
      </blockquote>Now if I install the program anywhere inside "C:\Program Files (x86)" and inspect the shortcuts above (right-click-&gt;Properties), and choose "Change Icon" it will prompt an error that says "Windows cannot find the file %ProgramFiles%\&lt;installfolder&gt;\online.exe." I did a test and found that if I placed a copy of online.exe in the 64-bit Program Files folder that the shortcut icon was found by Windows Explorer, and I did another test and found that the field was properly filled in if any folder other than C:\Program Files (x86) (such as C:\newtest) was used. What I think is NSIS has some type of code that is converting Program Files path by default to the environmental variable %ProgramFiles%. This might work on 32-bit Windows, but 64-bit Windows uses different folders for 32-bit and 64-bit and this causes the icon path at least for CreateShortcut to be resolved improperly in Windows Explorer (64-bit version).<br />
      <br />
      What I also found is that in some cases the icon on the shortcuts will default back to the missing shortcut icon and you have to reset the icon manually on the shortcut for it to work again, which is how I discovered this problem. It does this every time after a reboot on the first shortcut in the code, the other ones are a bit different (URLs/Internet shortcuts) that don't seem to reset as often (so far). I'm still trying to fix this problem but thought I'd report about my findings, it's obviously a bug that needs fixing somewhere.<br />
      <br />
      NSIS 2.46...
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Zinthose</span><br />
      <span class="post-time small text-muted">24th February 2011 23:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">:eek: <i><font color="silver"><font size="1">Removed public display of stupid...</font></font></i></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">o___O</span><br />
      <span class="post-time small text-muted">24th February 2011 23:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">These are shortcuts being installed to the Start Menu Programs folder, ala internal NSIS Constant $SMPROGRAMS. I also found that it makes no difference what InstallDir is, the user can change directories to C:\Program Files (x86) during the installation, or manually select C:\Program Files (x86) and it will convert the shortcut icon path to %ProgramFiles%. As I said I believe NSIS detects "C:\Program Files (x86)" in $INSTDIR and converts it to %ProgramFiles%... unless it is some internal calls of Windows doing it (which NSIS executes), which is definitely possible.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">o___O</span><br />
      <span class="post-time small text-muted">25th February 2011 00:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Edit, scratch part of what I said before.<br />
      <br />
      This was my InstallDir:<br />
      <br />
      InstallDir "$PROGRAMFILES32\${APP_NAME}"<br />
      <br />
      I changed it to<br />
      <br />
      InstallDir "C:\PSOBB-installer\${APP_NAME}"<br />
      <br />
      Rebuild...<br />
      <br />
      <br />
      Actually, I'll just post my entire script for you to test with some test files. I think the behavior I described with %ProgramFiles% variable only occurs if $PROGRAMFILES is initially used in InstallDir, this doesn't happen after changing InstallDir like I did above, and then manually select "C:\Program Files (x86)" as the installation location.<br />
      <br />
      Here's my script &amp; test files to make it work if you wanna take a look and try it: <a href="http://strags.com/d2/nsis.zip" target="_blank">http://strags.com/d2/nsis.zip</a></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Zinthose</span><br />
      <span class="post-time small text-muted">25th February 2011 00:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><a href="http://en.wikipedia.org/wiki/Kodama_%28spirit%29" target="_blank">Kodama,</a><br /></p>
      <pre>
<span style="color: #007700">!</span><span style="color: #0000BB">defineAPP_NAME</span><span style="color: #DD0000">"MyApp"
<br /></span><span style="color: #0000BB">OutFilelnkTest</span><span style="color: #007700">.</span><span style="color: #0000BB">exe
<br /><br />InstallDir</span><span style="color: #DD0000">"$PROGRAMFILES\${APP_NAME}"
<br /><br /></span><span style="color: #0000BB">Section
<br />SetOutPath$INSTDIR
<br />File</span><span style="color: #007700">/</span><span style="color: #0000BB">oname</span><span style="color: #007700">=</span><span style="color: #0000BB">online</span><span style="color: #007700">.</span><span style="color: #0000BB">exe</span><span style="color: #DD0000">"C:\WINDOWS\NOTEPAD.EXE"
<br /><br /></span><span style="color: #0000BB">CreateDirectory</span><span style="color: #DD0000">"$SMPROGRAMS\${APP_NAME}"
<br /></span><span style="color: #0000BB">CreateShortcut</span><span style="color: #DD0000">"$SMPROGRAMS\${APP_NAME}\${APP_NAME}.lnk""$INSTDIR\online.exe""""$INSTDIR\online.exe""""""""LaunchesPSOBB"
<br /></span><span style="color: #0000BB">SectionEnd
<br /></span>

<!-- php buffer end -->
                
                
                
</pre>
      <hr />
      <pre>
        
I ran this on my Windows XP x64 system and it works fine.
                
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">o___O</span><br />
      <span class="post-time small text-muted">25th February 2011 00:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Did you check the Change Icon function to determine if the path was set correctly? Didn't work on Win7Ult x64.. BUT the icon does show up properly, at least right after install. Problem I have run into, is that it might default back to the broken shortcut icon after awhile, which shows up on the next screen.<br />
      <br />
      <a href="http://strags.com/i/myapp.png" target="_blank">http://strags.com/i/myapp.png</a><br />
      <a href="http://strags.com/i/myapp.png" target="_blank">http://strags.com/i/myapp.png</a><br />
      <br />
      <a href="http://strags.com/i/myapp2.png" target="_blank">http://strags.com/i/myapp2.png</a><br />
      <a href="http://strags.com/i/myapp2.png" target="_blank">http://strags.com/i/myapp2.png</a></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">o___O</span><br />
      <span class="post-time small text-muted">25th February 2011 00:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If I go and put a copy of online.exe (for your example) in C:\Program Files\My App, it will find it without changing the shortcut. It won't work ever without being manually updated if it's in C:\Program Files (x86) under these exact circumstances. I used the same code as you...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Zinthose</span><br />
      <span class="post-time small text-muted">25th February 2011 01:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">AH! not I see the problem... I'm going to perform some tests to see what can be done about this.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">o___O</span><br />
      <span class="post-time small text-muted">25th February 2011 01:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Let me know what you find...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">25th February 2011 09:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">NSIS does not touch your strings, blame the windows shortcut API. At least for you main apps shortcut, try not setting the icon directly and just use "" as the icon path<br />
      <br />
      Edit: Another option would be to remove the SLDF_HAS_EXP_ICON_SZ flag and datablock after the shortcut has been created:<br />
      PHP Code:</p>
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">CreateShortcut</span><span style="color: #DD0000">"$temp\test.lnk""c:\windows\system32\calc.exe""""c:\windows\explorer.exe"</span><span style="color: #0000BB">1<br />
      <br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'OLE32::CoCreateInstance(g"{00021401-0000-0000-c000-000000000046}",i0,i1,g"{000214ee-0000-0000-c000-000000000046}",*i.r1)i'<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">1</span><span style="color: #007700">&lt;&gt;</span><span style="color: #0000BB">0<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'$1-&gt;0(g"{0000010b-0000-0000-C000-000000000046}",*i.r2)'<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">2</span><span style="color: #007700">&lt;&gt;</span><span style="color: #0000BB">0<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'$2-&gt;5(w"$temp\test.lnk",i2)i.r0'<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">0</span><span style="color: #007700">=</span><span style="color: #0000BB">0<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'$1-&gt;0(g"{45e2b4ae-b1c3-11d0-b92f-00a0c90312e1}",*i.r3)i.r0'<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">3</span><span style="color: #007700">&lt;&gt;</span><span style="color: #0000BB">0<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'$3-&gt;5(i0xA0000007)i.r0'<br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'$3-&gt;6(*i.r4)i.r0'<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">0</span><span style="color: #007700">=</span><span style="color: #0000BB">0<br />
      IntOp</span><span style="color: #007700">$</span><span style="color: #0000BB">4</span><span style="color: #007700">$</span><span style="color: #0000BB">4</span><span style="color: #007700">&amp;</span><span style="color: #0000BB">0xffffBFFF<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'$3-&gt;7(ir4)i.r0'<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">0</span><span style="color: #007700">=</span><span style="color: #0000BB">0<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'$2-&gt;6(i0,i0)'<br /></span> <span style="color: #007700">${EndIf}<br />
      ${EndIf}<br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">$</span><span style="color: #0000BB">3</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">2</span><span style="color: #007700">()<br />
      ${EndIf}<br />
      ${EndIf}<br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">$</span><span style="color: #0000BB">2</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">2</span><span style="color: #007700">()<br />
      ${EndIf}<br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">2</span><span style="color: #007700">()<br />
      ${EndIf}</span> After I do this, (on XP) the change shortcut icon dialog displays c:\windows\explorer.exe and not %SystemRoot%\explorer.exe<br />
      <br /></span>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Zinthose</span><br />
      <span class="post-time small text-muted">25th February 2011 16:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">As usual... Awesome work Anders :up:<br />
      I Wrapped your code up into a function/macro for easy implementation so I can add it to my own packages. I have been packaging for 64bit XP for some time but never noticed the issue. Worse yet no one has complained yet. :eek:<br /></p>
      <pre>
<span style="color: #FF8000">/******************************************************************************
<br />WORKAROUND-FixShortcut
<br />ThissnippetwasdevelopedtoaddressanissuewithWindows
<br />x64incorectlyredirectingtheshortcutsiconfrom$PROGRAMFILES32
<br />to$PROGRAMFILES64.
<br /><br />SeeForumpost:http://forums.winamp.com/newreply.php?do=postreply&amp;t=327806
<br /><br />Example:
<br />CreateShortcut"$SMPROGRAMS\MyApp\MyApp.lnk""$INSTDIR\MyApp.exe""""$INSTDIR\MyApp.exe"
<br />${lnkX64IconFix}"$SMPROGRAMS\MyApp\MyApp.lnk"
<br /><br />OriginalCodebyAnders-http://forums.winamp.com/member.php?u=70852
<br />******************************************************************************/
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">ifndef___lnkX64IconFix___
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">verbosepush
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">verbose0
<br /><br /></span><span style="color: #007700">!include</span><span style="color: #DD0000">"LogicLib.nsh"
<br /></span><span style="color: #007700">!include</span><span style="color: #DD0000">"x64.nsh"
<br /><br /></span><span style="color: #007700">!</span><span style="color: #0000BB">define___lnkX64IconFix___
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">definelnkX64IconFix</span><span style="color: #007700">`</span><span style="color: #0000BB">!insertmacro_lnkX64IconFix</span><span style="color: #007700">`
<br />!</span><span style="color: #0000BB">macro_lnkX64IconFix_lnkPath
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">verbosepush
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">verbose0
<br /></span><span style="color: #007700">${If}${</span><span style="color: #0000BB">RunningX64</span><span style="color: #007700">}
<br /></span><span style="color: #0000BB">DetailPrint</span><span style="color: #DD0000">"WORKAROUND:64bitOSDetected,AttemptingtoapplylnkX64IconFix"
<br /></span><span style="color: #0000BB">Push</span><span style="color: #DD0000">"${_lnkPath}"
<br /></span><span style="color: #0000BB">CalllnkX64IconFix
<br /></span><span style="color: #007700">${EndIf}
<br />!</span><span style="color: #0000BB">verbosepop
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">macroend
<br /><br /></span><span style="color: #007700">Function</span><span style="color: #0000BB">lnkX64IconFix</span><span style="color: #007700">;</span><span style="color: #0000BB">_lnkPath
<br />Exch</span><span style="color: #007700">$</span><span style="color: #0000BB">5
<br />Push</span><span style="color: #007700">$</span><span style="color: #0000BB">0
<br />Push</span><span style="color: #007700">$</span><span style="color: #0000BB">1
<br />Push</span><span style="color: #007700">$</span><span style="color: #0000BB">2
<br />Push</span><span style="color: #007700">$</span><span style="color: #0000BB">3
<br />Push</span><span style="color: #007700">$</span><span style="color: #0000BB">4
<br />System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'OLE32::CoCreateInstance(g"{00021401-0000-0000-c000-000000000046}",i0,i1,g"{000214ee-0000-0000-c000-000000000046}",*i.r1)i'
<br /></span><span style="color: #007700">${If}$</span><span style="color: #0000BB">1</span><span style="color: #007700">&lt;&gt;</span><span style="color: #0000BB">0
<br />System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'$1-&gt;0(g"{0000010b-0000-0000-C000-000000000046}",*i.r2)'
<br /></span><span style="color: #007700">${If}$</span><span style="color: #0000BB">2</span><span style="color: #007700">&lt;&gt;</span><span style="color: #0000BB">0
<br />System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'$2-&gt;5(wr5,i2)i.r0'
<br /></span><span style="color: #007700">${If}$</span><span style="color: #0000BB">0</span><span style="color: #007700">=</span><span style="color: #0000BB">0
<br />System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'$1-&gt;0(g"{45e2b4ae-b1c3-11d0-b92f-00a0c90312e1}",*i.r3)i.r0'
<br /></span><span style="color: #007700">${If}$</span><span style="color: #0000BB">3</span><span style="color: #007700">&lt;&gt;</span><span style="color: #0000BB">0
<br />System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'$3-&gt;5(i0xA0000007)i.r0'
<br /></span><span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'$3-&gt;6(*i.r4)i.r0'
<br /></span><span style="color: #007700">${If}$</span><span style="color: #0000BB">0</span><span style="color: #007700">=</span><span style="color: #0000BB">0
<br />IntOp</span><span style="color: #007700">$</span><span style="color: #0000BB">4</span><span style="color: #007700">$</span><span style="color: #0000BB">4</span><span style="color: #007700">&amp;</span><span style="color: #0000BB">0xffffBFFF
<br />System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'$3-&gt;7(ir4)i.r0'
<br /></span><span style="color: #007700">${If}$</span><span style="color: #0000BB">0</span><span style="color: #007700">=</span><span style="color: #0000BB">0
<br />System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'$2-&gt;6(i0,i0)'
<br /></span><span style="color: #0000BB">DetailPrint</span><span style="color: #DD0000">"WORKAROUND:lnkX64IconFixAppliedsuccessfully"
<br /></span><span style="color: #007700">${EndIf}
<br />${EndIf}
<br /></span><span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">$</span><span style="color: #0000BB">3</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">2</span><span style="color: #007700">()
<br />${EndIf}
<br />${EndIf}
<br /></span><span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">$</span><span style="color: #0000BB">2</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">2</span><span style="color: #007700">()
<br />${EndIf}
<br /></span><span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">2</span><span style="color: #007700">()
<br />${EndIf}
<br /></span><span style="color: #0000BB">Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">4
<br />Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">3
<br />Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">2
<br />Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1
<br />Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">0
<br />FunctionEnd
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">verbosepop
<br /></span><span style="color: #007700">!endif
</span>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Zinthose</span><br />
      <span class="post-time small text-muted">25th February 2011 19:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">FYI: <a href="http://nsis.sourceforge.net/WORKAROUND:_Winx64_Shortcut_Icon_Bug" target="_blank">Wiki Article Created</a></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">25th February 2011 20:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That URL in the comment is broken. You should probably point to: <a href="http://forums.winamp.com/showthread.php?t=327806" target="_blank">http://forums.winamp.com/showthread.php?t=327806</a></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">o___O</span><br />
      <span class="post-time small text-muted">25th February 2011 20:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by Anders</small><br />
        NSIS does not touch your strings, blame the windows shortcut API. At least for you main apps shortcut, try not setting the icon directly and just use "" as the icon path<br />
        <br />
        Edit: Another option would be to remove the SLDF_HAS_EXP_ICON_SZ flag and datablock after the shortcut has been created:<br />
        <br />
        After I do this, (on XP) the change shortcut icon dialog displays c:\windows\explorer.exe and not %SystemRoot%\explorer.exe
      </blockquote>Neither of these are suitable alternatives, though. The shortcuts I want to specify the icon on are Internet links, the default icon is just ugly and doesn't go with the program. Secondly, NSIS must be involved in this process somehow, because if InstallDir is set to "C:\${APP_NAME}" by default rather than "$PROGRAMFILES32\${APP_NAME}" - one can manually select the "C:\Program Files (x86)" folder during installation and not have this problem (shortcut icon path is correct, icons never vanish). I think the problem has to do with how NSIS is resolving $PROGRAMFILES or handling these Constants and the environmental variables internally (might be specific to InstallDir directive or when or how these variables are used)... Give it another look.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">25th February 2011 21:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><a href="http://nsis.sourceforge.net/CreateInternetShortcut_macro_%26_function" target="_blank">http://nsis.sourceforge.net/CreateIn...o_%26_function</a><br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Zinthose</span><br />
      <span class="post-time small text-muted">25th February 2011 21:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Internet shortcuts are even easier to tweak as they are just ini files.<br /></p>
      <pre>
<code>[InternetShortcut]<br />URL=http://download.microsoft.com/download/8/8/8/888f34b7-4f54-4f06-8dac-fa29b19f33dd/msxml3.msi<br />IDList=<br />IconFile=C:\WINDOWS\system32\accwiz.exe<br />HotKey=0<br />IconIndex=5<br />[{000214A0-0000-0000-C000-000000000046}]<br />Prop3=19,2</code>
</pre>Do somthing like this.. PHP Code:
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">WriteINIStr</span><span style="color: #DD0000">"$SMPROGRAMS\${APP_NAME}\MyWebSite.url""InternetShortcut""IconFile""$INSTDIR\online.exe"<br /></span> <span style="color: #0000BB">WriteINIStr</span><span style="color: #DD0000">"$SMPROGRAMS\${APP_NAME}\MyWebSite.url""InternetShortcut""IconIndex"</span><span style="color: #0000BB">5<br /></span></span> <!-- php buffer end -->
      <hr />
      ...and it "Should" fix it.<br />
      <br />
      <br />
      <b><u><font size="3"><i>EDIT: Or just read the Wiki article Stu Posted.. :D</i></font></u></b>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">25th February 2011 22:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by o___O</small><br />
        I think the problem has to do with how NSIS is resolving $PROGRAMFILES or handling these Constants and the environmental variables internally (might be specific to InstallDir directive or when or how these variables are used)... Give it another look.
      </blockquote>InstallDir does not do anything special, $PROGRAMFILES is resolved using a documented shell function and nsis itself does not use environment variables IIRC.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">o___O</span><br />
      <span class="post-time small text-muted">2nd March 2011 10:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I found more information out about this issue. From the manual:<br />
      <br /></p>

      <blockquote>
        4.8.1.21 InstallDir<br />
        definstdir<br />
        Sets the default installation directory. See the variables section for variables that can be used to make this string (especially $PROGRAMFILES). Note that the part of this string following the last \ will be used if the user selects 'browse', and may be appended back on to the string at install time (to disable this, end the directory with a \ (which will require the entire parameter to be enclosed with quotes). If this doesn't make any sense, play around with the browse button a bit.
      </blockquote>So the problem is with this behavior in NSIS when InstallDir doesn't end with a \. Disable this feature and the icons and shortcuts are fine.<br />
      <br />
      So..<br />
      <br />
      InstallDir "$PROGRAMFILES32\SCHTHACK PSOBB" has the problem.<br />
      InstallDir "$PROGRAMFILES32\SCHTHACK PSOBB\" (disables behavior) doesn't have the problem.<br />
      <br />
      It seems to be something going wrong in this feature when it enumerates and appends "SCHTHACK PSOBB" to the directory selection. For example, a user will choose "C:\Program Files (x86)" as the directory rather than a sub directory, and NSIS will fill in the sub directory to match the last string of InstallDir after the last \, in this case "SCHTHACK PSOBB," making it auto to C:\Program Files (x86)\SCHTHACK PSOBB\. For some reason this breaks CreateShortcut icon association and perhaps other functions in NSIS. What it looks like is Windows is looking in the 64-bit Program Files directory for the icon when this function is enabled, even though the program is really in the 32-bit Program Files folder, which I think is the result of this features functionality mixing up the 64-bit and 32-bit Program Files folders or how it resolves them.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">2nd March 2011 13:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by o___O</small><br />
        making it auto to C:\Program Files (x86)\SCHTHACK PSOBB\.
      </blockquote>Are you sure about this? $instdir will normally strip off the \ at the end.<br />
      <br />
      Try:<br />
      PHP Code:
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">strcpy$instdir</span><span style="color: #DD0000">"c:\temp\"<br />
      MessageBoxmb_ok$instdir<br /></span></span> <!-- php buffer end -->
      <hr />
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Zinthose</span><br />
      <span class="post-time small text-muted">2nd March 2011 14:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I'm going to have to confirm with Anders.<br />
      <br />
      I modified the test script and the issue remains.<br />
      Can you provide a script that shows the working vs non?<br />
      PHP Code:</p>
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #007700">!</span><span style="color: #0000BB">defineAPP_NAME</span><span style="color: #DD0000">"MyApp"<br /></span> <span style="color: #0000BB">OutFilelnkTest</span><span style="color: #007700">.</span><span style="color: #0000BB">exe<br />
      ShowInstDetailsshow<br />
      <br />
      InstallDir</span><span style="color: #DD0000">"$PROGRAMFILES32\${APP_NAME}\"<br />
      <br />
      Pagedirectory<br />
      Pageinstfiles<br />
      <br />
      Section<br />
      SetOutPath"</span><span style="color: #0000BB">$INSTDIR</span><span style="color: #DD0000">"<br />
      File/oname=online.exe"</span><span style="color: #0000BB">C</span><span style="color: #007700">:</span><span style="color: #0000BB">WINDOWSNOTEPAD</span><span style="color: #007700">.</span><span style="color: #0000BB">EXE</span><span style="color: #DD0000">"<br />
      <br />
      CreateDirectory"</span><span style="color: #0000BB">$SMPROGRAMS</span><span style="color: #007700">${</span><span style="color: #0000BB">APP_NAME</span><span style="color: #007700">}</span><span style="color: #DD0000">"<br />
      CreateShortcut"</span><span style="color: #0000BB">$SMPROGRAMS</span><span style="color: #007700">${</span><span style="color: #0000BB">APP_NAME</span><span style="color: #007700">}${</span><span style="color: #0000BB">APP_NAME</span><span style="color: #007700">}.</span><span style="color: #0000BB">lnk</span><span style="color: #DD0000">""</span><span style="color: #0000BB">$INSTDIRonline</span><span style="color: #007700">.</span><span style="color: #0000BB">exe</span><span style="color: #DD0000">""""</span><span style="color: #0000BB">$INSTDIRonline</span><span style="color: #007700">.</span><span style="color: #0000BB">exe</span><span style="color: #DD0000">""""""""</span><span style="color: #0000BB">LaunchesPSOBB</span><span style="color: #DD0000">"<br />
      SectionEnd<br /></span></span> <!-- php buffer end -->
      <hr />
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
