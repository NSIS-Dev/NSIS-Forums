<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="${If} ${UserIsAdmin}" />

  <title>${If} ${UserIsAdmin} - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">${If} ${UserIsAdmin}</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=308950">${If} ${UserIsAdmin}</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Zinthose</span><br />
      <span class="post-time small text-muted">27th July 2009 16:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>${If} ${UserIsAdmin}</strong><br />
      I patched together a macro for use with the LogicLib library to easily check if the security context has Administrative rights.<br />
      <br />
      Feedback is practically non existent on the wiki as most of the activity appears to be here in the forums.<br />
      <br />
      It has been quite handy in my projects... Enjoy. :)<br />
      <br /></p>
      <pre>
<span style="color: #007700">;-----------------------
<br />;</span><span style="color: #0000BB">UserIsAdmin
<br /></span><span style="color: #007700">;-----------------------
<br />;
<br />;</span><span style="color: #0000BB">Example</span><span style="color: #007700">:
<br />;${If}${</span><span style="color: #0000BB">UserIsAdmin</span><span style="color: #007700">}
<br />;</span><span style="color: #0000BB">DetailPrint</span><span style="color: #DD0000">"Currentusersecuritycontexthaslocaladministrativerights."
<br /></span><span style="color: #007700">;${Else}
<br />;</span><span style="color: #0000BB">DetailPrint</span><span style="color: #DD0000">"CurrentusersecuritycontextdoseNOThavelocaladministrativerights."
<br /></span><span style="color: #007700">;${EndIf}
<br />;
<br />!</span><span style="color: #0000BB">macro_UserIsAdmin_a_b_t_f
<br />System</span><span style="color: #007700">::</span><span style="color: #0000BB">Store</span><span style="color: #DD0000">'p0p1p2p3'
<br /></span><span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'*(&amp;i10,&amp;i40,&amp;i15)i.r0'
<br /></span><span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'advapi32::AllocateAndInitializeSid(ir0,i2,i32,i544,i0,i0,i0,i0,i0,i0,*i.r1)i.r2'
<br /></span><span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Free</span><span style="color: #007700">$</span><span style="color: #0000BB">0
<br />System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'advapi32::CheckTokenMembership(in,ir1,*i.r2)i.r3'
<br /></span><span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'advapi32::FreeSid(ir1)i.r2'
<br /><br /></span><span style="color: #0000BB">StrCmp</span><span style="color: #007700">$</span><span style="color: #0000BB">300</span><span style="color: #007700">+</span><span style="color: #0000BB">4
<br /></span><span style="color: #FF8000">##UserisanAdmin
<br /></span><span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Store</span><span style="color: #DD0000">'r0r1r2r3'
<br /></span><span style="color: #0000BB">Goto</span><span style="color: #007700">`${</span><span style="color: #0000BB">_f</span><span style="color: #007700">}`
<br /><br /></span><span style="color: #FF8000">##UserisnotanAdmin
<br /></span><span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Store</span><span style="color: #DD0000">'r0r1r2r3'
<br /></span><span style="color: #0000BB">Goto</span><span style="color: #007700">`${</span><span style="color: #0000BB">_t</span><span style="color: #007700">}`
<br /><br />!</span><span style="color: #0000BB">macroend
<br /></span>

<!-- php buffer end -->
                
                
                
</pre>
      <hr />
      <pre>
        

                
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">27th July 2009 16:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I think your +4 jump is one too many. Also, where is your define for UserIsAdmin.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Zinthose</span><br />
      <span class="post-time small text-muted">27th July 2009 23:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Ah, good eye.. =)<br />
      <br />
      Here is the corrected macro.<br />
      <br />
      PHP Code:</p>
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #007700">;----------------------------<br />
      ;</span><span style="color: #0000BB">LogicLib_Ext</span><span style="color: #007700">.</span><span style="color: #0000BB">nsh<br /></span> <span style="color: #007700">;----------------------------<br />
      ;<br />
      ;</span><span style="color: #0000BB">Librarytoextendthe</span><span style="color: #DD0000">'LogicLib'</span><span style="color: #0000BB">library</span><span style="color: #DD0000">'sexistingfunctions.<br />
      ;<br />
      <br />
      <br />
      !ifndef___LOGICLIB_EXT__NSH___<br />
      !define___LOGICLIB_EXT__NSH___<br />
      <br />
      !include'</span><span style="color: #0000BB">LogicLib</span><span style="color: #007700">.</span><span style="color: #0000BB">nsh</span><span style="color: #DD0000">'<br />
      <br />
      ;-----------------------<br />
      ;UserIsAdmin<br />
      ;-----------------------<br />
      ;<br />
      ;Example:<br />
      ;${If}${UserIsAdmin}<br />
      ;DetailPrint"Currentusersecuritycontexthaslocaladministrativerights."<br />
      ;${Else}<br />
      ;DetailPrint"CurrentusersecuritycontextdoseNOThavelocaladministrativerights."<br />
      ;${EndIf}<br />
      ;<br />
      !macro_UserIsAdmin_a_b_t_f<br />
      System::Store'</span><span style="color: #0000BB">p0p1p2p3</span><span style="color: #DD0000">'<br />
      System::Call'</span><span style="color: #007700">*(&amp;</span><span style="color: #0000BB">i10</span><span style="color: #007700">,&amp;</span><span style="color: #0000BB">i40</span><span style="color: #007700">,&amp;</span><span style="color: #0000BB">i15</span><span style="color: #007700">)</span><span style="color: #0000BB">i</span><span style="color: #007700">.</span><span style="color: #0000BB">r0</span><span style="color: #DD0000">'<br />
      System::Call'</span><span style="color: #0000BB">advapi32</span><span style="color: #007700">::</span><span style="color: #0000BB">AllocateAndInitializeSid</span><span style="color: #007700">(</span><span style="color: #0000BB">ir0</span><span style="color: #007700">,</span><span style="color: #0000BB">i2</span><span style="color: #007700">,</span><span style="color: #0000BB">i32</span><span style="color: #007700">,</span><span style="color: #0000BB">i544</span><span style="color: #007700">,</span><span style="color: #0000BB">i0</span><span style="color: #007700">,</span><span style="color: #0000BB">i0</span><span style="color: #007700">,</span><span style="color: #0000BB">i0</span><span style="color: #007700">,</span><span style="color: #0000BB">i0</span><span style="color: #007700">,</span><span style="color: #0000BB">i0</span><span style="color: #007700">,</span><span style="color: #0000BB">i0</span><span style="color: #007700">,*</span><span style="color: #0000BB">i</span><span style="color: #007700">.</span><span style="color: #0000BB">r1</span><span style="color: #007700">)</span><span style="color: #0000BB">i</span><span style="color: #007700">.</span><span style="color: #0000BB">r2</span><span style="color: #DD0000">'<br />
      System::Free$0<br />
      System::Call'</span><span style="color: #0000BB">advapi32</span><span style="color: #007700">::</span><span style="color: #0000BB">CheckTokenMembership</span><span style="color: #007700">(</span><span style="color: #0000BB">in</span><span style="color: #007700">,</span><span style="color: #0000BB">ir1</span><span style="color: #007700">,*</span><span style="color: #0000BB">i</span><span style="color: #007700">.</span><span style="color: #0000BB">r2</span><span style="color: #007700">)</span><span style="color: #0000BB">i</span><span style="color: #007700">.</span><span style="color: #0000BB">r3</span><span style="color: #DD0000">'<br />
      System::Call'</span><span style="color: #0000BB">advapi32</span><span style="color: #007700">::</span><span style="color: #0000BB">FreeSid</span><span style="color: #007700">(</span><span style="color: #0000BB">ir1</span><span style="color: #007700">)</span><span style="color: #0000BB">i</span><span style="color: #007700">.</span><span style="color: #0000BB">r2</span><span style="color: #DD0000">'<br />
      <br />
      StrCmp$300+3<br />
      ##UserisanAdmin<br />
      System::Store'</span><span style="color: #0000BB">r0r1r2r3</span><span style="color: #DD0000">'<br />
      Goto`${_f}`<br />
      <br />
      ##UserisnotanAdmin<br />
      System::Store'</span><span style="color: #0000BB">r0r1r2r3<br />
      Goto</span><span style="color: #007700">`${</span><span style="color: #0000BB">_t</span><span style="color: #007700">}`<br />
      <br />
      !</span><span style="color: #0000BB">macroend<br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">defineUserIsAdmin</span><span style="color: #007700">`</span><span style="color: #0000BB">""UserIsAdmin""</span><span style="color: #007700">`<br />
      <br />
      !endif</span> FYI: The Latest version can always be found at: <a href="http://nsis.sourceforge.net/LogicLib_-_UserIsAdmin" target="_blank">NSIS WIKI - UserIsAdmin</a><br />
      <br /></span>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">27th July 2009 23:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">you could probably optimize this a bit, you could build the SID in a system struct without calling AllocateAndInitializeSid and FreeSid, and if you store the result from CheckTokenMembership on the stack, you could probably just have one system::store to restore and pop into the logiclib temp var, and if you did both there would only be need for one register and no need to call store at all</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">28th July 2009 12:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">As usual, I can't help myself, so here is my take on it:<br /></p>
      <pre>
<code><br />!macro _UserIsAdminNT5 _a _b _t _f<br />Push $1<br />!insertmacro _LOGICLIB_TEMP<br />System::Call '*(&amp;i1 1,&amp;i1 2,&amp;i5,&amp;i1 5,&amp;i4 32,&amp;i4 544)i.r1' ;S-1-5-32-544<br />System::Call 'advapi32::CheckTokenMembership(i n,i r1,*i.s)i.s'<br />System::Free $1<br />Pop $1<br />Pop $_LOGICLIB_TEMP<br />IntCmpU $1 0 0 +2 +2<br />StrCpy $_LOGICLIB_TEMP 0<br />Pop $1<br />!insertmacro _!= $_LOGICLIB_TEMP 0 `${_t}` `${_f}`<br />!macroend<br />!define UserIsAdminNT5 `"" UserIsAdminNT5 ""` <br /><br />Section<br />${If} ${UserIsAdminNT5}<br />        DetailPrint "admin"<br />${Else}<br />        DetailPrint "not admin"<br />${EndIf}<br />SectionEnd<br /></code>
</pre><br />
      <br />
      I named it NT5 because CheckTokenMembership was added to windows 2000, if you need to support every OS, use the userinfo plugin
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Zinthose</span><br />
      <span class="post-time small text-muted">28th July 2009 20:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Wow awesome Anders!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">ryanpager</span><br />
      <span class="post-time small text-muted">29th July 2009 17:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Anders FTW!</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
