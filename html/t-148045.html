<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Rename /REBOOTOK Questions"><title>Rename /REBOOTOK Questions - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Rename /REBOOTOK Questions</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=148045">Rename /REBOOTOK Questions</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">JaffaDog</span><br><span class="post-time small text-muted">3rd September 2003 22:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Rename /REBOOTOK Questions</strong><br>Hello All,<br><br>1. How does this achieve it's "rebootok" magic? I've checked the runonce keys and it does not appear to be loading anything there. Where is it scheduling anything to happen on reboot?<br><br>2. When I use Rename /rebootok and the target file exists, it will always choose to schedule this for reboot. Even if the target file is not locked. I can precede the rename with a delete, but this seems unnecessary.<br><br>TIA,<br>Jeremy</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">RDaneel</span><br><span class="post-time small text-muted">4th September 2003 03:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Check out the SDK docs on MoveFile and MoveFileEx.<br><br>Basically, NSIS will try a MoveFile, which *always* fails if the dst exists. Then it trys a MoveFileEx, which *can* work if the dst is present, but only asks for the rename to be scheduled at reboot time... if MoveFileEx isn't present (it showed up in NT4), then an entry is made in "wininit.ini" to handle things.<br><br>I have tried (in vain) to get KiCHiK to adjust this logic so that MoveFileEx is the preferred API, only falling back to the older stuff in case of failure, but it hasn't worked. :(<br><br>I even tried to imply that I would make the changes myself (well, I *would*) and hand them over. :)<br><br>I think he prefers the model of use the oldest APIs if possible, rather than to model things after the newer APIs and fall back to old stuff as required... and since he "owns" this area of the code, that's the way it is (for now).<br><br>OTOH, his judgement is usually good, and he does work cheap... :D</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">4th September 2003 12:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">So I'm a sweatshop worker now? :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JaffaDog</span><br><span class="post-time small text-muted">4th September 2003 19:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks. The Win SDK spells this out nicely (<a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/fileio/base/movefileex.asp" target="_blank">http://msdn.microsoft.com/library/de...movefileex.asp</a>). I'm using NSIS to put together a patcher, replacing files which may be in use (some are locked by the explorer.exe shell). I'll share the macro I've put together (so far):<br><br>!macro UpdateFile FILENAME DESTPATH<br><br>DetailPrint ""<br><br>; Add this file to the install package<br>File "files\${FILENAME}"<br><br>; Check if this file is present on the target PC<br>IfFileExists "${DESTPATH}\${FILENAME}" "check_${DESTPATH}\${FILENAME}"<br><br>DetailPrint "File does not exist ${DESTPATH}\${FILENAME}"<br>Goto "update_${DESTPATH}\${FILENAME}"<br><br>"check_${DESTPATH}\${FILENAME}:"<br>; If the file is found on the target PC, check its date to determine if it is the same as the file in the install package<br>DetailPrint "Checking version of ${DESTPATH}\${FILENAME}"<br><br>; Get date of update file from install package (SetOutPath $TEMP)<br>GetFileTime "$TEMP\${FILENAME}" $R0 $R1<br>StrCpy $0 "$R0.$R1"<br><br>; Get date of existing file on target PC<br>GetFileTime "${DESTPATH}\${FILENAME}" $R0 $R1<br>StrCpy $1 "$R0.$R1"<br><br>DetailPrint "Comparing dates &lt;$0&gt; &lt;$1&gt;"<br>StrCmp $0 $1 0 "update_${DESTPATH}\${FILENAME}"<br><br>DetailPrint "This file is up to date - No update needed"<br>goto "done_${DESTPATH}\${FILENAME}"<br><br>"update_${DESTPATH}\${FILENAME}:"<br>; Update the file; delete the old version and replace it with the new version<br>DetailPrint "Updating this file"<br>Delete "${DESTPATH}\${FILENAME}"<br>Rename /REBOOTOK "$TEMP\${FILENAME}" "${DESTPATH}\${FILENAME}"<br><br>"done_${DESTPATH}\${FILENAME}:"<br><br>!macroend</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>