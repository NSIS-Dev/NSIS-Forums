<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="install folder name length limitation"><title>install folder name length limitation - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">install folder name length limitation</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=261331">install folder name length limitation</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">bowman2</span><br><span class="post-time small text-muted">8th December 2006 08:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>install folder name length limitation</strong><br>What is the length limitation for the folder you wish to install to?<br><br>When installing into a folder with a name of about 200 characters, a write error is issued and nothing is copied.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Takhir</span><br><span class="post-time small text-muted">8th December 2006 10:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Windows<br>#define MAX_PATH 260</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">bowman2</span><br><span class="post-time small text-muted">8th December 2006 10:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Then why does the installer show the error box as in the attached image?<br><br>The folder name is not that long. Is this a bug?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Takhir</span><br><span class="post-time small text-muted">8th December 2006 11:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">This limit includes both path and file name.<br>Use CreateDirectory or SetOutPath to dest. folder first to ensure that folder exists. GetLastError can give error code <a href="http://forums.winamp.com/showthread.php?s=&amp;threadid=232489&amp;highlight=GetLastError" target="_blank">http://forums.winamp.com/showthread....t=GetLastError</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">dbyron</span><br><span class="post-time small text-muted">6th October 2008 04:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I think the MAX_PATH limit is only on relative paths, and any individual component of a path name. At least that's my reading of <a href="http://msdn.microsoft.com/en-us/library/aa365247(VS.85).aspx" target="_blank">http://msdn.microsoft.com/en-us/libr...47(VS.85).aspx</a>.<br><br>That page says the limit of an absolute path is ~32,000 characters.<br><br>I ran into a snag where I entered a long filename as the installation directory. The directory name is valid according to the above page, but I also have C code that can create it, remove it, etc. I used:<br><br>C:\Program Files\foo\XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX XXXXXXXXXX\foo<br><br>The snag is that GetInstDirError tells me the directory is valid but SetOutPath fails to create the directory and sets the error flag.<br><br>If I don't trap the error, I see a dialog box for the first File statement after SetOutPath that says "Error opening file for writing."<br><br>What are the chances of adding support for file/directory names &gt; MAX_PATH? In the meantime, I have a feeling it'd be more consistent for GetInstDirError to report an invalid directory but I've only got a bit of experience with this function so I'm not sure yet.<br><br>Thanks.<br><br>-DB</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">6th October 2008 06:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Only some of the windows api supports long paths, but you need to prefix the path with \\?\ and only the unicode api's supports this, so you will never see support for this in the ansi version of nsis</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">dbyron</span><br><span class="post-time small text-muted">6th October 2008 12:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I didn't realize there was an ansi version of nsis. Does this mean there's also a unicode version?<br><br>What do you think about how GetInstDirErr handles this directory? Shouldn't it report it as invalid?<br><br>-DB</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">6th October 2008 14:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">the "normal" version you get from nsis.sf.net is ansi, unicode fork is @ <a href="http://www.scratchpaper.com/" target="_blank">http://www.scratchpaper.com/</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">dbyron</span><br><span class="post-time small text-muted">6th October 2008 19:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks for the link. Still curious about the directory verification / GetInstDirErr.<br><br>I just peeked into the NSIS source for the first time, but changing the EW_CREATEDIR code in exehead/exec.c to build a unicode string, prefix it with \\?\ and call CreateDirectoryW doesn't seem so bad. It wouldn't get me all the way, but it seems like a step in the right direction.<br><br>I'd probably need to call GetProcAddress to make sure the function is available...got to look around the code to see the nsis way of dealing with that.<br><br>I took a quick look at is_valid_instpath. I'll have to dig deeper to see what it would take to decide the path is invalid. Looks like an explicit length check may be it. I haven't found the definition of NSIS_MAX_STRLEN but it looks like is_valid_instpath only looks at that many characters of whatever it's passed.<br><br>Any idea what the chances of patches for either place getting accepted are?<br><br>-DB</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">6th October 2008 21:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">k, here is the deal, only the low level file api's support those long paths, not the shell stuff like ShellExecute(ExecShell) and probably CreateShortcut. So if you change nsis so it uses \\?\, some stuff would work and other stuff would not. NSIS_MAX_STRLEN is 1024 in default build</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">dbyron</span><br><span class="post-time small text-muted">6th October 2008 21:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I realize that not all the windows APIs work with long filenames. Just having SetOutPath and File work could be enough for some folks (like me) though. Having some support seems better than none.<br><br>Since Windows Explorer doesn't handle long filenames in all cases, maybe I'm just barking up the wrong tree. Or maybe there are places where calling GetShortPathName to get things to work is the way to go. That worked for me to get CreateProcessW to execute processes that have long names. Maybe it would work for ShellExecute as well.<br><br>A NSIS_MAX_STRLEN of 1024 means I need to dig in further. The path I gave isn't that long so it wasn't getting truncated but somehow it's still considered valid which doesn't seem right.<br><br>-DB</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">6th October 2008 21:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">you can use FileMon/Process Monitor to see if the path nsis tries to access is invalid or not</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">dbyron</span><br><span class="post-time small text-muted">6th October 2008 22:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Interesting. For a path of:<br><br>C:\Program Files\foo\XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX XXXXXXXXXX\foo<br><br>the only paths that show up in ProcMon are C:\, C:\Program Files and c:\Program Files\foo.<br><br>From looking at the code, it seems like the FindFirstFile in file_exists returns INVALID_HANDLE_VALUE if the path is too long, so file_exists returns NULL. That makes the code in is_valid_instpath just skip over that part of the path.<br><br>I just did a quick test and FindFirstFile fails with GetLastError() set to ERROR_FILENAME_EXCED_RANGE (206) when given a filename that's too long. Not sure what the most pleasing way to use that info is...the simplest way is probably to check<br></p><pre>
<code>if (!fd &amp;&amp; (GetLastError() == ERROR_FILENAME_EXCED_RANGE))<br>  return 0;<br></code>
</pre><br>
      in is_valid_instpath but that's a bit unclean. Keeping the GetLastError() code in file_exists probably means changing the signature of that function.
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jamesrf</span><br>
      <span class="post-time small text-muted">7th January 2009 18:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I am suffering this problem too. Are you saying that the Unicode build will allow long filenames?<br>
      <br>
      I just need File and SetOutPath to support long filenames...<br>
      <br>
      Cheers.</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>