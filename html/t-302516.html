<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="EnvVarUpdate corrupts PATH"><title>EnvVarUpdate corrupts PATH - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">EnvVarUpdate corrupts PATH</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=302516">EnvVarUpdate corrupts PATH</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">cromev</span><br><span class="post-time small text-muted">28th January 2009 08:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>EnvVarUpdate corrupts PATH</strong><br>Hi everybody,<br><br><br>in my installer script, I issue the following command:<br><br><b>${EnvVarUpdate} $1 "PATH" "A" "HKLM" ${PATH_EXTENSION_STRING}</b><br><br>In 1 out of 20 cases, this command corrupts the PATH such that is does not <i>append</i> the PATH_EXTENSION_STRING but <i>replace</i> it. The fatal consequence is that almost no software is able to run on the affected machine.<br><br>I don't suss for the life of me what's going on, the fact that it only occurs every now and again points to the suspicion that some race condition or other side effect is behind this phenomenon.<br><br>Anyone any clue?<br><br><br>Cheers,<br>Chris</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Animaether</span><br><span class="post-time small text-muted">28th January 2009 12:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">it only happens occasionally? quaint.<br><br>Only thing I can think of is adding debuggery statements (messageboxes or so) at every step of the ${EnvVarUpdate} macro/Function and see where it fails.. and hopefully figure out why.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">smarmit</span><br><span class="post-time small text-muted">5th February 2009 18:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hi. What I've discovered may or may not be the same reason your PATH gets corrupted.<br><br>There is a limit to the length of the PATH variable. Normally on server types (e.g. 2003 server) that limit is 2048 characters. On XP without a hot fix or SP2, it's 1023.<br><br>My QA department found that if their current PATH env var is approaching that limit, and you attempt to add anything over that limit using EnvVarUpdate, it will corrupt the PATH and remove a lot of what was there. This happens with both "A" for append and with "P" for prepend.<br><br>I'm still pondering the right thing to do. Count the characters in the existing path, then determine what to do? Also looking at the EnvVarUpdate code to make the fix there (probably the right thing to do).<br><br>If you tried appending or prepending more characters to the PATH via the usual Control Panel method, Windows won't allow you to do it. But given EnvVarUpdate does this via the registry directly, the checks are bypassed.<br><br>So, not sure if this is what's happening to you, but beware of this anyway.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Comperio</span><br><span class="post-time small text-muted">6th February 2009 05:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">This is the first time I've heard about the path limitation under XP. But then again, most places I've worked for require the latest service packs of Windows always be installed. If that's a problem, perhaps you should check for the existence of the SP or such before you try setting it over the limit.<br><br>Another trick might be to figure out the short folder names (8.3 format) of the folder(s) used in the path and use that in the path variable. (The <a href="http://msdn.microsoft.com/en-us/library/aa364989(VS.85).aspx" target="_blank">GetShortPathName</a> API could be used with the system plugin to get that info.)<br><br>Also make sure you use the <a href="http://nsis.sourceforge.net/Special_Builds" target="_blank">large strings</a> version of NSIS to deal with strings longer than 1024 characters, or you may run into similar problems even on a "patched" version of windows.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">cromev</span><br><span class="post-time small text-muted">26th February 2009 13:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">A few weeks ago I decided to NOT use <b>EnvVarUpdate</b> anymore and to use the <b>setx</b> tool instead.<br><br>This has been working fine for a while, but yesterday the same thing occured again: the old content of <b>PATH</b> was replaced by my stuff. Again, it only occurs occasionally.<br><br>So we basically have one and the same phenomenon caused by two different tools (!!!)<br><br>I then issued the <b>setx</b> command from within a batch script (not using NSIS at all!) and did not experience any trouble.<br><br>I then returned to NSIS using either <b>EnvVarUpdate</b> or <b>setx</b>, inserted LOADS of debug <b>MessageBox</b>es, some of them right at the beginning of the installer, displaying the content of PATH to the installing user (<b>ReadEnvStr $R0 PATH</b>). They all tell me that <b>PATH</b> is empty but it is actually not because when I look up <b>PATH</b> in Windows it still holds the original string.<br><br>My (tentative) conclusion from this is that there's a general problem with the handling of environment variables in NSIS. Can anyone confirm this?<br><br><br>Ah and BTW, I also suspected a string length problem but that's not the case.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">cromev</span><br><span class="post-time small text-muted">26th February 2009 14:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Just a basic question -- is NSIS deemed capable of running on 64 bit versions of XP? I'm working on 64 bit machines all the time, might this be the cause for my problems?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">14th March 2009 22:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">NSIS strings are limited to 1024 characters. This has nothing to do with x64. You can use the special long string build that limits you to 8192.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">eigenguy</span><br><span class="post-time small text-muted">25th June 2009 02:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">So I just had the same thing happen to me as this guy did. I'm running NSIS 2.45. This happened WITH the long strings (8192) build, so that is consistent in that it isn't the problem (besides which, the path is &lt;600 characters right now anyway)<br><br>The one thing which is similar is that I'm running on a 64-bit system too (Vista). Several executions of the installer and corresponding uninstaller gave NO problems. Then, all of a sudden, the path was GONE with only the item I was adding there.<br><br>Has there been ANY follow-up to this? Did cromev ever find a solution?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Deko Servidoni</span><br><span class="post-time small text-muted">15th April 2010 19:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">My way:<br>I verified the size of the PATH before and after update it<br>If the size after was greater than the size before its ok, continue the process.<br>Else its is corrupt so i abort the process.<br>Anyone know if its right or will working?<br>Thanks<br><br>PS: if my english is too bad tell me, i am learning yet<br>=]</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">15th April 2010 20:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">That works if the expanded variable is always larger than the variable. That doesn't necessarily have to be so, though. It would probably be better to search for the original string (like whatever is supposed to get appended after the expanded envvar) inside the new one.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Deko Servidoni</span><br><span class="post-time small text-muted">15th April 2010 20:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Ok<br>i will try search for the original inside the new one<br>thanks MSG</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">TeeWeTee</span><br><span class="post-time small text-muted">1st March 2013 09:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Don't want to wake old threads however I found one more reason why EnvVarUpdate could corrupt system variables (like PATH):<br><br>I tried to add several entries at once:<br></p><pre>
<code>${EnvVarUpdate} $0 "PATH" "A" "HKLM" "Entry1;Entry2;Entry3"</code>
</pre><br>-&gt; If you call EnvVarUpdate n-times those three entries will be appended three times.<br><br>After I changed it to:<br><pre>
<code>${EnvVarUpdate} $0 "PATH" "A" "HKLM" "Entry1"<br>${EnvVarUpdate} $0 "PATH" "A" "HKLM" "Entry2"<br>${EnvVarUpdate} $0 "PATH" "A" "HKLM" "Entry3"</code>
</pre><br>
      everything worked fine (actually I did it in a loop). When calling the code again EnvVarUpdate prints out:<br>
      <pre>
<code>"Target is already present in PATH. It will be removed and appended to PATH"</code>
</pre>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>