<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Compression blocks" />

  <title>Compression blocks - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Compression blocks</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=200457">Compression blocks</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CodeSquid</span><br />
      <span class="post-time small text-muted">28th November 2004 14:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Compression blocks</strong><br />
      The problem with huge installers using "whole compression" mode is the slow initialization time of the installer. I'm still using zlib compression for my installers because I hate to wait for installers (worst is the InstallShield + MSI combination).<br />
      <br />
      The benefit of lzma + whole compression is the reduced installer size.<br />
      Zlib compression on the other side is the fastest, especially since every file gets compressed individually.<br />
      <br />
      <br />
      Now I had the idea of compression blocks, each consisting of one or more files.<br />
      <br />
      For this I would introduce some new commands:<br />
      BeginCompressionBlock &lt;name&gt;<br />
      EndCompressionBlock &lt;name&gt;<br />
      <br />
      Blocks can be nested in the sources (for use in macros with plugins for example). Inside a block, every instruction which causes a file to be added to the installer, will be added to the specified compression block.<br />
      If blocks with the same name already exists, any additional files will be appended.<br />
      If no block is open, a default block will be used.<br />
      <br />
      So I could for example call BeginCompressionBlock at each section (and EndCompressionBlock at the end).<br />
      That way only the files for the sections which will be installed will be extracted. The remaining files won't be touched, as opposed to the current solid compression where those files still get extracted but discarded.<br />
      <br />
      Hence it will also be possible to use seperate compression blocks for the install code/data and the plugins, thus dramaticaly reducing initialization time while still keeping a good compression ratio similar to old solid mode.<br />
      <br />
      This would be a very useful feature for complex projects. Best example I can think of would be projects like XAMPP or other meta-projects.<br />
      Would it be very hard to implement this?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">30th November 2004 18:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Starting with the shortest:</p>

      <blockquote>
        Would it be very hard to implement this?
      </blockquote>Yes.<br />
      <br />
      Next, a solution. If your installer loads slowly and shows the unpacking window, it's because your script is not optimally organized. I think the new ReserveFile descrption explains it best:

      <blockquote>
        Reserves a file in the data block for later use. Files are added to the compressed data block in the order they appear in the script. Functions, however, are not necessarily called in the order they appear in the script. Therefore, if you add a file in a function called early but put the function at the end of the script, all of the files added earlier will have to be decompressed to get to the required file. This process can take a long time if there a lot of files. .onInit is one such function. It is called at the very beginning, before anything else appears. If you put it at the very end of the script, extract some files in it and have lots of files added before it, the installer might take a very long time to load. This is where this command comes useful, allowing you to speed up the loading process by including the file at the top of the data block instead of letting NSIS seek all the way down to the bottom of the compressed data block.
      </blockquote>If your installer loads slowly and shows the verifying CRC window, it's because it's very large and CRCing it takes a while. Not much to be done there.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Andy La Rubin</span><br />
      <span class="post-time small text-muted">3rd December 2004 10:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">When the script becomes big and hairy (and uses lots of macros) it might be hard to find/remember all the File commands, especially when the order of expanding macros is not clear.<br />
      <br />
      Here's the method I used to optimize my script:<br />
      <br />
      1. add line !define MUI_VERBOSE 4 into the script (you can remove it later). It'll cause all MUI macros to generate the needed output.<br />
      2. build the installer. Capture all makensis output into a file.<br />
      3. filter out all the lines except "File:" (grep is handy for it)<br />
      4. go through file list in reverse order and look for any files (plugin dlls, InstallOptions inis, MUI grafix, etc) which is used after whole bunch of files to be installed.<br />
      5. add all of these files as ReserveFile at the top of the script. Repeat procedure if necessary (to be sure that all ReserveFiles are placed before the main bunch)</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
