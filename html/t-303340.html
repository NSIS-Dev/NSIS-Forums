<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="file check and download with nsis" />

  <title>file check and download with nsis - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">file check and download with nsis</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=303340">file check and download with nsis</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">novocaine</span><br />
      <span class="post-time small text-muted">21st February 2009 15:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>file check and download with nsis</strong><br />
      hi everyone<br />
      <br />
      i need to know if with nsis is possible to create an updater with this features:<br />
      <br />
      <br />
      1) Check where a program is installed (done with InstallDirRegKey)<br />
      2) Check a list of files already installed on the pc with filesize or crc check and:<br />
      if the files has a different CRC or filesize from other files stored in a webserver: delete old file, download it from the server and add the new one;<br />
      else if is up to date skip.<br />
      <br />
      suggestions?<br />
      <br />
      i have read some threads and the documentation of nsis, but i get a lot confused :cry:<br />
      <br />
      thanks in advance for your help[list=1][/list=1]</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Animaether</span><br />
      <span class="post-time small text-muted">21st February 2009 20:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">is your question...<br />
      <br />
      A. Can I do this?<br />
      B. Can you point me to some ways to do this?<br />
      C. Can you write this for me?<br />
      <br />
      Because...<br />
      A. yes<br />
      <br />
      B. Sure...<br />
      -- registry --<br />
      InstallDirRegKey - that only really applies to your own installer. If it is your own installer, that's fine. Otherwise, look into ReadRegStr to read a string from a registry key value.<br />
      <br />
      -- getting a file list --<br />
      You can use the FindFirst, FindNext and FindClose methods to loop over files, or you can use one of the many pre-made loop-over-files functions here:<br />
      nsis.sourceforge.net/Category:Disk,_Path_&amp;_File_Functions<br />
      <br />
      -- CRC / MD5 --<br />
      I would go with an MD5, as that has become the defacto standard for hashing a file.<br />
      <a href="http://nsis.sourceforge.net/MD5_plugin" target="_blank">http://nsis.sourceforge.net/MD5_plugin</a><br />
      <br />
      You can extend that, for some additional checking, with the size of the file using GetSize from FileFunc.nsh (included with NSIS, just !include `FileFunc.nsh` - see documentation). You can also do this yourself by opening the file, seeking to its end, and then getting the position, then closing the file.<br />
      <br />
      == Get file data from website / Download new files ==<br />
      Use a plugin such as inetc..<br />
      <a href="http://nsis.sourceforge.net/Inetc_plug-in" target="_blank">http://nsis.sourceforge.net/Inetc_plug-in</a><br />
      ..to download a text file that has the information on the current files (i.e. which files should be present, which are old and should be deleted, and their MD5 hashes).<br />
      <br />
      Read that text file, compare to your findings from the above (i.e. check the MD5 by comparing the strings). IIf the files differ, back the old file up and use inetc again to download the new file. If that download fails, you may wish to restore the old file. (or, better, download to a temporary file and only backup/delete the old file if the download was successful).<br />
      <br />
      Done.<br />
      <br />
      It *is* a bit of work, but it's certainly doable :)<br />
      <br />
      C. what's your offer? ;)<br />
      (kidding - what spare time I have I'm trying to spend away from code where I can)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">novocaine</span><br />
      <span class="post-time small text-muted">21st February 2009 21:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">fisrt of all, thank you for your reply<br />
      <br />
      i have started to work and i'mk in a good point, but i have a problem.<br />
      <br />
      how can i check the md5 of the files stored in the webserver?<br />
      and how can i confront with those are alredy insalled?<br />
      <br />
      edit: maybe i have found a solution..</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">21st February 2009 22:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        edit: maybe i have found a solution..
      </blockquote>you're enigmatic...<br />
      tell us about the solution.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">novocaine</span><br />
      <span class="post-time small text-muted">21st February 2009 22:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>
      <pre>
<code>Section "Client" client<br />;file nel server<br />inetc::head /TIMEOUT 10000 "http://www.xxx.com/nhr/Client.exe" "$TEMP\client.exe"<br />        Pop $0<br />        StrCmp $0 "OK" _ok<br />        _error:<br />            MessageBox MB_OK "Could not download."<br />            goto _end<br />        _ok:<br />            StrCpy $R0 -1<br />                FileOpen $0 "$TEMP\client.exe" "r"<br />                _nextline:<br />                    ClearErrors<br />                    FileRead $0 $1<br />                    IfErrors _closeFile<br />                    StrCpy $2 $1 16<br />                    StrCmp $2 "Content-Length: " _found _nextline<br />                    _found:<br />                        StrCpy $R0 $1 "" 16<br />                        goto _closeFile<br />        _closeFile:<br />        FileClose $0<br />        MessageBox MB_OK "File size web: $R0"<br />        _end:<br />        ;file presente nel pc<br />        ${GetSize} "$INSTDIR" "/M=client.exe /S=0b /G=0" $0 $1 $2<br />                MessageBox MB_OK "File size pc: $0"<br />    MessageBox MB_OK "File size: $R0 - $0"<br />;confronto i files<br />${if} $0 == $R0<br />MessageBox MB_OK "Il file client Ã¨ giÃ_ aggiornato!"<br />ABORT<br />${else}<br />; single file, NSISdl-style embedded progress bar with specific cancel button text<br />    inetc::get /caption "2005 report" /canceltext "Annulla" "http://www.xxx.com/nhr/Client.exe" "$INSTDIR\client.exe" /end<br />    Pop $0 # return value = exit code, "OK" means OK<br />${endif}<br />sectionend</code>
</pre><br />
      <br />
      why doesn't work :cry:<br />
      <br />
      EDIT: ok now i can check both sizes of files but the if is not working -.-
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">demiller9</span><br />
      <span class="post-time small text-muted">22nd February 2009 04:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">== is a string comparison, = is a signed integer comparison operator. Your registers (especially $R0) might contain more than just digits and the strings might not match even though the values do. Try using the = operator instead of the ==.<br />
      <br />
      Don</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">novocaine</span><br />
      <span class="post-time small text-muted">22nd February 2009 10:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">thank you it works, scripting in php makes really different :P</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
