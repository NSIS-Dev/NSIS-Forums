<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="IsEmptyDir check" />

  <title>IsEmptyDir check - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">IsEmptyDir check</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=354625">IsEmptyDir check</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">PoRtAbLe_StEaLtH</span><br />
      <span class="post-time small text-muted">16th January 2013 11:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>IsEmptyDir check</strong><br />
      Im not an expert .. but find NSIS an intriguing language.<br />
      I love the simplicity, and small overhead.<br />
      <br />
      I discover new things everyday.<br />
      <br />
      For instance.. today.. i learned:<br /></p>
      <pre>
<code>IfFileExists
<br /></code>

<!-- php buffer end -->
                
                
                
</pre>
      <hr />
      <pre>
        
 if used with a wildcard to detect if files exists, will always return true, due to ".", "..".<br /><br /><b>Example</b>:<br />        PHP Code:
        
                
</pre>
      <hr />
      <pre>
                <code style="white-space:nowrap">
                
                        <!-- php buffer start --></code><span style="color: #000000">
<span style="color: #0000BB">IfFileExists</span><span style="color: #007700">`</span><span style="color: #0000BB">$INSTDIR\Dir\*.*</span><span style="color: #007700">`</span><span style="color: #0000BB">0skip
<br />MessageBoxMB_OK</span><span style="color: #DD0000">"Didnotskip."
<br /></span><span style="color: #0000BB">skip</span><span style="color: #007700">:
</span></span>
</pre><b>Using Logic</b>:<br />
      <pre>
<span style="color: #007700">${If}${</span><span style="color: #0000BB">FileExists</span><span style="color: #007700">}`</span><span style="color: #0000BB">$INSTDIR\Dir\*.*</span><span style="color: #007700">`
<br /></span><span style="color: #0000BB">MessageBoxMB_OK</span><span style="color: #DD0000">"Didnotskip."
<br /></span><span style="color: #007700">${EndIf}
</span>
</pre>Both examples will execute MessageBox, because it will detect ".", "..".<br />
      <br />
      I have put together a useful script that will allow both above examples to work.<br />
      <br />
      <pre>
<span style="color: #007700">;!include</span><span style="color: #0000BB">logiclib</span><span style="color: #007700">.</span><span style="color: #0000BB">nsh
<br /><br /></span><span style="color: #007700">!</span><span style="color: #0000BB">defineIsEmptyDir</span><span style="color: #007700">`</span><span style="color: #0000BB">""LL_IsEmptyDir</span><span style="color: #007700">`
<br />!</span><span style="color: #0000BB">macro_LL_IsEmptyDir_a_b_t_f
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">insertmacro_LOGICLIB_TEMP
<br /></span><span style="color: #007700">${</span><span style="color: #0000BB">EmptyDir</span><span style="color: #007700">}`${</span><span style="color: #0000BB">_b</span><span style="color: #007700">}`</span><span style="color: #0000BB">$_LOGICLIB_TEMP
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">insertmacro_</span><span style="color: #007700">=</span><span style="color: #0000BB">$_LOGICLIB_TEMP1</span><span style="color: #007700">`${</span><span style="color: #0000BB">_t</span><span style="color: #007700">}``${</span><span style="color: #0000BB">_f</span><span style="color: #007700">}`
<br />!</span><span style="color: #0000BB">macroend
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">macroEmptyDir_DIR_VAR
<br />Push</span><span style="color: #007700">${</span><span style="color: #0000BB">_DIR</span><span style="color: #007700">}
<br /></span><span style="color: #0000BB">CallEmptyDir
<br />Pop</span><span style="color: #007700">${</span><span style="color: #0000BB">_VAR</span><span style="color: #007700">}
<br />!</span><span style="color: #0000BB">macroend
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">defineEmptyDir</span><span style="color: #007700">`</span><span style="color: #0000BB">!insertmacroEmptyDir</span><span style="color: #007700">`
<br />Function</span><span style="color: #0000BB">EmptyDir
<br /></span><span style="color: #007700">;</span><span style="color: #0000BB">renamedisemptyfrom</span><span style="color: #007700">:
<br />;</span><span style="color: #0000BB">http</span><span style="color: #007700">:</span><span style="color: #FF8000">//nsis.sourceforge.net/Check_if_dir_is_empty
<br />#Stack-&gt;#Stack:&lt;directory&gt;
<br /></span><span style="color: #0000BB">Exch</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #FF8000">#Stack:$0
<br /></span><span style="color: #0000BB">Push</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #FF8000">#Stack:$1,$0
<br /></span><span style="color: #0000BB">FindFirst</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #DD0000">"$0\*.*"
<br /></span><span style="color: #0000BB">strcmp</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #DD0000">"."</span><span style="color: #0000BB">0_notempty
<br />FindNext</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">$</span><span style="color: #0000BB">1
<br />strcmp</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #DD0000">".."</span><span style="color: #0000BB">0_notempty
<br />ClearErrors
<br />FindNext</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">$</span><span style="color: #0000BB">1
<br />IfErrors0_notempty
<br />FindClose</span><span style="color: #007700">$</span><span style="color: #0000BB">0
<br />Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #FF8000">#Stack:$0
<br /></span><span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">01
<br />Exch</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #FF8000">#Stack:1(true)
<br /></span><span style="color: #0000BB">goto_end
<br />_notempty</span><span style="color: #007700">:
<br /></span><span style="color: #0000BB">FindClose</span><span style="color: #007700">$</span><span style="color: #0000BB">0
<br />ClearErrors
<br />Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #FF8000">#Stack:$0
<br /></span><span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">00
<br />Exch</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #FF8000">#Stack:0(false)
<br /></span><span style="color: #0000BB">_end</span><span style="color: #007700">:
<br /></span><span style="color: #0000BB">FunctionEnd
<br /></span>

<!-- php buffer end -->
                
                
                
</pre>
      <hr />
      <pre>
        
<br /><b>Now you can do this</b>:<br />        PHP Code:
        
                
</pre>
      <hr />
      <pre>
                <code style="white-space:nowrap">
                
                        <!-- php buffer start --></code><span style="color: #000000">
<span style="color: #007700">${</span><span style="color: #0000BB">IfNot</span><span style="color: #007700">}${</span><span style="color: #0000BB">IsEmptyDir</span><span style="color: #007700">}`</span><span style="color: #0000BB">$INSTDIR\Dir</span><span style="color: #007700">`
<br /></span><span style="color: #0000BB">MessageBoxMB_OK</span><span style="color: #DD0000">"Didnotskip."
<br /></span><span style="color: #007700">${EndIf}
</span></span>
</pre><br />
      im sure the script can be shortened/improved..<br />
      But im not an expert..<br />
      infact.. i would truly love it if someone could improve the "isEmptyDir" script w/ Logic.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">gfm688</span><br />
      <span class="post-time small text-muted">16th January 2013 13:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">System::Call Shlwapi::PathIsDirectoryEmpty(t"$INSTDIR\Dir")i.r0<br />
      StrCmp $0 1 0 +2<br />
      MessageBox MB_OK "Directory is empty"</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">PoRtAbLe_StEaLtH</span><br />
      <span class="post-time small text-muted">16th January 2013 13:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Amazing</strong><br /></p>

      <blockquote>
        <small>Originally posted by gfm688</small><br />
        System::Call Shlwapi::PathIsDirectoryEmpty(t"$INSTDIR\Dir")i.r0<br />
        StrCmp $0 1 0 +2<br />
        MessageBox MB_OK "Directory is empty"
        <hr />
      </blockquote>
    </div>
    <hr />
    <b>Amazing</b>. :up:<br />
    <br />
    <b>all of that code can now be shrunken to this</b>:<br />
    <pre>
<span style="color: #007700">!</span><span style="color: #0000BB">defineIsEmptyDir</span><span style="color: #007700">`</span><span style="color: #0000BB">""LL_IsEmptyDir</span><span style="color: #007700">`
<br />!</span><span style="color: #0000BB">macro_LL_IsEmptyDir_a_b_t_f
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">insertmacro_LOGICLIB_TEMP
<br />System</span><span style="color: #007700">::</span><span style="color: #0000BB">CallShlwapi</span><span style="color: #007700">::</span><span style="color: #0000BB">PathIsDirectoryEmpty</span><span style="color: #007700">(</span><span style="color: #0000BB">t</span><span style="color: #DD0000">"${_b}"</span><span style="color: #007700">)</span><span style="color: #0000BB">i</span><span style="color: #007700">.</span><span style="color: #0000BB">r0$_LOGICLIB_TEMP
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">insertmacro_</span><span style="color: #007700">=</span><span style="color: #0000BB">$_LOGICLIB_TEMP1</span><span style="color: #007700">`${</span><span style="color: #0000BB">_t</span><span style="color: #007700">}``${</span><span style="color: #0000BB">_f</span><span style="color: #007700">}`
<br />!</span><span style="color: #0000BB">macroend
<br /></span>

<!-- php buffer end -->
                
                
                
</pre>
    <hr />
    <pre>
        
<b>to call</b>:<br />        PHP Code:
        
                
</pre>
    <hr />
    <pre>
                <code style="white-space:nowrap">
                
                        <!-- php buffer start --></code><span style="color: #000000">
<span style="color: #007700">;!include</span><span style="color: #0000BB">LogicLib</span><span style="color: #007700">.</span><span style="color: #0000BB">nsh
<br /><br /></span><span style="color: #007700">${</span><span style="color: #0000BB">IfNot</span><span style="color: #007700">}${</span><span style="color: #0000BB">IsEmptyDir</span><span style="color: #007700">}`</span><span style="color: #0000BB">$Dir_to_check</span><span style="color: #007700">`
<br /></span><span style="color: #DD0000">"codetoexecute"
<br /></span><span style="color: #007700">${EndIf}
</span></span>
</pre><br />
    <b>Thank you gfm688.</b><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">gfm688</span><br />
      <span class="post-time small text-muted">17th January 2013 01:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">!define IsEmptyDir `"" LL_IsEmptyDir`<br />
      !macro _LL_IsEmptyDir _a _b _t _f<br />
      !insertmacro _LOGICLIB_TEMP<br />
      <font color="teal">System::Call</font> `<font color="DimGray">Shlwapi::PathIsDirectoryEmpty(t"${_b}")i.s</font>`<br />
      <font color="blue">Pop</font> <font color="DarkRed">$_LOGICLIB_TEMP</font><br />
      !insertmacro _= $_LOGICLIB_TEMP 1 `${_t}` `${_f}`<br />
      !macroend</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">PoRtAbLe_StEaLtH</span><br />
      <span class="post-time small text-muted">17th January 2013 05:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Quote:</p>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
        <span class="post-time small text-muted">17th January 2013 10:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content"></p>

        <blockquote>
          <small>Originally posted by gfm688</small><br />
          !define IsEmptyDir `"" LL_IsEmptyDir`<br />
          !macro _LL_IsEmptyDir _a _b _t _f<br />
          !insertmacro _LOGICLIB_TEMP<br />
          <font color="teal">System::Call</font> `<font color="DimGray">Shlwapi::PathIsDirectoryEmpty(t"${_b}")i.s</font>`<br />
          <font color="blue">Pop</font> <font color="DarkRed">$_LOGICLIB_TEMP</font><br />
          !insertmacro _= $_LOGICLIB_TEMP 1 `${_t}` `${_f}`<br />
          !macroend
        </blockquote>You should change this code so it compares &lt;&gt; 0, BOOL can be &gt; 1, it usually means success is non-zero...
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">PoRtAbLe_StEaLtH</span><br />
        <span class="post-time small text-muted">17th January 2013 13:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

        <p class="post-content"><strong>Thank you</strong><br /></p>

        <blockquote>
          <small>Originally posted by Anders</small><br />
          You should change this code so it compares &lt;&gt; 0, BOOL can be &gt; 1, it usually means success is non-zero...
        </blockquote><b>How's this?</b><br />
        <br />
        PHP Code:
        <hr />
        <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #007700">!</span><span style="color: #0000BB">defineIsEmptyDir</span><span style="color: #007700">`</span><span style="color: #0000BB">""LL_IsEmptyDir</span><span style="color: #007700">`<br />
        !</span><span style="color: #0000BB">macro_LL_IsEmptyDir_a_b_t_f<br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">insertmacro_LOGICLIB_TEMP<br />
        System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #007700">`</span><span style="color: #0000BB">Shlwapi::PathIsDirectoryEmpty(t"</span><span style="color: #007700">${</span><span style="color: #0000BB">_b</span><span style="color: #007700">}</span><span style="color: #0000BB">")i.s</span><span style="color: #007700">`<br /></span> <span style="color: #0000BB">Pop$_LOGICLIB_TEMP<br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">insertmacro_</span><span style="color: #007700">&lt;&gt;</span><span style="color: #0000BB">$_LOGICLIB_TEMP0</span><span style="color: #007700">`${</span><span style="color: #0000BB">_t</span><span style="color: #007700">}``${</span><span style="color: #0000BB">_f</span><span style="color: #007700">}`<br />
        !</span><span style="color: #0000BB">macroend<br /></span></span> <!-- php buffer end -->
        <hr />
        <br />
        any recommendations for checking stack in a function/macro?
      </div>
      <hr />

      <div class="footer">
        <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
      </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
      hljs.initHighlightingOnLoad();
      //]]>
      </script>

      <table cellpadding="6" cellspacing="0" border="0" width="100%">
        <tr>
          <td class="alt2">
            <hr />
            Originally Posted by <strong>gfm688</strong> (Post 2908169) !define IsEmptyDir `"" LL_IsEmptyDir`<br />
            !macro _LL_IsEmptyDir _a _b _t _f<br />
            !insertmacro _LOGICLIB_TEMP<br />
            <font color="teal">System::Call</font> `<font color="DimGray">Shlwapi::PathIsDirectoryEmpty(t"${_b}")i.s</font>`<br />
            <font color="blue">Pop</font> <font color="DarkRed">$_LOGICLIB_TEMP</font><br />
            !insertmacro _= $_LOGICLIB_TEMP 1 `${_t}` `${_f}`<br />
            !macroend how come it works for me without popping?
          </td>
        </tr>
      </table>
    </div>
  </div>
</body>
</html>
