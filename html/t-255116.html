<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Start Menu variable not set in MUI Start Menu Leave ?" />

  <title>Start Menu variable not set in MUI Start Menu Leave ? - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.2/readable/bootstrap.min.css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Start Menu variable not set in MUI Start Menu Leave ?</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=255116">Start Menu variable not set in MUI Start Menu Leave ?</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CrushBug</span><br />
      <span class="post-time small text-muted">8th September 2006 22:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Start Menu variable not set in MUI Start Menu Leave ?</strong><br />
      &nbsp; In NSIS 2.19<br />
      <br />
      I think that the MUI custom leave function for the Start Menu is not setting the variable specified. It does get set when the MUI Start Menu page is completely gone (after the custom leave function), but not in the function.<br />
      <br />
      eg. (subset of full installer)<br />
      <br />
      !define MUI_PAGE_CUSTOMFUNCTION_LEAVE LeaveFunction_StartMenuSelect<br />
      !define MUI_STARTMENUPAGE_DEFAULTFOLDER "Default"<br />
      !insertmacro MUI_PAGE_STARTMENU "MainApp" $StartMenuLocation<br />
      <br />
      Function LeaveFunction_StartMenuSelect<br />
      <br />
      MessageBox MB_OK $StartMenuLocation<br />
      <br />
      FunctionEnd<br />
      <br />
      And $StartMenuLocation keeps coming up blank/null/""<br />
      <br />
      I found a similar report from 2003 - <a href="http://forums.winamp.com/showthread.php?threadid=140253" target="_blank">http://forums.winamp.com/showthread.php?threadid=140253</a> and I am wondering if this is an issue that hasn't been fixed yet or not properly reported. Anyone else seeing this?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">9th September 2006 01:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The StartMenu only pushes the result when its finished. There's no INI to update as with InstallOptions. You could get the text on your own calling GetWindowText using the System plug-in.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CrushBug</span><br />
      <span class="post-time small text-muted">9th September 2006 23:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">While I understand what you are saying and I am going to try the GetWindowText in a few minutes, this still seems like a bug to me.<br />
      <br />
      This kind of functionality exists in Dir Select page and I am able to fully and completly filter and edit all possible bad characters through the _LEAVE function.<br />
      <br />
      When I needed to filter bad characters in the Start Menu page, this page does not set the variable like it does in the Dir Select page. This functionality was expected because it works perfectly in Dir Select. Without it, I am unable to filter bad characters, although I should be able to now, using your GetWindowText suggestion.<br />
      <br />
      Would you reconsider this issue as a bug, or is it dead?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CrushBug</span><br />
      <span class="post-time small text-muted">10th September 2006 00:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Tryint to get this to work, but I guess I don't know how to get the control ID for the MUI Start Menu edit box correctly<br /></p>
      <pre>
<code>FindWindow$0 "#32770" "" $HWNDPARENT
<br />GetDlgItem$1 $0 1000 
<br />&gt;
</code>
</pre>I have tried 1000 and 1019 but no luck, or am I just totally off in the weeds?
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CrushBug</span><br />
      <span class="post-time small text-muted">10th September 2006 21:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">OK, I have it all mostly working now. Here is what is going right:<br /></p>
      <pre>
<code>
FindWindow $3 "#32770" "" $HWNDPARENT
<br />GetDlgItem$2 $3 1002  ; 1002 is the ID of the Start Menu Edit 
<br />System</code>::Call 'User32::GetWindowText(i $2, t .R0, i 256)' 
</pre>And $R0 ends up with the Start Menu that has been selected/typed in. I do my validation code after this, and once its all done, I re-write the edit box with:<br />
      <pre>
<code>System</code>::Call 'User32::SetWindowText(i $2, t "$R0")' 
</pre>and call the abort if I want the user to fix the Start Menu path.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">15th September 2006 08:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by CrushBug</i><br />
        <b>Would you reconsider this issue as a bug, or is it dead?</b>
      </blockquote>You could submit a bug report/feature request/patch. It would be best if the leave function would have the correct value, but as you can understand from my earlier explanation, there's a technical difficulty involved. A possible solution would be having the MUI use GetWindowsText on its own before calling your leave function.
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
