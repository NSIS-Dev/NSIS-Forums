<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="RequestExecutionLevel admin doesn't seem to do anything"><title>RequestExecutionLevel admin doesn't seem to do anything - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">RequestExecutionLevel admin doesn't seem to do anything</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=334999">RequestExecutionLevel admin doesn't seem to do anything</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">JonHodgson</span><br><span class="post-time small text-muted">20th September 2011 10:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>RequestExecutionLevel admin doesn't seem to do anything</strong><br>Hi,<br><br>I have an installer that really needs to run with admin priviledges.<br><br>I can run it fine from an admin account... no surprise there.<br><br>But when I run it from a user account, the best I seem to be able to manage is to get it to detect it does not have admin priviledges and exit.<br><br>RequestExecutionLevel admin seems to make no difference.<br><br>Neither it seems does right clicking and selecting "run as administrator"<br><br>So how do I get it to run with admin priviledges from a user account?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">20th September 2011 12:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">"RequestExecutionLevel" does nothing but adding a Manifest to the EXE file.<br><br>This will trigger <i>elevation</i> on Vista+ systems that have <b>UAC</b> enabled.<br><br>However it does <i>absolutely nothing</i> on pre-Vista systems as well as on Vista+ systems with UAC turned off.<br><br>That's why you still need to check for Admin rights <i>at runtime</i>, as suggested all the time on the forum...<br><br><br>I would recommend to give the UAC plug-in a try:<br><a href="http://nsis.sourceforge.net/UAC_plug-in" target="_blank">http://nsis.sourceforge.net/UAC_plug-in</a><br><br>That is the code I currently use:<br><a href="http://pastie.org/private/8eaggwflkvn3shecyvjng" target="_blank">http://pastie.org/private/8eaggwflkvn3shecyvjng</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JonHodgson</span><br><span class="post-time small text-muted">20th September 2011 13:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I've implemented the check at runtime, that works.<br><br>But what I can't seem to do, despite having requires admin rights in the manifest, AND selecting "run as admin" from the explorer context menu, is to actually get it to run with admin rights from a non admin user account.<br><br>I'm working on Windows 7 64 bit (though it's a 32 bit installer and app)<br><br>I shall try your code</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">20th September 2011 14:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">With "RequestExecutionLevel admin" <i>and</i> running on Vista+ <i>and</i> UAC enabled, the following should happen:<br><br>(1) User with admin-privileges runs the installer:<br>An UAC dialog pops up and asks the user to confirm (click on YES button is sufficient, NO button aborts)<br><br>(2) User <i>without</i> admin-privileges runs the installer:<br>An UAC dialog pops up and asks the user to enter login credentials of an Admin account.<br><br>In both cases the installer should either start with <i>elevated</i> ("admin") rights or <b>not</b> start at all. Also you don't need to use "run as admin". This is for legacy applications that need elevation ("admin" rights) but are lacking a proper UAC Manifest to enforce.<br><br>Again, on Windows XP (or even older) the UAC Manifest does nothing. So on these systems the installer would start with the privileges of whoever has launched the installer and you need to check yourself, at runtime, whether we are Admin or not.<br><br>BTW: The great UAC plug-in allows you to do "elevation" even on Windows XP (it will pop up a "run as" dialog, if the installer was run by a Non-Admin user) and it allows you to handle the situation when the user has clicked "NO" in the UAC dialog on Vista+ systems (so you can show a message like "This installer needs elevation. Please try again!" and then re-run the installer to give the user another chance).<br><br>IMPORTANT: If you ever try the UAC plug-in, make sure you use "RequestExecutionLevel <u>user</u>" and let the plug-in handle all elevation!</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">20th September 2011 14:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Please do not recommend the UAC plugin for something as simple as elevation. Elevation is NOT what the UAC plugin should be used for. The only thing the UAC plugin was designed to do is allowing the finish page's Run checkbox to launch the app at userlevel, after elevation has occured for the installer.<br><br>To enforce admin-only installations, use the userinfo plugin in .onInit, with a messagebox + quit if access level is too low.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JonHodgson</span><br><span class="post-time small text-muted">20th September 2011 14:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">What you describe is what I expected to happen.<br><br>But not what I'm getting.<br><br>Windows 7 seems to be completely ignoring the requirement for admin rights when running the installer... though not when bringing up errors when it tries to do something that requires admin rights.<br><br>I've checked and it is in the manifest.<br><br>the UAC plugin example installer seems to work as it should, so that seems like a working solution to what I need to do, but I'm still confused as to why I'm not seeing the behaviour you describe.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">20th September 2011 14:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I disagree ;)<br><br>Being able to launch application in a non-elevated way from an elevated installer already is an essential feature for me. But being able to force "elevation" (i.e. automatically trigger a "run as" dialog if installer was run by a non-admin user) on pre-Vista systems is very useful too! Last but not least with UAC plug-in I can handle the situation when elevation has failed (e.g. the user has accidentally clicked on "NO"). Without UAC plug-in my installer would never be started in that case, so I cannot handle anything. Bad for Auto Update and stuff...<br><br>(This doesn't mean everybody needs the UAC plug-in, but everybody should be aware what it can do)<br><br><b>@JonHodgson</b><br>What UAC level is configured on your test system? Also, what actions exactly do cause errors?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">20th September 2011 15:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I don't think everybody should be aware of what it can do. It's a relatively complex tool for only a small added feature (being a shiny run as dialog). You shouldn't push any and all beginners towards something that will in the best case cost them a huge amount of work to figure out, and in the worst case cause them to give up completely.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JonHodgson</span><br><span class="post-time small text-muted">20th September 2011 15:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Where is the UAC level set?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">20th September 2011 16:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">In the control panel:<br><a href="http://img191.imageshack.us/img191/482/uaccontrol.jpg" target="_blank">http://img191.imageshack.us/img191/482/uaccontrol.jpg</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JonHodgson</span><br><span class="post-time small text-muted">20th September 2011 16:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks,<br><br>Ok, here's what I've found.<br><br>At some point I turned UAC off, probably because with all the installs and updates I was doing setting up a new system it was just a pain.<br><br>Anyway....<br><br>If UAC is any level of on, then things are as described by others here, I try to run the installer from a non admin user account and I get a dialog where I can put in an admin password, and it then runs properly.<br><br>But...<br><br>If UAC is switched off, I don't get any such dialog (not too surprising), but the installer doesn't work, because for example that user doesn't have write permission to Program Files (x86)<br><br>Maybe that makes sense to Microsoft, or someone here, but it doesn't to me. I would have thought that switching UAC off would switch off the protection against users modifying the system, but all it seems to be doing is switching off the means to elevate over that protection.<br><br>Now I think that a simple check of admin rights will result in an installer that will work first time for most users, so that's fine in itself, but I'd still like to understand the thinking behind how things are working.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">20th September 2011 16:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">As said before, without UAC (pre-Vista OS <i>or</i> Vista+ with UAC turned off) the UAC Manifest doesn't do anything.<br><br>So if the installer is launched by a Non-Admin user with UAC turned off, it will probably run with <i>that</i> user's <u>limited</u> rights.<br><br>Do what MSG has suggested: Use the UserInfo plug-in in .onInit and abort if the rights are not sufficient...<br><br><br>Keep in mind:<br><br>On Windows every user has a security "Token" containing its rights and generally applications are launched with the user's token. At least that was the situation before UAC (and still is the situation with UAC turned off). If a "regular" user, who has limited rights, launches an application, the application will have limited rights too. If an Admin, with maximum rights, launches the application, the application has maximum rights. Now, with UAC in action, each user has <b>two</b> tokens: A "restricted" one and an "unrestricted" one. By default applications are <i>always</i> launched with the "restricted" token - even if you are an Admin user! Elevation, which can be enforced by Manifest, will cause the application to be launched with the "unrestricted" token, but only after the user has confirmed. AFAIK "Admin" users just have to click "YES", but a "Non-Admin" user will be prompted to enter the login credentials of an "Admin" user in that situation (so it can borrow the Admin's "unrestricted" token for the installer process). With UAC turned off elevation doesn't happen! And so the application is simply launched with the user's token, which has limited rights - not because of UAC, but because the user is a "regular" (Non-Admin) user...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">20th September 2011 17:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><a href="http://pastebin.com/EvMkyLLt" target="_blank">http://pastebin.com/EvMkyLLt</a> is as simple as you can get it</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>