<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Determine if the vc8 dlls are installed"><title>Determine if the vc8 dlls are installed - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Determine if the vc8 dlls are installed</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=292487">Determine if the vc8 dlls are installed</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">TobbeSweden</span><br><span class="post-time small text-muted">30th May 2008 08:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Determine if the vc8 dlls are installed</strong><br>I've been trying to find a way to determine if the vc8 dlls (msvc*80.dll) are installed on a user's system. I've found a few different ways, but they all have their down sides.<br><br>http://nsis.sourceforge.net/VC_8.0_Redistributables<br>Only works if the user used the vc8 redist. If they were installed by some other means, like installing MS Visual Studio.<br><br>http://forums.winamp.com/showthread.php?postid=2080081#post2080081<br>I'm afraid this will be too slow on Vista. The WinSxS folder where the dlls are is too big (~5GB). It would take ages to search through that, wouldn't it?<br><br>http://blogs.msdn.com/astebner/archive/2007/01/16/mailbag-how-to-detect-the-presence-of-the-vc-8-0-runtime-redistributable-package.aspx<br>This looks like it might be the most promising way to do it. The problem is that I don't know how to call that MsiQueryProductState function. Can someone give me a hand with that?<br><br>Are there any other ways I haven't mentioned?<br>Any other thoughts on what I have said?<br><br>Thanks in advance for any help</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Red Wine</span><br><span class="post-time small text-muted">30th May 2008 09:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Actually I know very little about vista.<br>The provided example that you're referring populates the whole system drive, on a typical XP &lt;= system, which is probably useless for you.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">TobbeSweden</span><br><span class="post-time small text-muted">30th May 2008 09:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I don't know much about Vista either. I just happened to stumble upon that piece of information at http://www.winvistaclub.com/f16.html</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Red Wine</span><br><span class="post-time small text-muted">30th May 2008 12:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I wish I could help, yet, I don't intend to switch to vista.<br>Certain people down here, already renamed vista to svista, which means "remove them" in greeks. :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">TobbeSweden</span><br><span class="post-time small text-muted">30th May 2008 12:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You don't have to have Vista to help me. Just find a way that works in XP that doesn't involve searching for the .dll and it should work in Vista too (hopefully)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Joel</span><br><span class="post-time small text-muted">30th May 2008 23:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Did you try loadlibrary method? Normally microhog dlls are registered and ready to use with loadlibrary.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">TobbeSweden</span><br><span class="post-time small text-muted">31st May 2008 02:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks a lot! Doing a search for LoadLibrary in the wiki I found this page: http://nsis.sourceforge.net/WinSxS_QueryAssemblyInfo_to_check_if_assembly_is_installed I think that is what I'm looking for. And if it doesn't work as I want it I'm sure I can modify it to my needs (maybe with some help from you guys ;)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">TobbeSweden</span><br><span class="post-time small text-muted">31st May 2008 12:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You can't use LoadLibrary with Side by Side (SxS) assemblies, so I have to use IAssemblyCache::QueryAssemblyInfo instead (as they do in that function I posted a link to in my last post).<br><br>The problem with QueryAssemblyInfo is that it needs the full assembly identity, not just the dll name. Since I don't care about the full version of the dll this complicates things a bit.<br><br>Does anyone have any idea how I can use QueryAssemblyInfo to find out if version 8.0.whatever is installed?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">31st May 2008 13:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">that is the whole point of WinSxS, several versions of 8.0.xxx on the same windows install</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">TobbeSweden</span><br><span class="post-time small text-muted">31st May 2008 14:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Yes, I know.<br><br>This is the problem:<br>With this line:<br>!define CRTCHECKNAME 'Microsoft.VC80.CRT,version="8.0.50727.42",type="win32",processorArchitecture="x86",publicKeyToken="1fc8b3b9a1e18e3b"'<br>the detection fails.<br><br>With this line:<br>!define CRTCHECKNAME 'Microsoft.VC80.CRT,version="8.0.50727.1433",type="win32",processorArchitecture="x86",publicKeyToken="1fc8b3b9a1e18e3b"'<br>the detection passes.<br><br>The actual program that uses msvcr80.dll works with either version of that dll, so I want the detection to pass in both cases.<br><br>Is my only option to run a detection on every possible version of that dll?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">TobbeSweden</span><br><span class="post-time small text-muted">31st May 2008 18:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">This is what I have to do right now, which I think is rather silly:</p><pre>
<code>Push 'msvcr80.dll'<br>Push 'Microsoft.VC80.CRT,version="8.0.50727.42",type="win32",processorArchitecture="x86",publicKeyToken="1fc8b3b9a1e18e3b"'<br>Call WinSxS_HasAssembly<br>Pop $R0<br><br>${If} $R0 == 0<br>        ; Try another version<br>        Push 'msvcr80.dll'<br>        Push 'Microsoft.VC80.CRT,version="8.0.50727.163",type="win32",processorArchitecture="x86",publicKeyToken="1fc8b3b9a1e18e3b"'<br>        Call WinSxS_HasAssembly<br>        Pop $R0<br>        <br>        ${If} $R0 == 0<br>                ; Try yet another version<br>                Push 'msvcr80.dll'<br>                Push 'Microsoft.VC80.CRT,version="8.0.50727.762",type="win32",processorArchitecture="x86",publicKeyToken="1fc8b3b9a1e18e3b"'<br>                Call WinSxS_HasAssembly<br>                Pop $R0<br>                <br>                ${If} $R0 == 0<br>                        ; Try another version again<br>                        Push 'msvcr80.dll'<br>                        Push 'Microsoft.VC80.CRT,version="8.0.50727.1433",type="win32",processorArchitecture="x86",publicKeyToken="1fc8b3b9a1e18e3b"'<br>                        Call WinSxS_HasAssembly<br>                        Pop $R0<br>                        <br>                        ${If} $R0 == 0<br>                                StrCpy $R3 "false"<br>                        ${EndIf}<br>                ${EndIf}<br>        ${EndIf}<br>${EndIf}</code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br>
      <span class="post-time small text-muted">31st May 2008 19:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">you can just change the wiki sample to check more than one identity at the time<br>
      <br>
      the<br>
      <br>
      System::Call `$R0-&gt;4(i 0,w '$8',i $R1)i.r0` ;IAssemblyCache::QueryAssemblyInfo<br>
      ${If} $0 == 0<br>
      System::Call '*$R1(i,i.r0)'<br>
      IntOp $0 $0 &amp; 1 ;ASSEMBLYINFO_FLAG_INSTALLED=1<br>
      ${IfThen} $0 &lt;&gt; 0 ${|} StrCpy $9 1 ${|}<br>
      ${EndIf}<br>
      <br>
      code could be called in a loop</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">TobbeSweden</span><br>
      <span class="post-time small text-muted">31st May 2008 20:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Yes, but I would still have to call it once for every version of the .dll<br>
      <br>
      And whenever microsoft releases a new version of the dll I need to update that script :/<br>
      <br>
      Don't get me wrong here. I'm not trying to blame nsis or the function in the wiki. And I'm not trying to be ungrateful, I was just hoping there would be an easier way to do this.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br>
      <span class="post-time small text-muted">31st May 2008 20:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">well, there is, just use the findfile nsis stuff in $windir\winsxs and look for your dll (this method is not supported by MS ofcourse)</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">TobbeSweden</span><br>
      <span class="post-time small text-muted">31st May 2008 22:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">yeah, that would work if it weren't for Vista's 5GB winsxs dir...</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br>
      <span class="post-time small text-muted">1st June 2008 02:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Look at the folder names inside WinSxS for *VC80.CRT* , can't be that slow</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br>
      <span class="post-time small text-muted">15th June 2008 13:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well, I needed to verify if those libraries are installed on every windows version and I found that:<br>
      <br>
      - Windows 2000 sp4 not installed (obvious)<br>
      - Windows xp sp3 not installed (surprise)<br>
      - Windows server 2003 no sp not installed<br>
      - Vista home premium fresh install without any update. The libraries are installed v8.0.50727.312 assigned to none hence if your application has not dependency on a specific version you don't have to perform any search.<br>
      <br>
      Therefore I've implemented Anders' code for search and Koby's code for install in xp/2003 which takes a couple of seconds to proceed along with policy manifest/cat who also need to install. For older windows just copy them into $SYSDIR.<br>
      <br>
      So far, everything works as expected from win 2000 up to vista.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br>
      <span class="post-time small text-muted">21st June 2008 00:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by Red Wine</i><br>
        <b>Windows xp sp3 not installed (surprise)<br></b>
      </blockquote>Not really a surprise to me, the CRT for anything after VC6 is not really a part of windows (Microsoft does not follow the guideline here, they have their own internal version, new CRT code, but it still is in msvcrt.dll so they don't have to ship this stupid runtime with windows)
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Animaether</span><br>
      <span class="post-time small text-muted">14th July 2008 22:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I'm slightly confused by all of the above...<br>
      <br>
      From:<br>
      <a href="http://blogs.msdn.com/astebner/archive/2007/01/24/updated-vc-8-0-runtime-redistributable-packages-are-included-in-visual-studio-2005-sp1.aspx" target="_blank">http://blogs.msdn.com/astebner/archi...-2005-sp1.aspx</a><br>
      Linking to:<br>
      <a href="http://msdn.microsoft.com/en-gb/library/aa370363.aspx" target="_blank">http://msdn.microsoft.com/en-gb/library/aa370363.aspx</a> ( MsiQueryProductState Function )<br>
      <br>
      Which describes a windows installer function to check if a particular product has been installed, one of the possible return codes is "INSTALLSTATE_ABSENT - The product is installed for a different user.".<br>
      <br>
      Is it at all possible that the redistributables are installed under a 'current user' only, thus resulting in the above state? If so, wouldn't that invalidate the file searching method?<br>
      <br>
      Alternatively, regardless of whether it might be installed for 'current users' only, wouldn't checking the registry work? The class ID passed to that MsiQueryProductState function is certainly the same as used for the uninstall class ID's; though one post found on here seems to reference an older (non-SP1, perhaps?) class ID (starting with A4).<br>
      <br>
      I understand that the actual DLLs *may* have been installed via different means; either the extremely scary code as described by Koby or via a Visual Studio install, but then checking for those specific DLLs leads to the variat on DLL Hell (just when Microsoft intended SxS to do away with DLL Hell.. hum) that is checking version upon version and for each file you actually use; seeing as the existence of -one- file out of the redistributable wouldn't guarantee the existence of every single other?<br>
      <br>
      Dependencies are always a mess, but this one is headache-worthy. ( A wiki page would be nice.. this one is outdated (and not very clearly titled; happened upon it via Google) : <a href="http://nsis.sourceforge.net/VC_8.0_Redistributables" target="_blank">http://nsis.sourceforge.net/VC_8.0_Redistributables</a> )<br>
      <br>
      Thanks in advance for any insights.. an hour of reading about didn't give me much :/</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>