<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Install USB driver / .inf file - pnputil fails" />

  <title>Install USB driver / .inf file - pnputil fails - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Install USB driver / .inf file - pnputil fails</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=337966">Install USB driver / .inf file - pnputil fails</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Elmi</span><br />
      <span class="post-time small text-muted">22nd November 2011 19:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Install USB driver / .inf file - pnputil fails</strong><br />
      Hi,<br />
      <br />
      I want to install an USB driver via its .inf file using NSIS. I found a Wiki-entry regarding this that recommended to use Microsofts pnputil to add the .inf file to the driver storage.<br />
      <br />
      Unfortunately pnputil fails, it cancels the operation with an error message "Access denied". This is strange because I have administrator privileges.<br />
      <br />
      So what can I do - how can I pre-install a driver/.inf file so that it is used as soon as the related device is attached?<br />
      <br />
      Elmi</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">T.Slappy</span><br />
      <span class="post-time small text-muted">23rd November 2011 08:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What version of Windows are you using?<br />
      For W2k and XP use these plug-ins: <a href="http://nsis.sourceforge.net/Driver_installation_and_update" target="_blank">http://nsis.sourceforge.net/Driver_i...ion_and_update</a> and <a href="http://nsis.sourceforge.net/InstDrv_plug-in" target="_blank">http://nsis.sourceforge.net/InstDrv_plug-in</a><br />
      <br />
      For Vista and later PnPUtil is better.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Elmi</span><br />
      <span class="post-time small text-muted">23rd November 2011 11:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi,<br />
      <br />
      I'm using Win 7</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Elmi</span><br />
      <span class="post-time small text-muted">27th November 2011 17:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi,<br />
      <br />
      I think I found the reason:<br />
      <br />
      when executing pnputil within NSIS using command "Exec" it is NOT executed with administrator privileges although I previously called "RequestExecutionLevel admin".<br />
      <br />
      So how can I execute pnputil WITH admin privileges correctly?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">27th November 2011 17:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Are you sure you have administrative access? Note that requestexecutionlevel admin is NOT sufficient to guarantee it - you need to use the userinfo plugin (in .onInit) to verify!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Elmi</span><br />
      <span class="post-time small text-muted">27th November 2011 17:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I'm sure I don't have administrative access because pnputil fails. Therefore my question: how can I get administrative privileges for "Exec" calls?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Elmi</span><br />
      <span class="post-time small text-muted">27th November 2011 18:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">May be I have to be more detailled:<br />
      <br />
      When using "pnputil" manually I have to run a "cmd.exe" as administrator, elsewhere pnputil fails.<br />
      <br />
      So to execute pnputil out of a NSIS installer I currently execute it using "Exec". But this does not seem to execute it within a "cmd" that has administrator privileges.<br />
      <br />
      So how can I "Exec" it correctly so that the underlying command line environment has the same privileges like a "cmd.exe" that is executed with administrator privileges?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">28th November 2011 06:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If your installer isn't at admin level, the pnputil also will not be executed at admin level. To make sure the installer's child processes are admin, make sure the installer is admin. To do this, use the userinfo plugin.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Elmi</span><br />
      <span class="post-time small text-muted">20th December 2011 11:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by MSG</small><br />
        make sure the installer is admin. To do this, use the userinfo plugin.
      </blockquote>OK, it tells me I'm not Admin - how do I change that?
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">20th December 2011 12:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Simplest approach is to bring up a message box and tell the user they must run the installer as an administrator using Run As (and then exit). Another option is you could run the installer again using ExecShell with the runas verb. Last option I suppose is to use the UAC plug-in.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Elmi</span><br />
      <span class="post-time small text-muted">20th December 2011 14:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by Afrow UK</small><br />
        Simplest approach is to bring up a message box and tell the user they must run the installer as an administrator using Run As (and then exit).
      </blockquote>OK, in this case we're back to my original problem: running the installer as Administrator DOES NOT cause pnputil to work properly since the command line that is spawned from such an installer seems not to inherit its privileges!
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Theresias</span><br />
      <span class="post-time small text-muted">20th December 2011 15:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Save yourself the trouble and use DPInst instead, we've wasted our time with several approaches and after having tried them "all" we went with DPInst. In fact at this point we are very glad to have used as it also allows easy un-installation of specific driver versions.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">T.Slappy</span><br />
      <span class="post-time small text-muted">21st December 2011 09:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I can confirm Theresias words: PnPUtil is not working correctly in some cases.<br />
      I made drivers installer some time ago and it was too difficult to find out why is PnPUtil causing troubles so I switched to DPInst.<br />
      <br />
      Use DPInst - there is simple example here: <a href="http://blogs.technet.com/b/svengruenitz/archive/2008/07/02/driver-installation-and-up*******made-easy-dpinst-exe.aspx" target="_blank">http://blogs.technet.com/b/svengruen...pinst-exe.aspx</a><br />
      Also all necessary files are there so you do not need to download whole SDK package.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
