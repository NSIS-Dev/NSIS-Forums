<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="RunAs error: The stub received bad data." />

  <title>RunAs error: The stub received bad data. - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">RunAs error: The stub received bad data.</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=326709">RunAs error: The stub received bad data.</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">happyhippo</span><br />
      <span class="post-time small text-muted">31st January 2011 15:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>RunAs error: The stub received bad data.</strong><br />
      Hi there,<br />
      <br />
      I am using the following expression to start an update program that requires admin rights:<br />
      <br />
      SetOutPath "$EXEDIR"<br />
      File "RunAsDll\RunAs.dll"<br />
      StrCpy $1 "$ADMIN_LOGON"<br />
      StrCpy $2 "$ADMIN_PASSWD"<br />
      StrCpy $3 "$INST_TEMP\${UPDATE_FILE}"<br />
      StrCpy $4 0<br />
      System::Call 'RunAs::RunAsW(w r1,w r2,w r3,*w .r4) i .r0 ? u'<br />
      DetailPrint "RunAs Message: $4 ($0)"<br />
      <br />
      If I run this script I receive the following error through the $4 variable: “The stub received bad data.” and the $0 variable shows the value 0.<br />
      <br />
      The script runs on RequestExecutionLevel user (if this makes any difference).<br />
      <br />
      I have double checked all of the variables $1-$3 but they are all correct. I also have searched the internet for this error but did not find anything that helped further.<br />
      <br />
      So does anybody know what this error means and how to resolve it?<br />
      <br />
      Many Thanks.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">31st January 2011 18:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">RPC_NT_BAD_STUB_DATA=The stub received bad data<br />
      <br />
      I can't tell you why it is failing, but I can tell you that this plugin has some bugs (leaks two kernel handles or the error string each time you call it) but that is not the reason why it fails.<br />
      <br />
      On my XP box, it fails with "Access Denied" if the secondary logon service is not running, so the only suggestion I have is to make sure that service is running. If I start that service this code works for me:<br />
      PHP Code:</p>
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">outfiletest</span><span style="color: #007700">.</span><span style="color: #0000BB">exe<br />
      requestexecutionleveluser<br />
      pageinstfiles<br />
      section<br />
      initpluginsdir<br />
      SetOutPath$pluginsdir<br />
      File</span><span style="color: #DD0000">"RunAs.dll"<br /></span> <span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #DD0000">"xxxxxx"<br /></span> <span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">2</span><span style="color: #DD0000">"xxxxxx"<br /></span> <span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">3</span><span style="color: #DD0000">"$sysdir\calc.exe"<br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'RunAs::RunAsW(wr1,wr2,wr3,*w.r4)i.r0?u'<br /></span> <span style="color: #0000BB">SetOutPath$temp<br />
      messageboxmb_ok</span><span style="color: #DD0000">"RunAsMessage:$4($0)"<br /></span> <span style="color: #0000BB">sectionend<br /></span></span> <!-- php buffer end -->
      <hr />
      My other suggestion would be to run Process Monitor and see if it gives you any hints (Bad path, access denied etc)
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">happyhippo</span><br />
      <span class="post-time small text-muted">1st February 2011 12:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The secondary logon service is running.<br />
      <br />
      I have also tested your test script and faced the same problem.<br />
      <br />
      Then I have used the Process Monitor to watch the process but did not find any obstacles (but this may be due to my limited knowledge in that area). I have attached the Process Monitor recording, may be one of you can recognise any problem.<br />
      <br />
      My test script looks like the following:<br />
      PHP Code:</p>
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">outfiletest</span><span style="color: #007700">.</span><span style="color: #0000BB">exe<br />
      requestexecutionleveluser<br />
      pageinstfiles<br />
      Section<br />
      initpluginsdir<br />
      SetOutPath$pluginsdir<br />
      File</span><span style="color: #DD0000">"RunAsDll\RunAs.dll"<br /></span> <span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #DD0000">"xxx"<br /></span> <span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">2</span><span style="color: #DD0000">"yyy"<br /></span> <span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">3</span><span style="color: #DD0000">"C:\WINDOWS\NOTEPAD.EXE"<br /></span> <span style="color: #0000BB">MessageBoxMB_OK</span><span style="color: #DD0000">"1:$12:$23:$34:$4"<br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">'RunAs::RunAsW(wr1,wr2,wr3,*w.r4)i.r0?u'<br /></span> <span style="color: #0000BB">MessageBoxMB_OK</span><span style="color: #DD0000">"RunAsMessage:$4($0)"<br /></span> <span style="color: #0000BB">SetOutPath$temp<br />
      SectionEnd<br /></span></span> <!-- php buffer end -->
      <hr />
      The Process Monitor recording was done between the first and the second message box.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">happyhippo</span><br />
      <span class="post-time small text-muted">18th February 2011 08:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have tested it with another machine and recognised that it worked before some patches have been applied, but after the wsus installed some XP and Office updates the error occured. Unfortunatly I was not able to identify the patch, which causes the problem.<br />
      <br />
      Anyhow, part of the RunAs plugin does anybody know another method with NSIS to call a process with another user? Is there maybe a system call that I could use?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">18th February 2011 12:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You could call CreateProcessAsUser/CreateProcessWithLogon etc with the system plugin...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">18th February 2011 14:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I wrote this plug-in quite a while ago: <a href="http://nsis.sourceforge.net/File:RunAs.zip" target="_blank">http://nsis.sourceforge.net/File:RunAs.zip</a><br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">happyhippo</span><br />
      <span class="post-time small text-muted">18th February 2011 15:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for the quick answer.<br />
      @ Afrow UK, I have used your plug-in under XP before, but unfortunatly it did not run under Windows 7.<br />
      <br />
      @ Anders, I have looked at them as well, but as I am not a very good programmer I had some problems to find the right syntax.<br />
      <br />
      However, I think I have found another solution. I am using a freeware tool called runasspc and starting it with an ExecWait command.<br />
      <br />
      This is my new test script:<br />
      <br />
      PHP Code:</p>
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">outfiletest_runasspc</span><span style="color: #007700">.</span><span style="color: #0000BB">exe<br />
      requestexecutionleveluser<br />
      ShowInstDetailsshow<br />
      Pageinstfiles<br />
      <br />
      Section<br />
      SetShellVarContextall<br />
      SetOutPath$APPDATANSIS_Temp<br />
      File</span><span style="color: #DD0000">"runasspc\runasspc.exe"<br /></span> <span style="color: #0000BB">File</span><span style="color: #DD0000">"7_admin.exe"</span><span style="color: #007700">;</span><span style="color: #0000BB">thefileperformstheelevation</span><span style="color: #007700">for</span><span style="color: #0000BB">Windows7</span><span style="color: #007700">and</span><span style="color: #0000BB">somesystemchanges<br />
      <br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #DD0000">"AdminUser"<br /></span> <span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">2</span><span style="color: #DD0000">"Password"<br /></span> <span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">3</span><span style="color: #DD0000">"Domain"<br /></span> <span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">4</span><span style="color: #DD0000">'"$APPDATA\NSIS_Temp\7_admin.exe"'<br /></span> <span style="color: #0000BB">SetDetailsPrintnone</span><span style="color: #007700">;</span><span style="color: #0000BB">inordertohidethepassword<br />
      ExecWait</span><span style="color: #DD0000">'"$APPDATA\NSIS_Temp\runasspc.exe"/user:$1/password:$2/domain:$3/program:$4/quiet'</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      SetDetailsPrintboth<br />
      <br />
      DetailPrint</span><span style="color: #DD0000">"ExecMessage:$0"<br /></span> <span style="color: #0000BB">messageboxmb_ok</span><span style="color: #DD0000">"ExecMessage:$0"<br />
      <br /></span> <span style="color: #0000BB">SetOutPath$APPDATA<br />
      RMDir</span><span style="color: #007700">/</span><span style="color: #0000BB">r</span><span style="color: #007700">/</span><span style="color: #0000BB">REBOOTOK</span><span style="color: #DD0000">"$APPDATA\NSIS_Temp"<br />
      <br />
      <br /></span> <span style="color: #0000BB">SectionEnd<br /></span></span> <!-- php buffer end -->
      <hr />
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
