<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="To NSIS developers (bug)"><title>To NSIS developers (bug) - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">To NSIS developers (bug)</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=184444">To NSIS developers (bug)</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">Penetrat</span><br><span class="post-time small text-muted">24th June 2004 21:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>To NSIS developers (bug)</strong><br>Function<br>CEXEBuild::doCommand(...);//line 793<br>gets pointer to macros storage (m_macros)<br>char *t=(char *)m_macros.get(); //line 815<br>and use this pointer throw the function.<br>If you have a lot of macroses (such as in my case) realloc for m_macros occured (in my case in string: if (str[0]) m_macros.add(str,strlen(str)+1); file script.cpp, line 891), thus t pointed to invalid memory. And code such as<br><i>if (strcmp(t," "))<br>{<br>int ret=process_oneline(t,str,lp);<br>if (ret != PS_OK)<br>{<br>ERROR_MSG("Error in macro %s on macroline %d\n",line.gettoken_str(1),lp);<br>return ret;<br>}<br>}</i><br><b>t+=strlen(t)+1;</b><br>finaly kill nsis:-( Release NSIS compiler work very unstable because of this and debug crush always (because memory marked as 0xEEFE). I think you should check this and another places when such bug can occured.<br>Best regards,<br>Penetrat</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">24th June 2004 21:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Those are not the same variables, they are not in the same scope. The first `t' is in the TOK_P_MACRO block and the second one is in the TOK_P_INSERTMACRO block. The first one is not used after data is added to m_macros.<br><br>If you can reproduce the crash attach an example script and specify the exact version of NSIS you've used. If you've recompiled makensis.exe, specify which compiler you've used.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Penetrat</span><br><span class="post-time small text-muted">25th June 2004 10:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Call stack:<br><br><i>NTDLL! 77f82d4b()<br>NTDLL! 77fac7da()<br>NTDLL! 77f8cf62()<br>NTDLL! 77f5e449()<br>NTDLL! 77f57688()<br>NTDLL! 77fac47f()<br>NTDLL! 77f8ec53()<br>_realloc_base(void * 0x009f8050, unsigned int 98464) line 258 + 22 bytes<br>realloc_help(void * 0x009f8070, unsigned int 98422, int 1, const char * 0x00000000, int 0, int 1) line 649 + 16 bytes<br>_realloc_dbg(void * 0x009f8070, unsigned int 98422, int 1, const char * 0x00000000, int 0) line 824 + 27 bytes<br>realloc(void * 0x009f8070, unsigned int 98422) line 768 + 19 bytes<br>GrowBuf::resize(int 32827) line 63 + 19 bytes<br>GrowBuf::add(const void * 0x00101710, int 35) line 50<br>CEXEBuild::doCommand(int 75, LineParser &amp; {...}) line 892<br>CEXEBuild::doParse(const char * 0x00b70108) line 436 + 16 bytes<br>CEXEBuild::parseScript() line 621 + 20 bytes<br>CEXEBuild::includeScript(char * 0x009e9848) line 663 + 8 bytes<br>CEXEBuild::doCommand(int 69, LineParser &amp; {...}) line 2622 + 15 bytes<br>CEXEBuild::doParse(const char * 0x00a302a8) line 436 + 16 bytes<br>CEXEBuild::parseScript() line 621 + 20 bytes<br>CEXEBuild::includeScript(char * 0x009e95f8) line 663 + 8 bytes<br>CEXEBuild::doCommand(int 69, LineParser &amp; {...}) line 2674 + 15 bytes<br>CEXEBuild::doParse(const char * 0x00a40029) line 436 + 16 bytes<br><b>CEXEBuild::process_oneline(char * 0x009f906f, char * 0x0011dde0, int 3) line 743 + 17 bytes</b><br>CEXEBuild::doCommand(int 77, LineParser &amp; {...}) line 971 + 29 bytes<br>CEXEBuild::doParse(const char * 0x00a181d1) line 436 + 16 bytes<br>CEXEBuild::process_oneline(char * 0x009fc5c2, char * 0x00124c04, int 5) line 743 + 17 bytes<br>CEXEBuild::doCommand(int 77, LineParser &amp; {...}) line 971 + 29 bytes<br>CEXEBuild::doParse(const char * 0x00a000c9) line 436 + 16 bytes<br>CEXEBuild::parseScript() line 621 + 20 bytes<br>CEXEBuild::process_script(_iobuf * 0x004f1328, char * 0x0012d754) line 196 + 8 bytes<br>main(int 2, char * * 0x00931700) line 377 + 25 bytes<br>mainCRTStartup() line 206 + 25 bytes<br>KERNEL32! BaseProcessStart@4 + 35 bytes</i><br><br>Source of stack bold string(<b>CEXEBuild::process_oneline</b>) is<br><i>while (*t)<br>{<br>lp++;<br>if (strcmp(t," "))<br>{<br><b>int ret=process_oneline(t,str,lp);</b><br>if (ret != PS_OK)<br>{<br>ERROR_MSG("Error in macro %s on macroline %d\n",line.gettoken_str(1),lp);<br>return ret;<br>}<br>}<br>t+=strlen(t)+1;<br>}</i><br><br>Local variable is:<br>eip = <b>int ret=process_oneline(t,str,lp);</b> //current instruction<br>m_macros.m_s = 0x009f8070 //ok<br>t = 0x009f906f //ok<br><br>After one debug step:<br>eip = <b>if (ret != PS_OK)</b> //current instruction<br>m_macros.m_s = <font color="red">0x00b82ff8</font> //ok realloc<br>t = 0x009f906f //<b>ERROR! Invalid memory</b><br><br>Next debug step is <b>t+=strlen(t)+1;</b>...I think you made guess whats going to happen...<br><br>P.S. Sorry, cannot attach script, because a lot of large files.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">25th June 2004 11:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks, fixed in latest CVS version.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Penetrat</span><br><span class="post-time small text-muted">25th June 2004 11:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Now I use simple workaround for GrowBuf::resize and all work fine but slowly:-)<br>void resize(int newlen)<br>{<br>m_used = newlen;<br>if (!m_s)<br>{<br>m_alloc = 0x000FFFFF; //1 Mb<br>m_s = calloc (m_alloc, 1);<br>}<br>}<br><br>There are still another bug in the CZlib::Compress<br>(Access violation)<br>Stack:<br><i><br>memcpy(unsigned char * 0x03187acb, unsigned char * 0x00adf0b0, unsigned long 48568) line 272<br>flush_pending(z_stream_s * 0x00a9d8f8) line 298 + 26 bytes<br>deflate_slow(internal_state * 0x00a94868, int 0) line 816 + 93 bytes<br>deflate(z_stream_s * 0x00a9d8f8, int 0) line 380 + 14 bytes<br>CZlib::Compress(int 0) line 22 + 23 bytes<br>CEXEBuild::add_db_data(IMMap * 0x000ea9a0) line 820 + 25 bytes<br>CEXEBuild::do_add_file(const char * 0x00a9d810, int 0, int 0, int 138, int * 0x000ec354, const char * 0x00a9d7df, int 1, int * 0x00000000, int 0) line 5577 + 15 bytes<br>CEXEBuild::doCommand(int 127, LineParser &amp; {...}) line 3983 + 60 bytes<br>CEXEBuild::doParse(const char * 0x047f0044) line 436 + 16 bytes<br>CEXEBuild::process_oneline(char * 0x01ea1123, char * 0x000f4908, int 138) line 743 + 17 bytes<br>CEXEBuild::doCommand(int 77, LineParser &amp; {...}) line 971 + 29 bytes<br>CEXEBuild::doParse(const char * 0x044c0042) line 436 + 16 bytes<br>CEXEBuild::process_oneline(char * 0x01ea149c, char * 0x000fb72c, int 4) line 743 + 17 bytes<br>CEXEBuild::doCommand(int 77, LineParser &amp; {...}) line 971 + 29 bytes<br>CEXEBuild::doParse(const char * 0x04080041) line 436 + 16 bytes<br>CEXEBuild::process_oneline(char * 0x01ea17c0, char * 0x00102550, int 3) line 743 + 17 bytes<br>CEXEBuild::doCommand(int 77, LineParser &amp; {...}) line 971 + 29 bytes<br>CEXEBuild::doParse(const char * 0x03c40041) line 436 + 16 bytes<br>CEXEBuild::process_oneline(char * 0x01ea1860, char * 0x00109374, int 2) line 743 + 17 bytes<br>CEXEBuild::doCommand(int 77, LineParser &amp; {...}) line 971 + 29 bytes<br>CEXEBuild::doParse(const char * 0x03a20042) line 436 + 16 bytes<br>CEXEBuild::process_oneline(char * 0x01ea6bd1, char * 0x00110198, int 59) line 743 + 17 bytes<br>CEXEBuild::doCommand(int 77, LineParser &amp; {...}) line 971 + 29 bytes<br>CEXEBuild::doParse(const char * 0x036f0043) line 436 + 16 bytes<br>CEXEBuild::process_oneline(char * 0x01e81645, char * 0x00116fbc, int 9) line 743 + 17 bytes<br>CEXEBuild::doCommand(int 77, LineParser &amp; {...}) line 971 + 29 bytes<br>CEXEBuild::doParse(const char * 0x02700041) line 436 + 16 bytes<br>CEXEBuild::process_oneline(char * 0x01e8235e, char * 0x0011dde0, int 5) line 743 + 17 bytes<br>CEXEBuild::doCommand(int 77, LineParser &amp; {...}) line 971 + 29 bytes<br>CEXEBuild::doParse(const char * 0x022c0042) line 436 + 16 bytes<br>CEXEBuild::process_oneline(char * 0x01e84612, char * 0x00124c04, int 6) line 743 + 17 bytes<br>CEXEBuild::doCommand(int 77, LineParser &amp; {...}) line 971 + 29 bytes<br>CEXEBuild::doParse(const char * 0x01a40041) line 436 + 16 bytes<br>CEXEBuild::parseScript() line 621 + 20 bytes<br>CEXEBuild::process_script(_iobuf * 0x004f1328, char * 0x0012d754) line 196 + 8 bytes<br>main(int 2, char * * 0x00931390) line 377 + 25 bytes<br>mainCRTStartup() line 206 + 25 bytes<br>KERNEL32! BaseProcessStart@4 + 35 bytes<br></i><br><br>Maybe also memory allocation/reallocation problem.<br>Compiler environment MSVC 6.0 Sp 5, Platform SDK November 2001 (old, but good:-), because old version idl compiler).<br><br>P.S. If you want I can send memory dump (for WinDbg).</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">25th June 2004 11:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Why fix it that way? I've already fixed it in the latest CVS version. Grab script.cpp from CVS and compile.<br><br>Memory dump would help. Stack trace alone doesn't help much here.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Penetrat</span><br><span class="post-time small text-muted">25th June 2004 13:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks! Fix work. Bug with CZlib::Compress didn't reproduce on latest sources but reproduce when I replace GrowBuf::resize as mentioned above. IMHO possible reasons uninitialize variable or memory somewhere used. I can't attach dump (0,5 mb. zip), because size restriction. Please, let me know how I can send this file to you (if you are still interested in).</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">25th June 2004 13:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">If it's caused by your change to resize, I'm not intereseted in it. It probably went over your 1mb buffer.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Penetrat</span><br><span class="post-time small text-muted">25th June 2004 13:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Ok. Thanks a lot to kichik. Case is closed.</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>