<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="system::call crypt32::CertNameToStr" />

  <title>system::call crypt32::CertNameToStr - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">system::call crypt32::CertNameToStr</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=313983">system::call crypt32::CertNameToStr</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bfek-18</span><br />
      <span class="post-time small text-muted">19th October 2009 09:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>system::call crypt32::CertNameToStr</strong><br />
      Hi,<br />
      <br />
      I want a function from the field crypt32 benefit.<br />
      <br />
      From these links i have the suggestions.<br />
      <br />
      <a href="http://nsis.sourceforge.net/Import_Root_Certificate" target="_blank">http://nsis.sourceforge.net/Import_Root_Certificate</a><br />
      <a href="http://forums.winamp.com/showthread.php?threadid=309032&amp;highlight=certificate" target="_blank">http://forums.winamp.com/showthread....ht=certificate</a><br />
      <br />
      I would like to use this function: crypt32::CertNameToStr<br />
      <br />
      here is this function in c :<br />
      <br />
      //-----------------------------------------------------------<br />
      // Convert the subject name to an ASN.1 encoded<br />
      // string and print the octets in that string.<br />
      <br />
      // First : Get the number of bytes that must<br />
      // be allocated for the string.<br />
      <br />
      cbSize = CertNameToStr(<br />
      pCertContext-&gt;dwCertEncodingType,<br />
      &amp;(pCertContext-&gt;pCertInfo-&gt;Subject),<br />
      MY_STRING_TYPE,<br />
      NULL,<br />
      0);<br />
      <br />
      Here's my attempt with system::call functions<br />
      <br />
      ; $2 pointer to the next certificate<br />
      ;<br />
      ; extracted from struct # <a href="http://msdn.microsoft.com/en-us/library/aa377189%28VS.85%29.aspx" target="_blank">http://msdn.microsoft.com/en-us/libr...8VS.85%29.aspx</a><br />
      ;<br />
      System::Call "*$2(i .r5,,,i .r6,)"<br />
      ; extracted from struct # <a href="http://msdn.microsoft.com/en-us/library/aa377200%28VS.85%29.aspx" target="_blank">http://msdn.microsoft.com/en-us/libr...8VS.85%29.aspx</a><br />
      ;<br />
      System::Call "*$6(,,,,,,i .r7,,,,,,)"<br />
      System::Call "crypt32::CertNameToStr(i r5,i r7, i 3,i 0,i 0) i.r3"<br />
      <br />
      unfortunately without success.<br />
      <br />
      Any hints are very wellcome.<br />
      (sorry for my poor english)<br />
      Uwe</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Zinthose</span><br />
      <span class="post-time small text-muted">19th October 2009 15:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">/sigh...<br />
      <br />
      I doubt many people will help you since your request very suspicious.<br />
      <br />
      Your forum account is brand new and your asking to perform a task that exploits a known security vulnerability in Windows.<br />
      <br />
      <a href="http://www.microsoft.com/technet/security/bulletin/ms09-056.mspx" target="_blank">http://www.microsoft.com/technet/sec.../ms09-056.mspx</a><br />
      http://www.microsoft.com/technet/security/bulletin/ms09-056.mspx</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">bfek-18</span><br />
      <span class="post-time small text-muted">19th October 2009 20:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Re: system::call crypt32::CertNameToStr</strong><br />
      Hallo Zinthose,<br />
      <br />
      Thank you for your notice.My question is, in this respect quite harmless.<br />
      I want my current NSIS script easier.<br />
      <br />
      This is my current way, to read the issuer from the certificate store.<br />
      <br />
      ; snip<br />
      !define RegCertKey "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\SystemCertificates\My\Certificates"<br />
      GetTempFileName $9<br />
      ExecDos::exec 'regedit /e $9 ${RegCertKey}' "" ""<br />
      ; snip<br />
      <br />
      Then search with "BinStrSearch" in this file to find the issuer name.<br />
      This whole to simplify is my goal.<br />
      <br />
      Uwe</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">f0rt</span><br />
      <span class="post-time small text-muted">20th October 2009 22:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">This could be done like shown in the following script (based on the script referred by you in your first post of this thread):<br />
      PHP Code:</p>
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">OutFile</span><span style="color: #DD0000">"cert.exe"<br />
      <br /></span> <span style="color: #007700">!include</span><span style="color: #DD0000">"LogicLib.nsh"<br />
      <br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">defineCERT_STORE_CERTIFICATE_CONTEXT1<br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">defineCERT_NAME_ISSUER_FLAG1<br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">defineCERT_NAME_SIMPLE_DISPLAY_TYPE4<br />
      <br /></span> <span style="color: #007700">Function</span><span style="color: #0000BB">display_certs<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Saveregisters<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Opensystemcertificatestoreofcertificationauthorities<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"crypt32::CertOpenSystemStore(i0,t'MY')i.r1"<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">1</span><span style="color: #007700">!=</span><span style="color: #0000BB">0<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">20<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Loopthroughcertificatestore<br /></span> <span style="color: #007700">${Do}<br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"crypt32::CertEnumCertificatesInStore(ir1,ir2)i.r2"<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">2</span><span style="color: #007700">!=</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Getsubjectofcertificate<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"crypt32::CertGetNameString(ir2,\\<br />
      i${CERT_NAME_SIMPLE_DISPLAY_TYPE},i0,i0,\\<br />
      t.r4,i${NSIS_MAX_STRLEN})i.r3"<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">3</span><span style="color: #007700">!=</span><span style="color: #0000BB">0<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #DD0000">"Subject:$4$\\r$\\n"<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Getissuerofcertificate<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"crypt32::CertGetNameString(ir2,\\<br />
      i${CERT_NAME_SIMPLE_DISPLAY_TYPE},\\<br />
      i${CERT_NAME_ISSUER_FLAG},i0,\\<br />
      t.r4,i${NSIS_MAX_STRLEN})i.r3"<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">3</span><span style="color: #007700">!=</span><span style="color: #0000BB">0<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #DD0000">"$0Issuer:$4"<br /></span> <span style="color: #007700">${EndIf}<br /></span> <span style="color: #0000BB">MessageBoxMB_OK</span><span style="color: #DD0000">"$0"<br /></span> <span style="color: #007700">${EndIf}<br />
      ${Else}<br />
      ${</span><span style="color: #0000BB">ExitDo</span><span style="color: #007700">}<br />
      ${EndIf}<br />
      ${</span><span style="color: #0000BB">Loop</span><span style="color: #007700">}<br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"crypt32::CertCloseStore(ir1,i0)"<br /></span> <span style="color: #007700">${EndIf}<br />
      <br />
      ;</span><span style="color: #0000BB">Restoreregisters<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      FunctionEnd<br />
      <br /></span> <span style="color: #007700">Function.</span><span style="color: #0000BB">onInit<br />
      InitPluginsDir<br />
      Calldisplay_certs<br />
      Quit<br />
      FunctionEnd<br />
      <br />
      Section<br />
      SectionEnd<br /></span></span> <!-- php buffer end -->
      <hr />
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
