<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Crypto Plugin"><title>Crypto Plugin - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Crypto Plugin</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=178991">Crypto Plugin</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">GAG</span><br><span class="post-time small text-muted">5th May 2004 07:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Crypto Plugin</strong><br>Introduction<br><br><br>This plugin provides you cryptographic interface using CryptoAPI.<br>Using this plugin you can get common cryptographic hashes like MD5, SHA1, MD2, MD4.<br><br>Plugin DLL size: 3 660 bytes (not packed), 2 886 bytes (upx packed)<br><br><br>How to use<br><br>1. Hash of string<br><br>Crypto::HashData "MD5" "String to be hashed"<br>Pop $0<br><br><br>Supported algorithms: MD5|SHA1|MD2|MD4<br><br>2. Hash of file<br><br>Crypto::HashFile "MD5" "$WINDIR\notepad.exe"<br>Pop $0<br><br><br>Supported algorithms: MD5|SHA1|MD2|MD4<br><br>Examples<br><br>Hash Calculator: HashCalc.nsi<br>Simple test: CryptoTest.nsi</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">GAG</span><br><span class="post-time small text-muted">5th May 2004 08:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Hash Calculator based on Crypto.dll</strong><br>Hash Calculator:<br>Example usage of Crypto plugin</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">CryptoNut</span><br><span class="post-time small text-muted">22nd November 2005 07:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>SHA-256</strong><br>Will this possibly support SHA-256 in the future?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">{ truparu }</span><br><span class="post-time small text-muted">22nd November 2005 14:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Great Plugin!</strong><br>Great Plugin :) Is there source available for this plugin anywhere?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">GAG</span><br><span class="post-time small text-muted">22nd November 2005 18:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">CryptoNut<br>Hashing realized via Microsoft CryptoAPI, so if CryptoAPI supports such algo, this algo is supported by plugin too. SHA-1 is already supported.<br><br><a href="http://msdn.microsoft.com/library/en-us/seccrypto/security/cryptcreatehash.asp" target="_blank">http://msdn.microsoft.com/library/en...createhash.asp</a><br><br>{ truparu }<br>Thank you!<br>Yep, source will be available, when I'll rewrote it from scratch ;) coz I lost my sources ;) [no backup while crash... as always]</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">marcpeterson</span><br><span class="post-time small text-muted">16th December 2005 03:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>CryptAcquireContext error 0x80090016</strong><br>I've used this dll on my development system without a problem. But when I run the installer on some other systems, I get a CryptAcquireContext error 0x80090016.<br><br>I did a bit of digging and found this:<br><a href="http://support.microsoft.com/default.aspx?scid=kb%3Ben-us%3B238187" target="_blank">http://support.microsoft.com/default...en-us%3B238187</a><br><br>Do you know if your check for the NTE_BAD_KEYSET as it states on this line?<br><br></p><pre>
<code>if (GetLastError() == NTE_BAD_KEYSET)</code>
</pre><br><br>What are the chances of a new version coming out any time soon? Thanks,<br><br>Marc</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">GAG</span><br><span class="post-time small text-muted">23rd December 2005 18:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hi, Marc<br>I know about CryptAcquireContext error 0x80090016<br>It's not related to link you posted.<br>I used enhanced crypto provider instead of basic one. On some OS enhanced version isn't installed (due to old stupid export limitations or on Win98 w/o IE6 with strong crypto support)<br>New version of this plugin will be published when I rewrote it from scratch :)<br>as i already said in prev post, I lost my sources.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">sag47</span><br><span class="post-time small text-muted">13th August 2007 02:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><i>Originally posted by GAG</i><br><b>Hi, Marc<br>I know about CryptAcquireContext error 0x80090016<br>It's not related to link you posted.<br>I used enhanced crypto provider instead of basic one. On some OS enhanced version isn't installed (due to old stupid export limitations or on Win98 w/o IE6 with strong crypto support)<br>New version of this plugin will be published when I rewrote it from scratch :)<br>as i already said in prev post, I lost my sources.</b></blockquote>When you rewrite it can you include support for Whirlpool algorithm possibly? Also your installer puts the documentation in the wrong place. It goes in NSISDIR/Docs/Crypto and the source code (when you rewrite it) should go in NSISDIR/Contrib/Crypto.<br>SAM</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">sag47</span><br><span class="post-time small text-muted">13th August 2007 07:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Re: SHA-256</strong><br></p><blockquote><i>Originally posted by CryptoNut</i><br><b>Will this possibly support SHA-256 in the future?</b></blockquote>http :// msdn2. microsoft. com/en-us/library/ms937738.aspx<br>(had to link this way because now this forum has some dumb link approval system)<br><br>Take out the spaces and you'll have your link.<br>That is all of the supported hash algorithms supported by the CryptAPI.<br><br>I've also added a link in the plugin's wiki page on nsis.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">sag47</span><br><span class="post-time small text-muted">13th August 2007 07:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hi GAG,<br>Hopefully this little snippet will help you rewrite your code faster. Here is a code example I downloaded from another community I belong to that uses the CryptoAPI.<br>SAM</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">sag47</span><br><span class="post-time small text-muted">13th August 2007 08:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Here is a slightly modified version of the the one above.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">GAG</span><br><span class="post-time small text-muted">15th August 2007 12:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>CryptoAPI Plugin NEWS</strong><br>Hi sag47<br><br>Thank you for you support and updated NSIS Wiki page about my plugin.<br><br></p><blockquote>When you rewrite it can you include support for Whirlpool algorithm possibly?</blockquote>Whirlpool isn't included in any CrypoAPI implementation, so it can be implemented only using non-CryptoAPI method. If you can explain why Whirlpool is better than SHA-256|512, I'll try to add this algo.<br><br><blockquote>Also your installer puts the documentation in the wrong place.</blockquote>ok, will be placed in accordance to NSIS folder structure<br><br><blockquote>That is all of the supported hash algorithms supported by the CryptAPI.</blockquote>just check <a href="http://msdn2.microsoft.com/en-us/library/aa375549.aspx" target="_blank">ALG_ID at MSDN</a> and you'll see this note above CALG_SHA_256:<br><b>Windows XP and Windows 2000/NT:</b>: This algorithm is <u>not supported</u>.<br><br>the only way to include support for SHA &gt;=256 bits is to create a CryptoAPI-independent implementation which will increase plugin size (I do not really care about disk space anymore :)<br><br>well, I'll try to find more time now to implement some of your wishes ;)<br><br>P.S. url tag needs to be approved? (see above)<br>P.P.S. ALG_ID at MSDN: http://msdn2.microsoft.com/en-us/library/aa375549.aspx</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">********</span><br><span class="post-time small text-muted">23rd February 2008 16:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Well, the plug is broken not only on 98, but on 2000 as well.<br><br>CryptAcquireContext=0x80090016</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">GAG</span><br><span class="post-time small text-muted">23rd February 2008 17:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">what do you mean 'broken' ?<br>plugin was developed on Win2k sp4 and it works OK on many systems</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">sag47</span><br><span class="post-time small text-muted">25th February 2008 15:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Why was this added to the Wiki?<br></p><pre>
<code>Note that it will likely to fail with CryptAcquireContext=0x80090016 error on systems prior to WinXP.</code>
</pre><br><a href="http://nsis.sourceforge.net/mediawiki/index.php?title=Crypto_plug-in&amp;diff=14789&amp;oldid=12942" target="_blank">http://nsis.sourceforge.net/mediawik...89&amp;oldid=12942</a><br>At the moment there doesn't appear to be sufficient research to indicate this problem with the exception of one person whose configuration could itself possibly be broken.<br><br>I just tested the cryto 1.1 with the following script test using NSIS v2.34 on Windows 2000 SP4 user privileges only.<br><pre>
<code> Crypto::HashFile "MD5"  "$WINDIR\notepad.exe"<br> Pop $0<br> MessageBox MB_OK $0</code>
</pre><br>
      The message returned was null and no hash was return yet I didn't get the error like the user above specified so I think before the wiki is edited that further testing is required.<br>
      SAM
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">sag47</span><br>
      <span class="post-time small text-muted">25th February 2008 15:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by ********</i><br>
        <b>Well, the plug is broken not only on 98, but on 2000 as well.<br>
        <br>
        CryptAcquireContext=0x80090016</b>
      </blockquote>Provide more specs as to how you got that error. Just saying "it's broken" doesn't help with anything. I can't (or don't know how) to produce that error. Please provide the following:

      <ul>
        <li>Example of the code used to produce error</li>

        <li>OS and service pack version (of all systems tested on)</li>

        <li>user privileges on those systems</li>

        <li>Any other valuable information that you think would lead to producing the error and/or fixing the problem.</li>
      </ul>Thanks,<br>
      SAM
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">********</span><br>
      <span class="post-time small text-muted">10th March 2008 13:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Simply launched HashCalc.exe<br>
      Windows2000 SP4<br>
      Local Administrator<br>
      No domain</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">GAG</span><br>
      <span class="post-time small text-muted">12th March 2008 09:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>NTE_BAD_KEYSET error</strong><br>
      Workaround for NTE_BAD_KEYSET error will be added.<br>
      Anyway I do not understand, why someone named Techtonik added to wiki article his note about mentioned error in Introduction (!!!) section. If you want to say that it doesn't work on your system, do it in Remarks section, but in Introduction, please.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">sag47</span><br>
      <span class="post-time small text-muted">3rd April 2008 15:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Re: NTE_BAD_KEYSET error</strong><br></p>

      <blockquote>
        <i>Originally posted by GAG</i><br>
        <b>Workaround for NTE_BAD_KEYSET error will be added.<br>
        Anyway I do not understand, why someone named Techtonik added to wiki article his note about mentioned error in Introduction (!!!) section. If you want to say that it doesn't work on your system, do it in Remarks section, but in Introduction, please.</b>
      </blockquote>I don't know how to revert the history of the Wiki (hopefully you do GAG?). I've tried to figure it out with no luck. I'd prefer that the Note it will fail message in the Introduction stay out until whether or not this is a OS wide problem is figured out.<br>
      SAM
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">7wolves</span><br>
      <span class="post-time small text-muted">15th May 2008 09:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>who can tell me how I can get the source code? Thanks</strong><br>
      Who can tell me how I can get the source code?<br>
      BTW, I encountered CryptAcquireContext=0x80090016 error in one of my machines with winxp sp2.<br>
      Thanks</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Animaether</span><br>
      <span class="post-time small text-muted">18th March 2009 03:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">just gonna cross-reference a post made to a wrong thread here:<br>
      <a href="http://forums.winamp.com/showthread.php?postid=2497982#post2497982" target="_blank">http://forums.winamp.com/showthread....82#post2497982</a><br>
      <br>
      A user saw some odd behavior from the Crypto plugin, in that the Popped value appears empty, while $0 contains the actual result;<br>
      [quote]I'd guess that nothing actually gets set on the stack (as the Pop results in the Errors flag being set) and instead the Crypto plugin dumps its result in $0 directly. Not a huge issue (although not encouraged), but something that should probably be noted in the docs.[/code]</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">GAG</span><br>
      <span class="post-time small text-muted">18th March 2009 13:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">see sample script CryptoTest.nsi:<br>
      <br></p>
      <pre>
<code><br>SubSection /e "SHA1"<br>Section "String Data"<br>  SectionIn 1 2<br>  DetailPrint "${Sep01}"<br>  DetailPrint "SHA1 String Hash"<br>  DetailPrint ""<br>  DetailPrint "Crypto::HashData 'SHA1' '${HashStr}'"<br>  Crypto::HashData "SHA1" "${HashStr}"<br>  <b>Pop $0</b><br>  DetailPrint "Result:"<br>  DetailPrint "String: '${HashStr}'"<br>  DetailPrint "SHA1: [$0]"<br>  DetailPrint ""<br>SectionEnd<br></code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Animaether</span><br>
      <span class="post-time small text-muted">18th March 2009 13:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">GAG:<br>
      <br></p>
      <pre>
<code><br>        StrCpy $0 "D0"<br>        StrCpy $1 "D1"<br>        Crypto::HashFile "MD5" "$WINDIR\notepad.exe"<br>        ClearErrors<br>        Pop $1<br>        ${If} ${Errors}<br>                MessageBox MB_OK "Pop error!"      <br>        ${EndIf}<br>        MessageBox MB_OK "[$0][$1]"<br></code>
</pre><br>
      Throws the Pop error messagebox, and the 2nd messagebox shows that $1 still reads "D1", while $0 shows the MD5 hash.
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">sag47</span><br>
      <span class="post-time small text-muted">8th September 2009 15:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        CryptAcquireContext=0x80090016
      </blockquote>Here is an MSDN article that describes the CryptAcquireContext error codes.<br>
      <br>
      <a href="http://support.microsoft.com/kb/238187" target="_blank">http://support.microsoft.com/kb/238187</a><br>
      <br>
      Thought that would help with further development. Specifically with that error:<br>

      <blockquote>
        NTE_BAD_KEYSET (0x80090016)

        <ul>
          <li>Key container does not exist.</li>

          <li>You do not have access to the key container.</li>

          <li>The Protected Storage Service is not running.</li>
        </ul>
      </blockquote>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">nvit</span><br>
      <span class="post-time small text-muted">11th November 2010 14:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I got CryptAcquireContext=0x80090016 error on 3 of 5 machines with Win XP SP3.<br>
      The errors can be shown just by HashCalc.exe.<br>
      Is there some workaround?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">nvit</span><br>
      <span class="post-time small text-muted">11th November 2010 15:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Crypto plugin has a bug. It's 100%.<br>
      So I've replaced it by <a href="http://nsis.sourceforge.net/MD5_plugin" target="_blank">MD5 plugin</a></p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">sag47</span><br>
      <span class="post-time small text-muted">12th November 2010 17:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for posting an alternative. The source appears to be lost for the Crypto Plugin so I don't know if the bug will ever be fixed. I'm not the original creator.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jdpipe</span><br>
      <span class="post-time small text-muted">27th March 2011 10:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Broken plugin</strong><br>
      This plugin fails for me on Windows 7 using the provided 'HashCalc' example. The error NTE_BAD_KEYSET (0x80090016) is given. I built the installer and also tested the resulting HaskCalc on Windows XP and I get the same error.<br>
      <br>
      So I conclude that something might have changed in Windows Crypto and this plugin for NSIS is now completely unusable unless someone works out how to fix it.<br>
      <br>
      Update: it may be that users outside the United States see this error only, if this is something to do with the plugin depending on a hobbled version of some Windows DLL that doesn't provide the required functionality...?</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>