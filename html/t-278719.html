<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="NSIS Start Menu problem"><title>NSIS Start Menu problem - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">NSIS Start Menu problem</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=278719">NSIS Start Menu problem</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">eoin</span><br><span class="post-time small text-muted">11th October 2007 17:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>NSIS Start Menu problem</strong><br>Hi,<br><br>I'm writing an installer for an application that customers may want to install multiple times.<br><br>I'm trying to check the install directory and start menu folder to ensure that the customer does not overwrite an existing installation (they can't anyway as the installer has overwrite is set to off - but I want a visible warning and the ability to change the install dir)<br><br>I use the pre and leave functions with MUI to check the selected install dir and start menu folder. The former works fine - $INSTDIR gets the value of the selected install dir and the LEAVE function uses that in its test. However, but the start menu checks don't work as the path entered in the start menu dialog doesn't get written into the start menu variable (MUI_PAGE_STARTMENU page_id variable)<br><br>The attached file is a stripped down version of the installer - it's just intended to show the problem.<br><br>To test it:<br>1. Create a folder call Batch in the same folder as the script. Put a few files in it.<br>2. Compile the script<br>3. Run the resulting setup - the app gets installed in the default install dir and start menu folder.<br>4. Run the setup again.<br>5. If you specify the default install dir you'll get a warning.<br>6. Change the install dir - that works ok.<br>7. Specify the default start menu folder - again you get a warning.<br>8. Change the start menu folder. The changed value does not get picked up.<br>9. Click on the back button and then on the Next button. This time the value of the start menu folder is correctly picked up by the installer.<br><br>Am I doing something wrong?<br>If not, is there a workaround?<br><br>I tried an invisble custom installer page directly after the start menu page. This picked up the user-specified value of the start menu folder but I couldn't work out how to send the installer back to the start menu page (so user could reenter start menu folder value)<br><br>I also tried the getDlgValue to get the control id the page element that contains the start menu folder string - but there doesn't seem to be a method for reading the actual value when you know the control id.<br><br>Finally, had a look inside system.nsh in NSIS\Contrib\Modern UI. Can't see where the dialog value for the start menu folder is picked up.<br><br>Thanks,<br>Eoin</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">eoin</span><br><span class="post-time small text-muted">12th October 2007 15:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Got a workaround<br><br>1. Got the RelGotoPage function from <a href="http://nsis.sourceforge.net/Go_to_a_NSIS_page#Modern_UI" target="_blank">http://nsis.sourceforge.net/Go_to_a_NSIS_page#Modern_UI</a><br><br>2. After the start menu page, created another MUI_PAGE_DIRECTORY page - and gave it a custom PRE function.<br>That PRE function looks like:<br><br>Function CheckStartMenuFolder<br><br>MessageBox MB_OK "Inventory type: $INVENTORY_TYPE"<br><br>ReadRegStr $1 "${STARTMENUPAGE_REGISTRY_ROOT}" "${STARTMENUPAGE_REGISTRY_KEY}" "${STARTMENUPAGE_REGISTRY_VALUENAME}"<br><br>MessageBox MB_OK "Selected Start Menu: $STARTMENU_FOLDER"<br>MessageBox MB_OK "Existing Start Menu folder: $1"<br><br>${if} $1 == $STARTMENU_FOLDER<br>MessageBox MB_OK "There is already an asset gateway using this Start Menu folder.$\nChoose another location for this installation or uninstall the existing gateway."<br>; Go back a page (to the start menu page)<br>StrCpy $R9 -1<br>Call RelGotoPage<br>Abort<br>${Else}<br>; Go forward a page (skip this page)<br>StrCpy $R9 1<br>Call RelGotoPage<br>Abort<br>${EndIf}<br>FunctionEnd<br><br>The extra MUI_PAGE_DIRECTORY page never appears. You either go back to the start menu page or forward to the next page.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">eoin</span><br><span class="post-time small text-muted">12th October 2007 15:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Um, best not to use MUI_PAGE_DIRECTORY as the extra, invisible page. It seems to clear the install folder value entered earlier in the real, visible MUI_PAGE_DIRECTORY.<br><br>Switched to using MUI_PAGE_WELCOME instead. That works ok.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">12th October 2007 16:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Just use Page Custom CustomDummy for an invisible page.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">eoin</span><br><span class="post-time small text-muted">15th October 2007 15:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Ok - works nicely. Thanks!</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>