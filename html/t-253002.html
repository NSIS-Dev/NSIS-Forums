<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="EnumRegKey - infinite loop on some Win98 machine, but not others?" />

  <title>EnumRegKey - infinite loop on some Win98 machine, but not others? - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">EnumRegKey - infinite loop on some Win98 machine, but not others?</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=253002">EnumRegKey - infinite loop on some Win98 machine, but not others?</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">beano_okc</span><br />
      <span class="post-time small text-muted">10th August 2006 18:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>EnumRegKey - infinite loop on some Win98 machine, but not others?</strong><br />
      I need to enumerate Outlook profiles on Windows 98 machines as part of my NSIS script. I have 42 machines as an initial group I'm working with, and of the 42, I had 6 that went into an infinite loop when trying to enumerate "HKCU\Software\Microsoft\Windows Messaging Subsystem\Profiles". I can't see anything different on these machines, they all have anywhere from 1 to 7-8 Outlook profiles configured. I'm doing some testing on one of the machines and can't determine why this loops endlessly:<br />
      <br />
      Machine has only one Outlook profile, "GTriplett", so beneath Profiles in the registry, that is the only key present, and should therefore be the only key EnumRegKey sees before it returns an empty string or errors out. I've added some debugging stuff (well, attempt at debugging) to the loop so I can see the condition of variables and whatnot via DetailPrint, but I'm stumped.<br />
      <br />
      The NSIS loop is (debugging stuff is still in it):<br />
      <br />
      --------------------------------<br />
      ; First build a stack of Outlook profiles<br />
      StrCpy $1 0<br />
      StrCpy $2 0<br />
      DetailPrint "Building a list of Outlook profiles..."<br />
      loop_getprofs:<br />
      ClearErrors<br />
      DetailPrint "Var 1 is $1, now reading registry"<br />
      EnumRegKey $1 HKCU "Software\Microsoft\Windows Messaging Subsystem\Profiles" $2<br />
      IfErrors getprof_error<br />
      StrCmp $1 "" done_getprofs<br />
      Push $1<br />
      DetailPrint " $2. $1"<br />
      IntOp $2 $2 + 1<br />
      StrCpy $1 0<br />
      StrCmp $2 30 EndIt<br />
      Goto loop_getprofs<br />
      <br />
      getprof_error:<br />
      DetailPrint "Ran into an error reading HKCU\Sofware\MS\WMS\Profiles at index $2"<br />
      done_getprofs:<br />
      -----------------------------------<br />
      <br />
      <br />
      The Details window of NSIS shows this:<br />
      <br />
      ----------------------------------------<br />
      Building a list of Outlook profiles...<br />
      Var 1 is 0, now reading registry<br />
      0. GTriplett<br />
      Var 1 is 0, now reading registry<br />
      1. GTriplett<br />
      Var 1 is 0, now reading registry<br />
      2. GTriplett<br />
      Var 1 is 0, now reading registry<br />
      3. GTriplett<br />
      --- snip ---<br />
      Var 1 is 0, now reading registry<br />
      28. GTriplett<br />
      Var 1 is 0, now reading registry<br />
      29. GTriplett<br />
      Completed<br />
      ------------------------------------<br />
      <br />
      So you can see that $2 is incrementing, and therefore EnumRegKey is being told to read an incrementing index, yet it always returns "GTriplett", and will loop infinitely on it. The majority of my machines went just fine, is this a bug in EnumRegKey, or registry corruption, or... any other ideas?<br />
      <br />
      Thanks very much,<br />
      Mark</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">beano_okc</span><br />
      <span class="post-time small text-muted">10th August 2006 23:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>update</strong><br />
      As an update, it appears that on the Windows 98 machines where I saw an issue, that I can enumerate *any* registry key and get an infinite loop. I am very definitely incrementing the key index with IntOp, and echoing the registry key name, and can see that the script goes through the values as you would expect, listing each one individually. When it exhausts the keys, though, it just keeps listing the last key it hit, over and over, and the key index just keeps climbing from the IntOp (the line in my script snippet above, "DetailPrint $2. $1" is showing me the key index and the result of that particular enumeration).<br />
      <br />
      Has anyone else run into something like this? Is there some update to Windows that these machines have missed, and they have a broken API "RegEnumKey" function?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">19th August 2006 14:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Run the attached executable on a machine which shows this behavior and let me know what is the result you get from it. It will call RegEnumKey with an index above the number of available subkeys and show the result.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
