<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="SetShellVarContext all --&gt; $DOCUMENTS" />

  <title>SetShellVarContext all --&gt; $DOCUMENTS - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">SetShellVarContext all --&gt; $DOCUMENTS</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=248693">SetShellVarContext all --&gt; $DOCUMENTS</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">lievencardoen</span><br />
      <span class="post-time small text-muted">14th June 2006 10:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>SetShellVarContext all --&gt; $DOCUMENTS</strong><br /></p>
      <pre>
<code>SetShellVarContext all<br />MessageBox MB_OK $DOCUMENTS</code>
</pre><br />
      <br />
      This still shows the path to my local user documents and not to all users documents...<br />
      <br />
      Why? I'm working on Windows XP SP2, so this should work, as all users folder does exist...<br />
      <br />
      Lieven
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br />
      <span class="post-time small text-muted">14th June 2006 11:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Strange, I am also getting the same ...<br />
      CF</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">14th June 2006 15:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">works for me (XP SP2 MCE2k5)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">lievencardoen</span><br />
      <span class="post-time small text-muted">14th June 2006 15:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well, apparently it is not to be trusted...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JeronimoColon</span><br />
      <span class="post-time small text-muted">15th June 2006 23:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Any word on this? I'm experiencing the same problem.<br />
      All the PCs I'm testing this on are Windows XP SP2.<br />
      <br />
      I created a sample install and all it does is:<br />
      SetShellVarContext all<br />
      DetailPrint "All DOCUMENTS: $DOCUMENTS"<br />
      <br />
      SetShellVarContext current<br />
      DetailPrint "Current DOCUMENTS: $DOCUMENTS"<br />
      <br />
      On some PC it behaves correctly but on others this is what I get:<br />
      All DOCUMENTS: C:\Documents and Settings\jcolon\My Documents<br />
      Current DOCUMENTS: C:\Documents and Settings\jcolon\My Documents<br />
      Completed<br />
      <br />
      I cant seem to figure out what's different between all these PCs. I'll keep checking and post back if I find anything.<br />
      <br />
      jc3</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br />
      <span class="post-time small text-muted">15th June 2006 23:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have tried your example code, and it dosen't seem to work. I have tried it with $DESKTOP, $VIDEOS, $MUSIC, and $PICTURES, and these all work. Could be a bug that has not been fixed (or windows has changed the way the 'My Documents' folder is stored :().</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Comperio</span><br />
      <span class="post-time small text-muted">16th June 2006 00:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">hmm... mine works fine. I have XP pro SP2.<br />
      <br />
      Out of curiosity, on those machines that have the problem,<br />
      what version of Windows XP is being used? (Home, pro, media edition, 64-bit, etc.)<br />
      <br />
      And when you're in windows Explorer, do you have a 'shared documents' folder? If so, I presume that takes you to the 'all users' folder (ie C:\documents and settings\all users\documents)?<br />
      <br />
      <b>[edit]</b><br />
      I found this blog that talks about problems with the 'shared documents' folder:<br />
      <a href="http://blogs.msdn.com/jmazner/archive/2005/01/29/363160.aspx" target="_blank">http://blogs.msdn.com/jmazner/archiv...29/363160.aspx</a><br />
      <br />
      And this article about how to disable the 'shared documents' folder by editing the registry:<br />
      <a href="http://www.winguides.com/registry/display.php/1220/" target="_blank">http://www.winguides.com/registry/display.php/1220/</a><br />
      <br />
      (Just thinking that if maybe the shared documents folder has been disabled, you can reverse to 're-enable' it.)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">16th June 2006 00:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That just removes them from "my computer". BTW I'm running as a restricted user and it still works</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br />
      <span class="post-time small text-muted">16th June 2006 02:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have XP Pro SP1 x86(haven't tried it yet) at home and the college computers are XP Pro SP2 x86.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">lievencardoen</span><br />
      <span class="post-time small text-muted">16th June 2006 07:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I will look into it as soon as possible, but I still think it is a bug in nsis. Workarounds are an option, but not a solution.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JeronimoColon</span><br />
      <span class="post-time small text-muted">16th June 2006 15:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What's strange is about half the PCs I've tried exhibit the problem (Mine is one of them), and the other half behave correctly.<br />
      <br />
      Also, as JasonFriday13 stated the $Documents variable seems to be the only one behaving oddly - even on my machine (which has the problem) the other variables behave correctly. As someone else suggested it may be a problem with just $Documents.<br />
      <br />
      And also, Comperio asked about the exact version Windows I was testing with. I work for a software firm and we are all Dell (Intel x86) with Windows XP Pro SP2. I still have to look at the blog info you have provided and do more digging.<br />
      <br />
      Finally, I created both a standard User account and a standard Admin account when testing and it didn't make a differenct so I think we can rule out permissions.<br />
      <br />
      I'll keep looking...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">16th June 2006 17:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Works fine for me as well. Windows XP Pro SP2.<br />
      Just tried it on NSIS v2.15 and then installed v2.17 and it still works.<br />
      <br />
      -Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br />
      <span class="post-time small text-muted">16th June 2006 18:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I am buffled. I am also using XP Pro SP2. Both calls get the value from <i>HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders\Personal</i> (using NSIS 2.17) ...<br />
      CF</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">16th June 2006 20:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I just tried it with NoSharedDocuments=1 and it does seem to disable the common folder since I get my local one</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JeronimoColon</span><br />
      <span class="post-time small text-muted">16th June 2006 20:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Just an FYI, I have checked, none of the PC have the registry setting set (both work and non-working).<br />
      <br />
      jc3</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JeronimoColon</span><br />
      <span class="post-time small text-muted">16th June 2006 22:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Okay, I had a theory I just tested. The only thing I noticed that was different between the "work" PCs and the "Non-Working" PCs was the "Non-Working" PCs are part of a Windows Domain. All the "Working" PCs were never added.<br />
      <br />
      Now what I don't know and I need to find out is if this is Windows policy related or default behavior. I don't think we use Windows policies (or very little) but I'll find out if and which - if we are using them.<br />
      <br />
      For those of you who have chimed in can you report whether or not you are part of a Domain or not?<br />
      <br />
      I'll keep digging...<br />
      <br />
      Thanks.<br />
      <br />
      jc3</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">16th June 2006 22:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The two XP SP2 (One is MCE2k5 and one is Pro) computers I tested on are not in a domain</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">16th June 2006 22:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">No domain here, just a workgroup.<br />
      <br />
      -Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br />
      <span class="post-time small text-muted">16th June 2006 23:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I am not in a domain either but it is not working :(<br />
      CF</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">17th June 2006 15:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">but do you have NoSharedDocuments=1 (in HKCU or HKLM)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br />
      <span class="post-time small text-muted">17th June 2006 18:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Good point Anders!<br />
      <br />
      For me it is the HKLM value of <i>NoSharedDocuments</i> that makes the difference :)<br />
      <br />
      If it is set to 1 then I can only see the user's $DOCUMENTS regardless of the <i>SetShellVarContext</i> value<br />
      <br />
      CF</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JeronimoColon</span><br />
      <span class="post-time small text-muted">19th June 2006 14:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Just to reiterate, we do not have NoSharedDocuments set at all.<br />
      <br />
      Could a Dev. chime in please?<br />
      <br />
      Thanks.<br />
      <br />
      jc3</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">onad</span><br />
      <span class="post-time small text-muted">20th June 2006 10:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">This might be of help:<br />
      <br />
      <a href="http://www.cs.wisc.edu/~rkennedy/my-documents" target="_blank">http://www.cs.wisc.edu/~rkennedy/my-documents</a><br />
      <br />
      If this part of NSIS is not working for you, the best would be to enter a defect in the defecttracker(bug)<br />
      <br />
      and then focus on what you want to achieve and not use the $DOCUMENTS var but make you own routine via the system module.<br />
      <br />
      After all it handy to use default values but not obliged, and if it does not work one better finds an alternative for himself thad does.<br />
      <br />
      I'm sad to say but creating installer and programming just IS a lot of work once in a while...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JeronimoColon</span><br />
      <span class="post-time small text-muted">20th June 2006 16:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for the info link Onad. I wasn't aware of the defecttracker so I will enter a bug.<br />
      <br />
      jc3</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JeronimoColon</span><br />
      <span class="post-time small text-muted">20th June 2006 19:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Here's my Win32 API workaround for those who may be interested:<br />
      <br />
      Function GetSharedDocPath<br />
      # Win32 API documentation:<br />
      # Call: <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/shellcc/platform/shell/reference/functions/shgetspecialfolderpath.asp" target="_blank">http://msdn.microsoft.com/library/de...folderpath.asp</a><br />
      # Enum: <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/shellcc/platform/shell/reference/enums/csidl.asp" target="_blank">http://msdn.microsoft.com/library/de...nums/csidl.asp</a><br />
      <br />
      SetPluginUnload alwaysoff<br />
      StrCpy $1 ""<br />
      IntOp $2 0x002e + # CSIDL_COMMON_DOCUMENTS (0x002e)<br />
      <br />
      System::Call 'shell32::SHGetSpecialFolderPath(i $HWNDPARENT, t .r1, i r2, i r3) i .r4'<br />
      <br />
      SetPluginUnload manual<br />
      System::Free 0<br />
      <br />
      DetailPrint "API Call Results: $1"<br />
      FunctionEnd<br />
      <br />
      [edit]<b>new links</b><br />
      <br />
      The API reference is:<br />
      <a href="http://msdn.microsoft.com/en-us/library/bb762204" target="_blank">http://msdn.microsoft.com/en-us/library/bb762204</a>(VS.85).aspx<br />
      <br />
      The Enum is:<br />
      <a href="http://msdn.microsoft.com/en-us/library/bb762494" target="_blank">http://msdn.microsoft.com/en-us/library/bb762494</a>(VS.85).aspx<br />
      [/edit]</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br />
      <span class="post-time small text-muted">21st June 2006 00:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have made a wiki page <a href="http://nsis.sourceforge.net/Getting_the_%27My_Documents%27_folder_for_all_users" target="_blank">here</a> using JeronimoColon's NSIS example, just so people can use it for future reference.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">21st June 2006 16:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Seems to be related to <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1008632&amp;group_id=22049&amp;atid=373085" target="_blank">http://sourceforge.net/tracker/index...49&amp;atid=373085</a><br />
      <br />
      Nsis uses SHGetSpecialFolderLocation since SHGetSpecialFolderPath needs shell v4.7(IE4 desktop update)<br />
      <br />
      Maybe nsis should check and use SHGetSpecialFolderPath if it is available on the system</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JasonFriday13</span><br />
      <span class="post-time small text-muted">22nd June 2006 22:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have just tried SetShellVarContext all at home on my XP pro SP1 x86 machine, and it works just fine.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">27th June 2007 14:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Seems like a bug in SHGetSpecialFolderPath that the workaround uses rather than a bug in SHGetSpecialFolderLocation which NSIS uses. If a policy in the domain or on the local computer disables the shared documents folder, it shouldn't be accessed. The fact that it still exists doesn't mean it's used.<br />
      <br />
      As for $DOCUMENTS getting the user's path, that's just how every variable works. If the folder for all users can't be found, the current user's folder is used. This way, there should never be an empty shell variable unless it really doesn't exist.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">27th June 2007 15:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">After some quick testing, it seems like only $DOCUMENTS is affected, $PICTURES and the other folders inside my documents still resolve to the all users path</p>
      <pre>
<code><br />curr $DOCUMENTS: C:\Documents and Settings\Anders\Documents<br />all  $DOCUMENTS: C:\Documents and Settings\Anders\Documents<br />curr $PICTURES: C:\Documents and Settings\Anders\Documents\Pictures<br />all  $PICTURES: C:\Documents and Settings\All Users\Documents\My Pictures<br />curr $MUSIC: C:\Documents and Settings\Anders\Documents\Music<br />all  $MUSIC: C:\Documents and Settings\All Users\Documents\My Music<br />curr $VIDEOS: C:\Documents and Settings\Anders\Documents\Videos<br />all  $VIDEOS: C:\Documents and Settings\All Users\Documents\My Videos<br />curr $DESKTOP: C:\Documents and Settings\Anders\Desktop<br />all  $DESKTOP: C:\Documents and Settings\All Users\Desktop<br />curr $APPDATA: C:\Documents and Settings\Anders\Application Data<br />all  $APPDATA: C:\Documents and Settings\All Users\Application Data<br />curr $TEMPLATES: C:\Documents and Settings\Anders\Templates<br />all  $TEMPLATES: C:\Documents and Settings\All Users\Templates<br />curr $STARTMENU: C:\Documents and Settings\Anders\Start Menu<br />all  $STARTMENU: C:\Documents and Settings\All Users\Start Menu<br /></code>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">nsnb</span><br />
      <span class="post-time small text-muted">8th March 2009 16:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by kichik</i><br />
        <b>Seems like a bug in SHGetSpecialFolderPath that the workaround uses rather than a bug in SHGetSpecialFolderLocation which NSIS uses. If a policy in the domain or on the local computer disables the shared documents folder, it shouldn't be accessed. The fact that it still exists doesn't mean it's used.<br />
        <br />
        As for $DOCUMENTS getting the user's path, that's just how every variable works. If the folder for all users can't be found, the current user's folder is used. This way, there should never be an empty shell variable unless it really doesn't exist.</b>
      </blockquote>I know this is an old thread, but that's exactly why I am asking: Is the above still valid?<br />
      <br />
      What has been the verdict by the NSIS gurus?<br />
      <br />
      Is this a documented feature in Windows? or a bug in NSIS?<br />
      <br />
      If the latter, has it been fixed since then?
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">8th March 2009 21:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        SHGetFolderPath as provided by shfolder.dll is used to get special folders unless the installer is running on Windows 95/98. For 95/98 shfolder.dll is only used for the Application Data and Documents folder (if the DLL exists). Oherwise, the old SHGetSpecialFolderLocation API is called.
      </blockquote><a href="http://nsis.svn.sourceforge.net/viewvc/nsis/NSIS/trunk/Source/exehead/util.c?revision=5917&amp;view=markup" target="_blank">http://nsis.svn.sourceforge.net/view...17&amp;view=markup</a><br />
      <br />
      I would assume that means its fixed, but to know for sure you would have to test since I can't remember
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
