<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Wrong place of the shortcut under Windows 7 64-bit" />

  <title>Wrong place of the shortcut under Windows 7 64-bit - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Wrong place of the shortcut under Windows 7 64-bit</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=330624">Wrong place of the shortcut under Windows 7 64-bit</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">TrifonovS</span><br />
      <span class="post-time small text-muted">16th May 2011 11:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Wrong place of the shortcut under Windows 7 64-bit</strong><br />
      Hello guys,<br />
      I have a problem the shortcuts on Windows 7. I know that there are several posts concerning such problems, but not exactly my situation.<br />
      I can install my application for all users and for the current user only. The problem happens if I install it for the current user only and under Windows 7.<br />
      The application is installed correct in C:\Users\AccName\AppPath\Roaming\AppName. But the shortcut is created always in the section for all users: C:\ProgramData\Microsoft\Windows\Start Menu\Programs\MyGroup. Instead of this, I expect to see the shortcut in: C:\Users\AccName\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\MyGroup. I thought that I might have an error in my script, but I printed the path to the shortcut and I see the following:<br />
      <br />
      MessageBox MB_OK "$SMPROGRAMS\MyGroup\MyApp.lnk" ; Here I see the test "C:\Users\AccName\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\MyGroup\MyApp.lnk"<br />
      CreateShortCut "$SMPROGRAMS\MyGroup\MyApp.lnk" "$INSTDIR\MyApp\MyApp.exe"<br />
      <br />
      Immediately after the execution of these lines of code I see that there is a shrotcut created in C:\ProgramData\Microsoft\Windows\Start Menu\Programs\MyGroup. Why?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">16th May 2011 12:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">AFAIK all you need do to is add a manifest. Use the requestexecutionlevel command.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">16th May 2011 16:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">NT6 sucks that's why, it thinks it knows better than you. But like MSG says, add requestexecutionlevel. See <a href="http://nsis.sourceforge.net/Shortcuts_removal_fails_on_Windows_Vista" target="_blank">http://nsis.sourceforge.net/Shortcut..._Windows_Vista</a></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">TrifonovS</span><br />
      <span class="post-time small text-muted">18th May 2011 07:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I used RequestExecutionLevel user, but now I'm facing to a new problem. The DLLs in System32 can not be installed. I get "Error opening file for writing!".</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">18th May 2011 07:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">To write to sys32, or any other protected directory, you need admin access. You'll have to do:<br />
      1) requestexecutionlevel admin<br />
      2) verify admin access in .onInit using the userinfo plugin<br />
      3) do an all-user install (because you're admin)<br />
      4) write all regentries to HKLM (see 3)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">TrifonovS</span><br />
      <span class="post-time small text-muted">19th May 2011 12:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I made it as you suggested and made tests on several operating systems. It looks that it works. Thanks a lot.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">TrifonovS</span><br />
      <span class="post-time small text-muted">14th June 2011 09:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">After more tests I saw a problem. I used Windows 7 32-bit version with two accounts - "Test" (with admin rights) and "Test1" (without admin rights). I tried to install my application in account "Test1" for the current user only. I expect to have an installation folder like this:<br />
      C:\Users\Test1\AppData\Roaming\NameOfMyApp<br />
      But I have the following line in my script:<br />
      RequestExecutionLevel admin<br />
      This cases elevation to admin rights. That's ok, but the installation folder is switched to<br />
      C:\Users\Test\AppData\Roaming\NameOfMyApp (instead of C:\Users\Test1\AppData\Roaming\NameOfMyApp).<br />
      If I remove the request for admin rights, I will get the correct installation folder, but I won't be able to install the DLLs in System32.<br />
      So the question is how I can ensure correct installation in all cases admin or non-admin rights, installation for all users or for the current user, OS Windows XP or 7,... As far as I know, I can not switch the access rights during the installation.<br />
      Please, help...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">14th June 2011 12:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You must not elevate if you want a single-user install. When installing something in Windows, you must do one of two things:<br />
      1) Elevate, and install for ALL users<br />
      2) Do not elevate, and install for THIS user.<br />
      <br />
      That is how Windows is designed. You must use one of the two. Not both. This means that you cannot install to the System folder without doing an all-user install. Sorry.<br />
      <br />
      <br />
      (Cheater's note: The NSIS UAC plugin technically allows you to elevate and still install as user, but that is contradictory to how Windows is designed. Only for advanced users who enjoy breaking rules, definitely not recommended.)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">TrifonovS</span><br />
      <span class="post-time small text-muted">14th June 2011 13:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Ok, but the RequestExecutionLevel must be outside of any functions. In the real world there is a dialog that asks the user for the type of the installation. How than I can switch the execution level?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">14th June 2011 14:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You cannot. The requested execution level is stored in the manifest, there can only be one of those. So it's one or the other: An all-user elevated installer, or a single-user userlevel installer. Like I said, what you want is not (sanely) possible. You'll have to install your application for all users if you want access to the system dir.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">TrifonovS</span><br />
      <span class="post-time small text-muted">14th June 2011 19:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have another idea. The first tests gave me good results, but I don't know what will happen at the end. The idea is the following:</p>

      <ul>
        <li>I programmed a simple application (with NSIS) that works on user level. It only writes a text file that contains the settled paths for $APPDATA, $SMPROGRAMS, $DESKTOP,... (what ever I need) for the current user.</li>
      </ul>

      <ul>
        <li>My original installer works on admin level. In .onInit function it calls the mentioned application. As a result, I have a file that contains the paths that I have to use if the user select an installation for the current user only.</li>
      </ul>

      <ul>
        <li>The installation continues and when it reach the point when the user select the needed installation mode (all users or current user), makes the following actions:</li>
      </ul>

      <blockquote>
        <ul>
          <li>If all user mode is selected - do the same as before.</li>
        </ul>

        <ul>
          <li>If current user mode is selected, modify the path from these ones from the file. This will guarantee that the application will not be installed in the account with administrator rights, but with the needed one. Then the installation continues as before.</li>
        </ul>
      </blockquote>

      <ul>
        <li>When the installation is done, delete the generated file with paths.</li>
      </ul><br />
      Do you thing that this will work?
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">14th June 2011 20:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">No, this will not work, if the user is not admin, they will elevate with a different user and then your helper app will get the admin users profile path and not the "real" path.<br />
      <br />
      You could do it the other way around, install files normally as current user and then launch a mini installer that runs as admin and installs your system files...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">TrifonovS</span><br />
      <span class="post-time small text-muted">16th June 2011 07:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Yes, I can do this, but it leads to many complications. I install several applications with one installer and I have for each one a separated section. Each section contains operations that must be done with user rights and and also operations that must be executed with admin rights (installation of DLLs in System32). So I prefer only to permit the possibility to install if the rights of the account are not admin. Now I have the next problem, therefore the next question. I want to check the rights in .onInit function. I can do this with the plug-in UserInfo. But if I use RequestExectionLevel Admin, the plug-in always reports admin rights. So is there a possibility to locate the original rights of the account in which the installer is started? Once more - I need the following... If the installer is started from account with admin rights, then installation for all users and for the local user are allowed. If the installer is started from account with non-admin rights, it must show a message that the rights are not enough and the installation must be aborted. This must work on Windows 2000, XP, Vista and 7. How can check the account rights?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">16th June 2011 08:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You are confused.<br />
      <br />
      1) Requestexecutionlevel does NOT elevate your installer. It only tells UAC that you *want* to elevate. If UAC is disabled, or you're on a windows version older than Vista, the requestexecutionlevel command does absolutely nothing.<br />
      2) If you request admin, and UAC is on, you will never ever ever be able to install as user. There is no way to know what the 'original' user was.<br />
      3) If you request user, or UAC is off, you will not elevate at all. This is why, if you want admin access, you must always verify admin access using the userinfo plugin.<br />
      <br />
      Once again, I can not stress this enough: You can NOT do things both at userlevel and adminlevel, in one installer. It's technically 100% impossible.<br />
      <br />
      <br />
      Cheater's note: There is a way to work around this problem by using the NSIS UAC plugin. It allows you to launch your installer at userlevel, and then start a second installer instance as admin. This allows you to effectively do things at both levels. But an installer using this trick will become quite complex, so it's not recommended. Your funeral.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">TrifonovS</span><br />
      <span class="post-time small text-muted">16th June 2011 08:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">MSG, I'm really confused.<br />
      I have seen many installer that ask you to select the installation mode. That's why NSIS has MultyUser-dialog. If it is impossible to select the installation mode later, then why we need this dialog?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">16th June 2011 10:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The problem with those installers is that they assume that the user running the installer is *already* an admin. Let's say you're on WinXP. Most people used XP from an admin account, because that's easiest. (It's also the most dangerous - this is why Microsoft changed things in Vista.) So let's say we're an admin user called Peter. If we run an installer, a 'single user' install is possible because the installer is running as the user Peter (after all, no elevation is necessary). So any 'userlevel' commands are really for THIS user. So it works.<br />
      <br />
      Now let's assume we're on WinXP, but we're a *userlevel* user called Steve. Steve runs the installer, and the installer (if it's not completely stupid) warns the user that it needs admin access and quits. So, Steve does Run As Admin. From that point on a single-user installation is no longer possible, because the installer is now running <b>as a different user</b>. Any 'userlevel' commands (and variables such as $desktop etc) are now not executed as the user Steve, but rather as the admin user (Peter, or Administrator, or some other admin account). So if the installer still tries to do a 'single user' install, everything breaks: It's installed for the admin, not for the user who launched the installer.<br />
      <br />
      <br />
      Now, this story changes for newer Windows versions. Since the launch of Windows Vista (when UAC is on), there is no real admin user anymore: All users are normal users until they elevate. The only difference between a userlevel user and an adminlevel user is that the first is not allowed to elevate, while the second one is. This is why, on Vista and newer, an elevated installation must <b>always</b> be installed for all users: There is no way for Windows to know what user originally launched the installer.<br />
      <br />
      <br />
      (Note: On WinXP and older, admin users do exist. So on those windows versions you *could* offer a single-user installation choice. This is however somewhat dangerous, because if Steve does Run As Admin, you'd still end up installing for the wrong user. So again, best way is to simply force an alluser install if the installer has admin access. In other words: All installers that offer you the choice are broken.)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jpderuiter</span><br />
      <span class="post-time small text-muted">16th June 2011 10:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well, the MultiUser option is meant for installers which do not need admin rights.<br />
      And that is still valid for Windows Vista and Windows 7 etc.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">TrifonovS</span><br />
      <span class="post-time small text-muted">16th June 2011 11:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Then the only possible solution for me is to remove this possibility for my installer and install always for all users.<br />
      Thanks to all of you!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">16th June 2011 11:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by jpderuiter</small><br />
        Well, the MultiUser option is meant for installers which do not need admin rights.<br />
        And that is still valid for Windows Vista and Windows 7 etc.
      </blockquote>Err... What? You cannot install for all users if you don't have admin access. Well, unless you're counting power users, I suppose...
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">jpderuiter</span><br />
      <span class="post-time small text-muted">16th June 2011 11:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by MSG</small><br />
        Err... What? You cannot install for all users if you don't have admin access. Well, unless you're counting power users, I suppose...
      </blockquote>Hmm, you're absolutely right, should have thought about that myself.<br />
      So there is no use for the MultiUser option at all anymore, actually it will be confusing for the user.<br />
      Good to know.
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
