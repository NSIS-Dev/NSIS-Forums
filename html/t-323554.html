<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Plugin not accepted after recompilation" />

  <title>Plugin not accepted after recompilation - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Plugin not accepted after recompilation</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=323554">Plugin not accepted after recompilation</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Javarome</span><br />
      <span class="post-time small text-muted">28th October 2010 17:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Plugin not accepted after recompilation</strong><br />
      Hello,<br />
      <br />
      I am in the situation of taking ownership of software not developed by myself, and make the whole thing buildable through scripts, both on 32 bit and 64 bit platforms.<br />
      <br />
      Among the files part of the build is a NSIS plugin dll whose an existing 32 bits version works fine (makeNSIS builds the nsi script without problem, and the generated installer works fine).<br />
      When I recompile the plugin dll however, makeNSIS complains about the first call to the plugin dll function, saying it is an "Invalid command". Whereas this is usually due to a wrong plugin directory, this is definitively because of the dll itself in my case, as replacing the dll by the old one make the thing work.<br />
      So my question is: what could lead makeNSIS to say "invalid command" when the dll is found? Some compilation options? a DLL format issue?<br />
      Checking with previous versions of the sources, I cannot see differences in them. The only differences are that I'm using VC++ 2010 to compile (instead of 2008) and that I'm compiling on a Win7 64 bits platform (but the problem arises both in compiling a Win32 or x64 configuration).<br />
      <br />
      A last clue : when looking at the exports (using dumpbin) on the existing dll that is accepted, i can see:<br /></p>

      <blockquote>
        00000000 characteristics<br />
        4BC6D78A time date stamp Thu Apr 15 11:08:26 2010<br />
        0.00 version<br />
        1 ordinal base<br />
        4 number of functions<br />
        4 number of names<br />
        <br />
        ordinal hint RVA name<br />
        <br />
        1 0 0000F390 BrowserRunning<br />
        2 1 0000F530 CheckSerial<br />
        3 2 0000F1E0 KillProc<br />
        4 3 0000F3F0 SHA1<br />
        <br />
        Summary<br />
        <br />
        3000 .data<br />
        3000 .rdata<br />
        2000 .reloc<br />
        1000 .rsrc<br />
        F000 .text
      </blockquote>Whereas when looking at the newly compiled version, I can see a slight difference in the exported names ("name = _name", what does it mean?):<br />

      <blockquote>
        00000000 characteristics<br />
        4CC99565 time date stamp Thu Oct 28 17:23:17 2010<br />
        0.00 version<br />
        1 ordinal base<br />
        4 number of functions<br />
        4 number of names<br />
        <br />
        ordinal hint RVA name<br />
        <br />
        1 0 00001170 BrowserRunning = _BrowserRunning<br />
        2 1 00001240 CheckSerial = _CheckSerial<br />
        3 2 00001A00 KillProc = _KillProc<br />
        4 3 00001000 SHA1 = _SHA1<br />
        <br />
        Summary<br />
        <br />
        3000 .data<br />
        4000 .rdata<br />
        2000 .reloc<br />
        1000 .rsrc<br />
        E000 .text
      </blockquote>Thank you for your help.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Javarome</span><br />
      <span class="post-time small text-muted">29th October 2010 09:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">In case you don't have any clue, is there any NSIS debug option that would help me to understand why the recompiled DLL is considered invalid whereas the old one is not?<br />
      Thanks</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Javarome</span><br />
      <span class="post-time small text-muted">29th October 2010 15:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">It looks that the problem occurs only when running on Windows (7) 64 bits, not on Windows (7) 32 bits.<br />
      Any idea? Is it a NSIS bug?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">29th October 2010 19:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">NSIS just does LoadLibrary and GetProcAddress. If it fails, it either can't load the dll, or find the export.<br />
      <br />
      You should probably start by fixing the exports, are you using a .def file or __declspec ?<br />
      <br />
      Maybe post your function declaration so we can have a look...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Javarome</span><br />
      <span class="post-time small text-muted">2nd November 2010 12:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for replying Anders.<br />
      <br />
      First of all a correction: the problem only occurs when trying to load a DLL/plugin compiled for a 64-bits platform (NSIS doesn't complain packaging the same DLL compiled for 32 bits, even when running makeNSIS on 64 bits).<br />
      <br />
      The DLL uses __declspec. Here is an example declaration in the .c file:<br />
      <br />
      void __declspec(dllexport) SHA1(HWND hwndParent, int string_size,<br />
      char *variables, stack_t **stacktop,<br />
      extra_parameters *extra) {<br />
      <br />
      which is loaded fine when compiled for 32 bits, when running makeNSIS either or 32 bits or (almost paradoxally as the 32-bits dll won't be able to be loaded) on 64 bits.<br />
      <br />
      So right now I'm thinking about a simple explanation of the problem : how can 32-bits compiled NSIS could load a 64 bits DLL ? Isn't it normal that it fails to do so (even if the message should be more explicit that "Invalid command", like "cannot load plugin Xxx because it is 64 bits and you're using a 32 bits NSIS").<br />
      For example a 64 bits java virtual machine cannot load 32 bits dlls using the Java Native Interface. The DLLs have to be 64 bits.<br />
      <br />
      Or maybe I'm missing something. If not, my next question is: is there a 64-bits compiled NSIS, and where can I find it?<br />
      <br />
      Thank you for your help.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Javarome</span><br />
      <span class="post-time small text-muted">2nd November 2010 14:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">For the record, the problem can be workarounded by compiling all plugins for 32 bits and running NSIS with them on a 64 bits platform.<br />
      <br />
      So why would I need to run a 64 bits compatible version a NSIS (and associated plugins) then, would you ask? Because I expected that such a version would allow to properly kill a 64-bits running process, which I need to. But it looks my expectation was wrong, as stated in <a href="http://forums.winamp.com/showthread.php?t=318977" target="_blank">http://forums.winamp.com/showthread.php?t=318977</a></p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
