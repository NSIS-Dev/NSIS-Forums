<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Bug in ExecDos" />

  <title>Bug in ExecDos - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Bug in ExecDos</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=254677">Bug in ExecDos</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">torpark</span><br />
      <span class="post-time small text-muted">3rd September 2006 05:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Bug in ExecDos</strong><br />
      I have found what I think is a bug in the NSIS compiler or in ExecDos.<br />
      <br />
      I have ExecDos set with a very standard line of code, which causes the program to spawn a second copy of its process into memory!<br />
      <br />
      ExecDos::exec /NOUNLOAD /TIMEOUT=10000 "$TORDIRECTORY\TorCircuitStatus 82"<br />
      <br />
      which usually causes torcircuitstatus.exe to run, instead causes the main program to spawn another instance of itself and torcircuitstatus never runs at all!<br />
      <br />
      It used to work, and now it doesn't.<br />
      <br />
      I can provide full source if need be, but I am 100% sure it is that line that is the error.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Takhir</span><br />
      <span class="post-time small text-muted">3rd September 2006 06:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Is 'main' program your installer or some other application? Not long ago I made changes in ExecDos (added 'output to stack' option), but you can test situation with previous plug-in version from this page <a href="http://nsis.sourceforge.net/File:ExecDos.zip" target="_blank">http://nsis.sourceforge.net/File:ExecDos.zip</a> Can you reproduce 'fork' with any other application? ExecDos call exit code (Pop)?<br />
      Also. You should set a full file name in the command line including extension, torcircuitstatus.exe, otherwise, while we not using shell, file will not be found. And '/nounload' switch in the sync mode usefull for serial dll calls only. Short script sample (with files required) may help.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">torpark</span><br />
      <span class="post-time small text-muted">3rd September 2006 15:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Main program is indeed my installer.<br />
      <br />
      The strange issue is that when I have some entirely unrelated files around, it works just fine. Very very strange.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">torpark</span><br />
      <span class="post-time small text-muted">3rd September 2006 16:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I have a new development. The programs don't work if they are moved at all whatsoever! If I move the directory, and exact copy of it, to anywhere else, the installer forks.<br />
      <br />
      Further, when I removed the /NOUNLOAD i got this:<br /></p>

      <blockquote>
        The instruction at "0x011613a5" referenced memory at "0xffffffff". The memory could not be "read".
      </blockquote>I have seen this problem happen with the correct program being run instead of the main installer program. I am thinking it is possible that execdos is infact running the correct program, but that it is using the main installers name. However Execdos isn't allowing the program to throw back a code from the stack. BTW, unless your execdos is of a different size, I was using your old version (July 1st).
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">torpark</span><br />
      <span class="post-time small text-muted">3rd September 2006 16:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Update: strange to stranger</strong><br />
      I substituted NsExec in place of ExecDOS... Now there isn't just one extra copy of the loader but more and more continually.<br />
      <br />
      And I am indeed using the exact and full path of the program. Yet still it breaks and runs the new process under the name of the installer.<br />
      <br />
      Could this be an issue with the NSIS compiler?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Takhir</span><br />
      <span class="post-time small text-muted">3rd September 2006 17:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">One more.. If path includes blank spaces use double quotas:<br />
      '"$TORDIRECTORY\TorCircuitStatus" 82'<br />
      Both ExecDos and nsExec start one process only.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">torpark</span><br />
      <span class="post-time small text-muted">3rd September 2006 19:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Still no good. I'm about to post the source and programs so you can see the insanity for yourself. I've found a new error as well in FindProcDLL:FindProc that may be related to this problem.<br />
      <br />
      In my code I have:<br /></p>

      <blockquote>
        DoneWithFlagCheck:<br />
        MessageBox MB_OK `R0 = $R0`<br />
        FindProcDLL::FindProc "tor.exe" ;Make sure tor.exe is still running<br />
        Pop $R0<br />
        MessageBox MB_OK `The value returned was: $R0`
      </blockquote>The first message box returns "R0 = 0"<br />
      The second message box returns "The value returned was: I:\soapbox2\App\tor\TorCircuitStatus.exe 82"<br />
      <br />
      This is really strange because that is the string I am sending to ExecDos. And for some reason, FindProcDLL pulls that from somewhere and returns it as $R0!
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">torpark</span><br />
      <span class="post-time small text-muted">3rd September 2006 19:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Okay, the issue isn't with FindProcDLL, it has to do with something with ExecDOS or the compiler or environment.<br />
      <br />
      I changed the code:<br />
      <br /></p>

      <blockquote>
        DoneWithFlagCheck:<br />
        MessageBox MB_OK `R0 = $R0`<br />
        FindProcDLL::FindProc "tor.exe" ;Make sure tor.exe is still running<br />
        Pop $R1<br />
        StrCmp $DEBUGON 1 "" +2<br />
        MessageBox MB_OK `R0: $R0, R1 = $R1`
      </blockquote>The output was:<br />
      R0 = 0<br />
      R0 = 1 R1 = I:\soapbox2\App\tor\TorCircuitStatus.exe 82<br />
      <br />
      So apparently ExecDos is forcing the string "I:\soapbox2\App\tor\TorCircuitStatus.exe 82" on the stack.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">torpark</span><br />
      <span class="post-time small text-muted">3rd September 2006 20:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Okay. The i have removed all "POP $R0" after FindProcDLL as they are all useless since FindProcDLL pushes the return to $R0.<br />
      <br />
      The problem is very odd. When the directory is on a USB stick, it runs fine. If it is in a certain directory on my computer, it runs fine. If it is moved anywhere else, the installer "Torpark.exe" keeps respawning its process anytime i try to ExecDos TorCircuitStatus.exe.<br />
      <br />
      Check it for yourself. Put it into debug mode by running it with /debug like so "Torpark /debug" from the command prompt.<br />
      <br />
      Full BIN, dir structure, and source available here:<br />
      <a href="http://torpark.nfshost.com/soapbox2.zip" target="_blank">http://torpark.nfshost.com/soapbox2.zip</a><br />
      <br />
      The strangest thing of all... I used to have a message at the beginning of the installer, and that is what kept popping up when the process restarted. I changed that message slightly and recompiled it, and when it ran the installer again it gave me the original message! Very strange.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">torpark</span><br />
      <span class="post-time small text-muted">3rd September 2006 22:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Okay. I think it is the environment, but it may be effected by the compiler.<br />
      <br />
      When I compile the program and run it, often, it will fork two other processes that I am calling with ExecDos. Not just torpark.exe, but sometimes an extra tor.exe will show up.<br />
      <br />
      When I take that same code, copy it to a different medium and run it from there, no problems.<br />
      <br />
      So I rebooted and ran the program from the original location. It started forking again. I tried the one at the different drive and it was fine, just as before.<br />
      <br />
      Is it possible that versions of the program are being called from the system cache, and that is what is causing the appearance of multiple processes?<br />
      <br />
      Admittedly, I highly doubt this as the machine I am experiencing this problem on has no pagefile / 0MB set, as it has 1.5GB Ram.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">8th September 2006 17:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">All of your ExecDos calls cause stack corruption. You pass only the application to run and not the stdin string and the log file name. Seeing FindProc returning/getting parts of the stack of ExecDos, you definitely have a stack corruption and it might be related to this issue.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">torpark</span><br />
      <span class="post-time small text-muted">12th September 2006 05:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Why would execdos calls be causing stack corruption? Is this because of the formatting I have used?<br />
      <br />
      How should syntax be if I am running, with no log file:<br />
      <br />
      $TORDIRECTORY\TorCircuitStatus 82<br />
      <br />
      It was said that it was: '"$TORDIRECTORY\TorCircuitStatus" 82' but this does not address the log file.<br />
      <br />
      So I assume it should be:<br />
      '"$TORDIRECTORY\TorCircuitStatus" 82' "" ""<br />
      <br />
      BTW, I tried the program on a different machine, and was able to reproduce forking after running and exiting the program 10 or so times.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">15th September 2006 09:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">It's because of the way you've used ExecDos. You've passed only one argument where ExecDos expects 3 (numbers might be off, see the readme for the exact numbers). This makes it pop two more arguments from the stack that have nothing to do with ExecDos. It causes stack corruption because something else was expecting those stack items.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
