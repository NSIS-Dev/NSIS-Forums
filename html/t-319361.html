<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Install .Net if it is not installed - newbie needs help - 99% working just one thing!"><title>Install .Net if it is not installed - newbie needs help - 99% working just one thing! - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Install .Net if it is not installed - newbie needs help - 99% working just one thing!</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=319361">Install .Net if it is not installed - newbie needs help - 99% working just one thing!</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">martinmacca</span><br><span class="post-time small text-muted">22nd May 2010 00:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Install .Net if it is not installed - newbie needs help - 99% working just one thing!</strong><br>I've installed this script <a href="http://nsis.sourceforge.net/How_to_Automatically_download_and_install_a_particular_version_of_.NET_if_it_is_not_already_installed" target="_blank">http://nsis.sourceforge.net/How_to_A...eady_installed</a> and it integrates into my installer perfectly.<br><br>If .Net isnt installed it downloads and installs it with no issues.<br><br>However - it always wants to install .Net 2.0 even if its already installed. I cant help thinking i'm doing something wrong! All i've done is copy and paste the code and change the .Net version from 1.1 to 2.0<br><br></p><blockquote>; Usage<br>; 1 Call SetupDotNetSectionIfNeeded from .onInit function<br>; This function will check if the required version<br>; or higher version of the .NETFramework is installed.<br>; If .NET is NOT installed the section which installs dotnetfx is selected.<br>; If .NET is installed the section which installs dotnetfx is unselected.<br><br>#!define SF_USELECTED 0<br>#!define SF_SELECTED 1<br>#!define SF_SECGRP 2<br>#!define SF_BOLD 8<br>#!define SF_RO 16<br>#!define SF_EXPAND 32<br>###############################<br><br>!define DOT_MAJOR <font color="red">2</font><br>!define DOT_MINOR <font color="red">0</font><br><br>!macro SecSelect SecId<br>Push $0<br>IntOp $0 ${SF_SELECTED} | ${SF_RO}<br>SectionSetFlags ${SecId} $0<br>SectionSetInstTypes ${SecId} 1<br>Pop $0<br>!macroend<br><br>!define SelectSection '!insertmacro SecSelect'<br>#################################<br><br>!macro SecUnSelect SecId<br>Push $0<br>IntOp $0 ${SF_USELECTED} | ${SF_RO}<br>SectionSetFlags ${SecId} $0<br>SectionSetText ${SecId} ""<br>Pop $0<br>!macroend<br><br>!define UnSelectSection '!insertmacro SecUnSelect'<br>###################################<br><br>!macro SecExtract SecId<br>Push $0<br>IntOp $0 ${SF_USELECTED} | ${SF_RO}<br>SectionSetFlags ${SecId} $0<br>SectionSetInstTypes ${SecId} 2<br>Pop $0<br>!macroend<br><br>!define SetSectionExtract '!insertmacro SecExtract'<br>###################################<br><br>!macro Groups GroupId<br>Push $0<br>SectionGetFlags ${GroupId} $0<br>IntOp $0 $0 | ${SF_RO}<br>IntOp $0 $0 ^ ${SF_BOLD}<br>IntOp $0 $0 ^ ${SF_EXPAND}<br>SectionSetFlags ${GroupId} $0<br>Pop $0<br>!macroend<br><br>!define SetSectionGroup "!insertmacro Groups"<br>####################################<br><br>!macro GroupRO GroupId<br>Push $0<br>IntOp $0 ${SF_SECGRP} | ${SF_RO}<br>SectionSetFlags ${GroupId} $0<br>Pop $0<br>!macroend<br><br>!define MakeGroupReadOnly '!insertmacro GroupRO'<br><br>Function SetupDotNetSectionIfNeeded<br><br>StrCpy $0 "0"<br>StrCpy $1 "SOFTWARE\Microsoft\.NETFramework" ;registry entry to look in.<br>StrCpy $2 0<br><br>StartEnum:<br>;Enumerate the versions installed.<br>EnumRegKey $3 HKLM "$1\policy" $2<br><br>;If we don't find any versions installed, it's not here.<br>StrCmp $3 "" noDotNet notEmpty<br><br>;We found something.<br>notEmpty:<br>;Find out if the RegKey starts with 'v'.<br>;If it doesn't, goto the next key.<br>StrCpy $4 $3 1 0<br>StrCmp $4 "v" +1 goNext<br>StrCpy $4 $3 1 1<br><br>;It starts with 'v'. Now check to see how the installed major version<br>;relates to our required major version.<br>;If it's equal check the minor version, if it's greater,<br>;we found a good RegKey.<br>IntCmp $4 ${DOT_MAJOR} +1 goNext yesDotNetReg<br>;Check the minor version. If it's equal or greater to our requested<br>;version then we're good.<br>StrCpy $4 $3 1 3<br>IntCmp $4 ${DOT_MINOR} yesDotNetReg goNext yesDotNetReg<br><br>goNext:<br>;Go to the next RegKey.<br>IntOp $2 $2 + 1<br>goto StartEnum<br><br>yesDotNetReg:<br>;Now that we've found a good RegKey, let's make sure it's actually<br>;installed by getting the install path and checking to see if the<br>;mscorlib.dll exists.<br>EnumRegValue $2 HKLM "$1\policy\$3" 0<br>;$2 should equal whatever comes after the major and minor versions<br>;(ie, v1.1.4322)<br>StrCmp $2 "" noDotNet<br>ReadRegStr $4 HKLM $1 "InstallRoot"<br>;Hopefully the install root isn't empty.<br>StrCmp $4 "" noDotNet<br>;build the actuall directory path to mscorlib.dll.<br>StrCpy $4 "$4$3.$2\mscorlib.dll"<br>IfFileExists $4 yesDotNet noDotNet<br><br>noDotNet:<br>${SelectSection} ${SECDOTNET}<br>goto done<br><br>yesDotNet:<br>;Everything checks out. Go on with the rest of the installation.<br>${UnSelectSection} ${SECDOTNET}<br>goto done<br><br>done:<br>;All done.<br><br>FunctionEnd<br><br>!define BASE_URL <a href="http://download.microsoft.com/download" target="_blank">http://download.microsoft.com/download</a><br>; .NET Framework<br>; English<br>!define URL_DOTNET_1033 "${BASE_URL}/5/6/7/567758a3-759e-473e-bf8f-52154438565a/dotnetfx.exe"<br><br><br><br>Var "LANGUAGE_DLL_TITLE"<br>Var "LANGUAGE_DLL_INFO"<br>Var "URL_DOTNET"<br>Var "OSLANGUAGE"<br>Var "DOTNET_RETURN_CODE"<br><br><br>LangString DESC_REMAINING ${LANG_ENGLISH} " (%d %s%s remaining)"<br>LangString DESC_PROGRESS ${LANG_ENGLISH} "%d.%01dkB/s" ;"%dkB (%d%%) of %dkB @ %d.%01dkB/s"<br>LangString DESC_PLURAL ${LANG_ENGLISH} "s"<br>LangString DESC_HOUR ${LANG_ENGLISH} "hour"<br>LangString DESC_MINUTE ${LANG_ENGLISH} "minute"<br>LangString DESC_SECOND ${LANG_ENGLISH} "second"<br>LangString DESC_CONNECTING ${LANG_ENGLISH} "Connecting..."<br>LangString DESC_DOWNLOADING ${LANG_ENGLISH} "Downloading %s"<br>LangString DESC_SHORTDOTNET ${LANG_ENGLISH} "Microsoft .Net Framework 2.0"<br>LangString DESC_LONGDOTNET ${LANG_ENGLISH} "Microsoft .Net Framework 2.0"<br>LangString DESC_DOTNET_DECISION ${LANG_ENGLISH} "$(DESC_SHORTDOTNET) is required.$\nIt is strongly \<br>advised that you install$\n$(DESC_SHORTDOTNET) before continuing.$\nIf you choose to continue, \<br>you will need to connect$\nto the internet before proceeding.$\nWould you like to continue with \<br>the installation?"<br>LangString SEC_DOTNET ${LANG_ENGLISH} "$(DESC_SHORTDOTNET) "<br>LangString DESC_INSTALLING ${LANG_ENGLISH} "Installing"<br>LangString DESC_DOWNLOADING1 ${LANG_ENGLISH} "Downloading"<br>LangString DESC_DOWNLOADFAILED ${LANG_ENGLISH} "Download Failed:"<br>LangString ERROR_DOTNET_DUPLICATE_INSTANCE ${LANG_ENGLISH} "The $(DESC_SHORTDOTNET) Installer is \<br>already running."<br>LangString ERROR_NOT_ADMINISTRATOR ${LANG_ENGLISH} "$(DESC_000022)"<br>LangString ERROR_INVALID_PLATFORM ${LANG_ENGLISH} "$(DESC_000023)"<br>LangString DESC_DOTNET_TIMEOUT ${LANG_ENGLISH} "The installation of the $(DESC_SHORTDOTNET) \<br>has timed out."<br>LangString ERROR_DOTNET_INVALID_PATH ${LANG_ENGLISH} "The $(DESC_SHORTDOTNET) Installation$\n\<br>was not found in the following location:$\n"<br>LangString ERROR_DOTNET_FATAL ${LANG_ENGLISH} "A fatal error occurred during the installation$\n\<br>of the $(DESC_SHORTDOTNET)."<br>LangString FAILED_DOTNET_INSTALL ${LANG_ENGLISH} "The installation of $(PRODUCT_NAME) will$\n\<br>continue. However, it may not function properly$\nuntil $(DESC_SHORTDOTNET)$\nis installed."<br><br><br>Section $(SEC_DOTNET) SECDOTNET<br>SectionIn RO<br>IfSilent lbl_IsSilent<br>!define DOTNETFILESDIR "Common\Files\MSNET"<br>StrCpy $DOTNET_RETURN_CODE "0"<br>!ifdef DOTNET_ONCD_1033<br>StrCmp "$OSLANGUAGE" "1033" 0 lbl_Not1033<br>SetOutPath "$PLUGINSDIR"<br>file /r "${DOTNETFILESDIR}\dotnetfx1033.exe"<br>DetailPrint "$(DESC_INSTALLING) $(DESC_SHORTDOTNET)..."<br>Banner::show /NOUNLOAD "$(DESC_INSTALLING) $(DESC_SHORTDOTNET)..."<br>nsExec::ExecToStack '"$PLUGINSDIR\dotnetfx1033.exe" /q /c:"install.exe /noaspupgrade /q"'<br>pop $DOTNET_RETURN_CODE<br>Banner::destroy<br>SetRebootFlag true<br>Goto lbl_NoDownloadRequired<br>lbl_Not1033:<br>!endif<br>; Insert Other language blocks here<br><br>; the following Goto and Label is for consistencey.<br>Goto lbl_DownloadRequired<br>lbl_DownloadRequired:<br>DetailPrint "$(DESC_DOWNLOADING1) $(DESC_SHORTDOTNET)..."<br>MessageBox MB_ICONEXCLAMATION|MB_YESNO|MB_DEFBUTTON2 "$(DESC_DOTNET_DECISION)" /SD IDNO \<br>IDYES +2 IDNO 0<br>Abort<br>; "Downloading Microsoft .Net Framework"<br>AddSize 153600<br>nsisdl::download /TRANSLATE "$(DESC_DOWNLOADING)" "$(DESC_CONNECTING)" \<br>"$(DESC_SECOND)" "$(DESC_MINUTE)" "$(DESC_HOUR)" "$(DESC_PLURAL)" \<br>"$(DESC_PROGRESS)" "$(DESC_REMAINING)" \<br>/TIMEOUT=30000 "$URL_DOTNET" "$PLUGINSDIR\dotnetfx.exe"<br>Pop $0<br>StrCmp "$0" "success" lbl_continue<br>DetailPrint "$(DESC_DOWNLOADFAILED) $0"<br>Abort<br><br>lbl_continue:<br>DetailPrint "$(DESC_INSTALLING) $(DESC_SHORTDOTNET)..."<br>Banner::show /NOUNLOAD "$(DESC_INSTALLING) $(DESC_SHORTDOTNET)..."<br>nsExec::ExecToStack '"$PLUGINSDIR\dotnetfx.exe" /q /c:"install.exe /noaspupgrade /q"'<br>pop $DOTNET_RETURN_CODE<br>Banner::destroy<br>SetRebootFlag true<br>; silence the compiler<br>Goto lbl_NoDownloadRequired<br>lbl_NoDownloadRequired:<br><br>; obtain any error code and inform the user ($DOTNET_RETURN_CODE)<br>; If nsExec is unable to execute the process,<br>; it will return "error"<br>; If the process timed out it will return "timeout"<br>; else it will return the return code from the executed process.<br>StrCmp "$DOTNET_RETURN_CODE" "" lbl_NoError<br>StrCmp "$DOTNET_RETURN_CODE" "0" lbl_NoError<br>StrCmp "$DOTNET_RETURN_CODE" "3010" lbl_NoError<br>StrCmp "$DOTNET_RETURN_CODE" "8192" lbl_NoError<br>StrCmp "$DOTNET_RETURN_CODE" "error" lbl_Error<br>StrCmp "$DOTNET_RETURN_CODE" "timeout" lbl_TimeOut<br>; It's a .Net Error<br>StrCmp "$DOTNET_RETURN_CODE" "4101" lbl_Error_DuplicateInstance<br>StrCmp "$DOTNET_RETURN_CODE" "4097" lbl_Error_NotAdministrator<br>StrCmp "$DOTNET_RETURN_CODE" "1633" lbl_Error_InvalidPlatform lbl_FatalError<br>; all others are fatal<br><br>lbl_Error_DuplicateInstance:<br>DetailPrint "$(ERROR_DOTNET_DUPLICATE_INSTANCE)"<br>GoTo lbl_Done<br><br>lbl_Error_NotAdministrator:<br>DetailPrint "$(ERROR_NOT_ADMINISTRATOR)"<br>GoTo lbl_Done<br><br>lbl_Error_InvalidPlatform:<br>DetailPrint "$(ERROR_INVALID_PLATFORM)"<br>GoTo lbl_Done<br><br>lbl_TimeOut:<br>DetailPrint "$(DESC_DOTNET_TIMEOUT)"<br>GoTo lbl_Done<br><br>lbl_Error:<br>DetailPrint "$(ERROR_DOTNET_INVALID_PATH)"<br>GoTo lbl_Done<br><br>lbl_FatalError:<br>DetailPrint "$(ERROR_DOTNET_FATAL)[$DOTNET_RETURN_CODE]"<br>GoTo lbl_Done<br><br>lbl_Done:<br>DetailPrint "$(FAILED_DOTNET_INSTALL)"<br>lbl_NoError:<br>lbl_IsSilent:<br>SectionEnd<br><br>!insertmacro MUI_FUNCTION_DESCRIPTION_BEGIN<br>!insertmacro MUI_DESCRIPTION_TEXT ${SECDOTNET} $(DESC_LONGDOTNET)<br>!insertmacro MUI_FUNCTION_DESCRIPTION_END</blockquote>and then i'm pasting this at the bottom of my .nsi compiler file<br><br><blockquote>Function .onInit<br>StrCpy $LANGUAGE_DLL_TITLE "Installer Language"<br>StrCpy $LANGUAGE_DLL_INFO "Please select a language:"<br>StrCpy $URL_DOTNET "${URL_DOTNET_1033}"<br>StrCpy $OSLANGUAGE "1033"<br><br>; Insert other Language Blocks Here<br><br>!define MUI_LANGDLL_WINDOWTITLE "$LANGUAGE_DLL_TITLE"<br>!define MUI_LANGDLL_INFO "$LANGUAGE_DLL_INFO"<br>!insertmacro MUI_LANGDLL_DISPLAY<br>!undef MUI_LANGDLL_WINDOWTITLE<br>!undef MUI_LANGDLL_INFO<br>InitPluginsDir<br>SetOutPath "$PLUGINSDIR"<br>File /r "${NSISDIR}\Plugins\*.*"<br>FunctionEnd</blockquote></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">22nd May 2010 10:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Looks like that code is written to only work with .NET 1.1. 2.0 and above do not depend on 1.1 and therefore the check is not going to work. In particular, the HKLM\Software\Microsoft\.NETFramework\Policy key it is enumerating does not contain any .NET version information after 1.1. You need to be enumerating the HKLM\Software\Microsoft\NET Framework Setup\NDP key instead.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">martinmacca</span><br><span class="post-time small text-muted">22nd May 2010 12:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks Stu - i'll look at the keys in more detail - thought i was installing it wrong!</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>