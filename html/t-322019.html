<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Extending the x64.nsh"><title>Extending the x64.nsh - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Extending the x64.nsh</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=322019">Extending the x64.nsh</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">Zinthose</span><br><span class="post-time small text-muted">27th August 2010 21:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Extending the x64.nsh</strong><br>I'm starting to dig heavily in creating my own header/includes and I identified a shortcoming in the x64.nsh include.<br><br>I looked for an API to detect if the file redirection has been disabled but I was unable to locate anything that didn't feel like a hack.<br><br>So, I added a new macro to the x64.nsh include named "RestoreX64FSRedirection". It uses the precompiler directives to track the redirection state. It's not perfect as any calls outside of the x64.nsh that changes the redirection state will break it but it's better than nothing. :D<br><br>Why go through the trouble? Headers! A header library author never knows what the state of the systems is in prior to the include or macro / function execution. I added this to allow my header code to support 64bit without inadvertently mucking up the developer's code. When he/she installs with redirection enabled they expect it to return to the way they left it after they run one of my macros or functions. It's all about maintaining state. :cool:<br><br><a href="http://nsis.pastebin.com/gBet9drP" target="_blank">x64.nsh v2 on PasteBin.com</a><br><br>What do you guys think?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Animaether</span><br><span class="post-time small text-muted">27th August 2010 23:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">well if you're going through that trouble, you might as well update it to use the proper Wow64DisableWow64FsRedirection and Wow64RevertWow64FsRedirection API calls ;)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">27th August 2010 23:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You also have the (major) issue that the order that code fragments appear in a script isn't the order that they will be executed at run time. Therefore you really need to use a run time check for this. If you must, just add a define to make x64.nsh use its own state variable.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Zinthose</span><br><span class="post-time small text-muted">27th August 2010 23:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">hmmm...... TO THE LAB!!</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Animaether</span><br><span class="post-time small text-muted">27th August 2010 23:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">yep.. what's what we ended up doing. We actually adjusted it a slight bit further to ignore the redirection bits with ${Unless} ${AtLeastWinVista}, and new $SYS32 and $SYS64 variables which are initialized (in .onInit). On Vista+, $SYS64 simply contains the $WINDIR\SysNative folder (avoiding the need for the FS redirector calls), while on XP it's left to $SYSDIR with the FS redirection disable/revert calls taking care of files going to the correct one. It also makes it easier for us to work with because we don't see a bunch of $SYSDIR references having to puzzle from context or comments as to whether the code should be dealing with the 32bit or the 64bit one.</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>