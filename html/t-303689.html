<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="System::Call not working with custom DLL"><title>System::Call not working with custom DLL - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">System::Call not working with custom DLL</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=303689">System::Call not working with custom DLL</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">njshaw2</span><br><span class="post-time small text-muted">2nd March 2009 17:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>System::Call not working with custom DLL</strong><br>Hi,<br><br>I've written a function in my own DLL to find out if the user has permission to install the software version (based on a hardware dongle setting, but that detail is irrelevant). My function, in C, is something like this:<br><br>int WINAPI CanUserInstall(void)<br>{<br>int Ret = FALSE;<br><br>// do various checks<br>// if user is allowed to install, set Ret to TRUE;<br><br>return Ret;<br>}<br><br>This function is being exported by the DLL correctly (according to Microsoft's Dependency Walker app).<br><br>In my NSIS script, I have the following code:<br><br>SetOutPath "$TEMP"<br>File "installer.dll"<br>System::Call 'installer.dll::CanUserInstall(v) i.R0 ?e'<br>Pop $0<br>MessageBox MB_OK "Return value = $R0, lasterr = $0"<br>IntCmp $R0 1 OkToInstall CancelInstall<br><br>CancelInstall:<br>Abort "Not allowed to install"<br><br>OkToInstall:<br>; ... do the install<br><br>Firstly, the messagebox returns this:<br>"Return value = error, lasterr = 0"<br>Then the IntCmp always goes to the CancelInstall as $R0 always equals 0.<br><br>Any ideas where I'm going wrong? The error return implies it either can't load the DLL, or can't find the function in it, but I can't see where I've gone wrong.<br><br>Thanks for any help.<br>Nick.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">2nd March 2009 17:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">you don't need ".dll". you don't need v, just () is fine, other than that it looks ok to me. And I'm sure you know, in this example, ?e is pointless since you don't call SetLastError or other windows api's</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">AxelMock</span><br><span class="post-time small text-muted">2nd March 2009 17:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Re: System::Call not working with custom DLL</strong><br></p><blockquote><i>Originally posted by njshaw2</i><br><br>[B]Hi,<br><br>I've written a function in my own DLL to find out if the user has permission to install the software version (based</blockquote>Last time i fiddled with System::Call I ended up with:<br><br>!define GetPrivateProfileString "kernel32::GetPrivateProfileStringA(t,t,t,t,i,t) i"<br><br><br>and<br>System::Call "${GetPrivateProfileString}('Version', 'DriverVer', '', .r1, ${NSIS_MAX_STRLEN}, r1) .s"<br><br>before it worked.<br><br>So in your case:<br><br>!define CanUserInstall "installer::CanUserInstall(v) i"<br><br>and<br>System::Call "${CanUserInstall} () .R0"<br><br><br>Maybe omitting the ".dll" already helps....<br><br>Good luck</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">2nd March 2009 17:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">AxelMock, dude, you know nsis already has .ini support?<br><br>and a define will not help at all, thats all precompiler magic and does not change the end result</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">njshaw2</span><br><span class="post-time small text-muted">2nd March 2009 18:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks for the suggestions. I've already tried without the ".dll", without the (v) and without the ?e - all give the same result.<br><br>I'm at the stage where I can't see the DLL is actually loaded - I've put OutputDebugStrings in the DLL's DllMain() which are never being called, so either NSIS is failing to load the DLL, or the DLL is not loading properly. Does the DLL need any specific calling convention or build property? I'm using WINAPI for the functions, and the project is built with Multi-threaded DLL support. It's also being built in VS2008, can't see why that could be an issue, but just in case.<br><br>It looks, from the replies, like I'm doing all the right stuff in NSIS (I can do calls to Win32 APIs fine, so I know the system.dll is working and my syntax is pretty much ok) - back to the old VS2008 debugging, it looks like.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">2nd March 2009 20:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Process Monitor from sysinternals should be able to help out. You can see both the filesystem operations to make sure it finds the file, and possible errors when the loader tries to map the dll</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">AxelMock</span><br><span class="post-time small text-muted">3rd March 2009 07:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><i>Originally posted by Anders</i><br><b>AxelMock, dude, you know nsis already has .ini support?<br></b></blockquote>Yes, I know ConfigRead but it does NOT work on a Unicode inf-file.<br>GetPrivateProfileString works. And I can set the section in which to look for the value.<br><br>And converting the inf-file to ANSI did not work on the japanese/chinese Windows machine.<br><br>And last week I didn't have the Unicode to UTF-8 conversion...</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">njshaw2</span><br><span class="post-time small text-muted">16th March 2009 14:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I've found the problem I was having. Subtle. You need to include the path of your dll in the System::Call() information if your dll is not in the system path. The documentation doesn't specify this; it implies it will load it from the last configured "SetOutPath". Obviously not.<br><br>So I used:<br><br>SetOutPath "$TEMP"<br>File "Data\MyFile.dll"<br>System:Call "$TEMP\MyFile.dll:MyFunc() i.r0"<br><br>and from then on it was happy. :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">16th March 2009 15:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I think if you extract your dll to the same folder as the System.dll then it will work (i.e. $PLUGINSDIR).<br><br>Stu</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>