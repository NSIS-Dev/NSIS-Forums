<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="nsExec bug, probably, erroneous first run behavior"><title>nsExec bug, probably, erroneous first run behavior - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">nsExec bug, probably, erroneous first run behavior</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=279683">nsExec bug, probably, erroneous first run behavior</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">chjfth</span><br><span class="post-time small text-muted">22nd October 2007 09:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>nsExec bug, probably, erroneous first run behavior</strong><br>On a Windows machine that nsExec::Exec has never run before, execute a installer generated by the following nsi script:<br><br></p><pre>
<code><br>Name "nsExec Test"<br><br>OutFile "nsExec-Test.exe"<br><br>ShowInstDetails show<br><br>Section "Silent MakeNSIS"<br>    nsExec::Exec "regYYY"<br>        Pop $0 # return value/error/timeout<br>        DetailPrint ""<br>        DetailPrint "       Return value: $0"<br>        DetailPrint ""<br>SectionEnd<br><br></code>
</pre><br>
      <br>
      Of course, you don't have regYYY.exe on your Windows, but you'll get "Return value: 0" , which means execution success [:-(]. However, a second run of the very installer on the same machine will give the result "Return value: error".<br>
      <br>
      You can easily reproduce this symptom by installing a virtual machine software with snapshot functionality, e.g. WMWare Workstation(you are well off making a snapshot before first launching the installer).<br>
      <br>
      Does any developer guy know what the problem is? I'm using NSIS v2.31 .
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">23rd October 2007 00:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Works fine for me returning error every time. Have you been able to reproduce this on more than one VM? Which OS? Which configuration? Reboot helps?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">chjfth</span><br>
      <span class="post-time small text-muted">23rd October 2007 03:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thank you Kichik, before I post this topic, I tried it on two virtual machines, one is Win2k SP4, the other is WinXP SP2(both are simplified Chinese version).<br>
      <br>
      Since Kichik says he tried himself and did not find this problem, I tried again on a new Windows Win2K system(English version). This time nsExec behaves correctly as well. So I suspect that this problem can only be seen on simplified Chinese versions of Windows.<br>
      <br>
      Please download this VMware virtual machine(simplified Chinese Win2k) and try again for me. <a href="http://down.nlscan.com/Misc/Internet-Keep-Ref/_vmware-5-Win2kchs-nsExec-bug.7z" target="_blank">http://down.nlscan.com/Misc/Internet...-nsExec-bug.7z</a><br>
      <br>
      BTW: On every reboot of that Win2K VM, we got 0 from nsExec::Exec, a second run after reboot gives the correct result, i.e, "error".</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">chjfth</span><br>
      <span class="post-time small text-muted">23rd October 2007 04:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Why is my URL submitted hidden by the forum? That URL is:<br>
      <br>
      down.nlscan.com/Misc/Internet-Keep-Ref/_vmware-5-Win2kchs-nsExec-bug.7z</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">23rd October 2007 20:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Your URL is hidden because you're a new user. I get 404 on both posted URLs.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">chjfth</span><br>
      <span class="post-time small text-muted">24th October 2007 01:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Oh sorry, that URL is correct, but the damn IIS6 by default refuses to serve files with the unknown extension name .7z . Now I've corrected it. Please download and try.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">24th October 2007 20:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I get a really lousy download speed of 3kb/s and even that is for no longer than a minute straight which is followed by at least 5 minutes of nothing. Can you upload it to a stabler website?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">chjfth</span><br>
      <span class="post-time small text-muted">25th October 2007 01:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well Kichik, that address is on a server of the company I work for which locates in China. It may be slow for you, so feel free to use any download manager(e.g. FlashGet) to get it. You know, it is hard to find a globally fast website that will gladly host a file larger than 300M bytes. This nsExec issue is not urgent for me. So I can wait several weeks.<br>
      <br>
      Or, if you can get a ISO of Windows 2000/XP simplified Chinese installation disk, you can try installing it on a VM, and I think the problem can be reproduced.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">25th October 2007 19:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well, there's RapidShare, Sendago and others. But I'm still downloading anyway... When it's done, I'll have a look.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">9th November 2007 18:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I found and fixed the problem. The internal process nsExec calls never called ExitProcess but only returned its result on WinMain. If there were any threads attached to that process for some reason and they exited after the main thread, the end result would be their result and not the executed program's result.<br>
      <br>
      I still don't know exactly what caused this to happen just on the first execution in your VMWare, but I don't have time to debug it right now.<br>
      <br>
      This might have even caused some issue someone once reported about nsExec never returning at all. If there's another thread that won't die until ExitProcess is called, it might cause this.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">chjfth</span><br>
      <span class="post-time small text-muted">10th November 2007 14:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thank you Kichik. I'm thankful for your responsiveness.</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>