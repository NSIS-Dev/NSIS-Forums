<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Delete some exe and dll files during install process"><title>Delete some exe and dll files during install process - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Delete some exe and dll files during install process</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=169617">Delete some exe and dll files during install process</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">pgpatron</span><br><span class="post-time small text-muted">16th February 2004 17:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Delete some exe and dll files during install process</strong><br>Hi all,<br><br>I am using an exe file and a dll file during the install process and I want to delete them once their taks are finished.<br><br>I copy them to $INSTDIR and I want to erase them after they have been used.<br><br>In my "Delete" call I received an error and the files left in the $INSTDIR after install process is finished.<br><br>more or less:<br><br>SetOutPath "$INSTDIR"<br>File /r "${SRC}\*.*"<br><br>System::Call 'mydll::AFunctionOfMyFile.dll ...'<br>Delete mydll.dll<br>(ERROR Flag on)<br><br>ExecWait myexe.exe<br>Delete myexe.exe<br>(ERROR Flag on)<br><br>Does anyone knows why I can not erase them and/or how should I do it correctly?<br><br>Thank you in advance,<br><br>Pedro</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">VegetaSan</span><br><span class="post-time small text-muted">16th February 2004 18:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Try this<br><br>SetOutPath "$INSTDIR"<br>File /r "${SRC}\*.*"<br><br>System::Call 'mydll::AFunctionOfMyFile.dll ...'<br>Delete "mydll.dll"<br>(ERROR Flag on)<br><br>ExecWait "$INSTDIR\myexe.exe"<br>Delete "myexe.exe"<br>(ERROR Flag on)<br><br>Please tell me if it works :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pgpatron</span><br><span class="post-time small text-muted">16th February 2004 18:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">It does not work. Both files are blocked by the installer program... What can I do? :( :(</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">VegetaSan</span><br><span class="post-time small text-muted">16th February 2004 18:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">What's the error??</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pgpatron</span><br><span class="post-time small text-muted">16th February 2004 19:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I have achieved to fix the problem with the exe file by calling the Delete inside the .onGUIend function inspite of doing it just after its Execwait call.<br><br>But that does not work with the DLL System::Call. It is still blocked by the install process whe that function is called.<br><br>Help please.<br><br>I have bee following the C.5 Calling an external DLL using the System.dll plugin page of the NSIS manual<br><br>Inside this page a comment of the example says:<br>; last plugin call must not have /NOUNLOAD so NSIS will be able to delete<br>; the temporary DLL<br><br>That is what I want to do: Delete the DLL. But I do not understand the meaning of this comment. I have tried with the 'SetPluginUnload manual' and without it and with 'System::Free 0' and without it.<br><br>Could you help me please?<br><br>Thanks.<br><br>Pedro</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pgpatron</span><br><span class="post-time small text-muted">17th February 2004 09:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I have found in the NSIS System Plugin(c) documentation the following option:<br>u - unload DLL after call (using FreeLibrary, so you'll be able to do something with it, delete for example)<br><br>DELETE FOR EXAMPLE!!! Great!! That's what I want to do!<br><br>But there is no example (I neither didn't find in forum) and the doc is not very clear for my understanding.<br><br><br>Could somebody show me an example of how to do a System::Call to a DLL with this option?<br><br>Thank you all,</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pgpatron</span><br><span class="post-time small text-muted">17th February 2004 09:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Fixed :D</strong><br>I have already fixed the problem.<br>:D :D<br><br>Maybe It could help somebody:<br><br>StrCpy $9 "$INSTDIR\${MYPROGRAM}"<br>System::Call 'mydll::myfunc(t) i (r9) r8 ? u'<br><br>SetPluginUnload manual<br>System::Free 0<br><br>Delete mydll.dll<br><br>It runs!!! :) :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">EnCey</span><br><span class="post-time small text-muted">20th March 2008 10:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I'm facing the same problem, but unfortunately the above solution doesn't work for me...<br>Here's my code:<br></p><pre>
<code><br>  StrCpy ${errorText} ""<br>  DetailPrint "Executing ${function} ..."<br>  <br>  ; load dll<br>  System::Call "kernel32::LoadLibrary(t '${dll}') i .r0 ? e"<br>  IntCmp $0 0 callWebCAError_${LN} callWebCAError_${LN} 0<br><br>  ; get function address<br>  System::Call "kernel32::GetProcAddress(i r0, t '${function}') i .r1 ? e"<br>  IntCmp $1 0 callWebCAError_${LN} callWebCAError_${LN} 0<br><br>  ; call function<br>  System::Call "::$1(${arg}) i .r2 ? e"<br>  IntCmp $2 0 callWebCAError_${LN} callWebCAError_${LN} 0<br>  <br>  goto callWebCASuccess_${LN}<br><br>  callWebCAError_${LN}:<br>    IntCmp $0 0 0 0 +2<br>      DetailPrint "Can't load library $\"${dll}$\"!"<br>    IntCmp $1 0 0 0 +2<br>      DetailPrint "Function $\"${function}$\" not found!"<br>    Pop $0<br>    StrCmp $0 "" 0 +2<br>      StrCpy $0 "[NSIS] Unknown Error"<br>    StrCpy ${errorText} "Error: ${function} failed (Error: $0)"<br>    DetailPrint ${errorText}<br>    goto callWebCAFinish_${LN}<br>    <br>  callWebCASuccess_${LN}:<br>    DetailPrint "Successfully executed ${function}! (return value: $2)"<br><br>  callWebCAFinish_${LN}:<br>    System::Call "kernel32::FreeLibrary(i r0) b s ?e"<br>    ClearErrors<br><br></code>
</pre><br>
      <br>
      I can't delete the dll, it's locked.<br>
      SetPluginUnload manual<br>
      System::Free 0<br>
      before deletion doesn't work either.<br>
      I'm extracting the dll before using it and try to delete it afterwards, both in install and uninstall sections
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">20th March 2008 19:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Your FreeLibrary call is invalid as `b` is not a valid type. You should use `i` instead.<br>
      <br>
      And this entire piece of code can be replaced by a single System::Call line as it will load the library and find the proc for you.</p>
      <pre>
<code>System::Call "${dll}::${function}(i ${arg}) ?u"</code>
</pre>Notice the added "?u" that causes System to call FreeLibrary immediately after the call.
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">EnCey</span><br>
      <span class="post-time small text-muted">21st March 2008 08:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Omg shame on me ^^<br>
      I was reading the code again and again and never noticed....<br>
      <br>
      I've tried to replace all the code with the single line of code after I've read the first post in this thread, but had some errors. I'll try later when I've more time.<br>
      Thanks kichik!</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>