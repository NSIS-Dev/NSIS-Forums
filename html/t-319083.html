<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Problem with kernel32::ReadFile" />

  <title>Problem with kernel32::ReadFile - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.2/readable/bootstrap.min.css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Problem with kernel32::ReadFile</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=319083">Problem with kernel32::ReadFile</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">santana108</span><br />
      <span class="post-time small text-muted">10th May 2010 19:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Problem with kernel32::ReadFile</strong><br />
      &nbsp; I am having a problem with the Windows ReadFile function when executing it with the system.dll plug-in. I am able to open the file and get the file size with the kernel32 functions, so I know that the file handle is valid. When I attempt to read data from the file with the ReadFile Function it always returns 0 indicating failure and 0 bytes read. The GetLastError returns the code file already exists which is probably from when the file was opened with CreateFile. If anyone has an idea as to what might be wrong I would be bery gratefull for a response. The code snippet is below<br />
      <br />
      !define OPEN_EXISTING 3<br />
      !define CREATE_NEW 1<br />
      !define CREATE_ALWAYS 2<br />
      <br />
      !define FILE_ATTRIBUTES_NORMAL 128<br />
      !define GENERIC_WRITE 0x40000000<br />
      !define GENERIC_READ 0x80000000<br />
      <br />
      System::Call Alloc 80 ; Allocate memory for read buffer<br />
      Pop $0 ; Pointer to Read Buffer<br />
      <br />
      System::Call "kernel32::CreateFile(t '$INSTDIR\$1', ${GENERIC_READ},i 0, i 0, i ${OPEN_EXISTING}, i ${FILE_ATTRIBUTES_NORMAL}, i 0) i .r8"<br />
      <br />
      System::Call "kernel32::GetFileSize(i r8, i 0) i .r6"<br />
      <br />
      System::Call "kernel32::ReadFile(i r8, i r0, i 80, *i .r2, i 0) i .r3"<br />
      <br />
      <br />
      Chris Lustig</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">10th May 2010 19:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Any reason you are using that instead of FileOpen/FileRead/FileClose?<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">santana108</span><br />
      <span class="post-time small text-muted">10th May 2010 19:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by Afrow UK</small><br />
        Any reason you are using that instead of FileOpen/FileRead/FileClose?<br />
        <br />
        Stu
      </blockquote>I am trying to copy binary CAB files from a PC to a Windows CE device attached to PC with ActiveSync. If FileRead encounters the code for a new line it is going to return and I will not know how many bytes have been read. Also I was allocating memory for a buffer that is bigger than 1024 bytes.<br />
      <br />
      Chris
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">f0rt</span><br />
      <span class="post-time small text-muted">10th May 2010 22:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">My guess would be that<br /></p>
      <pre>
<code>
System::Call Alloc 80 ; Allocate memory for read buffer 
<br />&gt;
</code>
</pre>should be changed into<br />
      <pre>
<code>
System::Alloc 80 ; Allocate memory for read buffer 
<br />&gt;
</code>
</pre>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
