<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Major help on script requested"><title>Major help on script requested - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Major help on script requested</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=273072">Major help on script requested</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">JayGunter</span><br><span class="post-time small text-muted">19th June 2007 08:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Major help on script requested</strong><br>Hey guys (&amp; gals),<br><br>Let me just say I am new to the whole NSIS scripting language, but I believe this is a pretty good script for a beginner. I wrote a driver for Windows 98 SE giving it FULL USB support (This means you can use any USB Mass Storage Device on Windows 98 SE with only one driver).<br><br>To make the installation of the driver easier for the average user, I am compiling this release as an installer. Although, I am having some troubles. I was wondering if any brave soul wanted to look at it and tweak it or give me some tips. I have perfected the registry keys for uninstallation.<br><br>Here are some problems I am experiencing:<br><br>- After you accept the License Agreement and continue to the next page then click back you must click Accept again even if the button is filled in to re-enable the next button.<br><br>- The uninstaller..it is TERRIBLE. :igor: I know that is vague..but look at it yourself.<br><br>Things I would like to add:<br><br>- Operating System detection at the beginning (Where only Windows 98 SE can run setup)<br><br>- If the install somehow fails take the user to a page saying it did not install properly.<br><br><br>NOTE: If you are NOT using Windows 98 and would still like to help please put an ";" at the beginning of line 54 to disable merging with the driver database. What this will do, really, is just extract files to the installation directory.<br><br>Due to size restriction on the forums I have uploaded my 180kb archive to and external hosting site. You can find it it at http://www.freewebs.com/customizefacebook/Build2.7z<br><br>You must have 7Zip installed on your computer to open it. You can download 7Zip at <a href="http://www.7zip.org" target="_blank">http://www.7zip.org</a><br><br>Thank you,<br><br>Jay Gunter</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">19th June 2007 10:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">The uninstaller is terrible? Yes that is a bit vague lol. Do you mean it's functionality or look? Are you not using Modern UI?<br><br>There are many functions out there to detect the operating system, one of which is the WinVer.nsh extension to LogicLib.nsh.<br><br>If the install fails the Finish page will reflect this with Modern UI.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JayGunter</span><br><span class="post-time small text-muted">19th June 2007 17:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I am using the modern UI, but there are no images or text on the uninstaller.<br><br>Here is my uninstall script.<br><br>;--------------------------------<br>;Uninstaller Section<br><br>!insertmacro MUI_UNPAGE_WELCOME<br>!insertmacro MUI_UNPAGE_INSTFILES<br>!insertmacro MUI_UNPAGE_FINISH<br><br>Section "Uninstall"<br><br>DELETE "$INSTDIR\*.*"<br>RMDir "$INSTDIR"<br><br>DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\USB Storage Driver"<br><br>SectionEnd<br><br>Is there something I am missing to put images in the uninstaller like I did with the<br><br>!define MUI_WELCOMEFINISHPAGE_BITMAP "modern-wizard.bmp"<br>!define MUI_HEADERIMAGE<br>!define MUI_HEADERIMAGE_RIGHT<br>!define MUI_HEADERIMAGE_BITMAP "modern-header.bmp"<br><br>functions for the installer?<br><br>Jay</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JayGunter</span><br><span class="post-time small text-muted">19th June 2007 17:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I hate to double post but like I said earlier, you can check out my script at:<br><br><a href="http://www.freewebs.com/customizefacebook/Build2.7z" target="_blank">http://www.freewebs.com/customizefacebook/Build2.7z</a></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">19th June 2007 19:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Why didn't you notice the 11 warnings that makensisw was throwing at you (literally!)?<br><br>Your page definitions need to go above the language insertions, whereas currently your uninstall page definitions are below.<br>You also need to use MUI_HEADERIMAGE_UNBITMAP for the uninstaller (more info in the Modern UI manual).<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">JayGunter</span><br><span class="post-time small text-muted">19th June 2007 20:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Yeah, I saw those but like I said before I am a beginner, and I don't know how to fix those warnings. So you suggest moving my page definitions above my language stuff it should work...<br><br>Now what is my problem with the License Agreement where if you continue to the next page then go back you have to click the already filled bubble to re-enable the next button.<br><br>And how do I setup the script for OS detection with the WinVer.nsh extension to LogicLib.nsh? Sorry I am a newbie guys. Bear with me..</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">19th June 2007 21:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><pre>
<code>!include LogicLib.nsh<br>!include WinVer.nsh<br><br>...<br><br>${If} ${AtleastWin98}<br>  MessageBox MB_OK ja!<br>${EndIf}</code>
</pre><br>
      <br>
      Also, you can change this:<br>
      <pre>
<code>InstallOptions::initDialog /NOUNLOAD "$PLUGINSDIR\ioA.ini"<br>GetDlgItem $1 $HWNDPARENT 1<br>EnableWindow $1 0<br>InstallOptions::show</code>
</pre><br>
      To:<br>
      <pre>
<code>ReadINIStr $0 "$PLUGINSDIR\ioA.ini" "Field 4" "State"<br>StrCmp $0 1 +3<br>  GetDlgItem $1 $HWNDPARENT 1<br>  EnableWindow $1 0<br><br>InstallOptions::display "$PLUGINSDIR\ioA.ini"</code>
</pre><br>
      Reason being the Next button is not part of the InstallOptions dialog.<br>
      <br>
      Also, regarding your uninstall code (which will not work because Delete *.* does not remove sub folders, only all files in a folder), see this page:<br>
      <a href="http://nsis.sourceforge.net/Validating_%24INSTDIR_before_uninstall" target="_blank">http://nsis.sourceforge.net/Validati...fore_uninstall</a><br>
      <br>
      Stu
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JayGunter</span><br>
      <span class="post-time small text-muted">20th June 2007 05:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I changed to what you suggested but I receive an error "Invalid command: InstallOptions::display" I still ussed you suggestion but changed to "InstallOptions::show "$PLUGINSDIR\ioA.ini"" But now the page is skipped.<br>
      <br>
      I am using NSIS 2.28.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">20th June 2007 12:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Sorry, should be InstallOptions::dialog.<br>
      <br>
      Stu</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JayGunter</span><br>
      <span class="post-time small text-muted">20th June 2007 19:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That is great! Now I added the operating system detection but can NSIS determine Windows 98 from Windows 98 SE?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">20th June 2007 19:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">WinVer.nsh does not have support for that unfortunately. Maybe you could post a feature request on the NSIS SourceForge page.<br>
      Otherwise;<br>
      <a href="http://nsis.sourceforge.net/GetVersion_%28Windows%29_plug-in" target="_blank">http://nsis.sourceforge.net/GetVersi...ows%29_plug-in</a><br>
      <br>
      Stu</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JayGunter</span><br>
      <span class="post-time small text-muted">20th June 2007 20:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I know that Windows 98 has a registry key that its value is "Windows 98 SE" is there a way I can configure my script to launch if the registry key is present and if it is not display and error message.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">20th June 2007 20:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">ClearErrors<br>
      ReadRegStr ...<br>
      IfErrors ...<br>
      <br>
      Stu</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JayGunter</span><br>
      <span class="post-time small text-muted">20th June 2007 20:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Okay! I think I am almost done with all my questions. But here is my last one. On the validating the uninstall before uninstalling section..I am having trouble with what it would look like for my script.<br>
      <br>
      Here's what I have:<br>
      <br>
      Section "Uninstall"<br>
      <br>
      StrCmp $INSTDIR "" 0 +3<br>
      MessageBox MB_OK|MB_ICONSTOP "Error: The install path missing!"<br>
      Abort<br>
      <br>
      StrCpy $R0 $INSTDIR "" -6<br>
      StrCmp $R0 "\USB Storage Driver" +3<br>
      MessageBox MB_YESNO|MB_ICONQUESTION "What brings up this box??" IDYES +2<br>
      Abort<br>
      <br>
      IfFileExists "$INSTDIR\*.*" +4<br>
      IfFileExists "$INSTDIR\CSETUP.exe" +3<br>
      MessageBox MB_OK|MB_ICONSTOP "Install path invalid!"<br>
      Abort<br>
      <br>
      DELETE "$INSTDIR\*.*"<br>
      RMDir "$INSTDIR"<br>
      <br>
      DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\USB Storage Driver"<br>
      <br>
      SectionEnd</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">20th June 2007 22:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">As I already said, Delete "$INSTDIR\*.*" will not delete sub folders. Either you delete all files and subfolders individually from the highest level down, or you use RMDir /r "$INSTDIR\*.*". This is NOT recommended in case the user has put his own files in there since the installation.<br>
      <br>
      Stu</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">JayGunter</span><br>
      <span class="post-time small text-muted">20th June 2007 23:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">How does this look?<br>
      <br>
      Section "Uninstall"<br>
      <br>
      StrCmp $INSTDIR "" 0 +3<br>
      MessageBox MB_OK|MB_ICONSTOP "Install path missing!"<br>
      Abort<br>
      <br>
      StrCpy $R0 $INSTDIR "" -6<br>
      StrCmp $R0 "\USB Storage Driver" +3<br>
      MessageBox MB_YESNO|MB_ICONQUESTION "..." IDYES +2<br>
      Abort<br>
      <br>
      IfFileExists "$INSTDIR\*.*" +4<br>
      IfFileExists "$INSTDIR\_nusb.inf" +3<br>
      MessageBox MB_OK|MB_ICONSTOP "Install path invalid!"<br>
      Abort<br>
      <br>
      DELETE "$INSTDIR\_NUSB.INF"<br>
      DELETE "$INSTDIR\1394.IN"<br>
      DELETE "$INSTDIR\1394BUS.SYS"<br>
      DELETE "$INSTDIR\CSETUP.EXE"<br>
      DELETE "$INSTDIR\DISKTSD.VXD"<br>
      DELETE "$INSTDIR\HARDWARE.HLP"<br>
      DELETE "$INSTDIR\IOS.VXD"<br>
      DELETE "$INSTDIR\NODRIVER.INF"<br>
      DELETE "$INSTDIR\NTMAP.INF"<br>
      DELETE "$INSTDIR\NTMAP.SYS"<br>
      DELETE "$INSTDIR\NTMAPHLP.PDR"<br>
      DELETE "$INSTDIR\OHCI1394.SYS"<br>
      DELETE "$INSTDIR\QFECHECK.EXE"<br>
      DELETE "$INSTDIR\QFECHECK.HLP"<br>
      DELETE "$INSTDIR\SBP2PORT.SYS"<br>
      DELETE "$INSTDIR\USBAUTH.SYS"<br>
      DELETE "$INSTDIR\USBMPHLP.PDR"<br>
      DELETE "$INSTDIR\USBNTMAP.INF"<br>
      DELETE "$INSTDIR\USBNTMAP.SYS"<br>
      DELETE "$INSTDIR\USBSTOR.INF"<br>
      DELETE "$INSTDIR\USBSTOR.SYS"<br>
      DELETE "$INSTDIR\USBU2A.SYS"<br>
      DELETE "$INSTDIR\W95INF16.DLL"<br>
      DELETE "$INSTDIR\W95INF32.DLL"<br>
      RMDir "$INSTDIR"<br>
      <br>
      DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\USB Storage Driver"<br>
      <br>
      SectionEnd<br>
      <br>
      And what does this function do?<br>
      <br>
      StrCpy $R0 $INSTDIR "" -6<br>
      StrCmp $R0 "\USB Storage Driver" +3<br>
      MessageBox MB_YESNO|MB_ICONQUESTION "..." IDYES +2<br>
      Abort<br>
      <br>
      I want to know what causes the message box to display so I can change the message in the message box.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">21st June 2007 10:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That code is much better :)<br>
      The RMDir without the /r switch will ensure that the folder is only removed if it is empty and therefore any user files will remain.<br>
      <br>
      That one will take the last 6 characters from the end of the path and compare it to a value. Your message box should ask them whether they wish to continue uninstalling because the path to uninstall from does not have "USB Storage Driver" on the end (may want to word that differently).<br>
      Also, as "\USB Storage Driver" is not the same as "\MyApp", it's length is different. -6 should be -19.<br>
      <br>
      Stu</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>