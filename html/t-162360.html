<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="GetDeviceCaps Macro" />

  <title>GetDeviceCaps Macro - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">GetDeviceCaps Macro</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=162360">GetDeviceCaps Macro</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">billym</span><br />
      <span class="post-time small text-muted">29th December 2003 18:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>GetDeviceCaps Macro Help</strong><br />
      can someone assist me with getting the bitdepth converted. I want the output to be in bits ex. 1, 2, 4, 8, 16, etc...<br />
      <br />
      here is what I have so far.<br />
      <br />
      !macro GetDeviceCaps devCap<br />
      <br />
      System::Call "user32::GetDC(i $HWNDPARENT) i .s"<br />
      System::Call "gdi32::GetDeviceCaps(i s, i ${devCap}) i .r0"<br />
      StrCmp ${devCap} "BITSPIXEL" +1 +3<br />
      System::Call "kernel32::MulDiv??????????????<br />
      <br />
      <br />
      !macroEnd<br />
      <br />
      !insertmacro GetDeviceCaps "BITSPIXEL"</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joel</span><br />
      <span class="post-time small text-muted">30th December 2003 16:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Just for the record, did you get the awnser?<br />
      Maybe <a href="http://nsis.sourceforge.net/archive/viewpage.php?pageid=325" target="_blank">I can help</a>... :)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">billym</span><br />
      <span class="post-time small text-muted">30th December 2003 22:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Actually no, but I did get it working partially. I have a macro that is almost complete for calling the getdevice cap api.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">billym</span><br />
      <span class="post-time small text-muted">31st December 2003 14:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I am in the process of creating the plugin version of this as well but having a problem. Here is my function:<br />
      <br />
      void __declspec(dllexport) nsGetDeviceCaps(HWND hwndParent, int string_size, char *variables, stack_t **stacktop)<br />
      {<br />
      char buf[1024];<br />
      popstring(buf);<br />
      EXDLL_INIT();<br />
      {<br />
      HWND winHandle = GetDesktopWindow();<br />
      HDC deviceContext = GetDC(winHandle);<br />
      int colorDepth = GetDeviceCaps(deviceContext, buf);<br />
      ltoa(colorDepth, buf, 10);<br />
      pushstring(buf);<br />
      }<br />
      }<br />
      <br />
      This fails when I call it from the script like this:<br />
      <br />
      nsAPIgdi::nsGetDeviceCaps BITSPIXEL<br />
      <br />
      I have determined that the cause of the problem is when the parameter is passed to the function. In the case of this API call, the params that get passed are defined in a header file. "BITSPIXEL", when passed into the buffer does not get changed into the defined value before being handed off to the API call causing it to fail.<br />
      <br />
      I am a DOTNET developer and learning C/C++ at the moment. Really enjoying nsis. I am starting with this plugin as the first of a framework of nsAPI plugins for the more advanced API's that are harder to call from the system plugin. I have intentions of working on suites of these plugins so that you can choose any number of these mini-plugins for your installer without bloating your install package.<br />
      <br />
      If someone knows how to get the function to lookup the value of the parameter passed before the API is called it would really help.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joel</span><br />
      <span class="post-time small text-muted">31st December 2003 16:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Yeah, it's the <b>HWND hwndParent</b>.<br />
      You'll need to use strings....<br />
      Use some of atoi or atof functions to convert a string to a decent integer or long integer.<br />
      There's a function in system plugin source named "myatoi".</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">billym</span><br />
      <span class="post-time small text-muted">31st December 2003 18:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If I try to do it this way I will need to build a reference table for all of the defines that already exist. I am looking for a way to make the API call to see my parameter as the define that windows provides for this API. I may be wrong. Could you please provide an example.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joel</span><br />
      <span class="post-time small text-muted">31st December 2003 19:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Let me try one....</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">1st January 2004 17:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You can't use defines in the plug-in. Defines are processed at compile time on the compiler side. You will have to convert the string into a number as Lobo suggested.<br />
      <br />
      As for the System.dll code, as BITPIXEL was only defined when the macro was inserted, it wasn't defined when you actually called !insertmacro. That means that ${BITSPIXEL} was passed as ${BITSPIXEL} and not as 12.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">billym</span><br />
      <span class="post-time small text-muted">2nd January 2004 14:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">It seems to handle the conversion of ${BITSPIXEL} to the 12 fine in this example.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">2nd January 2004 14:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">It handles the conversion once BITSPIXEL is actually defined. That only happens after the macro is inserted for the first time. You should define it outside of the macro so you can use it as a parameter for the macro without actually inserting the macro.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">billym</span><br />
      <span class="post-time small text-muted">2nd January 2004 15:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">So instead of just uncommenting the defines needed within the macro you would define the params in your script and never modify the macro?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">2nd January 2004 15:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You should define them above the macro definition but still in the header file. See Include\Sections.nsh for an example.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
