<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="How to write a good Device Driver installer?" />

  <title>How to write a good Device Driver installer? - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">How to write a good Device Driver installer?</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=233055">How to write a good Device Driver installer?</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">eran.liberty</span><br />
      <span class="post-time small text-muted">13th December 2005 10:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>How to write a good Device Driver installer?</strong><br />
      I have 2 years old, C++ based, custom installer code for a SCSI CD drive emulation.<br />
      I wish to port it to NSIS.<br />
      <br />
      The original code has references to functions like:<br />
      SetupDiRegisterDeviceInfo, SetupDiSetDeviceRegistryProperty, SetupDiCallClassInstaller and more SetupDiXXX commands, all of which are nicely documented in the MSDN. I have seen no reference for them in the NSIS, Examples or this forum.<br />
      (like to msdn info: <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/devio/base/device_interface_classes.asp" target="_blank">http://msdn.microsoft.com/library/de...ce_classes.asp</a>)<br />
      <br />
      A bit of google'ing raised the possibility that the paradigm for device driver installation may have changed to functions like: DriverPackagePreinstall(), DriverPackageInstall(), DriverPackageUninstall() and DriverPackageGetPath(). Those have no reference in NSIS as well.<br />
      (link to msdn info: <a href="http://www.microsoft.com/whdc/driver/install/DIFxtls.mspx" target="_blank">http://www.microsoft.com/whdc/driver...l/DIFxtls.mspx</a>)<br />
      <br />
      NSIS on its part suggest these two helpful links:<br />
      link1: <a href="http://nsis.sourceforge.net/Driver_installation_and_update" target="_blank">http://nsis.sourceforge.net/Driver_i...ion_and_update</a><br />
      link2: <a href="http://nsis.sourceforge.net/Service_Control_Manager_plugin_(install_services_and_drivers_on_NT/2K/XP)" target="_blank">http://nsis.sourceforge.net/Service_...s_on_NT/2K/XP)</a><br />
      <br />
      Now here comes the question (at last):<br />
      <br />
      1. What is the right way to write a device driver installer these days? (regardless to NSIS support on the matter)<br />
      <br />
      2. What is NSIS support on the matter? (admit you did not see that one coming :) )<br />
      <br />
      10x, Liberty</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">13th December 2005 16:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You can call external DLL functions with the System plugin which is bundled with NSIS.<br />
      <br />
      -Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">eran.liberty</span><br />
      <span class="post-time small text-muted">13th December 2005 16:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by Afrow UK</i><br />
        <b>You can call external DLL functions with the System plugin which is bundled with NSIS.<br />
        -Stu</b>
      </blockquote>ofcourse I can... but for that I need a DLL plugin... hmmm...<br />
      <br />
      so I repharse my two questions....<br />
      <br />
      1. is there such a plugin that does all I need... saving me the time to write it myself?<br />
      <br />
      2. assuming I will write a plugin myself a.k.a "the hard way, all the way". which installer technology is superior the SetupDiXXX or the DriverPackageXXX.?<br />
      <br />
      Liberty
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">13th December 2005 18:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <ol style="list-style-type: decimal">
        <li>If it's not on the Wiki, it probably doesn't exist. It seems you'd have to write one yourself. If you do end up writing one, please upload it to the Wiki.</li>

        <li>It seems DriverPackage* was created after SetupDi* and its description at microsoft.com also states it's simpler. So I guess it's preferable. But I'd make sure it works on all target platforms first. It's very new, so it might work on 2000 and above only, or even XP and above.</li>
      </ol>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">onad</span><br />
      <span class="post-time small text-muted">14th December 2005 01:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You could do an exec of the ".inf" file belonging to the driver... in NSIS, maybenot fully taking the posibillity NSIS has to offer , but you are helped maybe.<br />
      <br />
      running an ".inf" is also not a easy task, some of my Delphi code I once used to install/uninstall device drivers. This Pseudo code you could convert to NSIS script<br />
      <br />
      Whatever way you will solve it, I expect it will not be easy . Alternatively you could post a message with an offer to pay someone to do it for you.<br />
      <br />
      -----------------------------------------<br />
      <br />
      const<br />
      rsUSN = 'DefaultUninstall';<br />
      rsUSNntx86 = 'DefaultUninstall.ntx86'; //make sure these sections exist in your .inf file<br />
      rsShellRunDLL32 = 'rundll32.exe';<br />
      <br />
      <br />
      ...<br />
      <br />
      if IsWinNT then<br />
      UninstallSectionName:=rsUSNntx86<br />
      else<br />
      UninstallSectionName:=rsUSN;<br />
      <br />
      ...<br />
      <br />
      UnInstallLine:='advpack.dll,LaunchINFSection '+UninstallInfFileName+', '+UninstallSectionName;<br />
      TargetPath:='';<br />
      <br />
      shellexecute(h, 'open',pchar(rsShellRunDLL32),pchar(UnInstallLine),pchar(TargetPath),SW_SHOWNORMAL);</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">onad</span><br />
      <span class="post-time small text-muted">14th December 2005 01:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Oh, I forgot<br />
      <br />
      On 9x/ME following the DriverPackage* will not work.<br />
      <br />
      You can also just mimic the behaviour of the inf file alltougheter by writing to the registry, pathe etc yourself.<br />
      <br />
      For this you can take a snapshot with system snapshot tools for the registry, and then monitor the API calls when the driver gets installed with other tools. <a href="http://www.sysinternals.com/" target="_blank">http://www.sysinternals.com/</a> has some monitoring tools for free. Also the Windowze tool may help.<br />
      <br />
      Good luck, you need that... and persistance!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">eran.liberty</span><br />
      <span class="post-time small text-muted">14th December 2005 12:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by kichik</i><br />
        <b>It seems DriverPackage* was created after SetupDi* and its description at microsoft.com also states it's simpler. So I guess it's preferable. But I'd make sure it works on all target platforms first. It's very new, so it might work on 2000 and above only, or even XP and above.</b>
      </blockquote>did some more homework and in the "Kernel-Mode Driver Framework" (<a href="http://www.microsoft.com/whdc/driver/wdf/KMDF_pkg.mspx" target="_blank">http://www.microsoft.com/whdc/driver/wdf/KMDF_pkg.mspx</a>) the use of Co-Installer (SetupDi* functions) is explicitly specified.<br />
      maybe DriverPackage* and SetupDi* are not eqvivalent in some way or maybe the KMDF is not up to date...<br />
      I will look for some microsoft forum for this one.
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
