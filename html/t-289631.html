<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Check if directory is writable" />

  <title>Check if directory is writable - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Check if directory is writable</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=289631">Check if directory is writable</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">madjerry</span><br />
      <span class="post-time small text-muted">4th April 2008 12:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Check if directory is writable</strong><br />
      Hi,<br />
      <br />
      I'm working on a installer that needs to install programs on non administrative accounts, and has to work on Vista with UAC on or off. So i made a script that does not require admin rights and by default it installs a program to C:\My Games, so far so good. The scrip works just fine until user decides to change installDir, if that happened and the installdir is a Directory that requires admin rights to write the files will not copy :( So i i had an idea to check if selected directory can be written this is the code for that<br />
      <br />
      !include "FileFunc.nsh"<br />
      !insertmacro GetFileAttributes<br />
      !insertmacro GetParent<br />
      <br />
      Function IsWritable<br />
      !define IsWritable `!insertmacro IsWritableCall`<br />
      <br />
      !macro IsWritableCall _PATH _RESULT<br />
      Push `${_PATH}`<br />
      Call IsWritable<br />
      Pop ${_RESULT}<br />
      !macroend<br />
      <br />
      Exch $R0<br />
      Push $R1<br />
      <br />
      loop:<br />
      StrLen $R1 $R0<br />
      StrCmp $R1 0 isbad<br />
      ${GetFileAttributes} $R0 "DIRECTORY" $R1<br />
      StrCmp $R1 0 parent<br />
      ${GetFileAttributes} $R0 "READONLY" $R1<br />
      StrCmp $R1 1 isbad<br />
      Goto isok<br />
      <br />
      parent:<br />
      ${GetParent} $R0 $R0<br />
      Goto loop<br />
      <br />
      isbad:<br />
      StrCpy $R1 1<br />
      Goto exit<br />
      <br />
      isok:<br />
      StrCpy $R1 0<br />
      Goto exit<br />
      <br />
      exit:<br />
      Exch<br />
      Pop $R0<br />
      Exch $R1<br />
      <br />
      FunctionEnd<br />
      <br />
      Function .onVerifyInstDir<br />
      <br />
      Push $R1<br />
      ${IsWritable} $INSTDIR $R1<br />
      IntCmp $R1 0 pathgood<br />
      Pop $R1<br />
      Abort<br />
      <br />
      pathgood:<br />
      Pop $R1<br />
      <br />
      FunctionEnd<br />
      <br />
      I based IsWritable function on some code i found here, the problem is that this does not work as intended, for eg if i select ProgramFiles it will detect that i cant write there, but if i select any other dir inside ProgamFiles it will allow me to install there. So i had another idea to check if any parent dir of the InstalDir is read-only, that did not work as well because it allowed installation to C:\Windows. My next idea is to find first parent dir of the install dir and create a dir there, if dir is created i will allow installation in that dir and than delete that dir, if dir was not created i will not allow to install there. I know that it is not the best idea but I cant find any other solution to my problem. Does anyone know how to check if installdir can be written ? Or is there any other way to prevent user to select invalid installdir ?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mauvecloud</span><br />
      <span class="post-time small text-muted">4th April 2008 13:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I wouldn't suggest relying on file attributes when dealing with the UAC. I think it's better to try to create the directory (and possibly a file in it, in case the directory already exists), and consider the directory invalid if the installer couldn't create the directory (and/or the file)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">madjerry</span><br />
      <span class="post-time small text-muted">4th April 2008 14:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Creating a directory, did not work :(<br />
      <br />
      CreateDirectory "$R0\T_S"<br />
      ${GetFileAttributes} "$R0\T_S" "DIRECTORY" $R1<br />
      StrCmp $R1 0 isbad<br />
      RMDir "$R0\T_S"<br />
      <br />
      $R0 contains the path to the firs existing parent of the installdir, CreateDirectory - i have read that this function sets an error if it fails, how can i check if the function failed ?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mauvecloud</span><br />
      <span class="post-time small text-muted">4th April 2008 14:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Use IfErrors.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">madjerry</span><br />
      <span class="post-time small text-muted">4th April 2008 15:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi, again i have spend quite some time trying to make this work. Does anyone know what can i use to create a installer that will properly work on vista ? By properly i mean handling user directory with UAC, creating shortcuts etc. The current version of installation can be downloaded @ <a href="http://codeminion.com/downloads/StoneLoopsSetup.exe" target="_blank">http://codeminion.com/downloads/StoneLoopsSetup.exe</a><br />
      it works correctly- creates shortcuts in proper places, does not require admin password, but when user who is not admin changes installdir to one that requires admin rights the installer will not copy the files. Is there anyone out there who know how to handle this ?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">mauvecloud</span><br />
      <span class="post-time small text-muted">4th April 2008 15:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Try something more like this:<br />
      CreateDirectory $INSTDIR<br />
      IfErrors isbad<br />
      RMDir $INSTDIR<br />
      <br />
      Alternatively, reject the installation directory as invalid if traversing the list of parents finds a match for $PROGRAMFILES, $WINDIR, etc., even if the user is operating in XP or as an admin with the UAC off.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">madjerry</span><br />
      <span class="post-time small text-muted">4th April 2008 15:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hey,<br />
      <br />
      mauvecloud, thx for your help, i finally got the script working, here is the code: i will improve it a bit to make it more better but hey it works!<br />
      <br />
      RequestExecutionLevel user<br />
      <br />
      !include "FileFunc.nsh"<br />
      !insertmacro GetFileAttributes<br />
      !insertmacro GetParent<br />
      <br />
      Function IsWritable<br />
      <br />
      SetShellVarContext current<br />
      !define IsWritable `!insertmacro IsWritableCall`<br />
      <br />
      !macro IsWritableCall _PATH _RESULT<br />
      Push `${_PATH}`<br />
      Call IsWritable<br />
      Pop ${_RESULT}<br />
      !macroend<br />
      <br />
      Exch $R0<br />
      Push $R1<br />
      <br />
      loop:<br />
      StrLen $R1 "$R0"<br />
      StrCmp $R1 0 isbad<br />
      <br />
      IfFileExists "$R0" 0 parent<br />
      ${GetFileAttributes} "$R0" "DIRECTORY" $R1<br />
      StrCmp $R1 0 parent<br />
      ${GetFileAttributes} "$R0" "READONLY" $R1<br />
      StrCmp $R1 1 isbad<br />
      Goto testdir<br />
      <br />
      parent:<br />
      ${GetParent} "$R0" "$R0"<br />
      Goto loop<br />
      <br />
      isbad:<br />
      StrCpy $R1 1<br />
      Goto exit<br />
      <br />
      testdir:<br />
      ClearErrors<br />
      CreateDirectory "$R0\T_S"<br />
      IfErrors isbad isok<br />
      <br />
      isok:<br />
      RMDir "$R0\T_S"<br />
      StrCpy $R1 0<br />
      Goto exit<br />
      <br />
      exit:<br />
      Exch<br />
      Pop $R0<br />
      Exch $R1<br />
      <br />
      FunctionEnd<br />
      <br />
      Function .onVerifyInstDir<br />
      <br />
      Push $R1<br />
      ${IsWritable} $INSTDIR $R1<br />
      IntCmp $R1 0 pathgood<br />
      Pop $R1<br />
      Abort<br />
      <br />
      pathgood:<br />
      Pop $R1<br />
      <br />
      FunctionEnd<br />
      <br />
      If you have any ideas no how to improve this let me know</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">madjerry</span><br />
      <span class="post-time small text-muted">4th April 2008 16:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi again,<br />
      <br />
      I have improved this function and now it looks like this:<br />
      <br />
      Function .onVerifyInstDir<br />
      <br />
      Push $R0<br />
      Push $R1<br />
      Push $R2<br />
      <br />
      StrCpy $R0 "$INSTDIR"<br />
      StrCpy $R2 "some_unique_name"<br />
      <br />
      loop:<br />
      StrLen $R1 "$R0"<br />
      StrCmp $R1 0 pathbad<br />
      IfFileExists "$R0" 0 parentLoop<br />
      ${GetFileAttributes} "$R0" "DIRECTORY" $R1<br />
      StrCmp $R1 0 parentLoop<br />
      ${GetFileAttributes} "$R0" "READONLY" $R1<br />
      StrCmp $R1 1 pathbad<br />
      ClearErrors<br />
      IfFileExists "$R0\$R2" pathgood 0<br />
      CreateDirectory "$R0\$R2"<br />
      IfErrors pathbad 0<br />
      RMDir "$R0\$R2"<br />
      Goto pathgood<br />
      <br />
      parentLoop:<br />
      ${GetParent} "$R0" "$R0"<br />
      Goto loop<br />
      <br />
      pathbad:<br />
      Abort<br />
      <br />
      pathgood:<br />
      <br />
      Pop $R2<br />
      Pop $R1<br />
      Pop $R0<br />
      <br />
      FunctionEnd</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
