<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Proof of concept: Detect 64-bit capable CPU - execute CPUID opcode from System plugin" />

  <title>Proof of concept: Detect 64-bit capable CPU - execute CPUID opcode from System plugin - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" />
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
               <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
               <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
       <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Proof of concept: Detect 64-bit capable CPU - execute CPUID opcode from System plugin</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=310359">Proof of concept: Detect 64-bit capable CPU - execute CPUID opcode from System plugin</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">f0rt</span><br />
      <span class="post-time small text-muted">19th August 2009 20:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Proof of concept: Detect 64-bit capable CPU - execute CPUID opcode from System plugin</strong><br />
      WARNING: The following script should merely illustrate that it is possible to execute x86 machine code embedded in the script via the System plugin. It is likely to fail if the page containing the embedded machine code is flagged as non-executable. So the better approach would be to write a dedicated plugin.<br />
      <br />
      PHP Code:</p>
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">OutFile</span><span style="color: #DD0000">"cpuid.exe"<br />
      <br /></span> <span style="color: #007700">!include</span><span style="color: #DD0000">"LogicLib.nsh"<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">cpuid<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">ExecutesCPUIDinstructionwiththequerycode</span><span style="color: #007700">***91;</span><span style="color: #0000BB">EAXvalue</span><span style="color: #007700">***93;</span><span style="color: #0000BB">in</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Params</span><span style="color: #007700">:</span><span style="color: #0000BB">querycode</span><span style="color: #007700">***91;</span><span style="color: #0000BB">EAXvalue</span><span style="color: #007700">***93;</span><span style="color: #0000BB">in</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Returns</span><span style="color: #007700">:</span><span style="color: #0000BB">0in</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">iffunction</span><span style="color: #0000BB">succeeded</span><span style="color: #007700">and</span><span style="color: #0000BB">theresultsofCPUID<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">in</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #007700">***91;</span><span style="color: #0000BB">EAX</span><span style="color: #007700">***93;,$</span><span style="color: #0000BB">2</span><span style="color: #007700">***91;</span><span style="color: #0000BB">EBX</span><span style="color: #007700">***93;,$</span><span style="color: #0000BB">3</span><span style="color: #007700">***91;</span><span style="color: #0000BB">ECX</span><span style="color: #007700">***93;and$</span><span style="color: #0000BB">4</span><span style="color: #007700">***91;</span><span style="color: #0000BB">EDX</span><span style="color: #007700">***93;<br />
      ;</span><span style="color: #0000BB">non</span><span style="color: #007700">-</span><span style="color: #0000BB">zerovaluein</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">if</span><span style="color: #0000BB">CPUIDinstructionisnotavailable</span><span style="color: #007700">.<br />
      Function</span><span style="color: #0000BB">cpuid<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">intcpuid</span><span style="color: #007700">(</span><span style="color: #0000BB">unsignedintquery_code</span><span style="color: #007700">,</span><span style="color: #0000BB">unsignedintregs</span><span style="color: #007700">***91;</span><span style="color: #0000BB">4</span><span style="color: #007700">***93;)<br />
      ;</span><span style="color: #0000BB">cpuid</span><span style="color: #007700">:<br />
      ;</span><span style="color: #0000BB">0</span><span style="color: #007700">:</span><span style="color: #0000BB">55pushebp<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">1</span><span style="color: #007700">:</span><span style="color: #0000BB">89e5movebp</span><span style="color: #007700">,</span><span style="color: #0000BB">esp<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">3</span><span style="color: #007700">:</span><span style="color: #0000BB">53pushebx<br /></span> <span style="color: #007700">;<br />
      ;;</span><span style="color: #0000BB">CPUIDinstructionavailable</span><span style="color: #007700">?<br />
      ;;</span><span style="color: #0000BB">yes</span><span style="color: #007700">if</span><span style="color: #0000BB">IDflag</span><span style="color: #007700">(=</span><span style="color: #0000BB">EFLAGS</span><span style="color: #007700">:</span><span style="color: #0000BB">21</span><span style="color: #007700">)</span><span style="color: #0000BB">canbemodified<br /></span> <span style="color: #007700">;<br />
      ;</span><span style="color: #0000BB">4</span><span style="color: #007700">:</span><span style="color: #0000BB">9cpushfd<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">5</span><span style="color: #007700">:</span><span style="color: #0000BB">58popeax<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">6</span><span style="color: #007700">:</span><span style="color: #0000BB">89c1movecx</span><span style="color: #007700">,</span><span style="color: #0000BB">eax<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">8</span><span style="color: #007700">:</span><span style="color: #0000BB">3500002000</span><span style="color: #007700">xor</span><span style="color: #0000BB">eax</span><span style="color: #007700">,$</span><span style="color: #0000BB">0x200000<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">d</span><span style="color: #007700">:</span><span style="color: #0000BB">50pusheax<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">e</span><span style="color: #007700">:</span><span style="color: #0000BB">9dpopf<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">f</span><span style="color: #007700">:</span><span style="color: #0000BB">9cpushf<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">10</span><span style="color: #007700">:</span><span style="color: #0000BB">58popeax<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">11</span><span style="color: #007700">:</span><span style="color: #0000BB">39c8cmpeax</span><span style="color: #007700">,</span><span style="color: #0000BB">ecx<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">13</span><span style="color: #007700">:</span><span style="color: #0000BB">7417je2c</span><span style="color: #007700">&lt;</span><span style="color: #0000BB">cpuid_end</span><span style="color: #007700">&gt;<br />
      ;<br />
      ;;</span><span style="color: #0000BB">ExecuteCPUIDinstructionwiththepassedquerycode<br /></span> <span style="color: #007700">;;and</span><span style="color: #0000BB">storetheresultsintheinteger</span><span style="color: #007700">array<br />
      ;<br />
      ;</span><span style="color: #0000BB">15</span><span style="color: #007700">:</span><span style="color: #0000BB">56pushesi<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">16</span><span style="color: #007700">:</span><span style="color: #0000BB">8b4508moveax</span><span style="color: #007700">,***91;</span><span style="color: #0000BB">ebp</span><span style="color: #007700">+</span><span style="color: #0000BB">8</span><span style="color: #007700">***93;<br />
      ;</span><span style="color: #0000BB">19</span><span style="color: #007700">:</span><span style="color: #0000BB">0fa2cpuid<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">1b</span><span style="color: #007700">:</span><span style="color: #0000BB">8b750cmovesi</span><span style="color: #007700">,</span><span style="color: #0000BB">dwordptr</span><span style="color: #007700">***91;</span><span style="color: #0000BB">ebp</span><span style="color: #007700">+</span><span style="color: #0000BB">12</span><span style="color: #007700">***93;<br />
      ;</span><span style="color: #0000BB">1e</span><span style="color: #007700">:</span><span style="color: #0000BB">8906movdwordptr</span><span style="color: #007700">***91;</span><span style="color: #0000BB">esi</span><span style="color: #007700">***93;,</span><span style="color: #0000BB">eax<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">20</span><span style="color: #007700">:</span><span style="color: #0000BB">895e04movdwordptr</span><span style="color: #007700">***91;</span><span style="color: #0000BB">esi</span><span style="color: #007700">+</span><span style="color: #0000BB">4</span><span style="color: #007700">***93;,</span><span style="color: #0000BB">ebx<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">23</span><span style="color: #007700">:</span><span style="color: #0000BB">894e08movdwordptr</span><span style="color: #007700">***91;</span><span style="color: #0000BB">esi</span><span style="color: #007700">+</span><span style="color: #0000BB">8</span><span style="color: #007700">***93;,</span><span style="color: #0000BB">ecx<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">26</span><span style="color: #007700">:</span><span style="color: #0000BB">89560cmovdwordptr</span><span style="color: #007700">***91;</span><span style="color: #0000BB">esi</span><span style="color: #007700">+</span><span style="color: #0000BB">12</span><span style="color: #007700">***93;,</span><span style="color: #0000BB">edx<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">29</span><span style="color: #007700">:</span><span style="color: #0000BB">5epopesi<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">2a</span><span style="color: #007700">:</span><span style="color: #0000BB">31c0</span><span style="color: #007700">xor</span><span style="color: #0000BB">eax</span><span style="color: #007700">,</span><span style="color: #0000BB">eax<br /></span> <span style="color: #007700">;<br />
      ;<br />
      ;</span><span style="color: #0000BB">cpuid_end</span><span style="color: #007700">:<br />
      ;</span><span style="color: #0000BB">2c</span><span style="color: #007700">:</span><span style="color: #0000BB">5bpopebx<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">2d</span><span style="color: #007700">:</span><span style="color: #0000BB">5dpopebp<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">2e</span><span style="color: #007700">:</span><span style="color: #0000BB">c3ret<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">2f</span><span style="color: #007700">:</span><span style="color: #0000BB">90nop<br /></span> <span style="color: #007700">;<br />
      ;</span><span style="color: #0000BB">Littleendian</span><span style="color: #007700">=&gt;</span><span style="color: #0000BB">combine4bytesfromlasttofirstonetoaninteger<br /></span> <span style="color: #007700">;<br />
      <br /></span> <span style="color: #0000BB">Push</span><span style="color: #007700">$</span><span style="color: #0000BB">5<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">6<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">cpuid</span><span style="color: #007700">function</span><span style="color: #0000BB">inx86machinecode<br /></span> <span style="color: #007700">;(</span><span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Callsupportsamaximumof100parameters</span><span style="color: #007700">)<br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"*(\\<br />
      i0x53e58955,\\<br />
      i0xc189589c,\\<br />
      i0x20000035,\\<br />
      i0x9c9d5000,\\<br />
      i0x74c83958,\\<br />
      i0x458b5617,\\<br />
      i0x8ba20f08,\\<br />
      i0x06890c75,\\<br />
      i0x89045e89,\\<br />
      i0x5689084e,\\<br />
      i0xc0315e0c,\\<br />
      i0x90c35d5b\\<br />
      )i.r5"<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Allocateinteger</span><span style="color: #007700">array<br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"*(i0,i0,i0,i0)i.r6"<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Executecpuidmachinecode<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"::$5(ir1,ir6)i.r0"<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Readdatafrominteger</span><span style="color: #007700">array<br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"*$6(i.r1,i.r2,i.r3,i.r4)"<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Freepreviouslyallocatedmemory<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Free</span><span style="color: #007700">$</span><span style="color: #0000BB">6<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Free</span><span style="color: #007700">$</span><span style="color: #0000BB">5<br />
      <br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">6<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">5<br />
      FunctionEnd<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">GetVendorIdviaCPUIDinstruction<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">ReturnsVendorIdin</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">Function</span><span style="color: #0000BB">VendorId<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">5<br />
      <br />
      Push0<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Callcpuid<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">0</span><span style="color: #007700">!=</span><span style="color: #0000BB">0<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #DD0000">"CPUIDinstructionnotavailable!"<br /></span> <span style="color: #007700">${Else}<br />
      ;</span><span style="color: #0000BB">Concatenatevendorstring</span><span style="color: #007700">:</span><span style="color: #0000BB">12characterASCIIstringstoredinEBX</span><span style="color: #007700">,</span><span style="color: #0000BB">EDX</span><span style="color: #007700">and</span><span style="color: #0000BB">ECX<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"*(ir2,ir4,ir3,i0)i.r5"<br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"*$5(&amp;m13.r0)"<br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Free</span><span style="color: #007700">$</span><span style="color: #0000BB">5<br /></span> <span style="color: #007700">${EndIf}<br />
      <br /></span> <span style="color: #0000BB">Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">5<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      FunctionEnd<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Determine</span><span style="color: #007700">if</span><span style="color: #0000BB">CPUsupports64</span><span style="color: #007700">-</span><span style="color: #0000BB">bitaddressspace<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Returns</span><span style="color: #DD0000">"64-bit"</span><span style="color: #007700">or</span><span style="color: #DD0000">"32-bit"</span><span style="color: #0000BB">in</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">Function</span><span style="color: #0000BB">Is64bit<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">32</span><span style="color: #007700">-</span><span style="color: #0000BB">bitby</span><span style="color: #007700">default<br /></span> <span style="color: #0000BB">Push</span><span style="color: #DD0000">"32-bit"<br />
      <br /></span> <span style="color: #0000BB">Push0<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Callcpuid<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">0</span><span style="color: #007700">==</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">${</span><span style="color: #0000BB">AndIf</span><span style="color: #007700">}$</span><span style="color: #0000BB">1</span><span style="color: #007700">!=</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">GetHighestExtended</span><span style="color: #007700">Function</span><span style="color: #0000BB">Supported<br />
      Push0x80000000<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Callcpuid<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">0</span><span style="color: #007700">==</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">${</span><span style="color: #0000BB">AndIf</span><span style="color: #007700">}$</span><span style="color: #0000BB">1</span><span style="color: #007700">&gt;</span><span style="color: #0000BB">0x80000000<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">ExtendedProcessorInfo</span><span style="color: #007700">and</span><span style="color: #0000BB">FeatureBits<br />
      Push0x80000001<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Callcpuid<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">0</span><span style="color: #007700">==</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Checklongmodebit</span><span style="color: #007700">(</span><span style="color: #0000BB">EDX</span><span style="color: #007700">:</span><span style="color: #0000BB">29</span><span style="color: #007700">)<br /></span> <span style="color: #0000BB">IntOp</span><span style="color: #007700">$</span><span style="color: #0000BB">4</span><span style="color: #007700">$</span><span style="color: #0000BB">4</span><span style="color: #007700">&amp;</span><span style="color: #0000BB">0x20000000<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">4</span><span style="color: #007700">!=</span><span style="color: #0000BB">0<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      Push</span><span style="color: #DD0000">"64-bit"<br /></span> <span style="color: #007700">${EndIf}<br />
      ${EndIf}<br />
      ${EndIf}<br />
      ${EndIf}<br />
      <br />
      ;Return</span><span style="color: #0000BB">value<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      <br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      FunctionEnd<br />
      <br /></span> <span style="color: #007700">Function.</span><span style="color: #0000BB">onInit<br />
      InitPluginsDir<br />
      CallVendorId<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      CallIs64bit<br />
      MessageBoxMB_OK</span><span style="color: #DD0000">"Vendor=$1***91;$0capable***93;"<br /></span> <span style="color: #0000BB">Quit<br />
      FunctionEnd<br />
      <br />
      Section<br />
      SectionEnd<br /></span></span> <!-- php buffer end -->
      <hr />
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">19th August 2009 22:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">as you say, this will cause problems with DEP/NX, you could allocate memory with VirtualAlloc (PAGE_EXECUTE_READWRITE protection)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">f0rt</span><br />
      <span class="post-time small text-muted">25th August 2009 17:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks a lot for your advice.<br />
      <br />
      I took your advice and improved the script:<br />
      <br />
      PHP Code:</p>
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">OutFile</span><span style="color: #DD0000">"cpuid.exe"<br /></span> <span style="color: #0000BB">Name</span><span style="color: #DD0000">"CPUID"<br />
      <br /></span> <span style="color: #007700">!include</span><span style="color: #DD0000">"LogicLib.nsh"<br />
      <br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">defineTRUE1<br />
      <br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">defineMEM_COMMIT0x1000<br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">defineMEM_RELEASE0x8000<br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">definePAGE_EXECUTE_READWRITE0x40<br />
      <br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">defineCRYPT_STRING_HEX0x00000004<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">intcpuid</span><span style="color: #007700">(</span><span style="color: #0000BB">unsignedintquery_code</span><span style="color: #007700">,</span><span style="color: #0000BB">unsignedintregs</span><span style="color: #007700">***91;</span><span style="color: #0000BB">4</span><span style="color: #007700">***93;)<br />
      ;</span><span style="color: #0000BB">cpuid</span><span style="color: #007700">:<br />
      ;</span><span style="color: #0000BB">0</span><span style="color: #007700">:</span><span style="color: #0000BB">55pushebp<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">1</span><span style="color: #007700">:</span><span style="color: #0000BB">89e5movebp</span><span style="color: #007700">,</span><span style="color: #0000BB">esp<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">3</span><span style="color: #007700">:</span><span style="color: #0000BB">53pushebx<br /></span> <span style="color: #007700">;<br />
      ;;</span><span style="color: #0000BB">CPUIDinstructionavailable<br /></span> <span style="color: #007700">;;</span><span style="color: #0000BB">yes</span><span style="color: #007700">if</span><span style="color: #0000BB">IDflag</span><span style="color: #007700">(=</span><span style="color: #0000BB">EFLAGS</span><span style="color: #007700">:</span><span style="color: #0000BB">21</span><span style="color: #007700">)</span><span style="color: #0000BB">canbemodified<br /></span> <span style="color: #007700">;<br />
      ;</span><span style="color: #0000BB">4</span><span style="color: #007700">:</span><span style="color: #0000BB">9cpushfd<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">5</span><span style="color: #007700">:</span><span style="color: #0000BB">58popeax<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">6</span><span style="color: #007700">:</span><span style="color: #0000BB">89c1movecx</span><span style="color: #007700">,</span><span style="color: #0000BB">eax<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">8</span><span style="color: #007700">:</span><span style="color: #0000BB">3500002000</span><span style="color: #007700">xor</span><span style="color: #0000BB">eax</span><span style="color: #007700">,$</span><span style="color: #0000BB">0x200000<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">d</span><span style="color: #007700">:</span><span style="color: #0000BB">50pusheax<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">e</span><span style="color: #007700">:</span><span style="color: #0000BB">9dpopf<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">f</span><span style="color: #007700">:</span><span style="color: #0000BB">9cpushf<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">10</span><span style="color: #007700">:</span><span style="color: #0000BB">58popeax<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">11</span><span style="color: #007700">:</span><span style="color: #0000BB">39c8cmpeax</span><span style="color: #007700">,</span><span style="color: #0000BB">ecx<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">13</span><span style="color: #007700">:</span><span style="color: #0000BB">7417je2c</span><span style="color: #007700">&lt;</span><span style="color: #0000BB">cpuid_end</span><span style="color: #007700">&gt;<br />
      ;<br />
      ;;</span><span style="color: #0000BB">RunCPUIDwiththepassedquerycode<br /></span> <span style="color: #007700">;;and</span><span style="color: #0000BB">storetheresultsintheinteger</span><span style="color: #007700">array<br />
      ;<br />
      ;</span><span style="color: #0000BB">15</span><span style="color: #007700">:</span><span style="color: #0000BB">56pushesi<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">16</span><span style="color: #007700">:</span><span style="color: #0000BB">8b4508moveax</span><span style="color: #007700">,***91;</span><span style="color: #0000BB">ebp</span><span style="color: #007700">+</span><span style="color: #0000BB">8</span><span style="color: #007700">***93;<br />
      ;</span><span style="color: #0000BB">19</span><span style="color: #007700">:</span><span style="color: #0000BB">0fa2cpuid<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">1b</span><span style="color: #007700">:</span><span style="color: #0000BB">8b750cmovesi</span><span style="color: #007700">,</span><span style="color: #0000BB">dwordptr</span><span style="color: #007700">***91;</span><span style="color: #0000BB">ebp</span><span style="color: #007700">+</span><span style="color: #0000BB">12</span><span style="color: #007700">***93;<br />
      ;</span><span style="color: #0000BB">1e</span><span style="color: #007700">:</span><span style="color: #0000BB">8906movdwordptr</span><span style="color: #007700">***91;</span><span style="color: #0000BB">esi</span><span style="color: #007700">***93;,</span><span style="color: #0000BB">eax<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">20</span><span style="color: #007700">:</span><span style="color: #0000BB">895e04movdwordptr</span><span style="color: #007700">***91;</span><span style="color: #0000BB">esi</span><span style="color: #007700">+</span><span style="color: #0000BB">4</span><span style="color: #007700">***93;,</span><span style="color: #0000BB">ebx<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">23</span><span style="color: #007700">:</span><span style="color: #0000BB">894e08movdwordptr</span><span style="color: #007700">***91;</span><span style="color: #0000BB">esi</span><span style="color: #007700">+</span><span style="color: #0000BB">8</span><span style="color: #007700">***93;,</span><span style="color: #0000BB">ecx<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">26</span><span style="color: #007700">:</span><span style="color: #0000BB">89560cmovdwordptr</span><span style="color: #007700">***91;</span><span style="color: #0000BB">esi</span><span style="color: #007700">+</span><span style="color: #0000BB">12</span><span style="color: #007700">***93;,</span><span style="color: #0000BB">edx<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">29</span><span style="color: #007700">:</span><span style="color: #0000BB">5epopesi<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">2a</span><span style="color: #007700">:</span><span style="color: #0000BB">31c0</span><span style="color: #007700">xor</span><span style="color: #0000BB">eax</span><span style="color: #007700">,</span><span style="color: #0000BB">eax<br /></span> <span style="color: #007700">;<br />
      ;<br />
      ;</span><span style="color: #0000BB">cpuid_end</span><span style="color: #007700">:<br />
      ;</span><span style="color: #0000BB">2c</span><span style="color: #007700">:</span><span style="color: #0000BB">5bpopebx<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">2d</span><span style="color: #007700">:</span><span style="color: #0000BB">5dpopebp<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">2e</span><span style="color: #007700">:</span><span style="color: #0000BB">c3ret<br />
      <br /></span> <span style="color: #007700">!</span><span style="color: #0000BB">defineHEXCODE</span><span style="color: #DD0000">"5589e5539c5889c13500002000509d9c5839c87417568b45080fa28b750c8906895e04894e0889560c5e31c05b5dc3"<br />
      <br /></span> <span style="color: #007700">Var</span><span style="color: #0000BB">CODE<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Converthexstringintobinary<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Params</span><span style="color: #007700">:</span><span style="color: #0000BB">hexstring</span><span style="color: #007700">-</span><span style="color: #0000BB">stringinhexadecimalformat<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">hexlen</span><span style="color: #007700">-</span><span style="color: #0000BB">lengthofhexstring<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">binbuffer</span><span style="color: #007700">-</span><span style="color: #0000BB">pointertobufferthatreceivesthebinaryoutput<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">binlen</span><span style="color: #007700">-</span><span style="color: #0000BB">sizeofbufferthatreceivesthebinaryoutput<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Returns</span><span style="color: #007700">:</span><span style="color: #0000BB">Numberofbytesstoredinbuffer<br /></span> <span style="color: #007700">Function</span><span style="color: #0000BB">hex2bin<br />
      Exch</span><span style="color: #007700">$</span><span style="color: #0000BB">2</span><span style="color: #007700">;</span><span style="color: #0000BB">Lengthofresultingstring<br />
      Exch<br />
      Exch</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #007700">;</span><span style="color: #0000BB">Resultingstring<br />
      Exch2<br />
      Exch</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">;</span><span style="color: #0000BB">Lengthofhexstring<br />
      Exch3<br />
      Exch</span><span style="color: #007700">$</span><span style="color: #0000BB">3</span><span style="color: #007700">;</span><span style="color: #0000BB">Hexstring<br />
      <br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">CryptStringToBinaryonlyavailableonWindowsXP</span><span style="color: #007700">or</span><span style="color: #0000BB">itssuccessors<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"Crypt32::CryptStringToBinary(tr3,ir0,i${CRYPT_STRING_HEX},ir1,*ir2r2,i0,i0)i.r4"<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">4</span><span style="color: #007700">!=${</span><span style="color: #0000BB">TRUE</span><span style="color: #007700">}<br />
      ;</span><span style="color: #0000BB">Fallbacktogenerichextobinaryimplementation<br /></span> <span style="color: #007700">;<br />
      ;</span><span style="color: #0000BB">Ensurethatatleastoneintegervaluecouldbewritten<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">2</span><span style="color: #007700">&gt;=</span><span style="color: #0000BB">4<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">5<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">6<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">7<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">8<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">9<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Lengthofhexstring<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">5</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Sizeofbuffer<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">6</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Integerstring<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">7</span><span style="color: #DD0000">""<br /></span> <span style="color: #007700">${</span><span style="color: #0000BB">DoWhile</span><span style="color: #007700">}$</span><span style="color: #0000BB">6</span><span style="color: #007700">&gt;</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Extracttwocharactersworkingfromendtobeginningofhexstring<br />
      IntOp</span><span style="color: #007700">$</span><span style="color: #0000BB">5</span><span style="color: #007700">$</span><span style="color: #0000BB">5</span><span style="color: #007700">-</span><span style="color: #0000BB">2<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">8</span><span style="color: #007700">$</span><span style="color: #0000BB">32</span><span style="color: #007700">$</span><span style="color: #0000BB">5<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Combinetheextractedcharacterstoanintegerstring<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">7</span><span style="color: #DD0000">"$7$8"<br /></span> <span style="color: #0000BB">StrLen</span><span style="color: #007700">$</span><span style="color: #0000BB">9</span><span style="color: #007700">$</span><span style="color: #0000BB">7<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">9</span><span style="color: #007700">&gt;=</span><span style="color: #0000BB">8<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Completeintegerstring<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Determinetheaddresswheretheintegervalueisgoingtobewritten<br />
      IntOp</span><span style="color: #007700">$</span><span style="color: #0000BB">6</span><span style="color: #007700">$</span><span style="color: #0000BB">6</span><span style="color: #007700">-</span><span style="color: #0000BB">4<br />
      IntOp</span><span style="color: #007700">$</span><span style="color: #0000BB">9</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #007700">+$</span><span style="color: #0000BB">6<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Writeintegervalue<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"*$9(i0x$7)"<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Cleanintegerstring<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">7</span><span style="color: #DD0000">""<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">6</span><span style="color: #007700">&lt;</span><span style="color: #0000BB">4<br /></span> <span style="color: #007700">${</span><span style="color: #0000BB">AndIf</span><span style="color: #007700">}$</span><span style="color: #0000BB">6</span><span style="color: #007700">&gt;</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Thefirstintegervalueisbuiltfromtheveryfirst8charactersofthehexstring<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">58<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Setoffsetto4soitbecomesthestartaddressofthebinarybuffer</span><span style="color: #007700">for</span><span style="color: #0000BB">writing<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">thefirstintegervalue<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">64<br /></span> <span style="color: #007700">${EndIf}<br />
      ${EndIf}<br />
      ${</span><span style="color: #0000BB">Loop</span><span style="color: #007700">}<br /></span> <span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">9<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">8<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">7<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">6<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">5<br /></span> <span style="color: #007700">${Else}<br /></span> <span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">00<br /></span> <span style="color: #007700">${EndIf}<br />
      ${Else}<br /></span> <span style="color: #0000BB">StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br /></span> <span style="color: #007700">${EndIf}<br /></span> <span style="color: #0000BB">Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Exch</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      FunctionEnd<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Initializeenviornment</span><span style="color: #007700">for</span><span style="color: #0000BB">cpuid</span><span style="color: #007700">function<br />
      Function</span><span style="color: #0000BB">cpuid_init<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      <br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">${</span><span style="color: #0000BB">HEXCODE</span><span style="color: #007700">}<br />
      ;</span><span style="color: #0000BB">Lengthofhexstring<br />
      StrLen</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Lengthofresultingstring<br />
      IntOp</span><span style="color: #007700">$</span><span style="color: #0000BB">2</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #007700">/</span><span style="color: #0000BB">2<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Allocatememorytostorecode</span><span style="color: #007700">for</span><span style="color: #0000BB">execution<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">VirtualAllocisavailableonWindows2000Pro</span><span style="color: #007700">or</span><span style="color: #0000BB">itssuccessors<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"kernel32::VirtualAlloc(i0,ir2,\\<br />
      i${MEM_COMMIT},i${PAGE_EXECUTE_READWRITE})i.r3"<br />
      <br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">3</span><span style="color: #007700">==</span><span style="color: #DD0000">"error"<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">FallbacktoSystem</span><span style="color: #007700">::</span><span style="color: #0000BB">Alloc<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Alloc</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br /></span> <span style="color: #007700">${EndIf}<br />
      <br />
      ${If}$</span><span style="color: #0000BB">3</span><span style="color: #007700">!=</span><span style="color: #0000BB">0<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Callhex2bin<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      StrCpy$CODE</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br /></span> <span style="color: #007700">${EndIf}<br />
      <br /></span> <span style="color: #0000BB">Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      FunctionEnd<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Cleanupenviornment</span><span style="color: #007700">for</span><span style="color: #0000BB">cpuid</span><span style="color: #007700">function<br />
      Function</span><span style="color: #0000BB">cpuid_deinit<br /></span> <span style="color: #007700">${If}</span><span style="color: #0000BB">$CODE</span><span style="color: #007700">!=</span><span style="color: #DD0000">""<br /></span> <span style="color: #0000BB">Push</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Freememoryusedtostorecode</span><span style="color: #007700">for</span><span style="color: #0000BB">execution<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">VirtualFreeisavailableonWindows2000Pro</span><span style="color: #007700">or</span><span style="color: #0000BB">itssuccessors<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"kernel32::VirtualFree(i$CODE,i0,i${MEM_RELEASE})i.r0"<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">0</span><span style="color: #007700">==</span><span style="color: #DD0000">"error"<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">FallbacktoSystem</span><span style="color: #007700">::</span><span style="color: #0000BB">Free<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Free$CODE<br /></span> <span style="color: #007700">${EndIf}<br /></span> <span style="color: #0000BB">StrCpy$CODE</span><span style="color: #DD0000">""<br /></span> <span style="color: #0000BB">Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">${EndIf}<br /></span> <span style="color: #0000BB">FunctionEnd<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">cpuid<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">ExecutesCPUIDinstructionwiththequerycode</span><span style="color: #007700">***91;</span><span style="color: #0000BB">EAXvalue</span><span style="color: #007700">***93;</span><span style="color: #0000BB">in</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Params</span><span style="color: #007700">:</span><span style="color: #0000BB">querycode</span><span style="color: #007700">***91;</span><span style="color: #0000BB">EAXvalue</span><span style="color: #007700">***93;</span><span style="color: #0000BB">in</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Returns</span><span style="color: #007700">:</span><span style="color: #0000BB">0in</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">iffunction</span><span style="color: #0000BB">succeeded</span><span style="color: #007700">and</span><span style="color: #0000BB">theresultsofCPUID<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">in</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #007700">***91;</span><span style="color: #0000BB">EAX</span><span style="color: #007700">***93;,$</span><span style="color: #0000BB">2</span><span style="color: #007700">***91;</span><span style="color: #0000BB">EBX</span><span style="color: #007700">***93;,$</span><span style="color: #0000BB">3</span><span style="color: #007700">***91;</span><span style="color: #0000BB">ECX</span><span style="color: #007700">***93;and$</span><span style="color: #0000BB">4</span><span style="color: #007700">***91;</span><span style="color: #0000BB">EDX</span><span style="color: #007700">***93;<br />
      ;</span><span style="color: #0000BB">non</span><span style="color: #007700">-</span><span style="color: #0000BB">zerovaluein</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #007700">if</span><span style="color: #0000BB">CPUIDinstructionisnotavailable</span><span style="color: #007700">.<br />
      Function</span><span style="color: #0000BB">cpuid<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">5<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">6<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">7<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Set</span><span style="color: #007700">return</span><span style="color: #0000BB">codetoanon</span><span style="color: #007700">-</span><span style="color: #0000BB">zerovalue</span><span style="color: #007700">(=</span><span style="color: #0000BB">error</span><span style="color: #007700">)as</span><span style="color: #0000BB">aninitialvalue<br />
      Push</span><span style="color: #007700">-</span><span style="color: #0000BB">1<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      <br /></span> <span style="color: #007700">${If}</span><span style="color: #0000BB">$CODE</span><span style="color: #007700">!=</span><span style="color: #DD0000">""<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Allocateinteger</span><span style="color: #007700">array<br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"*(i0,i0,i0,i0)i.r7"<br />
      <br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">7</span><span style="color: #007700">!=</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Executecpuidmachinecode<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"::$CODE(ir1,ir7)i.r0"<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Readdatafrominteger</span><span style="color: #007700">array<br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"*$7(i.r1,i.r2,i.r3,i.r4)"<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Freepreviouslyallocatedmemory</span><span style="color: #007700">for</span><span style="color: #0000BB">integer</span><span style="color: #007700">array<br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Free</span><span style="color: #007700">$</span><span style="color: #0000BB">7<br /></span> <span style="color: #007700">${EndIf}<br />
      ${EndIf}<br />
      <br /></span> <span style="color: #0000BB">Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">7<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">6<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">5<br />
      FunctionEnd<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">GetVendorIdviaCPUIDinstruction<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">ReturnsVendorIdin</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">Function</span><span style="color: #0000BB">VendorId<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">5<br />
      <br />
      Push0<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Callcpuid<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">0</span><span style="color: #007700">!=</span><span style="color: #0000BB">0<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">0</span><span style="color: #DD0000">"CPUIDinstructionnotavailable!"<br /></span> <span style="color: #007700">${Else}<br />
      ;</span><span style="color: #0000BB">Concatenatevendorstring</span><span style="color: #007700">:</span><span style="color: #0000BB">12characterASCIIstringstoredinEBX</span><span style="color: #007700">,</span><span style="color: #0000BB">EDX</span><span style="color: #007700">and</span><span style="color: #0000BB">ECX<br />
      System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"*(ir2,ir4,ir3,i0)i.r5"<br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Call</span><span style="color: #DD0000">"*$5(&amp;m13.r0)"<br /></span> <span style="color: #0000BB">System</span><span style="color: #007700">::</span><span style="color: #0000BB">Free</span><span style="color: #007700">$</span><span style="color: #0000BB">5<br /></span> <span style="color: #007700">${EndIf}<br />
      <br /></span> <span style="color: #0000BB">Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">5<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      FunctionEnd<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Determine</span><span style="color: #007700">if</span><span style="color: #0000BB">CPUsupports64</span><span style="color: #007700">-</span><span style="color: #0000BB">bitaddressspace<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Returns</span><span style="color: #DD0000">"64-bit"</span><span style="color: #007700">or</span><span style="color: #DD0000">"32-bit"</span><span style="color: #0000BB">in</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">Function</span><span style="color: #0000BB">Is64bit<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      Push</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br />
      <br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">32</span><span style="color: #007700">-</span><span style="color: #0000BB">bitby</span><span style="color: #007700">default<br /></span> <span style="color: #0000BB">Push</span><span style="color: #DD0000">"32-bit"<br />
      <br /></span> <span style="color: #0000BB">Push0<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Callcpuid<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">0</span><span style="color: #007700">==</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">${</span><span style="color: #0000BB">AndIf</span><span style="color: #007700">}$</span><span style="color: #0000BB">1</span><span style="color: #007700">!=</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">GetHighestExtended</span><span style="color: #007700">Function</span><span style="color: #0000BB">Supported<br />
      Push0x80000000<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Callcpuid<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">0</span><span style="color: #007700">==</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">${</span><span style="color: #0000BB">AndIf</span><span style="color: #007700">}$</span><span style="color: #0000BB">1</span><span style="color: #007700">&gt;</span><span style="color: #0000BB">0x80000000<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">ExtendedProcessorInfo</span><span style="color: #007700">and</span><span style="color: #0000BB">FeatureBits<br />
      Push0x80000001<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      Callcpuid<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">0</span><span style="color: #007700">==</span><span style="color: #0000BB">0<br /></span> <span style="color: #007700">;</span><span style="color: #0000BB">Checklongmodebit</span><span style="color: #007700">(</span><span style="color: #0000BB">EDX</span><span style="color: #007700">:</span><span style="color: #0000BB">29</span><span style="color: #007700">)<br /></span> <span style="color: #0000BB">IntOp</span><span style="color: #007700">$</span><span style="color: #0000BB">4</span><span style="color: #007700">$</span><span style="color: #0000BB">4</span><span style="color: #007700">&amp;</span><span style="color: #0000BB">0x20000000<br /></span> <span style="color: #007700">${If}$</span><span style="color: #0000BB">4</span><span style="color: #007700">!=</span><span style="color: #0000BB">0<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      Push</span><span style="color: #DD0000">"64-bit"<br /></span> <span style="color: #007700">${EndIf}<br />
      ${EndIf}<br />
      ${EndIf}<br />
      ${EndIf}<br />
      <br />
      ;Return</span><span style="color: #0000BB">value<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      <br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">4<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">3<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">2<br />
      Pop</span><span style="color: #007700">$</span><span style="color: #0000BB">1<br />
      FunctionEnd<br />
      <br /></span> <span style="color: #007700">Function.</span><span style="color: #0000BB">onInit<br />
      InitPluginsDir<br />
      Callcpuid_init<br />
      CallVendorId<br />
      StrCpy</span><span style="color: #007700">$</span><span style="color: #0000BB">1</span><span style="color: #007700">$</span><span style="color: #0000BB">0<br />
      CallIs64bit<br />
      Callcpuid_deinit<br />
      MessageBoxMB_OK</span><span style="color: #DD0000">"Vendor=$1***91;$0capable***93;"<br /></span> <span style="color: #0000BB">Quit<br />
      FunctionEnd<br />
      <br />
      Section<br />
      SectionEnd<br /></span></span> <!-- php buffer end -->
      <hr />
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
