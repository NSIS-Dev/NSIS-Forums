<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Archiving $INSTDIR using rename" />

  <title>Archiving $INSTDIR using rename - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Archiving $INSTDIR using rename</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=276404">Archiving $INSTDIR using rename</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">wacaveman</span><br />
      <span class="post-time small text-muted">24th August 2007 16:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Archiving $INSTDIR using rename</strong><br />
      4.9.1.6 Rename<br />
      [/REBOOTOK] source_file dest_file<br />
      Rename source_file to dest_file. You can use it to move a file from anywhere on the system to anywhere else and you can move a directory to somewhere else on the same drive. The destination file must not exist or the move will fail (unless you are using /REBOOTOK). If /REBOOTOK is specified, and the file cannot be moved (if, for example, the destination exists), then the file is moved when the system reboots. If the file will be moved on a reboot, the reboot flag will be set. The error flag is set if the file cannot be renamed (and /REBOOTOK is not used) or if the source file does not exist.<br />
      <br />
      Ok, I am trying to understand what this means. Firstly, do I need /REBOOTOK or not? I understand the purpose of the flag, but the name of the flag, and the text in the help is a bit confusing to me.<br />
      <br />
      I have seen several other posts in regard to renaming a directory, but I can't for the life of me figure out why I am having trouble renaming files or directories. I just want to move the whole directory prior to putting files there.<br />
      <br />
      So, I have logging as well, so I turn logging on in my $INSTDIR, then when I get to the archive part, I turn logging off, attempt to move the log into $TEMP, then move the entire $INSTDIR to an archive directory. It took me a while to figure out what the "error flag" is, BTW. It is all over the documentation, and usually it isn't shown in the examples. It would be nice to add a link to the IfErrors section (I know, a ton of busy work), for those of us who don't have time to read the entire manual cover to cover.<br />
      <br />
      When you rename a directory, should the destination be there, or not? I am guessing not, but no matter what I try to do, it fails.<br />
      <br />
      I am guessing I am being screwed by the logger, as it fails to rename the install.log file to the $TEMP directory successfully.<br />
      <br />
      Any help would be welcome.<br />
      <br />
      Thanks,<br />
      <br />
      -Kevin<br />
      <br />
      SetOutPath "$INSTDIR\.."<br />
      <br />
      IfFileExists "$INSTDIR\${mcexec}" "" skipArchive<br />
      DetailPrint "Archiving old files"<br />
      ;GetRoot "$INSTDIR" $R0<br />
      StrCpy $ArchivePath "$ArchiveRoot\${packagename}_Archive_$2$1$0_$4$5"<br />
      MessageBox MB_OK "Archive path is $ArchivePath"<br />
      ;CreateDirectory "c:\$archive_$2$1$0_$4$5"<br />
      ;Note that when using rename, the new path must not exist...<br />
      ;but we need to create the root if it is missing...<br />
      CreateDirectory "$ArchiveRoot"<br />
      ;CreateDirectory "$ArchivePath"<br />
      DetailPrint "About to move $INSTDIR to $ArchivePath"<br />
      DetailPrint "About to move $INSTDIR\install.log to $TEMP\install.log"<br />
      ;turn logger off and move the log file to the side...<br />
      !insertmacro Logger off<br />
      ClearErrors<br />
      LogSet off<br />
      IfErrors 0 +2<br />
      MessageBox MB_OK "Turning the log off failed";<br />
      MessageBox MB_OK "Just turned off the logger";<br />
      ClearErrors<br />
      Rename "$INSTDIR\install.log" "$TEMP\install.log"<br />
      IfErrors 0 +2<br />
      MessageBox MB_OK "Rename $INSTDIR\install.log to $TEMP\install.log failed";<br />
      <br />
      ;CopyFiles "$INSTDIR\*.*" "$ArchivePath"<br />
      ClearErrors<br />
      Rename "$INSTDIR" "$ArchivePath"<br />
      IfErrors 0 +2<br />
      MessageBox MB_OK "Rename $INSTDIR to $ArchivePath failed";<br />
      ;put logfile back and turn logger back on<br />
      MessageBox MB_OK "Rename complete ($0), about to copy the log back";<br />
      ClearErrors<br />
      Rename "$TEMP\install.log" "$INSTDIR\install.log"<br />
      IfErrors 0 +2<br />
      MessageBox MB_OK "Rename $TEMP\install.log to $INSTDIR\install.log failed";<br />
      !insertmacro Logger on<br />
      MessageBox MB_OK "Just turned on the logger (the log rename returned $0)";<br />
      DetailPrint "Archive complete"<br />
      skipArchive:</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">wacaveman</span><br />
      <span class="post-time small text-muted">24th August 2007 17:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">OK, I was correct. I am screwed by the logger. LogSet off does not close the file, so when you try to rename it, you get:<br />
      The process cannot access the file because it is being used by another process.<br />
      <br />
      I am not sure if this is the only bug here, but I will hopefully find out shortly.<br />
      <br />
      BTW, is there a mechanism to actually get the error message for why something failed? I am guessing if there was a way, it would be shown in the IfErrors section of the help manual.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">24th August 2007 17:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Use /REBOOTOK to rename the file on reboot, or try CopyFiles followed by Delete /REBOOTOK. You do realise that if an error occurs you will get both messages boxes - one saying something was successful and one saying it was not. You need to jump over your second message box (easiest way is to add IDOK +2 onto the end of the first MessageBox.)<br />
      Also those ; on the end of the MessageBox calls are not necessary and anything after them will be denoted as a comment.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">wacaveman</span><br />
      <span class="post-time small text-muted">24th August 2007 18:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Yeah, I know -- they were just a bunch of debug I threw in there. I missed the ; on the end -- C++ programmer by trade, I just did it out of habit.<br />
      <br />
      BTW, there is something up that seems to hang on the directory and keep it from being deleted. I just blew about 4 hours on this because Rename doesn't support wild cards, the logger bug, and what I just mentioned about something hanging onto the directory until you reboot.<br />
      <br />
      Anyway, Rename does not work reliably. I am not sure if it is NSIS or the WinZip self extractor, but one of the two is screwing me now. I will take your suggestion about CopyFiles, then Delete. I really hate to take that action, because rename is an instant change, and copying takes 10-15 minutes and then deleting takes a bunch of time too. Argh.<br />
      <br />
      Thanks for the help understanding what a /REBOOTOK flag should do.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">wacaveman</span><br />
      <span class="post-time small text-muted">24th August 2007 19:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well, here is what I came up with as an alternative. We will see how well it works out. This is the last-ditch effort before I go and copy/delete everything.<br />
      <br />
      archiveFiles:<br />
      ;CopyFiles "$INSTDIR\*.*" "$ArchivePath"<br />
      ClearErrors<br />
      Rename "$INSTDIR" "$ArchivePath"<br />
      IfErrors 0 +2<br />
      MessageBox MB_RETRYCANCEL|MB_ICONEXCLAMATION "Rename $INSTDIR to $ArchivePath failed" IDCANCEL skipArchive IDRETRY archiveFiles<br />
      ;put logfile back and turn logger back on<br />
      DetailPrint "Archive complete"<br />
      skipArchive:<br />
      ;it sucks to have to do this here, but the logger doesn't close the file when commanded off<br />
      !insertmacro Logger on<br />
      <br />
      Thanks again for the help!</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
