<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="ErrorLevel Not returning" />

  <title>ErrorLevel Not returning - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">ErrorLevel Not returning</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=319925">ErrorLevel Not returning</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Squirre1</span><br />
      <span class="post-time small text-muted">13th June 2010 18:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>ErrorLevel Not returning</strong><br />
      I am using a custom errorlevel in an installer and it does not appear to be returning as necessary...<br />
      <br /></p>
      <pre>
<span style="color: #007700">!</span><span style="color: #0000BB">insertmacrologme$INSTLOG</span><span style="color: #DD0000">"OSDetected:Windows$R0$R1"</span><span style="color: #0000BB">l
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">insertmacrologme$INSTLOG</span><span style="color: #DD0000">"InstallError:OSNotSupported"</span><span style="color: #0000BB">l
<br />MessageBoxMB_OK</span><span style="color: #007700">|</span><span style="color: #0000BB">MB_ICONINFORMATION</span><span style="color: #DD0000">"Pleaseprovidethefollowinginformationtosupport.$\r$\n$\r$\nInstallationof${APP_DESC}failedwitherror:OSNotSupported$\r$\n$\r$\nTerminatingInstallation"</span><span style="color: #007700">/</span><span style="color: #0000BB">SDIDOK
<br />SetErrorLevel999
<br />SetRebootFlagfalse
<br />goto_ierrored
<br /></span>

<!-- php buffer end -->
                
                
                
</pre>
      <hr />
      <pre>
        

        PHP Code:
        
                
</pre>
      <hr />
      <pre>
                <code style="white-space:nowrap">
                
                        <!-- php buffer start --></code><span style="color: #000000">
<span style="color: #0000BB">_ierrored</span><span style="color: #007700">:
<br /><br />!</span><span style="color: #0000BB">insertmacrologme$INSTLOG</span><span style="color: #DD0000">"CleaningUpTemporaryFiles...PleasebePatient"</span><span style="color: #0000BB">b
<br />SetOutPath$INSTDIR
<br /></span><span style="color: #007700">!</span><span style="color: #0000BB">insertmacroRemoveFilesAndSubDirs</span><span style="color: #DD0000">"$INSTDIR\${APP_NAME}"
<br /></span><span style="color: #0000BB">RMDir</span><span style="color: #007700">/</span><span style="color: #0000BB">r</span><span style="color: #DD0000">"$INSTDIR\${APP_NAME}"
<br /><br /></span><span style="color: #007700">!</span><span style="color: #0000BB">insertmacrologme$INSTLOG</span><span style="color: #DD0000">"***${APP_DESC}InstallationEndedinError***"</span><span style="color: #0000BB">b
<br />StrCpy$FINISHPAGE_TEXT</span><span style="color: #DD0000">"Theinstallationof${APP_DESC}hasresultedinanerrorandwasnotcompleted.$\r$\n$\r$\nClickFinishtoclosethiswizard."
<br /><br /></span><span style="color: #0000BB">_end</span><span style="color: #007700">:
</span></span>
</pre>There are just the two sections of any relavence so you can see whats taking place.. The log is generating correctly, but there errorlevel does not appear to be getting set.<br />
      <br />
      13.06.2010 12:28:47 *-----------------------------------------------------*<br />
      13.06.2010 12:28:47 ### Microsoft Windows Installer 4.5 Installation Starting<br />
      13.06.2010 12:28:47 ### Build Verison: 1.0.0.1<br />
      13.06.2010 12:28:47 ### Runtime: 6/13/2010 12:28:47<br />
      13.06.2010 12:28:47 ### Switches: /S<br />
      13.06.2010 12:28:47 *-----------------------------------------------------*<br />
      13.06.2010 12:28:47<br />
      13.06.2010 12:28:47 Silent Installation has been Requested<br />
      13.06.2010 12:28:47 Running Pre-installation Processes<br />
      13.06.2010 12:28:47 Detecting the Running Operating System<br />
      13.06.2010 12:28:47 OS Detected: Windows 7 64<br />
      13.06.2010 12:28:47 Install Error: OS Not Supported<br />
      13.06.2010 12:28:47 Cleaning Up Temporary Files ... Please be Patient<br />
      13.06.2010 12:28:47 *** Microsoft Windows Installer 4.5 Installation Ended in Error ***<br />
      <br />
      Any Ideas are greatly appreciated..<br />
      <br />
      Thanks...
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">13th June 2010 18:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I don't see Quit in there</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Squirre1</span><br />
      <span class="post-time small text-muted">13th June 2010 19:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Do you have to have a Quit in order for it to return the errorlevel... I thought the SetErrorLevel was enough for it to assign the errorlevel for when the installation finishes..? Please correct me if I am wrong.<br />
      <br />
      In a commandline window I do the following...<br />
      <br />
      &gt;Set errorlevel=15 ; Set a dummy errorlevel level to validate it changes<br />
      &gt;Installer.exe /S<br />
      &gt;echo %errorlevel% ; Still returns 15 for the errorlevel, like the installer NEVER influenses it..</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Squirre1</span><br />
      <span class="post-time small text-muted">13th June 2010 20:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Just as a FYI, I tested with the Quit in there, and it is STILL not returning the errorlevel correctly. Not sure what is up...<br />
      <br />
      I have also tested different methods of SetErrorLevel for ex.<br />
      SetErrorLevel "999"<br />
      SetErrorLevel 999<br />
      SetErrorLevel '999'<br />
      <br />
      All with the same result, none of them return...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Animaether</span><br />
      <span class="post-time small text-muted">13th June 2010 20:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I believe SetErrorLevel must come immediately before your Quit command (not too sure if GoTo's are allowed), as otherwise NSIS' own code for error level setting upon installer exit may override whatever you set.<br />
      Worth a try, at least - our installers have it set immediately before Quit / last command of .onGuiEnd , and work correctly.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">demiller9</span><br />
      <span class="post-time small text-muted">13th June 2010 21:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">It looks like you have masked the true errorlevel by setting a variable with that name before the program started. Remove the "Set ErrorLevel=15" and see if your program returns 999.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Squirre1</span><br />
      <span class="post-time small text-muted">13th June 2010 21:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That does not mask it, anytime the NSIS installer finishes it should overwrite the previous errorlevel... I have even created small scripts based on some recommendations from the others...<br />
      <br />
      Doesn't Work: Post Execution Errorlevel = 0<br />
      PHP Code:</p>
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">Name</span><span style="color: #DD0000">"SetErrorLeveltest"<br />
      <br /></span> <span style="color: #0000BB">OutFile</span><span style="color: #DD0000">"SetErrorLevel.exe"<br />
      <br /></span> <span style="color: #007700">Function.</span><span style="color: #0000BB">onInit<br />
      FunctionEnd<br />
      <br />
      Section<br />
      SetErrorLevel25<br />
      SectionEnd<br /></span></span> <!-- php buffer end -->
      <hr />
      Doesn't Work: Post Execution Errorlevel = 0<br />
      PHP Code:
      <hr />
      <code style="white-space:nowrap"><!-- php buffer start --></code><span style="color: #000000"><span style="color: #0000BB">Name</span><span style="color: #DD0000">"SetErrorLeveltest"<br />
      <br /></span> <span style="color: #0000BB">OutFile</span><span style="color: #DD0000">"SetErrorLevel.exe"<br />
      <br /></span> <span style="color: #007700">Function.</span><span style="color: #0000BB">onInit<br />
      FunctionEnd<br />
      <br />
      Section<br />
      SectionEnd<br />
      <br /></span> <span style="color: #007700">Function.</span><span style="color: #0000BB">onGUIEnd<br />
      SetErrorlevel25<br />
      Quit<br />
      FunctionEnd<br /></span></span> <!-- php buffer end -->
      <hr />
      No matter how you do it, for some reason the errorlevel is not returning... I have another installer where errorlevel is assigned with no problem the exact same way as in the first post, BUT it is not assigned manually, but by the installer... For ex.<br />
      <br />
      ExecWait "blah blah blah" $0<br />
      SetErrorLevel $0<br />
      <br />
      That works find with no problem... So not quite sure what is up... Im Stumped for the moment...
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Squirre1</span><br />
      <span class="post-time small text-muted">13th June 2010 21:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">So, a little more into it.. And this is even a little more messed up...<br />
      <br />
      From the scripts in my previous post. If you call it from command line as just seterrorlevel.exe it returns with 0. But if you call it from command line as cmd /c "seterrorlevel.exe" it actually does return the errorlevel of 25... Ugh... Now I am lost, if it is just an interfacing issue or if there is some underlying thing in my NSIS script that is not getting set...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">13th June 2010 22:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">To verify error levels, use another nsis script and call ExecWait yourapp.exe $0 and check the register, cmd.exe has many problems with error codes</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Wizou</span><br />
      <span class="post-time small text-muted">13th June 2010 23:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Anders is right..<br />
      In cmd.exe, if you want to catch the correct ERRORLEVEL from a non-console app, you must call<br /></p>
      <pre>
<code>start "" /WAIT myapp.exe<br />echo %ERRORLEVEL%</code>
</pre><br />
      or make a program (like Anders is suggesting) that catch the errorlevel for you
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">demiller9</span><br />
      <span class="post-time small text-muted">14th June 2010 01:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>errorlevel is not the same as %errorlevel%</strong><br />
      Raymond Chen wrote an <a href="http://blogs.msdn.com/b/oldnewthing/archive/2008/09/26/8965755.aspx" target="_blank">article</a> that explains ERRORLEVEL is not the same as %ERRORLEVEL%. That's why I suggested that your "Set errorlevel=0" and "echo %errorlevel% are not displaying the actual errorlevel that the exe returns.<br />
      <br />
      You can also refer to the MS <a href="http://www.microsoft.com/resources/documentation/windows/xp/all/proddocs/en-us/batch.mspx?mfr=true" target="_blank">documentation</a> of the "IF" command which says</p>

      <blockquote>
        %errorlevel% expands into a string representation of the current value of errorlevel, <font color="red">provided that there is not already an environment variable with the name ERRORLEVEL</font>
      </blockquote>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
