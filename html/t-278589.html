<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="How to change the process owner of the installer?"><title>How to change the process owner of the installer? - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">How to change the process owner of the installer?</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=278589">How to change the process owner of the installer?</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">giriraj</span><br><span class="post-time small text-muted">10th October 2007 13:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>How to change the process owner of the installer?</strong><br>Hi.<br>As a part of my project i am supposed to create a new Windows User with Administrator privileges.<br>So far i have succeeded in that.<br>Next what my task is for the process "installer.exe"; (i.e the currently running installer) to change its owner from the logged on user to the newly created user.<br>In short i want to change the owner of the current process.<br><br>Any help in this regard would be greatly appreciated.<br><br>And by the way,this whole NSIS thing is simply outstanding stuff.Kudos to the development team for such a fantastic effort.<br><br>Regards,<br>Giriraj.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">10th October 2007 13:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I don't think you can change a process owner/user on the fly. You probably have to start another instance of the same process by calling CreateProcessAsUser or one of the other CreateProcessAs/With api's with the system plugin</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">giriraj</span><br><span class="post-time small text-muted">11th October 2007 05:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks a lot Anders for your information.<br>Is it possible for you to give an example for the same.<br>I am a newbie in this awesome technology called NSIS.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">CancerFace</span><br><span class="post-time small text-muted">11th October 2007 10:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote>I don't think you can change a process owner/user on the fly</blockquote>Actually you can but it does not seem to be a supported feature (!). Seems to work up to Server 2k3 but is broken in Vista, according to <a href="http://forums.microsoft.com/MSDN/ShowPost.aspx?PostID=1034817&amp;SiteID=1" target="_blank">this</a> page. If the calling thread has the <i>SE_ASSIGNPRIMARYTOKEN_NAME</i> privilege, one can use <i>NtSetInformationProcess</i> to change the thread's primary token and as such the security context of the owner.<br><br>@giriraj<br>You need to call <a href="http://msdn2.microsoft.com/en-us/library/aa378184.aspx" target="_blank">LogonUser</a> to get a primary token for the new user, convert the resulting impersonation token to a primary one with <a href="http://msdn2.microsoft.com/en-us/library/aa446617.aspx" target="_blank">DuplicateTokenEx</a> then call <a href="http://msdn2.microsoft.com/en-us/library/ms682429.aspx" target="_blank">CreateProcessAsUser</a> with the new token, in order to start a new process of the program.<br><br>Alternatively you can call <a href="http://msdn2.microsoft.com/en-us/library/ms682434.aspx" target="_blank">CreateProcessWithTokenW</a> or the <a href="http://msdn2.microsoft.com/en-us/library/ms682431.aspx" target="_blank">CreateProcessWithLogonW</a> APIs as anders suggested.<br><br>I'll try to put this together on a script if time permits, unless someone has it ready.<br>CF</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">giriraj</span><br><span class="post-time small text-muted">11th October 2007 10:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">It would be really helpful to me if you can put up an example.<br>I am yet to get conversant with the terminologies involved in the System calls made through NSIS.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">CancerFace</span><br><span class="post-time small text-muted">11th October 2007 11:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Then this is an excellent opportunity to get conversant with the system API calls. Start with <a href="http://nsis.sourceforge.net/Authenticate_User" target="_blank">this</a> LogonUser example and its <a href="http://msdn2.microsoft.com/en-us/library/aa378184.aspx" target="_blank">MSDN</a> description and move to the other API calls. What you are after is rather involved as there are many little details to pay attention to...<br>CF</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">CancerFace</span><br><span class="post-time small text-muted">11th October 2007 16:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">@giriraj<br>After reading the MSDN info on the functions that are mentioned in this thread, I think that the easiest way to start a new process with your new account is by calling from your installer <a href="http://msdn2.microsoft.com/en-us/library/ms682431.aspx" target="_blank">CreateProcessWithLogonW</a>.<br><br>Here is a minimal script to get you started:<br></p><pre>
<code>!define LOGON_WITH_PROFILE  0x00000001<br>!define LOGON_NETCREDENTIALS_ONLY  0x00000002<br>!define CREATE_DEFAULT_ERROR_MODE  0x04000000<br>!define CREATE_NEW_CONSOLE  0x00000010<br>!define CREATE_NEW_PROCESS_GROUP  0x00000200<br>!define strPROCESS_INFORMATION  (i,i,i,i)<br><br>SetCompressor /SOLID lzma<br>!include "MUI.nsh"<br>!include "LogicLib.nsh"<br><br>OutFile "TEST.exe"<br>InstallDir "$PLUGINSDIR"<br><br>Section -Ext<br>MessageBox MB_OK|MB_ICONINFORMATION "Starting Notepad as another user:"<br>System::Alloc ${NSIS_MAX_STRLEN}<br>Pop $R0<br>System::Call 'Advapi32::CreateProcessWithLogonW(w "test",w ".",w "1234",i ${LOGON_WITH_PROFILE},w "$SYSDIR\notepad.exe",w "",i ${CREATE_DEFAULT_ERROR_MODE}|${CREATE_NEW_CONSOLE}|${CREATE_NEW_PROCESS_GROUP},,w "$SYSDIR\",,i R0)i.R6 ?e'<br>Pop $9<br>${If} $R6 == 0<br>  MessageBox MB_OK|MB_ICONSTOP "Got an error code of '$9'"<br>  Quit<br>${EndIf}<br>System::Call '*$R0${strPROCESS_INFORMATION}(.R1,.R2,.R3,.R4)'<br>MessageBox MB_OK|MB_ICONEXCLAMATION "The new process started!$\nProcess handle: $R1$\nProcess thread: $R2$\nProcessID: $R3$\nThreadID: $R4$\n"<br>MessageBox MB_OK|MB_ICONINFORMATION "Press OK to terminate the original process"<br>  Quit<br>SectionEnd<br><br>Function .onInit<br>  InitPluginsDir<br>FunctionEnd</code>
</pre><br>
      It will start notepad in the security context of the user <i>test</i> with password <i>1234</i> (<i>Replace those with your new admin user's values</i>) and will then exit.<br>
      <br>
      Go over the notes on the MSDN page, maybe your scenario needs some extra bits, but the above should be a good starting point.<br>
      CF
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">giriraj</span><br>
      <span class="post-time small text-muted">17th October 2007 07:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks a lot CF.<br>
      I was able to run your sample code and the notepad's owner was actually the new user i specified.<br>
      But then i got stuck.<br>
      What i specifically need is that whatever files are installed by the installer ,all of those files should have their preferences(for e.g file owner) set to the new user i just created(new user is created through the same installer process).I mean all these have to be performed through single instance of the running installer.<br>
      I was looking for a way to do this through "CreateProcessWithLogonW". But i haven't found a way yet.<br>
      I hope i am able to put forth my problem appropriately.<br>
      <br>
      Giriraj.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">giriraj</span><br>
      <span class="post-time small text-muted">17th October 2007 07:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">And just to add something more.<br>
      I have created a plug-in that encrypts a string using Win32Crypto API in VC(i am new to VC too :) ).<br>
      Is there any place i can post my plug-in for others to use.?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br>
      <span class="post-time small text-muted">17th October 2007 10:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Ownership of files/folders you can set from within the installer using the <a href="http://nsis.sourceforge.net/AccessControl_plug-in" target="_blank">AccessControl</a> plugin...<br>
      <br>
      Also you may want to have a look at the remarks at the end of the <a href="http://msdn2.microsoft.com/en-us/library/ms682431.aspx" target="_blank">CreateProcessWithLogon</a> MSDN page:</p>

      <blockquote>
        By default, CreateProcessWithLogonW does not load the specified user profile into the HKEY_USERS registry key. This means that access to information in the HKEY_CURRENT_USER registry key may not produce results that are consistent with a normal interactive logon. It is your responsibility to load the user registry hive into HKEY_USERS before calling CreateProcessWithLogonW, by using LOGON_WITH_PROFILE, or by calling the LoadUserProfile function.
      </blockquote>...<br>
      <br>
      What this means is that you can run your program at the security context of your new user, however the user's profile is not loaded and his/her hive is not present in the registry. Changes that you would like to reflect to this user's program preferences will not be saved unless you load the user's profile...<br>
      <br>
      You can attach your plugin on this (or another) thread or you can create a <a href="http://nsis.sourceforge.net/Category:Plugins" target="_blank">wiki</a> page for it (some related information can be found <a href="http://nsis.sourceforge.net/Wiki_Information" target="_blank">here</a>)<br>
      <br>
      CF
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>