<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Searching for a string in a text file" />

  <title>Searching for a string in a text file - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Searching for a string in a text file</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=243361">Searching for a string in a text file</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">torpark</span><br />
      <span class="post-time small text-muted">13th April 2006 15:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Searching for a string in a text file</strong><br />
      I'm using stu's FileSearch function to search for a string, but it isn't working. The string is certainly in the file, but it keeps looping. Ideas? Also, does $1 indicate the string was found, or the file was found?<br />
      <br />
      CheckForCircuit:<br />
      Sleep 5000<br />
      Push $EXEDIR\temp\tor.log<br />
      Push "Successfully created a circuit"<br />
      Call FileSearch<br />
      Pop $0 #Number of times found throughout<br />
      Pop $1 #Found at all? yes/no<br />
      Pop $2 #Number of lines found in<br />
      StrCmp $1 yes LaunchFF CheckForCircuit</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">13th April 2006 17:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">$1 indicates the string was found.<br />
      Ran it 50 times or so, with sort string, long string, long string with spaces, always fool-proof. :-)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">13th April 2006 17:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I'll check it out when I can get on my build machine.<br />
      <br />
      -Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">13th April 2006 20:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Could you post tor.log?<br />
      Function works fine for me.<br />
      <br />
      -Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">torpark</span><br />
      <span class="post-time small text-muted">14th April 2006 02:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Here is the file</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">torpark</span><br />
      <span class="post-time small text-muted">14th April 2006 02:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">perhaps a better explanation is needed.<br />
      <br />
      execdos is writing this tor.exe's output to the log file. And the file keeps getting updated. That is why I have a 5000 delay. Is it not getting read because the file is already open and being appended to?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">galil</span><br />
      <span class="post-time small text-muted">14th April 2006 03:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Uh, first of all, in the log file you attached there's no such string you were looking for. So no surprise it loops.<br />
      <br />
      And second, to see if the file was opened successfully, in FileSearch function after the FileOpen command add<br />
      IfErrors 0 +2<br />
      MessageBox MB_OK "FileOpen error!"</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">torpark</span><br />
      <span class="post-time small text-muted">14th April 2006 04:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>galil</strong><br />
      yes, i'm aware that isn't the string. i just typed that in. infact it doesn't even find "circuit".<br />
      <br />
      However you are right. There is a fileopen error! So if it is already open and being appended, what do you suggest? Is there a way to read a file that is already opened and being written to by another program?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">14th April 2006 09:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">check out this example, handles the fileopen case, though, we stop the execution at certain n , because we read and write in a loop. Assuming that other program writes in the file we read the execution is terminated once the file no more updated.<br />
      * there is a strange n of lines shown but I guess it is because of the read/write loop. Anyway the string and n of times found is fool-proof. :-)<br /></p>
      <pre>
<code>!define STRING 'Successfully created a circuit'<br />!define FILE '$EXEDIR\install.log'<br />!define TEMPFILE '$TEMP\tmp.log'<br /><br />outfile 'test.exe'<br />ShowInstDetails show<br /><br />section -<br />    strcpy $R1 0 ; needed to stop loop for the example<br />_loop:<br />   FileOpen $R0 '${FILE}' a<br />   FileSeek $R0 0 END<br />   FileWrite $R0 'bla bla bla$\r$\n'<br />   FileWrite $R0 '${STRING}$\r$\n'<br />   FileWrite $R0 'bla bla bla$\r$\n'<br />   ; this is only for to stop loop for the example<br />   ; in real world the prog who writes on readme.txt<br />   ; when is about to finish will write the last record EOF<br />   ; so when the prog who reads the tmp.log should stop loop<br />   Intop $R1 $R1 + 1<br />   intcmp $R1 '9' +2 +2 +1<br />   FileWrite $R0 'EOF$\r$\n'<br />   fileclose $R0<br />   CopyFiles '${FILE}' '${TEMPFILE}'<br /><br />   Push '${TEMPFILE}'<br />   Push '${STRING}'<br />   Call FileSearch<br />   Pop $0 #Number of times found throughout<br />   Pop $1 #Found at all? yes/no<br />   Pop $2 #Number of lines found in<br /><br />   StrCmp $1 yes 0 _end<br />   DetailPrint "'${STRING}' was found in the file $0 times on $2 lines."<br />   Push '${TEMPFILE}'<br />   Push 'EOF'<br />   Call FileSearch<br />   Pop $0 #Number of times found throughout<br />   Pop $1 #Found at all? yes/no<br />   Pop $2 #Number of lines found in<br />   StrCmp $1 yes _end<br />   goto _loop<br />_end:<br />   delete ${TEMPFILE}<br />sectionend<br /></code>
</pre>don't forget <a href="http://nsis.sourceforge.net/Search_for_text_in_file" target="_blank">Stu's function search for text in file</a><br />
      <br />
      * this article entirely edited in order to make more sense. (hopful) :-)
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">14th April 2006 13:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I did try to make my comments more readable and upload here the entire script including Stu's function.<br />
      @ Stu I hope you don't mind. If you do, just remove the link :-)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">torpark</span><br />
      <span class="post-time small text-muted">14th April 2006 16:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The problem i'm having is the FileOpen fails. If FileOpen didn't work in stu's FileSearch, I don't think it will work here either.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">14th April 2006 16:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">the above script is full working. why don't you try to customize it according what you want to do?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">torpark</span><br />
      <span class="post-time small text-muted">14th April 2006 17:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Stu's script works fine as well. The problem has nothing to do with the script, it is that the file i am trying to open is already opened by execdos and thus locked.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">14th April 2006 17:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If another process has the file locked then make a copy of it and search that instead (like Red Wine's example shows). It may or may not work but it's worth trying.<br />
      <br />
      -Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">torpark</span><br />
      <span class="post-time small text-muted">14th April 2006 17:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I tried copying it a while back. It ends up writing a file fragment.<br />
      <br />
      If it helps the issue, the file that i'm tring to open is originally opened (thus locked?) by ExecDos as it's log file:<br />
      <br />
      ExecDos::exec /NOUNLOAD /ASYNC `"$EXEDIR\tor\tor.exe" -f "$EXEDIR\tor\torrc"` "" "$EXEDIR\temp\tor.log"<br />
      <br />
      So it is inside my program, if i can figure out how to access it. Afrow, any ideas about using a variable as the log file and having that variable written to a file i can open?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">14th April 2006 17:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I got the point a little late :-)<br />
      Anyway I don't know how the execdos log works but when I'm testing those below they work fine. The problem is that must exists a keyword to the end of the logging. The keyword could be the same with the one you're looking for if you just want to find it one time. If you want to find it n times then must exists a keyword that means end of logging.<br />
      When I run loop_read begins looping, then I run loop_write and they both work fine all the way to the end. For the example I run the logging for specific rounds, and I use as keyword EOF that tells me the logging is finished so terminate the loop_read.</p>
      <pre>
<code>!define STRING 'Successfully created a circuit'<br />!define FILE '$EXEDIR\install.log'<br /><br />outfile 'loop_read.exe'<br />ShowInstDetails show<br /><br />section -<br />_loop:<br />   Push '${FILE}'<br />   Push '${STRING}'<br />   Call FileSearch<br />   Pop $0 #Number of times found throughout<br />   Pop $1 #Found at all? yes/no<br />   Pop $2 #Number of lines found in<br /><br />   StrCmp $1 yes 0 _loop<br />   DetailPrint "'${STRING}' was found in the file $0 times"<br /><br />   Push '${FILE}'<br />   Push 'EOF'<br />   Call FileSearch<br />   Pop $0 #Number of times found throughout<br />   Pop $1 #Found at all? yes/no<br />   Pop $2 #Number of lines found in<br />   StrCmp $1 yes _end<br />   goto _loop<br />_end:<br />sectionend</code>
</pre><br />
      <pre>
<code>!define FILE '$EXEDIR\install.log'<br />!define STRING 'Successfully created a circuit'<br /><br />outfile 'loop_write.exe'<br />showinstdetails show<br /><br />section -<br />   FileOpen $R0 '${FILE}' a<br />_loop:<br />   FileSeek $R0 0 END<br />   FileWrite $R0 'bla bla bla$\r$\n'<br />   FileWrite $R0 'bla bla bla$\r$\n'<br />   FileWrite $R0 'bla bla bla$\r$\n'<br />   FileWrite $R0 'bla bla bla$\r$\n'<br />   <br />   Intop $R1 $R1 + 1<br />   intcmp $R1 '199' +4 +4 +1<br />   FileWrite $R0 '${STRING}$\r$\n'<br />   FileWrite $R0 'EOF$\r$\n'<br />   goto _end<br />   goto _loop<br />_end:<br />   fileclose $R0<br />sectionend</code>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">14th April 2006 17:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">It's a shame ExecDos doesn't support ExecToStack (or similar) like nsExec. Ideally it would push a line of output to the stack as an individual stack item which you could Pop in a loop.<br />
      <br />
      -Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">torpark</span><br />
      <span class="post-time small text-muted">14th April 2006 18:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Okay. This is now confusing. I found out the file appears to be share read access supposedly. Here is the code inside execdos:<br />
      <br />
      /* open log file if name is correct */<br />
      if(*(ptp-&gt;logFile) != 0 &amp;&amp;<br />
      (f = CreateFile(ptp-&gt;logFile, GENERIC_WRITE, FILE_SHARE_READ, NULL,<br />
      CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL)) == INVALID_HANDLE_VALUE)<br />
      { rslt = ERR_LOGOPEN; break; }<br />
      <br />
      <br />
      But yet, I cannot use CopyFiles to copy it. That doesn't seem right.<br />
      <br />
      Afrow, instead of using ExecDos to generate the log file, I can have the external program pipe the data to stdout. Can stdout be captured somehow?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">torpark</span><br />
      <span class="post-time small text-muted">14th April 2006 18:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">SOLUTION FOUND.<br />
      <br />
      If I copy the file, I get a file fragment. And this would normally be no good, except that the reason I think it is a file fragment is because it has no EOF. But that doesn't matter. If I just ignore that it is a fragment and read the file, it totally works. However, I am concerned about how other OSes and file systems will interpret the fragment. Thoughts on this?<br />
      <br />
      So here is the code for all eternity:<br />
      <br />
      LaunchTor:<br />
      SetOutPath "$EXEDIR"<br />
      ExecDos::exec /NOUNLOAD /ASYNC `"$EXEDIR\tor\tor.exe" -f "$EXEDIR\tor\torrc"` "" "$EXEDIR\temp\tor.log"<br />
      Sleep 2000<br />
      FindProcDLL::FindProc "tor.exe"<br />
      Pop $R0<br />
      StrCmp $R0 "0" "" CheckForCircuit ; If tor.exe process is not running, start tor again, else goto LaunchFF<br />
      Goto LaunchTor<br />
      <br />
      CheckForCircuit:<br />
      Sleep 1000<br />
      CopyFiles $EXEDIR\temp\tor.log $EXEDIR\temp\tor.chk<br />
      Push $EXEDIR\temp\tor.chk<br />
      Push "Tor has successfully opened a circuit"<br />
      Call FileSearch<br />
      Pop $0 #Number of times found throughout<br />
      Pop $1 #Found at all? yes/no<br />
      Pop $2 #Number of lines found in<br />
      Delete $EXEDIR\temp\tor.chk<br />
      StrCmp $1 yes LaunchFF CheckForCircuit</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">14th April 2006 20:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">unless I'm still out of the point, I made it as simple as gets following the above.<br />
      I made a bat file (displays the nsis license), run it with execdos and looking for string "Altered source versions", so everything works fine at this point. even if you put a pause at the end of the bat loop_read keeps looping untill you kill cmd.exe with task manager, then terminates with success.<br />
      the bat:<br /></p>
      <pre>
<code>@echo OFF<br />rem name it tor.bat<br />ECHO Copyright (C) 1999-2006 Nullsoft, Inc.<br />ECHO. <br />ECHO This license applies to everything in the NSIS package,<br />ECHO except where otherwise noted.<br />ECHO. <br />ECHO This software is provided 'as-is', without any express or implied warranty.<br />ECHO In no event will the authors be held liable for any damages arising from<br />ECHO the use of this software. <br />ECHO.<br />ECHO Permission is granted to anyone to use this software for any purpose, including<br />ECHO commercial applications, and to alter it and redistribute it freely, subject<br />ECHO to the following restrictions:<br />ECHO.<br />ECHO 1. The origin of this software must not be misrepresented;<br />ECHO you must not claim that you wrote the original software.<br />ECHO If you use this software in a product, an acknowledgment in the product<br />ECHO documentation would be appreciated but is not required.<br />ECHO.<br />ECHO 2. Altered source versions must be plainly marked as such,<br />ECHO and must not be misrepresented as being the original software.<br />ECHO.<br />ECHO 3. This notice may not be removed or altered from any source distribution.<br />rem pause <br /></code>
</pre><br />
      the script:<br />
      <pre>
<code>!define STRING 'Altered source versions'<br />!define FILE '$EXEDIR\tor.log'<br /><br />outfile 'loop_read.exe'<br />ShowInstDetails show<br /><br />section -<br />ExecDos::exec /NOUNLOAD /ASYNC `"$EXEDIR\tor.bat" -f "$EXEDIR\torrc"` "" "$EXEDIR\tor.log"<br />_loop:<br />   Push '${FILE}'<br />   Push '${STRING}'<br />   Call FileSearch<br />   Pop $0 #Number of times found throughout<br />   Pop $1 #Found at all? yes/no<br />   Pop $2 #Number of lines found in<br /><br />   StrCmp $1 yes 0 _loop<br />   DetailPrint "'${STRING}' was found in the file $0 times"<br />sectionend</code>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">14th April 2006 20:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I think you may be missing the point <i>Red Wine</i>.<br />
      ExecDos keeps the log file in use while it writes to it (/ASYNC) and while it is in use, we can't access it from elsewhere (i.e. in the NSIS script).<br />
      /ASYNC means that it runs as a seperate thread along side our NSIS script.<br />
      For <i>torpark</i> your code will infinately loop until ExecDos has finished.<br />
      <br />
      -Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Red Wine</span><br />
      <span class="post-time small text-muted">14th April 2006 21:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">So, we need a sync access to the log, it's useless if we read it after is created. Am I right?<br />
      I thought we just need to know if tor 'Successfully created a circuit' in order to launch FF, else re-launch tor or do some other action.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">14th April 2006 22:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Yes. Probably needs to find out when part of the process is complete so that another task can be executed (or perhaps the task can be closed).<br />
      <br />
      -Stu</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
