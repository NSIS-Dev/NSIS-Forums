<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="$APPDATA directory creation failure under Vista"><title>$APPDATA directory creation failure under Vista - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">$APPDATA directory creation failure under Vista</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=272512">$APPDATA directory creation failure under Vista</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">billsh</span><br><span class="post-time small text-muted">8th June 2007 21:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>$APPDATA directory creation failure under Vista</strong><br>I'm trying to create a folder under $APPDATA\FOO for some data files (CreateDirectory "$APPDATA\test"). This fails on Vista, yet I can open a non-admin cmd window and MD that folder with no problems. I can see the correct paths in the Details window so I know I'm in the right place. It will say something like:<br><br>Create folder: c:\Users\Bill\AppData\Roaming\test<br><br>yet that folder doesn't exist after install.<br><br>Is there a way to get win32-type error codes info from this failure? I know it sets the error flag, is there any info stored in registers or variables after that flag is set? I haven't found anything like that in the samples/forum (although I could be just be ignorant and not seeing it). Most just seem to jump to a section that prints an error, but I haven't found any examples that give me something like GetLastError() would.<br><br>Cheers!</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">9th June 2007 09:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">There's no way to get the last error. Are you sure it really creates the right directory and you're not just in an elevated account where you actually create something like C:\Users\<b>Admin</b>\AppData\Roamin\test?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">GenRabbit</span><br><span class="post-time small text-muted">10th June 2007 13:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I have had the same problem, It runs smoothly under WinXp and generates a file as expected in the $appdata$ folder. But on Vista its no no. Its not being created.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">GenRabbit</span><br><span class="post-time small text-muted">10th June 2007 13:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Btw here is my installer script. just remove the files to isntall to test it on Vista or something.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pengyou</span><br><span class="post-time small text-muted">10th June 2007 17:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Creating a folder using $APPDATA\test works OK for me on Vista, using a "standard" account and an installer with RequestExecutionLevel set to "user".</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">GenRabbit</span><br><span class="post-time small text-muted">11th June 2007 00:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">And how do I set RequestExecutionLevel to "user". I don't have Vista, A friend runs it somewhere far away from me.<br>Did it work with my installer?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pengyou</span><br><span class="post-time small text-muted">11th June 2007 01:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote>And how do I set RequestExecutionLevel to "user"</blockquote>Add the command to your installer script.<br><br>See the NSIS User Manual:<br><a href="http://nsis.sourceforge.net/Docs/Chapter4.html#4.8.1.32" target="_blank">http://nsis.sourceforge.net/Docs/Chapter4.html#4.8.1.32</a></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">billsh</span><br><span class="post-time small text-muted">12th June 2007 15:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I've tried a few things, but still can't seem to create that sucker. I've searched the disk and it doesn't appear that its being virtualized.<br><br>Here is a snippet of code:<br><br>RequestExecutionLevel user (tried admin too)<br>...<br><br>SetOutPath "$INSTDIR"<br>File /r "DiskImage\*"<br><br>; Move test.inf over to app data folder<br><br>ClearErrors<br>CreateDirectory "$APPDATA\test"<br>Rename "$INSTDIR\test.inf" "$APPDATA\test\test.inf"<br>IfErrors 0 +2<br>DetailPrint "CreateDirectory Failed"<br><br><br>I don't get the failure notice on CreateDirectory, so NSIS thinks it created the folder. The rename call seems to point to the right files (c:\program files\test\test.inf -&gt; c:\users\&lt;me&gt;\AppData\Roaming\test\test.inf). But I can't find that file/directory on the disk anywhere after.<br><br>If I try to run Filemon to capture it I get gobs of random NSIS files accesses under c:\users by the setup process, but setup doesn't give me any UI - and the process is still running and can't be killed. So much for being clever!</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">pengyou</span><br><span class="post-time small text-muted">12th June 2007 17:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Here is the script for the test program I used on my Vista system.<br></p><pre>
<code>; Using $APPDATA on Vista<br><br>  RequestExecutionLevel   user<br><br>  OutFile "demo.exe"<br>  ShowInstDetails show<br><br>Section<br>        CreateDirectory   "$APPDATA\demo"<br>SectionEnd</code>
</pre>I logged in as the user "Test" and ran the demo.exe program. The details window showed<br>
      <br>
      Create folder: C:\Users\Test\AppData\Roaming\demo<br>
      Completed<br>
      <br>
      and when I checked the "demo" folder had been created. I deleted the "demo" folder, re-ran the test and the folder got recreated.
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">billsh</span><br>
      <span class="post-time small text-muted">12th June 2007 22:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks! I can run your script and it works great. However if I change user to admin/none it fails. Do you see the same behavior?<br>
      <br>
      I'll need admin to put files in Program Files of course.<br>
      <br>
      Cheers!</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">pengyou</span><br>
      <span class="post-time small text-muted">12th June 2007 23:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I changed the "RequestExecutionLevel user" line in my script to "RequestExecutionLevel admin" and recompiled it.<br>
      <br>
      I ran the revised program while logged in as the "Test" user and Vista asked me for the administrator password. After I entered the password the program created the "demo" folder in the administrator's "AppData\Roaming" folder. I deleted the "demo" folder, re-ran the test and the folder got recreated.<br>
      <br>
      I logged in as the administrator and ran the revised program. It created the "demo" folder in the administrator's "AppData\Roaming" folder. I deleted the "demo" folder, re-ran the test and the folder got recreated.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">GenRabbit</span><br>
      <span class="post-time small text-muted">13th June 2007 12:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Can the "RequestExecutionLevel user" be put anywhere in the installer? like just below the !define and !include ?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">billsh</span><br>
      <span class="post-time small text-muted">13th June 2007 17:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I believe I've sorted out the main problem (pilot error). The admin user name is a '.' different that the 'user' name, so first.last vs firstlast. Sorry, missed that period in 1440x900 mode. Beer fine for me. And the folder search won't turn it up cause a user doesn't have perms to the admin data.<br>
      <br>
      So my final behavior is:<br>
      <br>
      Logon Admin:<br>
      REL:user- no pw prompt. created in appdata\user<br>
      REL:admin - prompt. created in appdata\admin<br>
      <br>
      Logon Std:<br>
      REL:user - no prompt. created in appdata\user<br>
      REL:admin - prompt. created in appdata\admin<br>
      <br>
      However, it does bring up another interesting question. If you need admin level for copying files to c:\program files, but your app is run in std mode. How will the app find it's data? Its copied to appdata\admin at install time vs appdata\user and the user can't see the admin's tree even if they knew where it was.<br>
      <br>
      I can't seem to find a best practice doc on this, but it must be a common issue as everyone is now supposed to not put data in Program Files.<br>
      <br>
      GenRabbit - you can put it up top with all the initial includes, etc. It yelled at me if I put it in a section.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">13th June 2007 19:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The best practice is to create the data files for a specific user from the program itself. The installer should only install global data files.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">billsh</span><br>
      <span class="post-time small text-muted">18th June 2007 19:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks Kichik! What do people do about uninstall? We'll have the same location ambiguity issue, but the app obviously won't know its being uninstalled.<br>
      <br>
      Cheers!</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">18th June 2007 20:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You just leave the application data behind. If you really want to remove it, you can use <a href="http://nsis.sourceforge.net/EnumUsersReg" target="_blank">EnumUsersReg</a>, but that's rarely done.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">99999999</span><br>
      <span class="post-time small text-muted">18th June 2007 21:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">One thing you might do, is to run the application that you want to run in user mode, using the Vista task manager. I have to do this for a similar purpose with my application, otherwise the second time you run the application on Vista, it cannot write to $APPDATA because the directories created the first time, were created with Administrator purposes.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">GenRabbit</span><br>
      <span class="post-time small text-muted">12th July 2007 12:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">So what your saying is that if you want to make anything install in C:\programfiles it has to install in Admin modus, billish?</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">12th July 2007 17:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Of course. That's not even new for Vista.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">GenRabbit</span><br>
      <span class="post-time small text-muted">14th July 2007 09:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Oki, I wasen't aware of that. neither on Vista or WindowsXP. but then again I'm always logged in with admin rights.</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script type="text/javascript" src="../js/highlight.pack.js" async>
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>