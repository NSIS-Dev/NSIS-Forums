<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Uninstaller does not reboot if run from installer" />

  <title>Uninstaller does not reboot if run from installer - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Uninstaller does not reboot if run from installer</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=340966">Uninstaller does not reboot if run from installer</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">cowwoc</span><br />
      <span class="post-time small text-muted">20th January 2012 20:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Uninstaller does not reboot if run from installer</strong><br />
      My installer code runs the uninstaller (in .onInit) if it detects the software is already installed. Once the software finishes uninstalling, it continues with the installation.<br />
      <br />
      I am using "Delete /REBOOTOK" to delete files in my uninstaller. If one of the files cannot be deleted, it asks the user to reboot the system.<br />
      <br />
      1. If I intentionally lock a file, run the uninstaller directly, and the user agrees to reboot the system *does* reboot.<br />
      <br />
      2. If I do the same, but launch the uninstaller from inside the installer, it does *not* reboot.<br />
      <br />
      The installer is invoking the uninstaller using this code:<br />
      <br /></p>
      <pre>
<code>ExecWait '$0 _?=$INSTDIR' ;Do not copy the uninstaller to a temp file</code>
</pre><br />
      <br />
      Why isn't the uninstaller rebooting?<br />
      <br />
      Thanks,<br />
      Gili
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">demiller9</span><br />
      <span class="post-time small text-muted">20th January 2012 20:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Windows 'knows' that the installer is running and prevents the reboot. I had a similar problem and solved it by making the uninstaller terminate the installer.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">cowwoc</span><br />
      <span class="post-time small text-muted">20th January 2012 21:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by demiller9</small><br />
        Windows 'knows' that the installer is running and prevents the reboot. I had a similar problem and solved it by making the uninstaller terminate the installer.
      </blockquote>Seems hackish, but just in case... how do you do that? :)<br />
      Is there a cleaner solution?<br />
      <br />
      Thanks,<br />
      Gili
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">20th January 2012 23:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The installer is blocking the reboot IIRC, I think there is a plugin that prevents it from doing that...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">cowwoc</span><br />
      <span class="post-time small text-muted">23rd January 2012 17:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by Anders</small><br />
        The installer is blocking the reboot IIRC, I think there is a plugin that prevents it from doing that...
      </blockquote>Where can I find this plugin?
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">23rd January 2012 19:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><a href="http://nsis.sourceforge.net/ShutdownAllow_plug-in" target="_blank">http://nsis.sourceforge.net/ShutdownAllow_plug-in</a><br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">cowwoc</span><br />
      <span class="post-time small text-muted">23rd January 2012 20:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Excellent. Thanks Stu! :)<br />
      <br />
      Gili</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">cowwoc</span><br />
      <span class="post-time small text-muted">23rd January 2012 21:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Okay, now I've got one more problem... The uninstaller is causing the system to reboot, but in the meantime it returns control back to the installer which allows the user to begin installation.<br />
      <br />
      I noticed that the uninstaller is returning exit code 164 (or -164, I forget). Where does this number come from? Is it documented somewhere? Can I rely on it not changing?<br />
      <br />
      Thanks,<br />
      Gili</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">cowwoc</span><br />
      <span class="post-time small text-muted">23rd January 2012 21:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hmm, it seems I jumped the gun. I get an exit code of 164 whether the uninstaller reboots or not. Any ideas on how to tell the installer to abort when the uninstaller tries to reboot?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">23rd January 2012 21:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Looking at the source it just returns the current error level (SetErrorLevel) so perhaps something in your script is setting it to 164. You can try setting your own error level just before rebooting.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">cowwoc</span><br />
      <span class="post-time small text-muted">23rd January 2012 21:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I stand corrected. I'm getting error code 0 (not 164) whether it reboots or not.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">cowwoc</span><br />
      <span class="post-time small text-muted">23rd January 2012 21:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Stu,<br />
      <br />
      Which function gets executed if the user chooses to reboot (I'd like to SetErrorLevel there)? I believe the reboot flag is being set by "Delete /REBOOTOK". I never explicitly set it.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">23rd January 2012 21:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>
      <pre>
<code>IfRebootFlag 0 +2<br />  SetErrorLevel 99</code>
</pre>Stu
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">cowwoc</span><br />
      <span class="post-time small text-muted">23rd January 2012 21:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by Afrow UK</small><br />
        <pre>
<code>IfRebootFlag 0 +2<br />  SetErrorLevel 99</code>
</pre>Stu
      </blockquote>I added this to the end of:<br />
      <br />
      Section "Uninstall"<br />
      <br />
      Thanks again,<br />
      Gili
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
