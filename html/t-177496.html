<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="HOWTO: Close a java application" />

  <title>HOWTO: Close a java application - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">HOWTO: Close a java application</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=177496">HOWTO: Close a java application</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">drbungle</span><br />
      <span class="post-time small text-muted">21st April 2004 15:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>HOWTO: Close a java application</strong><br />
      Hi<br />
      <br />
      heres what i want to do:<br />
      <br />
      I want the installer to shutdown a java application (a gui started with a command line order like java.exe -jar myapplication). The problem is that the app also has an icon in the systray, so if you close the app window, the icon in the taskbar still remains there and the java app is also still running (its using a dll file to be in the systray).<br />
      <br />
      I used the KillProcDLL Plugin but the problem is that if you are a developer, your development environment is also being closed. Currently i managed to solve that problem with a warning and about 6 java.exe kills running in the installer to ensure that my application is closed, but isnt there an other way ? (I hate warnings)<br />
      <br />
      How can i kill that dll and the app window ?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">sundaram123</span><br />
      <span class="post-time small text-muted">23rd April 2004 16:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">To Close the java application, you need to write the start/stop method in you java application.<br />
      <br />
      You can follow the tomcat method of starting/stoping application.<br />
      <br />
      1. While starting create a socket and listen for it.<br />
      2. To Stop connect to that port and send shutdown message.<br />
      <br />
      Here is the sample code I have.<br />
      <br />
      Hope this helps you, please let me know, if you need any more information on this<br />
      <br />
      -Sundaram<br />
      <br />
      /*<br />
      * Deamon.java<br />
      *<br />
      * Created on April 20, 2004, 1:54 PM<br />
      */<br />
      import java.io.*;<br />
      import java.util.*;<br />
      import java.beans.IndexedPropertyDescriptor;<br />
      import java.beans.PropertyChangeListener;<br />
      import java.beans.PropertyChangeSupport;<br />
      import java.beans.PropertyDescriptor;<br />
      import java.io.File;<br />
      import java.io.FileOutputStream;<br />
      import java.io.IOException;<br />
      import java.io.InputStream;<br />
      import java.io.OutputStreamWriter;<br />
      import java.io.PrintWriter;<br />
      import java.net.InetAddress;<br />
      import java.net.ServerSocket;<br />
      import java.net.Socket;<br />
      import java.security.AccessControlException;<br />
      import java.sql.Timestamp;<br />
      import java.util.Enumeration;<br />
      import java.util.Hashtable;<br />
      import java.util.Random;<br />
      <br />
      import java.rmi.*;<br />
      import java.rmi.registry.*;<br />
      import javax.rmi.*;<br />
      <br />
      public class Deamon {<br />
      <br />
      public static String SERVERIP ="127.0.0.1";<br />
      public static int SHUT_PORT=9191;<br />
      <br />
      protected static Deamon server = null;<br />
      <br />
      /**<br />
      * Use shutdown hook flag.<br />
      */<br />
      protected boolean useShutdownHook = true;<br />
      <br />
      /**<br />
      * The shutdown command string we are looking for.<br />
      */<br />
      private String shutdown = "SHUTDOWN";<br />
      <br />
      /**<br />
      * Shutdown hook.<br />
      */<br />
      protected Thread shutdownHook = null;<br />
      <br />
      /** Creates a new instance of Deamon */<br />
      public Deamon() {<br />
      }<br />
      <br />
      /**<br />
      * @param args the command line arguments<br />
      */<br />
      public static void main(String[] args) {<br />
      <br />
      server = new Deamon();<br />
      <br />
      try {<br />
      String command = "start";<br />
      if (args.length &gt; 0) {<br />
      command = args[args.length - 1];<br />
      }<br />
      System.out.println("Args: " + command);<br />
      <br />
      if (command.equals("startd") ||command.equals("start")) {<br />
      server.start();<br />
      } else if (command.equals("stopd")|| command.equals("stop")) {<br />
      server.stop();<br />
      }<br />
      } catch (Throwable t) {<br />
      t.printStackTrace();<br />
      }<br />
      <br />
      }<br />
      <br />
      public void startWriting() {<br />
      PrintWriter pw = null;<br />
      <br />
      String fileName ="c:\\test.txt";<br />
      try {<br />
      <br />
      FileWriter fw = new FileWriter(new File(fileName), true);<br />
      pw = new PrintWriter(fw);<br />
      <br />
      while(true){<br />
      pw.println(new Date().toString() + " : Waiting.....\n" );<br />
      <br />
      pw.flush() ;<br />
      Thread.sleep((60 * 60)* 2);<br />
      }<br />
      <br />
      <br />
      }catch(Exception ex){<br />
      System.out.println("Unable to open the file :" + ex);<br />
      }<br />
      <br />
      }<br />
      <br />
      public void start() {<br />
      <br />
      try {<br />
      server= this;<br />
      // Wait for shutdown message to stop<br />
      new Thread(){<br />
      public void run() {<br />
      System.out.println("Calling await");<br />
      await();<br />
      }<br />
      }.start();<br />
      <br />
      <br />
      startRmiRegistry();<br />
      startWriting();<br />
      <br />
      <br />
      } catch( Exception ex) {<br />
      System.out.println("Error : " + ex.getMessage() );<br />
      }<br />
      <br />
      <br />
      }<br />
      <br />
      <br />
      public void stop() {<br />
      <br />
      // Stop the existing server<br />
      try {<br />
      Socket socket = new Socket(SERVERIP, SHUT_PORT);<br />
      OutputStream stream = socket.getOutputStream();<br />
      // String shutdown = server.getShutdown();<br />
      for (int i = 0; i &lt; shutdown.length(); i++)<br />
      stream.write(shutdown.charAt(i));<br />
      stream.flush();<br />
      stream.close();<br />
      socket.close();<br />
      } catch (IOException e) {<br />
      System.out.println("App.stop: " + e);<br />
      // e.printStackTrace(System.out);<br />
      System.exit(1);<br />
      }<br />
      <br />
      System.out.println("Done!");<br />
      System.exit(0);<br />
      }<br />
      <br />
      // Start RMI Registry<br />
      public void startRmiRegistry() {<br />
      // ==================== Start RMi registry ===============<br />
      try {<br />
      Registry registry = LocateRegistry.createRegistry(1099);<br />
      System.out.println("RMI registry started");<br />
      } catch ( Exception x) {<br />
      System.out.println("Error while start RMI registry");<br />
      }<br />
      }<br />
      <br />
      <br />
      /**<br />
      * Wait until a proper shutdown command is received, then return.<br />
      */<br />
      public void await() {<br />
      <br />
      // Set up a server socket to wait on<br />
      ServerSocket serverSocket = null;<br />
      System.out.println("creating server socket");<br />
      try {<br />
      serverSocket =<br />
      new ServerSocket(SHUT_PORT, 1,<br />
      InetAddress.getByName("127.0.0.1"));<br />
      } catch (IOException e) {<br />
      System.err.println("StandardServer.await: create[" + SHUT_PORT<br />
      + "]: " + e);<br />
      e.printStackTrace();<br />
      System.exit(1);<br />
      }<br />
      <br />
      // Loop waiting for a connection and a valid command<br />
      while (true) {<br />
      <br />
      // Wait for the next connection<br />
      Socket socket = null;<br />
      InputStream stream = null;<br />
      try {<br />
      socket = serverSocket.accept();<br />
      socket.setSoTimeout(10 * 1000); // Ten seconds<br />
      stream = socket.getInputStream();<br />
      } catch (AccessControlException ace) {<br />
      System.err.println("StandardServer.accept security exception: "<br />
      + ace.getMessage());<br />
      continue;<br />
      } catch (IOException e) {<br />
      System.err.println("StandardServer.await: accept: " + e);<br />
      e.printStackTrace();<br />
      System.exit(1);<br />
      }<br />
      <br />
      // Read a set of characters from the socket<br />
      StringBuffer command = new StringBuffer();<br />
      Random random=null;<br />
      int expected = 1024; // Cut off to avoid DoS attack<br />
      while (expected &lt; shutdown.length()) {<br />
      if (random == null)<br />
      random = new Random(System.currentTimeMillis());<br />
      expected += (random.nextInt() % 1024);<br />
      }<br />
      while (expected &gt; 0) {<br />
      int ch = -1;<br />
      try {<br />
      ch = stream.read();<br />
      } catch (IOException e) {<br />
      System.err.println("StandardServer.await: read: " + e);<br />
      e.printStackTrace();<br />
      ch = -1;<br />
      }<br />
      if (ch &lt; 32) // Control character or EOF terminates loop<br />
      break;<br />
      command.append((char) ch);<br />
      expected--;<br />
      }<br />
      <br />
      // Close the socket now that we are done with it<br />
      try {<br />
      socket.close();<br />
      } catch (IOException e) {<br />
      ;<br />
      }<br />
      <br />
      // Match against our command string<br />
      boolean match = command.toString().equals(shutdown);<br />
      if (match) {<br />
      break;<br />
      } else<br />
      System.err.println("StandardServer.await: Invalid command '" +<br />
      command.toString() + "' received");<br />
      <br />
      }<br />
      <br />
      // Close the server socket and return<br />
      try {<br />
      serverSocket.close();<br />
      } catch (IOException e) {<br />
      ;<br />
      }<br />
      System.out.println("Shuting down!!!");<br />
      System.exit(0);<br />
      }<br />
      <br />
      }</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">drbungle</span><br />
      <span class="post-time small text-muted">26th April 2004 11:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I havent tried the code above yet, the developer has to include it in the next program version, but if its working how to connect to that socket from within NSIS, do you have a sample code for that too ?<br />
      <br />
      But its good to see that there is an other way, killing javaw.exe x 5 isnt a good solution, like i said, on the developers machine i killed the Java Development Environment when testing the installer ;)</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
