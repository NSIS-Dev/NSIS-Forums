<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="INSTDIR remembers previous setting" />

  <title>INSTDIR remembers previous setting - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">INSTDIR remembers previous setting</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=277627">INSTDIR remembers previous setting</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">DrPeggs</span><br />
      <span class="post-time small text-muted">20th September 2007 11:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>INSTDIR remembers previous setting</strong><br />
      Hi<br />
      <br />
      I am having trouble with a couple of scripts and i am not sure whether this is a nsis bug or intended behaviour.<br />
      <br />
      I have a zip file that the user extracts to some dir and then runs my nsis exe installer to just re-arrange a couple of directories and install a desktop and 2 start menu shortcuts (one for my app and one for an uninstaller).<br />
      <br />
      I have a virtually identical 2nd script which does all the same stuff but for a slightly different flavour of my software.<br />
      <br />
      So basically, in essence, i have installer_X and installer_Y and uninstaller_X and uninstaller_Y in the appropriate and completely separate X and Y dirs.<br />
      <br />
      All seems to work fine if you only work with one app, either X or Y, doesn't matter, installs fine, uninstalls fine.<br />
      <br />
      Now the problem comes if i install one app, lets say app X and then app Y then i attempt to uninstall X. The X uninstaller seems to use the INSTDIR variable from the last used installer on the machine, in this case Y!! The result is that uninstaller_X removes the files in the Y dir!<br />
      <br />
      So to summarise, INSTDIR for the uninstaller seems to remember the value from the last used installer.<br />
      <br />
      <br />
      So my questions and plees for help are:<br />
      <br />
      1) Can anyone repeat this?<br />
      2) Is it known or expected or intended or is it a bug i should report?<br />
      3) Is there a work-around i can try?<br />
      <br />
      I suspect i have just misunderstood the proper INSTDIR usage<br />
      Thanks a lot in advance<br />
      Steve<br />
      :)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">20th September 2007 12:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You are probably using the same InstallDirRegKey for both.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">DrPeggs</span><br />
      <span class="post-time small text-muted">20th September 2007 12:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Here is my script - originally generated in Eclipse then edited by hand (i have added comments and censored some info for this post, hope that is ok):<br />
      <br />
      # Auto-generated by EclipseNSIS Script Wizard<br />
      # 06-Aug-2007 13:53:41<br />
      # Then butchered by the fingers of xxx on 07-Aug-2007<br />
      # 20/09/07 xxx updated with a new shortcut icon<br />
      <br />
      Name MyApp<br />
      <br />
      # Defines<br />
      !define REGKEY "SOFTWARE\$(^Name)"<br />
      !define VERSION 1_06 &lt;---- This is the only thing that is different in the 2 scripts<br />
      !define COMPANY "MyCompany"<br />
      !define URL <a href="http://www.url.com" target="_blank">www.url.com</a><br />
      <br />
      # Included files<br />
      !include Sections.nsh<br />
      <br />
      # Reserved Files<br />
      ReserveFile "${NSISDIR}\Plugins\StartMenu.dll"<br />
      <br />
      # Variables<br />
      Var StartMenuGroup<br />
      <br />
      # Installer pages<br />
      Page custom StartMenuGroupSelect "" ": Start Menu Folder"<br />
      Page instfiles<br />
      <br />
      # Installer attributes<br />
      OutFile InstallMyApp.exe<br />
      InstallDir $EXEDIR<br />
      CRCCheck on<br />
      XPStyle on<br />
      Icon "${NSISDIR}\Contrib\Graphics\Icons\classic-install.ico"<br />
      ShowInstDetails show<br />
      AutoCloseWindow true<br />
      VIProductVersion 1.0.0.0<br />
      VIAddVersionKey ProductName MyApp<br />
      VIAddVersionKey ProductVersion "${VERSION}"<br />
      VIAddVersionKey CompanyName "${COMPANY}"<br />
      VIAddVersionKey CompanyWebsite "${URL}"<br />
      VIAddVersionKey FileVersion ""<br />
      VIAddVersionKey FileDescription ""<br />
      VIAddVersionKey LegalCopyright ""<br />
      InstallDirRegKey HKLM "${REGKEY}" Path<br />
      UninstallIcon "${NSISDIR}\Contrib\Graphics\Icons\classic-uninstall.ico"<br />
      ShowUninstDetails show<br />
      <br />
      # Installer sections<br />
      !macro CREATE_SMGROUP_SHORTCUT NAME PATH<br />
      Push "${NAME}"<br />
      Push "${PATH}"<br />
      Call CreateSMGroupShortcut<br />
      !macroend<br />
      <br />
      Section -Main SEC0000<br />
      SetOutPath $INSTDIR\MyApp<br />
      CreateShortcut "$DESKTOP\MyApp_${VERSION}.lnk" "$EXEDIR\MyApp\MyApp.jar" "" "$EXEDIR\MyApp\MyApp.ico"<br />
      CreateDirectory $EXEDIR\bin<br />
      CopyFiles /SILENT /FILESONLY $EXEDIR\MyApp\My_App.exe $EXEDIR\bin<br />
      CopyFiles /SILENT /FILESONLY $EXEDIR\MyApp\dlls\cygwin1.dll $EXEDIR\bin<br />
      CopyFiles /SILENT /FILESONLY $EXEDIR\MyApp\dlls\MyCompanyRunner.dll $EXEDIR\MyApp<br />
      CopyFiles /SILENT /FILESONLY $EXEDIR\MyApp\dlls\MyCompanyDLL.dll $EXEDIR\MyApp<br />
      CopyFiles /SILENT /FILESONLY $EXEDIR\MyApp\dlls\jspWin.dll $EXEDIR\MyApp<br />
      WriteRegStr HKLM "${REGKEY}\Components" Main 1<br />
      SectionEnd<br />
      <br />
      Section -post SEC0001<br />
      WriteRegStr HKLM "${REGKEY}" Path $INSTDIR<br />
      WriteRegStr HKLM "${REGKEY}" StartMenuGroup $StartMenuGroup<br />
      SetOutPath $INSTDIR<br />
      WriteUninstaller $INSTDIR\UninstallMyApp_${VERSION}.exe<br />
      !insertmacro CREATE_SMGROUP_SHORTCUT "Uninstall $(^Name) ${VERSION}" $INSTDIR\UninstallMyApp_${VERSION}.exe<br />
      WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" DisplayName "$(^Name)"<br />
      WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" DisplayVersion "${VERSION}"<br />
      WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" Publisher "${COMPANY}"<br />
      WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" URLInfoAbout "${URL}"<br />
      WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" DisplayIcon $INSTDIR\UninstallMyApp_${VERSION}.exe<br />
      WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" UninstallString $INSTDIR\UninstallMyApp_${VERSION}.exe<br />
      WriteRegDWORD HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" NoModify 1<br />
      WriteRegDWORD HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" NoRepair 1<br />
      SetOutPath $INSTDIR\MyApp<br />
      CreateShortcut "$SMPROGRAMS\$StartMenuGroup\MyApp_${VERSION}.lnk" "$EXEDIR\MyApp\MyApp.jar" "" "$EXEDIR\MyApp\MyApp.ico"<br />
      SectionEnd<br />
      <br />
      # Macro for selecting uninstaller sections<br />
      !macro SELECT_UNSECTION SECTION_NAME UNSECTION_ID<br />
      Push $R0<br />
      ReadRegStr $R0 HKLM "${REGKEY}\Components" "${SECTION_NAME}"<br />
      StrCmp $R0 1 0 next${UNSECTION_ID}<br />
      !insertmacro SelectSection "${UNSECTION_ID}"<br />
      GoTo done${UNSECTION_ID}<br />
      next${UNSECTION_ID}:<br />
      !insertmacro UnselectSection "${UNSECTION_ID}"<br />
      done${UNSECTION_ID}:<br />
      Pop $R0<br />
      !macroend<br />
      <br />
      # Uninstaller sections<br />
      !macro DELETE_SMGROUP_SHORTCUT NAME<br />
      Push "${NAME}"<br />
      Call un.DeleteSMGroupShortcut<br />
      !macroend<br />
      <br />
      Section /o un.Main UNSEC0000<br />
      Delete /REBOOTOK $DESKTOP\MyApp_${VERSION}.lnk<br />
      DeleteRegValue HKLM "${REGKEY}\Components" Main<br />
      SectionEnd<br />
      <br />
      Section un.post UNSEC0001<br />
      Delete $INSTDIR\bin\My_App.exe<br />
      Delete $INSTDIR\bin\cygwin1.dll<br />
      Delete $INSTDIR\MyApp\MyCompanyRunner.dll<br />
      Delete $INSTDIR\MyApp\MyCompanyDLL.dll<br />
      Delete $INSTDIR\MyApp\jspWin.dll<br />
      RMDir $INSTDIR\bin<br />
      DeleteRegKey HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)"<br />
      !insertmacro DELETE_SMGROUP_SHORTCUT "Uninstall $(^Name) ${VERSION}"<br />
      !insertmacro DELETE_SMGROUP_SHORTCUT "MyApp_${VERSION}"<br />
      Delete /REBOOTOK $INSTDIR\UninstallMyApp_${VERSION}.exe<br />
      DeleteRegValue HKLM "${REGKEY}" StartMenuGroup<br />
      DeleteRegValue HKLM "${REGKEY}" Path<br />
      DeleteRegKey /IfEmpty HKLM "${REGKEY}\Components"<br />
      DeleteRegKey /IfEmpty HKLM "${REGKEY}"<br />
      RMDir $SMPROGRAMS\$StartMenuGroup<br />
      Push $R0<br />
      StrCpy $R0 $StartMenuGroup 1<br />
      StrCmp $R0 "&gt;" no_smgroup<br />
      no_smgroup:<br />
      Pop $R0<br />
      SectionEnd<br />
      <br />
      # Installer functions<br />
      Function StartMenuGroupSelect<br />
      Push $R1<br />
      StartMenu::Select /checknoshortcuts "Do not create shortcuts" /autoadd /text "Select the Start Menu folder in which to create the program's shortcuts:" /lastused $StartMenuGroup MyCompanyMyApp<br />
      Pop $R1<br />
      StrCmp $R1 success success<br />
      StrCmp $R1 cancel done<br />
      MessageBox MB_OK $R1<br />
      Goto done<br />
      success:<br />
      Pop $StartMenuGroup<br />
      done:<br />
      Pop $R1<br />
      FunctionEnd<br />
      <br />
      Function .onInit<br />
      InitPluginsDir<br />
      FunctionEnd<br />
      <br />
      Function CreateSMGroupShortcut<br />
      Exch $R0 ;PATH<br />
      Exch<br />
      Exch $R1 ;NAME<br />
      Push $R2<br />
      StrCpy $R2 $StartMenuGroup 1<br />
      StrCmp $R2 "&gt;" no_smgroup<br />
      SetOutPath $SMPROGRAMS\$StartMenuGroup<br />
      CreateShortcut "$SMPROGRAMS\$StartMenuGroup\$R1.lnk" $R0<br />
      no_smgroup:<br />
      Pop $R2<br />
      Pop $R1<br />
      Pop $R0<br />
      FunctionEnd<br />
      <br />
      <br />
      # Uninstaller functions<br />
      Function un.onInit<br />
      ReadRegStr $INSTDIR HKLM "${REGKEY}" Path<br />
      ReadRegStr $StartMenuGroup HKLM "${REGKEY}" StartMenuGroup<br />
      !insertmacro SELECT_UNSECTION Main ${UNSEC0000}<br />
      FunctionEnd<br />
      <br />
      Function un.DeleteSMGroupShortcut<br />
      Exch $R1 ;NAME<br />
      Push $R2<br />
      StrCpy $R2 $StartMenuGroup 1<br />
      StrCmp $R2 "&gt;" no_smgroup<br />
      Delete /REBOOTOK "$SMPROGRAMS\$StartMenuGroup\$R1.lnk"<br />
      no_smgroup:<br />
      Pop $R2<br />
      Pop $R1<br />
      FunctionEnd</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">DrPeggs</span><br />
      <span class="post-time small text-muted">20th September 2007 12:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        You are probably using the same InstallDirRegKey for both
      </blockquote>ah, thanks for the quick response, i clearly don't understand that bit:<br />
      <br />
      InstallDirRegKey HKLM "${REGKEY}" Path<br />
      <br />
      Do i just make the HKLM bit different for both like:<br />
      <br />
      InstallDirRegKey MyApp_${VERSION} "${REGKEY}" Path<br />
      <br />
      <br />
      thanks again
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">20th September 2007 12:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You need to change this line in both scripts:<br />
      Name MyApp<br />
      <br />
      REGKEY is set to Software\$(^Name) which is Software\MyApp. Therefore as I expected, both your installers are saving their install directory path under the same registry key value.<br />
      <br />
      And HKLM is HKEY_LOCAL_MACHINE so leave that.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">DrPeggs</span><br />
      <span class="post-time small text-muted">20th September 2007 12:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">fantastic, many thanks fella</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
