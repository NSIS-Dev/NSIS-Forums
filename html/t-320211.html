<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="!packhdr and VMProtect packer"><title>!packhdr and VMProtect packer - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">!packhdr and VMProtect packer</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=320211">!packhdr and VMProtect packer</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">underline</span><br><span class="post-time small text-muted">24th June 2010 18:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>!packhdr and VMProtect packer</strong><br>Hello,<br><br>I try to pack the header of my NSIS script using !packhdr command and VMProtect protector (vmpsoft.com). The issue is that VMProtect is unable to replace the file to be protected with the protected file. If the file to be protected is "exeheader.tmp" then the protected file will be "exeheader.vmp.tmp".<br><br>__________________________________________<br>Command line version for VMProtect looks like:<br>(VMProtect_Con.exe is the command version file)<br><br>VMProtect_Con File Output file -ProjectFile -ScriptFile<br><br>File - the name of the executable file that should be protected (*.exe, *.dll, etc.) or the project file name (*.vmp). If a project file is specified as the source file, the name of the executable file will be taken from the project file.<br><br>Output file - the name and path to the protected file that should be created after the source file is processed. If the parameter is not specified, its value is taken from the project file.<br><br>Porject file - the name and path to the project file created in the ‘Expert’ mode mode. If the parameter is not specified, the folder with the executable file will be searched for in the project file (*.vmp).<br><br>Script file - the name of the file containing the script that will be used to process the protected file. If the parameter is not specified, the folder with the executable file will be searched for the script file (*.vms).<br>__________________________________________<br><br><br>Now if I try this:<br><br>!packhdr "$%TEMP%\exehead.tmp" '"${NSISDIR}\Packhdr\VMProtect_Con.exe" "$%TEMP%\exehead.tmp" "$%TEMP%\exehead.tmp" -exehead.tmp.vmp -exehead.tmp.vms "$%TEMP%\exehead.tmp"'<br><br><br>the installer header is not packed, but if I try this:<br><br>!packhdr "$%TEMP%\exehead.tmp" '"${NSISDIR}\Packhdr\VMProtect_Con.exe" "$%TEMP%\exehead.tmp" "$%TEMP%\exehead.tmp" -exehead.tmp.vmp -exehead.tmp.vms "$%TEMP%\exehead.vmp.tmp"'<br><br>and I check the TEMP folder then there I see that the installer header file "exehead.tmp" were corectly packed as "exehead.vmp.tmp" but ofcorse not applied to the installer exe.<br><br>Maybe the solution is to create a batch file or is there any way to use an packer that is unable to replace the file to be packed with the packed file as UPX do it?<br><br>Please let me have your suggestion or solution!<br><br>Thanks!!!</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">24th June 2010 20:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Just use a batch file.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">underline</span><br><span class="post-time small text-muted">24th June 2010 20:10 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks Afrow!<br><br>I did it and works and this also thanks to one of your old posts:<br><br><a href="http://nsis.sourceforge.net/Using_!packhdr" target="_blank">http://nsis.sourceforge.net/Using_!packhdr</a><br><br>Now I can see that even packed, I can still extract using an universal unpacker the script file (script.bin) with every installer command information. This universal unpacker can't extract VMProtect exe packed file but seems the NSIS exe header is not the area with install information and install settings which is exactly what I want to protect using this packer.<br><br>Any suggestion to protect my NSIS installer on same way to avoid unpacking of the file with the NSIS information and settings?<br><br>Thanks!</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">24th June 2010 20:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">This was asked a while back and you'd need to change the values of some constants in the source code and recompile NSIS (I forget which constants - probably in the lzma headers).<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">underline</span><br><span class="post-time small text-muted">24th June 2010 20:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I will be very interested to find out this post but don't know how to locate it. Any suggestion?<br><br>I don't use LZMA, I use /SOLID BZIP2 as can't be extracted with 7zip</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">24th June 2010 20:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Wait a minute, it IS the header that contains the script code. Are you sure VMProtect is working?<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">underline</span><br><span class="post-time small text-muted">24th June 2010 20:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I am sure that VMProtect is working because after protection the installer.exe size was increased with ~ 200k and also when I open installer.exe with an Hex Editor (HexWorkshop), I can see the VMProtect signature (VMP0 and VMP1) at the beginning of the installer.exe</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">24th June 2010 20:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Then perhaps it's not protecting well enough? The script code is definitely in the installer header.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">underline</span><br><span class="post-time small text-muted">24th June 2010 20:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hmm, I will try to switch some protection settings and see if the result is the same and also I will try AsProtect as an alternative and see if the same result then I will let you know.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">underline</span><br><span class="post-time small text-muted">24th June 2010 21:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Done it with AsProtect and I have the same result!<br><br>My batch file is together with the packer inside \NSIS\Packhdr and looks as below:<br><br><br>cd /d %~dp0<br><br>Move %1 exehead.tmp<br><br>ASProtect -process ASProtect1.aspr2<br><br>Move exehead.asp.tmp %1<br><br>del exehead.tmp<br><br><br>and inside nsisconf.nsh I have added next line:<br><br>!packhdr $%TEMP%\exehead.tmp `"${NSISDIR}\Packhdr\asp.bat" "$%TEMP%\exehead.tmp"`<br><br><br>and I can still extract the script file with main script commands and that is exactly what I want to avoid.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">underline</span><br><span class="post-time small text-muted">24th June 2010 21:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">After some tests I see that the exehead.tmp file which NSIS installer use it to pack is only 60k on size (not packed) but the script.bin file extracted with the Universal UnPacker is 120k on size so I think that the exe header is packed but not the very important NSIS information because if I look inside script.bin I can see the paths where NSIS extract the files, http links from where NSIS download updates, passwords for 7zip protected files and more... and those informations should be protected with the packer but don't know how to do it as seems that !packhdr don't do its job as expected...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">25th June 2010 10:53 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">There is no problems with !packhdr. UPX and Resource Hacker work just fine with it. What exactly are you using to read the script after packing?<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">underline</span><br><span class="post-time small text-muted">25th June 2010 11:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Resource Hacker is used only to remove first installer icon. This works.<br>UPX is very common packer and can be easy unprotected.<br><br>I sent you a private message with the name and link for the unpacker.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">25th June 2010 11:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Looking at the Universal Extractor forums the developer has asked for ASProtect samples so it looks like he could have cracked it?<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">underline</span><br><span class="post-time small text-muted">25th June 2010 12:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">AsProtect is an old protector but can't be cracked by this UnivExtractor! It is very hard to crack AsProtect and can be done only manually and not on all situations (depending on protection settings).<br><br>As a proof, If I pack any exe file even the NSIS installer exe with AsProtect and then I try to unpack it using the unprotector then the unpacking Failed so is not able to unpack any AsProtected file.<br><br>If I try the same with the NSIS installer with exe header packed using !packhdr then the extraction is completed.<br><br>This should be the proof that something is wrong with the !packhdr or maybe don't pack the full exe header and important information/settings are left not packed. This can explain why exehead.tmp is only 60k and when script.bin is extracted with UnivUnpacker that file is 120k. So the difference of 60k should be what !packhdr left behind unprotected?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">underline</span><br><span class="post-time small text-muted">25th June 2010 14:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I think that NSIS keep the installer instructions not protected and protect only exe header which don't have inside any installer instructions. If this is the situation then I will create an Function to obfuscate the installer instructions based to an unique hardcoded key so if the script.bin is extracted the installer instructions inside will be obfuscated and everything is protected without using a packer. I think that this is the real working solution and after some tests I see that this works.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br><span class="post-time small text-muted">25th June 2010 17:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">That's interesting. I guess I just assumed the script code was included in the overhead but perhaps not then. Best ask kichik about it.<br><br>For obfuscation would you mind telling us your solution? I think a lot of people have asked for the same thing in the past.<br><br>Stu</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">underline</span><br><span class="post-time small text-muted">25th June 2010 18:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I will try to understand where is the issue with !packhdr and how NSIS can be modified in order to fix that so I hope kichik will see this post and will come with an suggestion if any.<br><br>About obfuscation I will consider your suggestion when I will finish the function.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Animaether</span><br><span class="post-time small text-muted">25th June 2010 19:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Isn't obfuscation semi-moot? The extracted script file (I extract files with a total commander plug-in, but the script.bin is the same as with Universal Extractor; probably uses the same binary underneath the hood) contains a ton of binary data and, lastly, a bunch of strings. E.g.<br><br></p><pre>
<code><br>\NSISArray.dll LoggerCreated ExistsI LoggerExisted Push ý‚€\ #32770 ý€ 1016 0x1004 ýš€\System.dll 1024 Alloc *(i, i, i, i, i, i, i, i, i) i (0, 0, 0, 0, 0, r3, 1024) .r1 Call User32::SendMessageA(i, i, i, i) i (ý€€, 0x102D, ý‚€, r1) *ýƒ€(&amp;t1024 .r4) -8 ... 100% 15 Create folder:  D: ý†€<br> -&gt; Created Directory: ý†€<br> Output folder:  d: ý†€<br> -&gt; Created Directory (implicit):<br></code>
</pre><br>
      Which is all very fascinating, but in no way that -I- or a layman is going to be figure out just what it all means.<br>
      <br>
      Even if you grab up the old 7zip that decompiles it into a script file, you get things a la:<br>
      ( I can't even find the above strings in the result, so this is another section )<br>
      <pre>
<code><br>StrCpy $0 "614.4" -2<br>FileWrite 54 6055 0<br>Pop $0<br>CopyFiles 74 6098 1556<br>Execute 6141 1 1<br>Call 491<br>Pop $[56]<br>Push $0<br>StrCpy $0 "617.4" -2<br>FileWrite 54 6179 0<br>SerCtlColors 74 0 0<br></code>
</pre><br>
      <br>
      Which goes on and on and on... I guess I could encrypt the strings and use some IntOp bits and pieces to decrypt them at run-time if I really felt like even the above information is too revealing<br>
      But obfuscating the source script code (e.g. through defines) would only really have any use if I were sharing the script file (perhaps a header) that I want people to be able to !include... yet not be able to read easily. Otherwise, somebody's just going to go through the trouble of disassembling the binary and try to turn it into some form of script such as the above ( with 'SerCtrlColors' and more ).<br>
      <br>
      And if somebody is -that- interested in trying to figure out what your scripting does, then no obfuscation is going to help anyway. I daresay that somebody who wants to go through that trouble will probably happily look up asprotect removal instructions and put those to work, too.<br>
      <br>
      Finally.. if what you are trying to protect is not so much the installer, but the program you are installing, then the installer is the wrong place for any protection whatsoever.<br>
      clean VM + a successful install = everything a person needs to copy your software, presuming it is generic for all people installing it.
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">underline</span><br>
      <span class="post-time small text-muted">25th June 2010 19:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What I need to protect is not the files inside the NSIS installer, is the installer binary where install instructions can be easy readed and on some cases we don't like end user to see that our installer use x resources and install on y folder and use z password or any http link used for updates. Obfuscation make those information invisible in the installer binary and without a proper key used for obfscation there is no chance to restore those information and this without use any packer as I just see the exe header packing is not a solution. I will just obfuscate NSIS installer instructions visible inside the binary file and this is enough as the files inside are already protected before add them to the installer.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Animaether</span><br>
      <span class="post-time small text-muted">25th June 2010 19:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">That's my point, though... anybody with a mere modicum of interest in finding out what your installer does may fire up e.g. filemon to see what files you're working with, regmon to check for any registry key values you might be setting, tcpmon to monitor network connections, some other tool to see exactly what is inside the TCP packets, etc.<br>
      <br>
      I'm not saying it's -entirely- pointless - just saying: is it worth the effort?<br>
      If for you the answer is 'yes', then you should certainly proceed :)</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">underline</span><br>
      <span class="post-time small text-muted">25th June 2010 19:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">you're right but the main intention is to obfuscate password used to encrypt some files inside the script and some of the tools you talk about can be detected and rejected with an incompatibility mode function...</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">underline</span><br>
      <span class="post-time small text-muted">25th June 2010 20:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by Animaether</small><br>
        That's my point, though... anybody with a mere modicum of interest in finding out what your installer does may fire up e.g. filemon to see what files you're working with, regmon to check for any registry key values you might be setting, tcpmon to monitor network connections, some other tool to see exactly what is inside the TCP packets, etc.<br>
        <br>
        I'm not saying it's -entirely- pointless - just saying: is it worth the effort?<br>
        If for you the answer is 'yes', then you should certainly proceed :)
      </blockquote>With other words:<br>
      <br>
      filemon - can see the files but if are packed/protected user can't analyze them<br>
      regmon - can see registry but don't help very much if the detected files are packed<br>
      tcpmon - upload/download files are also packed/crypted or password protected<br>
      <br>
      If together with all those methods the exe header is obfuscated then is very hard for the end user to understand and analyze the script. Please correct me if I am wrong.
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Animaether</span><br>
      <span class="post-time small text-muted">25th June 2010 21:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">My notes with regard to filemon, regmon, tcpmon were with how your installer operates and its end-result (installed files / an application) and how obfuscating your installer itself is moot if the end-result is what you're trying to protect.<br>
      <br>
      As an example.. let's say I have a very simple script and a file that it installs, file_A.txt, that contains some information.. say "Hello World".<br>
      <br>
      You know that users can extract the files with utilities out there, so you encrypt the file (becomes "Hsa0hUq-skq") using a key that you do -not- store anywhere in the installer (so you don't have to worry about obfuscating/etc. either), and store its original CRC/MD5/whathaveyou.<br>
      <br>
      Now your installer asks the user for the installation key. The user enters the key, the installer decrypts the file, and checks its CRC to make sure the user entered the correct key before continuing with further decryption of other files. Note that any hacker can then try whatever other key they like and force the installer to believe the CRC is correct to let the installer continue, but all of the decrypted files are going to be corrupt as the key was incorrect (result "iaQ-1jUbq9z") unless they happen to guess right.<br>
      <br>
      Now here is the problem in the above: at the end of the installation, if the correct key was entered, file_A.txt is going to have "Hello World" just fine.<br>
      <br>
      filemon.exe is going to see the file_A.txt write-out, and if I'm interested in your files, I'll just grab it from there. Now presume I'm somebody with ill will, and the key you gave me is going on some popular forum the same night.<br>
      <br>
      So what did the encryption in the installer accomplish in this case? Not a whole lot.<br>
      <br>
      So you'd have to combine that with machine-specific details to combine the key the user should enter with those details in order to get the correct key. Of course that means you now need remote authorization (i.e. connect to the internet).<br>
      But even that is moot because instead of handing out the key.. why would an ill-willed person not just take file_A.txt, with the correctly decrypted "Hello World", and upload that to such a forum?<br>
      <br>
      That's what I meant by the installer not being the correct place for protection of a product you're installing; by its very nature, an installer is ill-suited for it.<br>
      <br>
      <br>
      <br>
      If you're trying to protect the installer itself, that's another matter entirely, where obfuscation and encryption of the strings can go a long way to at least stop some random joe from grabbing UE or the old 7zip and having a peek at the installer's code (which, again, comes out pretty ugly as it is).. but it won't do a whole lot for that which it installs.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">underline</span><br>
      <span class="post-time small text-muted">25th June 2010 21:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Very interesting point of view and complete description! Thanks!<br>
      <br>
      I will take it into consideration.</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>