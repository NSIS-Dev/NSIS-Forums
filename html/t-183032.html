<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Hex Editing during install?" />

  <title>Hex Editing during install? - NSIS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Hex Editing during install?</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=183032">Hex Editing during install?</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Pyrii</span><br />
      <span class="post-time small text-muted">11th June 2004 20:16 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Hex Editing during install?</strong><br />
      I was sure of a function in NSIS that could edit bytes withing binary files, but I'm at a loss, either I'm reading the documentation too fast and missed something. Or it needs special scripting. Basically, what I'm trying to do is make an installer for a edited version of a file, we do all sorts to Game EXEs, from allowing multiple windows, skipping certain annoying checks, reading data from different sources. I wanted to allow the installer to be able to give the user the choice of which features they wanted for once, rather than get an EXE with ALL the different "hacks". Our work is done in Hexadecimal, Offsets and data. I want a script where I can provide the offset and hexidecimal data to be written (Anything from one byte (00 - FF) to hundreds of bytes long.<br />
      <br />
      Gomen if this is alot to ask, if there is such a function and I missed it, then please point me in the right direction, and sorry for being a n00b =P I'm not much of a programmer. Just the only "File Editing" functions seem to be only ASCII Based (txt and ini files).<br />
      <br />
      All help apreciated.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">deguix</span><br />
      <span class="post-time small text-muted">11th June 2004 22:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Yes, all that is possible. (Remember that hexadecimal numbers inside NSIS are identified by the "0x" before the number. i.e.: 0xFF)<br />
      <br />
      You can use <i>FileOpen</i> to open the file (use "a" openmode), <i>FileSeek</i> to go where you want in the file<i>FileWrite</i> or <i>FileWriteByte</i> to write where you chose and <i>FileClose</i> to close the file. All instructions on how to use them are found on the documentation.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">John P.</span><br />
      <span class="post-time small text-muted">13th June 2004 16:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi.<br />
      <br />
      I'm in a similar situation as Pyrii, and I'd like some help.<br />
      <br />
      I have searched the forums and the FAQ and example files and such, and have found some things I can use I think. The problem is I'm not a coder, and I'm just too thick to get into my head exactly <i>what</i> to write in my installer script to make it work.<br />
      (sorry - this is not an attempt at "hijacking" the thread, I just thought that since a thread with such a similar problem was already posted, I would reply here instead of making a new thread)<br />
      <br />
      OK, here's the deal:<br />
      <br />
      There is a game that I have made some high resolution textures for. Luckily for me, this game is very easy to customize. All I have to do to make the game use my higher res textures, is to hex edit some game files, so that the game doesn't find the original texture names inside those files.<br />
      The game will then automatically look for the texture name in a DynamicallyLoaded folder, and if it finds a texture there with the same name as the file it missed inside the game file, it will use that texture in place of the original, even though the new texture is of a higher resolution.<br />
      <br />
      Now - that's all well and good. But I can't very well tell people who download my textures that they have to hex edit these game files one by one, editing sometimes multiple strings inside them.<br />
      So after some head scratching, I finally had an "aha!!" moment, and figured the most obvious answer would be to batch hex edit these files.<br />
      <br />
      And I actually made installers that does this, and they work. So everyone should be happy, right?<br />
      <br />
      Well - it turns out that I did this in the most clumsy and awkward way. What my installers are currently doing, is to extract a folder with a hex editor inside it, then run a .bat file that runs a script for that hex editor, so that it batch hex edits the game files. When it's done, it deletes the hex editing tool's folder. On uninstall, the hex editor in it's folder is again extracted, and an UNDO script is run(basically reversing what the install did).<br />
      <br />
      *phew*<br />
      <br />
      But then I thought that it would be much better if I could somehow make my installer run the hex editor from inside, instead of exctracting it and then running it.<br />
      <br />
      And so I came here, looking for an answer.<br />
      <br />
      And from your posts in this thread, it looks like my NSIS installer will be able to hex edit the files in question <i>without</i> the need for an external hex editor.<br />
      Which is great news.<br />
      <br />
      But now I need to get an example of how exactly to make this work. I think I have found the examples, it's just that I have no idea what to put in place of the <b>file_handle</b>, <b>user_var</b>, and other such function examples. Again, I'm no coder.<br />
      <br />
      What I have gathered so far, is that I could perhaps use <b>FileOpen</b>, <b>FileSeek</b>, <b>FileWrite</b>, and <b>FileClose</b>. I just don't get <b>how</b>.<br />
      <br />
      <br />
      The files I want to open(hex edit), are called: <b>Kernel_GFXALL.ibt</b> and <b>MainMenu_GFXALL.ibt</b>.<br />
      <br />
      I need my installer to search through them one at a time, for the same file names, and change them. As an example, one file name inside the .ibt files would be <b>swooshc01</b>, and I want to rename it so that it's called <b>bwooshc01</b>.<br />
      <br />
      Likewise, I want the other file names I need to change to have their first letter changed to a 'b'.<br />
      <br />
      This has to be done in both of the .ibt files(maybe a lot more of them later on, but for now it's those two).<br />
      <br />
      So in essense; I need to open a file(the .ibt), find a specific string[where the texture name is](how do I find the "name" of the string, btw? Line number?), change a letter(or hex number) in that string, search for the next string with a given texture name, change a letter in <i>that</i> string, and so on, then save the altered .ibt file.<br />
      And it needs to do this for both of the files.<br />
      <br />
      Could someone please give me an example of a script that would do this?<br />
      <br />
      I need to be spoon fed! :hang:<br />
      <br />
      I'm not asking you to do it all for me, I just need it explained in simple terms. I got my installer working this far because I found examples by searching these forums that I could use by pretty much just replace the names in the example with my own, plus some trial and error.<br />
      <br />
      Thanks in advance. :)<br />
      <br />
      <br />
      PS: Sorry about the long post, just thought I'd try to explain exactly what I need and why.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">John P.</span><br />
      <span class="post-time small text-muted">13th June 2004 23:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">OK.<br />
      <br />
      I have tried to get my head around my problem, and read a lot of example files and the NSIS Scripting Reference, and I can now make a script that will actually successfully make an .exe that will hex edit the files in question.<br />
      <br />
      But...<br />
      <br />
      The way I have to do it, seems to be that I have to find the placement of the first byte in the name I wish to alter, and write that exact address in the FileSeek part of the script. When I do that, the resulting .exe file does successfully overwrite the string that I specified inside the .ibt file.<br />
      <br />
      But it's just sooo exhausting having to open a hex editor to find the exact placement of each and every filename inside the .ibt file...<br />
      <br />
      Not to mention that even though it's the same file names in the two(or more) .ibt files, they are not placed at the same address in both files, so I'll have to go through the same tedious work for all the .ibt files I wish to change...<br />
      <br />
      The external hex editor I'm currently using with my installers(xvi32), has a nifty script where I just have to tell it to REPLACEALLASC, which means it will search for and replace all occurances of an ASCII string to what I specify.<br />
      <br />
      Is that possible to do with NSIS?<br />
      -Just tell it to search for a string(ASCII name or hex string), then make it change all the entries it finds to what I have specified?<br />
      Instead of the tedious work of having to find each and every address manually?<br />
      <br />
      Below is a very short example of what I currently have.<br />
      This will of course be much bigger when it covers all the filenames, and it will also be just a small part of the rest of my installers, this is just to show what I've got so far when it comes to hex editing the files in question.<br />
      <br />
      The "bwooshc01" is the name I'm replacing the original with, and 37669 is the address of the first byte in 'swooshc01', which is the word I want to overwrite:<br />
      <br />
      <br /></p>
      <pre>
<code><br />Name "TEST"<br />OutFile "TEST.exe"<br /><br />Section ""<br />FileOpen $2 "$DESKTOP\New installer TEST\Kernel_GFXALL.ibt" a<br />FileSeek $2 37669 SET<br />FileWrite $2 "bwooshc01" <br />FileClose $2<br />SectionEnd</code>
</pre><br />
      <br />
      <br />
      Thanks.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br />
      <span class="post-time small text-muted">13th June 2004 23:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You can use NSIS commands to search for data, there are some examples available in the NSIS Archive.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">John P.</span><br />
      <span class="post-time small text-muted">14th June 2004 14:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well, I've been reading 'till my eyes bleed, but I can't seem to find exactly what I want.<br />
      <br />
      Most of the 'replace string' scripts are for .txt files it seems, and they create and delete a temp file, which I don't want.<br />
      <br />
      I just want to search a binary file for all occurances of a word, then convert all the instances of that word to some other word that I specify. That's all. If I could write that word in ASCII, that would be great.<br />
      <br />
      I found a script that is made for doing just that, but it's for editing a .txt file as far as I can gather.<br />
      <br />
      Since I don't want it to create a temp file, but rather that it should just write directly to the file in question, I tried to edit the script to do only what I need.<br />
      <br />
      It does compile alright, but the resulting .exe doesn't do anything to the binary file (.ibt), as far as I can tell. It sure doesn't do what I want it to do, at least.<br />
      <br />
      So could someone at least tell me why this script doesn't do anything to the binary file?<br />
      Can I use this script at all?<br />
      Do I need to write the words out in hex? (they are there as text as well in the file)<br />
      And where does he get the '0' and '+3' numbers from, and should I use different numbers there for my script?<br />
      <br />
      <b>My version:</b><br />
      <br /></p>
      <pre>
<code><br />Name "TEST"<br />OutFile "TEST.exe"<br /><br />Section<br />ClearErrors<br />FileOpen $0 "$DESKTOP\New installer TEST\Kernel_GFXALL.ibt" "a"<br />loop:<br />   FileRead $0 $2<br />   IfErrors done<br />   StrCmp $2 "swooshc01" 0 +3<br />      FileWrite $0 "bwooshc01"<br />      Goto loop<br />   StrCmp $2 "swooshc01" 0 +3<br />      FileWrite $0 "bwooshc01"<br />      Goto loop<br />   FileWrite $0 $2<br />   Goto loop<br /><br />done:<br />   FileClose $0<br />   SectionEnd<br />   </code>
</pre><br />
      <br />
      <b>Original version:</b><br />
      <pre>
<code><br />ClearErrors<br />FileOpen $0 "file.txt" "r"<br />GetTempFileName $R0<br />FileOpen $1 $R0 "w"<br />loop:<br />   FileRead $0 $2<br />   IfErrors done<br />   StrCmp $2 "line to replace$\r$\n" 0 +3<br />      FileWrite $1 "replacement of line$\r$\n"<br />      Goto loop<br />   StrCmp $2 "line to replace" 0 +3<br />      FileWrite $1 "replacement of line"<br />      Goto loop<br />   FileWrite $1 $2<br />   Goto loop<br /><br />done:<br />   FileClose $0<br />   FileClose $1<br />   Delete "file.txt"<br />   CopyFiles /SILENT $R0 "file.txt"<br />   Delete $R0<br /></code>
</pre><br />
      <br />
      <br />
      I have tried some other scripts as well, but even though I get them to compile, they don't do anything either.<br />
      <br />
      The only script I've got working, is the one I posted in my previous post, but that's just a way too exhausting method of doing this.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">iceman_k</span><br />
      <span class="post-time small text-muted">14th June 2004 14:54 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If I were you, I would continue using the external hex editor instead of twisting myself in knots trying to do it by scripting.<br />
      The only thing I would change is to extract the hex editor and the batch file to the $PLUGINS directory. That way it gets automatically deleted when the installer closes.<br />
      Even better, instead of trying to script the binary search &amp; replace, you could write it as a plugin using C or Delphi. That way you may end up with a smaller installer as well.<br />
      I am pretty sure there is plenty of C code out there to do binary search &amp; replace.<br />
      Just my $0.02...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">John P.</span><br />
      <span class="post-time small text-muted">14th June 2004 15:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">OK, thanks for the reply.<br />
      <br />
      It <i>does</i> seem to be simpler to use the external hex editor, and it's working 'perfectly' already.<br />
      <br />
      The only reason I was trying to make the installer do the job itself, was to 1) have a smaller .exe, 2) not have to extract and delete a MB at the user's computer. Not that it matters much, I just thought that after umpteen installs of several of my installers, that the write/delete process would make it necessary to defragment their drive.<br />
      Hardly a big problem though. Kinda stupid even when I think about it more.<br />
      <br />
      I'll certainly look into using the $PLUGINS directory and maybe even try to make a plugin though.<br />
      <br />
      [edit]-Is the $PLUGINS directory a Windows specific one, or is it the NSIS plugins folder, or does it not matter? 'Cause my "clients" most likely don't have NSIS installed.[/edit]<br />
      <br />
      Heh - by the time I'm done with all this, I'm probably a somewhat decent coder, which is a nice side effect. ;)<br />
      <br />
      Anyway - thanks for the help. :)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">iceman_k</span><br />
      <span class="post-time small text-muted">14th June 2004 16:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Here's a small fast search &amp; replace utility- only 24 kb.<br />
      <a href="http://wcarchive.cdrom.com/pub/simtelnet/msdos/txtutl/gsar110.zip" target="_blank">General Search And Replace</a> .<br />
      You can either use it as is or convert it to a plugin.<br />
      It claims to be blindingly fast.<br />
      It is GPL'ed freeware so you should be able to use the source code for the plugin as long as you keep it GPL'ed.<br />
      The $PLUGINS directory is a temporary folder created by the installer when it runs, into which it extracts temporary files you may need.<br />
      It can be initialized using the InitPluginsDir command- usually in the .onInit function.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">John P.</span><br />
      <span class="post-time small text-muted">14th June 2004 18:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thank you again. This could be of invaluable help. :)</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
