<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="ExecWait as user"><title>ExecWait as user - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">ExecWait as user</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=357090">ExecWait as user</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">azureusvuze</span><br><span class="post-time small text-muted">10th March 2013 09:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>ExecWait as user</strong><br>Anyone have plugin which can ExecWait as user privileges?<br><br>Usually i used:<br>Push "$EXEDIR\${APPDIR}\${APPEXE}"<br>Push "open"<br>Push '${APPSWITCH} $0'<br>StdUtils::ExecShellAsUser /NOUNLOAD<br>FindProcDLL::WaitProcEnd "${APPEXE}" -1</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">10th March 2013 15:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">If you need to run a application as the user (other than the finish checkbox) you are probably doing something wrong...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">10th March 2013 22:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">What you want is <b>not</b> possible the way "ExecShellAsUser" works. The implementation of ExecShellAsUser in the StdUtils plug-in is based on the <a href="http://msdn.microsoft.com/de-de/library/windows/desktop/bb774138%28v=vs.85%29.aspx" target="_blank">IShellDispatch2</a> COM interface. And if you look at the <a href="http://msdn.microsoft.com/de-de/library/windows/desktop/bb774148%28v=vs.85%29.aspx" target="_blank">ShellExecute</a> function, you'll see it is rather limited, compared to the "native" <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/bb762154%28v=vs.85%29.aspx" target="_blank">ShellExecuteEx</a> function. It does NOT return a handle we could use for waiting. Can you explain what exactly your use-case is?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">azureusvuze</span><br><span class="post-time small text-muted">16th March 2013 07:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by LoRd_MuldeR</small><br>What you want is <b>not</b> possible the way "ExecShellAsUser" works. The implementation of ExecShellAsUser in the StdUtils plug-in is based on the <a href="http://msdn.microsoft.com/de-de/library/windows/desktop/bb774138%28v=vs.85%29.aspx" target="_blank">IShellDispatch2</a> COM interface. And if you look at the <a href="http://msdn.microsoft.com/de-de/library/windows/desktop/bb774148%28v=vs.85%29.aspx" target="_blank">ShellExecute</a> function, you'll see it is rather limited, compared to the "native" <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/bb762154%28v=vs.85%29.aspx" target="_blank">ShellExecuteEx</a> function. It does NOT return a handle we could use for waiting. Can you explain what exactly your use-case is?</blockquote>Installer is executed as administrator privileges, but will execwait app.exe as user privileges.<br>Is this possible?</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">MSG</span><br><span class="post-time small text-muted">16th March 2013 10:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by azureusvuze</small><br>Installer is executed as administrator privileges, but will execwait app.exe as user privileges.<br>Is this possible?</blockquote>This is possible with the UAC plugin, but it's not easy. But like Anders said, if you need this, you are probably doing things in a very broken way. Reconsider your approach carefully, you are most probably trying to make an application that is not Windows compatible.</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">16th March 2013 14:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by azureusvuze</small><br>Installer is executed as administrator privileges, but will execwait app.exe as user privileges.<br>Is this possible?</blockquote>Again: What exactly are you trying to do? Usually there is only one use-case to run applications with user-privileges from an elevated installer: You are done installing and now want to launch the app you've just installed. But you don't want that app to run elevated. In that case, you don't need to wait for that app, of course... Why do you need to wait for the app <i>and</i> need it to run with user-privileges?</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">azureusvuze</span><br><span class="post-time small text-muted">17th March 2013 07:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by LoRd_MuldeR</small><br>Again: What exactly are you trying to do? Usually there is only one use-case to run applications with user-privileges from an elevated installer: You are done installing and now want to launch the app you've just installed. But you don't want that app to run elevated. In that case, you don't need to wait for that app, of course... Why do you need to wait for the app <i>and</i> need it to run with user-privileges?</blockquote>I try to make portable app launcher like portableapps.com, launcher need to be run as administrator to backup and restore registry, but target need to be run as user privileges.<br><br>Like this:<br>registry::_DeleteKey /NOUNLOAD "${_REGKEY}-BackupBy${APP}Portable"<br>registry::_MoveKey /NOUNLOAD "${_REGKEY}" "${_REGKEY}-BackupBy${APP}Portable"<br><br>ExecWait app.exe<br><br>registry::_DeleteKey /NOUNLOAD "${_REGKEY}"<br>registry::_MoveKey /NOUNLOAD "${_REGKEY}-BackupBy${APP}Portable" "${_REGKEY}"</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">17th March 2013 13:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">So, do I get this right? You have an application that is not "portable", but you try to <i>pretend</i> it is portable by silently installing (i.e. setting up registry keys and stuff) the application right before its launched and again silently uninstalling the application after it has terminated?<br><br>I guess the only way to achieve that currently is what MSG has suggested already: Use the UAC plug-in. But even more important: Instead of inventing ugly workarounds, why not make your application "portable" right away, so these workarounds are not needed any longer ???</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Highcoder</span><br><span class="post-time small text-muted">17th March 2013 14:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I think its because "his" app is not his app. ;)<br>And the most of all programs that are designed to be installed normally need this keys to run.<br>But these apps are not portable with this workaround.<br>Portable means you can run this app on every (windows)machine without adminrights an installing.<br>Your thing is not portable at all because you need adminrights for your "launcher" to set the necessary keys.<br><br>But the most people use "Portable" Apps because they have no mess on their PC caused by bad uninstall routines that doesn't clean up and left a lot of files an regkeys.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">LoRd_MuldeR</span><br><span class="post-time small text-muted">17th March 2013 17:52 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><small>Originally posted by Highcoder</small><br>I think its because "his" app is not his app. ;)</blockquote>Then there are two possibilities: The app that is not "his" is OpenSource/FreeSoftware and thus can be "fixed" to be portable. In that case we don't need the workarounds. Or that app is <i>proprietary</i>, in which case he might not even be allowed to redistribute it! Only real case I see is, when the app is proprietary but still allows redistribution under a Freeware license (and also explicitly allows repackaging). And, in that particular case, I would still try to contact the developer can get him convinced to release a "real" portable version, first...<br><br>If nothing else helps and if also the UAC plug-in method isn't acceptable, he could also do this: Create a "base" (wrapper) installer that explicitly runs with user privileges. In that installer, include two more installers that will run with admin privileges: One to prepare starting the app and one for cleaning up afterwards. Then he could do something like:<br><br><pre>
<code>ExeShell '"$PLUGINSDIR\prepare-installer.exe"'<br>ExecWait '"$PLUGINSDIR\the-not-so-portable-app.exe"'<br>ExeShell '"$PLUGINSDIR\cleanup-installer.exe"'</code>
</pre><br>
      <br>
      Only drawback: User will have to accept an UAC dialog twice...
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">azureusvuze</span><br>
      <span class="post-time small text-muted">19th March 2013 06:23 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by LoRd_MuldeR</small><br>
        Then there are two possibilities: The app that is not "his" is OpenSource/FreeSoftware and thus can be "fixed" to be portable. In that case we don't need the workarounds. Or that app is <i>proprietary</i>, in which case he might not even be allowed to redistribute it! Only real case I see is, when the app is proprietary but still allows redistribution under a Freeware license (and also explicitly allows repackaging). And, in that particular case, I would still try to contact the developer can get him convinced to release a "real" portable version, first...<br>
        <br>
        If nothing else helps and if also the UAC plug-in method isn't acceptable, he could also do this: Create a "base" (wrapper) installer that explicitly runs with user privileges. In that installer, include two more installers that will run with admin privileges: One to prepare starting the app and one for cleaning up afterwards. Then he could do something like:<br>
        <br>
        <pre>
<code>ExeShell '"$PLUGINSDIR\prepare-installer.exe"'<br>ExecWait '"$PLUGINSDIR\the-not-so-portable-app.exe"'<br>ExeShell '"$PLUGINSDIR\cleanup-installer.exe"'</code>
</pre><br>
        <br>
        Only drawback: User will have to accept an UAC dialog twice...
      </blockquote>Too many exe to be run.<br>
      I'll back using StdUtils and FindProcDLL (mod by hnedka).<br>
      <br>
      Thanks for your answer.
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>