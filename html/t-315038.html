<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="exdll plugin made with MSVC9 does not work on W98"><title>exdll plugin made with MSVC9 does not work on W98 - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">exdll plugin made with MSVC9 does not work on W98</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=315038">exdll plugin made with MSVC9 does not work on W98</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">davo123</span><br><span class="post-time small text-muted">2nd December 2009 07:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>exdll plugin made with MSVC9 does not work on W98</strong><br>I have been using a simple plug-in DLL with NSIS for years. It displays a simple dialog box, accepts passwords, makes some checks on registry entries (plus some other 'magic'). If I compile the DLL using MSVC5 (1997) the installation program works on all Windows OS including W98 and even W95. But if I re-compile the DLL using the upgraded (sic) MSVC9 (2008) the installation program will not work on W98.<br><br>I've searched google and tried every phrase I can think of in the WinAmp search options.<br><br>I can make DLLs and executables using MSVC9 that work perfectly OK on W98. I have set the compiler not to use Unicode, use the /MT option so it doesn't require the C run time, even fixed the DLL executable with Legacy Extender so it fixes the MSVC9 "feature" that stops executables working on W95 variants. These settings will make an executable that works on W98. But if I incorporate the DLL into a NSIS installer, it locks up the W98 system as soon as any call is made using *any* MyDLL::MyFunc-style command, with or without a dialog. The plug-in DLL is made using the proper exdll.c/h files provided. I have NSIS 2.38.<br><br>Anyone else had this problem on W98 or know the correct settings for MSVC9? I know I could use another compiler, but I'd like to make this work with MSVC9, if possible.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">2nd December 2009 10:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Have you tried running dumpbin.exe on the DLL and looking for anything funny? Probably one of the /RTC options need to be disabled, or just all of them with <a href="http://msdn.microsoft.com/en-us/library/hddybs7t%28VS.71%29.aspx" target="_blank">/GZ-</a>.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">davo123</span><br><span class="post-time small text-muted">2nd December 2009 10:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I've used CFF Explorer and there's nothing obviously amiss. I write many DLLs using MSVC9 that work very well on W98. I'd like to think I know all the settings and fixes to do. It's the distribution of these programs to end users on W98 that worries me.<br><br>Since writing the first post, I've done some more tests using the provided exdll.c/h files and a simple test script:<br><br>Name "Test exdll plug in"<br>!addplugindir "."<br>outfile testexdll.exe<br>Section Test<br>StrCpy $0 "Hello world"<br>DetailPrint "About to call myFunction: $0"<br>exdll::myFunction<br>SectionEnd<br><br>1. If I compile exdll.dll (using simpler, old 2003 versions of the source code) using MSVC5, it will work OK on W98.<br><br>2. If I compile exdll.dll using Pelles C, it will work but then give me a GPF error before exiting.<br><br>3. If I compile using MSVC9 without using Legacy Extender, it gives an error message that the DLL could not be loaded.<br><br>4. If I use Legacy Extender on exdll.dll, it hangs in W98 immediately the first call is made to exdll:MyFunction.<br><br>Then I downloaded the latest version of NSIS (2.45). This includes an MSVC2008 (=MSVC9) project file (but oh joy, now we have to include a .lib file, so we can't even compile it on anything else -- not a clever move, guys!).<br><br>5. I compile the new exdll source using MSVC9, remake the script, but get the same error as in (3) above on W98.<br><br>6. If I recompile the test NSIS script using the original exdll.dll made in (1) using the latest NSIS, it works OK in W98.<br><br>I'd very much like to continue using NSIS to distribute my programs to end users who may well still be using W98. Our friends at MS do not seem to be making this easy. I know the world moves on, but there are still customers out there!</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">2nd December 2009 11:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">What does Dependency Walker say when profiling the loading process?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">davo123</span><br><span class="post-time small text-muted">2nd December 2009 22:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Solved it. And of course I was the culprit. There are *two* changes you have to make in MSVC9 to use Legacy Extender and I'd missed out one. Hence the system crash in W98. My punishment has been to waste the last 24 hours trying to fix it. They are setting up the flogging frame already.<br><br>Thanks to kichik for the suggestions and, of course, to the guys at NSIS for a great tool. Here's what I've learned to make sure it works on legacy W98 systems (and presumably W95 and WMe, too):<br><br>1. If you want to use a plug-in DLL with your installation then either:<br><br>(a) Compile the DLL with MSVC6 or earlier (don't know about MSVC7); or<br><br>(b) Compile with MSVC8 (VS2005+) or above but then use Cloanto's Legacy Extender to "fix" the DLL (<a href="http://www.legacyextender.com/" target="_blank">http://www.legacyextender.com/</a>)<br><br>2. Read their Project Configuration instructions properly! If you don't make the Legacy Extender fixes, you will just get a message that temp\xxx.DLL did not work.<br><br>3. The old 2003 exdll.c/h files still work perfectly well on all systems. You don't need to use the complications of pluginapi.lib, etc.<br><br>If anyone knows the settings to make a DLL compatible with both NSIS and W98 using Pelles C or MinGW, I'm sure we'd all be grateful to hear.</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>