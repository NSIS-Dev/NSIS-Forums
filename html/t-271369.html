<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Type &quot;x&quot; when installation is in progress."><title>Type "x" when installation is in progress. - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Type "x" when installation is in progress.</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=271369">Type "x" when installation is in progress.</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">DrDan</span><br><span class="post-time small text-muted">18th May 2007 15:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Type "x" when installation is in progress.</strong><br>The installer I am working on has a test case where pressing the "x" key on the keyboard must not interrupt the installation when all the files are being unpacked and deployed to their final destinations.<br><br>However, when I pressed "x" whilst testing, the installer becomes unresponsive. :(<br><br>It continued to have a task bar entry, but clicking that does not bring the installer to the foreground. Checking the task manager showed that the installer was still running and using CPU time, but I was not able to switch back to it. It does sometimes become visible again if I press the Windows key + "D" a couple of times, but the contents of the installer window is not updating.<br><br>Is there a way to disable this feature?<br><br>The only way to stop the installer is to kill the process using the Task Manager or other similar tool.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">18th May 2007 15:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I can't reproduce this. Please include more details. Which version of NSIS? What exactly is the installer doing when you press the X button? Is it the keyboard X button or the close button on the top right corner of the window?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">DrDan</span><br><span class="post-time small text-muted">18th May 2007 16:22 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I am using NSIS 2.26 (large string version). I am running Windows 2000 SP4.<br><br>As I said in the original posting, you press the "x" key on the keyboard - between "z" and "c" on a UK keyboard. I am not referring to the "x" button at the top-right of the window. This happens when the installer is on the MUI_PAGE_INSTFILES page.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">18th May 2007 16:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Still can't reproduce this. Upgrade to 2.27 and provide a minimal script that displays this problem. If you can't provide a script, list the plug-ins that you use and any other detail that might be relevant. Also try reproducing it yourself on other computers.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">DrDan</span><br><span class="post-time small text-muted">21st May 2007 10:41 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Example installer...</strong><br>I have created an example installer script. The script for it is included in the attached zip file.<br><br>The installer has 4 sections, and each section basically sleeps for one second allowing time for the user to press the "x" key. DetailPrint'ed instructions on when to press "x" are displayed.<br><br>This test installer does not perform any installation actions.<br><br>I have confirmed with a colleague that the installer also dies on his computer when they press x during install time.<br><br>Just to summarise again, I am using<br><br>NSIS 2.26 (large string version)<br>Windows 2000 Service Pack 4</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">onad</span><br><span class="post-time small text-muted">21st May 2007 12:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Whatever the issue is, please first use NSIS 2.27 not NSIS 2.26.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">onad</span><br><span class="post-time small text-muted">21st May 2007 12:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Can't reproduce the defect you decribe compiled you example using 2.27 on Vista Ultimate. Installer just runs fine.<br><br>As I understand you want people to be able to cancel the installer? Why not have last custom page the with a button and text, like "Oeps, no it did not want to install, please uninstall"?<br><br>Note that sleep lets the installer sleep, i.e. the installer application unable to do anything. Maybe create a loop if you want to do certain other actions.<br><br>I do still not see what it is you really want to accomplish.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">DrDan</span><br><span class="post-time small text-muted">21st May 2007 13:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>NSIS 2.27 does not help</strong><br>I have the same problem with NSIS 2.27 (large string version).<br><br>Onad: I do not want people to be able to cancel the install.<br><br>The point is that pressing "x" crashes my installer. Why does this happen?<br><br>Did you press the "x" on the keyboard when the example installer instructed you to? I do not use the sleep command in my real installer. I had to use it for this demonstration to simulate a large number of files being unpacked.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">demiller9</span><br><span class="post-time small text-muted">21st May 2007 14:09 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>unable to reproduce...</strong><br>I compiled the sample script on NSIS 2.25 and ran it on XP sp2. The X key gave me the 'default beep' each time I pressed it, but the script completed normally.<br><br>I'll try this again at work where I have Win2K<br><br>Don<br><br><b>Edit:</b> Originally I wrote that I compiled this on NSIS 2.26.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">{_trueparuex^}</span><br><span class="post-time small text-muted">21st May 2007 14:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I can reproduce this with the example on Windows 2000 SP4, but not on Windows XP SP2... Wierd. This has "Windows api bug" written all over it. :D<br><br>Edit: And I used "normal" NSIS v2.27</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">DrDan</span><br><span class="post-time small text-muted">21st May 2007 15:35 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks {_trueparuex^}!! At last someone else who can reproduce this :-) I started to think that I had gone insane!!!!! ;)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">demiller9</span><br><span class="post-time small text-muted">21st May 2007 16:17 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>reproduced again (Win2k, NSIS 2.23)</strong><br>The CPU goes to full usage (50% on a dual processor) when I typed X. I'll try to attach the debugger and see what is happening.<br><br>Don<br><font size="1">Edit: Debugging didn't show me much. The system appears to be looping inside USER32.dll, in the function SendMessageA</font></p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">DrDan</span><br><span class="post-time small text-muted">23rd May 2007 10:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>What happens next?</strong><br>Are there any moves to resolve this issues? Does a bug need to be raised? Is there any idea on the time to get a fix for this problem?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">23rd May 2007 14:15 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I can reproduce it as well on Windows 2000 SP4. If you say it didn't happen with 2.25, it must be related to the disabling of the X button on the top right corner of the window when the Cancel button is disabled. I don't get how the `X` button on the keyboard is related as nothing in NSIS cares for anything on the keyboard but the space bar on the components page.<br><br>It'll take some debugging time and it's not the top priority right now. Any more details would be helpful. And yes, a bug report should be submitted.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">demiller9</span><br><span class="post-time small text-muted">23rd May 2007 18:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I reported above that it was reproduced on NSIS 2.23 and Win2k SP4, it wouldn't be related to the cancel button in that case.<br><br>Don</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">23rd May 2007 19:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Even stranger...</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">2nd June 2007 18:19 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Re: reproduced again (Win2k, NSIS 2.23)</strong><br></p><blockquote><i>Originally posted by demiller9</i><br><b>Edit: Debugging didn't show me much. The system appears to be looping inside USER32.dll, in the function SendMessageA</b></blockquote>It responds to any key pressed with a very nice endless loop in USER32!xxxGNM_FindNextMnem. It seems to have a loop around USER32!_NextControl which keeps returning more controls. When it gets to the last control, it goes back to the first one again.<br><br>And the stack trace...<pre>
<code>be415c9c 8046950e nt!RtlpBreakWithStatusInstruction<br>be415c9c a003bced nt!KeUpdateSystemTime+0x13e<br>be415d3c a003bd84 win32k!InternalVkKeyScanEx+0x5c<br>be415d50 80465691 win32k!NtUserVkKeyScanEx+0x4b<br>be415d50 77e14e36 nt!KiSystemService+0xc4<br>0012fac4 77e304d6 USER32!NtUserVkKeyScanEx+0xb<br>0012fcf0 77e302ac USER32!xxxGNM_FindNextMnem+0xf6<br>0012fd18 77e17cf4 USER32!xxxGotoNextMnem+0x24<br>0012fd44 77e1cbd9 USER32!IsDialogMessageW+0x22a<br>0012fd80 77e1ca62 USER32!DialogBox2+0x14e<br>0012fda4 77e1cd18 USER32!InternalDialogBox+0xd1<br>0012fdc4 77e378af USER32!DialogBoxIndirectParamAorW+0x34<br>0012fdf0 00403793 USER32!DialogBoxParamA+0x4a<br>00407294 74696445 KillTheInstaller+0x3793<br>00407298 00413032 0x74696445<br>0040729c 68636952 KillTheInstaller+0x13032</code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">4th June 2007 19:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I was able to workaround this Windows bug by removing the WS_GROUP style from the first button. I still don't know exactly what happens there, but at least a very good direction now.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">6th June 2007 20:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well, not even that works... There's a loop there that calls _NextControl until it finds a mnemonic for the pressed key. It also stops if the loop returns to the original dialog item that was enumerated first.</p>
      <pre>
<code>iWND xxxGNM_FindNextMnem(iWND dialog, iWND ctl, WCHAR key) {<br>  // some other group(?) stuff here<br><br>  // find control with matching mnemonic<br>  iWND h = _NextControl(dialog, ctl);<br>  while (h != ctl) { // <b>never equal!</b><br>    if (SomeMnemCheck(h, key)) {<br>      return h;<br>    }<br><br>    h = _NextControl(dialog, h);<br>  }<br>}</code>
</pre>But _NextControl() never returns <i>ctl</i>, which for the specific call in which it hangs is the internal handle to the IDD_INSTFILES dialog. <i>dialog</i> is IDD_INST.
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">6th June 2007 20:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Heh, I managed to reproduce a similar bug in Windows XP SP2. In a dialog with no enabled or visible controls with WS_TABSTOP, sending WM_NEXTDLGCTL(0, FALSE) kills it :)</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">6th June 2007 21:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">And here's a small reproduction program. I'll try to minimize it to see if I can pinpoint exactly what's wrong. Currently it seems like it's choking because the default button, which also has "focus" is invisible.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">8th June 2007 15:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Some more fun debugging lines later and I think I have a mostly complete description of the bug.</p>

      <ol style="list-style-type: decimal">
        <li>The user hits a key.</li>

        <li>Windows translates that to a WM_CHAR message to the focused control in the active window.</li>

        <li>That control is hidden, so it passes the message to its parent. The parent, in our case, is also a child of another dialog.</li>

        <li>DialogBox2 (which is internally called by our own DialogBox) reads this message using PeekMessage and calls IsDialogMessage to handle it.</li>

        <li>IsDialogMessage gets WM_CHAR and so it calls xxxGotoNextMnem to activate a mnemonic, if present.</li>

        <li>xxxGotoNextMnem calls xxxGNM_FindNextMnem which loops over all controls, starting from the control passed to WM_CHAR. It does that using _NextControl.</li>

        <li>_NextControl never returns the internal dialog because it has the WS_EX_CONTROLPARENT style. Instead, it returns its first child.</li>

        <li>xxxGNM_FindNextMnem keeps looping until it finds a control with a matching mnemonic or until it reaches back to control sent to WM_CHAR.</li>

        <li>xxxGNM_FindNextMnem never finds a matching control and _NextControl never gives it a proper value to stop the loop.</li>
      </ol>So to sum it up - don't set focus to a control and then hide it. Or, if you'd like, Windows dialogs love infinite loops. There are a number of places in the code I've debugged where loops are stopped with a counter that reaches magic values like 0x400. _NextControl itself calls _NextSibblingOrAncestor up to 0x400 times, probably to stop another infinite loop bug that was there in the past. Just for the laughs, I've debugged the same functions under Windows XP. And lo and behold, that exact piece of code now has a counter reaching to 0x400 as well! :D
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br>
      <span class="post-time small text-muted">8th June 2007 15:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Good god that isn't very good lol<br>
      Well done though kichik :)<br>
      <br>
      Stu</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">8th June 2007 18:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1733692&amp;group_id=22049&amp;atid=373085" target="_blank">http://sourceforge.net/tracker/index...49&amp;atid=373085</a></p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">{_trueparuex^}</span><br>
      <span class="post-time small text-muted">8th June 2007 19:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by kichik</i><br>
        <b>Just for the laughs, I've debugged the same functions under Windows XP. And lo and behold, that exact piece of code now has a counter reaching to 0x400 as well! :D</b>
      </blockquote>So it loops somewhere 1024 times in XP too? :D Well that's one way to fix infinite loops.<br>
      <br>
      By the way this bug is also reproducible on Windows 98 and (my guess) on any windows prior to XP.
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br>
      <span class="post-time small text-muted">8th June 2007 19:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Not only somewhere... A lot of places! :)</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>