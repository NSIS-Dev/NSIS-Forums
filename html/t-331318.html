<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="UAC: CreateShortcut not created in user directory"><title>UAC: CreateShortcut not created in user directory - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">UAC: CreateShortcut not created in user directory</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=331318">UAC: CreateShortcut not created in user directory</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">floyd82</span><br><span class="post-time small text-muted">7th June 2011 21:32 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>UAC: CreateShortcut not created in user directory</strong><br>Hi,<br><br>I have the problem, that I want to execute my NSIS installer with user privilegues via the UAC plugin. In my opinion I did everything right with the UAC plugin, but all shortcuts (desktop and startmenu) are not created in the user directories, but in the administrator directories.<br><br>These following lines are the most important in my opinion:<br><br></p><pre>
<code>!include "UAC.nsh"</code>
</pre><br><br><pre>
<code>RequestExecutionLevel user</code>
</pre><br><br><pre>
<code>; Attempt to give the UAC plug-in a user process and an admin process.<br>Function .OnInit<br> <br>UAC_Elevate:<br>    !insertmacro UAC_PageElevation_RunElevated<br>    StrCmp 1223 $0 UAC_ElevationAborted ; UAC dialog aborted by user?<br>    StrCmp 0 $0 0 UAC_Err ; Error?<br>    StrCmp 1 $1 0 UAC_Success ;Are we the real deal or just the wrapper?<br>    Quit<br> <br>UAC_Err:<br>    MessageBox mb_iconstop "Unable to elevate, error $0"<br>    Abort<br> <br>UAC_ElevationAborted:<br>    # elevation was aborted, run as normal?<br>    MessageBox mb_iconstop "This installer requires admin access, aborting!"<br>    Abort<br> <br>UAC_Success:<br>    StrCmp 1 $3 +4 ;Admin?<br>    StrCmp 3 $1 0 UAC_ElevationAborted ;Try again?<br>    MessageBox mb_iconstop "This installer requires admin access, try again"<br>    goto UAC_Elevate <br> <br>FunctionEnd</code>
</pre><br>
      <br>
      <pre>
<code>!insertmacro UAC_AsUser_Call Function CreateUserShortcuts ${UAC_SYNCREGISTERS}</code>
</pre><br>
      <br>
      <pre>
<code>Function CreateUserShortcuts<br>    # start menu<br>    createDirectory "$SMPROGRAMS\genialix 1x1\"<br>    createShortCut "$SMPROGRAMS\genialix 1x1\genialix 1x1.lnk" "$INSTDIR\genialix-1x1-launcher.exe" "" "$INSTDIR\genialix.ico"<br>    createShortCut "$SMPROGRAMS\genialix 1x1\genialix 1x1 deinstallieren.lnk" "$INSTDIR\uninstall.exe" ""<br><br>    # desktop shortcut<br>    createShortCut "$DESKTOP\genialix 1x1.lnk" "$INSTDIR\genialix-1x1-launcher.exe" "" "$INSTDIR\genialix.ico"<br>FunctionEnd</code>
</pre><br>
      <br>
      I also have the whole NSIS script attached, if it helps...<br>
      I used NSIS version 2.46, with UAC version 0.2.2d from here:<br>
      <a href="http://nsis.sourceforge.net/UAC_plug-in" target="_blank">http://nsis.sourceforge.net/UAC_plug-in</a><br>
      <br>
      Thanks in advance for your help!<br>
      <br>
      <pre>
<code>!include "MUI2.nsh"<br>!include LogicLib.nsh<br>!include "UAC.nsh"<br><br>#required: jre 1.6<br>!define MIN_JAVA_MAJOR_VERSION 1<br>!define MIN_JAVA_MINOR_VERSION 6<br><br>#name<br>!define APPLICATION_NAME "genialix 1x1"<br><br>outFile "genialix-1x1-installer.exe"<br>Name "${APPLICATION_NAME}"<br>Icon "genialix.ico"<br>!define MUI_ICON "genialix.ico"<br>!define MUI_UNICON "genialix.ico"<br>installDir "$PROGRAMFILES\genialix 1x1"<br>RequestExecutionLevel user<br><br>;Get installation folder from registry if available<br>InstallDirRegKey HKCU "Software\genialix 1x1" ""<br><br>;Request application privileges for Windows Vista<br>RequestExecutionLevel admin<br><br>;--------------------------------<br>;Interface Settings<br><br>  !define MUI_HEADERIMAGE<br>  !define MUI_HEADERIMAGE_BITMAP "OneHundred_NSIS_Header.bmp" #optional<br>  !define MUI_ABORTWARNING<br>  !define MUI_WELCOMEFINISHPAGE_BITMAP "OneHundred_NSIS_WelcomeFinishPage.bmp" #optional<br><br><br>;--------------------------------<br>;Pages<br><br>  !insertmacro MUI_PAGE_WELCOME<br>#  !insertmacro MUI_PAGE_LICENSE "${NSISDIR}\Docs\Modern UI\License.txt"<br>  !insertmacro MUI_PAGE_LICENSE "license.txt"<br>  !insertmacro MUI_PAGE_DIRECTORY<br>  !insertmacro MUI_PAGE_INSTFILES<br>  !insertmacro MUI_PAGE_FINISH<br><br>  !insertmacro MUI_UNPAGE_WELCOME<br>  !insertmacro MUI_UNPAGE_CONFIRM<br>  !insertmacro MUI_UNPAGE_INSTFILES<br>  !insertmacro MUI_UNPAGE_FINISH<br><br>;--------------------------------<br>;Languages<br><br>  !insertmacro MUI_LANGUAGE "German"<br><br><br>; Attempt to give the UAC plug-in a user process and an admin process.<br>Function .OnInit<br> <br>UAC_Elevate:<br>    !insertmacro UAC_PageElevation_RunElevated<br>    StrCmp 1223 $0 UAC_ElevationAborted ; UAC dialog aborted by user?<br>    StrCmp 0 $0 0 UAC_Err ; Error?<br>    StrCmp 1 $1 0 UAC_Success ;Are we the real deal or just the wrapper?<br>    Quit<br> <br>UAC_Err:<br>    MessageBox mb_iconstop "Unable to elevate, error $0"<br>    Abort<br> <br>UAC_ElevationAborted:<br>    # elevation was aborted, run as normal?<br>    MessageBox mb_iconstop "This installer requires admin access, aborting!"<br>    Abort<br> <br>UAC_Success:<br>    StrCmp 1 $3 +4 ;Admin?<br>    StrCmp 3 $1 0 UAC_ElevationAborted ;Try again?<br>    MessageBox mb_iconstop "This installer requires admin access, try again"<br>    goto UAC_Elevate <br> <br>FunctionEnd<br><br><br># start default section<br>section<br> <br>    # set the installation directory as the destination for the following actions<br>    setOutPath $INSTDIR<br><br>    call jre_installation<br><br>    file "genialix.ico"<br>    file "genialix-1x1-launcher.exe"<br>    file /r "..\..\dist\*.*"<br> <br>    # create the uninstaller<br>    writeUninstaller "$INSTDIR\uninstall.exe"<br><br>    !insertmacro UAC_AsUser_Call Function CreateUserShortcuts ${UAC_SYNCREGISTERS}<br><br>sectionEnd<br> <br># jre installation<br>function jre_installation<br><br>    # read jre version from registry<br>    ClearErrors<br>    ReadRegStr $R1 HKLM "SOFTWARE\JavaSoft\Java Runtime Environment" "CurrentVersion"<br>    #ReadRegStr $R0 HKLM "SOFTWARE\JavaSoft\Java Runtime Environment\$R1" "JavaHome"<br>    IfErrors no_jre_found<br><br>    # check if java version suits our needs<br>    Push "."<br>    Push $R1<br>    call SplitFirstStrPart<br>    Pop $R0 #1st part (hopefully something like "1")<br>    Pop $R1 #rest     (hopefully something like "6")<br>    ${If} $R0 == ${MIN_JAVA_MAJOR_VERSION}<br>        ${If} $R1 &lt; ${MIN_JAVA_MINOR_VERSION}<br>            goto old_jre_found<br>        ${Else}<br>            return<br>        ${EndIf}<br>    ${ElseIf} $R0 &lt; ${MIN_JAVA_MAJOR_VERSION}<br>        goto old_jre_found<br>    ${Else}<br>        return<br>    ${EndIf}<br><br>    MessageBox MB_OK "Fehler bei der Java-Erkennung. $\nInstallation wird ohne Java fortgesetzt."<br>    return<br><br>    # jre version could not be detected -&gt; probably no java installed<br>    no_jre_found:<br>    MessageBox MB_YESNO "Für ${APPLICATION_NAME} wird Java benötigt. Auf diesem Computer wurde kein Java gefunden. $\n$\nWollen Sie es jetzt installieren?" /SD IDYES IDYES do_jre_installation<br>    Abort<br><br>    # jre version is too old<br>    old_jre_found:<br>    MessageBox MB_YESNO "Für ${APPLICATION_NAME} wird eine aktuelle Version von Java benötigt. $\nDas auf diesem Computer installierte Java ist jedoch veraltet. $\n$\nWollen Sie es jetzt eine aktuelle Version von Java installieren?" /SD IDYES IDYES do_jre_installation<br>    Abort<br><br>    # the actual jre installer <br>    do_jre_installation:<br>    file "jre-6u22-windows-i586-s.exe"<br>    ClearErrors<br>    ExecWait "$INSTDIR\jre-6u22-windows-i586-s.exe"<br>    IfErrors installing_jre_error<br>    return<br><br>    # jre not installed?  -&gt; quit<br>    installing_jre_error:<br>    MessageBox MB_OK "Install JRE error"<br>    Abort<br><br>functionEnd<br><br>Function SplitFirstStrPart<br>  Exch $R0<br>  Exch<br>  Exch $R1<br>  Push $R2<br>  Push $R3<br>  StrCpy $R3 $R1<br>  StrLen $R1 $R0<br>  IntOp $R1 $R1 + 1<br>  loop:<br>    IntOp $R1 $R1 - 1<br>    StrCpy $R2 $R0 1 -$R1<br>    StrCmp $R1 0 exit0<br>    StrCmp $R2 $R3 exit1 loop<br>  exit0:<br>  StrCpy $R1 ""<br>  Goto exit2<br>  exit1:<br>    IntOp $R1 $R1 - 1<br>    StrCmp $R1 0 0 +3<br>     StrCpy $R2 ""<br>     Goto +2<br>    StrCpy $R2 $R0 "" -$R1<br>    IntOp $R1 $R1 + 1<br>    StrCpy $R0 $R0 -$R1<br>    StrCpy $R1 $R2<br>  exit2:<br>  Pop $R3<br>  Pop $R2<br>  Exch $R1 ;rest<br>  Exch<br>  Exch $R0 ;first<br>FunctionEnd<br><br># uninstaller section start<br>section "uninstall"<br> <br>    # first, delete the uninstaller<br>    delete "$INSTDIR\uninstall.exe"<br><br>    # delete files <br>    delete "$INSTDIR\genialix.ico"<br>    delete "$INSTDIR\genialix-1x1-launcher.exe"<br>    delete "$INSTDIR\OneHundred.jar"<br>    delete "jre-6u22-windows-i586-s.exe"<br>    RMDir "$INSTDIR"<br><br>    !insertmacro UAC_AsUser_Call Function Un.CreateUserShortcuts ${UAC_SYNCREGISTERS}<br> <br># uninstaller section end<br>sectionEnd<br><br><br>Function CreateUserShortcuts<br>    # start menu<br>    createDirectory "$SMPROGRAMS\genialix 1x1\"<br>    createShortCut "$SMPROGRAMS\genialix 1x1\genialix 1x1.lnk" "$INSTDIR\genialix-1x1-launcher.exe" "" "$INSTDIR\genialix.ico"<br>    createShortCut "$SMPROGRAMS\genialix 1x1\genialix 1x1 deinstallieren.lnk" "$INSTDIR\uninstall.exe" ""<br><br>    # desktop shortcut<br>    createShortCut "$DESKTOP\genialix 1x1.lnk" "$INSTDIR\genialix-1x1-launcher.exe" "" "$INSTDIR\genialix.ico"<br>FunctionEnd<br><br>Function Un.CreateUserShortcuts<br>    # start menu<br>    delete "$SMPROGRAMS\genialix 1x1\genialix 1x1.lnk"<br>    delete "$SMPROGRAMS\genialix 1x1\genialix 1x1 deinstallieren.lnk"<br>    RMDir "$SMPROGRAMS\genialix 1x1\"<br><br>    # desktop shortcut<br>    delete "$DESKTOP\genialix 1x1.lnk"<br>FunctionEnd</code>
</pre>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br>
      <span class="post-time small text-muted">8th June 2011 06:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Well, I can only find one problem and that's that you don't syncinstdir for your userlevel function. But that wouldn't change the location where the shortcut is created. How about if you explicitly setshellvarcontext user in the userlevel function?<br>
      <br>
      Also, please do NOT post such large amounts of code in the forums. Either use pastebin or add a file attachment.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">floyd82</span><br>
      <span class="post-time small text-muted">8th June 2011 09:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for your answer! Using setshellvarcontext seems to be a hack, I would feel better when finding out what the real problem is... And how should I use it anyway? I only found this doc and no real example:<br>
      <a href="http://nsis.sourceforge.net/Docs/Chapter4.html#4.9.7.7" target="_blank">http://nsis.sourceforge.net/Docs/Chapter4.html#4.9.7.7</a><br>
      <br>
      Sorry for posting the whole script, I can't edit it anymore now...</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br>
      <span class="post-time small text-muted">8th June 2011 12:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Err... Why would using a proper NSIS command be a hack? Just try it and see if it works. And as you can read in the manual entry you linked, the user's context can be set by passing the parameter 'current'.<br>
      <br>
      Anyway, better still, add a MessageBox to verify that the path you're passing to createshortcut is actually correct.</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>