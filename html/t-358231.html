<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="64-bit Registry Values Not Written in One Case" />

  <title>64-bit Registry Values Not Written in One Case - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">64-bit Registry Values Not Written in One Case</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=358231">64-bit Registry Values Not Written in One Case</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">GTVic</span><br />
      <span class="post-time small text-muted">27th March 2013 22:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>64-bit Registry Values Not Written in One Case</strong><br />
      My script sets values both under HKCR\Interface and under HKCR\Wow6432Node\Interface<br />
      <br />
      When I run the NSIS compiled EXE it works, I have SetRegView 64 in the script which also has requestexecutionlevel admin. Everything is running in a UAC environment, Windows 7 64.<br />
      <br />
      So far so good.<br />
      <br />
      But when I run a VBS script that runs the NSIS EXE, then the HKCR\Interface values are not set, presumably redirected to HKCR\Wow6432Node\Interface.<br />
      <br />
      The details of the VBS script are that it checks if there are any command line parameters and then it executes itself with admin rights<br />
      if WSCript.Arguments.length = 0 then<br />
      oShell.ShellExecute "wscript.exe", Chr(34) &amp; strScriptPath &amp; Chr(34) &amp; " uac", "", "runas", 1<br />
      end if<br />
      where oShell is defined as<br />
      Set oShell = CreateObject("Shell.Application")<br />
      <br />
      To run the NSIS compiled EXE which edits the registry, the VBS Script uses oWSH.Exec(runstring) where oWSH is defined as<br />
      Set oWSH = CreateObject("WScript.Shell")</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">28th March 2013 00:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Can you check in Process Explorer to make sure the installer is running at high integrity level?<br />
      You could also try Process Monitor and see where it writes in the registry.<br />
      <br />
      Why use oWSH.Exec? Could you try one of the other two methods (Run, ShellExecute) that use ShellExecute internally so we know you are getting UAC elevation handling...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">GTVic</span><br />
      <span class="post-time small text-muted">28th March 2013 00:58 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks, ShellExecute, Run have no wait option, but I was able to find an intermediary program that will do the waiting. First test went ok.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">GTVic</span><br />
      <span class="post-time small text-muted">28th March 2013 02:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for the tip.<br />
      <br />
      So in summary I wasn't concerned about running elevated because the entire script is elevated to start, guaranteed. Since the problem NSIS compiled script was working partially, adding 32-bit registry entries, I was not concerned about elevation.<br />
      <br />
      In the end it seems as though oWSH.Exec can force a child process in a 32-bit compatibility mode.<br />
      <br />
      Whereas Run or ShellExecute don't appear to have that restriction. The problem with these is that they cannot wait for the process to finish.<br />
      <br />
      I did find a website <a href="http://www.westmesatech.com/misctools.html" target="_blank">Bill Stewart's Site - Miscellaneous Tools</a>. That has a set of elevate tools that allow use of Run or ShellExecute with proper UAC control and will wait for the process to finish.<br />
      <br />
      So that was my solution. I have an NSIS script which downloads/runs another NSIS script which extracts files and runs an extracted VBS script which uses ELEVATE to run a third NSIS script to modify the registry and set both 32-bit and 64-bit values. :confused:</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">28th March 2013 02:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Run can wait...</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Afrow UK</span><br />
      <span class="post-time small text-muted">28th March 2013 12:56 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I would avoid using a VBS because wscript/cscript can be disabled by group policy and this has been common with my users in the past (for example those in a domain/workstation environment). You'll just get a message box appear and then your installer will never run. Similar issue can happen with cmd.exe. The only real alternative is to use a MSI wrapper which can run embedded VBS using its own built in interpreter.<br />
      <br />
      Also if you use RequestExecutionLevel admin, you still actually need to check the user is running as an administrator. You can use the UserInfo plug-in for this.<br />
      <br />
      Stu</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">GTVic</span><br />
      <span class="post-time small text-muted">28th March 2013 23:27 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks, this is a very controlled environment so no issues with VBS not working. I've removed the ELEVATE utilities, the only requirement was to use Run in place of Exec.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
