<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="AllUsers/CurrentUser install without elevation" />

  <title>AllUsers/CurrentUser install without elevation - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">AllUsers/CurrentUser install without elevation</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=330893">AllUsers/CurrentUser install without elevation</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Quintus</span><br />
      <span class="post-time small text-muted">25th May 2011 01:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>AllUsers/CurrentUser install without elevation</strong><br />
      I've got a game application that I'm trying to write an installer for. The game is an online game that has its own launcher/patcher and will need to apply frequent updates. Because of this, its desirable to install to a folder that doesn't require elevation to write to (otherwise the launcher/patcher would constantly have to request elevation to run)<br />
      <br />
      Other applications in this situation have modified the traditional PerUser/AllUsers install paths to be:<br />
      * AllUsers = install to a common per-machine location (e.g., CSIDL_COMMON_APPDATA)<br />
      * PerUser = install to something like CSIDL_LOCAL_APPDATA<br />
      <br />
      Microsoft even specifically addresses the problems posed by patching software <a href="http://msdn.microsoft.com/en-us/library/ee418715(v=vs.85).aspx" target="_blank">here</a>:<br />
      <br />
      My preference would be to install to a location like:</p>

      <ul>
        <li>
          <b>AllUsers</b>

          <ul>
            <li><b>Vista/Win7:</b> C:\Users\Public\Games\</li>

            <li><b>XP:</b> C:\Program Files\</li>
          </ul>
        </li>

        <li><b>PerUser:</b> C:\&lt;profile&gt;\My Documents\My Games\</li>
      </ul><br />
      This seems to be fairly irritating to implement. For starters, I haven't been able to get NSIS to reliably get me either the user's 'My Documents' folder or the 'Common' folder. I can get CSIDL_COMMON_APPDATA with something liek this:<br />
      <br />
      <pre>
<code>System::Call 'shell32::SHGetSpecialFolderPath(i $HWNDPARENT, t .r1, i 46, i0)i.r0'</code>
</pre><br />
      <br />
      But that doesn't actually give me the path I want. It might *work*, but it's not optimal.<br />
      <br />
      The SHGetSpecialFolderPath doesn't seem to work with the 'My Documents' folder. When I passin the CSIDL for that (12) - I get nothing... I can get it from the registry using<br />
      <br />
      <pre>
<code>ReadRegStr $0 HKCU "SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders" Personal</code>
</pre><br />
      <br />
      But I've heard that the registry method may not be reliable in non-English Windows installations (I haven't verified that).<br />
      <br />
      Finally - uninstallation can also be tricky. If a user installs (without privileges) in an AllUsers context to a folder like C:\Users\Public\ traditional installation/uninstallation tricks like writing registry keys/values to HKLM might not be available.<br />
      <br />
      Does anybody have any experience with the kind of installer I'm talking about? I would really appreciate hearing from anybody who has been down this path before.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">MSG</span><br />
      <span class="post-time small text-muted">25th May 2011 06:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"></p>

      <blockquote>
        <small>Originally posted by Quintus</small><br />
        My preference would be to install to a location like:

        <ul>
          <li>
            <b>AllUsers</b>

            <ul>
              <li><b>Vista/Win7:</b> C:\Users\Public\Games\</li>

              <li><b>XP:</b> C:\Program Files\</li>
            </ul>
          </li>

          <li><b>PerUser:</b> C:\&lt;profile&gt;\My Documents\My Games\</li>
        </ul><br />
        This seems to be fairly irritating to implement.
      </blockquote>It's actually quite easy. Use nsDialogs to create a custom page asking for single/all user install, and use winver.nsh to distinguish between OS versions. Then simply do StrCpy $INSTDIR "Whatever Applies".<br />
      <br />

      <blockquote>
        <small>Originally posted by Quintus</small><br />
        For starters, I haven't been able to get NSIS to reliably get me either the user's 'My Documents' folder or the 'Common' folder.
      </blockquote>It's all there in the manual...<br />
      <a href="http://nsis.sourceforge.net/Docs/Chapter4.html#4.2.3" target="_blank">http://nsis.sourceforge.net/Docs/Chapter4.html#4.2.3</a><br />
      <a href="http://nsis.sourceforge.net/Docs/Chapter4.html#4.9.7.7" target="_blank">http://nsis.sourceforge.net/Docs/Chapter4.html#4.9.7.7</a><br />
      <br />

      <blockquote>
        <small>Originally posted by Quintus</small><br />
        But I've heard that the registry method may not be reliable in non-English Windows installations (I haven't verified that).
      </blockquote>The reliability problem occurs on any language Windows. Mostly on newly installed operating systems, actually. But either way, use the constants listed in the manual.<br />
      <br />

      <blockquote>
        <small>Originally posted by Quintus</small><br />
        Finally - uninstallation can also be tricky. If a user installs (without privileges) in an AllUsers context to a folder like C:\Users\Public\ traditional installation/uninstallation tricks like writing registry keys/values to HKLM might not be available.
      </blockquote>A user-level user cannot install in an all users context. Only admins can. Use the userinfo plugin to verify whether you have admin access, and throw an error when you don't. Most people put it in .onInit, and add a "requestexecutionlevel admin" for graceful UAC handling.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Quintus</span><br />
      <span class="post-time small text-muted">25th May 2011 23:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">For what it's worth, the only part that I was having trouble getting to work at all was extracting the public profile path for Vista/Win7. None of the standard NSIS constants resolve to the root of the public user profile folder (e.g., C:\Users\Public\).<br />
      <br />
      After fishing around however, I found that in Vista/Win7, while there is not a CSIDL value that corresponds withe the public user profile, there <b><i>is</i></b> an environment variable %PUBLIC% that gets me what I want, so I now get the root for my AllUsers install on Vista/Win7 with the following:<br />
      <br /></p>
      <pre>
<code>ExpandEnvStrings $0 "%PUBLIC%\Games"</code>
</pre><br />
      <br />
      I have to be careful to only use the %PUBLIC% env. variable in Vista/Win7 (and I gracefully handle an empty result just in case), but for the most part I can just append my product-specific path on the end of that.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Anders</span><br />
      <span class="post-time small text-muted">25th May 2011 23:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">There is no CLSIDL, but there is a knownfolder id. You need to use the system plugin to call that api tho. I use the API in some other example @ <a href="http://pastebin.com/MZeNijJJ" target="_blank">http://pastebin.com/MZeNijJJ</a> you can just change the folder guid...</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
