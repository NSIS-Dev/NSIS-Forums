<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="&quot;Official&quot; application data folder support?"><title>"Official" application data folder support? - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">"Official" application data folder support?</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=126207">"Official" application data folder support?</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">RDaneel</span><br><span class="post-time small text-muted">24th February 2003 05:00 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>"Official" application data folder support?</strong><br>Hi all! I am on the verge of completing the transition from my own home-grown install system to NSIS 2.x (using MUI).<br><br>As you can guess, I have a question (as well as an observation or two). My question has to do with support in NSIS for detecting (and creating?) the "official" folder for application data... please correct me if I am wrong, but there doesn't seem to be any. :(<br><br>My own (in my app) logic uses the SHGetSpecialFolderLocation (with CSIDL_APPDATA)... if that fails (like on an older Windows), then &lt;windows dir&gt;\Application Data\ is used as the folder. But between handling errors and the ITEMIDLIST return from this call in NSIS-scripting land, it seems that the NSIS community *could* benefit from having builtin support for an "$APPDATA" variable during [un]installation.<br><br>I have (so far) resisted the temptation to stash a pointer to this folder in the app's reg entries, as I don't like creating gratuitous reg data... as an example, I save the app's menu folder location as command-line arg to the uninstaller.<br><br>In any case, I am certainly interested in any comments/solutions from those more experienced with NSIS than I! :)<br><br>I also have a comment on the RegDLL and UnRegDLL primitives in NSIS: if the DLL that one is dealing with is anything like a Shell extension, then an SHChangeNotify call will most likely be right after the RegDLL, and the UnRegDLL will very likely need to be followed by a call to CoFreeUnusedLibraries... perhaps each of these operations could be optionally performed in NSIS code rather than using the System plug-in?<br><br>Yeah, I know, that way lies bloat, but really, each one of these is a single Win32 call that doesn't require anything ugly like storage management or strings... and for this (which looks fairly simple) or possibly even for the $APPDATA thing, I would be willing to do some coding (but note that I am a Perforce rather than a CVS kind of guy).<br><br>Thanks for reading this far if you did!</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br><span class="post-time small text-muted">24th February 2003 09:49 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote>but note that I am a Perforce rather than a CVS kind of guy</blockquote>I use Perforce, you get used to CVS but I doubt you'll grow to love it. TortoiseCVS makes CVS a much nicer experience though :)</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">RDaneel</span><br><span class="post-time small text-muted">25th February 2003 22:36 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Thanks, Sunjammer, for the TortoiseCVS tip... interestingly, I installed it and then uninstalled it when I noticed that their Shell extension was giving me serious grief - it caused the time to get a file's properties (from, say, Windows Explorer) to go WAY up. This might not be noticeable for a single file, but try multi-selecting a thousand or more files and things get real ugly. :(<br><br>After seeing the hordes of people jumping in to this discussion with comments and advice on the "$APPDATA" thing, I think I will go ahead and write my own support for this function. Sigh. :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br><span class="post-time small text-muted">25th February 2003 23:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Well I was tempted to comment along the lines of "why would you want this appdata thing?" but figured that wasn't very constructive :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">RDaneel</span><br><span class="post-time small text-muted">26th February 2003 00:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">OK... perhaps I am missing something here, but this "Application Data" folder is *the* place for apps to stash any per-user data that the app needs to save (and isn't in the registry). As such, I had assumed it was of interest to almost anyone dealing with install/uninstall issues? Well, at least for apps that *have* this sort of storage requirements... :)<br><br>Anyway, a search on MSDN (CD or site) for "CSIDL_APPDATA" provides some background on this for anyone who is interested. But basically, it provides a place to store PER-USER data for apps, and is particularly important when dealing with roaming profiles or multi-user/network installations in general where the app's install directory may not be writable or is otherwise the "wrong place" to store per-user data.<br><br>In any case, take a look at the user profile folders (under "Documents and Settings" on 2K/XP) for examples of this in use... Microsoft isn't the only SW outfit using this - heck, even Sonique2 uses it! :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">RDaneel</span><br><span class="post-time small text-muted">26th February 2003 00:51 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Hmmm... another quick comment in the unlikely event that anyone jumps right into this without checking out the docs first: the expected usage of the "Application Data" folder is like, say, HKCU\Software - a company/org name should be the next level, followed by a specific app name, e.g. "&lt;Application Data&gt;\Microsoft\Media Player"... OTOH, Mozilla just uses "Mozilla".</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br><span class="post-time small text-muted">26th February 2003 01:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Yeah I kinda new all that, but you won't catch me storing anything in that folder. I hate programs that use it (just a foible of mine I guess). My preference is that a program store it's data in it's own installation directory so that it is all nicely self contained.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">RDaneel</span><br><span class="post-time small text-muted">26th February 2003 02:39 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I guess that's cool and all that (and it's DEFINITELY the way I feel about, say, DLLs that the app may need), but that model just doesn't support multiple users/profiles or separation of code and data (or R/O code trees) as easily.<br><br>Put another way, do you make use of the registry, or just use INI files in the install tree for apps you build? In the end, the Application Data tree could be seen as an extension of / replacement for the HKCU hive of the registry, for when you don't think the registry is appropriate for your purposes... hey, Mozilla uses it, and most of us probably wouldn't accuse them of trying to suck up to Microsoft! :)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">kichik</span><br><span class="post-time small text-muted">26th February 2003 10:37 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">This archive page explains how to get shell folders that aren't avaiable using $* NSIS variables:<br><a href="http://nsis.sourceforge.net/archive/viewpage.php?pageid=6" target="_blank">http://nsis.sourceforge.net/archive/...e.php?pageid=6</a><br><br>To get the application data folder read AppData.<br><br>I don't think calling SHChangeNotify after every RegDLL call is a good idea. Not all DLLs are shell extensions and calling this function will just slow things down when getting the shell to reload data.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">RDaneel</span><br><span class="post-time small text-muted">28th February 2003 23:03 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">No, I am really still alive... :)<br><br>Thanks for taking the time to point me to the archived suggestion(s) kichik, but it's not clear that that approach handles all the cases I am concerned with (quite).<br><br>All of this started to really bug me, especially since Microsoft tried to introduce a DLL (SHFolder.dll) provide a uniform interface to Shell folder info, and then THAT broke because of some of their "security" fixes... so I have put together fresh installs of Win95, Win95 OSR2, Win98, WinNT4, as well as my day-to-day Win2K and notebook WinXP, to see what the real deal is with both the "SH" APIs and the "Explorer\Shell Folders" data in the registry across all of these (except Me, which I never could bring myself to get).<br><br>I'll be back (after running my tests with Beta 2)! :)<br><br>And regarding the SHChangeNotify and the CoFreeUnusedLibraries after [Un]RegDLL calls, I did mention "optional"... and when you need them, you do need them, so if the System plugin is still needed to get things done, then that is the way it goes. :(</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">RDaneel</span><br><span class="post-time small text-muted">6th March 2003 00:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">After examining clean installs of 95, 95 OSR2, 98, NT4, as well as "running" versions of 2000 and XP with respect to the following questions, here is what we get (regarding the "Application Data" issue):<br><br>Q: Is "\Windows\Application Data" present?<br><br>A: In 95, you would get to create it, in 98 it is already there, and for NT4 and later, you actually have a "profile" folder in which "Application Data" resides.<br><br>Q: Does SHGetPathFromIDList() give useful results?<br><br>A: This API is functional in ALL releases of Windows starting with 95, but only supplies useful info for "Application Data" starting with 98 (where it returns "\Windows\Application Data").<br><br>Q: Does SHGetFolderPath() give useful results?<br><br>A: This API is only functional in releases of Windows starting with 2000. It MAY be supported if the SHFolder.DLL redistributable has been installed, BUT see notes below.<br><br>Q: What about the "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders" key?<br><br>A: See comments below, but as of 98, this key is populated with "App Data" info, but requires expansion of the environment var "%USERPROFILE%" for NT4 and later.<br><br>Q: What about the "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders" key?<br><br>A: See comments below, but as of NT4, this key is populated with "App Data" info (and always requires expansion of "%USERPROFILE%").<br><br>Q: What does Microsoft say about locating Shell folders?<br><br>A: Previously, they said to use SHGetPathFromIDList()... which is something of a hassle because of having to deal with the ITEMIDLIST return. Later, they starting pushing SHGetFolderPath(), which is built into 2000 and later (i.e., XP), and even suggested that developers start including a redistributable containing SHFolder.DLL to use this latest "uniform" API for accessing Shell folder info. Unfortunately, code in this DLL asked for R/W access to the registry, and ran afoul of some of the Microsoft security patches. Sigh. So this "solution" became a "problem".<br><br>Comment1: So, API-wise, SHGetPathFromIDList() has the most uniform support, only requiring 98 or later. And the API-level way of getting Shell folder info is the ONLY one that has and will continue to have long-term support from Microsoft.<br><br>Comment2: The Explorer "Shell Folders" registry key is somewhat mixed in its usefulness... while the values SEEM to look good starting with 98, there are issues (besides using reg keys rather than APIs) - officially, the "User Shell Folders" Explorer key takes precedence over "Shell Folders", and it doesn't show up until NT4. As a practical note, don't forget to expand the environment strings which can be embedded in the values from these keys!<br><br>Comment3: The whole topic of per-user "Application Data" storage has gotten uglier, now that Microsoft has "refined" the model to deal with "roaming" profiles... the Registry is not cool any longer, you are supposed to split up user data into "roaming" and "local" chunks, with the original "Application Data" becoming "roaming" and a new "Application Data" under "Local Settings" becoming local or non-roaming. Sigh.<br><br>Summary: I will continue to use the following logic: use SHGetPathFromIDList() to get an ITEMIDLIST and SHGetPathFromIDList() to transform that into a string. If we can't get the ITEMIDLIST, we are on 95, so use "$WINDIR\Application Data" - creating it if we have to.<br><br>I believe that it will be increasingly useful for NSIS to support "$APPDATA" and "$LOCALAPPDATA" variables, as it can be done with a minimum of code and saves the script-writer from having to use the System plugin - as cool as it is! :)<br><br>But then, I also think that the [Un]RegDLL primitives should OPTIONALLY invoke SHChangeNotify (to update the Shell's view of "associations" and filetypes) and CoFreeUnusedLibraries (at times important if you need to do something like, say, deleting your COM DLL during an uninstall), as these are essential for full support of [un]installation of ActiveX/Shell extensions/COM objects etc., and not everyone sees it that way. :)<br><br>If anyone is interested, I will publish my function for obtaining "$APPDATA", but remember that its use will also bring in the System plugin - for now.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">virtlink</span><br><span class="post-time small text-muted">6th March 2003 10:59 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">NSIS wants to be the InstallShield concurrent, or at least a good, free installer, capable of virtually anything, right?<br>I like the $APPDATA suggestion and it is one step further to InstallShield.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Sunjammer</span><br><span class="post-time small text-muted">6th March 2003 12:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">I've updated a <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=697838&amp;group_id=22049&amp;atid=373088" target="_blank">feature request</a> at the nsis project page. That feature request related to this kind of subject matter so I figured I'd link to this thread in it. That way when whoever gets around to looking at that feature request this information won't be forgotten.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Mad Doggie</span><br><span class="post-time small text-muted">12th October 2003 05:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">What ever happened with this one? I am urgently needing to update an INI file located under the current user's Application Data folder.<br><br>Cheers!<br><br>Luke</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Mad Doggie</span><br><span class="post-time small text-muted">12th October 2003 05:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">OK, realized that I was looking at the wrong hive in RegEdt32.... I see that the current folder is stored in HKCU. We'll keep our fingers crossed.<br><br>Cheers!<br><br>Luke</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br><span class="post-time small text-muted">27th December 2003 23:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">NSIS 2 RC1 has a constant for Application Data: $APPDATA.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Mad Doggie</span><br><span class="post-time small text-muted">28th December 2003 03:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><i>Originally posted by Joost Verburg</i><br><b>NSIS 2 RC1 has a constant for Application Data: $APPDATA.</b></blockquote>Great! Thanks!<br><br>Cheers!<br><br>Luke</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">Anders</span><br><span class="post-time small text-muted">29th December 2003 20:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">fun fact: you are not supposed to use the shell folders key<br><br><br><br><br><a href="http://blogs.gotdotnet.com/raymondc/commentview.aspx/ebeb8e28-3ecb-4ca9-b0b0-2bf1bdc57c3a" target="_blank">The long and sad story of the Shell Folders key</a><br><br><br><br></p><blockquote>Once upon a time, in what seems like a galaxy far far away (a Windows 95 beta release known as "M3"), we documented a registry key called "Shell Folders" that programs could read to obtain the locations of various special folders like the Fonts folder or the My Documents folder.<br><br>The developers who received Windows 95 M3 Beta followed the documentation and used that key.<br><br>In the meantime, Windows 95 work continued, and we realized that a registry key was the wrong place to store this information. In part, because a lot of things (like the Control Panel) aren't disk directories so they wouldn't be expressible there. And in another part, because we had forgotten to take into account a feature of Windows NT called roaming user profiles, where your user profile can move around from place to place, so a hard-coded path in the registry is no good.<br></blockquote></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">RDaneel</span><br><span class="post-time small text-muted">29th February 2004 21:07 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">"fun fact: you are not supposed to use the shell folders key"<br><br>Indeed. And after I had gone to some lengths in this thread to explain why this was a bad idea and what to do instead.<br><br>Sigh.<br><br>I have been away from NSIS for a while, and can still hope that the APPDATA implementation doesn't match the documentation that is currently published. I will go look...<br><br>&lt;a short time passes&gt;<br><br>Cool. The docs are incorrect (or at least I find them misleading), and the current code in an NSIS-generated installer does not (in general) rely on the registry for most of the "interesting" new variables - like APPDATA. :)<br><br>Or at least this would seem to be the case from a quick perusal of "GetNSISString" in "exehead\util.c".<br><br>Thanks, Kichik and Joost and whoever else helped on this one!<br><br>Now I am off to see why the latest iteration of NSIS (as with most of its "interesting" releases) no longer likes my installer script. :)</p></div><hr><div class="footer"><p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p></div></div><script src="../js/highlight.pack.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>