<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Plugin for Unicode files conversion"><title>Plugin for Unicode files conversion - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">Plugin for Unicode files conversion</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=218714">Plugin for Unicode files conversion</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">Instructor</span><br><span class="post-time small text-muted">12th June 2005 14:50 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Plugin for Unicode files conversion</strong><br>&nbsp; <b>Features:</b><br>-Convert file from Unicode to ANSI<br>-Convert file from ANSI to Unicode<br>&amp;nbsp;&amp;nbsp;&amp;nbsp;Conversions supported:<br>&amp;nbsp;&amp;nbsp;&amp;nbsp;"UTF-8"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;-&gt; ANSI<br>&amp;nbsp;&amp;nbsp;&amp;nbsp;"UTF-16LE" &lt;-&gt; ANSI<br>&amp;nbsp;&amp;nbsp;&amp;nbsp;"UTF-16BE" &lt;-&gt; ANSI<br><br>-Get file unicode type:<br>&amp;nbsp;&amp;nbsp;&amp;nbsp;"NONE"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;- None Unicode<br>&amp;nbsp;&amp;nbsp;&amp;nbsp;"UTF-8"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;- 8-bit Variable Width (Web)<br>&amp;nbsp;&amp;nbsp;&amp;nbsp;"UTF-16LE|UCS-2LE" - 16-bit Little Endian (Default for Windows)<br>&amp;nbsp;&amp;nbsp;&amp;nbsp;"UTF-16BE|UCS-2BE" - 16-bit Big Endian (Default for Linux)<br>&amp;nbsp;&amp;nbsp;&amp;nbsp;"UTF-32LE|UCS-4LE" - 32-bit Little Endian<br>&amp;nbsp;&amp;nbsp;&amp;nbsp;"UTF-32BE|UCS-4BE" - 32-bit Big Endian<br><br>"<b>unicode</b>" v1.0</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">tpr</span><br><span class="post-time small text-muted">18th November 2008 12:30 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Many thanks for this. I needed exactly this one.</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">AxelMock</span><br><span class="post-time small text-muted">26th February 2009 15:04 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Re:Plugin for Unicode files conversion</strong><br>&nbsp; Hi,<br><br>I used this plugin to convert an .inf file from Unicode to ANSI to search for some value in the .inf file using the standard (non-Unicode) NSIS version.<br><br>Worked fine on the systems we tested here (German, English), but a customer reported that the application would stop (exception) on a chinese windows system (IDENTICAL .inf file).<br><br>Testing showed that japanese systems were affected too.<br><br>I started debugging, made a debug version of the DLL and a small test program. I ended debugging on the japanese and chinese system finding that the Call to kernel32::WideCharToMultiByte delivers the exception.<br>According to Microsoft documentation of that function the call made in unicode.dll is correct (using CP_ACP and no user defined replacement).<br>I limited the conversion to the starting file part woth NO language specific unicode character, and the function succeeds. IMHO must be some problem of the function with the ANSI codepage on these systems.<br><br>Playing around with some option flags, I could avoid the exeception, but the conversion did NOT take place (0 chars converted).<br><br>In my case a working function FileUnicode2UTF8 could have helped. I just could'n t figure out how to dimension the buffer as a UTF-8 char might take up multiple byte chars.<br><br>IMHO:This Unicode conversion plugin will get more important when the Unicode version of NSIS will be more widely used.<br>(Or does the NSIS Unicode branch supply its own conversion tools/keywords?)</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">akopts</span><br><span class="post-time small text-muted">27th February 2009 16:21 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Is there a way to convert from UTF-16LE to UTF-8?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">AxelMock</span><br><span class="post-time small text-muted">2nd March 2009 16:20 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"></p><blockquote><i>Originally posted by akopts</i><br><b>Is there a way to convert from UTF-16LE to UTF-8?</b></blockquote>See<br><a href="http://forums.winamp.com/showthread.php?postid=2491531#post2491531" target="_blank">Comment in NSIS Unicode Thread</a></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">AxelMock</span><br><span class="post-time small text-muted">2nd March 2009 17:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>Updated version V1.1 available</strong><br>&nbsp;</p><blockquote><i>Originally posted by AxelMock</i><br><b>See<br><a href="http://forums.winamp.com/showthread.php?postid=2491531#post2491531" target="_blank">Comment in NSIS Unicode Thread</a></b></blockquote>The updated version V1.1 is available.<br>Wiki updated too.<br>New function: FileUnicode2UTF8</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">gringoloco023</span><br><span class="post-time small text-muted">29th July 2010 22:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Bugs, the following line:<br>unicode::FileUnicode2Ansi "$EXEDIR\UTF-16LE.txt" "$EXEDIR\Temp.txt" "UTF-16LE"<br><br>unicode.dll v1.0 : adds a question-mark to the beginning of 'Temp.txt'<br>unicode.dll v1.1 : just creates an empty 'Temp.txt' file, but returns 0<br><br>Where 'UTF-16LE' is the file from the example script, but it seems to happen to all utf-16LE files !</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">koelzk</span><br><span class="post-time small text-muted">1st September 2010 16:42 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>FileUnicode2UTF8 fails in NSIS Unicode</strong><br>&nbsp; Hi,<br><br>I am working on an installer for the NSIS Unicode build. I wanted to use FileUnicode2UTF8 to convert a text file from UCS-2 LE to UTF-8. The background is I want to write a user selected folder path into a configuration file that uses UTF-8 encoding.<br><br>However, I just can't get the plug-in to convert the file, I always get error code 2. Is this a problem of NSIS Unicode or is my script file wrong (see attached file)?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">gringoloco023</span><br><span class="post-time small text-muted">1st September 2010 17:57 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>unicode plug-in does not work in Unicode Nsis !</strong><br>&nbsp; As there where a few utf-16 functions missing in TextFunc.nsh, I updated it one day and included some extras for ${FileRecode}<br><br>Aswell I made a couple of minor adjustments to your script:<br></p><pre>
<code>
nsh
<br>Section ""
<br>   ; Write Settings.ini:
<br>   FileOpen $0 "$EXEDIR\Settings.ini" w
<br>    StrCpy $R0"Folder=セちさ" ; Sample unicode string with 3 Japanese characters
<br>    FileWriteWord$0 0xFEFF ; write the BOM
<br>    FileWriteUTF16LE$0 $R0
<br>    FileClose$0
<br>   ; Convert file from Unicode to UTF-8
<br>    StrCpy$0 "$EXEDIR\Settings.ini"
<br>   StrCpy $1 "$EXEDIR\Settings2.ini"
<br>   StrCpy $2 "ToUTF8"
<br>   CopyFiles /SILENT $0 $1
<br>   ${FileRecode} $1 $2
<br>   ; Print some information
<br>    DetailPrint 'FileRecode to UTF8 "$0" "$1" $2'
<br>   DetailPrint "$3"
<br>   DetailPrint ""
<br>&gt;SectionEnd 
<br>&gt;
</code>
</pre>BTW: I remember I used to get the occasional crash whenever I done repetitive re-coding. Although I found out how to fix it I did not get around to it yet. If you're experiencing any problems with it I will put it higher on my priority list .
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">koelzk</span><br>
      <span class="post-time small text-muted">1st September 2010 20:06 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks for the quick reply :). Your script is a big help. However, as you said, there still seems to be a bug in the conversion.<br>
      <br>
      When I run the script, a few random characters are added to the end of the converted text file. The number of random characters differs from run to run (usually 3), sometimes no characters are added and the converted file is fine.</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">gringoloco023</span><br>
      <span class="post-time small text-muted">1st September 2010 21:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Hmm....</strong><br>
      &nbsp; I never experienced random characters on the end of the file.<br>
      <br>
      Just to make sure, you are not talking about the BOM for utf-8 ( ï»¿ ) ?<br>
      Which re-coding are you doing ? From utf-16LE to utf-8 ?<br>
      <br>
      Anyway, I will look into it these days... (shouldn't be that much work)<br>
      <br>
      Edit: Just to remind you, your Japanese characters take 6 bytes in utf-16, but 9 bytes in utf-8.<br>
      utf-8:<br>
      EF BB BF 46 6F 6C 64 65 72 3D E3 82 BB E3 81 A1 E3 81 95 = ï»¿Folder=ã‚»ã¡ã•<br>
      <br>
      utf-16LE:<br>
      FF FE 46 00 6F 00 6C 00 64 00 65 00 72 00 3D 00 BB 30 61 30 55 30 = ÿþF.o.l.d.e.r.=.»0a0U0</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">koelzk</span><br>
      <span class="post-time small text-muted">2nd September 2010 17:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">No, I don't think it's a byte order mark, just a few random bytes (and the bom at the beginning of the Settings2.ini is correct.). Notepad++ also shows them as additional characters.<br>
      <br>
      I modified the script so the same string is written with line terminator three times into the Settings.ini, which seems to provoke this bug more often. See the attached script and output files (I compiled the script with NSIS Unicode 2.46 and launched the exe on Windows 7 and XP). I hope this help to track the error. Thanks for taking a look into this issue :)</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">gringoloco023</span><br>
      <span class="post-time small text-muted">3rd September 2010 12:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hmm... I see what you mean now.<br>
      <br>
      So long for my testing :(<br>
      <br>
      I first have to finish the project I'm working on these days, then by the weekend I will have time to look at this issue.<br>
      <br>
      thanx for reporting it</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">gringoloco023</span><br>
      <span class="post-time small text-muted">4th September 2010 21:55 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Fixed ?</strong><br>
      &nbsp; I was not allocating any space to fit the terminating null-byte before ReadFile(), so the string ended in any kind of random characters.<br>
      <br>
      Not sure how I could have missed that before :confused:<br>
      <br>
      Anyway, give it ago (the script you send me is working fine for me)</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">koelzk</span><br>
      <span class="post-time small text-muted">5th September 2010 20:44 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Cool, thanks alot! Now the installer of my plotter app can write a user selected path into the settings file even when it's Chinese. You really helped me out :)</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Legace</span><br>
      <span class="post-time small text-muted">30th September 2010 14:13 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Thanks a lot gringoloco023!</p>
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>