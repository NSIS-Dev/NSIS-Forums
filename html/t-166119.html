<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Files get Deleted on Reboot after Uninstall / Install" />

  <title>Files get Deleted on Reboot after Uninstall / Install - NSIS Forums</title>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script>
  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" type="text/css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-65.html">NSIS Discussion</a></li>

      <li class="active">Files get Deleted on Reboot after Uninstall / Install</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=166119">Files get Deleted on Reboot after Uninstall / Install</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">alressler</span><br />
      <span class="post-time small text-muted">22nd January 2004 16:38 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Files get Deleted on Reboot after Uninstall / Install</strong><br />
      If you use the /reboot option for deleting files on uninstall you can run into the following confusion.<br />
      <br />
      1. Uninstall app, even though a DLL is in use to be deleted. (Uninstall instructions say delete the DLL when rebooted.<br />
      2. Reinstall the app.<br />
      3. Reboot the computer.<br />
      4. The DLL is deleted, even though a new install wants the DLL.<br />
      <br />
      Is there an option to clear Delete on Reboot files?<br />
      <br />
      Is the best way to work around this by renaming the file to delete and then deleting the renamed version?<br />
      Thanks.<br />
      P.S. I really love this product.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br />
      <span class="post-time small text-muted">22nd January 2004 16:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Renaming is also not possible when the file is in use.<br />
      <br />
      You should write a key/file to prevent the installer from running when an uninstallation is pending.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">alressler</span><br />
      <span class="post-time small text-muted">22nd January 2004 17:05 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Your message implies that I must require a reboot after uninstall to avoid this. I'm trying to avoid a mandatory reboot. I guess I could have a message that asks if the person wants to reboot before a reinstall.<br />
      <br />
      BTW, The windows explorer let's you rename a dll while it is in use. I would assume your APIs would do the same. Are you saying they won't?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Joost Verburg</span><br />
      <span class="post-time small text-muted">22nd January 2004 17:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">If you can rename it the DLL is not in use.<br />
      <br />
      You can remove the registry key to delete the file on reboot, but it has a bit of a special format so it's not that easy.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">alressler</span><br />
      <span class="post-time small text-muted">22nd January 2004 17:31 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">So I tried my hack with the rename and it works fine. It will rename it even if it is in use.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">stb</span><br />
      <span class="post-time small text-muted">20th May 2005 18:11 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content"><strong>Can someone help with plugin coding?</strong><br />
      I tried to address the problem.<br />
      <br />
      Idea: Remove those bad "Delete on reboot" entries in Windows just when installing the new file.<br />
      <br />
      Approach: delete all "Delete/Rename after Reboot" entries in Windows (wininit.ini or Registry key) just before the File command (or before !insertmacro InstallLib). So never a file should be removed/renamed after next reboot and break the installation.<br />
      <br />
      I'm not fit enough in pure C to finish the plugin. I just packed some code snippets together and wrote some comments, what to do. Maybe someone here can help to finish this.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">11th January 2007 21:28 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What if DLL files that need to be deleted on reboot would be first moved to $TEMP with a temporary name? Files in use can be moved, but just can't be deleted. This will solve the reinstall issue and will also make sure unregistered DLL files don't stay on the system.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">stb</span><br />
      <span class="post-time small text-muted">11th January 2007 21:40 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">hi kichik,<br />
      <br />
      that's a great idea and I think it will work. Do you think this should be and NSIS built-in feature?<br />
      <br />
      I can see two issues we should take care of:<br />
      <br />
      - This will only work if $TEMP is the same drive as the file to delete. (do not "rename" across drives (i.e. move))<br />
      <br />
      - The file could be locked so it cannot be renamed.<br />
      <br />
      Both issues are rare, but should be addressed. So if drive-internal renaming results in error the current method should be done.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">11th January 2007 21:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">GetTempFileName knows how to get a temporary file name on another folder than $TEMP, so the first problem can easily be solved. The second can be solved with a simple IfErrors, reverting back to the old method.<br />
      <br />
      The change would be done in the Library macros, as usual.<br />
      <br />
      I'd like to take some time and think about it, to make sure no problems should arise. Are there any other problem you can see but those two?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">stb</span><br />
      <span class="post-time small text-muted">11th January 2007 22:14 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">You're right. But GetTempFileName may fail. :-)<br />
      <br />
      a) You take the root of the dll drive as temp base dir ("d:\" for "d:\program files\prog\test.dll"). Problem: This dir could be write-protected. Think of a network share, so this scenario is not so weird. Of course every file or dir could have this problem. But root drive write access is something I would not rely in practise.<br />
      <br />
      b) You take the original dir as temp base dir ("d:\program files\prog\"). This is bad because an uninstaller would like to delete the "prog" dir if possible. At least directory cannot be removed in this session (on reboot, too). Hmm. "b)" sounds better to me.<br />
      <br />
      What about RMDIR /Rebootok? I don't see any problems. RMDIR /r /rebootok seems to be quite dangerous in general but this should not be any problem here.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">11th January 2007 22:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The problem with (b) is already present with the current solution, so it wouldn't be a bad start. To get to an even better solution, an attempt to move to $TEMP could be made before using $INSTDIR.<br />
      <br />
      RMDir /REBOOTOK will not work on Windows 9x without an undocumented patch. On Windows NT it already works.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">stb</span><br />
      <span class="post-time small text-muted">11th January 2007 22:29 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Sorry, the RMDIR issue has nothing to do with your DLL/library.nsh solution. So this was just an extra question for other use cases of your strategy (rename in case directory is in use).<br />
      <br />
      To address your question: I think the solution will work, don't see any problems and it's a real improvement.<br />
      <br />
      One issue not addressed by your solution is this:<br />
      <br />
      Another installer (non-NSIS or NSIS &lt;= 2.22) would not work like you suggest. So if someone installs multiple applications my original problem would occur anyway. Your solution tries to not create conflict entries in the delete-on-reboot-table but does not resolve existing conflicts.<br />
      <br />
      Anyway I think we should implement your solution because delete-on-reboot-table is not intended to being written to.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">24th January 2007 11:24 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">I've made the change. Had to tweak it a bit to handle both network drives and files on drives different than $TEMP's drive, but it works now. The change is available in <a href="http://nsis.cvs.sourceforge.net/nsis/NSIS/Include/Library.nsh?r1=1.37&amp;r2=1.38" target="_blank">CVS</a>. Let me know if there are any problems with it.<br />
      <br />
      One weird thing that I had to deal with is MoveFile() that doesn't report failure when moving in-use files from a network drive to a physical drive. It copies the file, but never deletes the original and reports success. I had to use IfFileExists instead of IfErrors to check for success and also delete the destination file, even though the source file still exists.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">stb</span><br />
      <span class="post-time small text-muted">5th April 2007 20:18 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Hi kichik and others,<br />
      <br />
      two question for Library.nsh:<br />
      <br />
      1. I want to use Library.nsh for all my files (not only runtim e dlls and typelibs) so I can use all those fine solutions for "in use" files without coding them again. Currently I use those macros with some workaround because InstallLib can only UPGRADE. For my application dlls (in "program files\...") I want to be able to downgrade. And I have some files that are no DLLs (just data files etc). So it would be very nice if I could disable the version comparing steps. I had a look into it but currently do not have a good feeling about just adding some jumps there. I don't want to break something...<br />
      <br />
      Workaround for me is: just call uninstalllib before installlib so the file will be removed (this means: version check will be always positive). I assume files without version information will always be copied...<br />
      <br />
      2. I have a DLL which is not very important for my application. It is a plugin DLL which is used by a third party software. If the 3rd party software runs, I now can make upgrades without stopping that software (very nice) by using the library.nsh and my macros. This will move the DLL in use to TEMP (still running) and will install the new one in INSTDIR. When the installer finishes it wants to reboot the machine. This isn't necessary here. The user can run the software without rebooting and for the new plugin DLL restarting the 3rd party software will do the trick.<br />
      <br />
      I'm thinking about doing this for myself (special macro using "SetRebootFlag false") but maybe this could be done in Library.nsh, too. (There my be others who want something like this.)<br />
      <br />
      Best regards<br />
      stb</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">stb</span><br />
      <span class="post-time small text-muted">5th April 2007 20:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Why not add some code :-)<br />
      <br /></p>
      <pre>
<code><br /><br />; ################################################################<br />; installs a file (existing file will be removed)<br />; OUTFILE: target filename, LOCALFILE: source filename (local)<br />!macro InstallFile OUTFILE LOCALFILE<br />  ; USE ON YOUR OWN RISK! Please report bugs here: <a href="http://stefan.bertels.org/" target="_blank">http://stefan.bertels.org/</a><br />  !insertmacro DeleteFile "${OUTFILE}"<br />  !insertmacro InstallLib DLL NOTSHARED REBOOT_NOTPROTECTED "${LOCALFILE}" "${OUTFILE}" "$INSTDIR"<br />!macroend<br /><br />; ################################################################<br />; installs a DLL that has to be registered (COM) (existing file will be removed)<br />; OUTFILE: target filename, LOCALFILE: source filename (local)<br />!macro InstallDLL OUTFILE LOCALFILE<br />  ; USE ON YOUR OWN RISK! Please report bugs here: <a href="http://stefan.bertels.org/" target="_blank">http://stefan.bertels.org/</a><br />  !insertmacro DeleteDLL "${OUTFILE}"<br />  !insertmacro InstallLib REGDLL NOTSHARED REBOOT_NOTPROTECTED "${LOCALFILE}" "${OUTFILE}" "$INSTDIR"<br />!macroend<br /><br />; ################################################################<br />; installs a DLL that has to be registered (COM) (existing file will be removed)<br />; this special variant does not change the reboot flag (will not be set here)<br />; OUTFILE: target filename, LOCALFILE: source filename (local)<br />!macro InstallDLLneverReboot OUTFILE LOCALFILE<br />  ; USE ON YOUR OWN RISK! Please report bugs here: <a href="http://stefan.bertels.org/" target="_blank">http://stefan.bertels.org/</a><br />  Push $0<br />  StrCpy $0 "0" ; reboot flag false<br />  IfRebootFlag 0 +2<br />  StrCpy $0 "1" ; reboot flag true<br />  !insertmacro DeleteFile "${OUTFILE}"<br />  !insertmacro InstallLib REGDLL NOTSHARED REBOOT_NOTPROTECTED "${LOCALFILE}" "${OUTFILE}" "$INSTDIR"<br />  StrCmp $0 "0" 0 +2  ; when reboot flag was not set before, we set it to false now<br />  SetRebootFlag false<br />  Pop $0<br />!macroend<br /><br />; ################################################################<br />!macro DeleteFile FILE<br />  ; USE ON YOUR OWN RISK! Please report bugs here: <a href="http://stefan.bertels.org/" target="_blank">http://stefan.bertels.org/</a><br />  !insertmacro UnInstallLib DLL NOTSHARED REBOOT_NOTPROTECTED "${FILE}"<br />!macroend<br /><br />; ################################################################<br />!macro DeleteDLL FILE<br />  ; USE ON YOUR OWN RISK! Please report bugs here: <a href="http://stefan.bertels.org/" target="_blank">http://stefan.bertels.org/</a><br />  !define LIBRARY_COM<br />  !insertmacro UnInstallLib REGDLL NOTSHARED REBOOT_NOTPROTECTED "${FILE}"<br />  !undef LIBRARY_COM<br />!macroend<br /></code>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">8th April 2007 19:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">Using Library for regular files can be achieved by ignoring version information. Probably another possible value for libtype should be added. Something like FILE.<br />
      <br />
      For unimportant files, another option can be added (LIBRARY_IGNORE_REBOOT or something), or SetRebootFlag false can be called by the user. Seems to me it's more of a user thing. But if you can find a good setting name for it, I don't mind.<br />
      <br />
      As always, patch or feature request ;)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">stb</span><br />
      <span class="post-time small text-muted">9th April 2007 11:33 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">What does LIBRARY_VERSION_NONE?<br />
      <br />
      I this is some (external) option, I don't see a chance of line 276 and following to run. I couldn't find the position where this is defined within Library.nsh.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">9th April 2007 11:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">It's an internal constant used by the Library. LibraryLocal.exe defines it when no version information is found in the DLL or TLB.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">stb</span><br />
      <span class="post-time small text-muted">11th April 2007 18:25 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">@kichik: is line 521 (SetOverwrite lastused) dead code (library.nsh)?</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">kichik</span><br />
      <span class="post-time small text-muted">11th April 2007 21:01 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">No. It's coupled with line 507 or 511 to return the overwrite flag to its last used value. SetOverwrite is not affected by Return as it's really a compile time command.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">stb</span><br />
      <span class="post-time small text-muted">12th April 2007 09:12 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">patch for (1.) by pm</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]>
  </script>
</body>
</html>
