<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="NSIS Service Plugin"><title>NSIS Service Plugin - NSIS Forums</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-53539506-8','auto');ga('send','pageview');</script><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" as="style" onload="this.rel='stylesheet'"><link rel="preload" href="../css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css"><link rel="stylesheet" href="../css/style.css"></noscript><script>!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);</script></head><body><div class="container"><ol class="breadcrumb"><li><a href="../index.html" class="glyphicon glyphicon-home"></a></li><li><a href="f-65.html">NSIS Discussion</a></li><li class="active">NSIS Service Plugin</li></ol><p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=248526">NSIS Service Plugin</a></p><br><div class="post"><p class="post-meta"><span class="post-author text-primary">BashLogic</span><br><span class="post-time small text-muted">12th June 2006 13:48 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>NSIS Service Plugin</strong><br>Greetings,<br><br>I have the need to check on a service status and startit up in case it is not running (windows installer) now the funny thing is that as i have been trying to use the SERVICE plugin, i have been able to get it to work with the services that have a single word as a service name but not with services that have spaces in between the words, for example..<br><br>----8&lt;----<br>OutFile findservices.exe<br>section<br>services::IsServiceRunning 'Windows Installer'<br>Pop $0<br>StrCmp $0 'Ok' success 0<br>MessageBox MB_OK|MB_ICONSTOP 'command: $0' 0 0<br>Abort<br>success:<br><br>SectionEnd<br>----8&lt;----<br><br>any ideas on what is going wrong and how that could be corrected?<br><br><br>regards<br>BL</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">CancerFace</span><br><span class="post-time small text-muted">12th June 2006 15:02 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">Try it as <i>MSIServer</i> instead.</p><pre>
<code> services::IsServiceRunning "MSIServer"</code>
</pre><br>Check the registry under <i>HKLM\System\CurrentControlSet\Services</i> for the exact service name. Windows Installer is the name of the service as it appears on any GUI, the true service name is MSIServer.<br>You can start/stop/query the service with either name ...<br>CF</div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">BashLogic</span><br><span class="post-time small text-muted">12th June 2006 16:34 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>case solved!</strong><br>thanks a lot!<br>that resolved my problem. now i only have to figure out<br>how to enable the service to start it up in case it is disabled ...any ideas?<br><br>regards<br>BL</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">CancerFace</span><br><span class="post-time small text-muted">12th June 2006 16:43 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You can use the <a href="http://nsis.sourceforge.net/NsSCM_plug-in" target="_blank">NsSCM plugin</a> to query/start/stop the service ...<br><br>CF</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">BashLogic</span><br><span class="post-time small text-muted">12th June 2006 16:46 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">but can that other plugin enable a disabled service?</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">BashLogic</span><br><span class="post-time small text-muted">12th June 2006 19:26 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content"><strong>case finally closed!!!</strong><br>ok guys<br><br>just to answer my own question,<br><br>appearently the service plugin is not able to enable a disabled service. even if you would enable a service from the registry, the net start (which equate to the service plugin) wont be able to start the service because in the service manager db the service is still registered to be in the previous state.<br><br>for each service there are two places (if im not mistaken) where information is stored regarding its state, its own registry path/key and the service manager db.<br><br>enabling the service from the registry path/key(start|dword) alone would not suffice, you would either have to do it thru the service mmc gui or... you can you the sc.exe to do it!<br><br>so if you have a disabled service, enable it first with the sc tool (if not found on your system, you can find it in the reskit) with the command "sc config msiserver start= demand" and after that use the service plugin to startup the service!<br><br>here is a sample script that does that, dirty but does the job :)<br><br>regards<br>BL<br>---8&lt;------8&lt;------8&lt;------8&lt;---<br>OutFile findservices.exe<br>section<br>;enable service from console<br>execwait "sc config msiserver start= demand"<br><br>;check if service is running<br>services::IsServiceRunning 'MSIServer'<br>Pop $0<br>StrCmp $0 'Ok' success 0<br>MessageBox MB_OK|MB_ICONSTOP 'Service running status: $0 (3= enabled!)' 0 0<br>success:<br><br>;read service registry status value<br>ReadRegDWORD $0 HKEY_LOCAL_MACHINE "SYSTEM\CurrentControlSet\Services\MSIServer" "Start"<br>Pop $0<br>MessageBox MB_OK|MB_ICONSTOP 'value: $0' 0 0<br><br>;startup service<br>services::SendServiceCommand 'start' 'MSIServer'<br>Pop $0<br>StrCmp $0 'Ok' success1 0<br>MessageBox MB_OK|MB_ICONSTOP 'Service start command status: $0' 0 0<br>success1:<br><br>; check that service started<br>services::IsServiceRunning 'MSIServer'<br>Pop $0<br>StrCmp $0 'Ok' success2 0<br>MessageBox MB_OK|MB_ICONSTOP 'Service running status: $0 (3= enabled!)' 0 0<br>success2:<br><br><br>SectionEnd<br>---8&lt;------8&lt;------8&lt;------8&lt;---</p></div><hr><div class="post"><p class="post-meta"><span class="post-author text-primary">CancerFace</span><br><span class="post-time small text-muted">12th June 2006 22:45 <abbr title="Coordinated Universal Time">UTC</abbr></span></p><p class="post-content">You could do the same using direct API calls, thus avoiding the use of a command line tool.<br>The following code will atempt to start the MSIServer and if it fails it will alter the service's configuration then retry:<br></p><pre>
<code>!define SC_MANAGER_ALL_ACCESS   0x3F<br>!define SERVICE_ALL_ACCESS      0xF01FF<br>!define SERVICE_DEMAND_START    0x00000003<br>!define SERVICE_NO_CHANGE       0xffffffff<br><br># Get a handle to the SCM<br>  System::Call 'advapi32::OpenSCManagerA(,,i ${SC_MANAGER_ALL_ACCESS})i.R9'<br><br># Get a handle to the service<br>  System::Call 'advapi32::OpenServiceA(i R9,t "MSIServer",i ${SERVICE_ALL_ACCESS})i.R8'<br><br># Start the service<br>  System::Call 'advapi32::StartServiceA(i R8,i 0,i 0)i.r0'<br>  StrCmp $0 0 0 +3<br>  # Change the service startup options<br>    System::Call 'advapi32::ChangeServiceConfigA(i R8,i ${SERVICE_NO_CHANGE},i ${SERVICE_DEMAND_START},i ${SERVICE_NO_CHANGE},,,,,,,)i.r0'<br>  # Start the service<br>    System::Call 'advapi32::StartServiceA(i R8,i 0,i 0)i.r0'<br><br># Close the service handle<br>  System::Call 'advapi32::CloseServiceHandle(i R8)i.r0'<br><br># Close the SCM handle<br>  System::Call 'advapi32::CloseServiceHandle(i R9)i.r0'</code>
</pre><br>
      <br>
      :)<br>
      <br>
      CF
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">BashLogic</span><br>
      <span class="post-time small text-muted">13th June 2006 06:47 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">wow,<br>
      that went right over my head, i didnt know that api calls can be done straight off! regardless of that its a totally different thing on whether i would know how to program to interface with the api :)<br>
      <br>
      so i guess my next question is .. due to security tightening policy, i need to keep the service as disabled after having installed the required applications (after a new install). now you presented how it could be enabled and started, I would greatly appreciate it if you could point on how to disable the service when done :)<br>
      <br>
      that is why i was running checks in between to verify the state prior to applying changes :)<br>
      <br>
      regards<br>
      BL</p>
    </div>
    <hr>

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">CancerFace</span><br>
      <span class="post-time small text-muted">13th June 2006 08:08 <abbr title="Coordinated Universal Time">UTC</abbr></span></p>

      <p class="post-content">The Windows Installer Service should be left on manual, otherwise the self-healing option that is provided as default with all msi packs will not work, if I am not mistaken.<br>
      <br>
      You can use part of the previous code that I posted to stop the service and set its configuration to <i>disabled</i>:<br></p>
      <pre>
<code>!define SC_MANAGER_ALL_ACCESS   0x3F<br>!define SERVICE_ALL_ACCESS      0xF01FF<br>!define SERVICE_DEMAND_START    0x00000003<br>!define SERVICE_DISABLED        0x00000004<br>!define SERVICE_NO_CHANGE       0xffffffff<br>!define SERVICE_CONTROL_STOP    1<br><br># Get a handle to the SCM<br>  System::Call 'advapi32::OpenSCManagerA(,,i ${SC_MANAGER_ALL_ACCESS})i.R9'<br><br># Get a handle to the service<br>  System::Call 'advapi32::OpenServiceA(i R9,t "MSIServer",i ${SERVICE_ALL_ACCESS})i.R8'<br><br># Stop the service<br>  System::Call '*(i,i,i,i,i,i,i)i.R0'<br>  System::Call 'advapi32::ControlService(i R8,i ${SERVICE_CONTROL_STOP},i R0)i.r0'<br>  System::Call '*$R0(,i.r1,,,,,)'  ; $1 contains the service status code<br>  System::Free $R0<br><br># Change the service startup options<br>  System::Call 'advapi32::ChangeServiceConfigA(i R8,i ${SERVICE_NO_CHANGE},i ${SERVICE_DISABLED},i ${SERVICE_NO_CHANGE},,,,,,,)i.r0'<br><br># Close the service handle<br>  System::Call 'advapi32::CloseServiceHandle(i R8)i.r0'<br><br># Close the SCM handle<br>  System::Call 'advapi32::CloseServiceHandle(i R9)i.r0'</code>
</pre>You can find more information about starting/stopping/pausing/quering etc a service at <a href="http://msdn.microsoft.com/library/en-us/dllproc/base/service_functions.asp" target="_blank">this</a> MSDN page.<br>
      ;)<br>
      CF
    </div>
    <hr>

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/nsis-dev/NSIS-Forums/">GitHub</a></p>
    </div>
  </div><script src="../js/highlight.pack.js" type="text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  hljs.initHighlightingOnLoad();
  //]]></script></body></html>